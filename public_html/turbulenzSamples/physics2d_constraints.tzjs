(function(){var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(n,r){r===undefined&&(r=new e(9));var i=h*m-p*v,s=p*d-c*m,o=c*v-h*d,u=a*i+f*s+l*o;if(u===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var a=n[0],f=n[1],l=n[2],c=n[3],h=n[4],p=n[5],d=n[6],v=n[7],m=n[8],g=1/u;return r[0]=i*g,r[1]=(v*l-m*f)*g,r[2]=(f*p-l*h)*g,r[3]=s*g,r[4]=(m*a-d*l)*g,r[5]=(c*l-a*p)*g,r[6]=o*g,r[7]=(d*f-v*a)*g,r[8]=(a*h-c*f)*g,r},m33InverseTranspose:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=f*p-l*h,v=l*c-a*p,m=a*h-f*c,g=s*d+o*v+u*m;if(g===0)i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0;else{var y=1/g;i[0]=d*y,i[3]=(h*u-p*o)*y,i[6]=(o*l-u*f)*y,i[1]=v*y,i[4]=(p*s-c*u)*y,i[7]=(a*u-s*l)*y,i[2]=m*y,i[5]=(c*o-h*s)*y,i[8]=(s*f-a*o)*y}return i},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=a*h-f*c,g=f*l-u*h,y=u*c-a*l,b=i*m+s*g+o*y;if(b===0)return r;r===undefined&&(r=new e(12));var w=1/b;return r[0]=m*w,r[1]=(c*o-h*s)*w,r[2]=(s*f-o*a)*w,r[3]=g*w,r[4]=(h*i-l*o)*w,r[5]=(u*o-i*f)*w,r[6]=y*w,r[7]=(l*s-c*i)*w,r[8]=(i*a-u*s)*w,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*w,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*w,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*w,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a,s[1]=n[1]*o+n[4]*u+n[7]*a,s[2]=n[2]*o+n[5]*u+n[8]*a,s},m43TransformPoint:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a+n[9],s[1]=n[1]*o+n[4]*u+n[7]*a+n[10],s[2]=n[2]*o+n[5]*u+n[8]*a+n[11],s},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i
[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}t.arrayConstructor=e,TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var t=new e;return t.subscribers=[],t},e}(),i=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480||s===504){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(t){var n=new e;n.initialRetryTime=t.initialRetryTime||500,n.notifyTime=t.notifyTime||4e3,n.maxRetryTime=t.maxRetryTime||8e3,n.notifiedConnectionLost=!1,n.connected=!0,n.reconnectedObserver=r.create(),n.reconnectTest=null,n.onReconnected=t.onReconnected||function(){},n.onRequestTimeout=t.onRequestTimeout||function(){};var i={eventOnload:[]};return n.handlers=i,n},e}(),s={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",r=t.method,i=t.data||{},o=t.encrypt,u=null,a=t.url,f=t.requestHandler,l=t.callback;if(o){i.requestUrl=a;var c=JSON.stringify(i);r==="POST"&&(c=TurbulenzEngine.encrypt(c)),n+="data="+encodeURIComponent(c)+"&",n+="gameSessionId="+encodeURIComponent(i.gameSessionId),u=TurbulenzEngine.generateSignature(c)}else if(i){var h;for(h in i)i.hasOwnProperty(h)&&(n.length!==0&&(n+="&"),r==="POST"?n+=h+"="+i[h]:n+=encodeURIComponent(h)+"="+encodeURIComponent(i[h]))}var p=function(t,n){var r=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;if(r.getResponseHeader("Content-Type")!=="application/json; charset=utf-8")TurbulenzEngine.setTimeout(function(){l({msg:"HttpStatus "+n+" "+s.ajaxStatusCodes[n]},n),l=null},0);else{var i=JSON.parse(t);if(o){var u=r.getResponseHeader("X-TZ-Signature"),f=TurbulenzEngine.verifySignature(t,u);t=null,TurbulenzEngine.setTimeout(function(){var e=i.requestUrl;if(f)if(!TurbulenzEngine.encryptionEnabled||e===a){l(i,n),l=null;return}n===400?l(i,n,"Verification Failed"):l({msg:"Verification failed",ok:!1},400,"Verification Failed"),l=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){l(i,n),l=null},0)}},d=function(i,s,o){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}o.xhr=a;var f=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(o,t,n)}};a.open(r,n&&r!=="POST"?i+"?"+n:i,!0),l&&(a.onreadystatechange=f),u&&a.setRequestHeader("X-TZ-Signature",u),r==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(f)f.request({src:a,requestFn:d,responseFilter:t.responseFilter,onload:p});else{var v={src:a};d(a,p,v)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},o={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},u=function(){function e(){}return e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=r.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){var n=new e;return n.object=t,n.referenceCount=0,n},e.version=1,e}(),a={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,o;for(o in this.profiles)this.profiles.hasOwnProperty(o)&&(i=this.profiles[o],s<i.duration&&(s=i.duration),r.push(i));var u;t===a.sortMode.alphabetical?u=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===a.sortMode.max?u=function(t,n){return n.max-t.max}:t===a.sortMode.min?u=function(t,n){return n.min-t.min}:t===a.sortMode.calls?u=function(t,n){return n.calls-t.calls}:u=function(t,n){return n.duration-t.duration},r.sort(u);var f,l="",c=n?n.precision:8,h=n?n.percentagePrecision:1,p=n?n.seperator:" ",d=r.length,v,m,g;for(g=0;g<d;g+=1)i=r[g],f=i.name,f+=p+i.calls,f+=p+i.duration.toFixed(c),f+=p+i.max.toFixed(c),f+=p+i.min.toFixed(c),m=i.duration/i.calls,f+=p+m.toFixed(c),v=Math.sqrt(i.sumOfSquares/i.calls-m*m),f+=p+v.toFixed(c),f+=p+(100*i.duration/s).toFixed(h)+"%\n",l+=f;return l}},f={};f.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},f.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var l=function(){function e(){}return e.create=function(){return new e},e}(),c=function(){function e(){}return e.prototype.push=function(e,t){var n=l.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var t=new e;return t.events=[],t},e}(),h=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,r=this.serviceStatusObserver,i;i=function(o,u){u?e.neverDiscard||(r.unsubscribe(i),t()):o&&(r.unsubscribe(i),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,r.subscribe(i)),!0);var o=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,d=h?h.discardRequests:!0;return n.discardRequests=d,d&&!e.neverDiscard?t():r.subscribe(i),p.serviceUnavailable(n,u),!1}return o?o.call(e.requestHandler,u,a,f,l):!0},s.ajax(e),!0},e.create=function(t,n){var i=new e;return n||(n={}),i.running=!0,i.discardRequests=!1,i.serviceStatusObserver=r.create(),i.serviceName=t,i.onServiceUnavailable=n.onServiceUnavailable,i.onServiceAvailable=n.onServiceAvailable,i},e}(),p=function(){function e(){}return e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var e=window.top.Turbulenz,t=e&&e.Data||{},n=t.joinMultiplayerSessionId,r=this,i=function(t){r.multiplayerJoinRequestQueue.push(t)},s=function(t){var n=JSON.parse(t);n.mode&&(r.mode=n.mode),n.joinMultiplayerSessionId&&r.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),r.bridgeServices=!!n.bridgeServices};n&&this.multiplayerJoinRequestQueue.push(n),d.setOnMultiplayerSessionToJoin(i),d.setOnReceiveConfig(s),d.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,d.on("bridgeservices.response",function(e){r.routeResponse(e)})},e.callOnBridge=function(e,t,n){var r={data:t,key:undefined};n&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=n,r.key=this.responseIndex),d.emit("bridgeservices."+e,JSON.stringify(r))},e.addSignature=function(e,t){var n;return e.requestUrl=t,n=TurbulenzEngine.encrypt(JSON.stringify(e)),e.str=n,e.signature=TurbulenzEngine.generateSignature(n),e},e.routeResponse=function(e){var t=JSON.parse(e),n=t.key||0,r=this.responseHandlers[n];r&&(this.responseHandlers[n]=null,r(t.data))},e.onServiceUnavailable=function(e,t){},e.onServiceAvailable=function(e,t){},e.createGameSession=function(e,t,n){return v.create(e,t,n)},e.createMappingTable=function(t,n,r,i,s){var o,u=n&&n.mappingTable,a,f,l;u?(a=u.mappingTableURL,f=u.mappingTablePrefix,l=u.assetPrefix):i?(a=i.mappingTableURL||(i.mappingTableURL===""?"":"mapping_table.json"),f=i.mappingTablePrefix||(i.mappingTablePrefix===""?"":"staticmax/"),l=i.assetPrefix||(i.assetPrefix===""?"":"missing/")):(a="mapping_table.json",f="staticmax/",l="missing/");var c=function(n){var r=i&&(i.urnMapping||{}),u=s||e.defaultErrorCallback;o.setMapping(r),u(n)},h={mappingTableURL:a,mappingTablePrefix:f,assetPrefix:l,requestHandler:t,onload:r,errorCallback:c};return o=m.create(h),o},e.createLeaderboardManager=function(e,t,n,r){return LeaderboardManager.create(e,t,n,r)},e.createBadgeManager=function(e,t){return BadgeManager.create(e,t)},e.createStoreManager=function(e,t,n,r){return StoreManager.create(e,t,n,r)},e.createNotificationsManager=function(e,t,n,r){return NotificationsManager.create(e,t,n,r)},e.createMultiplayerSessionManager=function(e,t){return MultiPlayerSessionManager.create(e,t)},e.createUserProfile=function(t,n,r){var i={};r||(r=e.defaultErrorCallback);var s=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n])}},o="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:o,method:"GET",callback:function(t,o){o===200?s(t):r&&r("TurbulenzServices.createUserProfile error with HTTP status "+o+": "+t.msg,o),n&&n(i)},requestHandler:t}),i},e.upgradeAnonymousUser=function(e){if(e){var t=function(n){e()};d.on("user.upgrade.occurred",t)}d.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(t,n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof t||0===t.length){s("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof n||isNaN(n)||!isFinite(n)){if("[object Array]"!==Object.prototype.toString.call(n)){s("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var o,u=n.length;for(o=0;o<u;o+=1)if("number"!=typeof n[o]||isNaN(n[o])||!isFinite(n[o])){s("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+i.gameSlug,method:"POST",data:{key:t,value:n,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.sendCustomMetricEventBatch=function(t,n,r,i){i||(i=e.defaultErrorCallback);if(!e.available()){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var s=TurbulenzEngine.time,o=t.events,u,a=o.length;for(u=0;u<a;u+=1){var f=o[u].key,l=o[u].value,c=o[u].timeOffset;if("string"!=typeof f||0===f.length){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof l||isNaN(l)||!isFinite(l)){if("[object Array]"!==Object.prototype.toString.call(l)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var h,p=l.length;for(h=0;h<p;h+=1)if("number"!=typeof l[h]||isNaN(l[h])||!isFinite(l[h])){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers",0);return}}if("number"!=typeof c||isNaN(c)||!isFinite(c)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}o[u].timeOffset=c-s}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+r.gameSlug,method:"POST",data:{batch:o,gameSessionId:r.gameSessionId},callback:function(t,n){n!==200&&i&&i("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:n,encrypt:!0})},e.getService=function(e){var t=this.services;if(t.hasOwnProperty(e))return t[e];var n=h.create(e);return t[e]=n,n},e.serviceUnavailable=function(t,n){var r=this.waitingServices,i=t.serviceName;if(r.hasOwnProperty(i))return;r[i]=t,t.running=!1;var o=function(r){var i=n.onServiceUnavailable;i&&i.call(r,n),r.onServiceUnavailable&&r.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(r)};t.discardRequests&&o(t);if(this.pollingServiceStatus)return;var u=this,a,f="/api/v1/service-status/game/read/"+window.gameSlug,l=function(i,s){if(s===200){var f=i.data,l=f.services,c=!1,h;for(h in r)if(r.hasOwnProperty(h)){var p=r[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=n.onServiceAvailable;m&&m.call(p,n),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete r[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&(p.discardRequests=!0,o(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(a,f.pollInterval*1e3)}else TurbulenzEngine.setTimeout(a,u.defaultPollInterval)};a=function(){s.ajax({url:f,method:"GET",callback:l})},a()},e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.defaultErrorCallback=function(e,t){},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e}();typeof d!="undefined"&&p.addBridgeEvents();var d=function(){function e(){}return e._initInstance=function(){var e=window.top.Turbulenz;if(e&&e.Services){var t=e.Services.bridge;if(!t)return;this._bridge=t,this.emit=t.emit,this.on=t.gameListenerOn||t.addListener||t.setListener,this.addListener=t.gameListenerOn||t.addListener||t.setListener,this.setListener=t.gameListenerOn||t.setListener}typeof p!="undefined"&&p.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(e,t,n){},e.on=function(e,t){},e.addListener=function(){},e.setListener=function(e,t){},e.setOnReceiveConfig=function(e){this.on("config.set",e)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(e){this.emit("game.session.created",e)},e.destroyedGameSession=function(e){this.emit("game.session.destroyed",e)},e.setGameSessionStatus=function(e,t){this.emit("game.session.status",e,t)},e.setGameSessionInfo=function(e){this.emit("game.session.info",e)},e.updateUserBadge=function(e){this.emit("userbadge.update",e)},e.updateLeaderBoard=function(e){this.emit("leaderboards.update",e)},e.setOnMultiplayerSessionToJoin=function(e){this.on("multiplayer.session.join",e)},e.triggerJoinedMultiplayerSession=function(e){this.emit("multiplayer.session.joined",e)},e.triggerLeaveMultiplayerSession=function(e){this.emit("multiplayer.session.leave",e)},e.triggerMultiplayerSessionMakePublic=function(e){this.emit("multiplayer.session.makepublic",e)},e.setOnBasketUpdate=function(e){this.on("basket.site.update",e)},e.triggerBasketUpdate=function(e){this.emit("basket.game.update.v2",e)},e.triggerUserStoreUpdate=function(e){this.emit("store.user.update",e)},e.setOnPurchaseConfirmed=function(e){this.on("purchase.confirmed",e)},e.setOnPurchaseRejected=function(e){this.on("purchase.rejected",e)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(
e){this.on("store.meta.v2",e)},e.triggerSendInstantNotification=function(e){this.emit("notifications.ingame.sendInstant",e)},e.triggerSendDelayedNotification=function(e){this.emit("notifications.ingame.sendDelayed",e)},e.setOnNotificationSent=function(e){this.on("notifications.ingame.sent",e)},e.triggerCancelNotificationByID=function(e){this.emit("notifications.ingame.cancelByID",e)},e.triggerCancelNotificationsByKey=function(e){this.emit("notifications.ingame.cancelByKey",e)},e.triggerCancelAllNotifications=function(e){this.emit("notifications.ingame.cancelAll",e)},e.triggerInitNotificationManager=function(e){this.emit("notifications.ingame.initNotificationManager",e)},e.setOnReceiveNotification=function(e){this.on("notifications.ingame.receive",e)},e.changeAspectRatio=function(e){this.emit("change.viewport.ratio",e)},e.setOnViewportHide=function(e){this.on("change.viewport.hide",e)},e.setOnViewportShow=function(e){this.on("change.viewport.show",e)},e.setOnFullscreenOn=function(e){this.on("change.viewport.fullscreen.on",e)},e.setOnFullscreenOff=function(e){this.on("change.viewport.fullscreen.off",e)},e.setOnMenuStateChange=function(e){this.on("change.menu.state",e)},e.setOnUserStateChange=function(e){this.on("change.user.state",e)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(e){this.emit("query.viewport.fullscreen",e)},e.queryViewportVisibility=function(e){this.emit("query.viewport.visibility",e)},e.queryMenuState=function(e){this.emit("query.menu.state",e)},e.queryUserState=function(e){this.emit("query.user.state",e)},e._bridge=undefined,e}();d.isInitialised()||d._initInstance();var v=function(){function e(){this.post_delay=1e3}return e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,d.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(d.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},p.bridgeServices?p.callOnBridge("gamesession.destroy",t,e):s.ajax({url:"/api/v1/games/destroy-session",method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(t,n,r){var i=new e,s=window.gameSlug,o=window.top.Turbulenz,u=o&&o.Data||{},a=u.mode||p.mode,f="/api/v1/games/create-session/"+s;i.info={sessionData:{},playerSessionData:{}},i.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},i.postData=function(){d.setGameSessionInfo(JSON.stringify(i.info)),i.pendingUpdate=null},i.pendingUpdate=null,i.gameSlug=s,i.requestHandler=t,i.errorCallbackFn=r||p.defaultErrorCallback,i.gameSessionId=null,i.service=p.getService("gameSessions"),i.status=null;if(!p.available())return n&&TurbulenzEngine.setTimeout(function(){n(i)},0),i;var l=function(t,r){r===200?(i.mappingTable=t.mappingTable,i.gameSessionId=t.gameSessionId,n&&n(i),d.createdGameSession(i.gameSessionId)):404===r?(window.gameSlug=undefined,i.gameSlug=undefined,n&&n(i)):i.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+r+": "+t.msg,r)};return a&&(f+="/"+a),i.service.request({url:f,method:"POST",callback:l,requestHandler:t,neverDiscard:!0}),i},e.version=1,e}(),m=function(){function e(){}return e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(t){var n=new e;n.mappingTableURL=t.mappingTableURL,n.tablePrefix=t.mappingTablePrefix,n.assetPrefix=t.assetPrefix,n.overrides={},n.errorCallbackFn=t.errorCallback||p.defaultErrorCallback,n.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var r=function(r){var i=r.urnmapping||r.urnremapping||{},s=r.overrides||{};n.urlMapping=i,n.overrides=s;var o=n.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}t.onload(n)};return n.mappingTableURL?t.requestHandler.request({src:n.mappingTableURL,onload:function(t,i){if(i===200){var s=JSON.parse(t);r(s)}else n.urlMapping={},t=t||{msg:"(no response)"},n.errorCallbackFn("MappingTable.create: HTTP status "+i+": "+t.msg,i)}}):t.mappingTableData?TurbulenzEngine.setTimeout(function(){r(JSON.parse(t.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){n.errorCallbackFn("!! mappingtable params contain no url or data")},0),n},e.version=1,e}(),g=function(){function e(){}return e.prototype.get=function(e){return null},e.create=function(t,n,i,s,o){function y(e){var t=e.parameters,n=e.techniques,r=e.programs,i,s,o,u,a,f,l,c,h,p,d,v,m,y,b;for(i in t)if(t.hasOwnProperty(i)){s=g[i];if(s!==undefined){t[i].rows=s,o={};for(u in n)if(n.hasOwnProperty(u)){a=n[u],f=a.length;for(l=0;l<f;l+=1){c=a[l];if(c.parameters.indexOf(i)!==-1){h=c.programs,p=h.length;for(d=0;d<p;d+=1)o[h[d]]=!0}}}v=new RegExp("uniform\\s+(\\w+)\\s+"+i+"\\s*\\[[^\\]]+\\]","mg"),m="uniform $1 "+i+"["+s+"]";for(y in o)o.hasOwnProperty(y)&&(b=r[y],b.code=b.code.replace(v,m))}}}s||(s=function(){});var u="default",a;if(i)a=i;else{var f={version:1,name:"default.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},diffuse:{type:"sampler2D"}},techniques:{textured3D:[{parameters:["worldViewProjection","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!0,CullFaceEnable:!0,CullFace:1029,BlendEnable:!1},programs:["vp","fp"]}]},programs:{fp:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];vec4 _ret_0;uniform sampler2D diffuse;void main()\n{_ret_0=texture2D(diffuse,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OUTpos1;vec2 _OUTuv1;uniform vec4 worldViewProjection[4];void main()\n{_OUTpos1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[1]+ATTR0.zzzz*worldViewProjection[2]+worldViewProjection[3];_OUTuv1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OUTpos1;}"}}};a=t.createShader(f),a||s("Default shader not created.")}var l={},c={},h={},p=0,d=null,v="",m=!1,g={};l[u]=a;var b=function(i,u){i===undefined&&s("Invalid texture path passed to ShaderManager.Load");var f=l[i];if(!f){if(!c[i]){c[i]=!0,p+=1;var g=r.create();h[i]=g,u&&g.subscribe(u);var b=function(n){if(n){var r=JSON.parse(n);m&&y(r);var s=t.createShader(r);s?l[i]=s:delete l[i],g.notify(s),delete h[i]}else o&&(o.innerHTML+="ShaderManager.load:&nbsp;'"+i+"' failed to load<br>"),delete l[i];delete c[i],p-=1};n.request({src:d&&d[i]||v+i,onload:b})}else u&&h[i].subscribe(u);return a}return u&&TurbulenzEngine.setTimeout(function(){u(f)},0),f},w=function(t,n){l[t]=l[n]},E=function(t){var n=l[t];return n?n:a},S=function(t){typeof l[t]!="undefined"&&delete l[t]},x=function(t,n){S(t),b(t,n)},T=new e;return o?(T.load=function(t,n){return o.innerHTML+="ShaderManager.load:&nbsp;'"+t+"'<br>",b(t,n)},T.map=function(t,n){o.innerHTML+="ShaderManager.map:&nbsp;'"+n+"' -> '"+t+"'<br>",w(t,n)},T.get=function(t){return o.innerHTML+="ShaderManager.get:&nbsp;'"+t+"'<br>",E(t)},T.remove=function(t){o.innerHTML+="ShaderManager.remove:&nbsp;'"+t+"'<br>",S(t)},T.reload=function(t,n){o.innerHTML+="ShaderManager. reload:&nbsp;'"+t+"'<br>",x(t,n)}):(T.load=b,T.map=w,T.get=E,T.remove=S,T.reload=x),T.reloadAll=function(){for(var t in l)l.hasOwnProperty(t)&&t!==u&&x(t)},T.getAll=function(){return l},T.getNumPendingShaders=function(){return p},T.isShaderLoaded=function(t){return!c[t]},T.isShaderMissing=function(t){return!l[t]},T.setPathRemapping=function(t,n){d=t,v=n},T.setAutomaticParameterResize=function(t,n){m=!0,g[t]=n},T.destroy=function(){if(l){var r;for(r in l)if(l.hasOwnProperty(r)){var i=l[r];i&&i.destroy()}l=null}a=null,c=null,h=null,p=0,d=null,v=null,n=null,t=null},T},e.version=1,e}(),y=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},b={CONTACT_SLOP:.01,EFF_MASS_EPSILON:1e-10,ILL_THRESHOLD:1e5,CLIP_EPSILON:1.65e-10,BIAS_COEF:.15,STATIC_BIAS_COEF:.75,CONT_BIAS_COEF:.5,CONT_STATIC_BIAS_COEF:.6,BOUNCE_VELOCITY_THRESHOLD:.25,STATIC_FRIC_SQ_EPSILON:1e-4,POINT_BIAS_COEF:.5,POINT_MAX_ERROR:.2,POINT_MAX_ERROR_SQ:.2*.2,POINT_SLOP_SQ:1e-6,POINT_LARGE_ERROR_SQ:.01,POINT_LARGE_ERROR_BIAS:.75,POINT_LARGE_ERROR_MAX:.4,WELD_BIAS_COEF:.5,WELD_MAX_LINEAR_ERROR:.2,WELD_MAX_ANGULAR_ERROR:.5,WELD_MAX_LINEAR_ERROR_SQ:.2*.2,WELD_LINEAR_SLOP_SQ:1e-6,WELD_ANGULAR_SLOP_SQ:1e-6,WELD_LARGE_ERROR_SQ:.01,WELD_LARGE_ERROR_BIAS:.75,WELD_LARGE_ERROR_MAX:.4,ANGLE_BIAS_COEF:.5,ANGLE_SLOP_SQ:1e-6,DIST_BIAS_COEF:.5,DIST_SLOP_SQ:1e-6,DIST_LARGE_ERROR_SQ:.01,DIST_LARGE_ERROR_BIAS:.75,LINE_BIAS_COEF:.8,LINE_SLOP_SQ:1e-6,LINE_LARGE_ERROR_SQ:.01,LINE_LARGE_ERROR_BIAS:.9,PULLEY_BIAS_COEF:.5,PULLEY_SLOP_SQ:1e-6,PULLEY_LARGE_ERROR_SQ:.01,PULLEY_LARGE_ERROR_BIAS:.75,MIN_LINEAR_STATIC_SWEEP:.05,MIN_ANGULAR_STATIC_SWEEP:.005,MIN_LINEAR_BULLET_SWEEP:.5,MIN_ANGULAR_BULLET_SWEEP:.05,SWEEP_LIMIT:5e-4,SWEEP_SLOP:.05,MINIMUM_SWEEP_ADVANCE:1e-6,MAX_SWEEP_ITER:50,EQUAL_SQ_VEL:.2,ZERO_ANG_BIAS:.02,TOI_SLIP_SCALE:.75,DELAYED_DEATH:30,DELTA_ROTATION_EPSILON:1e-4,SLEEP_DELAY:60,SLEEP_LINEAR_SQ:6e-4,SLEEP_ANGULAR_SQ:.001,CONTAINS_EPSILON:1e-6,CONTAINS_SQ_EPSILON:1e-12,COLLINEAR_EPSILON:1e-5,COLLINEAR_SQ_EPSILON:1e-5*1e-5,NORMALIZE_EPSILON:1e-6,NORMALIZE_SQ_EPSILON:1e-12},w=function(){function e(){}return e.prototype.getElasticity=function(){return this._data[0]},e.prototype.getStaticFriction=function(){return this._data[1]},e.prototype.getDynamicFriction=function(){return this._data[2]},e.prototype.getRollingFriction=function(){return this._data[3]},e.prototype.getDensity=function(){return this._data[4]},e.create=function(t){var n=new e,r=t&&t.elasticity!==undefined?t.elasticity:0,i=t&&t.staticFriction!==undefined?t.staticFriction:2,s=t&&t.dynamicFriction!==undefined?t.dynamicFriction:1,o=t&&t.rollingFriction!==undefined?t.rollingFriction:.005,u=t&&t.density!==undefined?t.density:1,a=n._data=new X.prototype.floatArray(5);return a[0]=r,a[1]=i,a[2]=s,a[3]=o,a[4]=u,n.userData=t&&t.userData?t.userData:null,n},e.version=1,e}(),E=function(){function e(){}return e.prototype._inWorld=function(){},e.prototype._outWorld=function(){},e.prototype._pairExists=function(e,t){return!1},e.prototype._wakeConnected=function(){},e.prototype._sleepComputation=function(e){},e.prototype._preStep=function(e){return!1},e.prototype._warmStart=function(){},e.prototype._iterateVel=function(){return!1},e.prototype._iteratePos=function(){return!1},e.prototype.init=function(e,t){var n=e._data;n[0]=t.frequency!==undefined?t.frequency:10,n[1]=t.damping!==undefined?t.damping:1,n[2]=t.maxForce!==undefined?t.maxForce:Number.POSITIVE_INFINITY,n[3]=t.maxError!==undefined?t.maxError:Number.POSITIVE_INFINITY,n[4]=-1,e._removeOnBreak=t.removeOnBreak!==undefined?t.removeOnBreak:!0,e._breakUnderError=t.breakUnderError!==undefined?t.breakUnderError:!1,e._breakUnderForce=t.breakUnderForce!==undefined?t.breakUnderForce:!1,e._stiff=t.stiff!==undefined?t.stiff:!0,e._ignoreInteractions=t.ignoreInteractions!==undefined?t.ignoreInteractions:!1,e.sleeping=t.sleeping!==undefined?t.sleeping:!1,e._active=t.disabled!==undefined?!t.disabled:!0,e.world=null,e._islandRoot=null,e._islandRank=0,e._island=null,e._isBody=!1,e._wakeTime=0,e._onBreak=[],e._onWake=[],e._onSleep=[],e.userData=t.userData||null},e.prototype.configure=function(e){var t=this._data;e.frequency!==undefined&&(t[0]=e.frequency),e.damping!==undefined&&(t[1]=e.damping),e.maxForce!==undefined&&(t[2]=e.maxForce),e.maxError!==undefined&&(t[3]=e.maxError),e.removeOnBreak!==undefined&&(this._removeOnBreak=e.removeOnBreak),e.breakUnderError!==undefined&&(this._breakUnderError=e.breakUnderError),e.breakUnderForce!==undefined&&(this._breakUnderForce=e.breakUnderForce),e.ignoreInteractions!==undefined&&(this._ignoreInteractions=e.ignoreInteractions),e.stiff!==undefined&&(this._stiff=e.stiff),this.wake(!0)},e.prototype.addEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:e==="break"?this._onBreak:null;if(n===null)return!1;var r=n.indexOf(t);return r!==-1?!1:(n.push(t),this.wake(),!0)},e.prototype.removeEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:e==="break"?this._onBreak:null;if(n===null)return!1;var r=n.indexOf(t);return r===-1?!1:(n.splice(r,1),this.wake(),!0)},e.prototype.wake=function(e){if(!this.world){this.sleeping=!1;return}this.world._wakeConstraint(this,!e)},e.prototype.sleep=function(){if(!this.world){this.sleeping=!0;return}this.world._forceSleepConstraint(this)},e.prototype.isEnabled=function(){return this._active},e.prototype.isDisabled=function(){return!this._active},e.prototype.enable=function(){this._active||(this._active=!0,this.world&&(this.world._enabledConstraint(this),this.wake(!0)))},e.prototype.disable=function(){this._active&&(this.world&&(this.wake(!1),this.world._disabledConstraint(this)),this._active=!1)},e.prototype.getAnchorA=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_A;return e[0]=t[n],e[1]=t[n+1],e},e.prototype.getAnchorB=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_B;return e[0]=t[n],e[1]=t[n+1],e},e.prototype.setAnchorA=function(e){var t=this._data,n=this._ANCHOR_A,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},e.prototype.setAnchorB=function(e){var t=this._data,n=this._ANCHOR_B,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},e.prototype.rotateAnchor=function(e,t,n,r){var i=e[n],s=e[n+1],o=t[5],u=t[6];e[r]=o*i-u*s,e[r+1]=u*i+o*s},e.prototype.dtRatio=function(e,t){var n=e[4],r=n===-1?1:t/n;return e[4]=t,r},e.prototype.twoBodyInWorld=function(){this.bodyA.constraints.push(this),this.bodyB.constraints.push(this)},e.prototype.twoBodyOutWorld=function(){var e=this.bodyA.constraints,t=e.indexOf(this);e[t]=e[e.length-1],e.pop(),e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()},e.prototype.twoBodyPairExists=function(e,t){return e===this.bodyA&&t===this.bodyB||t===this.bodyA&&e===this.bodyB},e.prototype.twoBodyWakeConnected=function(){var e=this.bodyA;e._type===0&&e.wake(!0),e=this.bodyB,e._type===0&&e.wake(!0)},e.prototype.twoBodySleepComputation=function(e){var t=this.bodyA;t._type===0&&e(t,this),t=this.bodyB,t._type===0&&e(t,this)},e.prototype._clearCache=function(){},e.prototype.clearCache=function(){var e=this._data;e[this._JACC]=0,e[4]=-1},e.prototype.clearCache2=function(){var e=this._data,t=this._JACC;e[t]=e[t+1]=0,e[4]=-1},e.prototype.clearCache3=function(){var e=this._data,t=this._JACC;e[t]=e[t+1]=e[t+2]=0,e[4]=-1},e.prototype.soft_params=function(e,t,n,r,i,s){var o=e[r],u=o*o,a=e[3];if(s&&u>a*a)return!0;var f=2*Math.PI*e[0],l=1/(i*f*(2*e[1]+f*i)),c=1/(1+l),h=i*f*f*l;return e[n]=l*c,e[t]*=c,o*=h,u*=h*h,u>a*a&&(u=a/Math.sqrt(u),o*=u),e[r]=o,!1},e.prototype.soft_params2=function(e,t,n,r,i,s){var o=e[r],u=e[r+1],a=o*o+u*u,f=e[3];if(s&&a>f*f)return!0;var l=2*Math.PI*e[0],c=1/(i*l*(2*e[1]+l*i)),h=1/(1+c),p=i*l*l*c;return e[n]=c*h,e[t]*=h,e[t+1]*=h,e[t+2]*=h,o*=p,u*=p,a*=p*p,a>f*f&&(a=f/Math.sqrt(a),o*=a,u*=a),e[r]=o,e[r+1]=u,!1},e.prototype.soft_params3=function(e,t,n,r,i,s){var o=e[r],u=e[r+1],a=e[r+2],f=o*o+u*u+a*a,l=e[3];if(s&&f>l*l)return!0;var c=2*Math.PI*e[0],h=1/(i*c*(2*e[1]+c*i)),p=1/(1+h),d=i*c*c*h;return e[n]=h*p,e[t]*=p,e[t+1]*=p,e[t+2]*=p,e[t+3]*=p,e[t+4]*=p,e[t+5]*=p,o*=d,u*=d,a*=d,f*=d*d,f>l*l&&(f=l/Math.sqrt(f),o*=f,u*=f,a*=f),e[r]=o,e[r+1]=u,e[r+2]=a,!1},e.prototype.safe_solve=function(e,t,n,r){var i=e[n],s=e[t];e[r]=s!==0?i/s:0},e.prototype.safe_solve2=function(e,t,n,r){var i=e[n],s=e[n+1],o=e[t],u=e[t+1],a=e[t+2],f=o*a-u*u;f===0?(e[r]=o!==0?i/o:0,e[r+1]=a!==0?s/a:0):(f=1/f,e[r]=f*(a*i-u*s),e[r+1]=f*(o*s-u*i))},e.prototype.safe_solve3=function(e,t,n,r){var i=e[n],s=e[n+1],o=e[n+2],u=e[t],a=e[t+1],f=e[t+2],l=e[t+3],c=e[t+4],h=e[t+5],p=l*h-c*c,d=f*c-a*h,v=a*c-f*l,m=u*p+a*d+f*v;if(m===0){m=u*l-a*a;if(m!==0){m=1/m,e[r]=m*(l*i-a*s),e[r+1]=m*(u*s-a*i),e[r+2]=h!==0?o/h:0;return}m=u*h-f*f;if(m!==0){m=1/m,e[r]=m*(h*i-f*o),e[r+1]=l!==0?s/l:0,e[r+2]=m*(u*o-f*i);return}m=l*h-c*c;if(m!==0){m=1/m,e[r]=u!==0?i/u:0,e[r+1]=m*(h*s-c*o),e[r+2]=m*(l*o-c*s);return}e[r]=u!==0?i/u:0,e[r+1]=l!==0?s/l:0,e[r+2]=h!==0?o/h:0}else{m=1/m;var g=u*h-f*f,y=a*f-u*c,b=u*l-a*a;e[r]=m*(p*i+d*s+v*o),e[r+1]=m*(d*i+g*s+y*o),e[r+2]=m*(v*i+y*s+b*o)}},e.prototype.safe_invert=function(e,t,n){var r=e[t];r===0?e[n]=0:e[t]=1/r},e.prototype.safe_invert2=function(e,t,n){var r=e[t],i=e[t+1],s=e[t+2],o=r*s-i*i;o===0?(r!==0?e[t]=1/r:e[n]=0,s!==0?e[t+2]=1/s:e[n+1]=0,e[t+1]=0):(o=1/o,e[t]=o*s,e[t+1]=o*-i,e[t+2]=o*r)},e.prototype.safe_invert3=function(e,t,n){var r=e[t],i=e[t+1],s=e[t+2],o=e[t+3],u=e[t+4],a=e[t+5],f=o*a-u*u,l=s*u-i*a,c=i*u-s*o,h=r*f+i*l+s*c;if(h===0){h=r*o-i*i;if(h!==0){h=1/h,e[t]=h*o,e[t+1]=h*-i,e[t+3]=h*r,a!==0?e[t+5]=1/a:e[n+2]=0,e[t+2]=e[t+4]=0;return}h=r*a-s*s;if(h!==0){h=1/h,e[t]=h*a,e[t+2]=h*-s,e[t+5]=h*r,o!==0?e[t+3]=1/o:e[n+1]=0,e[t+1]=e[t+4]=0;return}h=o*a-u*u;if(h!==0){h=1/h,e[t+3]=h*a,e[t+4]=h*-u,e[t+5]=h*o,r!==0?e[t]=1/r:e[n]=0,e[t+1]=e[t+2]=0;return}r!==0?e[t]=1/r:e[n]=0,o!==0?e[t+3]=1/o:e[n+1]=0,a!==0?e[t+5]=1/a:e[n+2]=0,e[t+1]=e[t+2]=e[t+4]=0}else h=1/h,e[t]=h*f,e[t+1]=h*l,e[t+2]=h*c,e[t+3]=h*(r*a-s*s),e[t+4]=h*(i*s-r*u),e[t+5]=h*(r*o-i*i)},e}(),S=function(e){function t(){e.apply(this,arguments),this.type="CUSTOM"}return y(t,e),t.prototype._inWorld=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1)e[n].constraints.push(this)},t.prototype._outWorld=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1){var r=e[n].constraints,i=r.indexOf(this);r[i]=r[r.length-1],r.pop()}},t.prototype._pairExists=function(e,t){var n=this.bodies,r=n.length,i;for(i=0;i<r;i+=1){var s=n[i];if(s===e||s===t){var o;for(o=i+1;o<r;o+=1){var u=n[o];if(s===e&&u===t||s===t&&u===e)return!0}}}return!1},t.prototype._wakeConnected=function(){var e=this.bodies,t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r._type===0&&r.wake(!0)}},t.prototype._sleepComputation=function(e){var t=this.bodies,n=t.length,r;for(r=0;r<n;r+=1){var i=t[r];i._type===0&&e(i,this)}},t.prototype._clearCache=function(){var e=this._data,t=this._J_ACC,n=t+this.dimension,r;for(r=t;r<n;r+=1)e[r]=0;e[4]=-1},t.prototype._cholesky=function(){var e=this._data,t=this._K_MASS,n=this._K_CHOLESKY,r=this.dimension,i;for(i=0;i<r;i+=1){var s=0,o;for(o=0;o<=i-1;o+=1){var u=e[n+i*r+o];s+=u*u}var a=e[t]-s,f=a<=0;f&&(a=e[t]),a=a<=0?0:Math.sqrt(a),t+=1,e[n+i*r+i]=a;var l;if(a!==0&&!f){a=1/a;for(l=i+1;l<r;l+=1){s=0;for(o=0;o<=i-1;o+=1)s+=e[n+l*r+o]*e[n+i*r+o];e[n+l*r+i]=a*(e[t]-s),t+=1}}if(f){for(l=i+1;l<r;l+=1)e[n+l*r+i]=0;for(l=0;l<i;l+=1)e[n+i*r+l]=0;t+=r-i-1}}},t.prototype._transform=function(e){var t=this._data,n=this._VECTOR_TMP,r=this._K_CHOLESKY,i=this.dimension,s,o,u,a;for(s=0;s<i;s+=1){u=t[e+s],o=t[r+s*i+s];if(o!==0){for(a=0;a<s;a+=1)u-=t[r+s*i+a]*t[n+a];t[n+s]=u/o}else t[n+s]=0}var f;for(f=0;f<i;f+=1){s=i-1-f,o=t[r+s*i+s];if(o!==0){u=t[n+s];for(a=s+1;a<i;a+=1)u-=t[r+a*i+s]*t[e+a];t[e+s]=u/o}else t[e+s]=0}},t.prototype._effMass=function(){var e=this._data,t=this.dimension,n=this.bodies,r=n.length,i=r*3,s=this._JACOBIAN,o=this._K_MASS,u,a,f;for(u=0;u<t;u+=1){var l=s+u*i;for(a=u;a<t;a+=1){var c=s+a*i,h=0;for(f=0;f<r;f+=1){var p=n[f]._data,d=f*3;h+=p[0]*(e[l+d]*e[c+d]+e[l+d+1]*e[c+d+1]),h+=p[1]*e[l+d+2]*e[c+d+2]}e[o]=h,o+=1}}},t.prototype._preStep=function(e){var t=this.dimension,n=this._data,r,i;this._posConsts&&this._posConsts.call(this);var s=this._JACOBIAN,o=this._K_CHOLESKY,u=this._BIAS;if(!this._stiff&&!this._velocityOnly){this._posError.call(this,n,u),this._jacobian.call(this,n,s),this._effMass(),this._cholesky();var a=0;i=u+t;for(r=u;r<i;r+=1){var f=n[r];a+=f*f}var l=n[3];if(this._breakUnderError&&a>l*l)return!0;var c=2*Math.PI*n[0],h=1/(e*c*(2*n[1]+c*e)),p=1/(1+h),d=-(e*c*c*h);n[6]=h*p,i=o+t*t,p=1/Math.sqrt(p);for(r=o;r<i;r+=1)n[r]*=p;a*=d*d,a>l*l&&(d*=l/Math.sqrt(a)),i=u+t;for(r=u;r<i;r+=1)n[r]*=d}else{this._jacobian.call(this,n,s),this._effMass(),this._cholesky(),i=u+t;for(r=u;r<i;r+=1)n[r]=0;n[6]=0}var v=E.prototype.dtRatio(n,e),m=this._J_ACC;i=m+this.dimension;for(r=m;r<i;r+=1)n[r]*=v;return n[5]=n[2]*e,!1},t.prototype._warmStart=function(){this._applyImpulse(this._J_ACC)},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=this._JACOBIAN,i=this._J_ACC,s=this.bodies,o=s.length,u=o*3,a=this.dimension,f;for(f=0;f<o;f+=1){var l=s[f];if(l===e){var c=0,h=0,p=0,d;for(d=0;d<a;d+=1)c+=n[i+d]*n[r+u*d],h+=n[i+d]*n[r+u*d+1],p+=n[i+d]*n[r+u*d+2];return t[0]=c,t[1]=h,t[2]=p,t}r+=3}return t[0]=t[1]=t[2]=0,t},t.prototype._applyImpulse=function(e,t){var n=this._data,r=this._JACOBIAN,i=this.bodies,s=i.length,o=s*3,u=this.dimension,a;for(a=0;a<s;a+=1){var f=i[a],l=f._data,c=0,h=0,p=0,d;for(d=0;d<u;d+=1)c+=n[e+d]*n[r+o*d],h+=n[e+d]*n[r+o*d+1],p+=n[e+d]*n[r+o*d+2];var v=l[0],m=p*l[1];t?(l[2]+=c*v,l[3]+=h*v,m!==0&&f._deltaRotation(m)):(l[7]+=c*v,l[8]+=h*v,l[9]+=m),r+=3}},t.prototype._iterateVel=function(){var e=this.dimension,t=this._data,n,r,i=this._VECTOR,s=this._BIAS,o,u=this.bodies,a=u.length,f=this._JACOBIAN;for(n=0;n<e;n+=1){var l=t[s+n];for(o=0;o<a;o+=1){var c=u[o]._data;l-=c[7]*t[f]+c[8]*t[f+1]+c[9]*t[f+2],f+=3}t[i+n]=l}this._transform(i);var h=this._J_ACC,p=this._VECTOR_TMP,d,v=t[6];for(n=0;n<e;n+=1)d=t[p+n]=t[h+n],t[h+n]+=t[i+n]-d*v;this._velClamp&&this._velClamp.call(this,t,h);var m=0;r=h+e;for(n=h;n<r;n+=1)d=t[n],m+=d*d;var g=t[5];if(this._breakUnderForce&&m>g*g)return!0;if(!this._stiff&&m>g*g){m=g/Math.sqrt(m);for(n=h;n<r;n+=1)t[n]*=m}for(n=0;n<e;n+=1)t[i+n]=t[h+n]-t[p+n];return this._applyImpulse(i),!1},t.prototype._iteratePos=function(){if(this._velocityOnly)return!1;this._posConsts&&this._posConsts.call(this);var e=this.dimension,t=this._data,n,r,i=this._BIAS;this._posError.call(this,t,i),r=i+e;var s,o=0;for(n=i;n<r;n+=1)s=t[n],o+=s*s,t[n]=-s;var u=t[3];if(this._breakUnderError&&o>u*u)return!0;var a=this._JACOBIAN;return this._jacobian.call(this,t,a),this._effMass(),this._cholesky(),this._transform(i),this._posClamp&&this._posClamp.call(this,t,i),this._applyImpulse(i,!0),!1},t.create=function(e){var n=new t,r=n.dimension=e.dimension;n.bodies=e.bodies.concat();var i=7+(r*(4+r)+r*(r+1)/2);return i+=r*n.bodies.length*3,n._data=new X.prototype.floatArray(i),E.prototype.init(n,e),n._K_MASS=7,n._K_CHOLESKY=n._K_MASS+r*(r+1)/2,n._BIAS=n._K_CHOLESKY+r*r,n._J_ACC=n._BIAS+r,n._VECTOR=n._J_ACC+r,n._JACOBIAN=n._VECTOR+r,n._VECTOR_TMP=n._JACOBIAN+r*n.bodies.length*3,n._draw=e.debugDraw,n._posConsts=e.positionConstants,n._posError=e.position,n._posClamp=e.positionClamp,n._velClamp=e.velocityClamp,n._jacobian=e.jacobian,n._velocityOnly=n._posError===undefined,n},t}(E),x=function(e){function t(){e.apply(this,arguments),this.type="PULLEY",this.dimension=1,this._ANCHOR_A=11,this._ANCHOR_B=13,this._ANCHOR_C=15,this._ANCHOR_D=17,this._JACC=9}return y(t,e),t.prototype.getRatio=function(){return this._data[7]},t.prototype.setRatio=function(e){var t=this._data;t[7]!==e&&(t[7]=e,this.wake(!0))},t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.getAnchorC=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_C;return e[0]=t[n],e[1]=t[n+1],e},t.prototype.setAnchorC=function(e){var t=this._data,n=this._ANCHOR_C,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},t.prototype.getAnchorD=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data,n=this._ANCHOR_D;return e[0]=t[n],e[1]=t[n+1],e},t.prototype.setAnchorD=function(e){var t=this._data,n=this._ANCHOR_D,r=e[0],i=e[1];if(r!==t[n]||i!==t[n+1])t[n]=r,t[n+1]=i,this.wake(!0)},t.prototype._inWorld=function(){this.bodyA.constraints.push(this),this.bodyB.constraints.push(this),this.bodyB!==this.bodyC&&this.bodyC.constraints.push(this),this.bodyD.constraints.push(this)},t.prototype._outWorld=function(){var e=this.bodyA.constraints,t=e.indexOf(this);e[t]=e[e.length-1],e.pop(),e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop(),this.bodyB!==this.bodyC&&(e=this.bodyB.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()),e=this.bodyD.constraints,t=e.indexOf(this),e[t]=e[e.length-1],e.pop()},t.prototype._pairExists=function(e,t){var n=this.bodyA,r=this.bodyB,i=this.bodyC,s=this.bodyD;return e===n&&(t===r||t===i||t===s)||e===r&&(t===n||t===i||t===s)||e===i&&(t===n||t===r||t===s)||e===s&&(t===n||t===r||t===i)},t.prototype._wakeConnected=function(){var e=this.bodyA;e._type===0&&e.wake(!0),e=this.bodyB,e._type===0&&e.wake(!0),e=this.bodyC,e!==this.bodyB&&e._type===0&&e.wake(!0),e=this.bodyD,e._type===0&&e.wake(!0)},t.prototype._sleepComputation=function(e){var t=this.bodyA;t._type===0&&e(t,this),t=this.bodyB,t._type===0&&e(t,this),t=this.bodyC,t!==this.bodyB&&t._type===0&&e(t,this),t=this.bodyD,t._type===0&&e(t,this)},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data;E.prototype.rotateAnchor(e,t,11,19),E.prototype.rotateAnchor(e,n,13,21),E.prototype.rotateAnchor(e,r,15,23),E.prototype.rotateAnchor(e,i,17,25);var s=e[5],o=e[6],u=n[2]+e[21]-(t[2]+e[19]),a=n[3]+e[22]-(t[3]+e[20]),f=i[2]+e[25]-(r[2]+e[23]),l=i[3]+e[26]-(r[3]+e[24]),c=u*u+a*a,h=f*f+l*l,p;c<b.NORMALIZE_SQ_EPSILON?(c=0,u=e[29],a=e[30]):(c=Math.sqrt(c),p=1/c,u*=p,a*=p);var d=e[7];h<b.NORMALIZE_SQ_EPSILON?(h=0,f=e[31],l=e[32]):(h=Math.sqrt(h),p=d/h,f*=p,l*=p);var v=c+h*d;this._equal?(v-=s,this._slack=!1):v<s?(v=s-v,u=-u,a=-a,f=-f,l=-l,this._slack=!1):v>o?(v-=o,this._slack=!1):(u=-u,a=-a,f=-f,l=-l,v=0,this._slack=!0),e[29]=u,e[30]=a,e[31]=f,e[32]=l,e[28]=-v},t.prototype._preStep=function(e){this._posError();if(this._slack)return!1;var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=this.bodyC._data,s=this.bodyD._data,o=t[7];o*=o;var u=t[29],a=t[30],f=t[31],l=t[32],c=t[33]=t[19]*a-t[20]*u,h=t[34]=t[21]*a-t[22]*u,p=t[35]=t[23]*l-t[24]*f,d=t[36]=t[25]*l-t[26]*f,v=i[0],m=i[1],g=n[0]+r[0]+o*(v+s[0])+c*n[1]*c+h*r[1]*h+p*m*p+d*s[1]*d;r===i&&(g-=2*((u*f+a*l)*v+h*p*m)),t[8]=g,E.prototype.safe_invert(t,8,9);if(!this._stiff){if(E.prototype.soft_params(t,8,27,28,e,this._breakUnderError))return!0}else t[27]=0,t[28]=0;var y=E.prototype.dtRatio(t,e);return t[9]*=y,t[10]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=e[9],o=e[29]*s,u=e[30]*s,a=t[0];t[7]-=o*a,t[8]-=u*a,t[9]-=e[33]*s*t[1],a=n[0],n[7]+=o*a,n[8]+=u*a,n[9]+=e[34]*s*n[1],o=e[31]*s,u=e[32]*s,a=r[0],r[7]-=o*a,r[8]-=u*a,r[9]-=e[35]*s*r[1],a=i[0],i[7]+=o*a,i[8]+=u*a,i[9]+=e[36]*s*i[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=r[9],r=this._data;if(e===this.bodyA)t[0]=-(r[29]*n),t[1]=-(r[30]*n),t[2]=-r[33]*n;else if(e===this.bodyD)t[0]=r[31]*n,t[1]=r[32]*n,t[2]=r[36]*n;else{var i=0,s=0,o=0;e===this.bodyB&&(i+=r[29]*n,s+=r[30]*n,o+=r[34]*n),e===this.bodyC&&(i-=r[31]*n,s-=r[32]*n,o-=r[35]*n),t[0]=i,t[1]=s,t[2]=o}return t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=e[29],o=e[30],u=e[31],a=e[32],f=e[33],l=e[34],c=e[35],h=e[36],p=e[28]-(s*(n[7]-t[7])+o*(n[8]-t[8])+u*(i[7]-r[7])+a*(i[8]-r[8])+l*n[9]-f*t[9]+h*i[9]-c*r[9]),d=e[9],v=e[8]*p-d*e[27],m=d+v,g=e[10];!this._equal&&m>0&&(m=0);if(this._breakUnderForce){if(m>g||m<-g)return!0}else this._stiff||(m>g?m=g:m<-g&&(m=-g));v=m-d,e[9]=m;var y=e[29]*v,b=e[30]*v,w=t[0];return t[7]-=y*w,t[8]-=b*w,t[9]-=f*v*t[1],w=n[0],n[7]+=y*w,n[8]+=b*w,n[9]+=l*v*n[1],y=e[31]*v,b=e[32]*v,w=r[0],r[7]-=y*w,r[8]-=b*w,r[9]-=c*v*r[1],w=i[0],i[7]+=y*w,i[8]+=b*w,i[9]+=h*v*i[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=this.bodyC._data,i=this.bodyD._data,s=t[0],o=n[0],u=r[0],a=i[0],f=t[1],l=n[1],c=r[1],h=i[1],p=e[28],d=e[3];if(this._breakUnderError&&(p>d||p<-d))return!0;var v=b.PULLEY_SLOP_SQ;if(p*p<v)return!1;p*=b.PULLEY_BIAS_COEF;var m=e[7];m*=m;var g=s+o+m*(u+a),y=e[29],w=e[30],S=e[31],x=e[32];n===r&&(g-=2*(y*S+w*x)*o);var T,N,C;if(p*p>b.PULLEY_LARGE_ERROR_SQ&&g>b.EFF_MASS_EPSILON){T=p*b.PULLEY_LARGE_ERROR_BIAS/g;if(this._equal||T<0)N=y*T,C=w*T,t[2]-=N*s,t[3]-=C*s,n[2]+=N*o,n[3]+=C*o,N=S*T,C=x*T,r[2]-=N*u,r[3]-=C*u,i[2]+=N*a,i[3]+=C*a,this._posError(),y=e[29],w=e[30],S=e[31],x=e[32],p=e[28]*b.PULLEY_BIAS_COEF}var k=e[19]*w-e[20]*y,L=e[21]*w-e[22]*y,A=e[23]*x-e[24]*S,O=e[25]*x-e[26]*S;g+=k*f*k+L*l*L+A*c*A+O*h*O,n===n&&(g-=2*L*l*A),e[8]=g,e[28]=p,E.prototype.safe_solve(e,8,28,28),T=e[28];if(this._equal||T<0){var M;N=y*T,C=w*T,t[2]-=N*s,t[3]-=C*s,M=-k*T*f,M!==0&&this.bodyA._deltaRotation(M),n[2]+=N*o,n[3]+=C*o,M=L*T*l,M!==0&&this.bodyB._deltaRotation(M),N=S*T,C=x*T,r[2]-=N*u,r[3]-=C*u,M=-A*T*c,M!==0&&this.bodyC._deltaRotation(M),i[2]+=N*a,i[3]+=C*a,M=O*T*h,M!==0&&this.bodyD._deltaRotation(M)}return!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(37);E.prototype.init(n,e);var i=e.anchorA;r[11]=i?i[0]:0,r[12]=i?i[1]:0,i=e.anchorB,r[13]=i?i[0]:0,r[14]=i?i[1]:0,i=e.anchorC,r[15]=i?i[0]:0,r[16]=i?i[1]:0,i=e.anchorD,r[17]=i?i[0]:0,r[18]=i?i[1]:0;var s=r[5]=e.lowerBound!==undefined?e.lowerBound:0,o=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=s===o,r[7]=e.ratio!==undefined?e.ratio:1,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n.bodyC=e.bodyC,n.bodyD=e.bodyD,r[29]=1,r[30]=0,r[31]=1,r[32]=0,n},t}(E),T=function(e){function t(){e.apply(this,arguments),this.type="MOTOR",this.dimension=1,this._JACC=8}return y(t,e),t.prototype.getRate=function(){return this._data[5]},t.prototype.getRatio=function(){return this._data[6]},t.prototype.setRate=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this.wake(!0))},t.prototype.setRatio=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this.wake(!0))},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[6];t[7]=n[1]+i*i*r[1],E.prototype.safe_invert(t,7,8);var s=E.prototype.dtRatio(t,e);return t[8]*=s,t[9]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[8];t[9]-=r*t[1],n[9]+=e[6]*r*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data;return t[0]=t[1]=0,t[2]=(e===this.bodyA?-1:e===this.bodyB?n[6]:0)*n[8],t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[6],i=e[7]*(e[5]+t[9]-r*n[9]),s=e[8],o=s+i,u=e[9];return this._breakUnderForce&&(o>u||o<-u)?!0:(o>u?o=u:o<-u&&(o=-u),i=o-s,e[8]=o,t[9]-=i*t[1],n[9]+=r*i*n[1],!1)},t.prototype._iteratePos=function(){return!1},t.create=function(e){var n=new t,r=n._data=new 
X.prototype.floatArray(10);return E.prototype.init(n,e),r[5]=e.rate!==undefined?e.rate:0,r[6]=e.ratio!==undefined?e.ratio:1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(E);T.prototype._inWorld=E.prototype.twoBodyInWorld,T.prototype._outWorld=E.prototype.twoBodyOutWorld,T.prototype._pairExists=E.prototype.twoBodyPairExists,T.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,T.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var N=function(e){function t(){e.apply(this,arguments),this.type="LINE",this.dimension=2,this._ANCHOR_A=7,this._ANCHOR_B=9,this._JACC=22}return y(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.getAxis=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[11],e[1]=t[12],e},t.prototype.setAxis=function(e){var t=this._data,n=e[0],r=e[1];if(n!==t[11]||r!==t[12]){var i=n*n+r*r;if(i===0)return;i=1/Math.sqrt(i),n*=i,r*=i,t[11]=n,t[12]=r,this.wake(!0)}},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data;E.prototype.rotateAnchor(e,t,7,13),E.prototype.rotateAnchor(e,n,9,15),E.prototype.rotateAnchor(e,t,11,17);var r=e[5],i=e[6],s=e[13],o=e[14],u=e[15],a=e[16],f=e[17],l=e[18],c=e[28]=n[2]+u-(t[2]+s),h=e[29]=n[3]+a-(t[3]+o),p=f*h-l*c,d=f*c+l*h;this._equal?(d-=r,e[32]=1):d>i?(d-=i,e[32]=1):d<r?(d=r-d,e[32]=-1):(d=0,e[32]=0),e[26]=-p,e[27]=-d},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;this._posError();var i=t[13],s=t[14],o=t[15],u=t[16],a=t[17],f=t[18],l=t[32],c=t[28]+i,h=t[29]+s,p=t[28]=a*h-f*c,d=t[29]=a*u-f*o,v=t[30]=a*c+f*h,m=t[31]=a*o+f*u,g=n[0]+r[0],y=n[1],b=r[1];t[19]=g+v*y*v+m*b*m,t[20]=-l*(v*y*p+m*b*d),t[21]=l*l*(g+p*y*p+d*b*d),E.prototype.safe_invert2(t,19,22);if(!this._stiff){if(E.prototype.soft_params2(t,19,25,26,e,this._breakUnderError))return!0}else t[25]=0,t[26]=0,t[27]=0;var w=E.prototype.dtRatio(t,e);return t[22]*=w,t[23]*=w,t[24]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[22],i=e[23],s=e[32],o=e[17],u=e[18],a=s*o*i-u*r,f=o*r+s*u*i,l=t[0];t[7]-=a*l,t[8]-=f*l,t[9]+=(s*e[28]*i-e[30]*r)*t[1],l=n[0],n[7]+=a*l,n[8]+=f*l,n[9]+=(e[31]*r-s*e[29]*i)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[22],i=n[23],s=n[32],o=n[17],u=n[18],a=s*o*i-u*r,f=o*r+s*u*i;return e===this.bodyA?(t[0]=-a,t[1]=-f,t[2]=s*n[28]*i-n[30]*r):e===this.bodyB?(t[0]=a,t[1]=f,t[2]=n[31]*r-s*n[29]*i):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[32],i=e[17],s=e[18],o=e[28],u=e[29],a=e[30],f=e[31],l=n[7]-t[7],c=n[8]-t[8],h=t[9],p=n[9],d=e[26]-(i*c-s*l+p*f-h*a),v=e[27]-r*(i*l+s*c-p*u+h*o),m=e[22],g=e[23],y=e[25],b=e[20],w=e[19]*d+b*v-m*y,E=b*d+e[21]*v-g*y,S=m+w,x=g+E;!this._equal&&x>0&&(x=0);var T=S*S+x*x,N=e[24];if(this._breakUnderForce){if(T>N*N)return!0}else this._stiff||T>N*N&&(T=N/Math.sqrt(T),S*=T,x*=T);w=S-m,E=x-g,e[22]=S,e[23]=x;var C=r*i*E-s*w,k=i*w+r*s*E,L=t[0];return t[7]-=C*L,t[8]-=k*L,t[9]+=(r*o*E-a*w)*t[1],L=n[0],n[7]+=C*L,n[8]+=k*L,n[9]+=(f*w-r*u*E)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data;this._posError();var r=e[26],i=e[27],s=r*r+i*i,o=e[3];if(this._breakUnderError&&s>o*o)return!0;var u=b.LINE_SLOP_SQ;if(s<u)return!1;var a=b.LINE_BIAS_COEF;r*=a,i*=a,s*=a*a;var f=t[0],l=n[0],c=t[1],h=n[1],p=f+l,d=e[17],v=e[18],m=e[32],g,y;if(s>b.LINE_LARGE_ERROR_SQ&&p>b.EFF_MASS_EPSILON){var w=b.LINE_LARGE_ERROR_BIAS/p;g=w*(v*r-m*d*i),y=w*(d*r*m-v*r),t[2]-=g*f,t[3]-=y*f,n[2]+=g*l,n[3]+=y*l,this._posError(),d=e[17],v=e[18],m=e[32],r=e[26]*a,i=e[27]*a}var S=e[13],x=e[14],T=e[15],N=e[16],C=e[28]+S,k=e[29]+x,L=d*k-v*C,A=d*N-v*T,O=d*C+v*k,M=d*T+v*N;e[19]=p+O*c*O+M*h*M,e[20]=-m*(O*c*L+M*h*A),e[21]=m*m*(p+L*c*L+A*h*A),e[26]=r,e[27]=i,E.prototype.safe_solve2(e,19,26,26);var _=e[26],D=e[27];!this._equal&&D>0&&(D=0),g=m*d*D-v*_,y=d*_+m*v*D,t[2]-=g*f,t[3]-=y*f;var P=(m*L*D-O*_)*c;return P!==0&&this.bodyA._deltaRotation(P),n[2]+=g*l,n[3]+=y*l,P=(M*_-m*A*D)*h,P!==0&&this.bodyB._deltaRotation(P),!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(33);E.prototype.init(n,e);var i=e.anchorA;r[7]=i?i[0]:0,r[8]=i?i[1]:0,i=e.anchorB,r[9]=i?i[0]:0,r[10]=i?i[1]:0,i=e.axis,r[11]=i[0],r[12]=i[1];var s=r[5]=e.lowerBound!==undefined?e.lowerBound:Number.NEGATIVE_INFINITY,o=r[6]=e.upperBound!==undefined?e.upperBound:Number.POSITIVE_INFINITY;return n._equal=s===o,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(E);N.prototype._inWorld=E.prototype.twoBodyInWorld,N.prototype._outWorld=E.prototype.twoBodyOutWorld,N.prototype._pairExists=E.prototype.twoBodyPairExists,N.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,N.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var C=function(e){function t(){e.apply(this,arguments),this.type="DISTANCE",this.dimension=1,this._ANCHOR_A=7,this._ANCHOR_B=9,this._JACC=16}return y(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[5],i=e[6];E.prototype.rotateAnchor(e,t,7,11),E.prototype.rotateAnchor(e,n,9,13);var s=n[2]+e[13]-(t[2]+e[11]),o=n[3]+e[14]-(t[3]+e[12]),u=s*s+o*o;if(u<b.NORMALIZE_SQ_EPSILON)s=e[20],o=e[21],u=0;else{u=Math.sqrt(u);var a=1/u;s*=a,o*=a}this._equal?(u-=r,this._slack=!1):u<r?(u=r-u,s=-s,o=-o,this._slack=!1):u>i?(u-=i,this._slack=!1):(s=-s,o=-o,u=0,this._slack=!0),e[20]=s,e[21]=o,e[19]=-u},t.prototype._preStep=function(e){this._posError();if(this._slack)return!1;var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[20],s=t[21],o=t[22]=t[11]*s-t[12]*i,u=t[23]=t[13]*s-t[14]*i;t[15]=n[0]+o*n[1]*o+r[0]+u*r[1]*u,E.prototype.safe_invert(t,15,16);if(!this._stiff){if(E.prototype.soft_params(t,15,18,19,e,this._breakUnderError))return!0}else t[18]=0,t[19]=0;var a=E.prototype.dtRatio(t,e);return t[16]*=a,t[17]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[16],i=e[20]*r,s=e[21]*r,o=t[0];t[7]-=i*o,t[8]-=s*o,t[9]-=e[22]*r*t[1],o=n[0],n[7]+=i*o,n[8]+=s*o,n[9]+=e[23]*r*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[16],i=n[20]*r,s=n[21]*r;return e===this.bodyA?(t[0]=-i,t[1]=-s,t[2]=-(n[22]*r)):e===this.bodyB?(t[0]=i,t[1]=s,t[2]=n[23]*r):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[20],i=e[21],s=e[22],o=e[23],u=e[19]-(r*(n[7]-t[7])+i*(n[8]-t[8])+o*n[9]-s*t[9]),a=e[16],f=e[15]*u-a*e[18],l=a+f,c=e[17];!this._equal&&l>0&&(l=0);if(this._breakUnderForce){if(l>c||l<-c)return!0}else this._stiff||(l>c?l=c:l<-c&&(l=-c));f=l-a,e[16]=l;var h=r*f,p=i*f,d=t[0];return t[7]-=h*d,t[8]-=p*d,t[9]-=e[22]*f*t[1],d=n[0],n[7]+=h*d,n[8]+=p*d,n[9]+=e[23]*f*n[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1],u=e[19],a=e[3];if(this._breakUnderError&&(u>a||u<-a))return!0;var f=b.DIST_SLOP_SQ;if(u*u<f)return!1;u*=b.DIST_BIAS_COEF;var l=r+i,c=e[20],h=e[21],p,d,v;if(u*u>b.DIST_LARGE_ERROR_SQ&&l>b.EFF_MASS_EPSILON){p=u*b.DIST_LARGE_ERROR_BIAS/l;if(this._equal||p<0)d=c*p,v=h*p,t[2]-=d*r,t[3]-=v*r,n[2]+=d*i,n[3]+=v*i,this._posError(),u=e[19]*b.DIST_BIAS_COEF,c=e[20],h=e[21]}var m=e[11]*h-e[12]*c,g=e[13]*h-e[14]*c;e[15]=l+m*s*m+g*o*g,e[19]=u,E.prototype.safe_solve(e,15,19,19),p=e[19];if(this._equal||p<0){d=c*p,v=h*p,t[2]-=d*r,t[3]-=v*r;var y=-m*s*p;y!==0&&this.bodyA._deltaRotation(y),n[2]+=d*i,n[3]+=v*i,y=g*o*p,y!==0&&this.bodyB._deltaRotation(y)}return!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(24);E.prototype.init(n,e);var i=e.anchorA;r[7]=i?i[0]:0,r[8]=i?i[1]:0,i=e.anchorB,r[9]=i?i[0]:0,r[10]=i?i[1]:0;var s=r[5]=e.lowerBound!==undefined?e.lowerBound:0,o=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=s===o,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,r[20]=1,r[21]=0,n},t}(E);C.prototype._inWorld=E.prototype.twoBodyInWorld,C.prototype._outWorld=E.prototype.twoBodyOutWorld,C.prototype._pairExists=E.prototype.twoBodyPairExists,C.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,C.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var k=function(e){function t(){e.apply(this,arguments),this.type="ANGLE",this.dimension=1,this._JACC=9}return y(t,e),t.prototype.getLowerBound=function(){return this._data[5]},t.prototype.getUpperBound=function(){return this._data[6]},t.prototype.getRatio=function(){return this._data[7]},t.prototype.setLowerBound=function(e){var t=this._data;t[5]!==e&&(t[5]=e,this._equal=e===t[6],this.wake(!0))},t.prototype.setUpperBound=function(e){var t=this._data;t[6]!==e&&(t[6]=e,this._equal=e===t[5],this.wake(!0))},t.prototype.setRatio=function(e){var t=this._data;t[7]!==e&&(t[7]=e,this.wake(!0))},t.prototype._posError=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[7],i=e[5],s=e[6],o=r*n[4]-t[4];this._equal?(o-=s,this._slack=!1,e[13]=1):o<i?(o=i-o,this._slack=!1,e[13]=-1):o>s?(o-=s,this._slack=!1,e[13]=1):(o=0,this._slack=!0,e[13]=0),e[12]=-o},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data,i=t[7],s=n[1],o=r[1];t[8]=s+i*i*o,E.prototype.safe_invert(t,8,9),this._posError();if(this._slack)return!1;if(!this._stiff){if(E.prototype.soft_params(t,8,11,12,e,this._breakUnderError))return!0}else t[11]=0,t[12]=0;var u=E.prototype.dtRatio(t,e);return t[9]*=u,t[10]=t[2]*e,!1},t.prototype._warmStart=function(){if(this._slack)return;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9]*e[13];t[9]-=r*t[1],n[9]+=r*e[7]*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[9]*n[13];return t[0]=t[1]=0,t[2]=(e===this.bodyA?-1:e===this.bodyB?n[7]:0)*r,t},t.prototype._iterateVel=function(){if(this._slack)return!1;var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[13],i=e[7],s=e[12]-r*(i*n[9]-t[9]),o=e[9],u=e[8]*s-o*e[11],a=o+u,f=e[10];if(this._breakUnderForce){if(a>f||a<-f)return!0;!this._equal&&a>0&&(a=0)}else this._stiff?!this._equal&&a>0&&(a=0):this._equal?a>f?a=f:a<-f&&(a=-f):a>0?a=0:a<-f&&(a=-f);return u=a-o,e[9]=a,u*=r,t[9]-=u*t[1],n[9]+=u*i*n[1],!1},t.prototype._iteratePos=function(){this._posError();if(this._slack)return!1;var e=this._data,t=e[12],n=e[3];if(this._breakUnderError&&(t>n||t<-n))return!0;var r=b.ANGLE_SLOP_SQ;if(t*t<r)return!1;t*=b.ANGLE_BIAS_COEF;var i=t*b.ANGLE_BIAS_COEF*e[8];if(this._equal||i<0){var s=this.bodyA;i*=e[13];var o=-i*s._data[1];o!==0&&s._deltaRotation(o),s=this.bodyB,o=i*s._data[1],o!==0&&s._deltaRotation(o)}return!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(14);E.prototype.init(n,e),r[7]=e.ratio!==undefined?e.ratio:1;var i=r[5]=e.lowerBound!==undefined?e.lowerBound:0,s=r[6]=e.upperBound!==undefined?e.upperBound:0;return n._equal=i===s,n._slack=!1,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(E);k.prototype._inWorld=E.prototype.twoBodyInWorld,k.prototype._outWorld=E.prototype.twoBodyOutWorld,k.prototype._pairExists=E.prototype.twoBodyPairExists,k.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,k.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var L=function(e){function t(){e.apply(this,arguments),this.type="WELD",this.dimension=3,this._ANCHOR_A=5,this._ANCHOR_B=7,this._JACC=20}return y(t,e),t.prototype.getPhase=function(){return this._data[13]},t.prototype.setPhase=function(e){var t=this._data;e!==t[13]&&(t[13]=e,this.wake(!0))},t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;E.prototype.rotateAnchor(t,n,5,9);var i=t[9],s=t[10];E.prototype.rotateAnchor(t,r,7,11);var o=t[11],u=t[12],a=n[0]+r[0],f=n[1],l=r[1];t[14]=a+s*f*s+u*l*u,t[15]=-(i*f*s)-o*l*u,t[16]=-(s*f)-u*l,t[17]=a+i*f*i+o*l*o,t[18]=i*f+o*l,t[19]=f+l,E.prototype.safe_invert3(t,14,20);if(!this._stiff){t[25]=n[2]+i-(r[2]+o),t[26]=n[3]+s-(r[3]+u),t[27]=n[4]+t[13]-r[4];if(E.prototype.soft_params3(t,14,24,25,e,this._breakUnderError))return!0}else t[24]=0,t[25]=0,t[26]=0,t[27]=0;var c=E.prototype.dtRatio(t,e);return t[20]*=c,t[21]*=c,t[22]*=c,t[23]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[20],i=e[21],s=e[22],o=t[0];t[7]-=r*o,t[8]-=i*o,t[9]-=(e[9]*i-e[10]*r+s)*t[1],o=n[0],n[7]+=r*o,n[8]+=i*o,n[9]+=(e[11]*i-e[12]*r+s)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[20],i=n[21],s=n[22];return e===this.bodyA?(t[0]=-r,t[1]=-i,t[2]=-(n[9]*i-n[10]*r+s)):e===this.bodyB?(t[0]=r,t[1]=i,t[2]=n[11]*i-n[12]*r+s):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9],i=e[10],s=e[11],o=e[12],u=t[9],a=n[9],f=e[25]-(n[7]-o*a)+(t[7]-i*u),l=e[26]-(n[8]+s*a)+(t[8]+r*u),c=e[27]-a+u,h=e[20],p=e[21],d=e[22],v=e[24],m=e[15],g=e[16],y=e[18],b=e[14]*f+m*l+g*c-h*v,w=m*f+e[17]*l+y*c-p*v,E=g*f+y*l+e[19]*c-d*v,S=h+b,x=p+w,T=d+E,N=S*S+x*x+T*T,C=e[23];if(this._breakUnderForce){if(N>C*C)return!0}else this._stiff||N>C*C&&(N=C/Math.sqrt(N),S*=N,x*=N,T*=N);b=S-h,w=x-p,E=T-d,e[20]=S,e[21]=x,e[22]=T;var k=t[0];return t[7]-=b*k,t[8]-=w*k,t[9]-=(r*w-i*b+E)*t[1],k=n[0],n[7]+=b*k,n[8]+=w*k,n[9]+=(s*w-o*b+E)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1];E.prototype.rotateAnchor(e,t,5,9);var u=e[9],a=e[10];E.prototype.rotateAnchor(e,n,7,11);var f=e[11],l=e[12],c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),p=t[4]+e[13]-n[4],d=c*c+h*h,v=p*p,m=e[3];if(this._breakUnderError&&d+v>m*m)return!0;if(d<b.WELD_LINEAR_SLOP_SQ&&v<b.WELD_ANGULAR_SLOP_SQ)return!1;var g=b.WELD_BIAS_COEF;c*=g,h*=g,p*=g,d*=g*g;var y=r+i,w,S;if(d>b.WELD_LARGE_ERROR_SQ&&y>b.EFF_MASS_EPSILON){var x=b.WELD_BIAS_COEF/y;w=c*x,S=h*x;var T=w*w+S*S,N=b.WELD_LARGE_ERROR_MAX;T>N*N&&(T=N/Math.sqrt(T),w*=T,S*=T),t[2]-=w*r,t[3]-=S*r,n[2]+=w*r,n[3]+=S*r,c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),c*=g,h*=g,d=c*c+h*h}e[14]=y+a*s*a+l*o*l,e[15]=-(u*s*a)-f*o*l,e[16]=-(a*s)-l*o,e[17]=y+u*s*u+f*o*f,e[18]=u*s+f*o,e[19]=s+o,d>b.WELD_MAX_LINEAR_ERROR_SQ&&(d=b.WELD_MAX_LINEAR_ERROR/Math.sqrt(d),c*=d,h*=d);var C=b.WELD_MAX_ANGULAR_ERROR;p>C?p=C:p<-C&&(p=-C),e[25]=c,e[26]=h,e[27]=p,E.prototype.safe_solve3(e,14,25,25),w=e[25],S=e[26];var k=e[27];t[2]-=w*r,t[3]-=S*r;var L=-((u*S-a*w+k)*s);return L!==0&&this.bodyA._deltaRotation(L),n[2]+=w*i,n[3]+=S*i,L=(f*S-l*w+k)*o,L!==0&&this.bodyB._deltaRotation(L),!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(28);E.prototype.init(n,e);var i=e.anchorA;return r[5]=i?i[0]:0,r[6]=i?i[1]:0,i=e.anchorB,r[7]=i?i[0]:0,r[8]=i?i[1]:0,r[13]=e.phase!==undefined?e.phase:0,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(E);L.prototype._inWorld=E.prototype.twoBodyInWorld,L.prototype._outWorld=E.prototype.twoBodyOutWorld,L.prototype._pairExists=E.prototype.twoBodyPairExists,L.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,L.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var A=function(e){function t(){e.apply(this,arguments),this.type="POINT",this.dimension=2,this._ANCHOR_A=5,this._ANCHOR_B=7,this._JACC=16}return y(t,e),t.prototype._preStep=function(e){var t=this._data,n=this.bodyA._data,r=this.bodyB._data;E.prototype.rotateAnchor(t,n,5,9);var i=t[9],s=t[10];E.prototype.rotateAnchor(t,r,7,11);var o=t[11],u=t[12],a=n[0]+r[0],f=n[1],l=r[1];t[13]=a+s*f*s+u*l*u,t[14]=-(i*f*s)-o*l*u,t[15]=a+i*f*i+o*l*o,E.prototype.safe_invert2(t,13,16);if(!this._stiff){t[20]=n[2]+i-(r[2]+o),t[21]=n[3]+s-(r[3]+u);if(E.prototype.soft_params2(t,13,19,20,e,this._breakUnderError))return!0}else t[19]=0,t[20]=0,t[21]=0;var c=E.prototype.dtRatio(t,e);return t[16]*=c,t[17]*=c,t[18]=t[2]*e,!1},t.prototype._warmStart=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[16],i=e[17],s=t[0];t[7]-=r*s,t[8]-=i*s,t[9]-=(e[9]*i-e[10]*r)*t[1],s=n[0],n[7]+=r*s,n[8]+=i*s,n[9]+=(e[11]*i-e[12]*r)*n[1]},t.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[16],i=n[17];return e===this.bodyA?(t[0]=-r,t[1]=-i,t[2]=-(n[9]*i-n[10]*r)):e===this.bodyB?(t[0]=r,t[1]=i,t[2]=n[11]*i-n[12]*r):t[0]=t[1]=t[2]=0,t},t.prototype._iterateVel=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=e[9],i=e[10],s=e[11],o=e[12],u=t[9],a=n[9],f=e[20]-(n[7]-o*a)+(t[7]-i*u),l=e[21]-(n[8]+s*a)+(t[8]+r*u),c=e[16],h=e[17],p=e[14],d=e[19],v=e[13]*f+p*l-c*d,m=p*f+e[15]*l-h*d,g=c+v,y=h+m,b=g*g+y*y,w=e[18];if(this._breakUnderForce){if(b>w*w)return!0}else this._stiff||b>w*w&&(b=w/Math.sqrt(b),g*=b,y*=b);v=g-c,m=y-h,e[16]=g,e[17]=y;var E=t[0];return t[7]-=v*E,t[8]-=m*E,t[9]-=(r*m-i*v)*t[1],E=n[0],n[7]+=v*E,n[8]+=m*E,n[9]+=(s*m-o*v)*n[1],!1},t.prototype._iteratePos=function(){var e=this._data,t=this.bodyA._data,n=this.bodyB._data,r=t[0],i=n[0],s=t[1],o=n[1];E.prototype.rotateAnchor(e,t,5,9);var u=e[9],a=e[10];E.prototype.rotateAnchor(e,n,7,11);var f=e[11],l=e[12],c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),p=c*c+h*h,d=e[3];if(this._breakUnderError&&p>d*d)return!0;if(p<b.POINT_SLOP_SQ)return!1;var v=b.POINT_BIAS_COEF;c*=v,h*=v,p*=v*v;var m=r+i,g,y;if(p>b.POINT_LARGE_ERROR_SQ&&m>b.EFF_MASS_EPSILON){var w=b.POINT_LARGE_ERROR_BIAS/m;g=c*w,y=h*w;var S=g*g+y*y,x=b.POINT_LARGE_ERROR_MAX;S>x*x&&(S=x/Math.sqrt(S),g*=S,y*=S),t[2]-=g*r,t[3]-=y*r,n[2]+=g*r,n[3]+=y*r,c=t[2]+u-(n[2]+f),h=t[3]+a-(n[3]+l),c*=v,h*=v,p=c*c+h*h}e[13]=m+a*s*a+l*o*l,e[14]=-(u*s*a)-f*o*l,e[15]=m+u*s*u+f*o*f,p>b.POINT_MAX_ERROR_SQ&&(p=b.POINT_MAX_ERROR/Math.sqrt(p),c*=p,h*=p),e[20]=c,e[21]=h,E.prototype.safe_solve2(e,13,20,20),g=e[20],y=e[21],t[2]-=g*r,t[3]-=y*r;var T=-((u*y-a*g)*s);return T!==0&&this.bodyA._deltaRotation(T),n[2]+=g*i,n[3]+=y*i,T=(f*y-l*g)*o,T!==0&&this.bodyB._deltaRotation(T),!1},t.create=function(e){var n=new t,r=n._data=new X.prototype.floatArray(22);E.prototype.init(n,e);var i=e.anchorA;return r[5]=i?i[0]:0,r[6]=i?i[1]:0,i=e.anchorB,r[7]=i?i[0]:0,r[8]=i?i[1]:0,n.bodyA=e.bodyA,n.bodyB=e.bodyB,n},t}(E);A.prototype._inWorld=E.prototype.twoBodyInWorld,A.prototype._outWorld=E.prototype.twoBodyOutWorld,A.prototype._pairExists=E.prototype.twoBodyPairExists,A.prototype._wakeConnected=E.prototype.twoBodyWakeConnected,A.prototype._sleepComputation=E.prototype.twoBodySleepComputation;var O=function(){function e(){}return e.prototype.computeArea=function(){return 0},e.prototype.computeMasslessInertia=function(){return 0},e.prototype.computeCenterOfMass=function(e){return null},e.prototype.translate=function(e,t){},e.prototype._update=function(e,t,n,r,i){},e.prototype.clone=function(){return undefined},e.prototype.getGroup=function(){return this._group},e.prototype.setGroup=function(e){this._group=e,this.body&&this.body.wake(!0)},e.prototype.getMask=function(){return this._mask},e.prototype.setMask=function(e){this._mask=e,this.body&&this.body.wake(!0)},e.prototype.getMaterial=function(){return this._material},e.prototype.setMaterial=function(e){if(this._material!==e){this._material=e,this.body&&this.body._invalidate();var t=this.arbiters,n=t.length,r;for(r=0;r<n;r+=1)t[r]._invalidate()}},e.prototype.copyCommon=function(t,n){n._type=t._type,n._material=t._material,n._group=t._group,n._mask=t._mask,n.sensor=t.sensor,n.id=e.uniqueId,e.uniqueId+=1,n.arbiters=[],n._bphaseHandle=null,n.userData=t.userData;var r=t._data,i=t._data.length,s=n._data=new X.prototype.floatArray(i),o;for(o=0;o<i;o+=1)s[o]=r[o];n._onPreSolve=[],n._events=[]},e.prototype.init=function(t,n){t._material=n.material||w.create(),t._group=n.group!==undefined?n.group:1,t._mask=n.mask!==undefined?n.mask:4294967295,t.sensor=n.sensor!==undefined?n.sensor:!1,t.arbiters=[],t._bphaseHandle=null,t.userData=n.userData!==undefined?n.userData:null,t.id=e.uniqueId,e.uniqueId+=1,t._onPreSolve=[],t._events=[]},e.eventIndex=function(e,t,n,r){var i=e.length,s;for(s=0;s<i;s+=1){var o=e[s];if(o.callback===n&&o.mask===r&&o.type===t)return s}return-1},e.prototype.addEventListener=function(t,n,r,i){var s,o;t==="preSolve"?(s=this._onPreSolve,o=6):(s=this._events,o=t==="begin"?1:t==="progress"?2:t==="end"?3:null);if(o===null)return!1;t!=="preSolve"?i=undefined:i===undefined&&(i=!1);var u=e.eventIndex(s,o,n,r);return u!==-1?!1:(s.push({callback:n,mask:r,type:o,deterministic:i}),this.body&&this.body.wake(!0),!0)},e.prototype.removeEventListener=function(t,n,r){var i,s;t==="preSolve"?(i=this._onPreSolve,s=6):(i=this._events,s=t==="begin"?1:t==="progress"?2:t==="end"?3:null);if(s===null)return!1;var o=e.eventIndex(i,s,n,r);return o===-1?!1:(i.splice(o,1),this.body&&this.body.wake(!0),!0)},e.uniqueId=0,e}(),M=function(e){function t(){e.call(this),this.type="CIRCLE"}return y(t,e),t.prototype.computeArea=function(){var e=this._data[6];return Math.PI*e*e},t.prototype.computeMasslessInertia=function(){var e=this._data,t=this._data[6],n=e[7],r=e[8];return.5*t*t+(n*n+r*r)},t.prototype.getRadius=function(){return this._data[6]},t.prototype.setRadius=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data;e!==n[6]&&(n[6]=e,this._validate(),t&&t._invalidate())},t.prototype.getOrigin=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[7],e[1]=t[8],e},t.prototype.setOrigin=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data,r=e[0],i=e[1];if(n[7]!==r||n[8]!==i)n[7]=r,n[8]=i,this._validate(),t&&t._invalidate()},t.prototype.clone=function(){var e=new t;return O.prototype.copyCommon(this,e),e},t.prototype.scale=function(e){if(e<=0)return;var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data;n[7]*=e,n[8]*=e,n[6]*=e,this._validate(),t&&t._invalidate()},t.prototype.translate=function(e,t){var n=this.body;if(!t&&n&&n.world&&(n._type===2||n.world._midStep))return;var r=this._data;r[7]+=e[0],r[8]+=e[1],this._validate(),!t&&n&&n._invalidate()},t.prototype.rotate=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=Math.cos(e),r=Math.sin(e),i=this._data,s=i[7],o=i[8];i[7]=n*s-r*o,i[8]=r*s+n*o,this._validate(),t&&t._invalidate()},t.prototype.transform=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=e[0],r=e[2],i=e[1],s=e[3],o=this._data,u=n*s-r*i;if(u<=0)return;o[6]*=Math.sqrt(u);var a=o[7],f=o[8];o[7]=n*a+r*f+e[4],o[8]=i*a+s*f+e[5],this._validate(),t&&t._invalidate()},t.prototype._update=function(e,t,n,r,i){var s=this._data,o=s[7],u=s[8],a=s[9]=e+n*o-r*u,f=s[10]=t+r*o+n*u;if(!i){var l=s[6];s[0]=a-l,s[1]=f-l,s[2]=a+l,s[3]=f+l}},t.prototype._validate=function(){var e=this._data,t=e[7],n=e[8],r=e[6],i=Math.sqrt(t*t+n*n);e[4]=r+i,e[5]=e[4]-Math.max(r-i,0)},t.prototype.computeCenterOfMass=function(e){return this.getOrigin(e)},t.create=function(e){var n=new t;n._type=0,O.prototype.init(n,e);var r=e.radius,i=e.origin?e.origin[0]:0,s=e.origin?e.origin[1]:0,o=n._data=new X.prototype.floatArray(11);return o[6]=r,o[7]=i,o[8]=s,n._validate(),n},t.version=1,t}(O),_=function(e){function t(){e.call(this),this.type="POLYGON"}return y(t,e),t.prototype.computeArea=function(){var e=this._data,t=6,n=e.length,r=0;for(;t<n;t+=13){var i=t+13;i===n&&(i=6),r+=e[t+0]*e[i+0+1]-e[t+0+1]*e[i+0]}return r*.5},t.prototype.computeMasslessInertia=function(){var e=this._data,t=6,n=e.length,r=0,i=0;for(;t<n;t+=13){var s=t+13;s===n&&(s=6);var o=e[t+0],u=e[t+0+1],a=e[s+0],f=e[s+0+1],l=o*f-a*u,c=o*o+u*u+(a*a+f*f)+(o*a+u*f);r+=l*c,i+=l}return r/(6*i)},t.prototype.computeCenterOfMass=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data,n=6,r=t.length,i=0,s=0,o=0;for(;n<r;n+=13){var u=n+13;u===r&&(u=6);var a=t[n+0],f=t[n+0+1],l=t[u+0],c=t[u+0+1],h=a*c-f*l;i+=h,s+=(a+l)*h,o+=(f+c)*h}var p=1/(3*i);return e[0]=s*p,e[1]=o*p,e},t.prototype.setVertices=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;this._validate(e),t&&t._invalidate()},t.prototype.clone=function(){var e=new t;return O.prototype.copyCommon(this,e),e},t.prototype.scale=function(e,t){var n=this.body;if(n&&n.world&&(n._type===2||n.world._midStep))return;t===undefined&&(t=e);if(e<=0||t<=0)return;var r=1/e,i=1/t,s=this._data,o=s.length,u=6,a=0,f=Number.POSITIVE_INFINITY;for(;u<o;u+=13){var l=s[u+0]*=e,c=s[u+0+1]*=t,h=s[u+4]*r,p=s[u+4+1]*i,d=1/Math.sqrt(h*h+p*p);s[u+4]=h*=d,s[u+4+1]=p*=d;var v=s[u+8]=h*l+p*c;v<f&&(f=v);var m=l*l+c*c;m>a&&(a=m);var g=u+13;g===o&&(g=6);var y=s[g+0]*e-l,b=s[g+0+1]*t-c,w=Math.sqrt(y*y+b*b);s[u+12]=w}s[4]=Math.sqrt(a),s[5]=s[4]-Math.max(f,0),n&&n._invalidate()},t.prototype.translate=function(e,t){var n=this.body;if(!t&&n&&n.world&&(n._type===2||n.world._midStep))return;var r=this._data,i=r.length,s=6,o=e[0],u=e[1],a=0,f=Number.POSITIVE_INFINITY;for(;s<i;s+=13){var l=r[s+0]+=o,c=r[s+0+1]+=u,h=r[s+4],p=r[s+4+1],d=r[s+8]+=h*o+p*u;d<f&&(f=d);var v=l*l+c*c;v>a&&(a=v)}r[4]=Math.sqrt(a),r[5]=r[4]-Math.max(f,0),!t&&n&&n._invalidate()},t.prototype.rotate=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=this._data,r=n.length,i=6,s=Math.cos(e),o=Math.sin(e);for(;i<r;i+=13){var u=n[i+0],a=n[i+0+1];n[i+0]=u*s-a*o,n[i+0+1]=u*o+a*s,u=n[i+4],a=n[i+4+1],n[i+4]=u*s-a*o,n[i+4+1]=u*o+a*s}t&&t._invalidate()},t.prototype.transform=function(e){var t=this.body;if(t&&t.world&&(t._type===2||t.world._midStep))return;var n=e[0],r=e[2],i=e[1],s=e[3],o=e[4],u=e[5];if(n*s-r*i<=0)return;var a=this._data,f=a.length,l=6,c,h;for(;l<f;l+=13)c=a[l+0],h=a[l+0+1],a[l+0]=n*c+r*h+o,a[l+0+1]=i*c+s*h+u;var p=0,d=Number.POSITIVE_INFINITY;l=6;for(;l<f;l+=13){c=a[l+0],h=a[l+0+1];var v=l+13;v===f&&(v=6);var m=-(a[v+0]-c),g=-(a[v+0+1]-h),y=Math.sqrt(m*m+g*g),b=1/y,w=-g*b,E=m*b;a[l+4]=w,a[l+4+1]=E,a[l+12]=y;var S=a[l+8]=w*c+E*h,x=c*c+h*h;x>p&&(p=x),S<d&&(d=S)}a[4]=Math.sqrt(p),a[5]=a[4]-Math.max(d,0),t&&t._invalidate()},t.prototype._update=function(e,t,n,r,i){var s=this._data,o=s.length,u=6,a,f,l,c,h;for(;u<o;u+=13){var p=s[u+0],d=s[u+0+1],v=s[u+2]=e+n*p-r*d,m=s[u+2+1]=t+r*p+n*d;p=s[u+4],d=s[u+4+1];var g=s[u+6]=n*p-r*d,y=s[u+6+1]=r*p+n*d;s[u+9]=g*v+y*m,s[u+10]=g*m-y*v,u!==6?(a=u-13,s[a+11]=s[a+6]*m-s[a+6+1]*v,i||(v<f?f=v:v>c&&(c=v),m<l?l=m:m>h&&(h=m))):i||(f=c=v,l=h=m)}u=6,a=s.length-13,s[a+11]=s[a+6]*s[u+2+1]-s[a+6+1]*s[u+2],i||(s[0]=f,s[1]=l,s[2]=c,s[3]=h)},t.prototype._validate=function(e){var t=e.length,n=this._data,r=6+t*13;if(!n||r!==n.length)n=this._data=new X.prototype.floatArray(r);var i=0,s=Number.POSITIVE_INFINITY,o=6,u;for(u=0;u<t;u+=1,o+=13){var a=e[u],f=e[u===t-1?0:u+1],l=a[0],c=a[1],h=l-f[0],p=c-f[1],d=Math.sqrt(h*h+p*p),v=1/d,m=-p*v,g=h*v;n[o+0]=l,n[o+0+1]=c,n[o+4]=m,n[o+4+1]=g,n[o+12]=d;var y=n[o+8]=m*l+g*c,b=l*l+c*c;b>i&&(i=b),y<s&&(s=y)}n[4]=Math.sqrt(i),n[5]=n[4]-Math.max(s,0)},t.create=function(e,n){var r=new t;return r._type=1,O.prototype.init(r,e),r._validate(n||e.vertices),r},t.version=1,t}(O),D=function(){function e(){}return e.prototype.isDynamic=function(){return this._type===0},e.prototype.setAsDynamic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(0);var e=this._data,t=e[23],n=e[24];e[0]=t===Number.POSITIVE_INFINITY?0:1/t,e[1]=n===Number.POSITIVE_INFINITY?0:1/n},e.prototype.isStatic=function(){return this._type===2},e.prototype.setAsStatic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(2);var e=this._data;e[0]=e[1]=0,e[7]=e[8]=e[9]=0},e.prototype.isKinematic=function(){return this._type===1},e.prototype.setAsKinematic=function(){if(this.world&&this.world._midStep)return;this._setTypeValue(1);var e=this._data;e[0]=e[1]=0},e.prototype._setTypeValue=function(e){if(e===this._type)return;if(!this.world){this._type=e;return}this.world._transmitBodyType(this,e)},e.prototype.applyImpulse=function(e,t){if(this._type!==0)return;var n=this._data,r,i;t?(r=t[0]-n[2],i=t[1]-n[3]):(r=0,i=0);var s=e[0],o=e[1],u=n[0];n[7]+=s*u,n[8]+=o*u,n[9]+=(r*o-i*s)*n[1],this.wake(!0)},e.prototype.setVelocityFromPosition=function(e,t,n){if(this._type===2)return;var r=this._data,i=1/n;r[7]=(e[0]-r[2])*i,r[8]=(e[1]-r[3])*i,r[9]=(t-r[4])*i,this.wake(!0)},e.prototype.transformWorldPointToLocal=function(e,t){t===undefined&&(t=new X.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0]-n[2],o=e[1]-n[3];return t[0]=r*s+i*o,t[1]=r*o-i*s,t},e.prototype.transformWorldVectorToLocal=function(e,t){t===undefined&&(t=new X.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s+i*o,t[1]=r*o-i*s,t},e.prototype.transformLocalPointToWorld=function(e,t){t===undefined&&(t=new X.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s-i*o+n[2],t[1]=i*s+r*o+n[3],t},e.prototype.transformLocalVectorToWorld=function(e,t){t===undefined&&(t=new X.prototype.floatArray(2));var n=this._data,r=n[5],i=n[6],s=e[0],o=e[1];return t[0]=r*s-i*o,t[1]=i*s+r*o,t},e.prototype.getPosition=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[2],e[1]=t[3],e},e.prototype.setPosition=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data,n=e[0],r=e[1];if(t[2]!==n||t[3]!==r)t[2]=n,t[3]=r,this._invalidated=!0,this.wake(!0)},e.prototype.getRotation=function(){return this._data[4]},e.prototype.setRotation=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data;t[4]!==e&&(this._data[4]=e,this._data[5]=Math.cos(e),this._data[6]=Math.sin(e),this._invalidated=!0,this.wake(!0))},e.prototype.getVelocity=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[7],e[1]=t[8],e},e.prototype.setVelocity=function(e){if(this._type===2)return;var t=this._data,n=e[0],r=e[1];if(t[7]!==n||t[8]!==r)t[7]=n,t[8]=r,this.wake(!0)},e.prototype.getAngularVelocity=function(){return this._data[9]},e.prototype.setAngularVelocity=function(e){if(this._type===2)return;var t=this._data;t[9]!==e&&(t[9]=e,this.wake(!0))},e.prototype.getForce=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[10],e[1]=t[11],e},e.prototype.setForce=function(e){var t=this._data,n=e[0],r=e[1];if(t[10]!==n||t[11]!==r)t[10]=n,t[11]=r,this.wake(!0)},e.prototype.getTorque=function(){return this._data[12]},e.prototype.setTorque=function(e){var t=this._data;t[12]!==e&&(t[12]=e,this.wake(!0))},e.prototype.getSurfaceVelocity=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[13],e[1]=t[14],e},e.prototype.setSurfaceVelocity=function(e){var t=this._data;t[13]=e[0],t[14]=e[1],this.wake(!0)},e.prototype.getMass=function(){return this._data[23]},e.prototype.getInertia=function(){return this._data[24]},e.prototype.setMass=function(e){var t=this._data,n=t[23];if(!this._customMass||n!==e)t[23]=e,this._customMass=!0,this._invalidateMassInertia()},e.prototype.setMassFromShapes=function(){this._customMass&&(this._customMass=!1,this._data[23]=this.computeMassFromShapes(),this._invalidateMassInertia())},e.prototype.setInertia=function(e){var t=this._data,n=t[24];if(!this._customInertia||n!==e)t[24]=e,this._customInertia=!0,this._invalidateMassInertia()},e.prototype.setInertiaFromShapes=function(){this._customInertia&&(this._customInertia=!1,this._data[24]=this.computeInertiaFromShapes(),this._invalidateMassInertia())},e.prototype._invalidateMassInertia=function(){var e=this._data,t=e[23],n=e[24],r=this._type!==0,i=Number.POSITIVE_INFINITY;e[0]=r||t===i?0:1/t,e[1]=r||n===i?0:1/n,this.wake(!0)},e.prototype.getLinearDrag=function(){return 1-Math.exp(this._data[21])},e.prototype.setLinearDrag=function(e){this._data[21]=Math.log(1-e),this.wake(!0)},e.prototype.getAngularDrag=function(){return 1-Math.exp(this._data[22])},e.prototype.setAngularDrag=function(e){this._data[22]=Math.log(1-e),this.wake(!0)},e.prototype.addShape=function(e){if(this.world&&(this.world._midStep||this._type===2))return!1;if(e.body)return!1;e.body=this,this.shapes.push(e),this.world&&(this.wake(!0),this.world._addShape(e));var t=e._data[4],n=this._data;return t>n[19]&&(n[19]=t),this._invalidate(),!0},e.prototype.removeShape=function(e){if(this.world&&(this
.world._midStep||this._type===2))return!1;if(e.body!==this)return!1;this.world&&(this.wake(!0),this.world._removeShape(e)),e.body=null;var t=this.shapes,n=t.length-1,r=t.indexOf(e);t[r]=t[n],t.pop();var i,s=0;for(i=0;i<n;i+=1){e=t[i];var o=e._data[4];o>s&&(s=o)}return this._data[19]=s,this._invalidate(),!0},e.prototype.computeMassFromShapes=function(){var e=0,t,n=this.shapes,r=n.length;for(t=0;t<r;t+=1){var i=n[t];e+=i._material._data[4]*i.computeArea()}return e},e.prototype.computeInertiaFromShapes=function(){var e=0,t,n=this.shapes,r=n.length;for(t=0;t<r;t+=1){var i=n[t];e+=i._material._data[4]*i.computeMasslessInertia()*i.computeArea()}return e},e.prototype.wake=function(e){if(!this.world){this.sleeping=!1;return}this.world._wakeBody(this,!e)},e.prototype.sleep=function(){if(!this.world){this.sleeping=!0;return}this.world._forceSleepBody(this)},e.prototype.computeLocalCenterOfMass=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=0,n=0,r=0,i=this.shapes,s=i.length,o;for(o=0;o<s;o+=1){var u=i[o];u.computeCenterOfMass(e);var a=u.computeArea()*u._material._data[4];t+=e[0]*a,n+=e[1]*a,r+=a}var f=1/r;return e[0]=t*f,e[1]=n*f,e},e.prototype.computeWorldBounds=function(e){e===undefined&&(e=new X.prototype.floatArray(4));var t=Number.POSITIVE_INFINITY,n=t,r=t,i=-t,s=-t;this._update();var o=this.shapes,u=o.length,a;for(a=0;a<u;a+=1){var f=o[a]._data,l=f[0],c=f[1],h=f[2],p=f[3];l<n&&(n=l),h>i&&(i=h),c<r&&(r=c),p>s&&(s=p)}return e[0]=n,e[1]=r,e[2]=i,e[3]=s,e},e.prototype.alignWithOrigin=function(){if(this.world&&(this.world._midStep||this._type===2))return;var e=this.computeLocalCenterOfMass();e[0]*=-1,e[1]*=-1;var t=this.shapes,n=t.length,r;for(r=0;r<n;r+=1)t[r].translate(e,!0);this._invalidate()},e.prototype._invalidate=function(){this._invalidated=!0;var e=this._customMass,t=this._customInertia;if(!e||!t)e||(this._data[23]=this.computeMassFromShapes()),t||(this._data[24]=this.computeInertiaFromShapes()),this._invalidateMassInertia();this.wake(!0)},e.prototype._update=function(){if(this._invalidated){this._invalidated=!1;var e=this._data,t=this.shapes,n=t.length,r;for(r=0;r<n;r+=1)t[r]._update(e[2],e[3],e[5],e[6])}},e.prototype._atRest=function(e,t){if(this._type!==0)return this.sleeping;var n=this._data,r;do{var i=n[7],s=n[8],o=b.SLEEP_LINEAR_SQ;if(i*i+s*s>o){r=!1;break}i=n[2]-n[15],s=n[3]-n[16];var u=e*e*o;if(i*i+s*s>u){r=!1;break}s=n[19],i=n[9]*s,o=b.SLEEP_ANGULAR_SQ;if(i*i>o){r=!1;break}i=(n[4]-n[17])*s,u=e*e*o,r=i*i<=u}while(!1);return r?this._wakeTime+b.SLEEP_DELAY<t:(this._wakeTime=t,!1)},e.prototype._deltaRotation=function(e){var t=this._data,n=t[4]+=e;if(e*e>b.DELTA_ROTATION_EPSILON)t[5]=Math.cos(n),t[6]=Math.sin(n);else{var r=e*e,i=1-.5*r,s=1-r*r*.125,o=t[5],u=t[6],a=(i*u+e*o)*s,f=(i*o-e*u)*s;t[5]=f,t[6]=a}return n},e.prototype._sweepIntegrate=function(e){var t=this._data,n=e-t[18];if(n!==0){t[18]=e,t[2]+=t[7]*n,t[3]+=t[8]*n;var r=t[20];r!==0&&this._deltaRotation(t[20]*n)}},e.prototype.integrate=function(e){if(this.world&&(this.world._midStep||this._type===2))return;var t=this._data;t[18]=0,t[20]=t[9],this._sweepIntegrate(e),t[18]=0,this._invalidated=!0,this.wake(!0)},e.prototype.addEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:null;if(n===null)return!1;var r=n.indexOf(t);return r!==-1?!1:(n.push(t),this.wake(),!0)},e.prototype.removeEventListener=function(e,t){var n=e==="wake"?this._onWake:e==="sleep"?this._onSleep:null;if(n===null)return!1;var r=n.indexOf(t);return r===-1?!1:(n.splice(r,1),this.wake(),!0)},e.create=function(t){var n=new e,r=n._data=new X.prototype.floatArray(25),i=Number.POSITIVE_INFINITY;n._type=t.type==="dynamic"?0:t.type==="static"?2:t.type==="kinematic"?1:0;var s=t.shapes;n.shapes=[],n.constraints=[],n.world=null;var o=0;if(s){var u=s.length,a;for(a=0;a<u;a+=1){var f=s[a];if(f.body===n)continue;f.body=n,n.shapes.push(f);var l=f._data[4];l>o&&(o=l)}}r[19]=o,n._customMass=t.mass!==undefined,n._customInertia=t.inertia!==undefined;var c=n._customMass?t.mass:n.computeMassFromShapes(),h=n._customInertia?t.inertia:n.computeInertiaFromShapes(),p=n._type===0,d=n._type===2;r[0]=!p||c===i?0:1/c,r[1]=!p||h===i?0:1/h,r[23]=c,r[24]=h;var v=t.position,m=r[2]=v?v[0]:0,g=r[3]=v?v[1]:0,y=r[4]=t.rotation||0;return r[5]=Math.cos(y),r[6]=Math.sin(y),r[15]=m,r[16]=g,r[17]=y,v=t.velocity,r[7]=!d&&v?v[0]:0,r[8]=!d&&v?v[1]:0,r[9]=!d&&t.angularVelocity||0,v=t.force,r[10]=v?v[0]:0,r[11]=v?v[1]:0,r[12]=t.torque||0,v=t.surfaceVelocity,r[13]=v?v[0]:0,r[14]=v?v[1]:0,n.sleeping=t.sleeping||!1,n.bullet=t.bullet||!1,n._sweepFrozen=n._type!==0,n._deferred=!1,n._island=null,n._islandRank=0,n._islandRoot=null,n._isBody=!0,n._wakeTime=0,n._woken=!1,n._invalidated=!0,r[21]=Math.log(1-(t.linearDrag!==undefined?t.linearDrag:.05)),r[22]=Math.log(1-(t.angularDrag!==undefined?t.angularDrag:.05)),n.userData=t.userData||null,n._onWake=[],n._onSleep=[],n},e.version=1,e}(),P=function(){function e(){this.thisObject=null,this.callback=null,this.time=0,this.index=0,this.arbiter=null,this.next=null}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.thisObject=null,t.callback=null,t.arbiter=null},e.pool=null,e}(),H=function(){function e(){this.components=[],this.sleeping=!1,this.wakeTime=0,this.next=null}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.wakeTime=0},e.pool=null,e}(),B=function(){function e(){this.next=null,this.shapeA=null,this.shapeB=null,this.frozenA=this.frozenB=!1,this.arbiter=null,this.failed=!1,this.slipped=!1,this._data=new X.prototype.floatArray(7)}return e.allocate=function(){if(e.pool){var t=e.pool;return e.pool=t.next,t.next=null,t}return new e},e.deallocate=function(t){t.next=e.pool,e.pool=t,t.shapeA=t.shapeB=null,t.failed=!1,t.slipped=!1,t.arbiter=null},e.pool=null,e}(),j=function(){function e(){this.boxTreeIndex=-1,this.data=null,this.isStatic=!1}return e.allocate=function(){return 0<this.pool.length?this.pool.pop():new e},e.deallocate=function(e){this.pool.push(e),e.data=null},e.pool=[],e}(),F=function(){function e(){this.staticTree=G.create(!0),this.dynamicTree=G.create(!1),this.overlappingNodes=[]}return e.prototype.sample=function(e,t,n){var r=this.overlappingNodes,i=this.staticTree.getOverlappingNodes(e,r,0);i+=this.dynamicTree.getOverlappingNodes(e,r,i);var s;for(s=0;s<i;s+=1)t.call(n,r[s],e)},e.prototype.insert=function(e,t,n){var r=j.allocate();return r.data=e,r.isStatic=n,n?this.staticTree.add(r,t):this.dynamicTree.add(r,t),r},e.prototype.update=function(e,t,n){n!==undefined&&e.isStatic!==n?(e.isStatic?(this.staticTree.remove(e),this.dynamicTree.add(e,t)):(this.dynamicTree.remove(e),this.staticTree.add(e,t)),e.isStatic=n):n?this.staticTree.update(e,t):this.dynamicTree.update(e,t)},e.prototype.remove=function(e){e.isStatic?this.staticTree.remove(e):this.dynamicTree.remove(e),j.deallocate(e)},e.prototype.clear=function(e,t){this._clearTree(this.staticTree,e,t),this._clearTree(this.dynamicTree,e,t)},e.prototype._clearTree=function(e,t,n){var r=e.getNodes(),i=r.length,s;for(s=0;s<i;s+=1){var o=r[s].externalNode;o&&(t&&t.call(n,o),j.deallocate(o))}e.clear()},e.prototype._validate=function(){this.staticTree.finalize(),this.dynamicTree.finalize()},e.prototype.perform=function(e,t){this._validate();var n=this.overlappingNodes,r=this.staticTree,i=this.dynamicTree,s=i.getNodes(),o=s.length,u;for(u=0;u<o;u+=1){var a=s[u],f=a.externalNode;if(f){var l=r.getOverlappingNodes(a.extents,n,0),c;for(c=0;c<l;c+=1)e.call(t,f,n[c])}}var h=i.getOverlappingPairs(n,0);for(u=0;u<h;u+=2)e.call(t,n[u],n[u+1])},e.create=function(){return new e},e.version=1,e}(),I=function(){function e(){this._next=null,this._prev=null,this._aabb=new X.prototype.floatArray(4),this.data=null,this.isStatic=!1}return e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._prev=null,e._next=this.pool,this.pool=e,e.data=null},e.pool=null,e}(),q=function(){function e(){}return e.prototype.sample=function(e,t,n){var r=e[0],i=e[1],s=e[2],o=e[3];this._validate();var u=this._list;while(u){var a=u._aabb;if(a[2]<r){u=u._next;continue}if(a[0]>s)break;a[1]<=o&&i<=a[3]&&t.call(n,u,e),u=u._next}},e.prototype.insert=function(e,t,n){var r=I.allocate(),i=r._aabb;i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],r.data=e,r.isStatic=n;var s=this._list;return r._next=s,s&&(s._prev=r),this._list=r,r},e.prototype.update=function(e,t,n){var r=e._aabb;r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],n!==undefined&&(e.isStatic=n)},e.prototype.remove=function(e){e._prev?e._prev._next=e._next:this._list=e._next,e._next&&(e._next._prev=e._prev),I.deallocate(e)},e.prototype.clear=function(e,t){var n=this._list;while(n){var r=n._next;e&&e.call(t,n),I.deallocate(n),n=r}this._list=null},e.prototype._validate=function(){if(!this._list)return;var e=this._list._next;while(e){var t=e._next,n=e._prev,r=e._aabb[0];if(r>n._aabb[0]){e=t;continue}while(n._prev&&n._prev._aabb[0]>r)n=n._prev;var i=e._prev;i._next=t,t&&(t._prev=i),n._prev?(e._prev=n._prev,n._prev=e,e._prev._next=e,e._next=n):(e._prev=null,this._list=e,e._next=n,n._prev=e),e=t}},e.prototype.perform=function(e,t){this._validate();var n=this._list;while(n){var r=n._next,i=n._aabb,s=n.isStatic,o=i[2];while(r){var u=r._aabb;if(u[0]>o)break;if(s&&r.isStatic){r=r._next;continue}if(i[1]>u[3]||u[1]>i[3]){r=r._next;continue}e.call(t,n,r),r=r._next}n=n._next}},e.create=function(){var t=new e;return t._list=null,t},e.version=1,e}(),R=function(){function e(){this._data=new X.prototype.floatArray(17),this.fresh=!1,this._hash=0,this._timeStamp=0,this._next=null,this.active=!1,this.virtual=!1}return e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._next=this.pool,this.pool=e},e.prototype.getPosition=function(e){e===undefined&&(e=new X.prototype.floatArray(2));var t=this._data;return e[0]=t[0],e[1]=t[1],e},e.prototype.getPenetration=function(){return-this._data[2]},e.prototype.getNormalImpulse=function(){return this.virtual?0:this._data[11]},e.prototype.getTangentImpulse=function(){return this.virtual?0:this._data[12]},e.version=1,e.pool=null,e}(),U=function(){function e(){this.shapeA=null,this.shapeB=null,this.bodyA=null,this.bodyB=null,this._next=null,this._retired=!1,this._lazyRetired=!1,this._static=!1,this._state=0,this.sensor=!1,this._createStamp=0,this._updateStamp=0,this._sleepStamp=0,this._timeStamp=0,this._createContinuous=!1,this._endGenerated=0,this._midStep=!1,this.sleeping=!1,this.active=!1,this._invalidated=!1,this._data=new X.prototype.floatArray(24),this.contacts=[],this._userdef=0,this._velocity2Contact=!1,this._position2Contact=!1,this._contact1=this._contact2=null,this._faceType=0}return e.prototype.getNormal=function(e){e===undefined&&(e=new X.prototype.floatArray(2));if(this.sensor)e[0]=e[1]=0;else{var t=this._data;e[0]=t[4],e[1]=t[5]}return e},e.prototype.getRollingImpulse=function(){return this.sensor||this._velocity2Contact||this._contact1._hash!==0?0:this._data[16]},e.prototype.getElasticity=function(){return this.sensor?undefined:(this._validate(),this._data[2])},e.prototype.getDynamicFriction=function(){return this.sensor?undefined:(this._validate(),this._data[0])},e.prototype.getStaticFriction=function(){return this.sensor?undefined:(this._validate(),this._data[1])},e.prototype.getRollingFriction=function(){return this.sensor?undefined:(this._validate(),this._data[3])},e.prototype.setElasticity=function(e){if(this.sensor)return;this._data[2]=e,this._userdef|=4,this._invalidate(!0)},e.prototype.setDynamicFriction=function(e){if(this.sensor)return;this._data[0]=e,this._userdef|=1,this._invalidate(!0)},e.prototype.setStaticFriction=function(e){if(this.sensor)return;this._data[1]=e,this._userdef|=2,this._invalidate(!0)},e.prototype.setRollingFriction=function(e){if(this.sensor)return;this._data[3]=e,this._userdef|=8,this._invalidate(!0)},e.prototype.setElasticityFromShapes=function(){if(this.sensor)return;this._userdef&=-5,this._invalidate(!0)},e.prototype.setDynamicFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-2,this._invalidate(!0)},e.prototype.setStaticFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-3,this._invalidate(!0)},e.prototype.setRollingFrictionFromShapes=function(){if(this.sensor)return;this._userdef&=-9,this._invalidate(!0)},e.prototype.isStateAccepted=function(){return this.sensor?!1:(this._state&1)!==0},e.prototype.isStatePersistent=function(){return this.sensor?!1:(this._state&2)!==0},e.prototype.setAcceptedState=function(e){if(this.sensor)return;e?this._state|=1:this._state&=-2,this._invalidate(!0)},e.prototype.setPersistentState=function(e){if(this.sensor)return;e?this._state|=2:this._state&=-3,this._invalidate(!0)},e.prototype._lazyRetire=function(e){this._lazyRetired=!0,this._retired=!0,this.active=!1;var t,n;this.shapeA!==e&&(t=this.shapeA.arbiters,n=t.indexOf(this),t[n]=t[t.length-1],t.pop()),this.shapeB!==e&&(t=this.shapeB.arbiters,n=t.indexOf(this),t[n]=t[t.length-1],t.pop())},e.prototype._assign=function(e,t){this.bodyA=e.body,this.bodyB=t.body,this.shapeA=e,this.shapeB=t,e.arbiters.push(this),t.arbiters.push(this),this._retired=!1,this.sleeping=!1,this._invalidate()},e.prototype._retire=function(){this.shapeA=this.shapeB=null,this.bodyA=this.bodyB=null,this._retired=!0,this._lazyRetired=!1,this.active=!1,this._data[6]=0;var e=this.contacts;while(e.length>0){var t=e.pop();R.deallocate(t)}this._contact1=this._contact2=null},e.prototype._invalidate=function(e){this._invalidated=!0,e&&!this._midStep&&(this.shapeA.body.wake(),this.shapeB.body.wake())},e.prototype._validate=function(){this._invalidated=!1;var e=this._data,t=this.shapeA._material._data,n=this.shapeB._material._data,r=this._userdef;if((r&4)===0){var i,s=t[0],o=n[0];s<=Number.NEGATIVE_INFINITY||o<=Number.NEGATIVE_INFINITY?i=0:s>=Number.POSITIVE_INFINITY||o>=Number.POSITIVE_INFINITY?i=1:(i=(s+o)*.5,i<0?i=0:i>1&&(i=1)),e[2]=i}var u=Math.sqrt;(r&1)===0&&(e[0]=u(t[2]*n[2])),(r&2)===0&&(e[1]=u(t[1]*n[1])),(r&8)===0&&(e[3]=u(t[3]*n[3]))},e.prototype._injectContact=function(e,t,n,r,i,s,o){var u,a=this.contacts,f=a.length;f!==0&&(u=a[0],u._hash!==s&&(f!==1?(u=a[1],u._hash!==s&&(u=null)):u=null)),o===undefined&&(o=!1);var l;return u?(u.fresh=!o&&u.virtual,l=u._data):(u=R.allocate(),l=u._data,l[11]=l[12]=0,u._hash=s,u.fresh=!o,a.push(u),s===0&&(this._data[16]=0)),l[0]=e,l[1]=t,l[2]=i,u._timeStamp=this._timeStamp,u.virtual=o,l=this._data,l[4]=n,l[5]=r,u},e.prototype._cleanContacts=function(e){var t=!0;this._position2Contact=!1,this._contact2=null;var n=this.contacts,r=n.length,i;for(i=0;i<r;){var s=n[i];if(s._timeStamp+b.DELAYED_DEATH<e){r-=1,n[i]=n[r],n.pop(),R.deallocate(s);continue}s.active=s._timeStamp===e,s.active&&(t?(this._contact1=s,t=!1):(this._contact2=s,this._position2Contact=!0)),i+=1}if(this._position2Contact){if(this._contact1.virtual){var o=this._contact1;this._contact1=this._contact2,this._contact2=o}this._velocity2Contact=!this._contact2.virtual}else this._velocity2Contact=!1;return!t},e.prototype._preStep=function(e,t,n){if(!this._cleanContacts(t))return!1;this._invalidated&&this._validate();var r=this._data,i=r[6],s=i===0?1:e/i;r[6]=e;var o=this.bodyA._data,u=this.bodyB._data,a=o[2],f=o[3],l=u[2],c=u[3],h=o[7],p=o[8],d=o[9],v=u[7],m=u[8],g=u[9],y=r[4],w=r[5],E=o[0]+u[0],S=o[1],x=u[1],T=b.EFF_MASS_EPSILON,N=n?this._static?b.CONT_STATIC_BIAS_COEF:b.CONT_BIAS_COEF:this._static?b.STATIC_BIAS_COEF:b.BIAS_COEF;r[15]=N;var C=this._contact1,k,L,A,O,M;for(;;){k=C._data;var _=k[0],D=k[1];L=k[7]=_-a,A=k[8]=D-f,O=k[9]=_-l,M=k[10]=D-c;var P=L*y+A*w,H=O*y+M*w,B=E+x*H*H+S*P*P;k[6]=B<T?0:1/B,P=L*w-A*y,H=O*w-M*y;var j=E+x*H*H+S*P*P;k[5]=j<T?0:1/j;var F=v-M*g-(h-A*d),I=m+O*g-(p+L*d),q=y*F+w*I,R=q*r[2];R>-b.BOUNCE_VELOCITY_THRESHOLD&&(R=0),k[3]=R,q=y*I-w*F,q*q>b.STATIC_FRIC_SQ_EPSILON?k[4]=r[0]:k[4]=r[1],k[11]*=s,k[12]*=s;if(!this._velocity2Contact)break;if(C===this._contact2)break;C=this._contact2}k=this._contact1._data,L=k[7],A=k[8],O=k[9],M=k[10];var U=r[7]=L*w-A*y,z=r[8]=O*w-M*y;r[9]=L*y+A*w,r[10]=O*y+M*w;if(!this._velocity2Contact&&this._contact1._hash===0){r[16]*=s;var W=S+x;r[17]=W<T?0:1/W}else if(this._velocity2Contact){k=this._contact2._data;var X=k[7],V=k[8],$=k[9],J=k[10],K=r[16]=X*w-V*y,Q=r[17]=$*w-J*y;r[18]=X*y+V*w,r[19]=$*y+J*w;var G=r[20]=E+S*U*U+x*z*z,Y=r[21]=E+S*U*K+x*z*Q,Z=r[22]=E+S*K*K+x*Q*Q,et=G*Z-Y*Y;G*G>b.ILL_THRESHOLD*et?(this._contact2._data[2]<this._contact1._data[2]&&(this._contact1=this._contact2,r[7]=K,r[8]=Q,r[9]=r[18],r[10]=r[19]),this._velocity2Contact=!1,this._position2Contact=!1,this._contact2=null):r[23]=1/et}return!0},e.prototype._iterateVelocity=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[0],r=e[1],i=t[0],s=t[1],o=e[7],u=e[8],a=e[9],f=t[7],l=t[8],c=t[9],h=this._data,p=h[4],d=h[5],v=h[7],m=h[8],g=h[9],y=h[10],b=this._contact1._data,w=b[7],E=b[8],S=b[9],x=b[10],T=t[13]-e[13],N=t[14]-e[14],C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),L,A,O,M,_,D;L=(p*k-d*C+T)*b[6],D=b[4]*b[11],A=b[12],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,b[12]=O,M=-d*L,_=p*L,o-=M*n,u-=_*n,a-=g*L*r,f+=M*i,l+=_*i,c+=y*L*s;if(this._velocity2Contact){var P=this._contact2._data,H=P[7],B=P[8],j=P[9],F=P[10],I=h[20],q=h[21],R=h[22],U=h[23],z=h[16],W=h[17],X=h[18],V=h[19],$=f-F*c-(o-B*a),J=l+j*c-(u+H*a);L=(p*J-d*$+T)*P[6],D=P[4]*P[11],A=P[12],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,P[12]=O,M=-d*L,_=p*L,o-=M*n,u-=_*n,a-=X*L*r,f+=M*i,l+=_*i,c+=V*L*s,C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),$=f-F*c-(o-B*a),J=l+j*c-(u+H*a);var K=b[11],Q=P[11],G=C*p+k*d+N+b[3]-(I*K+q*Q),Y=$*p+J*d+N+P[3]-(q*K+R*Q),Z=U*(q*Y-R*G),et=U*(q*G-I*Y);Z>=0&&et>=0?(G=Z-K,Y=et-Q,b[11]=Z,P[11]=et):(Z=-(b[5]*G),Z>=0&&q*Z+Y>=0?(G=Z-K,Y=-Q,b[11]=Z,P[11]=0):(et=-(P[5]*Y),et>=0&&q*et+G>=0?(G=-K,Y=et-Q,b[11]=0,P[11]=et):G>=0&&Y>=0?(G=-K,Y=-Q,b[11]=P[11]=0):(G=0,Y=0))),L=G+Y,M=p*L,_=d*L,o-=M*n,u-=_*n,a-=(v*G+z*Y)*r,f+=M*i,l+=_*i,c+=(m*G+W*Y)*s}else{if(this._contact1._hash===0){var tt=c-a;L=tt*h[17],D=h[3]*b[11],A=h[16],O=A-L,O>D?O=D:O<-D&&(O=-D),L=O-A,h[16]=O,a-=L*r,c+=L*s}C=f-x*c-(o-E*a),k=l+S*c-(u+w*a),L=(b[3]+N+(p*C+d*k))*b[5],A=b[11],O=A-L,O<0&&(O=0),L=O-A,b[11]=O,M=p*L,_=d*L,o-=M*n,u-=_*n,a-=v*L*r,f+=M*i,l+=_*i,c+=m*L*s}e[7]=o,e[8]=u,e[9]=a,t[7]=f,t[8]=l,t[9]=c},e.prototype._refreshContactData=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[5],r=e[6],i=t[5],s=t[6],o=e[2],u=e[3],a=t[2],f=t[3],l,c,h,p=this._data,d=p[14],v=this._contact1._data;if(this._faceType===0){var m=v[13],g=v[14],y=n*m-r*g+o,w=r*m+n*g+u;m=v[15],g=v[16];var E=i*m-s*g+a,S=s*m+i*g+f,x=E-y,T=S-w,N=Math.sqrt(x*x+T*T);c=p[4],h=p[5];if(N<b.NORMALIZE_EPSILON)x=c,T=h;else{var C=1/N;x*=C,T*=C}l=N-d,x*c+T*h<0&&(l-=d,x=-x,T=-T),p[4]=x,p[5]=T;var k,L,A;this.shapeA._type===0?(A=this.shapeA._data[6]+l*.5,k=v[0]=y+x*A,L=v[1]=w+T*A):(A=this.shapeB._data[6]+l*.5,k=v[0]=E-x*A,L=v[1]=S-T*A),v[2]=l}else{var O=this._position2Contact?this._contact2._data:null,M,_,D,P,H,B=p[11],j=p[12],F=v[13],I=v[14];this._faceType===1?(c=B*n-j*r,h=B*r+j*n,M=p[13]+(c*o+h*u),_=a+F*i-I*s,P=f+F*s+I*i,O&&(F=O[13],I=O[14],D=a+F*i-I*s,H=f+F*s+I*i)):(c=B*i-j*s,h=B*s+j*i,M=p[13]+(c*a+h*f),_=o+F*n-I*r,P=u+F*r+I*n,O&&(F=O[13],I=O[14],D=o+F*n-I*r,H=u+F*r+I*n));var q=this._reverse?-1:1;p[4]=q*c,p[5]=q*h;var R=-M-d;l=_*c+P*h+R;var U=l*.5+d;v[0]=_-c*U,v[1]=P-h*U,v[2]=l,O&&(l=D*c+H*h+R,U=l*.5+d,O[0]=D-c*U,O[1]=H-h*U,O[2]=l)}},e.prototype._iteratePosition=function(){this._refreshContactData();var e=this.bodyA,t=this.bodyB,n=e._data,r=t._data,i=n[0],s=n[1],o=r[0],u=r[1],a=n[2],f=n[3],l=r[2],c=r[3],h,p,d,v,m,g,y,w,E,S,x,T,N,C,k,L,A=this._data,O=this._contact1._data,M=O[2]+b.CONTACT_SLOP;if(this._position2Contact){var _=this._contact2._data,D=_[2]+b.CONTACT_SLOP;if(M<0||D<0){h=O[0],p=O[1],x=h-a,T=p-f,N=h-l,C=p-c,h=_[0],p=_[1];var P=h-a,H=p-f,B=h-l,j=p-c;d=A[4],v=A[5],k=x*v-T*d,L=N*v-C*d;var F=P*v-H*d,I=B*v-j*d,q=i+o;E=q+s*k*k+u*L*L;var R=q+s*k*F+u*L*I,U=q+s*F*F+u*I*I;S=A[15];var z=M*S,W=D*S,X=E*U-R*R,V,$;X===0?(V=E===0?0:-z/E,$=U===0?0:-W/U):(X=1/X,V=X*(R*W-U*z),$=X*(R*z-E*W));if(V<0||$<0){V=-z/E,$=0;if(V<0||R*V+W<0){V=0,$=-W/U;if($<0||R*$+z<0)V=$=0}}y=V+$,m=d*y,g=v*y,a-=m*i,f-=g*i,w=-(k*V+F*$)*s,w!==0&&e._deltaRotation(w),l+=m*o,c+=g*o,w=(L*V+I*$)*u,w!==0&&t._deltaRotation(w)}}else M<0&&(h=O[0],p=O[1],x=h-a,T=p-f,N=h-l,C=p-c,d=A[4],v=A[5],k=x*v-T*d,L=N*v-C*d,E=o+L*L*u+i+k*k*s,E!==0&&(S=A[15],y=-(S*M/E),m=d*y,g=v*y,a-=m*i,f-=g*i,w=-(k*s*y),w!==0&&e._deltaRotation(w),l+=m*o,c+=g*o,w=L*u*y,w!==0&&t._deltaRotation(w)));n[2]=a,n[3]=f,r[2]=l,r[3]=c},e.prototype._warmStart=function(){var e=this.bodyA._data,t=this.bodyB._data,n=e[0],r=e[1],i=t[0],s=t[1],o=this._data,u=o[4],a=o[5],f=this._contact1._data,l=f[11],c=f[12],h=u*l-a*c,p=a*l+u*c;e[7]-=h*n,e[8]-=p*n,e[9]-=(f[7]*p-f[8]*h)*r,t[7]+=h*i,t[8]+=p*i,t[9]+=(f[9]*p-f[10]*h)*s,this._velocity2Contact?(f=this._contact2._data,l=f[11],c=f[12],h=u*l-a*c,p=a*l+u*c,e[7]-=h*n,e[8]-=p*n,e[9]-=(f[7]*p-f[8]*h)*r,t[7]+=h*i,t[8]+=p*i,t[9]+=(f[9]*p-f[10]*h)*s):this._contact1._hash===0&&(l=o[16],e[9]-=l*r,t[9]+=l*s)},e.prototype.getImpulseForBody=function(e,t){t===undefined&&(t=new X.prototype.floatArray(3));var n=this._data,r=n[4],i=n[5],s=this._contact1._data,o=s[11],u=s[12],a=r*o-i*u,f=i*o+r*u,l=0,c=0,h=0;return e===this.bodyA?(l-=a,c-=f,h-=s[7]*f-s[8]*a):e===this.bodyB&&(l+=a,c+=f,h+=s[9]*f-s[10]*a),this._velocity2Contact?(s=this._contact2._data,o=s[11],u=s[12],a=r*o-i*u,f=i*o+r*u,e===this.bodyA?(l-=a,c-=f,h-=s[7]*f-s[8]*a):e===this.bodyB&&(l+=a,c+=f,h+=s[9]*f-s[10]*a)):this._contact1._hash===0&&(o=n[16],h+=(e===this.bodyA?-1:e===this.bodyB?1:0)*o),t[0]=l,t[1]=c,t[2]=h,t},e.allocate=function(){if(!this.pool)return new e;var t=this.pool;return this.pool=t._next,t._next=null,t},e.deallocate=function(e){e._next=this.pool,this.pool=e,e._userdef=0},e.version=1,e.pool=null,e}(),z=function(){function e(){}return e.prototype.getGravity=function(e){return e===undefined&&(e=new X.prototype.floatArray(2)),e[0]=this._gravityX,e[1]=this._gravityY,e},e.prototype.setGravity=function(e){var t=e[0],n=e[1];if(t!==this._gravityX||n!==this._gravityY){this._gravityX=t,this._gravityY=n;var r=this.rigidBodies,i=r.length,s;for(s=0;s<i;s+=1)this._wakeBody(r[s])}},e.prototype._addShape=function(e){var t=e.body;t._update();var n=t._type===2||t.sleeping;e._bphaseHandle=this.broadphase.insert(e,e._data,n)},e.prototype._removeShape=function(e,t){var n=e.body;this.broadphase.remove(e._bphaseHandle),e._bphaseHandle=null;var r=e.arbiters;while(r.length!==0){var i=r.pop();if(i._retired)continue;i.bodyA!==n&&i.bodyA._type===0&&this._wakeBody(i.bodyA),i.bodyB!==n&&i.bodyB._type===0&&this._wakeBody(i.bodyB),i._lazyRetire(e),t||this._pushInteractionEvents(3,i)}},e.prototype._enabledConstraint=function(e){e._islandRoot=e,e._islandRank=0,e.sleeping||(e.sleeping=!0,this._wakeConstraint(e,!0))},e.prototype._disabledConstraint=function(e){this._wakeConstraint(e);var t=this.liveConstraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop()},e.prototype.addConstraint=function(e){return e.world?!1:(e.world=this,this.constraints.push(e),e._inWorld(),e._active&&this._enabledConstraint(e),!0)},e.prototype.removeConstraint=function(e){if(e.world!==this)return!1;var t=this.constraints,n=t.indexOf(e);return t[n]=t[t.length-1],t.pop(),e._active&&this._disabledConstraint(e),e.world=null,e._outWorld(),!0},e.prototype.addRigidBody=function(e){if(e.world)return!1;e.world=this,this.rigidBodies.push(e),e._update();var t,n=e.shapes,r=n.length;for(t=0;t<r;t+=1)this._addShape(n[t]);return e._type===2?(e.sleeping=!0,!0):(e._islandRoot=e,e._islandRank=0,e.sleeping||(e.sleeping=!0,this._wakeBody(e,!0)),!0)},e.prototype.removeRigidBody=function(e,t){if(e.world!==this)return!1;this._wakeBody(e),e.world=null;var n=this.rigidBodies,r=n.indexOf(e);n[r]=n[n.length-1],n.pop(),!e.sleeping&&e._type!==2&&(e._type===0?n=this.liveDynamics:n=this.liveKinematics,r=n.indexOf(e),n[r]=n[n.length-1],n.pop());var i,s=e.shapes,o=s.length;for(i=0;i<o;i+=1)this._removeShape(s[i],t);var u=e.constraints;while(u.length>0)this.removeConstraint(u[0]);return!0},e.prototype.clear=function(){var e=this.rigidBodies,t=e.length;while(t>0)t-=1,this.removeRigidBody(e[t],!0);var n=this.constraints;t=n.length;while(t>0)t-=1,this.removeConstraint(n[t]);this._clearArbiters(this.staticArbiters),this._clearArbiters(this.dynamicArbiters);var r=this._callbacks;t=r.length;while(t>0)t-=1,P.deallocate(r.pop())},e.prototype._clearArbiters=function(e){var t=e.length;while(t>0){var n=e.pop();t-=1,n._retire(),U.deallocate(n)}},e.prototype.shapePointQuery=function(e,t){return this._pointQuery(this._shapePointCallback,e,t)},e.prototype.bodyPointQuery=function(e,t){return this._pointQuery(this._bodyPointCallback,e,t)},e.prototype._pointQuery=function(e,t,n){var r=this._sampleRectangle;return r[0]=r[2]=t[0],r[1]=r[3]=t[1],e.store=n,e.count=0,this.broadphase.sample(r,e.sample,e),e.count},e.prototype.shapeCircleQuery=function(e,t,n){return this._circleQuery(this._shapeCircleCallback,e,t,n)},e.prototype.bodyCircleQuery=function(e,t,n){return this._circleQuery(this._bodyCircleCallback,e,t,n)},e.prototype._circleQuery=function(e,t,n,r){var i=this._circleQueryShape;i.setRadius(n);var s=t[0],o=t[1];i._update(s,o,1,0);var u=this._sampleRectangle;return u[0]=s-n,u[1]=o-n,u[2]=s+n,u[3]=o+n,e.store=r,e.count=0,this.broadphase.sample(u,e.sample,e),e.count},e.prototype.shapeRectangleQuery=function(e,t){return this._rectangleQuery(this._shapeRectangleCallback,e,t)},e.prototype.bodyRectangleQuery=function(e,t){return this._rectangleQuery(this._bodyRectangleCallback,e,t)},e.prototype._rectangleQuery=function(e,t,n){var r=this._rectangleQueryVertices,i=t[0],s=t[1],o=t[2],u=t[3];r[0][0]=r[3][0]=i<o?i:o,r[0][1]=r[1][1]=s<u?s:u,r[1][0]=r[2][0]=i<o?o:i,r[2][1]=r[3][1]=s<u?u:s;var a=this._rectangleQueryShape;return a.setVertices(r),a._update(0,0,1,0),e.store=n,e.count=0,this.broadphase.sample(t,e.sample,e),e.count},e.prototype.rayCast=function(e,t,n,r){var i=e.origin,s=e.direction,o=e.maxFactor,u=i[0],a=i[1],f=u+s[0]*o,l=a+s[1]*o,c=this._sampleRectangle;c[0]=u<f?u:f,c[1]=a<l?a:l,c[2]=u<f?f:u,c[3]=a<l?l:a;var h=this._rayCast;h.ray=e,h.noInner=t||!1,h.minFactor=e.maxFactor,h.userCallback=n,h.userThis=r,h.minShape=null,this.broadphase.sample(c,h.sample,h);if(h.minShape){var p=h.minNormal,d=new X.prototype.floatArray(2),v=new X.prototype.floatArray(2);return d[0]=p[0],d[1]=p[1],v[0]=u+s[0]*h.minFactor,v[1]=a+s[1]*h.minFactor,{shape:h.minShape,hitNormal:d,hitPoint:v,factor:h.minFactor}}return null},e.prototype.convexCast=function(e,t,n,r){var i=e.body,s=i._data,o=s[2],u=s[3];i._sweepIntegrate(t);var a=s[2],f=s[3],l=this._sampleRectangle,c=e._data[4];l[0]=(o<a?o:a)-c,l[1]=(u<f?u:f)-c,l[2]=(o<a?a:o)+c,l[3]=(u<f?f:u)+c,i[20]=i[9];var h=this._convexCast;h.deltaTime=t,h.minTOIAlpha=1,h.minShape=null,h.toi.shapeA=e,h.userCallback=n,h.userThis=r,this.broadphase.sample(l,h.sample,h),i._sweepIntegrate(0),e._update(o,u,s[5],s[6],!0);if(h.minShape){var p=h.minData,d=new X.prototype.floatArray(2),v=new X.prototype.floatArray(2);return d[0]=-p[0],d[1]=-p[1],v[0]=p[2],v[1]=p[3],{shape:h.minShape,hitNormal:d,hitPoint:v,factor:h.minTOIAlpha*t}}return null},e.prototype.step=function(e){this._midStep=!0,this._eventTime=0,this.timeStamp+=1,this._deltaTime=e,this.simulatedTime+=e,this._validate(),this._discreteCollisions(),this._sleepComputations(e),this._preStep(e),this._sortArbiters(),this._integrateVelocity(e),this._warmStart(),this._iterateVelocity(this.velocityIterations),this._integratePosition(e),this._eventTime=1,this._continuousCollisions(e),this._sortArbiters(),this._iteratePosition(this.positionIterations),this._finalize(),this._midStep=!1,this._eventTime=-1,this._doCallbacks()},e.prototype._discreteCollisions=function(){this.broadphase.perform(this._discreteNarrowPhase,this),this._doDeferredWake(!1)},e.prototype._doDeferredWake=function(e){var t=this._deferredWake,n=t.length;while(n>0){var r=t.pop();r._deferred=!1,this._wakeBody(r,!1,e),n-=1}},e.prototype._collisionType=function(e,t,n,r){if(n===r)return undefined;var i=n.constraints.length<r.constraints.length?n.constraints:r.constraints,s=i.length,o;for(o=0;o<s;o+=1){var u=i[o];if(u._active&&u._ignoreInteractions&&u._pairExists(n,r))return undefined}if((e._group&t._mask)===0||(t._group&e._mask)===0)return undefined;var a=!e.sensor&&!t.sensor;return n._type!==0&&r._type!==0&&a?undefined:a},e.prototype._discreteNarrowPhase=function(e,t,n){var r=e.data,i=t.data,s=r.body,o=i.body,u=this._collisionType(r,i,s,o);if(u===undefined)return null;var a=s._type!==0||o._type!==0,f,l;r.id<i.id?(f=r,l=i):(f=i,l=r);var c=(f.arbiters.length<l.arbiters.length?f:l).arbiters,h=c.length,p,d;for(p=0;p<h;p+=1){var v=c[p];if(v.shapeA===f&&v.shapeB===l){d=v;break}}var m=!d;m&&(d=U.allocate());if(m||d._timeStamp!==this.timeStamp||n){d._timeStamp=this.timeStamp;if(u&&this._collisions._collide(f,l,d)||!u&&this._collisions._test(f,l)){m&&(d.sensor=!u,d._assign(f,l),d._static=a,a?this.staticArbiters.push(d):this.dynamicArbiters.push(d));if(m||d._endGenerated===this.timeStamp&&n||d._updateStamp<this.timeStamp-1)d._createContinuous=n,d._createStamp=this.timeStamp,d._state=u?0:3;d._updateStamp=this.timeStamp;var g=!1;if(u&&(d._state&2)===0){d._state=1,d._midStep=!0;var y=f._onPreSolve;h=y.length;var b;for(p=0;p<h;p+=1)b=y[p],b.callback.call(b.thisObject,d,l),b.deterministic||(g=!0);y=l._onPreSolve,h=y.length;for(p=0;p<h;p+=1)b=y[p],b.callback.call(b.thisObject,d,f),b.deterministic||(g=!0);d._midStep=!1,d._indeterminate=g,g&&(d._state&2)===0&&(s._type===0&&!s._deferred&&(s._deferred=!0,this._deferredWake.push(s)),o._type===0&&!s._deferred&&(o._deferred=!0,this._deferredWake.push(o)))}u&&(d._state&1)!==0&&(s._type===0&&s.sleeping&&!s._deferred&&(s._deferred=!0,this._deferredWake.push(s)),o._type===0&&o.sleeping&&!o._deferred&&(o._deferred=!0,this._deferredWake.push(o))),d.sleeping&&this._wakeArbiter(d)}else m&&(U.deallocate(d),d=null)}return d},e.prototype._continuousCollisions=function(e){this.broadphase.perform(this._continuousNarrowPhase,this);var t=0,n=this._toiEvents,r=n.length,i,s;while(t<1&&r!==0){var o=Number.POSITIVE_INFINITY,u=!1,a=-1,f,l;for(s=0;s<r;){i=n[s],f=i.shapeA.body,l=i.shapeB.body;if(f._sweepFrozen&&l._sweepFrozen){r-=1,n[s]=n[r],n.pop(),B.deallocate(i);continue}if(i.frozenA!==f._sweepFrozen||i.frozenB!==l._sweepFrozen){i.frozenA=f._sweepFrozen,i.frozenB=l._sweepFrozen;if(i.frozenA){var c=i.shapeA;i.shapeA=i.shapeB,i.shapeB=c,i.frozenA=!1,i.frozenB=!0}this._collisions._staticSweep(i,e,b.SWEEP_SLOP);if(i._data[6]<0){r-=1,n[s]=n[r],n.pop(),B.deallocate(i);continue}}var h=i._data[6];h>=0&&(h<o||!u&&i.kinematic)&&(o=h,u=i.kinematic,a=s),s+=1}if(a===-1)break;i=n[a],r-=1,n[a]=n[r],n.pop(),t=o;var p=i.shapeA,d=i.shapeB;f=p.body,l=d.body;var v=f._data,m=l._data;if(!f._sweepFrozen||i.kinematic)f._sweepIntegrate(t*e),p._update(v[2],v[3],v[5],v[6],!0);if(!l._sweepFrozen||i.kinematic)l._sweepIntegrate(t*e),d._update(m[2],m[3],m[5],m[6],!0);var g=this._discreteNarrowPhase(p._bphaseHandle,d._bphaseHandle,!0);g&&this._continuousArbiterPrepare(g,e),g&&!g.sensor&&(g._state&1)!==0&&(!f._sweepFrozen&&f._type===0&&(f._sweepFrozen=!0,i.failed?v[20]=0:i.slipped&&(v[20]*=b.TOI_SLIP_SCALE),v[9]=v[20]),!l._sweepFrozen&&l._type===0&&(l._sweepFrozen=!0,i.failed?m[20]=0:i.slipped&&(m[20]*=b.TOI_SLIP_SCALE),m[9]=m[20])),B.deallocate(i)}while(r>0)i=n.pop(),B.deallocate(i),r-=1;var y=this.liveDynamics;r=y.length;for(s=0;s<r;s+=1){var w=y[s];w._sweepFrozen||w._sweepIntegrate(e)}y=this.liveKinematics,r=y.length;for(s=0;s<r;s+=1)y[s]._sweepIntegrate(e);this._doDeferredWake(!0)},e.prototype._continuousNarrowPhase=function(e,t){var n=e.data,r=t.data,i=n.body,s=r.body;if(i._sweepFrozen&&s._sweepFrozen)return;var o=i._type!==0||s._type!==0;if(o||i._bullet||s._bullet){var u=B.allocate(),a=i._type===1||s._type===1;o&&!a?(i._type!==0?(u.shapeB=n,u.shapeA=r):(u.shapeA=n,u.shapeB=r),this._collisions._staticSweep(u,this._deltaTime,b.SWEEP_SLOP)):n.body._sweepFrozen?(u.shapeB=n,u.shapeA=r,this._collisions._staticSweep(u,this._deltaTime,b.SWEEP_SLOP)):r.body._sweepFrozen?(u.shapeA=n,u.shapeB=r,this._collisions._staticSweep(u,this._deltaTime,b.SWEEP_SLOP)):(u.shapeA=n,u.shapeB=r,this._collisions._dynamicSweep(u,this._deltaTime,b.SWEEP_SLOP)),o&&u._data[6]<0||u.failed?B.deallocate(u):(this._toiEvents.push(u),u.frozenA=u.shapeA.body._sweepFrozen,u.frozenB=u.shapeB.body._sweepFrozen,u.staticType=o,u.kinematic=a)}},e.prototype.__union=function(e,t){var n,r;while(e!==e._islandRoot)r=e._islandRoot,e._islandRoot=n,n=e,e=r;while(n)r=n._islandRoot,n._islandRoot=e,n=r;while(t!==t._islandRoot)r=t._islandRoot,t._islandRoot=n,n=t,t=r;while(n)r=n._islandRoot,n._islandRoot=t,n=r;e!==t&&(e._islandRank<t._islandRank?e._islandRoot=
t:t._islandRank<e._islandRank?t._islandRoot=e:(t._islandRoot=e,e._islandRank+=1))},e.prototype.__find=function(e){if(e===e._islandRoot)return e;var t=null,n;while(e!==e._islandRoot)n=e._islandRoot,e._islandRoot=t,t=e,e=n;while(t)n=t._islandRoot,t._islandRoot=e,t=n;return e},e.prototype._sleepComputations=function(e){var t=this.dynamicArbiters,n,r=t.length,i;for(i=0;i<r;i+=1){n=t[i];if(!n.sensor&&!n._retired&&n._updateStamp===this.timeStamp&&(n._state&1)!==0){var s=n.bodyA,o=n.bodyB;s._type===0&&o._type===0&&this.__union(s,o)}}var u=this.liveConstraints;r=u.length;for(i=0;i<r;i+=1)u[i]._sleepComputation(this.__union);var a=this._islands,f,l,c=this.liveDynamics;r=c.length;while(r>0){r-=1;var h=c.pop();l=this.__find(h),f=l._island,f===null&&(l._island=f=H.allocate(),a.push(f),f.sleeping=!0,f.wakeTime=0),h._island=f,f.components.push(h);var p=h._atRest(e,this.timeStamp);f.sleeping=f.sleeping&&p,h._wakeTime>f.wakeTime&&(f.wakeTime=h._wakeTime)}r=u.length;while(r>0){r-=1;var d=u.pop();l=this.__find(d),f=l._island,f===null&&(l._island=f=H.allocate(),a.push(f),f.sleeping=!0,f.wakeTime=0),d._island=f,f.components.push(d),d._wakeTime>f.wakeTime&&(f.wakeTime=d._wakeTime)}r=a.length;var v,m=this.broadphase;while(r>0){r-=1,f=a[r],a.pop();var g,y;if(f.sleeping){y=f.components,v=y.length;var b;for(b=0;b<v;b+=1){g=y[b],g.sleeping=!0;if(g._isBody){var w=g.shapes,E=w.length,S;for(S=0;S<E;S+=1){var x=w[S];m.update(x._bphaseHandle,x._data,!0)}var T=g._data;T[7]=0,T[8]=0,T[9]=0}g._onSleep.length>0&&this._pushCallbacks(g,g._onSleep)}}else{y=f.components,v=y.length;while(v>0)v-=1,g=y.pop(),g._wakeTime=f.wakeTime,g._isBody?c.push(g):u.push(g),g._island=null,g._islandRoot=g,g._islandRank=0;H.deallocate(f)}}},e.prototype._sortArbiters=function(){this._subSortArbiters(this.dynamicArbiters),this._subSortArbiters(this.staticArbiters)},e.prototype._subSortArbiters=function(e){var t,n=e.length-1;for(t=1;t<n;t+=1){var r=e[t],i=r.shapeA.id,s=r.shapeB.id,o=t;while(o>0){var u=e[o-1],a=u.shapeA.id;if(a<i||a===i&&u.shapeB.id<s)break;e[o]=u,o-=1}e[o]=r}},e.prototype._onWakeCallbacks=function(e){this._midStep?e._onWake.length>0&&this._pushCallbacks(e,e._onWake):e._woken=!0},e.prototype._pushCallbacks=function(e,t){var n=this._callbacks,r=t.length,i;for(i=0;i<r;i+=1){var s=P.allocate();s.thisObject=e,s.callback=t[i],s.time=this._eventTime,s.index=i,n.push(s)}},e.prototype._pushInteractionEvents=function(e,t){var n=this._callbacks,r=t.shapeA,i=t.shapeB,s=r._group,o=i._group,u=r._events,a=u.length,f,l,c;for(f=0;f<a;f+=1)l=u[f],l.type===e&&(l.mask===undefined||(l.mask&o)!==0)&&(c=P.allocate(),c.thisObject=r,c.callback=l.callback,c.time=this._eventTime,c.index=f,c.arbiter=t,n.push(c));u=i._events,a=u.length;for(f=0;f<a;f+=1)l=u[f],l.type===e&&(l.mask===undefined||(l.mask&s)!==0)&&(c=P.allocate(),c.thisObject=r,c.callback=l.callback,c.time=this._eventTime,c.index=f,c.arbiter=t,n.push(c))},e.prototype._brokenConstraint=function(e){e._onBreak.length>0&&this._pushCallbacks(e,e._onBreak);if(e._removeOnBreak){e.world=null;var t=this.constraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop(),e._outWorld()}else e._active=!1;e._clearCache()},e.prototype._preStep=function(e){var t=this.liveConstraints,n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._preStep(e)){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._preStepArbiters(this.dynamicArbiters,e),this._preStepArbiters(this.staticArbiters,e)},e.prototype._preStepArbiter=function(e,t,n){var r=this.timeStamp;e.active=e._updateStamp===r,e._createContinuous&&e._createStamp===r?this._pushInteractionEvents(1,e):n&&e.active&&this._pushInteractionEvents(2,e),e.active&&((e._state&1)!==0?e._preStep(t,r,!0)||(e.active=!1):!e.sensor&&!e._cleanContacts(r)&&(e.active=!1))},e.prototype._preStepArbiters=function(e,t){var n=this.timeStamp,r=e.length,i;for(i=0;i<r;){var s=e[i];if(!s._retired&&s.bodyA.sleeping&&s.bodyB.sleeping){s._sleepStamp=n,s.sleeping=!0,s.active=!1,this._pushInteractionEvents(2,s),r-=1,e[i]=e[r],e.pop();continue}if(!!s._lazyRetired){s._lazyRetired=!1,i+=1;continue}if(s._retired||s._updateStamp+(s.sensor?1:b.DELAYED_DEATH)<n){s._retire(),r-=1,e[i]=e[r],e.pop(),U.deallocate(s);continue}s.active=s._updateStamp===n,s._createStamp===n?this._pushInteractionEvents(1,s):s.active?this._pushInteractionEvents(2,s):s._updateStamp===n-1&&(this._pushInteractionEvents(3,s),s._endGenerated=this.timeStamp),s.active&&((s._state&1)!==0?s._preStep(t,n)||(s.active=!1):!s.sensor&&!s._cleanContacts(n)&&(s.active=!1)),i+=1}},e.prototype._iterateVelocity=function(e){var t=this.liveConstraints;while(e>0){var n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._iterateVel()){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._iterateVelocityArbiters(this.dynamicArbiters),this._iterateVelocityArbiters(this.staticArbiters),e-=1}},e.prototype._iterateVelocityArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._iterateVelocity()}},e.prototype._iteratePosition=function(e){var t=this.liveConstraints;while(e>0){var n=t.length,r;for(r=0;r<n;){var i=t[r];if(i._stiff&&i._iteratePos()){n-=1,t[r]=t[n],t.pop(),this._brokenConstraint(i);continue}r+=1}this._iteratePositionArbiters(this.dynamicArbiters),this._iteratePositionArbiters(this.staticArbiters),e-=1}},e.prototype._iteratePositionArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._iteratePosition()}},e.prototype._integrateVelocity=function(e){var t=this._gravityX,n=this._gravityY,r=this.liveDynamics,i=r.length,s;for(s=0;s<i;s+=1){var o=r[s],u=o._data,a=u[0],f;a!==0&&(u[7]+=(u[10]*a+t)*e,u[8]+=(u[11]*a+n)*e,f=Math.exp(e*u[21]),u[7]*=f,u[8]*=f);var l=u[1];l!==0&&(u[9]+=u[12]*l*e,u[9]*=Math.exp(e*u[22]))}},e.prototype._integratePosition=function(e){this._integratePositionBodies(this.liveDynamics,e),this._integratePositionBodies(this.liveKinematics,e)},e.prototype._integratePositionBodies=function(e,t){var n=2*Math.PI/t,r=1/(t*t),i=b.MIN_LINEAR_STATIC_SWEEP,s=b.MIN_ANGULAR_STATIC_SWEEP;i*=i*r,s*=s*r;var o=b.MIN_LINEAR_BULLET_SWEEP,u=b.MIN_ANGULAR_BULLET_SWEEP;o*=o*r,u*=u*r;var a=this.broadphase,f=e.length,l;for(l=0;l<f;l+=1){var c=e[l],h=c._data,p=h[15]=h[2],d=h[16]=h[3];h[17]=h[4];var v=h[2]+=h[7]*t,m=h[3]+=h[8]*t,g=h[9];c._deltaRotation(g*t),h[18]=t;var y=h[7],w=h[8],E=h[20]=g%n,S=h[19],x=i*S*S,T=y*y+w*w;if(T>x||E*E>s){var N=p<v?p:v,C=d<m?d:m,k=p<v?v:p,L=d<m?m:d,A=c.shapes,O=A.length,M;for(M=0;M<O;M+=1){var _=A[M],D=_._data;S=D[4],D[0]=N-S,D[1]=C-S,D[2]=k+S,D[3]=L+S,a.update(_._bphaseHandle,D)}c._sweepFrozen=!1,c._type===0&&(c._bullet=c.bullet&&(T>o*S*S||E*E>u))}else c._sweepFrozen=!0,c._bullet=!1}},e.prototype._finalize=function(){this._finalizeBodies(this.liveDynamics),this._finalizeBodies(this.liveKinematics),this._finalizeArbiters(this.dynamicArbiters),this._finalizeArbiters(this.staticArbiters)},e.prototype._finalizeArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&r._refreshContactData()}},e.prototype._finalizeBodies=function(e){var t=this.broadphase,n=e.length,r;for(r=0;r<n;){var i=e[r],s=i._data,o=i.shapes,u=o.length,a,f;if(s[15]!==s[2]||s[16]!==s[3]||s[17]!==s[4])i._invalidated=!0;else if(i._type===1){n-=1,e[r]=e[n],e.pop(),i.sleeping=!0;for(a=0;a<u;a+=1)f=o[a],t.update(f._bphaseHandle,f._data,!0);continue}r+=1}},e.prototype._doCallbacks=function(){var e=this._callbacks,t,n=[e.length-1,0];do{var r=n.pop(),i=n.pop();if(r>i)continue;var s=r+i>>1,o=e[s],u=r,a=o.index,f=o.time;e[s]=e[i],e[i]=o;for(t=r;t<i;t+=1){var l=e[t];if(l.time<f||l.time===f&&l.index<a)e[t]=e[u],e[u]=l,u+=1}e[i]=e[u],e[u]=o,u+1<i&&(n.push(i),n.push(u+1)),r<u-1&&(n.push(u-1),n.push(r))}while(n.length>0);var c=e.length;for(t=0;t<c;t+=1){var h=e[t];if(h.arbiter){var p=h.arbiter,d=p.shapeA,v=p.shapeB,m=h.thisObject;h.callback.call(m,p,m===d?v:d)}else h.callback.call(h.thisObject);P.deallocate(h)}e.length=0},e.prototype._warmStart=function(){var e=this.liveConstraints,t=e.length,n;for(n=0;n<t;n+=1)e[n]._warmStart();this._warmStartArbiters(this.dynamicArbiters),this._warmStartArbiters(this.staticArbiters)},e.prototype._warmStartArbiters=function(e){var t=e.length,n;for(n=0;n<t;n+=1){var r=e[n];r.active&&!r.sensor&&(r._state&1)!==0&&r._warmStart()}},e.prototype._forceSleepBody=function(e){if(e.sleeping||e._type!==0)return;e.sleeping=!0;var t=this.liveDynamics,n=t.indexOf(e);t[n]=t[t.length-1],t.pop();var r=e.shapes,i=r.length,s,o=this.broadphase;for(s=0;s<i;s+=1){var u=r[s];o.update(u._bphaseHandle,u._data,!0);var a=u.arbiters,f=a.length,l;for(l=0;l<f;l+=1){var c=a[l];if(c._retired||c.sleeping)continue;c.sleeping=!0,c._sleepStamp=this.timeStamp;var h;c._static?h=this.staticArbiters:h=this.dynamicArbiters,n=h.indexOf(c),h[n]=h[h.length-1],h.pop()}}},e.prototype._forceSleepConstraint=function(e){if(e.sleeping)return;e.sleeping=!0;if(e._active){var t=this.liveConstraints,n=t.indexOf(e);t[n]=t[t.length-1],t.pop()}},e.prototype._wakeConstraint=function(e,t){if(e.world!==this)return;e._active&&(e._wakeTime=this.timeStamp+(this._midStep?0:1),e.sleeping&&(e._island?this._wakeIsland(e._island,t?e:null):(e.sleeping=!1,this.liveConstraints.push(e),e._wakeConnected(),t||this._onWakeCallbacks(e))))},e.prototype._wakeBody=function(e,t,n){if(e.world!==this)return;e._wakeTime=this.timeStamp+(this._midStep?0:1);if(e.sleeping)if(!e._island){var r=this.broadphase;e._type===0?(e.sleeping=!1,this.liveDynamics.push(e)):e._type===1&&(e.sleeping=!1,this.liveKinematics.push(e));var i=e.constraints,s=i.length,o;for(o=0;o<s;o+=1)this._wakeConstraint(i[o]);var u=e._type===2,a=e.shapes;s=a.length;for(o=0;o<s;o+=1){var f=a[o];this._wakeArbiters(f.arbiters,!1,n),u||r.update(f._bphaseHandle,f._data,!1)}!t&&e._type===0&&this._onWakeCallbacks(e)}else this._wakeIsland(e._island,t?e:null,n)},e.prototype._wakeArbiter=function(e,t){e.sleeping=!1;var n=this.timeStamp+(this._midStep?0:1),r=n-e._sleepStamp;e._updateStamp+=r;var i=e.contacts,s=i.length,o;for(o=0;o<s;o+=1)i[o]._timeStamp+=r;e._static?this.staticArbiters.push(e):this.dynamicArbiters.push(e),t&&this._continuousArbiterPrepare(e,this._deltaTime,!0)},e.prototype._continuousArbiterPrepare=function(e,t,n){this._preStepArbiter(e,t,n),e.active&&!e.sensor&&(e._state&1)!==0&&e._iterateVelocity()},e.prototype._wakeArbiters=function(e,t,n){var r=e.length,i,s=this.timeStamp+(this._midStep?0:1);for(i=0;i<r;i+=1){var o=e[i];if(o._retired)continue;o.sleeping&&this._wakeArbiter(o,n);if(!t&&o._updateStamp===s&&!o.sensor&&(o._state&1)!==0){var u=o.bodyA,a=o.bodyB;u._type===0&&u.sleeping&&this._wakeBody(u,!1,n),a._type===0&&a.sleeping&&this._wakeBody(a,!1,n)}}},e.prototype._wakeIsland=function(e,t,n){var r=this.broadphase,i=this.liveDynamics,s=this.liveConstraints,o=this.timeStamp+(this._midStep?0:1),u=e.components,a=u.length;while(a>0){a-=1;var f=u.pop();f._wakeTime=o,f._island=null,f._islandRoot=f,f._islandRank=0,f.sleeping=!1;if(f._isBody){i.push(f);var l=f.shapes,c=l.length,h;for(h=0;h<c;h+=1){var p=l[h];this._wakeArbiters(p.arbiters,!0,n),r.update(p._bphaseHandle,p._data,!1)}}else s.push(f);t!==f&&this._onWakeCallbacks(f)}H.deallocate(e)},e.prototype._transmitBodyType=function(e,t){this._wakeBody(e);var n;e._type===0?n=this.liveDynamics:e._type===1&&(n=this.liveKinematics);var r;n&&(r=n.indexOf(e),n[r]=n[n.length-1],n.pop()),e._type=t;var i=t===2;i&&e._update(),t===0&&(e._islandRoot=e,e._islandRank=0);var s=this.broadphase,o=e.shapes,u=o.length,a;for(a=0;a<u;a+=1){var f=o[a];i&&s.update(f._bphaseHandle,f._data,!0);var l=f.arbiters,c=l.length,h;for(h=0;h<c;){var p=l[h];if(p._retired)continue;var d=p.bodyA._type!==0&&p.bodyB._type!==0,v=p.bodyA._type===1||p.bodyB._type===1;if(d&&(!v||!p.sensor)){c-=1,l[h]=l[c],l.pop(),p._lazyRetire(f),this._pushInteractionEvents(3,p);continue}var m=p.bodyA._type!==0||p.bodyB._type!==0;if(m!==p._static){var g=p._static?this.staticArbiters:this.dynamicArbiters;r=g.indexOf(p),g[r]=g[g.length-1],g.pop(),p._static=m,g=m?this.staticArbiters:this.dynamicArbiters,g.push(p)}h+=1}}e.sleeping=!0,this._wakeBody(e)},e.prototype._validate=function(){this._validateBodies(this.liveDynamics),this._validateBodies(this.liveKinematics);var e=this.liveConstraints,t,n=e.length;for(t=0;t<n;t+=1){var r=e[t];r._woken&&r._onWake.length>0&&this._pushCallbacks(r,r._onWake),r._woken=!1}},e.prototype._validateBodies=function(e){var t=this.broadphase,n,r=e.length;for(n=0;n<r;n+=1){var i=e[n],s=i._data,o=s[4];s[5]=Math.cos(o),s[6]=Math.sin(o),i._update(),i._type===0&&i._woken&&i._onWake.length>0&&this._pushCallbacks(i,i._onWake),i._woken=!1;var u=i.shapes,a=u.length,f;for(f=0;f<a;f+=1){var l=u[f];t.update(l._bphaseHandle,l._data)}}},e.create=function(t){var n=new e;n.simulatedTime=0,n.rigidBodies=[],n.constraints=[],n.liveDynamics=[],n.liveKinematics=[],n.liveConstraints=[],n.dynamicArbiters=[],n.staticArbiters=[],n._islands=[],n._toiEvents=[],n._deferredWake=[],n._eventTime=-1,n._callbacks=[],n.broadphase=t.broadphase||F.create(),n.velocityIterations=t.velocityIterations||8,n.positionIterations=t.positionIterations||8,n._midStep=!1,n.timeStamp=0;var r=t.gravity;n._gravityX=r?r[0]:0,n._gravityY=r?r[1]:10,n._collisions=W.create(),n._sampleRectangle=new X.prototype.floatArray(4);var i=function(t){return{store:null,count:0,collisions:n._collisions,sample:function(e,n){var r=e.data;t.call(this,r,n)&&(this.store[this.count]=r,this.count+=1)}}},s=function(t){return{store:null,count:0,collisions:n._collisions,sample:function(e,n){var r=e.data;if(t.call(this,r,n)){var i=!1,s=r.body,o,u=this.count,a=this.store;for(o=0;o<u;o+=1)if(a[o]===s){i=!0;break}i||(a[u]=s,this.count+=1)}}}},o=function(t,n){return this.collisions._contains(t,n[0],n[1])};n._shapePointCallback=i(o),n._bodyPointCallback=s(o);var u=function(t,n){return this.collisions._test(t,this.rectangleShape)};n._shapeRectangleCallback=i(u),n._bodyRectangleCallback=s(u),n._rectangleQueryVertices=[new X.prototype.floatArray(2),new X.prototype.floatArray(2),new X.prototype.floatArray(2),new X.prototype.floatArray(2)],n._rectangleQueryShape=_.create({vertices:n._rectangleQueryVertices}),n._shapeRectangleCallback.rectangleShape=n._rectangleQueryShape,n._bodyRectangleCallback.rectangleShape=n._rectangleQueryShape;var a=function(t,n){return this.collisions._test(t,this.circleShape)};n._shapeCircleCallback=i(a),n._bodyCircleCallback=s(a),n._circleQueryShape=M.create({radius:1}),n._shapeCircleCallback.circleShape=n._circleQueryShape,n._bodyCircleCallback.circleShape=n._circleQueryShape;var f={shape:null,hitPoint:new X.prototype.floatArray(2),hitNormal:new X.prototype.floatArray(2),factor:0};return n._rayCast={minNormal:new X.prototype.floatArray(2),minShape:null,minFactor:0,userCallback:null,userThis:null,ray:null,noInner:!1,normal:new X.prototype.floatArray(2),sample:function(t,r){var i=t.data,s=this.ray,o=this.normal,u=s.maxFactor;s.maxFactor=this.minFactor;var a=n._collisions.rayTest(i,s,o,this.noInner);s.maxFactor=u;if(this.userCallback){var l=f,c=l.hitNormal;c[0]=o[0],c[1]=o[1],c=l.hitPoint;var h=s.origin,p=s.direction;c[0]=h[0]+p[0]*a,c[1]=h[1]+p[1]*a,l.factor=a,l.shape=i;if(!this.userCallback.call(this.userThis,s,l))return}if(a!==undefined){this.minFactor=a,this.minShape=i;var d=this.minNormal;d[0]=o[0],d[1]=o[1]}}},n._convexCast={toi:n._collisions._toi,minData:new X.prototype.floatArray(4),minShape:null,minTOIAlpha:0,userCallback:null,userThis:null,deltaTime:0,sample:function(t,r){var i=this.toi,s=t.data;if(s===i.shapeA)return;i.shapeB=s,s.body._update();var o=n._collisions._staticSweep(i,this.minTOIAlpha*this.deltaTime,0)*this.minTOIAlpha;if(o<=0)return;var u=i._data;if(this.userCallback){var a=f,l=a.hitNormal;l[0]=-u[0],l[1]=-u[1],l=a.hitPoint,l[0]=u[4],l[1]=u[5],a.factor=o*this.deltaTime,a.shape=s,a.shape=s;if(!this.userCallback.call(this.userThis,i.shapeA,a))return}this.minTOIAlpha=o;var c=this.minData;c[0]=u[0],c[1]=u[1],c[2]=u[4],c[3]=u[5],this.minShape=s}},n},e.version=1,e}(),W=function(){function e(){}return e.prototype.containsPoint=function(e,t){return e.body._update(),this._contains(e,t[0],t[1])},e.prototype.signedDistance=function(e,t,n,r,i){e.body._update(),t.body!==e.body&&t.body._update();var s=this._toi._data,o=this._distance(e,t,s);return n[0]=s[2],n[1]=s[3],r[0]=s[4],r[1]=s[5],i[0]=s[0],i[1]=s[1],o},e.prototype.intersects=function(e,t){return e.body._update(),t.body!==e.body&&t.body._update(),this._test(e,t)},e.prototype.rayTest=function(e,t,n,r){return e.body._update(),this._rayTest(e,t,n,r)},e.prototype.sweepTest=function(e,t,n,r,i){var s=this._toi;s.shapeA=e,s.shapeB=t;var o=e.body,u=t.body,a=o._data,f=u._data;a[18]=0,f[18]=0,a[20]=a[9],f[20]=f[9];var l=this._dynamicSweep(s,n,0,!0);o._sweepIntegrate(0),u._sweepIntegrate(0),e._update(a[2],a[3],a[5],a[6]),t._update(f[2],f[3],f[5],f[6]);if(l<0)return undefined;var c=s._data;return r[0]=.5*(c[2]+c[4]),r[1]=.5*(c[3]+c[5]),i[0]=c[0],i[1]=c[1],l*n},e.prototype._rayTest=function(e,t,n,r){return e._type===0?this._rayTestCircle(e,t,n,r):this._rayTestPolygon(e,t,n,r)},e.prototype._rayTestPolygon=function(e,t,n,r){var i=t.origin,s=t.direction,o=e._data,u=i[0],a=i[1],f=s[0],l=s[1],c=t.maxFactor,h,p,d=6,v=o.length;for(;d<v;d+=13){var m=o[d+6],g=o[d+6+1],y=m*f+g*l;if(y>=0&&r||y*y<b.COLLINEAR_SQ_EPSILON)continue;var w=(o[d+9]-(u*m+a*g))/y;if(w<0||w>=c)continue;var E=u+f*w,S=a+l*w,x=m*S-g*E;if(x<o[d+10]||x>o[d+11])continue;c=w,h=d,p=y>=0}if(h===undefined)return undefined;var T=p?-1:1;return n[0]=o[h+6]*T,n[1]=o[h+6+1]*T,c},e.prototype._rayTestCircle=function(e,t,n,r){var i=t.origin,s=t.direction,o=e._data,u=i[0],a=i[1],f=s[0],l=s[1],c=o[9],h=o[10],p=o[6],d=u-c,v=a-h,m=f*f+l*l,g=2*(d*f+v*l),y=d*d+v*v-p*p,b=g*g-4*m*y;if(b<0)return undefined;var w=1,E=1/(2*m),S=Math.sqrt(b),x=(-g-S)*E;if(x<0){if(r)return undefined;x+=S*2*E,w=-1}if(0<=x&&x<t.maxFactor){var T=u+f*x-c,N=a+l*x-h,C=w/p;return n[0]=T*C,n[1]=N*C,x}return undefined},e.prototype._contains=function(e,t,n){return e._type===0?this._containsCircle(e,t,n):this._containsPolygon(e,t,n)},e.prototype._containsCircle=function(e,t,n){var r=e._data,i=r[9]-t,s=r[10]-n,o=r[6];return i*i+s*s-o*o<=b.CONTAINS_SQ_EPSILON},e.prototype._containsPolygon=function(e,t,n){var r=e._data,i=6,s=r.length,o=b.CONTAINS_EPSILON;for(;i<s;i+=13){var u=r[i+6]*t+r[i+6+1]*n-r[i+9];if(u>o)return!1}return!0},e.prototype._dynamicSweep=function(e,t,n,r){var i=e.shapeA,s=e.shapeB,o=i.body,u=s.body,a=o._data,f=u._data,l=f[7]-a[7],c=f[8]-a[8],h=a[20],p=f[20],d=i._data[5]*(h<0?-h:h)+s._data[5]*(p<0?-p:p);if(!r&&l*l+c*c<b.EQUAL_SQ_VEL&&d<b.ZERO_ANG_BIAS){e._data[6]=undefined,e.failed=!0;return}var v=0,m=0,g=e._data,y=b.SWEEP_LIMIT,w=y*.5,E=b.MINIMUM_SWEEP_ADVANCE,S=b.MAX_SWEEP_ITER;for(;;){o._sweepIntegrate(v*t),u._sweepIntegrate(v*t);var x=a[2],T=a[3];i._update(x,T,a[5],a[6],!0),x=f[2],T=f[3],s._update(x,T,f[5],f[6],!0);var N=this._distance(i,s,g)+n,C=g[0],k=g[1],L=C*l+k*c;if(N<y){if(r)break;var A=g[2]-x,O=g[3]-T,M=L-h*(A*k-O*C);M>0&&(e.slipped=!0);if(M<=0||N<w)break}var _=(d-L)*t;if(_<=0){v=-1;break}var D=N/_;D<E&&(D=E),v+=D;if(v>=1){v=-1;break}m+=1;if(m>=S){N>n?e.failed=!0:r&&(v=-1);break}}return g[6]=v,v},e.prototype._staticSweep=function(e,t,n){var r=e.shapeA,i=e.shapeB,s=r.body,o=s._data,u=-o[7],a=-o[8],f=o[20],l=r._data[5]*(f<0?-f:f),c=0,h=0,p=e._data,d=b.SWEEP_LIMIT,v=d*.5,m=b.MINIMUM_SWEEP_ADVANCE,g=b.MAX_SWEEP_ITER;for(;;){s._sweepIntegrate(c*t);var y=o[2],w=o[3];r._update(y,w,o[5],o[6],!0);var E=this._distance(r,i,p)+n,S=p[0],x=p[1],T=S*u+x*a;if(E<d){var N=p[2]-y,C=p[3]-w,k=T-f*(N*x-C*S);k>0&&(e.slipped=!0);if(k<=0||E<v)break}var L=(l-T)*t;if(L<=0){c=-1;break}var A=E/L;A<m&&(A=m),c+=A;if(c>=1){c=-1;break}h+=1;if(h>=g){E>n&&(e.failed=!0);break}}return p[6]=c,c},e.prototype._distance=function(e,t,n){if(e._type===0)return t._type===0?this._distanceCircle2Circle(e,t,n):this._distanceCircle2Polygon(e,t,n);if(t._type===0){var r=this._distanceCircle2Polygon(t,e,n);n[0]=-n[0],n[1]=-n[1];var i=n[2];return n[2]=n[4],n[4]=i,i=n[3],n[3]=n[5],n[5]=i,r}return this._distancePolygon2Polygon(e,t,n)},e.prototype._distanceCircle2Circle=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=i[9],a=i[10],f=r[6],l=i[6],c=u-s,h=a-o,p=f+l,d=Math.sqrt(c*c+h*h);if(d===0)n[0]=c=1,n[1]=h=0;else{var v=1/d;n[0]=c*=v,n[1]=h*=v}return n[2]=s+c*f,n[3]=o+h*f,n[4]=u-c*l,n[5]=a-h*l,d-p},e.prototype._distanceCircle2Polygon=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=r[6],a=Number.NEGATIVE_INFINITY,f,l,c=6,h=i.length;for(;c<h;c+=13){l=i[c+6]*s+i[c+6+1]*o;var p=l-(u+i[c+9]);p>a&&(a=p,f=c)}var d=i[f+6],v=i[f+6+1];l=d*o-v*s;if(l>=i[f+10]){if(l<=i[f+11])return n[0]=-d,n[1]=-v,n[2]=s-=d*u,n[3]=o-=v*u,n[4]=s-d*a,n[5]=o-v*a,a;f+=13,f===h&&(f=6)}var m=i[f+2],g=i[f+2+1],y=m-s,b=g-o,w=Math.sqrt(y*y+b*b);if(w===0)n[0]=y=-d,n[1]=b=-v;else{var E=1/w;n[0]=y*=E,n[1]=b*=E}return n[2]=s+y*u,n[3]=o+b*u,n[4]=m,n[5]=g,w-u},e.prototype._distancePolygon2Polygon=function(e,t,n){var r=Number.POSITIVE_INFINITY,i=e._data,s=t._data,o=i.length,u=s.length,a,f,l,c,h,p,d=-r,v,m;for(a=6;a<o;a+=13){l=r,h=i[a+6],p=i[a+6+1];for(f=6;f<u;f+=13)c=h*s[f+2]+p*s[f+2+1],c<l&&(l=c);l-=i[a+9],l>d&&(d=l,m=a,v=!0)}for(f=6;f<u;f+=13){l=r,h=s[f+6],p=s[f+6+1];for(a=6;a<o;a+=13)c=h*i[a+2]+p*i[a+2+1],c<l&&(l=c);l-=s[f+9],l>d&&(d=l,m=f,v=!1)}var g=v?1:-1,y,w;v?(y=2,w=4):(i=t._data,s=e._data,o=i.length,u=s.length,y=4,w=2),h=i[m+6],p=i[m+6+1],l=r;var E;for(f=6;f<u;f+=13)c=h*s[f+6]+p*s[f+6+1],c<l&&(l=c,E=f);var S=E+13;S===u&&(S=6);var x,T,N,C,k,L,A,O,M,_=s[E+2],D=s[E+2+1],P=s[S+2],H=s[S+2+1],B=l<b.COLLINEAR_EPSILON-1;if(d<0&&B)return n[0]=h*g,n[1]=p*g,x=i[m+2],T=i[m+2+1],M=i[m+12],N=h*(D-T)-p*(_-x),N>=0&&N<=M?(n[w]=x=_,n[w+1]=T=D):(C=h*(H-T)-p*(_-x),C>=0&&C<=M?(n[w]=x=P,n[w+1]=T=H):(N<0?N=-N:N>M&&(N=M-N),n[w]=x=_-p*N,n[w+1]=T=D+h*N)),n[y]=x-h*d,n[y+1]=T-p*d,d;if(d<=0)return n[0]=h*g,n[1]=p*g,N=h*_+p*D,C=h*P+p*H,C<N&&(E=S),n[w]=x=s[E+2],n[w+1]=T=s[E+2+1],n[y]=x-h*d,n[y+1]=T-p*d,d;M=i[m+12];if(B){var j=s[E+12];if(j>M){M=j,S=m,m=E,E=S,S=E+13,S===o&&(S=6),_=i[E+2],D=i[E+2+1],P=i[S+2],H=i[S+2+1],i=s,h*=-1,p*=-1,g*=-1;var F=y;y=w,w=F}}x=i[m+2],T=i[m+2+1],N=-(h*(T-D)-p*(x-_));var I=!0;N<0?(N=0,I=!1):N>M&&(N=M,I=!1),C=-(h*(T-H)-p*(x-P));var q=!0;C<0?(C=0,q=!1):C>M&&(C=M,q=!1),k=_-(x-p*N),L=D-(T+h*N),A=P-(x-p*C),O=H-(T+h*C),N=k*k+L*L,C=A*A+O*O;var R;return N<C?(n[w]=x=_,n[w+1]=T=D,d=Math.sqrt(N),I||d<b.NORMALIZE_EPSILON?(n[0]=h*=g,n[1]=p*=g):(R=g/d,n[0]=h=k*R,n[1]=p=L*R)):(n[w]=x=P,n[w+1]=T=H,d=Math.sqrt(C),q||d<b.NORMALIZE_EPSILON?(n[0]=h*=g,n[1]=p*=g):(R=g/d,n[0]=h=A*R,n[1]=p=O*R)),n[y]=x-h*d*g,n[y+1]=T-p*d*g,d},e.prototype._collide=function(e,t,n){return e._type===0?t._type===0?this._collideCircle2Circle(e,t,n):this._collideCircle2Polygon(e,t,n,!1):t._type===0?this._collideCircle2Polygon(t,e,n,!0):this._collidePolygon2Polygon(e,t,n)},e.prototype._collideCircle2Polygon=function(e,t,n,r){var i=e._data,s=t._data,o=i[9],u=i[10],a=i[6],f=Number.NEGATIVE_INFINITY,l,c,h=6,p=s.length;for(;h<p;h+=13){c=s[h+6]*o+s[h+6+1]*u-(s[h+9]+a);if(c>0)return!1;c>f&&(f=c,l=h)}var d=n._data,v,m,g=s[l+6],y=s[l+6+1],w,E,S,x,T,N;c=g*u-y*o;if(c>=s[l+10]){if(c<=s[l+11])return c=a+f*.5,T=g*c,N=y*c,v=n._injectContact(o-T,u-N,r?g:-g,r?y:-y,f,0),n._faceType=r?1:2,n._reverse=!r,d[11]=s[l+4],d[12]=s[l+4+1],d[13]=s[l+8],d[14]=a,m=v._data,m[13]=i[7],m[14]=i[8],!0;var C=l+13;C===p&&(C=6),w=s[C+2],E=s[C+2+1],S=s[C+0],x=s[C+0+1]}else w=s[l+2],E=s[l+2+1],S=s[l+0],x=s[l+0+1];T=o-w,N=u-E;var k=T*T+N*N;if(k>a*a)return!1;if(k<b.NORMALIZE_SQ_EPSILON)v=n._injectContact(o,u,r?g:-g,r?y:-y,0,0);else{var L=Math.sqrt(k),A=1/L,O=.5+a*A*.5;r||(A=-A),v=n._injectContact(o-T*O,u-N*O,T*A,N*A,L-a,0)}return m=v._data,r?(m[13]=S,m[14]=x,m[15]=i[7],m[16]=i[8]):(m[13]=i[7],m[14]=i[8],m[15]=S,m[16]=x),d[14]=a,n._faceType=0,n._reverse=!1,!0},e.prototype._collidePolygon2Polygon=function(e,t,n){var r=Number.POSITIVE_INFINITY,i=e._data,s=t._data,o=i.length,u=s.length,a,f,l,c,h,p,d=-r,v,m,g;for(a=6;a<o;a+=13){l=r,h=i[a+6],p=i[a+6+1],g=i[a+9];for(f=6;f<u;f+=13){c=h*s[f+2]+p*s[f+2+1],c<l&&(l=c);if(l-g<=d)break}l-=g;if(l>=0)return!1;l>d&&(d=l,m=a,v=!0)}for(f=6;f<u;f+=13){l=r,h=s[f+6],p=s[f+6+1],g=s[f+9];for(a=6;a<o;a+=13){c=h*i[a+2]+p*i[a+2+1],c<l&&(l=c);if(l-g<=d)break}l-=g;if(l>=0)return!1;l>d&&(d=l,m=f,v=!1)}var y=v?1:-1,w;v?w=t.body._data:(i=t._data,s=e._data,o=i.length,u=s.length,w=e.body._data),h=i[m+6],p=i[m+6+1],l=r;var E;for(f=6;f<u;f+=13)c=h*s[f+6]+p*s[f+6+1],c<l&&(l=c,E=f);var S=E+13;S===u&&(S=6);var x=s[E+2],T=s[E+2+1],N=s[S+2],C=s[S+2+1],k=N-x,L=C-T,A=x*p-T*h,O=N*p-C*h,M=1/(O-A),_=(-i[m+11]-A)*M;_>b.CLIP_EPSILON&&(x+=k*_,T+=L*_),_=(-i[m+10]-O)*M,_<-b.CLIP_EPSILON&&(N+=k*_,C+=L*_);var D=n._data;D[11]=i[m+4],D[12]=i[m+4+1],D[13]=i[m+8],D[14]=0,n._faceType=v?1:2,g=i[m+9];var P=x*h+T*p-g,H=N*h+C*p-g,B=w[2],j=w[3],F=w[5],I=w[6];if(P>0&&H>0)return!1;var q=x-B,R=T-j;x-=h*P*.5,T-=p*P*.5;var U=n._injectContact(x,T,h*y,p*y,P,v?1:2,P>0)._data;return U[13]=F*q+I*R,U[14]=F*R-I*q,q=N-B,R=C-j,N-=h*H*.5,C-=p*H*.5,U=n._injectContact(N,C,h*y,p*y,H,v?2:1,H>0)._data,U[13]=F*q+I*R,U[14]=F*R-I*q,n._reverse=!v,!0},e.prototype._collideCircle2Circle=function(e,t,n){var r=e._data,i=t._data,s=r[9],o=r[10],u=r[6],a=i[9]-s,f=i[10]-o,l=u+i[6],c=a*a+f*f;if(c>l*l)return!1;var h;if(c<b.NORMALIZE_SQ_EPSILON)h=n._injectContact(s+a*.5,o+f*.5,1,0,-l,0);else{var p=Math.sqrt(c),d=1/p,v=.5+(u-.5*l)*d;h=n._injectContact(s+a*v,o+f*v,a*d,f*d,p-l,0)}var m=h._data;return m[13]=r[7],m[14]=r[8],m[15]=i[7],m[16]=i[8],m=n._data,m[14]=l,n._faceType=0,!0},e.prototype._test=function(e,t){return e._type===0?t._type===0?this._testCircle2Circle(e,t):this._testCircle2Polygon(e,t):t._type===0?this._testCircle2Polygon(t,e):this._testPolygon2Polygon(e,t)},e.prototype._testCircle2Circle=function(e,t){var n=e._data,r=t._data,i=n[9]-r[9],s=n[10]-r[10],o=n[6]+r[6];return i*i+s*s<=o*o},e.prototype._testCircle2Polygon=function(e,t){var n=e._data,r=t._data,i=n[9],s=n[10],o=n[6],u=Number.NEGATIVE_INFINITY,a,f,l=6,c=r.length;for(;l<c;l+=13){f=r[l+6]*i+r[l+6+1]*s;var h=f-(o+r[l+9]);if(h>0)return!1;h>u&&(u=h,a=l)}f=r[a+6]*s-r[a+6+1]*i;if(f>=r[a+10]){if(f<=r[a+11])return!0;a+=13,a===c&&(a=6)}var p=i-r[a+2],d=s-r[a+2+1];return p*p+d*d<=o*o},e.prototype._testPolygon2Polygon=function(e,t){var n=Number.POSITIVE_INFINITY,r=e._data,i=t._data,s=r.length,o=i.length,u,a,f,l,c,h;for(u=6;u<s;u+=13){f=n,c=r[u+6],h=r[u+6+1];for(a=6;a<o;a+=13)l=c*i[a+2]+h*i[a+2+1],l<f&&(f=l);if(f>r[u+9])return!1}for(a=6;a<o;a+=13){f=n,c=i[a+6],h=i[a+6+1];for(u=6;u<s;u+=13)l=c*r[u+2]+h*r[u+2+1],l<f&&(f=l);if(f>i[a+9])return!1}return!0},e.create=function(){var t=new e;return t._toi=B.allocate(),t},e}(),X=function(){function e(){this.vendor="Turbulenz"}return e.prototype.getDefaultMaterial=function(){return w.defaultMaterial},e.prototype.createCircleShape=function(e){return M.create(e)},e.prototype.createPolygonShape=function(e){return _.create(e,null)},e.prototype.createRigidBody=function(e){return D.create(e)},e.prototype.createWorld=function(e){return z.create(e)},e.prototype.createMaterial=function(e){return w.create(e)},e.prototype.createSweepAndPruneBroadphase=function(){return q.create()},e.prototype.createBoxTreeBroadphase=function(){return F.create()},e.prototype.createCollisionUtils=function(){return W.create()},e.prototype.createPointConstraint=function(e){return A.create(e)},e.prototype.createWeldConstraint=function(e){return L.create(e)},e.prototype.createAngleConstraint=function(e){return k.create(e)},e.prototype.createDistanceConstraint=function(e){return C.create(e)},e.prototype.createLineConstraint=function(e){return N.create(e)},e.prototype.createMotorConstraint=function(e){return T.create(e)},e.prototype.createPulleyConstraint=function(e){return x.create(e)},e.prototype.createCustomConstraint=function(e){return S.create(e)},e.prototype.createRectangleVertices=function(t,n,r,i){var s;r<t&&(s=t,t=r,r=s),i<n&&(s=n,n=i,i=s);var o=new e.prototype.floatArray(2);o[0]=t,o[1]=n;var u=new e.prototype.floatArray(2);u[0]=r,u[1]=n;var a=new e.prototype.floatArray(2);a[0]=r,a[1]=i;var f=new e.prototype.floatArray(2);return f[0]=t,f[1]=i,[o,u,a,f]},e.prototype.createBoxVertices=function(t,n){var r=t*.5,i=n*.5,s=new e.prototype.floatArray(2);s[0]=-r,s[1]=-i;var o=new e.prototype.floatArray(2);o[0]=r,o[1]=-i;var u=new e.prototype.floatArray(2);u[0]=r,u[1]=i;var a=new e.prototype.floatArray(2);return a[0]=-r,a[1]=i,[s,o,u,a]},e.prototype.createRegularPolygonVertices=function(t,n,r){var i=t*.5,s=n*.5,o=[],u=r,a=Math.PI*2/u,f;for(f=0;f<u;f+=1){var l=a*f,c=o[o.length]=new e.prototype.floatArray(2);c[0]=i*Math.cos(l),c[1]=s*Math.sin(l)}return o},e.create=function(){var t=new e;return t},e.version=1,e}();(function(){X.prototype.floatArray=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n},X.prototype.uint16Array=X.prototype.floatArray;var e,t;typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(X.prototype.floatArray=Float32Array)),typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(X.prototype.uint16Array=Uint16Array))})(),w.defaultMaterial=w.create();var V=function(){function e(){}return e.create=function(){var t=new e;return t.indices=[],t.textures=[],t.numSets=0,t.vertexBufferData=new K.floatArray(1024),t.numVertices=0,t},e}(),$=function(){function e(){}return e.prototype.getTextureRectangle=function(e){e===undefined&&(e=new K.floatArray(4));var t=this.data,n=this._texture;return n?(e[0]=t[12]*n.width,e[1]=t[13]*n.height,e[2]=t[14]*n.width,e[3]=t[15]*n.height):(e[0]=t[12],e[1]=t[13],e[2]=t[14],e[3]=t[15]),e},e.prototype.setTextureRectangle=function(e){var t=this.data,n=this._texture;if(n){var r=1/n.width,i=1/n.height;t[12]=e[0]*r,t[13]=e[1]*i,t[14]=e[2]*r,t[15]=e[3]*i}else t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=e[3]},e.prototype.getColor=function(e){e===undefined&&(e=new K.floatArray(4));var t=this.data;return e[0]=t[8],e[1]=t[9],e[2]=t[10],e[3]=t[11],e},e.prototype.setColor=function(e){var t=this.data;t[8]=e[0],t[9]=e[1],t[10]=e[2],t[11]=e[3]},e.prototype.getTexture=function(){return this._texture},e.prototype.setTexture=function(e){if(this._texture!==e){var t=(this._texture?this._texture.width:1)/(e?e.width:1),n=(this._texture?this._texture.height:1)/(e?e.height:1);this._texture=e||null;var r=this.data;r[12]*=t,r[13]*=n,r[14]*=t,r[15]*=n}},e.prototype.getWidth=function(){return this.data[17]*2},e.prototype.setWidth=function(e){e*=.5;var t=this.data;t[17]!==e&&(t[23]=t[23]*e/t[17],t[17]=e,this._invalidate())},e.prototype.getHeight=function(){return this.data[18]*2},e.prototype.setHeight=function(e){e*=.5;var t=this.data;t[18]!==e&&(t[24]=t[24]*e/t[18],t[18]=e,this._invalidate())},e.prototype.getScale=function(e){e===undefined&&(e=new K.floatArray(2));var t=this.data;return e[0]=t[19],e[1]=t[20],e},e.prototype.setScale=function(e){var t=e[0],n=e[1],r=this.data;if(r[19]!==t||r[20]!==n)r[19]=t,r[20]=n,this._invalidate()},e.prototype.getShear=function(e){e===undefined&&(e=new K.floatArray(2));var t=this.data;return e[0]=t[21],e[1]=t[22],e},e.prototype.setShear=function(e){var t=e[0],n=e[1],r=this.data;if(r[21]!==t||r[22]!==n)r[21]=t,r[22]=n,this._invalidate()},e.prototype.getOrigin=function(e){e===undefined&&(e=new K.floatArray(2));var t=this.data;return e[0]=t[23],e[1]=t[24],e},e.prototype.setOrigin=function(e){var t=e[0],n=e[1],r=this.data;if(r[23]!==t||r[24]!==n)r[23]=t,r[24]=n,this._invalidate()},e.prototype._invalidate=function(){var e=this.data,t=e[19],n=e[19]*e[21],r=e[20]*e[22],i=e[20],s=e[17]-e[23],o=e[18]-e[24],u=e[25]=t*s+n*o,a=e[26]=r*s+i*o;s=-e[17],o=-e[18];var f=e[27]=t*s+n*o,l=e[28]=r*s+i*o;s=-s;var c=e[29]=t*s+n*o,h=e[30]=r*s+i*o,p=e[16]=this.rotation,d=Math.cos(p),v=Math.sin(p);e[31]=d*u-v*a,e[32]=v*u+d*a,e[33]=d*f-v*l,e[34]=v*f+d*l,e[35]=d*c-v*h,e[36]=v*c+d*h;var m=2*(u*f+a*l);m<0&&(m=-m);var g=f*f+l*l+m;m=2*(u*c+a*h),m<0&&(m=-m);var y=c*c+h*h+m;y>g&&(g=y),g+=u*u+a*a,e[37]=.25/g},e.prototype._update=function(e){var t=this.data,n,r,i,s;n=this.rotation,r=n-t[16],r*r>t[37]*e&&(t[16]=n,i=Math.cos(n),s=Math.sin(n),n=t[25],r=t[26],t[31]=i*n-s*r,t[32]=s*n+i*r,n=t[27],r=t[28],t[33]=i*n-s*r,t[34]=s*n+i*r,n=t[29],r=t[30],t[35]=i*n-s*r,t[36]=s*n+i*r),i=this.x+t[31],s=this.y+t[32],n=t[33],r=t[34],t[0]=i+n,t[1]=s+r,t[6]=i-n,t[7]=s-r,n=t[35],r=t[36],t[2]=i+n,t[3]=s+r,t[4]=i-n,t[5]=s-r},e.create=function(t){if(t.width!==undefined&&t.height!==undefined||!!t.texture){var n=new e,r=n.data=new K.floatArray(38),i=n._texture=t.texture||null;if(i)if(0!==(i.width&i.width-1)||0!==(i.height&i.height-1))return null;n.x=t.x||0,n.y=t.y||0,n.rotation=r[16]=t.rotation||0;var s=t.color;r[8]=s?s[0]:1,r[9]=s?s[1]:1,r[10]=s?s[2]:1,r[11]=s?s[3]:1;var o=t.textureRectangle,u=i?1/i.width:1,a=i?1/i.height:1;r[12]=o?o[0]*u:0,r[13]=o?o[1]*a:0,r[14]=o?o[2]*u:1,r[15]=o?o[3]*a:1,r[17]=(t.width!==
undefined?t.width:i.width)*.5,r[18]=(t.height!==undefined?t.height:i.height)*.5;var f=t.scale;r[19]=f?f[0]:1,r[20]=f?f[1]:1;var l=t.shear;r[21]=l?l[0]:0,r[22]=l?l[1]:0;var c=t.origin;return r[23]=c?c[0]:r[17],r[24]=c?c[1]:r[18],n._invalidate(),n}return null},e.version=1,e}(),J={setFromRotatedRectangle:function(t,n,r,i,s,o,u){var a=r[0],f=r[1],l=r[2],c=r[3];if(!o)t[0]=a,t[1]=f,t[2]=l,t[3]=f,t[4]=a,t[5]=c,t[6]=l,t[7]=c;else{var h,p;u?(h=a+u[0],p=f+u[1]):(h=.5*(a+l),p=.5*(f+c));var d=a-h,v=f-p,m=Math.cos(o),g=Math.sin(o),y=l-a,b=c-f;t[0]=a=h+(m*d-g*v),t[1]=f=p+(g*d+m*v),t[2]=a+m*y,t[3]=f+g*y,t[4]=a-g*b,t[5]=f+m*b,t[6]=a+(m*y-g*b),t[7]=f+(g*y+m*b)}s?(t[8]=s[0],t[9]=s[1],t[10]=s[2],t[11]=s[3]):t[8]=t[9]=t[10]=t[11]=1;if(i&&n){var w=1/n.width,E=1/n.height;t[12]=i[0]*w,t[13]=i[1]*E,t[14]=i[2]*w,t[15]=i[3]*E}else t[12]=t[13]=0,t[14]=t[15]=1},create:function(){return new K.floatArray(16)}},K=function(){function e(){this.forceUpdate=!1,this.clearBackBuffer=!1,this.defaultClearColor=e.defaultClearColor,this.sort={deferred:"deferred",immediate:"immediate",texture:"texture"},this.scale={scale:"scale",none:"none"},this.blend={additive:"additive",alpha:"alpha",opaque:"opaque"},this.drawStates={uninit:0,ready:1,draw:2}}return e.prototype.clear=function(e){if(this.state!==this.drawStates.ready)return!1;var t=this.graphicsDevice;if(this.currentRenderTarget){if(!t.beginRenderTarget(this.currentRenderTarget.renderTarget))return!1;t.clear(e||this.defaultClearColor),t.endRenderTarget()}else t.clear(e||this.defaultClearColor);return!0},e.prototype.clearBatch=function(){var e=this.texLists;for(var t in e)e.hasOwnProperty(t)&&(e[t]=undefined);this.currentTextureGroup=undefined,this.numGroups=0},e.prototype.bufferSprite=function(e,t,n){t._update(0),n<<=4;var r=t.data;e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3],e[n+4]=r[4],e[n+5]=r[5],e[n+6]=r[6],e[n+7]=r[7],e[n+8]=r[8],e[n+9]=r[9],e[n+10]=r[10],e[n+11]=r[11],e[n+12]=r[12],e[n+13]=r[13],e[n+14]=r[14],e[n+15]=r[15]},e.prototype.update=function(){var e=this.graphicsDevice,t=this.width,n=this.height,r=e.width,i=e.height;if(t!==r||n!==i||this.forceUpdate){var s,o,u,a,f=this.viewportRectangle;f?(u=f[0],a=f[1],s=f[2]-u,o=f[3]-a):(u=0,a=0,s=r,o=i),s===r&&o===i?this.clearBackBuffer=!1:this.clearBackBuffer=!0;var l=this.currentRenderTarget;if(this.scaleMode==="scale"){var c=s/o,h=r/i,p,d,v,m,g,y;h>c?(p=Math.ceil(i/o*s),v=r-p,g=Math.floor(v*.5),this.scissorX=g,this.scissorY=0,this.scissorWidth=p,this.scissorHeight=i,this.viewScaleX=s/p,this.viewScaleY=o/i,l||(this.clipOffsetX=g/r*2-1,this.clipOffsetY=1,this.clipScaleX=p/r*2/s,this.clipScaleY=-2/o)):(d=Math.ceil(r/s*o),m=i-d,y=Math.floor(m*.5),this.scissorX=0,this.scissorY=y,this.scissorWidth=r,this.scissorHeight=d,this.viewScaleX=s/r,this.viewScaleY=o/d,l||(this.clipOffsetX=-1,this.clipOffsetY=1-y/i*2,this.clipScaleX=2/s,this.clipScaleY=d/i*-2/o))}else this.viewScaleX=1,this.viewScaleY=1,l||(this.clipOffsetX=-1,this.clipOffsetY=1,this.clipScaleX=2/r,this.clipScaleY=-2/i),this.scissorX=0,this.scissorY=i-o,this.scissorWidth=s,this.scissorHeight=o;this.spriteAngleFactor=Math.min(this.viewScaleX,this.viewScaleY),this.spriteAngleFactor*=this.spriteAngleFactor,this.width=r,this.height=i;var b=0,w=this.renderTargetStructs,E=w.length;for(b=0;b<E;b+=1)this.validateTarget(w[b],this.scissorWidth,this.scissorHeight);l&&(this.clipOffsetX=-1,this.clipOffsetY=-1,this.clipScaleX=2*l.actualWidth/l.texture.width/s,this.clipScaleY=2*l.actualHeight/l.texture.height/o),this.clipOffsetX-=u*this.clipScaleX,this.clipOffsetY-=a*this.clipScaleY;var S=this.techniqueParameters.clipSpace;S[0]=this.clipScaleX,S[1]=this.clipScaleY,S[2]=this.clipOffsetX,S[3]=this.clipOffsetY,this.updateRenderTargetVbo(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight),this.forceUpdate=!1}},e.prototype.getViewport=function(t){t||(t=new e.floatArray(4));var n=this.viewportRectangle;return n?(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]):(t[0]=t[1]=0,t[2]=this.graphicsDevice.width,t[3]=this.graphicsDevice.height),t},e.prototype.getScreenSpaceViewport=function(t){return t||(t=new e.floatArray(4)),this.update(),t[0]=this.scissorX,t[1]=this.height-(this.scissorY+this.scissorHeight),t[2]=t[0]+this.scissorWidth,t[3]=t[1]+this.scissorHeight,t},e.prototype.viewportMap=function(t,n,r){r||(r=new e.floatArray(2)),this.update();var i=this.height-this.scissorHeight-this.scissorY;r[0]=(t-this.scissorX)*this.viewScaleX,r[1]=(n-i)*this.viewScaleY;var s=this.viewportRectangle;return s&&(r[0]+=s[0],r[1]+=s[1]),r},e.prototype.viewportUnmap=function(t,n,r){r||(r=new e.floatArray(2)),this.update();var i=this.viewportRectangle;i&&(t-=i[0],n-=i[1]);var s=this.height-this.scissorHeight-this.scissorY;return r[0]=t/this.viewScaleX+this.scissorX,r[1]=n/this.viewScaleY+s,r},e.prototype.viewportClamp=function(e){if(e){var t=e[0],n=e[1],r,i,s,o,u=this.viewportRectangle;u?(r=u[0],i=u[1],s=u[2],o=u[3]):(r=0,i=0,s=this.graphicsDevice.width,o=this.graphicsDevice.height),t<r?t=r:t>s&&(t=s),n<i?n=i:n>o&&(n=o),e[0]=t,e[1]=n}return e},e.prototype.configure=function(e){if(this.state!==this.drawStates.ready)return!1;var t="viewportRectangle"in e?e.viewportRectangle:this.viewportRectangle,n=e.scaleMode;if(n!==undefined){if(!(n in this.scale))return!1;if(n==="scale"&&!t)return!1;this.scaleMode=n}return this.viewportRectangle=t,this.forceUpdate=!0,this.update(),!0},e.prototype.destroy=function(){this.texLists=null,this.state=this.drawStates.uninit,this.graphicsDevice=null,this.vertexBuffer&&this.vertexBuffer.destroy(),this.indexBuffer&&this.indexBuffer.destroy(),this.copyVertexBuffer.destroy();var e=this.renderTargetStructs;while(e.length>0){var t=e.pop();t.texture.destroy(),t.renderTarget.destroy(),t.texture=null,t.renderTarget=null}},e.prototype.begin=function(e,t){if(!t||t in this.sort){if(!e||e in this.blend){var n=!this.sortMode;this.dispatch()&&this.clearBatch();if(n){if(this.state!==this.drawStates.ready)return!1;this.update(),this.currentRenderTarget||this.graphicsDevice.setScissor(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight)}return this.state=this.drawStates.draw,t=t?t:n?"deferred":this.sortMode,e=e?e:n?"opaque":this.blendMode,n||(this.sortModeStack.push(this.sortMode),this.blendModeStack.push(this.blendMode)),this.sortMode=t,this.blendMode=e,this.prepareSortMode(t),this.graphicsDevice.setTechnique(this.blendModeTechniques[e]),!0}return!1}return!1},e.prototype._bufferSprite=function(t,n){var r=t.vertexBufferData,i=this.vertexBuffer,s=t.numVertices*i.stride,o=s+4*i.stride;if(o>=r.length){var u=this.bufferSizeAlgorithm(o,this.cpuStride),a=new e.floatArray(u),f;for(f=0;f<s;f+=1)a[f]=r[f];t.vertexBufferData=r=a}var l=n[8],c=n[9],h=n[10],p=n[11],d=n[12],v=n[13],m=n[14],g=n[15];r[s]=n[0],r[s+1]=n[1],r[s+2]=l,r[s+3]=c,r[s+4]=h,r[s+5]=p,r[s+6]=d,r[s+7]=v,r[s+8]=n[2],r[s+9]=n[3],r[s+10]=l,r[s+11]=c,r[s+12]=h,r[s+13]=p,r[s+14]=m,r[s+15]=v,r[s+16]=n[4],r[s+17]=n[5],r[s+18]=l,r[s+19]=c,r[s+20]=h,r[s+21]=p,r[s+22]=d,r[s+23]=g,r[s+24]=n[6],r[s+25]=n[7],r[s+26]=l,r[s+27]=c,r[s+28]=h,r[s+29]=p,r[s+30]=m,r[s+31]=g,t.numVertices+=4,t.indices[t.numSets-1]+=6},e.prototype.bufferMultiSprite=function(t,n,r,i){var s=t.vertexBufferData,o=this.vertexBuffer,u=r===undefined?Math.floor(n.length/16):r;r=u*16,i=(i!==undefined?i:0)*16;var a,f=t.numVertices*o.stride,l=f+u*4*o.stride;if(l>=s.length){var c=this.bufferSizeAlgorithm(l,this.cpuStride),h=new e.floatArray(c);for(a=0;a<f;a+=1)h[a]=s[a];t.vertexBufferData=s=h}var p=i+r;for(a=i;a<p;a+=16){var d=n[a+8],v=n[a+9],m=n[a+10],g=n[a+11],y=n[a+12],b=n[a+13],w=n[a+14],E=n[a+15];s[f]=n[a],s[f+1]=n[a+1],s[f+2]=d,s[f+3]=v,s[f+4]=m,s[f+5]=g,s[f+6]=y,s[f+7]=b,s[f+8]=n[a+2],s[f+9]=n[a+3],s[f+10]=d,s[f+11]=v,s[f+12]=m,s[f+13]=g,s[f+14]=w,s[f+15]=b,s[f+16]=n[a+4],s[f+17]=n[a+5],s[f+18]=d,s[f+19]=v,s[f+20]=m,s[f+21]=g,s[f+22]=y,s[f+23]=E,s[f+24]=n[a+6],s[f+25]=n[a+7],s[f+26]=d,s[f+27]=v,s[f+28]=m,s[f+29]=g,s[f+30]=w,s[f+31]=E,f+=32}t.numVertices+=u*4,t.indices[t.numSets-1]+=u*6},e.prototype.indexData=function(t){var n=new e.uint16Array(t),r,i=0;for(r=0;r<t;r+=6)n[r]=i,n[r+1]=i+1,n[r+2]=i+2,n[r+3]=i+1,n[r+4]=i+2,n[r+5]=i+3,i+=4;return n},e.prototype.uploadBuffer=function(e,t,n){var r=this.vertexBuffer,i=this.vertexBufferParameters,s=this.graphicsDevice,o=e.vertexBufferData,u=this.performanceData;if(t>i.numVertices){var a=this.bufferSizeAlgorithm(t,this.gpuStride);a>this.maxVertices&&(a=this.maxVertices),i.numVertices=a,this.vertexBuffer.destroy(),this.vertexBuffer=r=s.createVertexBuffer(i),u.gpuMemoryUsage=a*35,a*=1.5;var f=this.indexBufferParameters;f.data=this.indexData(a),f.numIndices=a,this.indexBuffer.destroy(),this.indexBuffer=s.createIndexBuffer(f),f.data=null,s.setIndexBuffer(this.indexBuffer)}u.dataTransfers+=1;if(n===0)r.setData(o,0,t);else{var l=r.stride;r.setData(o.subarray(n*l,(n+t)*l),0,t)}},e.prototype.drawRawImmediate=function(e,t,n,r){var i=this.drawGroups[0];i.textures[0]=e||this.defaultTexture,i.indices[0]=0,i.numSets=1,this.numGroups=1,this.bufferMultiSprite(i,t,n,r),this.dispatch()},e.prototype.drawSpriteImmediate=function(e){var t=this.drawGroups[0];t.textures[0]=e._texture||this.defaultTexture,t.indices[0]=0,t.numSets=1,this.numGroups=1,e._update(this.spriteAngleFactor),this._bufferSprite(t,e.data),this.dispatch()},e.prototype.drawImmediate=function(e){var t=e.texture||this.defaultTexture,n=e.destinationRectangle,r=e.sourceRectangle,i=e.color,s=e.rotation,o=this.drawGroups[0];o.textures[0]=t,o.indices[0]=0,o.numSets=1,this.numGroups=1;var u=this.drawSprite;J.setFromRotatedRectangle(u,t,n,r,i,s,e.origin),this._bufferSprite(o,u),this.dispatch()},e.prototype.drawRawDeferred=function(e,t,n,r){e=e||this.defaultTexture;var i=this.drawGroups[0];this.numGroups=1;var s=i.numSets;if(s===0||i.textures[s-1]!==e)i.textures[s]=e,i.indices[s]=0,i.numSets+=1;this.bufferMultiSprite(i,t,n,r)},e.prototype.drawSpriteDeferred=function(e){var t=e._texture||this.defaultTexture,n=this.drawGroups[0];this.numGroups=1;var r=n.numSets;if(r===0||n.textures[r-1]!==t)n.textures[r]=t,n.indices[r]=0,n.numSets+=1;e._update(this.spriteAngleFactor),this._bufferSprite(n,e.data)},e.prototype.drawDeferred=function(e){var t=e.texture||this.defaultTexture,n=this.drawGroups[0];this.numGroups=1;var r=n.numSets;if(r===0||n.textures[r-1]!==t)n.textures[r]=t,n.indices[r]=0,n.numSets+=1;var i=e.destinationRectangle,s=e.sourceRectangle,o=e.color,u=e.rotation,a=this.drawSprite;J.setFromRotatedRectangle(a,t,i,s,o,u,e.origin),this._bufferSprite(n,a)},e.prototype.drawRawTextured=function(e,t,n,r){e=e||this.defaultTexture;var i;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===e)i=this.currentTextureGroup;else{var s=e.name,o=this.texLists;i=o[s],i||(i=this.drawGroups[this.numGroups],i||(i=V.create()),this.drawGroups[this.numGroups]=o[s]=i,i.textures[0]=e,i.indices[0]=0,i.numSets=1,this.numGroups+=1),this.currentTextureGroup=i}this.bufferMultiSprite(i,t,n,r)},e.prototype.drawSpriteTextured=function(e){var t=e._texture||this.defaultTexture,n;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===t)n=this.currentTextureGroup;else{var r=t.name,i=this.texLists;n=i[r],n||(n=this.drawGroups[this.numGroups],n||(n=V.create()),this.drawGroups[this.numGroups]=i[r]=n,n.textures[0]=t,n.indices[0]=0,n.numSets=1,this.numGroups+=1),this.currentTextureGroup=n}e._update(this.spriteAngleFactor),this._bufferSprite(n,e.data)},e.prototype.drawTextured=function(e){var t=e.texture||this.defaultTexture,n;if(this.currentTextureGroup!==undefined&&this.currentTextureGroup.textures[0]===t)n=this.currentTextureGroup;else{var r=t.name,i=this.texLists;n=i[r],n||(n=this.drawGroups[this.numGroups],n||(n=V.create()),this.drawGroups[this.numGroups]=i[r]=n,n.textures[0]=t,n.indices[0]=0,n.numSets=1,this.numGroups+=1),this.currentTextureGroup=n}var s=e.destinationRectangle,o=e.sourceRectangle,u=e.color,a=e.rotation,f=this.drawSprite;J.setFromRotatedRectangle(f,t,s,o,u,a,e.origin),this._bufferSprite(n,f)},e.prototype.prepareSortMode=function(e){e==="deferred"?(this.draw=this.drawDeferred,this.drawSprite=this.drawSpriteDeferred,this.drawRaw=this.drawRawDeferred):e==="immediate"?(this.draw=this.drawImmediate,this.drawSprite=this.drawSpriteImmediate,this.drawRaw=this.drawRawImmediate):(this.draw=this.drawTextured,this.drawSprite=this.drawSpriteTextured,this.drawRaw=this.drawRawTextured)},e.prototype.end=function(){return this.state!==this.drawStates.draw?!1:(this.dispatch()&&this.clearBatch(),this.blendModeStack.length!==0?(this.blendMode=this.blendModeStack.pop(),this.sortMode=this.sortModeStack.pop(),this.prepareSortMode(this.sortMode),this.graphicsDevice.setTechnique(this.blendModeTechniques[this.blendMode])):(this.blendMode=undefined,this.sortMode=undefined,this.state=this.drawStates.ready),!0)},e.prototype.dispatch=function(){var e=this.numGroups;if(e===0)return!1;var t=this.graphicsDevice,n=this.techniqueParameters;t.setIndexBuffer(this.indexBuffer);var r=this.drawGroups,i=!1;this.currentRenderTarget&&(i=t.beginRenderTarget(this.currentRenderTarget.renderTarget));var s=this.performanceData,o;for(o=0;o<e;o+=1){var u=r[o],a=u.textures,f=u.indices,l=0,c=0,h=u.numVertices;while(c<h){var p=h-c;p>this.maxVertices&&(p=this.maxVertices),this.uploadBuffer(u,p,c),t.setStream(this.vertexBuffer,this.semantics);var d=p*1.5,v=0;while(v<d){n.texture=a[l];var m=d-v;m>=f[l]?(m=f[l],l+=1):f[l]-=m;var g=m/6;s.batchCount===0?(s.minBatchSize=g,s.maxBatchSize=g,s.avgBatchSize=g,s.batchCount=1):(g<s.minBatchSize&&(s.minBatchSize=g),g>s.maxBatchSize&&(s.maxBatchSize=g),s.avgBatchSize*=s.batchCount,s.avgBatchSize+=g,s.batchCount+=1,s.avgBatchSize/=s.batchCount),t.setTechniqueParameters(n),t.drawIndexed(t.PRIMITIVE_TRIANGLES,m,v),v+=m}c+=p}u.numSets=0,u.numVertices=0}return this.currentRenderTarget&&i&&t.endRenderTarget(),!0},e.prototype.bufferSizeAlgorithm=function(e,t){var n=1.25,r=Math.ceil(Math.log(e)/Math.log(n)),i=Math.floor(Math.pow(n,r));return t*Math.ceil(i/t)},e.prototype.updateRenderTargetVbo=function(e,t,n,r){var i=this.graphicsDevice,s=.5*i.width,o=.5*i.height,u=this.copyVertexBuffer,a=(e-s)/s,f=(e+n-s)/s,l=(t-o)/o,c=(t+r-o)/o,h=this.vertexBufferData;h[0]=a,h[1]=c,h[2]=0,h[3]=1,h[4]=a,h[5]=l,h[6]=0,h[7]=0,h[8]=f,h[9]=c,h[10]=1,h[11]=1,h[12]=f,h[13]=l,h[14]=1,h[15]=0,u.setData(h,0,4)},e.makePow2=function(e){var t=Math.log(e)/Math.log(2);return 1<<Math.ceil(t)},e.prototype.createRenderTarget=function(t){var n=this.graphicsDevice,r=this.renderTargetStructs,i=r.length,s=t&&t.name?t.name:"RenderTarget#"+i,o=t&&t.backBuffer!==undefined?t.backBuffer:!0,u=t.width===undefined||t.height===undefined,a=this.renderTargetTextureParameters;a.name=s;var f=u?n.width:t.width,l=u?n.height:t.height,c=e.makePow2;a.width=c(f),a.height=c(l);var h=n.createTexture(a),p=this.renderTargetParams;p.colorTexture0=h;var d=n.createRenderTarget(p);return r.push({managed:u,renderTarget:d,texture:h,backBuffer:o,actualWidth:o?f:h.width,actualHeight:o?l:h.height}),i},e.prototype.validateTarget=function(t,n,r){if(t.managed){var i=t.texture;t.backBuffer&&(t.actualWidth=n,t.actualHeight=r);var s=e.makePow2;n=s(n),r=s(r),t.backBuffer||(t.actualWidth=n,t.actualHeight=r);if(i.width!==n||i.height!==r){var o=this.renderTargetTextureParameters,u=this.renderTargetParams;o.name=i.name,o.width=n,o.height=r,i.destroy(),t.renderTarget.destroy();var a=this.graphicsDevice;t.texture=a.createTexture(o),u.colorTexture0=t.texture,t.renderTarget=a.createRenderTarget(u)}}},e.prototype.setBackBuffer=function(){return this.state!==this.drawStates.ready?!1:(this.currentRenderTarget=null,this.forceUpdate=!0,!0)},e.prototype.getRenderTargetTexture=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?null:t[e].texture},e.prototype.getRenderTarget=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?null:t[e].renderTarget},e.prototype.setRenderTarget=function(e){var t=this.renderTargetStructs;return e<0||e>=t.length?!1:this.state!==this.drawStates.ready?!1:(this.currentRenderTarget=t[e],this.forceUpdate=!0,!0)},e.prototype.copyRenderTarget=function(e){if(this.state!==this.drawStates.ready)return!1;var t=this.renderTargetStructs;if(e<0||e>=t.length)return!1;this.update(),this.currentRenderTarget||this.graphicsDevice.setScissor(this.scissorX,this.scissorY,this.scissorWidth,this.scissorHeight);var n=this.graphicsDevice,r=t[e],i=r.texture,s=this.copyTechnique,o=this.copyTechniqueParameters,u=o.copyUVScale;u[0]=r.actualWidth/i.width,u[1]=r.actualHeight/i.height,o.copyFlip=this.currentRenderTarget?1:-1,o.inputTexture0=i;var a=!1,f=this.currentRenderTarget,l=this.copyVertexBuffer;return f&&(a=n.beginRenderTarget(f.renderTarget)),n.setTechnique(s),n.setTechniqueParameters(o),n.setStream(l,this.quadSemantics),n.draw(this.quadPrimitive,4,0),f&&a&&n.endRenderTarget(),!0},e.prototype.resetPerformanceData=function(){var e=this.performanceData;e.minBatchSize=e.maxBatchSize=e.avgBatchSize=undefined,e.batchCount=0,e.dataTransfers=0},e.create=function(t){var n=new e,r=n.graphicsDevice=t.graphicsDevice;n.sortMode=undefined,n.blendMode=undefined,n.sortModeStack=[],n.blendModeStack=[],n.drawGroups=[V.create()],n.numGroups=0,n.texLists={},n.texGroup=undefined,n.drawSprite=J.create(),n.defaultTexture=r.createTexture({name:"DefaultDraw2DTexture",width:1,height:1,depth:1,format:"L8",cubemap:!1,mipmaps:!0,renderable:!1,dynamic:!1,data:[255]}),n.draw=undefined,n.drawSprite=undefined,n.drawRaw=undefined;var i=r.createShader({version:1,name:"draw2D.cgfx",samplers:{texture:{MinFilter:9985,MagFilter:9729,WrapS:33071,WrapT:33071},inputTexture0:{MinFilter:9728,MagFilter:9729,WrapS:33071,WrapT:33071}},parameters:{clipSpace:{type:"float",columns:4},copyUVScale:{type:"float",columns:2},copyFlip:{type:"float"},texture:{type:"sampler2D"},inputTexture0:{type:"sampler2D"}},techniques:{opaque:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_draw2D","fp_draw2D"]}],alpha:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_draw2D","fp_draw2D"]}],additive:[{parameters:["clipSpace","texture"],semantics:["POSITION","COLOR","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,1]},programs:["vp_draw2D","fp_draw2D"]}],copy:[{parameters:["copyUVScale","copyFlip","inputTexture0"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_copy","fp_copy"]}]},programs:{fp_copy:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _ret_0;uniform sampler2D inputTexture0;void main()\n{_ret_0=texture2D(inputTexture0,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp_copy:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OutPosition1;vec2 _OutUV1;uniform vec2 copyUVScale;uniform float copyFlip;void main()\n{_OutPosition1.x=ATTR0.x;_OutPosition1.y=ATTR0.y*copyFlip;_OutPosition1.zw=ATTR0.zw;_OutUV1=ATTR8.xy*copyUVScale;tz_TexCoord[0].xy=_OutUV1;gl_Position=_OutPosition1;}"},fp_draw2D:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;varying vec4 tz_TexCoord[1];\nvec4 _ret_0;vec4 _TMP0;uniform sampler2D texture;void main()\n{_TMP0=texture2D(texture,tz_TexCoord[0].xy);_ret_0=tz_Color*_TMP0;gl_FragColor=_ret_0;}"},vp_draw2D:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;varying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR3;attribute vec4 ATTR8;\nvec4 _OUTPosition1;vec4 _OUTColor1;vec2 _OUTTexCoord01;uniform vec4 clipSpace;void main()\n{vec2 _position;_position=ATTR0.xy*clipSpace.xy+clipSpace.zw;_OUTPosition1.x=_position.x;_OUTPosition1.y=_position.y;_OUTPosition1.z=0.0;_OUTPosition1.w=1.0;_OUTColor1=ATTR3;_OUTTexCoord01=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;tz_Color=ATTR3;gl_Position=_OUTPosition1;}"}}});n.blendModeTechniques={additive:i.getTechnique("additive"),alpha:i.getTechnique("alpha"),opaque:i.getTechnique("opaque")};if(t.blendModes)for(var s in t.blendModes)t.blendModes.hasOwnProperty(s)&&(n.blend[s]=s,n.blendModeTechniques[s]=t.blendModes[s]);n.techniqueParameters=r.createTechniqueParameters({clipSpace:new e.floatArray(4),texture:null}),n.currentRenderTarget=null,n.renderTargetStructs=[],n.state=n.drawStates.ready,n.scaleMode="none",n.blendMode="opaque",n.width=0,n.height=0,n.scissorX=0,n.scissorY=0,n.scissorWidth=n.graphicsDevice.width,n.scissorHeight=n.graphicsDevice.height,n.clipOffsetX=-1,n.clipOffsetY=1,n.clipScaleX=2/n.graphicsDevice.width,n.clipScaleY=-2/n.graphicsDevice.height,n.viewScaleX=1,n.viewScaleY=1;var o=t.initialGpuMemory?t.initialGpuMemory:0;o<140&&(o=140),o>2293760&&(o=2293760),n.performanceData={gpuMemoryUsage:o,minBatchSize:0,maxBatchSize:0,avgBatchSize:0,batchCount:0,dataTransfers:0},n.maxGpuMemory=t.maxGpuMemory?t.maxGpuMemory:2293760,n.maxGpuMemory<o&&(n.maxGpuMemory=o);var u=Math.floor(o/140)*4;return n.maxVertices=Math.floor(n.maxGpuMemory/140)*4,n.maxVertices>65536&&(n.maxVertices=65536),n.cpuStride=64,n.gpuStride=4,n.vertexBufferParameters={numVertices:u,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT4,r.VERTEXFORMAT_FLOAT2],"transient":!0},n.vertexBuffer=r.createVertexBuffer(n.vertexBufferParameters),n.semantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_COLOR,r.SEMANTIC_TEXCOORD0]),n.indexBufferParameters={numIndices:u*1.5,format:r.INDEXFORMAT_USHORT,dynamic:!1,data:n.indexData(u*1.5)},n.indexBuffer=r.createIndexBuffer(n.indexBufferParameters),n.indexBufferParameters.data=null,n.renderTargetIndex=0,n.renderTargetCount=0,n.renderTargetTextureParameters={name:"",width:0,height:0,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,renderable:!0,dynamic:!0},n.renderTargetParams={colorTexture0:null},n.copyTechnique=i.getTechnique("copy"),n.copyTechniqueParameters=r.createTechniqueParameters({inputTexture0:null,copyFlip:1,copyUVScale:new e.floatArray([1,1])}),n.quadSemantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_TEXCOORD0]),n.quadPrimitive=r.PRIMITIVE_TRIANGLE_STRIP,n.copyVertexBufferParams={numVertices:4,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT2],"transient":!0},n.copyVertexBuffer=r.createVertexBuffer(n.copyVertexBufferParams),n.vertexBufferData=new e.floatArray([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]),n},e.version=7,e.defaultClearColor=[0,0,0,1],e}();(function(){K.uint16Array=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n};var e,t;typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(K.uint16Array=Uint16Array)),K.floatArray=function(e){if(arguments.length===0)return[];var t,n;if(typeof e=="number")n=new Array(e);else{n=[];for(t=0;t<e.length;t+=1)n[t]=e[t]}return n},typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(K.floatArray=Float32Array,K.defaultClearColor=new Float32Array(K.defaultClearColor)))})();var Q=function(){function e(e,t,n){this.escapeNodeOffset=t,this.externalNode=n,this.extents=e}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s){this.escapeNodeOffset=i,this.externalNode=s;var o=this.extents;o[0]=e,o[1]=t,o[2]=n,o[3]=r},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=-t,e[3]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),G=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e}return e.prototype.add=function(e,t){var n=this.endNode;e.boxTreeIndex=n;var r=new this.arrayConstructor(4);r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],this.nodes[n]=Q.create(r,1,e),this.endNode=n+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.boxTreeIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.boxTreeIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.boxTreeIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=this.needsRebuild,a=this.needsRebound,f=this.nodes,l=f[n],c=l.extents,h=u||a||c[0]>r||c[1]>i||c[2]<s||c[3]<o;c[0]=r,c[1]=i,c[2]=s,c[3]=o;if(h&&!u&&1<f.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!a)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var p=this.findParent(n),d=p.extents;if(d[0]>r||d[1]>i||d[2]<s||d[3]<o)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=[],i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v<h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var e=this.nodes,t,n,r;if(this.numExternalNodes===e.length)t=e,n=e.length,e=[],this.nodes=e;else{t=[],t.length=this.numExternalNodes,n=0,r=this.endNode;for(var i=0;i<r;i+=1){var s=e[i];s.externalNode&&(e[i]=undefined,t[n]=s,n+=1)}t.length>n&&(t.length=n)}if(n>1)n>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this.sortNodesHighQuality(t):this.sortNodes(t)),this.recursiveBuild(t,0,n,0),r=e[0].escapeNodeOffset,e.length>r&&(e.length=r),this.endNode=r;else{var o=t[0];o.externalNode.boxTreeIndex=0,e.length=1,e[0]=o,this.endNode=1}t=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.sortNodes=function(e){var t=this.numNodesLeaf,n=e.length,r=function(t){var n=t.extents;return n[0]+n[2]},i=function(t){var n=t.extents;return n[1]+n[3]},s=function(t){var n=t.extents;return-(n[0]+n[2])},o=function(t){var n=t.extents;return-(n[1]+n[3])},u=this.nthElement,a=!1,f=0,l=function(n,c,h){var p=c+h>>1;f===0?a?u(n,c,p,h,s):u(n,c,p,h,r):a?u(n,c,p,h,o):u(n,c,p,h,i),f===0?f=2:f===2?f=1:f=0,a=!a,c+t<p&&l(n,c,p),p+t<h&&l(n,p,h)};l(e,0,n)},e.prototype.sortNodesHighQuality=function(e){var t=this.numNodesLeaf,n=e.length,r=function(t){var n=t.extents;return n[0]+n[2]},i=function(t){var n=t.extents;return n[1]+n[3]},s=function(t){var n=t.extents;return n[0]+n[1]+n[2]+n[3]},o=function(t){var n=t.extents;return n[0]-n[1]+n[2]-n[3]},u=function(t){var n=t.extents;return-(n[0]+n[2])},a=function(t){var n=t.extents;return-(n[1]+n[3])},f=function(t){var n=t.extents;return-(n[0]+n[1]+n[2]+n[3])},l=function(t){var n=t.extents;return-(n[0]-n[1]+n[2]-n[3])},c=this.nthElement,h=this.calculateSAH,p=!1,d=function(n,v,m){var g=v+m>>1;c(n,v,g,m,r);var y=h(n,v,g)+h(n,g,m);c(n,v,g,m,i);var b=h(n,v,g)+h(n,g,m);c(n,v,g,m,s);var w=h(n,v,g)+h(n,g,m);c(n,v,g,m,o);var E=h(n,v,g)+h(n,g,m);y<=b&&y<=w&&y<=E?p?c(n,v,g,m,u):c(n,v,g,m,r):b<=w&&b<=E?p?c(n,v,g,m,a):c(n,v,g,m,i):w<=E?p?c(n,v,g,m,f):c(n,v,g,m,s):p?c(n,v,g,m,l):c(n,v,g,m,o),p=!p,v+t<g&&d(n,v,g),g+t<m&&d(n,g,m)};d(e,0,n)},e.prototype.calculateSAH=function(e,t,n){var r,i,s,o,u,a;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3];for(var f=t+1;f<n;f+=1)r=e[f],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u<i[2]&&(u=i[2]),a<i[3]&&(a=i[3]);return u-s+(a-o)},e.prototype.nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype.recursiveBuild=function(e,t,n,r){var i=this.nodes,s=r;r+=1;var o,u,a,f,l,c,h;if(t+this.numNodesLeaf>=n){c=e[t],l=c.extents,o=l[0],u=l[1],a=l[2],f=l[3],c.externalNode.boxTreeIndex=r,i[r]=c;for(var p=t+1;p<n;p+=1)c=e[p],l=c.extents,o>l[0]&&(o=l[0]),u>l[1]&&(u=l[1]),a<l[2]&&(a=l[2]),f<l[3]&&(f=l[3]),r+=1,c.externalNode.boxTreeIndex=r,i[r]=c;h=i[r]}else{var d=t+n>>1;t+1>=d?(c=e[t],c.externalNode.boxTreeIndex=r,i[r]=c):this.recursiveBuild(e,t,d,r),h=i[r],l=h.extents,o=l[0],u=l[1],a=l[2],f=l[3],r+=h.escapeNodeOffset,d+1>=n?(c=e[d],c.externalNode.boxTreeIndex=r,i[r]=c):this.recursiveBuild(e,d,n,r),h=i[r],l=h.extents,o>l[0]&&(o=l[0]),u>l[1]&&(u=l[1]),a<l[2]&&(a=l[2]),f<l[3]&&(f=l[3])}var v=i[s];if(v!==undefined)v.reset(o,u,a,f,r+h.escapeNodeOffset-s);else{var m=new this.arrayConstructor(4);m[0]=o,m[1]=u,m[2]=a,m[3]=f,i[s]=Q.create(m,r+h.escapeNodeOffset-s)}},e.prototype.getVisibleNodes=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i=e.length,s=t.length,o,u,a,f,l,c,h,p,d,v,m,g,y=0;for(;;){o=n[y],u=o.extents,f=u[0],l=u[1],c=u[2],h=u[3],p=!0,d=0;do{v=e[d],m=v[0],g=v[1];if(m*(m<0?f:c)+g*(g<0?l:h)<v[2]){p=!1;break}d+=1}while(d<i);if(p)if(o.externalNode){t[s]=o.externalNode,s+=1,y+=1;if(y>=r)break}else{p=!0,d=0;do{v=e[d],m=v[0],g=v[1];if(m*(m>0?f:c)+g*(g>0?l:h)<v[2]){p=!1;break}d+=1}while(d<i);if(p){a=y+o.escapeNodeOffset,y+=1;do o=n[y],o.externalNode&&(t[s]=o.externalNode,s+=1),y+=1;while(y<a);if(y>=r)break}else y+=1}else{y+=o.escapeNodeOffset;if(y>=r)break}}}},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=this.nodes,a=this.endNode,f,l,c,h=0,p=n===undefined?t.length:n,d=0;for(;;){f=u[d],l=f.extents;var v=l[0],m=l[1],g=l[2],y=l[3];if(r<=g&&i<=y&&s>=v&&o>=m)if(f.externalNode){t[p]=f.externalNode,p+=1,h+=1,d+=1;if(d>=a)break}else if(s>=g&&o>=y&&r<=v&&i<=m){c=d+f.escapeNodeOffset,d+=1;do f=u[d],f.externalNode&&(t[p]=f.externalNode,p+=1,h+=1),d+=1;while(d<c);if(d>=a)break}else d+=1;else{d+=f.escapeNodeOffset;if(d>=a)break}}return h}return 0},e.prototype.getCircleOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=this.nodes,u=this.endNode,a,f,l=n.length,c=0;for(;;){a=o[c],f=a.extents;var h=f[0],p=f[1],d=f[2],v=f[3],m=0,g;i<h?(g=h-i,m+=g*g):i>d&&(g=i-d,m+=g*g),s<p?(g=p-s,m+=g*g):s>v&&(g=s-v,m+=g*g);if(m<=r){c+=1;if(a.externalNode){n[l]=a.externalNode,l+=1;if(c>=u)break}}else{c+=a.escapeNodeOffset;if(c>=u)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[2]&&p<=u[3]&&d>=u[0]&&v>=u[1]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.rayTest=function(e,t,n){var r=t.origin,i=t.direction,s=r[0],o=r[1],u=i[0],a=i[1],f=1/u,l=1/a,c=function(t,n){var r=t[0],i=t[1],c=t[2],h=t[3];if(r<=s&&s<=c&&
i<=o&&o<=h)return 0;var p,d,v,m,g;return u>=0?(g=r-s,p=g===0?0:g*f,g=c-s,d=g===0?0:g*f):(p=(c-s)*f,d=(r-s)*f),a>=0?(g=i-o,v=g===0?0:g*l,g=h-o,m=g===0?0:g*l):(v=(h-o)*l,m=(i-o)*l),p>m||v>d?undefined:(v>p&&(p=v),m<d&&(d=m),p<0&&(p=d),0<=p&&p<n?p:undefined)},h=[],p=null,d=function(r,i,s){var o=r.getNodes(),u=o[i],a=c(u.extents,s);if(a===undefined)return s;if(u.externalNode){var f=n(r,u.externalNode,t,a,s);f&&(p=f,s=f.factor)}else{var l=h.length,d;for(d=0;d<l;d+=1){var v=h[d];if(a>v.distance)break}h.splice(d-1,0,{tree:r,nodeIndex:i,distance:a})}return s},v=t.maxFactor,m,g;for(g=0;g<e.length;g+=1)m=e[g],m.endNode!==0&&(v=d(m,0,v));while(h.length!==0){var y=h.pop();if(y.distance>=v)continue;var b=y.nodeIndex;m=y.tree;var w=m.getNodes(),E=w[b],S=b+E.escapeNodeOffset,x=b+1;do v=d(m,x,v),x+=w[x].escapeNodeOffset;while(x<S)}return p},e.create=function(t){return new e(t)},e.version=1,e}();(function(){G.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(G.prototype.arrayConstructor=Float32Array)}})();var Y=function(){function e(){}return e.prototype.setPhysics2DViewport=function(e){if(e){var t=this._physics2DPort;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._physics2DPortEnabled=!0}else this._physics2DPortEnabled=!1;this._invalidated=!0},e.prototype.setScreenViewport=function(e){if(e){var t=this._screenPort;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._screenPortEnabled=!0}else this._screenPortEnabled=!1;this._invalidated=!0},e.prototype.drawLine=function(e,t,n,r,i){var s=this._numVertices,o=s*6,u=this._numLines*2;this._prepare(2,1);var a=this._vertexData;a[o]=e,a[o+1]=t,a[o+6]=n,a[o+7]=r,a[o+2]=a[o+8]=i[0],a[o+3]=a[o+9]=i[1],a[o+4]=a[o+10]=i[2],a[o+5]=a[o+11]=i[3],a=this._indexData,a[u]=s,a[u+1]=s+1},e.prototype.drawLinearSpring=function(e,t,n,r,i,s,o){if(i<=0){this.drawLine(e,t,n,r,o);return}var u=n-e,a=r-t,f=u*u+a*a,l=this.minSpringLength*this.screenToPhysics2D;if(f<l*l){this.drawLine(e,t,n,r,o);return}var c=-a,h=u,p=2*s/Math.sqrt(c*c+h*h);c*=p,h*=p;var d=1/(i*4);u*=d,a*=d;var v;for(v=0;v<i;v+=1)n=e+u*2,r=t+a*2,this.drawCurve(e,t,e+u+c,t+a+h,n,r,o),e=n,t=r,n=e+u*2,r=t+a*2,this.drawCurve(e,t,e+u-c,t+a-h,n,r,o),e=n,t=r},e.prototype._drawAngleIndicator=function(e,t,n,r,i,s){var o=Math.cos(n),u=Math.sin(n);this._drawAnchor(e+r*o,t+r*u,i,s)},e.prototype._drawAnchor=function(e,t,n,r){this.drawCircle(e,t,n,r),this.drawCircle(e,t,n*.75,r),this.drawCircle(e,t,n*.5,r),this.drawCircle(e,t,n*.25,r)},e.prototype.drawSpiral=function(e,t,n,r,i,s,o){if(n>r){var u=n;n=r,r=u,u=i,i=s,s=u}if(n===r)return;var a=s-i,f=r-n,l=Math.ceil(f/this.spiralMaxArc),c=a/l,h=f/l,p=Math.cos(h),d=Math.sin(h),v=Math.cos(n),m=Math.sin(n),g=i,y=e+i*v,b=t+i*m,w=a*v-g*f*m,E=a*m+g*f*v,S;for(S=0;S<l;S+=1){var x=g+c,T=p*v-d*m,N=d*v+p*m,C=e+x*T,k=t+x*N,L=a*T-x*f*N,A=a*N+x*f*T,O=w*A-E*L;if(O*O<this.spiralEpsilon)this.drawLine(y,b,C,k,o);else{var M=((C-y)*A+(b-k)*L)/O;M<=0?this.drawLine(y,b,C,k,o):this.drawCurve(y,b,y+w*M,b+E*M,C,k,o)}g=x,v=T,m=N,w=L,E=A,y=C,b=k}},e.prototype.drawSpiralSpring=function(e,t,n,r,i,s,o,u){if(n>r){var a=n;n=r,r=a,a=i,i=s,s=a}if(n===r)return;var f=s-i,l=r-n,c=Math.max(Math.ceil(l/(this.spiralMaxArc*3)),40*o),h=l/c,p=1/c,d=Math.cos(h),v=Math.sin(h),m=this.spiralSpringSize,g=Math.abs(2*Math.PI*f/l),y=m*g,b=2*o*Math.PI,w=y*b,E=Math.cos(n),S=Math.sin(n),x=i,T=e+x*E,N=t+x*S,C=f+w,k=C*E-x*l*S,L=C*S+x*l*E,A;for(A=0;A<c;A+=1){var O=(A+1)*p,M=d*E-v*S,_=v*E+d*S;x=i+f*O+y*Math.sin(b*O);var D=e+x*M,P=t+x*_;C=f+w*Math.cos(b*O);var H=C*M-x*l*_,B=C*_+x*l*M,j=k*B-L*H,F=k*H+L*B;j*j<this.spiralEpsilon||F<0||F>1-this.spiralEpsilon?this.drawLine(T,N,D,P,u):(O=((D-T)*B+(N-P)*H)/j,O<=0?this.drawLine(T,N,D,P,u):this.drawCurve(T,N,T+k*O,N+L*O,D,P,u)),E=M,S=_,k=H,L=B,T=D,N=P}},e.prototype.drawCurve=function(e,t,n,r,i,s,o){var u=o[0],a=o[1],f=o[2],l=o[3],c=this._curveStack,h=this._curveVerts;c.push(e,t,n,r,i,s);while(c.length>0){s=c.pop(),i=c.pop(),r=c.pop(),n=c.pop(),t=c.pop(),e=c.pop();var p=.25*(e+2*n+i),d=.25*(t+2*r+s),v=.5*(e+i),m=.5*(t+s),g=p-v,y=d-m,b=this.curveMaxError*this.screenToPhysics2D;if(g*g+y*y<b*b)h.push(e,t);else{var w=.5*(e+n),E=.5*(t+r),S=.5*(i+n),x=.5*(s+r),T=.5*(w+S),N=.5*(E+x);c.push(T,N,S,x,i,s),c.push(e,t,w,E,T,N)}}h.push(i,s);var C=h.length>>1,k=this._numVertices,L=k*6,A=this._numLines*2;this._prepare(C,C-1);var O=this._vertexData,M=this._indexData,_,D=0;for(_=0;_<C;_+=1)O[L]=h[D],O[L+1]=h[D+1],O[L+2]=u,O[L+3]=a,O[L+4]=f,O[L+5]=l,D+=2,L+=6,_>0&&(M[A]=k+_-1,M[A+1]=k+_,A+=2);h.length=0},e.prototype.drawRectangle=function(e,t,n,r,i){var s=this._numVertices,o=s*6,u=this._numLines*2;this._prepare(4,4);var a=this._vertexData,f=this._indexData;a[o]=a[o+18]=e,a[o+1]=a[o+7]=t,a[o+6]=a[o+12]=n,a[o+13]=a[o+19]=r,a[o+2]=a[o+8]=a[o+14]=a[o+20]=i[0],a[o+3]=a[o+9]=a[o+15]=a[o+21]=i[1],a[o+4]=a[o+10]=a[o+16]=a[o+22]=i[2],a[o+5]=a[o+11]=a[o+17]=a[o+23]=i[3],f[u]=f[u+7]=s,f[u+1]=f[u+2]=s+1,f[u+3]=f[u+4]=s+2,f[u+5]=f[u+6]=s+3},e.prototype.drawCircle=function(e,t,n,r){var i=r[0],s=r[1],o=r[2],u=r[3],a=this.circleMaxError,f=n*this.physics2DToScreen,l;f<a/2?l=3:(l=Math.ceil(Math.PI/Math.acos(1-a/f)),l<3&&(l=3));var c=this._numVertices,h=c*6,p=this._numLines*2;this._prepare(l,l);var d=n,v=0,m=Math.PI*2/l,g=Math.cos(m),y=Math.sin(m),b=this._vertexData,w=this._indexData,E;for(E=0;E<l;E+=1){var S=d*g-v*y;v=d*y+v*g,d=S,b[h]=e+d,b[h+1]=t+v,b[h+2]=i,b[h+3]=s,b[h+4]=o,b[h+5]=u,h+=6,w[p]=c+E,w[p+1]=c+(E+1)%l,p+=2}},e.prototype.drawRigidBody=function(e){e._update();var t=e.shapes,n=t.length,r;for(r=0;r<n;r+=1)this._drawShape(t[r]);if(this.showBodyDetail){var i=e._data;this.drawCircle(i[2],i[3],this.screenToPhysics2D*this.bodyPositionRadius,this.bodyDetailColor),this.drawLine(i[15],i[16],i[2],i[3],this.bodyDetailColor)}},e.prototype.drawConstraint=function(e){e._draw&&e._draw(this,e._stiff)},e.prototype.drawWorld=function(e){var t,n;if(this.showRigidBodies){var r=e.rigidBodies;n=r.length;for(t=0;t<n;t+=1){var i=r[t];this.drawRigidBody(i)}}this.showContacts&&(this._drawArbiters(e.dynamicArbiters),this._drawArbiters(e.staticArbiters));if(this.showConstraints){var s=e.constraints;n=s.length;for(t=0;t<n;t+=1){var o=s[t];o._active&&this.drawConstraint(o)}}},e.prototype._drawArbiters=function(e){var t=this.screenToPhysics2D*this.contactRadius,n=this.screenToPhysics2D*this.contactImpulseScale,r=e.length,i;for(i=0;i<r;i+=1){var s=e[i];if(!s.active)continue;var o=s._static?this.staticContactColor:this.dynamicContactColor,u,a;if(s.sensor)u=0,a=0;else{var f=s._data;u=f[4],a=f[5]}var l=s._contact1._data,c=l[0],h=l[1];this.drawCircle(c,h,t,o);var p,d;this.showContactImpulses&&!s._contact1.virtual&&(p=l[11]*n,d=l[12]*n,this.drawLine(c,h,c+u*p,h+a*p,this.normalImpulseColor),this.drawLine(c,h,c-a*d,h+u*d,this.frictionImpulseColor));if(s._position2Contact){var v=s._contact2._data,m=v[0],g=v[1];this.showContactImpulses&&!s._contact2.virtual&&(p=v[11]*n,d=v[12]*n,this.drawLine(m,g,m+u*p,g+a*p,this.normalImpulseColor),this.drawLine(m,g,m-a*d,g+u*d,this.frictionImpulseColor)),u*=t,a*=t,this.drawCircle(m,g,t,o),this.drawLine(c+u,h+a,m+u,g+a,o),this.drawLine(c-u,h-a,m-u,g-a,o)}}},e.prototype._drawShape=function(e){var t=e.body;if(e.sensor&&!this.showSensorsShapes||!e.sensor&&!this.showColliderShapes)return;var n=this._colors[e.body._type|(t.sleeping?4:0)|(e.sensor?8:0)|(t._bullet?16:0)];e._type===0?this._drawCircleShape(e,n):this._drawPolygonShape(e,n);if(this.showShapeDetail){var r=e._data;this.drawRectangle(r[0],r[1],r[2],r[3],this.shapeDetailColor)}},e.prototype._drawCircleShape=function(e,t){var n=e.body._data,r=e._data,i=r[9],s=r[10],o=r[6];this.drawCircle(i,s,o,t);if(e.body._type!==2){var u=n[5],a=n[6];this.drawLine(i+o*.333*u,s+o*.333*a,i+o*u,s+o*a,t)}this.showShapeDetail&&this.drawCircle(r[9],r[10],this.screenToPhysics2D*this.circleOriginRadius,this.shapeDetailColor)},e.prototype._drawPolygonShape=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=this._numVertices,u=o*6,a=this._numLines*2,f=e._data,l=6,c=f.length,h=(c-l)/13;this._prepare(h,h);var p=this._vertexData,d=this._indexData,v;for(v=0;l<c;l+=13,v+=1)p[u]=f[l+2],p[u+1]=f[l+2+1],p[u+2]=n,p[u+3]=r,p[u+4]=i,p[u+5]=s,u+=6,d[a]=o+v,d[a+1]=o+(v+1)%h,a+=2},e.prototype.begin=function(){var e=this._graphicsDevice,t=e.width,n=e.height,r,i,s,o,u;this._screenPortEnabled?(u=this._screenPort,r=u[0],i=u[1],s=u[2]-r,o=u[3]-i):(r=0,i=0,s=t,o=n);if(t!==this._width||n!==this._height||this._invalidated){this._width=t,this._height=n,this._invalidated=!1;var a,f,l,c;this._physics2DPortEnabled?(u=this._physics2DPort,a=u[0],f=u[1],l=u[2]-a,c=u[3]-f):(a=0,f=0,l=t/60,c=n/60);var h=this._techniqueParams.clipSpace;h[0]=2*s/(t*l),h[1]=-(2*o)/(n*c),h[2]=-(2*a*s)/(t*l)+2*r/t-1,h[3]=2*f*o/(n*c)-2*i/n+1;var p=h[0]*.5*t,d=-(h[1]*.5*n);this.physics2DToScreen=.5*(p+d),this.screenToPhysics2D=1/this.physics2DToScreen}e.setScissor(r,n-i-o,s,o),e.setTechnique(this._technique),e.setTechniqueParameters(this._techniqueParams)},e.prototype.end=function(){this._dispatch()},e.prototype._prepare=function(e,t){var n,r,i,s=this._numVertices*6,o=s+e*6,u=this._vertexData;if(o>u.length){n=this._bufferSizeAlgorithm(o),r=this._vertexData=new X.prototype.floatArray(n);for(i=0;i<s;i+=1)r[i]=u[i]}this._numVertices+=e,s=this._numLines*2,o=s+t*2,u=this._indexData;if(o>u.length){n=this._bufferSizeAlgorithm(o),r=this._indexData=new X.prototype.uint16Array(n);for(i=0;i<s;i+=1)r[i]=u[i]}this._numLines+=t},e.prototype._bufferSizeAlgorithm=function(e){var t=1.25,n=Math.ceil(Math.log(e)/Math.log(t)),r=Math.floor(Math.pow(t,n));return 6*Math.ceil(r/6)},e.prototype._dispatch=function(){var e=this._graphicsDevice,t=this._vertexBuffer,n=this._vertexBufferParameters,r=this._vertexData,i=this._indexBuffer,s=this._indexBufferParameters,o=this._indexData,u=this._numVertices;if(u===0)return;var a;u>n.numVertices&&(a=this._bufferSizeAlgorithm(u),n.numVertices=a,this._vertexBuffer.destroy(),this._vertexBuffer=t=e.createVertexBuffer(n)),t.setData(r,0,u),u=this._numLines*2,u>s.numIndices&&(a=this._bufferSizeAlgorithm(u),s.numIndices=a,this._indexBuffer.destroy(),this._indexBuffer=i=e.createIndexBuffer(s)),i.setData(o,0,u),e.setStream(t,this._semantics),e.setIndexBuffer(i),e.drawIndexed(e.PRIMITIVE_LINES,u),this._numVertices=0,this._numLines=0},e.prototype.destroy=function(){this._graphicsDevice=null,this._curveStack.length=0,this._curveVerts.length=0,this._colors.length=0,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},e.create=function(t){var n=new e,r=n._graphicsDevice=t.graphicsDevice;n._screenPort=new X.prototype.floatArray(4),n._screenPortEnabled=!1,n._physics2DPort=new X.prototype.floatArray(4),n._physics2DPortEnabled=!1,n._invalidated=!0,n.physics2DToScreen=0,n.screenToPhysics2D=0,n.circleMaxError=.4,n.curveMaxError=.6,n.spiralMaxArc=Math.PI/4,n.spiralEpsilon=1e-5,n.spiralSpringSize=.75,n._curveStack=[],n._curveVerts=[],n.minSpringLength=.5;var i=function(t,n,r,i){var s=new X.prototype.floatArray(4);return s[0]=t,s[1]=n,s[2]=r,s[3]=i,s},s=i(1,1,1,1),o=i(1,.5,.5,1),u=i(.9,.7,.7,.6),a=i(.8,.3,.8,1),f=i(.8,.4,.8,.6),l=i(.5,1,.5,1),c=i(.7,.9,.7,.6),h=i(.5,1,.5,.5),p=i(.7,.9,.7,.4),d=i(.8,.4,.8,.5),v=i(.8,.5,.8,.4);n.showConstraints=!0,n.constraintAnchorRadius=3,n.constraintSpringRadius=3,n.constraintSpringNumCoils=3,n.constraintSpiralMinRadius=10,n.constraintSpiralDeltaRadius=2.5/Math.PI,n.constraintSpiralNumCoils=4,n.constraintColorA=i(1,0,0,.8),n.constraintSleepingColorA=i(.7,.2,.2,.6),n.constraintColorB=i(0,0,1,.8),n.constraintSleepingColorB=i(.2,.2,.7,.6),n.constraintColorC=i(0,1,0,.8),n.constraintSleepingColorC=i(.2,.7,.2,.6),n.constraintColorD=i(1,0,1,.8),n.constraintSleepingColorD=i(.7,.2,.7,.6),n.constraintErrorColorA=i(1,1,.5,.8),n.constraintErrorSleepingColorA=i(.7,.7,.5,.6),n.constraintErrorColorB=i(.5,1,1,.8),n.constraintErrorSleepingColorB=i(.5,.7,.7,.6),n.constraintErrorColorC=i(.4,1,.4,.8),n.constraintErrorSleepingColorC=i(.4,.7,.4,.6),n.constraintErrorColorD=i(1,.4,1,.8),n.constraintErrorSleepingColorD=i(.7,.4,.7,.6),n.showContacts=!1,n.showContactImpulses=!1,n.contactRadius=3,n.contactImpulseScale=30,n.dynamicContactColor=i(1,0,.5,.7),n.staticContactColor=i(.5,0,1,.7),n.normalImpulseColor=i(1,0,0,1),n.frictionImpulseColor=i(0,0,1,1),n.showRigidBodies=!0,n.showColliderShapes=!0,n.showSensorsShapes=!0,n.showBodyDetail=!1,n.showShapeDetail=!1,n.bodyPositionRadius=.5,n.circleOriginRadius=.5,n.bodyDetailColor=i(0,1,1,.5),n.shapeDetailColor=i(1,1,0,.5);var m=n._colors=[];m[6]=o,m[14]=u,m[0]=l,m[8]=c,m[4]=h,m[12]=p,m[16]=s,m[1]=a,m[9]=f,m[5]=d,m[13]=v;var g=r.createShader({version:1,name:"lines.cgfx",parameters:{clipSpace:{type:"float",columns:4}},techniques:{alpha:[{parameters:["clipSpace"],semantics:["POSITION","COLOR"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[770,771]},programs:["vp_draw2dlines","fp_draw2dlines"]}]},programs:{fp_draw2dlines:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;\nvoid main()\n{gl_FragColor=tz_Color;}"},vp_draw2dlines:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying TZ_LOWP vec4 tz_Color;attribute vec4 ATTR3;attribute vec4 ATTR0;\nvec4 _outpos1;vec4 _outcol1;uniform vec4 clipSpace;void main()\n{vec2 _TMP1;_TMP1=ATTR0.xy*clipSpace.xy+clipSpace.zw;_outpos1=vec4(_TMP1.x,_TMP1.y,0.0,1.0);_outcol1=ATTR3;tz_Color=ATTR3;gl_Position=_outpos1;}"}}});n._techniqueParams=r.createTechniqueParameters({clipSpace:new X.prototype.floatArray(4)}),n._technique=g.getTechnique("alpha");var y=4,b=4;return n._vertexBufferParameters={numVertices:y,attributes:[r.VERTEXFORMAT_FLOAT2,r.VERTEXFORMAT_FLOAT4],"transient":!0},n._vertexBuffer=r.createVertexBuffer(n._vertexBufferParameters),n._semantics=r.createSemantics([r.SEMANTIC_POSITION,r.SEMANTIC_COLOR]),n._indexBufferParameters={numIndices:b,format:r.INDEXFORMAT_USHORT,"transient":!0},n._indexBuffer=r.createIndexBuffer(n._indexBufferParameters),n._vertexData=new X.prototype.floatArray(60),n._indexData=new X.prototype.uint16Array(60),n._numVertices=0,n._numLines=0,n},e.version=1,e}();x.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintSleepingColorC:t.constraintColorC,s=this.sleeping?t.constraintSleepingColorD:t.constraintColorD,o=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,u=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,a=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,f=this.sleeping?t.constraintErrorSleepingColorD:t.constraintErrorColorD,l=this._data,c=this.bodyA._data,h=this.bodyB._data,p=this.bodyC._data,d=this.bodyD._data,v=c[2]+l[19],m=c[3]+l[20],g=h[2]+l[21],y=h[3]+l[22],b=p[2]+l[23],w=p[3]+l[24],E=d[2]+l[25],S=d[3]+l[26],x=g-v,T=y-m,N=E-b,C=S-w,k=Math.sqrt(x*x+T*T),L=Math.sqrt(N*N+C*C),A=l[7];this._drawLink(t,v,m,g,y,x,T,k,L*A,1,o,u),this._drawLink(t,b,w,E,S,N,C,L,k,1/A,a,f);var O=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(v,m,O,n),t._drawAnchor(g,y,O,r),t._drawAnchor(b,w,O,i),t._drawAnchor(E,S,O,s)},x.prototype._drawLink=function(t,n,r,i,s,o,u,a,f,l,c,h){if(a>b.NORMALIZE_EPSILON){var p=1/a;o*=p,u*=p;var d=.5*(n+i),v=.5*(r+s),m=this._data,g=(m[5]-f)*l;g<0&&(g=0);var y=(m[6]-f)*l;y<0&&(y=0);var w=d-o*g*.5,E=v-u*g*.5,S=d+o*g*.5,x=v+u*g*.5;t.drawLine(w,E,S,x,c);if(isFinite(y)){var T=d-o*y*.5,N=v-u*y*.5,C=d+o*y*.5,k=v+u*y*.5;t.drawLine(T,N,w,E,h),t.drawLine(C,k,S,x,h)}if(!this._stiff){var L=t.constraintSpringNumCoils,A=t.constraintSpringRadius*t.screenToPhysics2D;a>y?(t.drawLinearSpring(T,N,n,r,L,A,h),t.drawLinearSpring(C,k,i,s,L,A,h)):a<g&&(t.drawLinearSpring(w,E,n,r,L,A,c),t.drawLinearSpring(S,x,i,s,L,A,c))}}},N.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,u=this._data,a=this.bodyA._data,f=this.bodyB._data,l=a[2]+u[13],c=a[3]+u[14],h=f[2]+u[15],p=f[3]+u[16],d=u[17],v=u[18],m=u[5],g=u[6];m===Number.NEGATIVE_INFINITY&&(m=-1e20),g===Number.POSITIVE_INFINITY&&(g=1e20);var y=h-l,b=p-c,w=y*d+b*v,E=l+d*m,S=c+v*m,x=l+d*g,T=c+v*g,N;w>m&&(N=Math.min(w,g),t.drawLine(E,S,l+d*N,c+v*N,i)),w<g&&(N=Math.max(w,m),t.drawLine(x,T,l+d*N,c+v*N,s));if(!this._stiff){var C=w<m?E:w>g?x:l+d*w,k=w<m?S:w>g?T:c+v*w,L=t.constraintSpringNumCoils,A=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(C,k,h,p,L,A,o)}var O=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(l,c,O,n),t._drawAnchor(h,p,O,r)},C.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this._data,u=this.bodyA._data,a=this.bodyB._data,f=u[2]+o[11],l=u[3]+o[12],c=a[2]+o[13],h=a[3]+o[14],p=c-f,d=h-l,v=p*p+d*d;if(v>b.NORMALIZE_SQ_EPSILON){var m=Math.sqrt(v),g=1/m;p*=g,d*=g;var y=.5*(f+c),w=.5*(l+h),E=o[5],S=o[6],x=y-p*E*.5,T=w-d*E*.5,N=y+p*E*.5,C=w+d*E*.5;t.drawLine(x,T,N,C,i);if(isFinite(S)){var k=y-p*S*.5,L=w-d*S*.5,A=y+p*S*.5,O=w+d*S*.5;t.drawLine(k,L,x,T,s),t.drawLine(A,O,N,C,s)}if(!this._stiff){var M=t.constraintSpringNumCoils,_=t.constraintSpringRadius*t.screenToPhysics2D;m>S?(t.drawLinearSpring(k,L,f,l,M,_,s),t.drawLinearSpring(A,O,c,h,M,_,s)):m<E&&(t.drawLinearSpring(x,T,f,l,M,_,i),t.drawLinearSpring(N,C,c,h,M,_,i))}}var D=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(f,l,D,n),t._drawAnchor(c,h,D,r)},k.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,s=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB,o=this._data,u=this.bodyA._data,a=this.bodyB._data,f=o[7];this._drawForBody(t,u,a,f,-1,i,s,n),this._drawForBody(t,a,u,1/f,1/f,i,s,r)},k.prototype._drawForBody=function(t,n,r,i,s,o,u,a){var f=this._data,l=f[5],c=f[6],h=r[4]*i+l*s,p=r[4]*i+c*s;if(h>p){var d=h;h=p,p=d}var v=t.constraintSpiralMinRadius*t.screenToPhysics2D,m=t.constraintSpiralDeltaRadius*t.screenToPhysics2D,g=t.constraintAnchorRadius*t.screenToPhysics2D,y=t.constraintSpiralNumCoils,b=n[2],w=n[3],E=n[4],S;E>h?(S=Math.min(E,p),t.drawSpiral(b,w,h,S,v,v+(S-h)*m,o)):!this._stiff&&E<h&&t.drawSpiralSpring(b,w,E,h,v+(E-h)*m,v,y,o),E<p?(S=Math.max(E,h),t.drawSpiral(b,w,S,p,v+(S-h)*m,v+(p-h)*m,u)):!this._stiff&&E>p&&t.drawSpiralSpring(b,w,E,p,v+(E-h)*m,v+(p-h)*m,y,u),t._drawAngleIndicator(b,w,E,v+(E-h)*m,g,a)},L.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,s=this._data,o=this.bodyA._data,u=this.bodyB._data,a=o[2]+s[9],f=o[3]+s[10],l=u[2]+s[11],c=u[3]+s[12],h=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(a,f,h,n),t._drawAnchor(l,c,h,r);if(this._stiff)t.drawLine(a,f,l,c,i);else{var p=t.constraintSpringNumCoils,d=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(a,f,l,c,p,d,i);var v=t.constraintSpiralMinRadius*t.screenToPhysics2D,m=t.constraintSpiralDeltaRadius*t.screenToPhysics2D,g=t.constraintAnchorRadius*t.screenToPhysics2D;p=t.constraintSpiralNumCoils;var y,b;b=o[4],y=u[4]-s[13];var w=this.sleeping?t.constraintErrorSleepingColorA:t.constraintErrorColorA,E=this.sleeping?t.constraintErrorSleepingColorB:t.constraintErrorColorB;t.drawSpiralSpring(o[2],o[3],b,y,v,v+(y-b)*m,p,E),t._drawAngleIndicator(o[2],o[3],b,v,g,w),b=u[4],y=s[13]+o[4],t.drawSpiralSpring(u[2],u[3],b,y,v,v+(y-b)*m,p,w),t._drawAngleIndicator(u[2],u[3],b,v,g,E)}},A.prototype._draw=function(t){var n=this.sleeping?t.constraintSleepingColorA:t.constraintColorA,r=this.sleeping?t.constraintSleepingColorB:t.constraintColorB,i=this.sleeping?t.constraintErrorSleepingColorC:t.constraintErrorColorC,s=this._data,o=this.bodyA._data,u=this.bodyB._data,a=o[2]+s[9],f=o[3]+s[10],l=u[2]+s[11],c=u[3]+s[12],h=t.constraintAnchorRadius*t.screenToPhysics2D;t._drawAnchor(a,f,h,n),t._drawAnchor(l,c,h,r);if(this._stiff)t.drawLine(a,f,l,c,i);else{var p=t.constraintSpringNumCoils,d=t.constraintSpringRadius*t.screenToPhysics2D;t.drawLinearSpring(a,f,l,c,p,d,i)}};var Z=function(){function e(e,t){this.gd=e,this.fm=t,this.bold=!1,this.italic=!1,this.pageWidth=0,this.pageHeight=0,this.baseline=0,this.glyphs=null,this.numGlyphs=0,this.minGlyphIndex=0,this.unknownGlyphIndex="?".charCodeAt(0),this.lineHeight=0,this.pages=null,this.kernings=null,this.textures=[]}return e.prototype.calculateTextDimensions=function(e,t,n,r,i){var s=this.glyphs,o=(this.lineHeight+(r||0))*t,u=s[this.unknownGlyphIndex],a=this.pages?this.pages.length:1,f=0,l=this.lineHeight*t,c=0,h=0,p=[],d=[],v=e.length,m=0,g,y,b,w,E;for(E=0;E<a;E+=1)d[E]=0;for(E=0;E<v;E+=1)g=e.charCodeAt(E),g===10?(m&&(m-=n),p[h]=m,h+=1,f<m&&(f=m),m=0,l+=o):(y=s[g]||u,y&&(b=y.awidth,b?(m+=b*t+n,c+=1):m+=n,w=y.page,d[w]+=1));return p[h]=m,f<m&&(f=m),i?(i.width=f,i.height=l,i.numGlyphs=c,i.linesWidth=p,i.glyphCounts=d,i):{width:f,height:l,numGlyphs:c,linesWidth:p,glyphCounts:d}},e.prototype.generatePageTextVertices=function(e,t,n,r){var i=t.scale||1,s=t.spacing?t.spacing*i:0,o=t.dimensions;o||(o=this.calculateTextDimensions(e,i,s));var u=o.glyphCounts,a=r||{vertices:null,vertexIndex:0},f=u[n];if(0===f)return a;var l=t.rect,c=t.alignment,h=o.linesWidth,p=(this.lineHeight+(t.lineSpacing||0))*i,d=this.kernings,v=this.glyphs,m=this.fm,g=m.reusableArrays,y=0,b=g[f];b?g[f]=null:b=new m.float32ArrayConstructor(f*4*4);var w=h[0],E=l[0],S=l[2],x=l[1],T=E;1===c?T+=(S-w)*.5:2===c&&(T+=S-w);var N=e.length,C=0,k,L,A,O,M,_,D,P,H,B,j,F,I;for(k=0;k<N;k+=1){A=e.charCodeAt(k);if(A===10)x+=p,C+=1,w=h[C],T=E,1===c?T+=(S-w)*.5:2===c&&(T+=S-w);else{I=v[A]||v[this.unknownGlyphIndex];if(I){P=I.awidth*i;if(P){L=I.page||0;if(L===n){O=T+I.xoffset*i,M=x+I.yoffset*i,_=O+I.width*i,D=M+I.height*i,H=I.left,B=I.top,j=I.right,F=I.bottom,b[y+0]=O,b[y+1]=M,b[y+2]=H,b[y+3]=B,b[y+4]=_,b[y+5]=M,b[y+6]=j,b[y+7]=B,b[y+8]=O,b[y+9]=D,b[y+10]=H,b[y+11]=F,b[y+12]=_,b[y+13]=D,b[y+14]=j,b[y+15]=F,y+=16,f-=1;if(0===f)break}T+=P+s;if(d){var q=d[A];if(q&&k<N-1){var R=q[e.charCodeAt(k+1)];R&&(T+=R*i)}}}else T+=s}}}return a.vertices=b,a.vertexIndex=0,a},e.prototype.drawTextRect=function(e,t){var n=t.dimensions;if(!n){var r=t.scale||1,i=t.spacing?t.spacing*r:0;n=this.calculateTextDimensions(e,r,i);var s=t;t={dimensions:n},t.__proto__=s}var o=n.numGlyphs;if(0>=o)return;var u=n.glyphCounts,a=u.length,f,l,c=this.fm.scratchPageContext;for(f=0;f<a;f+=1){l=u[f];if(l){c=this.generatePageTextVertices(e,t,f,c),this.drawTextVertices(c,f,!0),o-=l;if(0===o)break}}},e.prototype.drawTextVertices=function(e,t,n){var r=e.vertices;if(!r)return;var i=this.gd,s=this.fm,o=s.sharedVertexBuffer,u=s.sharedIndexBuffer,a=s.techniqueParameters,f,l,c=r.length>>4;f=c*4;if(!o||f>o.numVertices)o&&o.destroy(),o=this.createVertexBuffer(c),s.sharedVertexBuffer=o;o.setData(r,0,f),i.setStream(o,s.semantics),a.texture=this.textures[t],i.setTechniqueParameters(a);if(4<f){l=c*6;if(!u||l>u.numIndices)u&&u.destroy(),u=this.createIndexBuffer(c),s.sharedIndexBuffer=u;i.setIndexBuffer(u),i.drawIndexed(s.primitive,l,0)}else i.draw(s.primitiveTristrip,4,0);n&&(s.reusableArrays[c]=r)},e.prototype.createIndexBuffer=function(e){var t=this.gd,n={numIndices:6*e,format:"USHORT"},r=t.createIndexBuffer(n),i=r.map();if(i){var s,o,u,a;for(var f=0;f<e;f+=1)s=4*f,o=s+1,u=s+2,a=s+3,i(s,o,u),i(u,o,a);r.unmap(i)}return r},e.prototype.createVertexBuffer=function(e){var t=this.gd;return t.createVertexBuffer({numVertices:4*e,attributes:[t.VERTEXFORMAT_FLOAT2,t.VERTEXFORMAT_FLOAT2],dynamic:!0,"transient":!0})},e.version=1,e}(),et=function(){function e(e){this.primitive=e.PRIMITIVE_TRIANGLES,this.primitiveTristrip=e.PRIMITIVE_TRIANGLE_STRIP,this.semantics=e.createSemantics(["POSITION","TEXCOORD0"]),this.techniqueParameters=e.createTechniqueParameters({texture:null}),this.sharedIndexBuffer=null,this.sharedVertexBuffer=null,this.reusableArrays={},this.scratchPageContext={vertices:null,vertexIndex:0},this.float32ArrayConstructor=Array;if(typeof Float32Array!="undefined"){var t=new Float32Array(4),n=Object.prototype.toString.call(t);n==="[object Float32Array]"&&(this.float32ArrayConstructor=Float32Array)}}return e.prototype.get=function(e){return undefined},e.create=function(t,n,i,s,o){s||(s=function(){});var u={},a={},f={},l={},c=0,h={},p=null,d="",v=i,m=function(t,n,r){var i=Math.floor,s=r/16,o=1/16,u=1/s,a=.5/n.width,f=.5/n.height,l=i(n.width*o),c=i(n.height*u),h=[];h.length=r;for(var p=0;p<r;p+=1){var d=i(p%16)*o-a,v=i(p/16)*u-f;h[p]={width:l,height:c,awidth:l,xoffset:0,yoffset:0,left:d,top:v,right:d+o,bottom:v+u,page:0}}t.lineHeight=c,t.baseline=c,t.glyphs=h,t.numGlyphs=r,t.minGlyphIndex=0},g=function(t){function r(e,t,n){e[t+0]=255,e[t+1]=n&128?255:0,e[t+2]=255,e[t+3]=n&64?255:0,e[t+4]=255,e[t+5]=n&32?255:0,e[t+6]=255,e[t+7]=n&16?255:0,e[t+8]=255,e[t+9]=n&8?255:0,e[t+10]=255,e[t+11]=n&4?255:0,e[t+12]=255,e[t+13]=n&2?255:0,e[t+14]=255,e[t+15]=n&1?255:0}var n=[0,0,0,0,0,0,0,0,126,129,165,129,189,153,129,126,126,255,219,255,195,231,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,124,56,124,16,16,56,124,254,124,56,124,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,62,99,56,108,108,56,204,120,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,48,120,120,120,48,0,48,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,48,124,192,120,12,248,48,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,96,96,192,0,0,0,0,0,24,48,96,96,96,48,24,0,96,48,24,24,24,48,96,0,0,102,60,255,60,102,0,0,0,48,48,252,48,48,0,0,0,0,0,0,0,48,48,96,0,0,0,252,0,0,0,0,0,0,0,0,0,48,48,0,6,12,24,48,96,192,128,0,124,198,206,222,246,230,124,0,48,112,48,48,48,48,252,0,120,204,12,56,96,204,252,0,120,204,12,56,12,204,120,0,28,60,108,204,254,12,30,0,252,192,248,12,12,204,120,0,56,96,192,248,204,204,120,0,252,204,12,24,48,48,48,0,120,204,204,120,204,204,120,0,120,204,204,124,12,24,112,0,0,48,48,0,0,48,48,0,0,48,48,0,0,48,48,96,24,48,96,192,96,48,24,0,0,0,252,0,0,252,0,0,96,48,24,12,24,48,96,0,120,204,12,24,48,0,48,0,124,198,222,222,222,192,120,0,48,120,204,204,252,204,204,0,252,102,102,124,102,102,252,0,60,102,192,192,192,102,60,0,248,108,102,102,102,108,248,0,126,96,96,120,96,96,126,0,126,96,96,120,96,96,96,0,60,102,192,192,206,102,62,0,204,204,204,252,204,204,204,0,120,48,48,48,48,48,120,0,30,12,12,12,204,204,120,0,230,102,108,120,108,102,230,0,96,96,96,96,96,96,126,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,56,108,198,198,198,108,56,0,252,102,102,124,96,96,240,0,120,204,204,204,220,120,28,0,252,102,102,124,108,102,230,0,120,204,224,112,28,204,120,0,252,48,48,48,48,48,48,0,204,204,204,204,204,204,252,0,204,204,204,204,204,120,48,0,198,198,198,214,254,238,198,0,198,198,108,56,56,108,198,0,204,204,204,120,48,48,120,0,254,6,12,24,48,96,254,0,120,96,96,96,96,96,120,0,192,96,48,24,12,6,2,0,120,24,24,24,24,24,120,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,255,0,48,48,24,0,0,0,0,0,0,0,120,12,124,204,118,0,224,96,96,124,102,102,220,0,0,0,120,204,192,204,120,0,28,12,12,124,204,204,118,0,0,0,120,204,252,192,120,0,56,108,96,240,96,96,240,0,0,0,118,204,204,124,12,248,224,96,108,118,102,102,230,0,48,0,112,48,48,48,120,0,12,0,12,12,12,204,204,120,224,96,102,108,120,108,230,0,112,48,48,48,48,48,120,0,0,0,204,254,254,214,198,0,0,0,248,204,204,204,204,0,0,0,120,204,204,204,120,0,0,0,220,102,102,124,96,240,0,0,118,204,204,124,12,30,0,0,220,118,102,96,240,0,0,0,124,192,120,12,248,0,16,48,124,48,48,52,24,0,0,0,204,204,204,204,118,0,0,0,204,204,204,120,48,0,0,0,198,214,254,254,108,0,0,0,198,108,56,108,198,0,0,0,204,204,204,124,12,248,0,0,252,152,48,100,252,0,28,48,48,224,48,48,28,0,24,24,24,0,24,24,24,0,224,48,48,28,48,48,224,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0],i=new Array(32768),s,o,u,a,f,l,c;u=0,l=0,c=256;for(o=0;o<16;o+=1){a=u;for(s=0;s<16;s+=1){for(f=0;f<8;f+=1)r(i,a+f*c,n[l]),l+=1;a+=16}u+=2048}return t.createTexture({name:"defaultFont",width:128,height:64,depth:1,format:"L8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:i})},y=new e(t);if(!v){v=new Z(t,y);var b=g(t);b&&(m(v,b,128),v.textures=[b],v.pageWidth=128,v.pageHeight=64)}u["default"]=v;var w=function(t,n){t.textures=[n],t.pageWidth=n.width,t.pageHeight=n.height;var r=t.glyphs;r||m(t,n,256)},E=function(i,o){function h(){return l[i]-=1,l[i]===0?(delete l[i],delete a[i],c-=1,!0):!1}function m(e,n){var r=u[i];if(!r){h();return}t.createTexture({src:e,mipmaps:!0,onload:n})||(s("Failed to create texture for font '"+i+"'."),delete u[i],h())}var g=u[i];if(!g){if(i in a)o&&f[i].subscribe(o);else{a[i]=!0,l[i]=0,c+=1;var b=r.create();f[i]=b,o&&b.subscribe(o);var E=function(r,o){if(o!==200||!r){s("Failed to load font file: '"+i+"'."),b.notify(null),delete l[i],delete a[i],c-=1,o===404&&(u[i]=v);return}g=new Z(t,y);var E=JSON.parse(r),S=E.bitmapfontlayouts;for(var x in S)if(S.hasOwnProperty(x)){var T=S[x];g.bold=T.bold||!1,g.italic=T.italic||!1,g.pageWidth=T.pagewidth||0,g.pageHeight=T.pageheight||0,g.baseline=T.baseline||0,g.glyphs=T.glyphs||null,g.numGlyphs=T.numglyphs||0,g.minGlyphIndex=T.minglyphindex||0,g.lineHeight=T.lineheight||0,g.pages=T.pages||null,g.kernings=T.kernings||null;break}u[i]=g;var N,C=g.pages;if(C){var k=C.length;l[i]+=k;var L=function(t,n,r){var o=u[i],a=r.pageIdx;if(o){if(t){o.textures[a]=t,h()&&(b.notify(o),delete f[i]);return}s("Failed to load font page: '"+C[a]+"'."),delete u[i]}h()};for(var A=0;A<k;A+=1)N=C[A],n.request({src:p&&p[N]||d+N,onload:L,requestFn:m,pageIdx:A})}else N=i+".dds",n.request({src:p&&p[N]||d+N,onload:function(e){e?(w(g,e),b.notify(g),delete f[i]):(s("Failed to load font page: '"+N+"'."),delete u[i]),delete l[i],delete a[i],c-=1},requestFn:function(e,n){t.createTexture({src:e,mipmaps:!0,onload:n})||(r?s("Failed to create texture for font '"+i+"'."):s("Failed to load font '"+i+"'."),delete u[i],delete l[i],delete a[i],c-=1)}})},S=i,x,T=S.lastIndexOf(".");T!==-1&&(x=S.substr(T));if(!x||x!==".fnt"&&x!==".fontdat")S+=".fontdat";n.request({src:p&&p[S]||d+S,onload:E})}g=v}else o&&TurbulenzEngine.setTimeout(function(){o(g)},0);return g},S=function(t,n){u[t]=u[n],h[t]=!0},x=function(t){t in u&&delete u[t]};return o?(y.load=function(t,n){return o.innerHTML+="FontManager.load:&nbsp;'"+t+"'",E(t,n)},y.map=function(t,n){o.innerHTML+="FontManager.map:&nbsp;'"+n+"' -> '"+t+"'",S(t,n)},y.remove=function(t){o.innerHTML+="FontManager.remove:&nbsp;'"+t+"'",x(t)}):(y.load=E,y.map=S,y.remove=x),y.get=function(t){var n=u[t];return n?n:v},y.getAll=function(){return u},y.getNumPendingFonts=function(){return c},y.isFontLoaded=function(t){return!a[t]},y.isFontMissing=function(t){return!u[t]},y.setPathRemapping=function(t,n){p=t,d=n},y.calculateTextDimensions=function(t,n,r,i){var s=u[t];return s?s.calculateTextDimensions(n,r,i):{width:0,height:0,numGlyphs:0,linesWidth:[],glyphCounts:[]}},y.reuseVertices=function(t){this.reusableArrays[t.length>>4]=t},y.destroy=function(){if(u){var r;for(r in u)if(u.hasOwnProperty(r)){var i=u[r];if(i){var s=i.texture;s&&(s.destroy(),i.texture=null)}}u=null}this.sharedVertexBuffer&&(this.sharedVertexBuffer.destroy(),this.sharedVertexBuffer=null),this.sharedIndexBuffer&&(this.sharedIndexBuffer.destroy(),this.sharedIndexBuffer=null),this.techniqueParameters=null,this.semantics=null,a=null,l=null,f=null,l=null,c=0,h=null,p=null,d=null,n=null,t=null},y},e.version=1,e}(),tt=function(){function e(){this.version=1}return e.prototype.setSelectedRadio=function(e,t){var n=this.radioControls[e],r;n&&(r=n.controls[t],r&&(n.selected=t,this.updateRadio(r.id,!0)))},e.prototype.addRadioControl=function(e){var t=this.radioControls,n=e.groupName,r=e.radioIndex,i=e.id,s=e.fn,o=e.isDefault;if(n===undefined||n===null||
r<0||i===undefined||i===null||s===undefined||s===null)return;var u=t[n];u||(t[n]={},u=t[n],u.controls=[],u.selected=0),u.controls[r]=e,o&&(u.selected=r),this.updateRadio(i,o)},e.prototype.addCheckboxControl=function(e){var t=this.checkboxControls,n=e.id,r=e.value;t[r]=e,this.updateCheckbox(n,e.isSelected)},e.prototype.addButtonControl=function(e){var t=this.buttonControls,n=e.id;t[n]=e},e.prototype.addSliderControl=function(e){var t=this.sliderControls;t[e.id]=e},e.prototype.getSliderValue=function(e){var t=window.$("#"+e).value;return t?parseInt(t,10):undefined},e.prototype.getHandler=function(){var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls;return function(r){var i;r||(r=window.event),r.target?i=r.target:r.srcElement&&(i=r.srcElement),i.nodeType===3&&(i=i.parentNode);var s=i.id,o;switch(i.type){case"radio":for(var u in e)if(e.hasOwnProperty(u)){var a=0,f=e[u].controls,l=f.length;while(a<l){o=f[a];if(o.id===s){o.fn();return}a+=1}}break;case"checkbox":for(var c in t)if(t.hasOwnProperty(c)){o=t[c];if(o.id===s){var h=o.fn();h!==undefined&&(document.getElementById(o.id).checked=!!h);return}}break;case"button":for(var p in n)if(n.hasOwnProperty(p)){o=n[p];if(p===s){o.fn();return}}break;default:}}},e.prototype.register=function(){function d(e){return function(t,n){var r=window.$("#"+e+"input");r.val(n.value),r.change()}}function v(e,t){return function(){var n=parseFloat(this.value);if(!window.$)return;var r=window.$("#"+t),i=window.$("#"+t+"input");if(!r||!i)return;var s=r.slider("value");if(n===undefined||isNaN(n)||s===undefined||isNaN(s)||s===n)return;var o=r.slider("option","min"),u=r.slider("option","max");n<o?n=o:n>u&&(n=u),i.val(n),e.value=n,e.fn()}}var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls,r=this.sliderControls,i,s,o;for(var u in e)if(e.hasOwnProperty(u)){var a=e[u].selected,f=e[u].controls,l=f.length;for(var c=0;c<l;c+=1)i=f[c],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.name=i.groupName,s.onclick=this.getHandler(),s.checked=a===i.radioIndex?"checked":"")}for(var h in t)t.hasOwnProperty(h)&&(i=t[h],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler(),s.checked=i.isSelected?"checked":""));for(var p in n)n.hasOwnProperty(p)&&(i=n[p],o=p,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler()));for(var m in r)if(r.hasOwnProperty(m)){i=r[m],o=i.id;if(!window.$)return;var g=window.$("#"+o),y=window.$("#"+o+"input");if(!g||!y)return;g.slider({value:i.value,min:i.min,max:i.max,step:i.step,slide:d(o)}),y.val(g.slider("value")),y.change(v(i,o))}this.registered=!0},e.prototype.updateRadio=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateCheckbox=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateSlider=function(e,t){if(!this.registered)return;if(window.$){var n=window.$("#"+e);n&&n.slider("option","value",t)}},e.create=function(){var t=new e;return t.radioControls={},t.checkboxControls={},t.buttonControls={},t.sliderControls={},t.registered=!1,t},e}();TurbulenzEngine.onload=function(){function v(){p.createMappingTable(a,d,function(e){var t=e.urlMapping,n=e.assetPrefix;l.setPathRemapping(t,n),f.setPathRemapping(t,n),f.load("fonts/hero.fnt",function(e){c=e}),l.load("shaders/font.cgfx",function(e){h=e})})}function N(){function a(e,t,n,r){var i=m.createRigidBody({shapes:[m.createCircleShape({radius:n})],position:[e,t]});S.addRigidBody(i);if(r){var s=m.createPointConstraint({bodyA:x,bodyB:i,anchorA:[e,t],anchorB:[0,0],userData:"pin"});S.addConstraint(s)}return i}S.clear(),T=null;var e=m.createRigidBody({type:"static"}),t=.01,i;for(i=0;i<=4;i+=1){var o=y/4*i;e.addShape(m.createPolygonShape({vertices:m.createRectangleVertices(o-t,0,o+t,b)}))}for(i=0;i<=2;i+=1){var u=b/2*i;e.addShape(m.createPolygonShape({vertices:m.createRectangleVertices(0,u-t,y,u+t)}))}S.addRigidBody(e);var f,l,c;f=a(3.3,5,1),l=a(6.6,5,1),c=[5,5];var h=m.createPointConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),stiff:!n,frequency:r,damping:s});S.addConstraint(h),f=a(13.3,5,1),l=a(16.6,5,1),c=[15,5];var p=m.createWeldConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),phase:0,stiff:!n,frequency:r,damping:s});S.addConstraint(p),f=a(23.3,5,1),l=a(26.6,5,1);var d=m.createDistanceConstraint({bodyA:f,bodyB:l,anchorA:[1,0],anchorB:[-1,0],lowerBound:1,upperBound:3,stiff:!n,frequency:r,damping:s});S.addConstraint(d),f=a(33.3,5,1),l=a(36.6,5,1),c=[35,5];var v=m.createLineConstraint({bodyA:f,bodyB:l,anchorA:f.transformWorldPointToLocal(c),anchorB:l.transformWorldPointToLocal(c),axis:[0,1],lowerBound:-1,upperBound:1,stiff:!n,frequency:r,damping:s});S.addConstraint(v),f=a(3,15,1.5,!0),l=a(7,15,1.5,!0);var g=m.createAngleConstraint({bodyA:f,bodyB:l,ratio:3,lowerBound:-Math.PI*2,upperBound:Math.PI*2,stiff:!n,frequency:r,damping:s});S.addConstraint(g),f=a(13,15,1.5,!0),l=a(17,15,1.5,!0);var w=m.createMotorConstraint({bodyA:f,bodyB:l,ratio:4,rate:20});S.addConstraint(w);var E;f=a(23.3,16.6,.5),l=a(25,13.3,1,!0),E=a(26.6,16.6,.5);var N=m.createDistanceConstraint({bodyA:f,bodyB:l,lowerBound:.25,upperBound:Number.POSITIVE_INFINITY,anchorA:[0,-0.5],anchorB:[-1,0],userData:"pin"});S.addConstraint(N);var C=m.createDistanceConstraint({bodyA:E,bodyB:l,lowerBound:.25,upperBound:Number.POSITIVE_INFINITY,anchorA:[0,-0.5],anchorB:[1,0],userData:"pin"});S.addConstraint(C);var k=m.createPulleyConstraint({bodyA:f,bodyB:l,bodyC:l,bodyD:E,anchorA:[0,-0.5],anchorB:[-1,0],anchorC:[1,0],anchorD:[0,-0.5],ratio:2,lowerBound:6,upperBound:8,stiff:!n,frequency:r,damping:s});S.addConstraint(k),f=a(35,13.3,1),l=a(35,16.6,1,!0);var L=m.createLineConstraint({bodyA:x,bodyB:f,anchorA:[35,13.3],anchorB:[0,0],axis:[1,0],lowerBound:-5,upperBound:5,userData:"pin"});S.addConstraint(L);var A=m.createCustomConstraint({bodies:[f,l],dimension:1,position:function(t,n){var r=this.bodies[0],i=this.bodies[1];t[n]=Math.PI/5*(r.getPosition()[0]-35)-i.getRotation()},jacobian:function(t,n){t[n]=Math.PI/5,t[n+1]=0,t[n+2]=0,t[n+3]=0,t[n+4]=0,t[n+5]=-1},debugDraw:function(t,n){if(n)return;var r=this.bodies[0],i=this.bodies[1],s=r.getPosition(),o=i.getPosition(),u=i.getRotation()/(Math.PI/5)+35,a=Math.PI/5*(s[0]-35),f=3*t.screenToPhysics2D;t.drawLinearSpring(s[0],s[1],u,s[1],3,f,[1,0,0,1]),t.drawSpiralSpring(o[0],o[1],a,i.getRotation(),f,f*2,[0,0,1,1])},stiff:!n,frequency:r,damping:s});S.addConstraint(A)}function C(){var e=S.constraints,t=e.length,i;for(i=0;i<t;i+=1){var o=e[i];if(o===T||o.userData==="pin")continue;o.configure({stiff:!n,frequency:r,damping:s})}}function q(){function n(e,t,n,r){var i=w.viewportUnmap(e,t),s=w.viewportUnmap(e+10,t+r);c.drawTextRect(n,{rect:[i[0],i[1],s[0]-i[0],s[1]-i[1]],scale:1,spacing:0,alignment:1})}if(!o.beginFrame())return;k.update(),o.clear([.3,.3,.3,1]),T&&T.setAnchorA(w.viewportMap(O,M));var e=TurbulenzEngine.time,t=e-j;t>.05&&(t=.05),B+=t,j=e;while(S.simulatedTime<B)S.step(1/60);E.setScreenViewport(w.getScreenSpaceViewport()),E.begin(),E.drawWorld(S),E.end(),o.setTechnique(F),I.clipSpace=u.v4Build(2/o.width,-2/o.height,-1,1,I.clipSpace),o.setTechniqueParameters(I);var r=.75;n(0,0,"Point",r),n(10,0,"Weld",r),n(20,0,"Distance",r),n(30,0,"Line",r),n(0,10,"Angle",r),n(10,10,"Motor",r),n(20,10,"Pulley",r),n(30,10,"Custom",r),o.endFrame()}function U(){c&&h&&(F=h.getTechnique("font"),I=o.createTechniqueParameters({clipSpace:u.v4BuildZero(),alphaRef:.01,color:u.v4BuildOne()}),TurbulenzEngine.clearInterval(R),R=TurbulenzEngine.setInterval(q,1e3/60))}function z(){t=tt.create(),t.addCheckboxControl({id:"elasticConstraints",value:"elasticConstraints",isSelected:n,fn:function(){return n=!n,C(),n}}),t.addSliderControl({id:"frequencySlider",value:r,max:10,min:.25,step:.25,fn:function(){r=this.value,t.updateSlider("frequencySlider",r),n&&C()}}),t.addSliderControl({id:"dampingSlider",value:s,max:2,min:0,step:.25,fn:function(){s=this.value,t.updateSlider("dampingSlider",s),n&&C()}}),t.register()}var t,n=!1,r=1,s=.1,o=TurbulenzEngine.createGraphicsDevice({}),u=TurbulenzEngine.createMathDevice({}),a=i.create({}),f=et.create(o,a),l=g.create(o,a),c,h,d;d=p.createGameSession(a,v);var m=X.create(),y=40,b=20,w=K.create({graphicsDevice:o}),E=Y.create({graphicsDevice:o});w.configure({viewportRectangle:[0,0,y,b],scaleMode:"scale"}),E.setPhysics2DViewport([0,0,y,b]);var S=m.createWorld({gravity:[0,20]}),x=m.createRigidBody({type:"static"});S.addRigidBody(x);var T=null;N();var k=TurbulenzEngine.createInputDevice({}),L=k.keyCodes,A=k.mouseCodes,O=0,M=0,_=function(t,n){O=t,M=n};k.addEventListener("mouseover",_);var D=function(t){t===L.R&&N()};k.addEventListener("keyup",D);var P=function(t,n,r){O=n,M=r;if(T)return;var i=w.viewportMap(n,r),s;if(t===A.BUTTON_0){var o=[],u=S.bodyPointQuery(i,o),a;for(a=0;a<u;a+=1)s=o[a],s.isDynamic()&&(T=m.createPointConstraint({bodyA:x,bodyB:s,anchorA:i,anchorB:s.transformWorldPointToLocal(i),stiff:!1,maxForce:1e5}),S.addConstraint(T))}};k.addEventListener("mousedown",P);var H=function(){T&&(S.removeConstraint(T),T=null)};k.addEventListener("mouseleave",H),k.addEventListener("mouseup",H);var B=0,j=TurbulenzEngine.time,F,I,R=0;R=TurbulenzEngine.setInterval(U,100),z(),TurbulenzEngine.onunload=function(){R&&TurbulenzEngine.clearInterval(R),d&&(d.destroy(),d=null)}};if(!TurbulenzEngine.onload){window.alert("Entry point 'TurbulenzEngine.onload' must be defined.");return}TurbulenzEngine.onload.call(this)})();