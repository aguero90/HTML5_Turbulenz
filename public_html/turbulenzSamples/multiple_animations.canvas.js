(function(){function Ht(e,t,n){var r=e*65536+t%65536;return n&&(r+=1/(1+n)),r}function Bt(e){var t={far:e.sharedMaterial.meta.far};e.rendererInfo=t;var n=e.sharedMaterial.effect;return n.prepare&&n.prepare(e),t}var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(n,r){r===undefined&&(r=new e(9));var i=h*m-p*v,s=p*d-c*m,o=c*v-h*d,u=a*i+f*s+l*o;if(u===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var a=n[0],f=n[1],l=n[2],c=n[3],h=n[4],p=n[5],d=n[6],v=n[7],m=n[8],g=1/u;return r[0]=i*g,r[1]=(v*l-m*f)*g,r[2]=(f*p-l*h)*g,r[3]=s*g,r[4]=(m*a-d*l)*g,r[5]=(c*l-a*p)*g,r[6]=o*g,r[7]=(d*f-v*a)*g,r[8]=(a*h-c*f)*g,r},m33InverseTranspose:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=f*p-l*h,v=l*c-a*p,m=a*h-f*c,g=s*d+o*v+u*m;if(g===0)i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0;else{var y=1/g;i[0]=d*y,i[3]=(h*u-p*o)*y,i[6]=(o*l-u*f)*y,i[1]=v*y,i[4]=(p*s-c*u)*y,i[7]=(a*u-s*l)*y,i[2]=m*y,i[5]=(c*o-h*s)*y,i[8]=(s*f-a*o)*y}return i},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=a*h-f*c,g=f*l-u*h,y=u*c-a*l,b=i*m+s*g+o*y;if(b===0)return r;r===undefined&&(r=new e(12));var w=1/b;return r[0]=m*w,r[1]=(c*o-h*s)*w,r[2]=(s*f-o*a)*w,r[3]=g*w,r[4]=(h*i-l*o)*w,r[5]=(u*o-i*f)*w,r[6]=y*w,r[7]=(l*s-c*i)*w,r[8]=(i*a-u*s)*w,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*w,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*w,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*w,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a,s[1]=n[1]*o+n[4]*u+n[7]*a,s[2]=n[2]*o+n[5]*u+n[8]*a,s},m43TransformPoint:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a+n[9],s[1]=n[1]*o+n[4]*u+n[7]*a+n[10],s[2]=n[2]*o+n[5]*u+n[8]*a+n[11],s},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===
undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}t.arrayConstructor=e,TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",i=t.method,s=t.data||{},o=t.encrypt,u=null,a=t.url,f=t.requestHandler,l=t.callback;if(o){s.requestUrl=a;var c=JSON.stringify(s);i==="POST"&&(c=TurbulenzEngine.encrypt(c)),n+="data="+encodeURIComponent(c)+"&",n+="gameSessionId="+encodeURIComponent(s.gameSessionId),u=TurbulenzEngine.generateSignature(c)}else if(s){var h;for(h in s)s.hasOwnProperty(h)&&(n.length!==0&&(n+="&"),i==="POST"?n+=h+"="+s[h]:n+=encodeURIComponent(h)+"="+encodeURIComponent(s[h]))}var p=function(t,n){var i=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;if(i.getResponseHeader("Content-Type")!=="application/json; charset=utf-8")TurbulenzEngine.setTimeout(function(){l({msg:"HttpStatus "+n+" "+r.ajaxStatusCodes[n]},n),l=null},0);else{var s=JSON.parse(t);if(o){var u=i.getResponseHeader("X-TZ-Signature"),f=TurbulenzEngine.verifySignature(t,u);t=null,TurbulenzEngine.setTimeout(function(){var e=s.requestUrl;if(f)if(!TurbulenzEngine.encryptionEnabled||e===a){l(s,n),l=null;return}n===400?l(s,n,"Verification Failed"):l({msg:"Verification failed",ok:!1},400,"Verification Failed"),l=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){l(s,n),l=null},0)}},d=function(r,s,o){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}o.xhr=a;var f=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(o,t,n)}};a.open(i,n&&i!=="POST"?r+"?"+n:r,!0),l&&(a.onreadystatechange=f),u&&a.setRequestHeader("X-TZ-Signature",u),i==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(f)f.request({src:a,requestFn:d,responseFilter:t.responseFilter,onload:p});else{var v={src:a};d(a,p,v)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},i={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},s=function(){function e(){}return e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=l.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){var n=new e;return n.object=t,n.referenceCount=0,n},e.version=1,e}(),o={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,u;for(u in this.profiles)this.profiles.hasOwnProperty(u)&&(i=this.profiles[u],s<i.duration&&(s=i.duration),r.push(i));var a;t===o.sortMode.alphabetical?a=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===o.sortMode.max?a=function(t,n){return n.max-t.max}:t===o.sortMode.min?a=function(t,n){return n.min-t.min}:t===o.sortMode.calls?a=function(t,n){return n.calls-t.calls}:a=function(t,n){return n.duration-t.duration},r.sort(a);var f,l="",c=n?n.precision:8,h=n?n.percentagePrecision:1,p=n?n.seperator:" ",d=r.length,v,m,g;for(g=0;g<d;g+=1)i=r[g],f=i.name,f+=p+i.calls,f+=p+i.duration.toFixed(c),f+=p+i.max.toFixed(c),f+=p+i.min.toFixed(c),m=i.duration/i.calls,f+=p+m.toFixed(c),v=Math.sqrt(i.sumOfSquares/i.calls-m*m),f+=p+v.toFixed(c),f+=p+(100*i.duration/s).toFixed(h)+"%\n",l+=f;return l}},u={};u.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},u.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var a=function(){function e(e,t,n){return this.escapeNodeOffset=t,this.externalNode=n,this.extents=e,this}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s,o,u){this.escapeNodeOffset=o,this.externalNode=u;var a=this.extents;a[0]=e,a[1]=t,a[2]=n,a[3]=r,a[4]=i,a[5]=s},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=t,e[3]=-t,e[4]=-t,e[5]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),f=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e,this.ignoreY=!1,this.nodesStack=new Array(32)}return e.allocateNode=function(){var e=this.nodesPool;if(!e.length){var t=this.nodesPoolAllocationSize,n=this.useFloat32Array,r,i;n&&(r=new Float32Array(t*6),i=0);var s,o;for(s=0;s<t;s+=1)n?(o=r.subarray(i,i+6),i+=6):o=[0,0,0,0,0,0],e[s]=a.create(o,1,undefined)}return e.pop()},e.releaseNode=function(e){var t=this.nodesPool;t.length<this.nodesPoolAllocationSize&&(e.clear(),t.push(e))},e.recycleNodes=function(e,t){var n=e.length,r;for(r=t;r<n;r+=1){var i=e[r];i&&this.releaseNode(i)}e.length=t},e.prototype.add=function(t,n){var r=this.endNode;t.spatialIndex=r;var i=e.allocateNode();i.escapeNodeOffset=1,i.externalNode=t;var s=i.extents;s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],this.nodes[r]=i,this.endNode=r+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.spatialIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.spatialIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.spatialIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=this.needsRebuild,l=this.needsRebound,c=this.nodes,h=c[n],p=h.extents,d=f||l||p[0]>r||p[1]>i||p[2]>s||p[3]<o||p[4]<u||p[5]<a;p[0]=r,p[1]=i,p[2]=s,p[3]=o,p[4]=u,p[5]=a;if(d&&!f&&1<c.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!l)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var v=this.findParent(n),m=v.extents;if(m[0]>r||m[1]>i||m[2]>s||m[3]<o||m[4]<u||m[5]<a)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=this.nodesStack,i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3],g=h[4],y=h[5];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v>h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),g<h[4]&&(g=h[4]),y<h[5]&&(y=h[5]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,h[4]=g,h[5]=y,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var t=this.nodes,n,r,i,s;if(this.numExternalNodes===t.length)r=t,i=t.length,t=[],this.nodes=t;else{r=[],r.length=this.numExternalNodes,i=0,s=this.endNode;for(n=0;n<s;n+=1){var o=t[n];o.externalNode&&(t[n]=undefined,r[i]=o,i+=1)}r.length>i&&(r.length=i)}var u;if(i>1){i>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this._sortNodesHighQuality(r):this.ignoreY?this._sortNodesNoY(r):this._sortNodes(r));var a=this._predictNumNodes(0,i,0);t.length>a&&e.recycleNodes(t,a),this._recursiveBuild(r,0,i,0),s=t[0].escapeNodeOffset,t.length>s&&e.recycleNodes(t,s),this.endNode=s,u=t[0];var f=u.extents,l=f[3]-f[0],c=f[4]-f[1],h=f[5]-f[2];this.ignoreY=4*c<(l<=h?l:h)}else u=r[0],u.externalNode.spatialIndex=0,t.length=1,t[0]=u,this.endNode=1;r=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype._sortNodes=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return-(t[0]+t[3])}function u(e){var t=e.extents;return-(t[1]+t[4])}function a(e){var t=e.extents;return-(t[2]+t[5])}function h(e,n,p){var d=n+p>>1;c===0?l?f(e,n,d,p,o):f(e,n,d,p,r):c===2?l?f(e,n,d,p,a):f(e,n,d,p,s):l?f(e,n,d,p,u):f(e,n,d,p,i),c===0?c=2:c===2?c=1:c=0,l=!l,n+t<d&&h(e,n,d),d+t<p&&h(e,d,p)}var t=this.numNodesLeaf,n=e.length,f=this._nthElement,l=!1,c=0;h(e,0,n)},e.prototype._sortNodesNoY=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[2]+t[5]}function s(e){var t=e.extents;return-(t[0]+t[3])}function o(e){var t=e.extents;return-(t[2]+t[5])}function l(e,n,c){var h=n+c>>1;f===0?a?u(e,n,h,c,s):u(e,n,h,c,r):a?u(e,n,h,c,o):u(e,n,h,c,i),f===0?f=2:f=0,a=!a,n+t<h&&l(e,n,h),h+t<c&&l(e,h,c)}var t=this.numNodesLeaf,n=e.length,u=this._nthElement,a=!1,f=0;l(e,0,n)},e.prototype._sortNodesHighQuality=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return t[0]+t[2]+t[3]+t[5]}function u(e){var t=e.extents;return t[0]-t[2]+t[3]-t[5]}function a(e){var t=e.extents;return-(t[0]+t[3])}function f(e){var t=e.extents;return-(t[1]+t[4])}function l(e){var t=e.extents;return-(t[2]+t[5])}function c(e){var t=e.extents;return-(t[0]+t[2]+t[3]+t[5])}function h(e){var t=e.extents;return-(t[0]-t[2]+t[3]-t[5])}function m(e,n,g){var y=n+g>>1;p(e,n,y,g,r);var b=d(e,n,y)+d(e,y,g);p(e,n,y,g,i);var w=d(e,n,y)+d(e,y,g);p(e,n,y,g,s);var E=d(e,n,y)+d(e,y,g);p(e,n,y,g,o);var S=d(e,n,y)+d(e,y,g);p(e,n,y,g,u);var x=d(e,n,y)+d(e,y,g);b<=w&&b<=E&&b<=S&&b<=x?v?p(e,n,y,g,a):p(e,n,y,g,r):E<=w&&E<=S&&E<=x?v?p(e,n,y,g,l):p(e,n,y,g,s):w<=S&&w<=x?v?p(e,n,y,g,f):p(e,n,y,g,i):S<=x?v?p(e,n,y,g,c):p(e,n,y,g,o):v?p(e,n,y,g,h):p(e,n,y,g,u),v=!v,n+t<y&&m(e,n,y),y+t<g&&m(e,y,g)}var t=this.numNodesLeaf,n=e.length,p=this._nthElement,d=this._calculateSAH,v=!1;m(e,0,n)},e.prototype._calculateSAH=function(e,t,n){var r,i,s,o,u,a,f,l;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5];for(var c=t+1;c<n;c+=1)r=e[c],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u>i[2]&&(u=i[2]),a<i[3]&&(a=i[3]),f<i[4]&&(f=i[4]),l<i[5]&&(l=i[5]);return a-s+(f-o)+(l-u)},e.prototype._nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype._recursiveBuild=function(t,n,r,i){var s=this.nodes,o=i;i+=1;var u,a,f,l,c,h,p,d,v;if(n+this.numNodesLeaf>=r){d=t[n],p=d.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);for(var m=n+1;m<r;m+=1)d=t[m],p=d.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5]),i+=1,d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);v=s[i]}else{var g=n+r>>1;n+1>=g?(d=t[n],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,n,g,i),v=s[i],p=v.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],i+=v.escapeNodeOffset,g+1>=r?(d=t[g],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,g,r,i),v=s[i],p=v.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5])}var y=s[o];y===undefined&&(s[o]=y=e.allocateNode()),y.reset(u,a,f,l,c,h,i+v.escapeNodeOffset-o)},e.prototype._replaceNode=function(t,n,r){var i=t[n];t[n]=r,i!==undefined&&e.releaseNode(i)},e.prototype._predictNumNodes=function(e,t,n){n+=1;if(e+this.numNodesLeaf>=t)n+=t-e;else{var r=e+t>>1;e+1>=r?n+=1:n=this._predictNumNodes(e,r,n),r+1>=t?n+=1:n=this._predictNumNodes(r,t,n)}return n},e.prototype.getVisibleNodes=function(e,t,n){var r=0;if(this.numExternalNodes>0){var i=this.nodes,s=this.endNode,o=e.length,u=n===undefined?t.length:n,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=0;for(;;){a=i[T],f=a.extents,c=f[0],h=f[1],p=f[2],d=f[3],v=f[4],m=f[5],g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w<0?c:d)+E*(E<0?h:v)+S*(S<0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g)if(a.externalNode){t[u]=a.externalNode,u+=1,r+=1,T+=1;if(T>=s)break}else{g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w>0?c:d)+E*(E>0?h:v)+S*(S>0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g){l=T+a.escapeNodeOffset,T+=1;do a=i[T],a.externalNode&&(t[u]=a.externalNode,u+=1,r+=1),T+=1;while(T<l);if(T>=s)break}else T+=1}else{T+=a.escapeNodeOffset;if(T>=s)break}}}return r},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=this.nodes,l=this.endNode,c,h,p,d=0,v=n===undefined?t.length:n,m=0;for(;;){c=f[m],h=c.extents;var g=h[0],y=h[1],b=h[2],w=h[3],E=h[4],S=h[5];if(r<=w&&i<=E&&s<=S&&o>=g&&u>=y&&a>=b)if(c.externalNode){t[v]=c.externalNode,v+=1,d+=1,m+=1;if(m>=l)break}else if(o>=w&&u>=E&&a>=S&&r<=g&&i<=y&&s<=b){p=m+c.escapeNodeOffset,m+=1;do c=f[m],c.externalNode&&(t[v]=c.externalNode,v+=1,d+=1),m+=1;while(m<p);if(m>=l)break}else m+=1;else{m+=c.escapeNodeOffset;if(m>=l)break}}return d}return 0},e.prototype.getSphereOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=e[2],u=this.nodes,a=this.endNode,f,l,c=n.length,h=0;for(;;){f=u[h],l=f.extents;var p=l[0],d=l[1],v=l[2],m=l[3],g=l[4],y=l[5],b=0,w;i<p?(w=p-i,b+=w*w):i>m&&(w=i-m,b+=w*w),s<d?(w=d-s,b+=w*w):s>g&&(w=s-g,b+=w*w),o<v?(w=v-o,b+=w*w):o>y&&(w=o-y,b+=w*w);if(b<=r){h+=1;if(f.externalNode){n[c]=f.externalNode,c+=1;if(h>=a)break}}else{h+=f.escapeNodeOffset;if(h>=a)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3],m=u[4],g=u[5];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[3]&&p<=u[4]&&d<=u[5]&&v>=u[0]&&m>=u[1]&&g>=u[2]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getExtents=function(){return 0<this.nodes.length?this.nodes[0].extents:null},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes.length&&e.recycleNodes(this.nodes,0),this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.ignoreY=!1},e.rayTest=function(e,t,n){function d(e,t){var n=e[0],r=e[1],i=e[2],d=e[3],v=e[4],m=e[5];if(n<=s&&s<=d&&r<=o&&o<=v&&i<=u&&u<=m)return 0;var g,y,b,w,E;a>=0?(E=n-s,g=E===0?0:E*c,E=d-s,y=E===0?0:E*c):(g=(d-s)*c,y=(n-s)*c),f>=0?(E=r-o,b=E===0?0:E*h,E=v-o,w=E===0?0:E*h):(b=(v-o)*h,w=(r-o)*h);if(g>w||b>y)return undefined;b>g&&(g=b),w<y&&(y=w);var S,x;return l>=0?(E=i-u,S=E===0?0:E*p,E=m-u,x=E===0?0:E*p):(S=(m-u)*p,x=(i-u)*p),g>x||S>y?undefined:(S>g&&(g=S),x<y&&(y=x),g<0&&(g=y),0<=g&&g<t?g:undefined)}function g(e,r,i){var s=e.getNodes(),o=s[r],u=d(o.extents,i);if(u===undefined)return i;if(o.externalNode){var a=n(e,o.externalNode,t,u,i);a&&(m=a,i=a.factor)}else{var f=v.length,l;for(l=0;l<f;l+=1){var c=v[l];if(u>c.distance)break}v.splice(l-1,0,{tree:e,nodeIndex:r,distance:u})}return i}var r=t.origin,i=t.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=1/a,h=1/f,p=1/l,v=[],m=null,y=t.maxFactor,b,w;for(w=0;w<e.length;w+=1)b=e[w],b.endNode!==0&&(y=g(b,0,y));while(v.length!==0){var E=v.pop();if(E.distance>=y)continue;var S=E.nodeIndex;b=E.tree;var x=b.getNodes(),T=x[S],N=S+T.escapeNodeOffset,C=S+1;do y=g(b,C,y),C+=x[C].escapeNodeOffset;while(C<N)}return m},e.create=function(t){return new e(t?!0:!1)},e.version=1,e.useFloat32Array=!1,e.nodesPoolAllocationSize=128,e.nodesPool=[],e}();(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(f.useFloat32Array=!0)}})();var l=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var t=new e;return t.subscribers=[],t},e}(),c=function(){function e(){}return e.prototype.processBytes=function(t,n){if(!this.isValidHeader(t)){this.onerror(n);return}var r=4,i=this.parseHeader(t,r);r+=124,this.width=i.dwWidth,this.height=i.dwHeight,i.dwCaps2&this.DDSF_VOLUME&&i.dwDepth>0?this.depth=i.dwDepth:this.depth=1,i.dwFlags&this.DDSF_MIPMAPCOUNT?this.numLevels=i.dwMipMapCount:this.numLevels=1;if(i.dwCaps2&this.DDSF_CUBEMAP){var s=0;s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEX?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEX?1:0
,s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEY?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEY?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_POSITIVEZ?1:0,s+=i.dwCaps2&this.DDSF_CUBEMAP_NEGATIVEZ?1:0;if(s!==6||this.width!==this.height){this.onerror(n);return}this.numFaces=s}else this.numFaces=1;var o=!1,u=0,a=this.gd;if(i.ddspf.dwFlags&this.DDSF_FOURCC)switch(i.ddspf.dwFourCC){case this.FOURCC_DXT1:this.format=a.PIXELFORMAT_DXT1,u=8,o=!0;break;case this.FOURCC_DXT2:case this.FOURCC_DXT3:this.format=a.PIXELFORMAT_DXT3,u=16,o=!0;break;case this.FOURCC_DXT4:case this.FOURCC_DXT5:case this.FOURCC_RXGB:this.format=a.PIXELFORMAT_DXT5,u=16,o=!0;break;case this.FOURCC_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,u=3;break;case this.FOURCC_A8R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;break;case this.FOURCC_R5G6B5:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,u=2;break;case this.FOURCC_A8:this.format=a.PIXELFORMAT_A8,u=1;break;case this.FOURCC_A8B8G8R8:this.format=a.PIXELFORMAT_R8G8B8A8,u=4;break;case this.FOURCC_L8:this.format=a.PIXELFORMAT_L8,u=1;break;case this.FOURCC_A8L8:this.format=a.PIXELFORMAT_L8A8,u=2;break;case this.FOURCC_UNKNOWN:case this.FOURCC_ATI1:case this.FOURCC_ATI2:case this.FOURCC_X8R8G8B8:case this.FOURCC_X8B8G8R8:case this.FOURCC_A2B10G10R10:case this.FOURCC_A2R10G10B10:case this.FOURCC_A16B16G16R16:case this.FOURCC_R16F:case this.FOURCC_A16B16G16R16F:case this.FOURCC_R32F:case this.FOURCC_A32B32G32R32F:case this.FOURCC_L16:case this.FOURCC_X1R5G5B5:case this.FOURCC_A1R5G5B5:case this.FOURCC_A4R4G4B4:case this.FOURCC_R3G3B2:case this.FOURCC_A8R3G3B2:case this.FOURCC_X4R4G4B4:case this.FOURCC_A4L4:case this.FOURCC_D16_LOCKABLE:case this.FOURCC_D32:case this.FOURCC_D24X8:case this.FOURCC_D16:case this.FOURCC_D32F_LOCKABLE:case this.FOURCC_G16R16:case this.FOURCC_G16R16F:case this.FOURCC_G32R32F:break;default:this.onerror(n);return}else if(i.ddspf.dwFlags===this.DDSF_RGBA&&i.ddspf.dwRGBBitCount===32)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680&&i.ddspf.dwABitMask===4278190080?this.format=a.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===32)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680?this.format=a.PIXELFORMAT_R8G8B8A8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8A8,u=4;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===24)i.ddspf.dwRBitMask===255&&i.ddspf.dwGBitMask===65280&&i.ddspf.dwBBitMask===16711680?this.format=a.PIXELFORMAT_R8G8B8:this.bgrFormat=this.BGRPIXELFORMAT_B8G8R8,u=3;else if(i.ddspf.dwFlags===this.DDSF_RGB&&i.ddspf.dwRGBBitCount===16)i.ddspf.dwRBitMask===63488&&i.ddspf.dwGBitMask===2016&&i.ddspf.dwBBitMask===31?this.format=a.PIXELFORMAT_R5G6B5:this.bgrFormat=this.BGRPIXELFORMAT_B5G6R5,u=2;else{if(i.ddspf.dwRGBBitCount!==8){this.onerror(n);return}this.format=a.PIXELFORMAT_L8,u=1}var f=0;for(var l=0;l<this.numFaces;l+=1){var c=this.width,h=this.height,p=this.depth;for(var d=0;d<this.numLevels;d+=1){var v=o?Math.floor((c+3)/4):c,m=o?Math.floor((h+3)/4):h;f+=v*m*p*u,c=c>1?c>>1:1,h=h>1?h>>1:1,p=p>1?p>>1:1}}if(t.length<r+f){this.onerror(n);return}this.bytesPerPixel=u;var g=t.subarray(r);t=null;var y=!1;switch(this.bgrFormat){case this.BGRPIXELFORMAT_B8G8R8:this.format=a.PIXELFORMAT_R8G8B8,y=!0;break;case this.BGRPIXELFORMAT_B8G8R8A8:this.format=a.PIXELFORMAT_R8G8B8A8,y=!0;break;case this.BGRPIXELFORMAT_B5G6R5:this.format=a.PIXELFORMAT_R5G6B5,y=!0;break;default:}y&&(g=this.convertBGR2RGB(g));if(this.format===a.PIXELFORMAT_DXT1){if(!a.isSupported("TEXTURE_DXT1")){if(this.hasDXT1Alpha(g)){this.format=a.PIXELFORMAT_R5G5B5A1,e.decodeInWorker(e.WorkerCommand.DXT1A,g,this);return}this.format=a.PIXELFORMAT_R5G6B5,e.decodeInWorker(e.WorkerCommand.DXT1,g,this);return}}else if(this.format===a.PIXELFORMAT_DXT3){if(!a.isSupported("TEXTURE_DXT3")){this.format=a.PIXELFORMAT_R4G4B4A4,e.decodeInWorker(e.WorkerCommand.DXT3,g,this);return}}else if(this.format===a.PIXELFORMAT_DXT5&&!a.isSupported("TEXTURE_DXT5")){this.format=a.PIXELFORMAT_R4G4B4A4,e.decodeInWorker(e.WorkerCommand.DXT5,g,this);return}this.onload(g,this.width,this.height,this.format,this.numLevels,this.numFaces>1,this.depth,n)},e.createWorker=function(t){var n="var convertDXT1To565 = "+this.convertDXT1To565.toString()+";\n"+"var convertDXT1To5551 = "+this.convertDXT1To5551.toString()+";\n"+"var convertDXT3To4444 = "+this.convertDXT3To4444.toString()+";\n"+"var convertDXT5To4444 = "+this.convertDXT5To4444.toString()+";\n"+"var command, srcWidth, srcHeight, srcNumLevels, srcNumFaces, srcOffset;\n"+"onmessage = function decoderOnMessage(event)\n"+"{\n"+"    var edata = event.data;\n"+"    if (edata instanceof ArrayBuffer)\n"+"    {\n"+"        var data = new Uint8Array(edata, srcOffset);\n"+"        switch (command)\n"+"        {\n"+"            case 0: // DXT1\n"+"                data = convertDXT1To565(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 1: // DXT1A\n"+"                data = convertDXT1To5551(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 2: // DXT3\n"+"                data = convertDXT3To4444(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            case 3: // DXT4\n"+"                data = convertDXT5To4444(data, srcWidth, srcHeight, srcNumLevels, srcNumFaces);\n"+"                break;\n"+"            default:\n"+"                data = null;\n"+"                break;\n"+"        };\n"+"        if (data)\n"+"        {\n"+"            postMessage(data.buffer, [data.buffer]);\n"+"        }\n"+"        else\n"+"        {\n"+"            postMessage(null);\n"+"        }\n"+"    }\n"+"    else\n"+"    {\n"+"        command = edata.command;\n"+"        srcWidth = edata.width;\n"+"        srcHeight = edata.height;\n"+"        srcNumLevels = edata.numLevels;\n"+"        srcNumFaces = edata.numFaces;\n"+"        srcOffset = edata.byteOffset;\n"+"    }\n"+"};",r=new Blob([n],{type:"text/javascript"}),i=typeof URL!="undefined"?URL:window.webkitURL,s=i.createObjectURL(r),o;try{o=new Worker(s)}catch(u){o=null}if(o){var a=e.workerQueues[t];o.onmessage=function(e){var t=a.shift();o.load-=((t.width+3)*(t.height+3)>>4)*t.numLevels*t.numFaces;var n=e.data;n?t.onload(n,t.width,t.height,t.format,t.numLevels,t.numFaces>1,t.depth,200):t.onerror(200)},o.load=0}return i.revokeObjectURL(s),o},e.decodeInWorker=function(t,n,r){var i=this.maxNumWorkers;if(i){var s=this.workerQueues,o=this.workers,u=-1,a;if(!o){this.workerQueues=s=[],this.workers=o=[],u=0;for(a=0;a<i;a+=1){s[a]=[],o[a]=this.createWorker(a);if(!o[a]){u=-1;break}}}else{u=0;var f=o[0].load;for(a=1;a<i;a+=1){var l=o[a].load;f>l&&(f=l,u=a)}}if(u!==-1){var c=o[u];c.load+=((r.width+3)*(r.height+3)>>4)*r.numLevels*r.numFaces,s[u].push(r);var h=n.byteOffset,p;r.externalBuffer?(p=n.buffer.slice(h,h+n.byteLength),h=0):p=n.buffer,c.postMessage({command:t,width:r.width,height:r.height,numLevels:r.numLevels,numFaces:r.numFaces,byteOffset:h}),c.postMessage(p,[p]);return}this.maxNumWorkers=0}var d;switch(t){case e.WorkerCommand.DXT1:d=function(){n=e.convertDXT1To565(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT1A:d=function(){n=e.convertDXT1To5551(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT3:d=function(){n=e.convertDXT3To4444(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;case e.WorkerCommand.DXT5:d=function(){n=e.convertDXT5To4444(n,r.width,r.height,r.numLevels,r.numFaces),r.onload(n,r.width,r.height,r.format,r.numLevels,r.numFaces>1,r.depth,200)};break;default:d=null}d?TurbulenzEngine.setTimeout(d,0):r.onerror(200)},e.prototype.parseHeader=function(e,t){function n(){var n=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24;return t+=4,n}function r(){return{dwSize:n(),dwFlags:n(),dwFourCC:n(),dwRGBBitCount:n(),dwRBitMask:n(),dwGBitMask:n(),dwBBitMask:n(),dwABitMask:n()}}var i={dwSize:n(),dwFlags:n(),dwHeight:n(),dwWidth:n(),dwPitchOrLinearSize:n(),dwDepth:n(),dwMipMapCount:n(),dwReserved1:[n(),n(),n(),n(),n(),n(),n(),n(),n(),n(),n()],ddspf:r(),dwCaps1:n(),dwCaps2:n(),dwReserved2:[n(),n(),n()]};return i},e.prototype.isValidHeader=function(e){return 68===e[0]&&68===e[1]&&83===e[2]&&32===e[3]},e.prototype.convertBGR2RGB=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=this.numLevels,s=this.numFaces,o=0;for(var u=0;u<i;u+=1)o+=n*r,n=n>1?Math.floor(n/2):1,r=r>1?Math.floor(r/2):1;var a=o*t*s,f=0;if(t===3||t===4){do{var l=e[f];e[f]=e[f+2],e[f+2]=l,f+=t}while(f<a)}else if(t===2){var c=new Uint16Array(o*s),h=0,p=0,d,v,m,g=31,y=2016;do{var b=e[h+1]<<8|e[h];h+=2,d=(b&g)<<11,v=b&y,m=b>>11&g,c[p]=d|v|m,p+=1}while(f<a);return c}return e},e.prototype.decode565=function(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t},e.prototype.decodeColor=function(t,n,r,i,s){var o=s.cache,u=e.prototype.decode565,a=t[n+1]<<8|t[n];n+=2;var f=t[n+1]<<8|t[n];n+=2;var l,c,h,p,d;if(a!==f){l=u(a,o[0]),c=u(f,o[1]),h=o[2],p=o[3];if(a>f){for(d=0;d<3;d+=1){var v=l[d],m=c[d];h[d]=(v*2+m)/3|0,p[d]=(v+m*2)/3|0}h[3]=255,p[3]=255}else{for(d=0;d<3;d+=1)h[d]=l[d]+c[d]>>1,p[d]=0;h[3]=255,p[3]=0}}else{l=u(a,o[0]),c=l,h=l,p=o[1];for(d=0;d<4;d+=1)p[d]=0}var g=s.colorArray;g[0]=l,g[1]=c,g[2]=h,g[3]=p;var y,b,w;if(r)for(d=0;d<4;d+=1)y=t[n+d],b=i[d],b[0]=g[y&3],b[1]=g[y>>2&3],b[2]=g[y>>4&3],b[3]=g[y>>6&3];else for(d=0;d<4;d+=1)y=t[n+d],b=i[d],w=g[y&3],b[0][0]=w[0],b[0][1]=w[1],b[0][2]=w[2],b[0][3]=w[3],w=g[y>>2&3],b[1][0]=w[0],b[1][1]=w[1],b[1][2]=w[2],b[1][3]=w[3],w=g[y>>4&3],b[2][0]=w[0],b[2][1]=w[1],b[2][2]=w[2],b[2][3]=w[3],w=g[y>>6&3],b[3][0]=w[0],b[3][1]=w[1],b[3][2]=w[2],b[3][3]=w[3]},e.prototype.decodeDXT3Alpha=function(e,t,n){for(var r=0;r<4;r+=1){var i=e[t+1]<<8|e[t];t+=2;var s=n[r];i?(s[0][3]=(i&15)*17,s[1][3]=(i>>4&15)*17,s[2][3]=(i>>8&15)*17,s[3][3]=(i>>12&15)*17):(s[0][3]=0,s[1][3]=0,s[2][3]=0,s[3][3]=0)}},e.prototype.decodeDXT5Alpha=function(e,t,n,r){var i=e[t];t+=1;var s=e[t];t+=1;var o=r.alphaArray;o[0]=i,o[1]=s,i>s?(o[2]=(i*6+s*1)/7|0,o[3]=(i*5+s*2)/7|0,o[4]=(i*4+s*3)/7|0,o[5]=(i*3+s*4)/7|0,o[6]=(i*2+s*5)/7|0,o[7]=(i*1+s*6)/7|0):i<s?(o[2]=(i*4+s*1)/5|0,o[3]=(i*3+s*2)/5|0,o[4]=(i*2+s*3)/5|0,o[5]=(i*1+s*4)/5|0,o[6]=0,o[7]=255):(o[2]=i,o[3]=i,o[4]=i,o[5]=i,o[6]=0,o[7]=255);var u;for(var a=0;a<2;a+=1){var f=e[t]|e[t+1]<<8|e[t+2]<<16;t+=3,u=n[a*2],u[0][3]=o[f&7],u[1][3]=o[f>>3&7],u[2][3]=o[f>>6&7],u[3][3]=o[f>>9&7],u=n[a*2+1],u[0][3]=o[f>>12&7],u[1][3]=o[f>>15&7],u[2][3]=o[f>>18&7],u[3][3]=o[f>>21&7]}},e.prototype.convertToRGBA32=function(e,t,n){var r,i=this.width,s=this.height,o=this.numLevels,u=this.numFaces,a=0;for(r=0;r<o;r+=1)a+=i*s,i=i>1?i>>1:1,s=s>1?s>>1:1;var f=new Uint8Array(a*4*u),l=0,c=0,h=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]];for(var p=0;p<u;p+=1){i=this.width,s=this.height;for(var d=0;d<o;d+=1){var v=i>4?4:i,m=s>4?4:s,g=s+3>>2,y=i+3>>2,b=i*4,w=v*4,E=b*(m-1);for(var S=0;S<g;S+=1){for(var x=0;x<y;x+=1){t(e,l,h);var T=c;for(var N=0;N<m;N+=1){var C=h[N],k=T;for(var L=0;L<v;L+=1){var A=C[L];f[k]=A[0],f[k+1]=A[1],f[k+2]=A[2],f[k+3]=A[3],k+=4}T+=b}l+=n,c+=w}c+=E}i=i>1?i>>1:1,s=s>1?s>>1:1}}return f},e.prototype.hasDXT1Alpha=function(e){var t=e.length>>>1,n=new Uint16Array(e.buffer,e.byteOffset,t),r,i,s,o;for(r=0;r<t;r+=4)if(n[r]<=n[r+1]){i=r+2<<1;for(s=0;s<4;s+=1){o=e[i+s];if(2<o)if((o&3)===3||(o>>2&3)===3||(o>>4&3)===3||(o>>6&3)===3)return!0}}return!1},e.prototype.encodeR5G6B5=function(e){return(e[2]&248)>>>3|(e[1]&252)<<3|(e[0]&248)<<8},e.prototype.encodeR5G5B5A1=function(e){return e[3]>>>7|(e[2]&248)>>>2|(e[1]&248)<<3|(e[0]&248)<<8},e.prototype.encodeR4G4B4A4=function(e){return e[3]>>>4|e[2]&240|(e[1]&240)<<4|(e[0]&240)<<8},e.convertDXT1To565=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u)for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}else for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>>1,c[h]=0}else a=s(o,r[0]),f=a,l=a,c=r[1];var v=i;v[0]=(a[2]&248)>>>3|(a[1]&252)<<3|(a[0]&248)<<8,v[1]=(f[2]&248)>>>3|(f[1]&252)<<3|(f[0]&248)<<8,v[2]=(l[2]&248)>>>3|(l[1]&252)<<3|(l[0]&248)<<8,v[3]=(c[2]&248)>>>3|(c[1]&252)<<3|(c[0]&248)<<8;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],g[0]=v[m&3],g[1]=v[m>>2&3],g[2]=v[m>>4&3],g[3]=v[m>>6&3]}var o,u=t,a=n,f=r,l=i,c=0;for(o=0;o<f;o+=1)c+=u*a,u=u>1?u>>1:1,a=a>1?a>>1:1;var h=new Uint16Array(c*1*l),p=0,d=0,v=[new Uint16Array(4),new Uint16Array(4),new Uint16Array(4),new Uint16Array(4)],m=[new Uint8Array(3),new Uint8Array(3),new Uint8Array(3),new Uint8Array(3)],g=new Uint16Array(4);for(var y=0;y<l;y+=1){u=t,a=n;for(var b=0;b<f;b+=1){var w=u>4?4:u,E=a>4?4:a,S=a+3>>2,x=u+3>>2,T=u*1,N=w*1,C=T*(E-1);for(var k=0;k<S;k+=1){for(var L=0;L<x;L+=1){s(e,p,v,m,g);var A=d;for(var O=0;O<E;O+=1){var M=v[O],_=A;for(var D=0;D<w;D+=1)h[_]=M[D],_+=1;A+=T}p+=8,d+=N}d+=C}u=u>1?u>>1:1,a=a>1?a>>1:1}}return h},e.convertDXT1To5551=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a[3]>>>7|(a[2]&248)>>>2|(a[1]&248)<<3|(a[0]&248)<<8,v[1]=f[3]>>>7|(f[2]&248)>>>2|(f[1]&248)<<3|(f[0]&248)<<8,v[2]=l[3]>>>7|(l[2]&248)>>>2|(l[1]&248)<<3|(l[0]&248)<<8,v[3]=c[3]>>>7|(c[2]&248)>>>2|(c[1]&248)<<3|(c[0]&248)<<8;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],g[0]=v[m&3],g[1]=v[m>>2&3],g[2]=v[m>>4&3],g[3]=v[m>>6&3]}var o,u=t,a=n,f=r,l=i,c=0;for(o=0;o<f;o+=1)c+=u*a,u=u>1?u>>1:1,a=a>1?a>>1:1;var h=new Uint16Array(c*1*l),p=0,d=0,v=[new Uint16Array(4),new Uint16Array(4),new Uint16Array(4),new Uint16Array(4)],m=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],g=new Uint16Array(4);for(var y=0;y<l;y+=1){u=t,a=n;for(var b=0;b<f;b+=1){var w=u>4?4:u,E=a>4?4:a,S=a+3>>2,x=u+3>>2,T=u*1,N=w*1,C=T*(E-1);for(var k=0;k<S;k+=1){for(var L=0;L<x;L+=1){s(e,p,v,m,g);var A=d;for(var O=0;O<E;O+=1){var M=v[O],_=A;for(var D=0;D<w;D+=1)h[_]=M[D],_+=1;A+=T}p+=8,d+=N}d+=C}u=u>1?u>>1:1,a=a>1?a>>1:1}}return h},e.convertDXT3To4444=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],y=v[m&3],g[0][0]=y[0],g[0][1]=y[1],g[0][2]=y[2],g[0][3]=y[3],y=v[m>>2&3],g[1][0]=y[0],g[1][1]=y[1],g[1][2]=y[2],g[1][3]=y[3],y=v[m>>4&3],g[2][0]=y[0],g[2][1]=y[1],g[2][2]=y[2],g[2][3]=y[3],y=v[m>>6&3],g[3][0]=y[0],g[3][1]=y[1],g[3][2]=y[2],g[3][3]=y[3]}function o(e,t,n){for(var r=0;r<4;r+=1){var i=e[t+1]<<8|e[t];t+=2;var s=n[r];i?(s[0][3]=(i&15)*17,s[1][3]=(i>>4&15)*17,s[2][3]=(i>>8&15)*17,s[3][3]=(i>>12&15)*17):(s[0][3]=0,s[1][3]=0,s[2][3]=0,s[3][3]=0)}}var u,a=t,f=n,l=r,c=i,h=0;for(u=0;u<l;u+=1)h+=a*f,a=a>1?a>>1:1,f=f>1?f>>1:1;var p=new Uint16Array(h*1*c),d=0,v=0,m=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]],g=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],y=new Array(4);for(var b=0;b<c;b+=1){a=t,f=n;for(var w=0;w<l;w+=1){var E=a>4?4:a,S=f>4?4:f,x=f+3>>2,T=a+3>>2,N=a*1,C=E*1,k=N*(S-1);for(var L=0;L<x;L+=1){for(var A=0;A<T;A+=1){s(e,d+8,m,g,y),o(e,d,m);var O=v;for(var M=0;M<S;M+=1){var _=m[M],D=O;for(var P=0;P<E;P+=1){var H=_[P];p[D]=H[3]>>>4|H[2]&240|(H[1]&240)<<4|(H[0]&240)<<8,D+=1}O+=N}d+=16,v+=C}v+=k}a=a>1?a>>1:1,f=f>1?f>>1:1}}return p},e.convertDXT5To4444=function(e,t,n,r,i){function s(e,t,n,r,i){function s(e,t){var n=e>>11&31,r=e>>5&63,i=e&31;return t[0]=n<<3|n>>2,t[1]=r<<2|r>>4,t[2]=i<<3|i>>2,t[3]=255,t}var o=e[t+1]<<8|e[t];t+=2;var u=e[t+1]<<8|e[t];t+=2;var a,f,l,c,h;if(o!==u){a=s(o,r[0]),f=s(u,r[1]),l=r[2],c=r[3];if(o>u){for(h=0;h<3;h+=1){var p=a[h],d=f[h];l[h]=(p*2+d)/3|0,c[h]=(p+d*2)/3|0}l[3]=255,c[3]=255}else{for(h=0;h<3;h+=1)l[h]=a[h]+f[h]>>1,c[h]=0;l[3]=255,c[3]=0}}else{a=s(o,r[0]),f=a,l=a,c=r[1];for(h=0;h<4;h+=1)c[h]=0}var v=i;v[0]=a,v[1]=f,v[2]=l,v[3]=c;var m,g,y;for(h=0;h<4;h+=1)m=e[t+h],g=n[h],y=v[m&3],g[0][0]=y[0],g[0][1]=y[1],g[0][2]=y[2],g[0][3]=y[3],y=v[m>>2&3],g[1][0]=y[0],g[1][1]=y[1],g[1][2]=y[2],g[1][3]=y[3],y=v[m>>4&3],g[2][0]=y[0],g[2][1]=y[1],g[2][2]=y[2],g[2][3]=y[3],y=v[m>>6&3],g[3][0]=y[0],g[3][1]=y[1],g[3][2]=y[2],g[3][3]=y[3]}function o(e,t,n,r){var i=e[t];t+=1;var s=e[t];t+=1;var o=r;o[0]=i,o[1]=s,i>s?(o[2]=(i*6+s*1)/7|0,o[3]=(i*5+s*2)/7|0,o[4]=(i*4+s*3)/7|0,o[5]=(i*3+s*4)/7|0,o[6]=(i*2+s*5)/7|0,o[7]=(i*1+s*6)/7|0):i<s?(o[2]=(i*4+s*1)/5|0,o[3]=(i*3+s*2)/5|0,o[4]=(i*2+s*3)/5|0,o[5]=(i*1+s*4)/5|0,o[6]=0,o[7]=255):(o[2]=i,o[3]=i,o[4]=i,o[5]=i,o[6]=0,o[7]=255);var u;for(var a=0;a<2;a+=1){var f=e[t]|e[t+1]<<8|e[t+2]<<16;t+=3,u=n[a*2],u[0][3]=o[f&7],u[1][3]=o[f>>3&7],u[2][3]=o[f>>6&7],u[3][3]=o[f>>9&7],u=n[a*2+1],u[0][3]=o[f>>12&7],u[1][3]=o[f>>15&7],u[2][3]=o[f>>18&7],u[3][3]=o[f>>21&7]}}var u,a=t,f=n,l=r,c=i,h=0;for(u=0;u<l;u+=1)h+=a*f,a=a>1?a>>1:1,f=f>1?f>>1:1;var p=new Uint16Array(h*1*c),d=0,v=0,m=[[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)]],g=[new Uint8Array(4),new Uint8Array(4),new Uint8Array(4),new Uint8Array(4)],y=new Array(4),b=new Uint8Array(8);for(var w=0;w<c;w+=1){a=t,f=n;for(var E=0;E<l;E+=1){var S=a>4?4:a,x=f>4?4:f,T=f+3>>2,N=a+3>>2,C=a*1,k=S*1,L=C*(x-1);for(var A=0;A<T;A+=1){for(var O=0;O<N;O+=1){s(e,d+8,m,g,y),o(e,d,m,b);var M=v;for(var _=0;_<x;_+=1){var D=m[_],P=M;for(var H=0;H<S;H+=1){var B=D[H];p[P]=B[3]>>>4|B[2]&240|(B[1]&240)<<4|(B[0]&240)<<8,P+=1}M+=C}d+=16,v+=k}v+=L}a=a>1?a>>1:1,f=f>1?f>>1:1}}return p},e.create=function(t){function r(e,t,n,r){return e.charCodeAt(0)+t.charCodeAt(0)*256+n.charCodeAt(0)*65536+r.charCodeAt(0)*16777216}var n=new e;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror,n.FOURCC_ATI1=r("A","T","I","1"),n.FOURCC_ATI2=r("A","T","I","2"),n.FOURCC_RXGB=r("R","X","G","B");var i=t.src;if(i){n.src=i;var s;if(window.XMLHttpRequest)s=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;s=new window.ActiveXObject("Microsoft.XMLHTTP")}s.onreadystatechange=function(){if(s.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=s.status,t=s.status!==0&&s.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(s.getAllResponseHeaders()===""){var r;s.responseType==="arraybuffer"?r=!s.response:s.mozResponseArrayBuffer?r=!s.mozResponseArrayBuffer:r=!s.responseText;if(r){n.onerror&&n.onerror(0),s.onreadystatechange=null,s=null;return}}if(e===200||e===0){var i;if(s.responseType==="arraybuffer")i=s.response;else if(s.mozResponseArrayBuffer)i=s.mozResponseArrayBuffer;else{var o=s.responseText,u=o.length;i=[],i.length=u;for(var a=0;a<u;a+=1)i[a]=o.charCodeAt(a)&255}n.externalBuffer=!1,n.processBytes(new Uint8Array(i),e)}else n.onerror&&n.onerror(e)}s.onreadystatechange=null,s=null}},s.open("GET",t.src,!0),typeof s.responseType=="string"||s.hasOwnProperty&&s.hasOwnProperty("responseType")?s.responseType="arraybuffer":s.overrideMimeType?s.overrideMimeType("text/plain; charset=x-user-defined"):s.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),s.send(null)}else n.externalBuffer=!0,n.processBytes(t.data,0);return n},e.destroy=function(){var e=this.maxNumWorkers;if(e){this.workerQueues=null;var t=this.workers;if(t){this.workers=null;var n;for(n=0;n<e;n+=1)t[n].terminate()}}},e.version=1,e.maxNumWorkers=typeof Worker=="undefined"||typeof Blob=="undefined"||typeof URL=="undefined"&&typeof window.webkitURL=="undefined"?0:4,e.WorkerCommand={DXT1:0,DXT1A:1,DXT3:2,DXT5:3},e.workerQueues=null,e.workers=null,e}();c.prototype.DDSF_CAPS=1,c.prototype.DDSF_HEIGHT=2,c.prototype.DDSF_WIDTH=4,c.prototype.DDSF_PITCH=8,c.prototype.DDSF_PIXELFORMAT=4096,c.prototype.DDSF_MIPMAPCOUNT=131072,c.prototype.DDSF_LINEARSIZE=524288,c.prototype.DDSF_DEPTH=8388608,c.prototype.DDSF_ALPHAPIXELS=1,c.prototype.DDSF_FOURCC=4,c.prototype.DDSF_RGB=64,c.prototype.DDSF_RGBA=65,c.prototype.DDSF_COMPLEX=8,c.prototype.DDSF_TEXTURE=4096,c.prototype.DDSF_MIPMAP=4194304,c.prototype.DDSF_CUBEMAP=512,c.prototype.DDSF_CUBEMAP_POSITIVEX=1024,c.prototype.DDSF_CUBEMAP_NEGATIVEX=2048,c.prototype.DDSF_CUBEMAP_POSITIVEY=4096,c.prototype.DDSF_CUBEMAP_NEGATIVEY=8192,c.prototype.DDSF_CUBEMAP_POSITIVEZ=16384,c.prototype.DDSF_CUBEMAP_NEGATIVEZ=32768,c.prototype.DDSF_CUBEMAP_ALL_FACES=64512,c.prototype.DDSF_VOLUME=2097152,c.prototype.FOURCC_UNKNOWN=0,c.prototype.FOURCC_R8G8B8=20,c.prototype.FOURCC_A8R8G8B8=21,c.prototype.FOURCC_X8R8G8B8=22,c.prototype.FOURCC_R5G6B5=23,c.prototype.FOURCC_X1R5G5B5=24,c.prototype.FOURCC_A1R5G5B5=25,c.prototype.FOURCC_A4R4G4B4=26,c.prototype.FOURCC_R3G3B2=27,c.prototype.FOURCC_A8=28,c.prototype.FOURCC_A8R3G3B2=29,c.prototype.FOURCC_X4R4G4B4=30,c.prototype.FOURCC_A2B10G10R10=31,c.prototype.FOURCC_A8B8G8R8=32,c.prototype.FOURCC_X8B8G8R8=33,c.prototype.FOURCC_G16R16=34,c.prototype.FOURCC_A2R10G10B10=35,c.prototype.FOURCC_A16B16G16R16=36,c.prototype.FOURCC_L8=50,c.prototype.FOURCC_A8L8=51,c.prototype.FOURCC_A4L4=52,c.prototype.FOURCC_DXT1=827611204,c.prototype.FOURCC_DXT2=844388420,c.prototype.FOURCC_DXT3=861165636,c.prototype.FOURCC_DXT4=877942852,c.prototype.FOURCC_DXT5=894720068,c.prototype.FOURCC_D16_LOCKABLE=70,c.prototype.FOURCC_D32=71,c.prototype.FOURCC_D24X8=77,c.prototype.FOURCC_D16=80,c.prototype.FOURCC_D32F_LOCKABLE=82,c.prototype.FOURCC_L16=81,c.prototype.FOURCC_R16F=111,c.prototype.FOURCC_G16R16F=112,c.prototype.FOURCC_A16B16G16R16F=113,c.prototype.FOURCC_R32F=114,c.prototype.FOURCC_G32R32F=115,c.prototype.FOURCC_A32B32G32R32F=116,c.prototype.BGRPIXELFORMAT_B5G6R5=1,c.prototype.BGRPIXELFORMAT_B8G8R8A8=2,c.prototype.BGRPIXELFORMAT_B8G8R8=3;var h=function(){function e(){}return e.prototype.setData=function(e,t,n,r,i,s,o){var u=this.gd,a=this.target;u.bindTexture(a,this.glTexture),3<=arguments.length?(r===undefined&&(r=0),i===undefined&&(i=0),s===undefined&&(s=this.width-r),o===undefined&&(o=this.height-i),this.updateSubData(e,t,n,r,i,s,o)):this.updateData(e),u.bindTexture(a,null)},e.prototype.createGLTexture=function(e){var t=this.gd,n=t.gl,r;if(this.cubemap)r=n.TEXTURE_CUBE_MAP;else{if(this.depth>1)return!1;r=n.TEXTURE_2D}this.target=r;var i=n.createTexture();return this.glTexture=i,t.bindTexture(r,i),n.texParameteri(r,n.TEXTURE_MAG_FILTER,n.LINEAR),this.mipmaps?n.texParameteri(r,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST):n.texParameteri(r,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(r,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(r,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),this.updateData(e),t.bindTexture(r,null),!0},e.prototype.convertDataToRGBA=function(e,t,n,r,i){var s=t.length/i,o=new Uint8Array(s*4),u=0,a,f,l,c,h,p;if(n===e.LUMINANCE)for(a=0;a<s;a+=1,u+=4)l=t[a],o[u]=l,o[u+1]=l,o[u+2]=l,o[u+3]=255;else if(n===e.ALPHA)for(a=0;a<s;a+=1,u+=4)p=t[a],o[u]=255,o[u+1]=255,o[u+2]=255,o[u+3]=p;else if(n===e.LUMINANCE_ALPHA)for(a=0;a<s;a+=2,u+=4)l=t[a],p=t[a+1],o[u]=l,o[u+1]=l,o[u+2]=l,o[u+3]=p;else if(r===e.UNSIGNED_SHORT_5_6_5)for(a=0;a<s;a+=1,u+=4)f=t[a],l=f>>11&31,c=f>>5&63,h=f&31,o[u]=l<<3|l>>2,o[u+1]=c<<2|c>>4,o[u+2]=h<<3|h>>2,o[u+3]=255;else if(r===e.UNSIGNED_SHORT_5_5_5_1)for(a=0;a<s;a+=1,u+=4)f=t[a],l=f>>11&31,c=f>>6&31,h=f>>1&31,p=f&1,o[u]=l<<3|l>>2,o[u+1]=c<<3|c>>2,o[u+2]=h<<3|h>>2,o[u+3]=p?255:0;else if(r===e.UNSIGNED_SHORT_4_4_4_4)for(a=0;a<s;a+=1,u+=4)f=t[a],l=f>>12&15,c=f>>8&15,h=f>>4&15,p=f&15,o[u]=l<<4|l,o[u+1]=c<<4|c,o[u+2]=h<<4|h,o[u+3]=p<<4|p;return o},e.prototype.updateData=function(e){function r(e){return Math.floor(Math.log(e)/Math.LN2)}var t=this.gd,n=t.gl,i,s;this.mipmaps?e instanceof Image?(i=1,s=!0):(i=1+Math.max(r(this.width),r(this.height)),s=!1):(i=1,s=!1);var o=this.format,u,a,f,l=null,c;if(o===t.PIXELFORMAT_A8)u=n.ALPHA,a=n.UNSIGNED_BYTE,f=1,e&&!e.src&&(e instanceof Uint8Array?l=e:l=new Uint8Array(e));else if(o===t.PIXELFORMAT_L8)u=n.LUMINANCE,a=n.UNSIGNED_BYTE,f=1,e&&!e.src&&(e instanceof Uint8Array?l=e:l=new Uint8Array(e));else if(o===t.PIXELFORMAT_L8A8)u=n.LUMINANCE_ALPHA,a=n.UNSIGNED_BYTE,f=2,e&&!e.src&&(e instanceof Uint8Array?l=e:l=new Uint8Array(e));else if(o===t.PIXELFORMAT_R5G5B5A1)u=n.RGBA,a=n.UNSIGNED_SHORT_5_5_5_1,f=1,e&&!e.src&&(e instanceof Uint16Array?l=e:l=new Uint16Array(e));else if(o===t.PIXELFORMAT_R5G6B5)u=n.RGB,a=n.UNSIGNED_SHORT_5_6_5,f=1,e&&!e.src&&(e instanceof Uint16Array?l=e:l=new Uint16Array(e));else if(o===t.PIXELFORMAT_R4G4B4A4)u=n.RGBA,a=n.UNSIGNED_SHORT_4_4_4_4,f=1,e&&!e.src&&(e instanceof Uint16Array?l=e:l=new Uint16Array(e));else if(o===t.PIXELFORMAT_R8G8B8A8)u=n.RGBA,a=n.UNSIGNED_BYTE,f=4,e&&!e.src&&(e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?l=new Uint8Array(e.buffer):l=e:l=new Uint8Array(e));else if(o===t.PIXELFORMAT_R8G8B8)u=n.RGB,a=n.UNSIGNED_BYTE,f=3,e&&!e.src&&(e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?l=new Uint8Array(e.buffer):l=e:l=new Uint8Array(e));else if(o===t.PIXELFORMAT_D24S8)u=n.DEPTH_STENCIL,a=n.UNSIGNED_INT,f=1,e&&!e.src&&(l=new Uint32Array(e));else{if(o!==t.PIXELFORMAT_DXT1&&o!==t.PIXELFORMAT_DXT3&&o!==t.PIXELFORMAT_DXT5)return;c=t.compressedTexturesExtension;if(!c)return;o===t.PIXELFORMAT_DXT1?(u=c.COMPRESSED_RGBA_S3TC_DXT1_EXT,f=8):o===t.PIXELFORMAT_DXT3?(u=c.COMPRESSED_RGBA_S3TC_DXT3_EXT,f=16):(u=c.COMPRESSED_RGBA_S3TC_DXT5_EXT,f=16);if(u===undefined)return;e&&!e.src&&(e instanceof Uint8Array?l=e:l=new Uint8Array(e))}t.fixIE&&(u!==n.RGBA&&u!==n.RGB||a!==n.UNSIGNED_BYTE&&a!==n.FLOAT)&&(l&&(l=this.convertDataToRGBA(n,l,u,a,f)),u=n.RGBA,a=n.UNSIGNED_BYTE,f=4);var h=this.width,d=this.height,v=0,m,g,y,b;if(this.cubemap){if(e&&e instanceof p)return;m=n.TEXTURE_CUBE_MAP;for(var w=0;w<6;w+=1){var E=n.TEXTURE_CUBE_MAP_POSITIVE_X+w;for(g=0;g<i;g+=1){c?(y=Math.floor((h+3)/4)*Math.floor((d+3)/4)*f,l?b=l.subarray(v,v+y):b=new Uint8Array(y),t.WEBGL_compressed_texture_s3tc?n.compressedTexImage2D(E,g,u,h,d,0,b):c.compressedTexImage2D(E,g,u,h,d,0,b)):(y=h*d*f,l?(b=l.subarray(v,v+y),n.texImage2D(E,g,u,h,d,0,u,a,b)):e?n.texImage2D(E,g,u,u,a,e):(a===n.UNSIGNED_SHORT_5_6_5||a===n.UNSIGNED_SHORT_5_5_5_1||a===n.UNSIGNED_SHORT_4_4_4_4?b=new Uint16Array(y):b=new Uint8Array(y),n.texImage2D(E,g,u,h,d,0,u,a,b))),v+=y;if(l&&l.length<=v){l=null,e=null;if(0===g&&1<i){s=!0;break}}h=h>1?Math.floor(h/2):1,d=d>1?Math.floor(d/2):1}h=this.width,d=this.height}}else if(e&&e instanceof p)m=n.TEXTURE_2D,n.texImage2D(m,0,u,u,a,e.video);else{m=n.TEXTURE_2D;for(g=0;g<i;g+=1){c?(y=Math.floor((h+3)/4)*Math.floor((d+3)/4)*f,l?i===1?b=l:b=l.subarray(v,v+y):b=new Uint8Array(y),t.WEBGL_compressed_texture_s3tc?n.compressedTexImage2D(m,g,u,h,d,0,b):c.compressedTexImage2D(m,g,u,h,d,0,b)):(y=h*d*f,l?(i===1?b=l:b=l.subarray(v,v+y),n.texImage2D(m,g,u,h,d,0,u,a,b)):e?n.texImage2D(m,g,u,u,a,e):(a===n.UNSIGNED_SHORT_5_6_5||a===n.UNSIGNED_SHORT_5_5_5_1||a===n.UNSIGNED_SHORT_4_4_4_4?b=new Uint16Array(y):b=new Uint8Array(y),n.texImage2D(m,g,u,h,d,0,u,a,b))),v+=y;if(l&&l.length<=v){l=null,e=null;if(0===g&&1<i){s=!0;break}}h=h>1?Math.floor(h/2):1,d=d>1?Math.floor(d/2):1}}s&&n.generateMipmap(m)},e.prototype.updateSubData=function(e,t,n,r,i,s,o){var u=this.gd,a=u.gl,f=this.format,l,c,h,d;if(f===u.PIXELFORMAT_A8)l=a.ALPHA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_L8)l=a.LUMINANCE,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_L8A8)l=a.LUMINANCE_ALPHA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_R5G5B5A1)l=a.RGBA,c=a.UNSIGNED_SHORT_5_5_5_1,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R5G6B5)l=a.RGB,c=a.UNSIGNED_SHORT_5_6_5,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R4G4B4A4)l=a.RGBA,c=a.UNSIGNED_SHORT_4_4_4_4,e instanceof Uint16Array?h=e:h=new Uint16Array(e);else if(f===u.PIXELFORMAT_R8G8B8A8)l=a.RGBA,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?h=new Uint8Array(e.buffer):h=e:h=new Uint8Array(e);else if(f===u.PIXELFORMAT_R8G8B8)l=a.RGB,c=a.UNSIGNED_BYTE,e instanceof Uint8Array?typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray?h=new Uint8Array(e.buffer):h=e:h=new Uint8Array(e);else{if(f!==u.PIXELFORMAT_DXT1&&f!==u.PIXELFORMAT_DXT3&&f!==u.PIXELFORMAT_DXT5)return;d=u.compressedTexturesExtension;if(!d)return;f===u.PIXELFORMAT_DXT1?l=d.COMPRESSED_RGBA_S3TC_DXT1_EXT:f===u.PIXELFORMAT_DXT3?l=d.COMPRESSED_RGBA_S3TC_DXT3_EXT:l=d.COMPRESSED_RGBA_S3TC_DXT5_EXT,e instanceof Uint8Array?h=e:h=new Uint8Array(e)}var v;if(this.cubemap){if(e instanceof p)return;v=a.TEXTURE_CUBE_MAP_POSITIVE_X+t}else{if(e instanceof p){v=a.TEXTURE_2D,a.texSubImage2D(v,n,r,i,l,c,e.video);return}v=a.TEXTURE_2D}d?u.WEBGL_compressed_texture_s3tc?a.compressedTexSubImage2D(v,n,r,i,s,o,l,h):d.compressedTexSubImage2D(v,n,r,i,s,o,l,h):a.texSubImage2D(v,n,r,i,s,o,l,c,h)},e.prototype.updateMipmaps=function(e){if(this.mipmaps){if(this.depth>1){TurbulenzEngine.callOnError("3D texture mipmap generation unsupported");return}if(this.cubemap&&e!==5)return;var t=this.gd,n=t.gl,r=this.target;t.bindTexture(r,this.glTexture),n.generateMipmap(r),t.bindTexture(r,null)}},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glTexture;if(t){var n=e.gl;n&&(e.unbindTexture(t),n.deleteTexture(t)),delete this.glTexture}delete this.sampler,delete this.gd}},e.prototype.typedArrayIsValid=function(e){var t=this.gd,n=this.format;if(t){if(n===t.PIXELFORMAT_A8||n===t.PIXELFORMAT_L8||n===t.PIXELFORMAT_S8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===this.width*this.height*this.depth;if(n===t.PIXELFORMAT_L8A8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===2*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R8G8B8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===3*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R8G8B8A8)return(e instanceof Uint8Array||typeof Uint8ClampedArray!="undefined"&&e instanceof Uint8ClampedArray)&&e.length===4*this.width*this.height*this.depth;if(n===t.PIXELFORMAT_R5G5B5A1||n===t.PIXELFORMAT_R5G6B5||n===t.PIXELFORMAT_R4G4B4A4)return e instanceof Uint16Array&&e.length===this.width*this.height*this.depth}return!1},e.create=function(t,n){var r=new e;r.gd=t,r.mipmaps=n.mipmaps,r.dynamic=n.dynamic,r.renderable=n.renderable,r.id=++t.counters.textures;var i=n.src;if(i){r.name=n.name||i;var s,o=n.data;o?o[0]===137&&o[1]===80&&o[2]===78&&o[3]===71?s=".png":o[0]!==255||o[1]!==216||o[2]!==255||o[3]!==224&&o[3]!==225?o[0]===68&&o[1]===68&&o[2]===83&&o[3]===32?s=".dds":s=i.slice(-4):s=".jpg":s=i.slice(-4);if(s===".dds"||s===".tga"){if(s===".tga"&&typeof vt!="undefined"){var u={gd:t,onload:function(t,i,s,o,u){r.width=i,r.height=s,r.depth=1,r.format=o,r.cubemap=!1;var a=r.createGLTexture(t);n.onload&&n.onload(a?r:null,u)},onerror:function(t){r.failed=!0,n.onload&&n.onload(null,t)},data:undefined
,src:undefined};return o?u.data=o:u.src=i,vt.create(u),r}if(s===".dds"&&typeof c!="undefined"){var a={gd:t,onload:function(t,i,s,o,u,a,f,l){r.width=i,r.height=s,r.format=o,r.cubemap=a,r.depth=f,1<u&&(r.mipmaps||(r.mipmaps=!0));var c=r.createGLTexture(t);n.onload&&n.onload(c?r:null,l)},onerror:function(t){r.failed=!0,n.onload&&n.onload(null,t)},data:undefined,src:undefined};return o?a.data=o:a.src=i,c.create(a),r}return TurbulenzEngine.callOnError("Missing image loader required for "+i),r=e.create(t,{name:n.name||i,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:n.mipmaps,dynamic:n.dynamic,renderable:n.renderable,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),n.onload&&(TurbulenzEngine?TurbulenzEngine.setTimeout(function(){n.onload(r,200)},0):window.setTimeout(function(){n.onload(r,200)},0)),r}var f=new Image,l=function(){r.width=f.width,r.height=f.height,r.depth=1,r.format=t.PIXELFORMAT_R8G8B8A8,r.cubemap=!1;var i=r.createGLTexture(f);n.onload&&n.onload(i?r:null,200)};f.onload=l,f.onerror=function(){r.failed=!0,n.onload&&n.onload(null)};if(o){if(typeof Blob!="undefined"&&typeof URL!="undefined"&&URL.createObjectURL){var h;s===".jpg"||s===".jpeg"?h=new Blob([o],{type:"image/jpeg"}):s===".png"&&(h=new Blob([o],{type:"image/png"})),f.onload=function(){l(),URL.revokeObjectURL(f.src),h=null},i=URL.createObjectURL(h)}else s===".jpg"||s===".jpeg"?i="data:image/jpeg;base64,"+TurbulenzEngine.base64Encode(o):s===".png"&&(i="data:image/png;base64,"+TurbulenzEngine.base64Encode(o));f.src=i}else if(typeof URL!="undefined"&&URL.createObjectURL){var p=new XMLHttpRequest;p.onreadystatechange=function(){if(p.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=p.status;e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(p.getAllResponseHeaders()===""&&!p.response)n.onload&&n.onload(null,0);else if(e===200||e===0){var t=p.response;f.onload=function(){l(),URL.revokeObjectURL(f.src),t=null},f.src=URL.createObjectURL(t)}else n.onload(null,e);p.onreadystatechange=null,p=null}return r}},p.open("GET",i,!0),p.responseType="blob",p.send()}else f.crossOrigin="anonymous",f.src=i}else{if(""===i&&n.onload)return null;var d=n.format;typeof d=="string"&&(d=t["PIXELFORMAT_"+d]),r.width=n.width,r.height=n.height,r.depth=n.depth,r.format=d,r.cubemap=n.cubemap,r.name=n.name;var v=r.createGLTexture(n.data);v||(r=null),n.renderable&&(t.PIXELFORMAT_D16===d?r.glDepthAttachment=t.gl.DEPTH_ATTACHMENT:t.PIXELFORMAT_D24S8===d&&(r.glDepthAttachment=t.gl.DEPTH_STENCIL_ATTACHMENT)),n.onload&&n.onload(r,200)}return r},e.version=1,e}(),p=function(){function e(){}return e.prototype.play=function(e){var t=this.video;this.playing||(this.playing=!0,this.paused=!1),e===undefined&&(e=0);if(.01<Math.abs(t.currentTime-e))try{t.currentTime=e}catch(n){}return t.play(),!0},e.prototype.stop=function(){var e=this.playing;if(e){this.playing=!1,this.paused=!1;var t=this.video;t.pause(),t.currentTime=0}return e},e.prototype.pause=function(){return this.playing?(this.paused||(this.paused=!0,this.video.pause()),!0):!1},e.prototype.resume=function(e){if(this.paused){this.paused=!1;var t=this.video;if(e!==undefined&&.01<Math.abs(t.currentTime-e))try{t.currentTime=e}catch(n){}return t.play(),!0}return!1},e.prototype.rewind=function(){return this.playing?(this.video.currentTime=0,!0):!1},e.prototype.destroy=function(){this.stop(),this.video&&(this.elementAdded&&(this.elementAdded=!1,TurbulenzEngine.canvas.parentElement.removeChild(this.video)),this.video=null)},e.create=function(t){var n=new e,r=t.onload,i=t.looping,s=t.src,o=navigator.userAgent.toLowerCase(),u=document.createElement("video");u.preload="auto",u.autobuffer=!0,u.muted=!0,i?u.loop!==undefined&&!o.match(/firefox/)?u.loop=!0:u.onended=function(){u.src=s,u.play()}:u.onended=function(){n.playing=!1},n.video=u,n.src=s,n.playing=!1,n.paused=!1,o.match(/safari/)&&!o.match(/chrome/)&&(u.setAttribute("style","visibility: hidden;"),TurbulenzEngine.canvas.parentElement.appendChild(u),n.elementAdded=!0);if(u.webkitDecodedFrameCount!==undefined){var a=-1,f=0;Object.defineProperty(n,"tell",{get:function(){return a!==this.video.webkitDecodedFrameCount&&(a=this.video.webkitDecodedFrameCount,f=this.video.currentTime),f},enumerable:!0,configurable:!1})}else Object.defineProperty(n,"tell",{get:function(){return this.video.currentTime},enumerable:!0,configurable:!1});Object.defineProperty(n,"looping",{get:function(){return i},enumerable:!0,configurable:!1});var l=function(){r&&(r(null),r=null),u.removeEventListener("error",l),u=null,n.video=null,n.playing=!1};u.addEventListener("error",l,!1);var c=function(){n.length=u.duration,n.width=u.videoWidth,n.height=u.videoHeight,r&&(r(n,200),r=null),u.removeEventListener("progress",h),u.removeEventListener("canplaythrough",c)},h=function(){0<u.buffered.length&&u.buffered.end(0)>=u.duration&&c()};return u.addEventListener("progress",h,!1),u.addEventListener("canplaythrough",c,!1),u.crossorigin="anonymous",u.src=s,n},e.version=1,e}(),d=function(){function e(){}return e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&n.deleteRenderbuffer(t),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=new e,i=n.width,s=n.height,o=n.format;typeof o=="string"&&(o=t["PIXELFORMAT_"+o]);if(o!==t.PIXELFORMAT_D24S8&&o!==t.PIXELFORMAT_D16)return null;var u=t.gl,a=u.createRenderbuffer();u.bindRenderbuffer(u.RENDERBUFFER,a);var f,l;return t.PIXELFORMAT_D16===o?(f=u.DEPTH_COMPONENT16,l=u.DEPTH_ATTACHMENT):(f=u.DEPTH_STENCIL,l=u.DEPTH_STENCIL_ATTACHMENT),u.renderbufferStorage(u.RENDERBUFFER,f,i,s),r.width=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_WIDTH),r.height=u.getRenderbufferParameter(u.RENDERBUFFER,u.RENDERBUFFER_HEIGHT),u.bindRenderbuffer(u.RENDERBUFFER,null),r.width<i||r.height<s?(u.deleteRenderbuffer(a),null):(r.gd=t,r.format=o,r.glDepthAttachment=l,r.glBuffer=a,r.id=++t.counters.renderBuffers,r)},e.version=1,e}(),v=function(){function e(){}return e.prototype.copyBox=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},e.prototype.bind=function(){var e=this.gd,t=e.gl;this.colorTexture0&&(e.unbindTexture(this.colorTexture0.glTexture),this.colorTexture1&&(e.unbindTexture(this.colorTexture1.glTexture),this.colorTexture2&&(e.unbindTexture(this.colorTexture2.glTexture),this.colorTexture3&&e.unbindTexture(this.colorTexture3.glTexture)))),this.depthTexture&&e.unbindTexture(this.depthTexture.glTexture),t.bindFramebuffer(t.FRAMEBUFFER,this.glObject);var n=e.drawBuffersExtension;n&&(e.WEBGL_draw_buffers?n.drawBuffersWEBGL(this.buffers):n.drawBuffersEXT(this.buffers));var r=e.state;return this.copyBox(this.oldViewportBox,r.viewportBox),this.copyBox(this.oldScissorBox,r.scissorBox),e.setViewport(0,0,this.width,this.height),e.setScissor(0,0,this.width,this.height),!0},e.prototype.unbind=function(){var e=this.gd,t=e.gl;t.bindFramebuffer(t.FRAMEBUFFER,null);var n=e.drawBuffersExtension;if(n){var r=[t.BACK];e.WEBGL_draw_buffers?n.drawBuffersWEBGL(r):n.drawBuffersEXT(r)}var i=this.oldViewportBox;e.setViewport(i[0],i[1],i[2],i[3]),i=this.oldScissorBox,e.setScissor(i[0],i[1],i[2],i[3]),this.colorTexture0&&(this.colorTexture0.updateMipmaps(this.face),this.colorTexture1&&(this.colorTexture1.updateMipmaps(this.face),this.colorTexture2&&(this.colorTexture2.updateMipmaps(this.face),this.colorTexture3&&this.colorTexture3.updateMipmaps(this.face)))),this.depthTexture&&this.depthTexture.updateMipmaps(this.face)},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glObject;if(t){var n=e.gl;n&&n.deleteFramebuffer(t),delete this.glObject}delete this.colorTexture0,delete this.colorTexture1,delete this.colorTexture2,delete this.colorTexture3,delete this.depthBuffer,delete this.depthTexture,delete this.gd}},e.create=function(t,n){var r=new e,i=n.colorTexture0,s=i?n.colorTexture1||null:null,o=s?n.colorTexture2||null:null,u=o?n.colorTexture3||null:null,a=n.depthBuffer||null,f=n.depthTexture||null,l=n.face,c=t.maxSupported("RENDERTARGET_COLOR_TEXTURES");if(s&&c<2)return null;if(o&&c<3)return null;if(u&&c<4)return null;var h=t.gl,p=h.COLOR_ATTACHMENT0,d=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,d);var v,m;if(i){v=i.width,m=i.height;var g=i.glTexture;if(g===undefined)return TurbulenzEngine.callOnError("Color texture is not a Texture"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;i.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p,h.TEXTURE_2D,g,0),s&&(g=s.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+1,h.TEXTURE_2D,g,0),o&&(g=o.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+2,h.TEXTURE_2D,g,0),u&&(g=u.glTexture,s.cubemap?h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_CUBE_MAP_POSITIVE_X+l,g,0):h.framebufferTexture2D(h.FRAMEBUFFER,p+3,h.TEXTURE_2D,g,0))))}else if(f)v=f.width,m=f.height;else{if(!a)return TurbulenzEngine.callOnError("No RenderBuffers or Textures specified for this RenderTarget"),h.bindFramebuffer(h.FRAMEBUFFER,null),h.deleteFramebuffer(d),null;v=a.width,m=a.height}f?h.framebufferTexture2D(h.FRAMEBUFFER,f.glDepthAttachment,h.TEXTURE_2D,f.glTexture,0):a&&h.framebufferRenderbuffer(h.FRAMEBUFFER,a.glDepthAttachment,h.RENDERBUFFER,a.glBuffer);var y=h.checkFramebufferStatus(h.FRAMEBUFFER);h.bindFramebuffer(h.FRAMEBUFFER,null);if(y!==h.FRAMEBUFFER_COMPLETE)return h.deleteFramebuffer(d),null;r.gd=t,r.glObject=d,r.colorTexture0=i,r.colorTexture1=s,r.colorTexture2=o,r.colorTexture3=u,r.depthBuffer=a,r.depthTexture=f,r.width=v,r.height=m,r.face=l;if(t.drawBuffersExtension){var b;i?(b=[p],s&&(b.push(p+1),o&&(b.push(p+2),u&&b.push(p+3)))):b=[h.NONE],r.buffers=b}return r.id=++t.counters.renderTargets,r},e.version=1,e}();v.prototype.oldViewportBox=[],v.prototype.oldScissorBox=[];var m=function(){function e(){}return e.prototype.map=function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.numIndices);var n=this.gd,r=n.gl,i=this.format,s;i===r.UNSIGNED_BYTE?s=new Uint8Array(t):i===r.UNSIGNED_SHORT?s=new Uint16Array(t):s=new Uint32Array(t);var o=0,u=function(){var t=arguments.length;for(var n=0;n<t;n+=1)s[o]=arguments[n],o+=1};return u.write=u,u.data=s,u.offset=e,u.getNumWrittenIndices=function(){return o},u.write=u,u},e.prototype.unmap=function(e){if(e){var t=this.gd,n=t.gl,r=e.data;delete e.data;var i=e.offset;delete e.write;var s=e.getNumWrittenIndices();if(!s)return;s<r.length&&(r=r.subarray(0,s)),t.setIndexBuffer(this),s<this.numIndices?n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,i,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,r,this.usage)}},e.prototype.setData=function(e,t,n){t===undefined&&(t=0),n===undefined&&(n=this.numIndices);var r=this.gd,i=r.gl,s,o=this.format;o===i.UNSIGNED_BYTE?e instanceof Uint8Array?s=e:s=new Uint8Array(e):o===i.UNSIGNED_SHORT?(e instanceof Uint16Array?s=e:s=new Uint16Array(e),t*=2):o===i.UNSIGNED_INT&&(e instanceof Uint32Array?s=e:s=new Uint32Array(e),t*=4),e=undefined,n<s.length&&(s=s.subarray(0,n)),r.setIndexBuffer(this),n<this.numIndices?i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,t,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,s,this.usage)},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&(e.unsetIndexBuffer(this),n.deleteBuffer(t)),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.gd=t;var s=n.numIndices;i.numIndices=s;var o=n.format;typeof o=="string"&&(o=t["INDEXFORMAT_"+o]),i.format=o;var u;return o===r.UNSIGNED_BYTE?u=1:o===r.UNSIGNED_SHORT?u=2:u=4,i.stride=u,i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer(),n.data?i.setData(n.data,0,s):(t.setIndexBuffer(i),r.bufferData(r.ELEMENT_ARRAY_BUFFER,s*u,i.usage)),i.id=++t.counters.indexBuffers,i},e.version=1,e}(),g=function(){function e(){}return e.create=function(t,n){var r=new e,i=n.length;r.length=i;for(var s=0;s<i;s+=1){var o=n[s];typeof o=="string"?r[s]=t["SEMANTIC_"+o]:r[s]=o}return r},e.version=1,e}(),y=function(){function e(){}return e.prototype.map=function(e,t){e===undefined&&(e=0),t===undefined&&(t=this.numVertices);var n=this.gd,r=n.gl,i=this.stride,s=this.attributes,o=s.length,u,a,f=0;if(this.hasSingleFormat){var l=t*i,c=s[0].format;c===r.FLOAT?u=new Float32Array(l):c===r.BYTE?u=new Int8Array(l):c===r.UNSIGNED_BYTE?u=new Uint8Array(l):c===r.SHORT?u=new Int16Array(l):c===r.UNSIGNED_SHORT?u=new Uint16Array(l):c===r.INT?u=new Int32Array(l):c===r.UNSIGNED_INT&&(u=new Uint32Array(l)),a=function(){var t=arguments.length,n=0;for(var r=0;r<o;r+=1){var i=s[r],a=i.numComponents,l=0,c;do if(n<t){var h=arguments[n];n+=1;if(typeof h!="number"){if(l===0){var p=h.length;p>a&&(p=a);if(i.normalized){var d=i.normalizationScale;for(c=0;c<p;c+=1)u[f]=h[c]*d,f+=1,l+=1}else for(c=0;c<p;c+=1)u[f]=h[c],f+=1,l+=1;while(l<a)f+=1,l+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(h*=i.normalizationScale),u[f]=h,f+=1,l+=1}else f+=1,l+=1;while(l<a)}}}else{var h=0,p=t*this.strideInBytes;u=new ArrayBuffer(p);if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var d=new DataView(u);a=function(){var t=arguments.length,n=0;for(var r=0;r<o;r+=1){var i=s[r],u=i.numComponents,a=i.typedSetter,l=i.componentStride,c=0,p;do if(n<t){var v=arguments[n];n+=1;if(typeof v!="number"){if(c===0){var m=v.length;m>u&&(m=u);if(i.normalized){var g=i.normalizationScale;for(p=0;p<m;p+=1)a.call(d,h,v[p]*g,!0),h+=l,c+=1,f+=1}else for(p=0;p<m;p+=1)a.call(d,h,v[p],!0),h+=l,c+=1,f+=1;while(c<u)f+=1,c+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+r),null}i.normalized&&(v*=i.normalizationScale),a.call(d,h,v,!0),h+=l,c+=1,f+=1}else f+=1,c+=1;while(c<u)}}}else a=function(){var t=arguments.length,n=0,r;for(var i=0;i<o;i+=1){var a=s[i],l=a.numComponents;r=new a.typedArray(u,h,l),h+=a.stride;var c=0,p;do if(n<t){var d=arguments[n];n+=1;if(typeof d!="number"){if(c===0){var v=d.length;v>l&&(v=l);if(a.normalized){var m=a.normalizationScale;for(p=0;p<v;p+=1)r[c]=d[p]*m,c+=1,f+=1}else for(p=0;p<v;p+=1)r[c]=d[p],c+=1,f+=1;while(c<l)c+=1,f+=1;break}return TurbulenzEngine.callOnError("Missing values for attribute "+i),null}a.normalized&&(d*=a.normalizationScale),r[c]=d,c+=1,f+=1}else c+=1,f+=1;while(c<l)}}}return a.data=u,a.offset=e,a.getNumWrittenVertices=function(){return Math.floor(f/i)},a.getNumWrittenValues=function(){return f},a.write=a,a},e.prototype.unmap=function(e){if(e){var t=e.data;delete e.data,delete e.write;var n=e.getNumWrittenVertices();if(!n)return;var r=e.offset,i=this.strideInBytes;if(this.hasSingleFormat){var s=e.getNumWrittenValues();s<t.length&&(t=t.subarray(0,s))}else{var o=n*i;o<t.byteLength&&(t=t.slice(0,o))}var u=this.gd,a=u.gl;u.bindVertexBuffer(this.glBuffer),n<this.numVertices?a.bufferSubData(a.ARRAY_BUFFER,r*i,t):a.bufferData(a.ARRAY_BUFFER,t,this.usage)}},e.prototype.setData=function(e,t,n){t===undefined&&(t=0),n===undefined&&(n=this.numVertices);var r=this.gd,i=r.gl,s=this.strideInBytes;if(e.constructor===ArrayBuffer){r.bindVertexBuffer(this.glBuffer),n<this.numVertices?i.bufferSubData(i.ARRAY_BUFFER,t*s,e):i.bufferData(i.ARRAY_BUFFER,e,this.usage);return}var o=this.attributes,u=this.numAttributes,a,f,l,c;if(this.hasSingleFormat){a=o[0],f=a.format,f===i.FLOAT?e instanceof Float32Array||(c=Float32Array):f===i.BYTE?e instanceof Int8Array||(c=Int8Array):f===i.UNSIGNED_BYTE?e instanceof Uint8Array||(c=Uint8Array):f===i.SHORT?e instanceof Int16Array||(c=Int16Array):f===i.UNSIGNED_SHORT?e instanceof Uint16Array||(c=Uint16Array):f===i.INT?e instanceof Int32Array||(c=Int32Array):f===i.UNSIGNED_INT&&(e instanceof Uint32Array||(c=Uint32Array));var h=this.stride,p=n*h;c?(a.normalized&&(e=this.scaleValues(e,a.normalizationScale,p)),l=new c(e),p<l.length&&(l=l.subarray(0,p))):l=e,p<e.length&&(l=l.subarray(0,p))}else{var d=n*s;l=new ArrayBuffer(d);var v=0,m=0,g,y,b,w,E,S;if(typeof DataView!="undefined"&&"setFloat32"in DataView.prototype){var x=new DataView(l);for(g=0;g<n;g+=1)for(b=0;b<u;b+=1){a=o[b],w=a.numComponents,E=a.componentStride;var T=a.typedSetter;if(a.normalized){S=a.normalizationScale;for(y=0;y<w;y+=1)T.call(x,m,e[v]*S,!0),m+=E,v+=1}else for(y=0;y<w;y+=1)T.call(x,m,e[v],!0),m+=E,v+=1}}else for(g=0;g<n;g+=1)for(b=0;b<u;b+=1){a=o[b],w=a.numComponents;var N=new a.typedArray(l,m,w);m+=a.stride;if(a.normalized){S=a.normalizationScale;for(y=0;y<w;y+=1)N[y]=e[v]*S,v+=1}else for(y=0;y<w;y+=1)N[y]=e[v],v+=1}}e=undefined,r.bindVertexBuffer(this.glBuffer),n<this.numVertices?i.bufferSubData(i.ARRAY_BUFFER,t*s,l):i.bufferData(i.ARRAY_BUFFER,l,this.usage)},e.prototype.scaleValues=function(e,t,n){n===undefined&&(n=e.length);var r=new e.constructor(n);for(var i=0;i<n;i+=1)r[i]=e[i]*t;return r},e.prototype.bindAttributes=function(e,t,n){var r=this.gd,i=r.gl,s=this.attributes,o=this.strideInBytes,u=0;for(var a=0;a<e;a+=1){var f=s[a],l=t[a];u|=1<<l,i.vertexAttribPointer(l,f.numComponents,f.format,f.normalized,o,n),n+=f.stride}return u},e.prototype.setAttributes=function(e){var t=this.gd,n=e.length;this.numAttributes=n,this.attributes=[];var r=0,i=0,s=!0;for(var o=0;o<n;o+=1){var u=e[o];typeof u=="string"&&(u=t["VERTEXFORMAT_"+u]),this.attributes[o]=u,r+=u.stride,i+=u.numComponents,s&&o&&u.format!==this.attributes[o-1].format&&(s=!1)}return this.strideInBytes=r,this.stride=i,this.hasSingleFormat=s,r},e.prototype.resize=function(e){if(e!==this.strideInBytes*this.numVertices){var t=this.gd,n=t.gl;t.bindVertexBuffer(this.glBuffer);var r=n.ARRAY_BUFFER;n.bufferData(r,e,this.usage);var i=n.getBufferParameter(r,n.BUFFER_SIZE);this.numVertices=Math.floor(i/this.strideInBytes)}},e.prototype.destroy=function(){var e=this.gd;if(e){var t=this.glBuffer;if(t){var n=e.gl;n&&(e.unbindVertexBuffer(t),n.deleteBuffer(t)),delete this.glBuffer}delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.gd=t;var s=n.numVertices;i.numVertices=s;var o=i.setAttributes(n.attributes);i["transient"]=n["transient"]||!1,i.dynamic=n.dynamic||i["transient"],i.usage=i["transient"]?r.STREAM_DRAW:i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW,i.glBuffer=r.createBuffer();var u=s*o;return n.data?i.setData(n.data,0,s):(t.bindVertexBuffer(i.glBuffer),r.bufferData(r.ARRAY_BUFFER,u,i.usage)),i.id=++t.counters.vertexBuffers,i},e.version=1,e}(),b=function(){function e(){}return e.prototype.updateParametersData=function(e){var t=e.gl;this.dirty=!1;var n=this.parameters;for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i.dirty){i.dirty=0;var s=i.info,o=i.location;if(s&&null!==o){var u=s.values,a;s.type==="float"?(a=s.columns,4===a?t.uniform4fv(o,u):3===a?t.uniform3fv(o,u):2===a?t.uniform2fv(o,u):1===s.rows?t.uniform1f(o,u[0]):t.uniform1fv(o,u)):s.sampler!==undefined?e.setTexture(i.textureUnit,u,s.sampler):(a=s.columns,4===a?t.uniform4iv(o,u):3===a?t.uniform3iv(o,u):2===a?t.uniform2iv(o,u):1===s.rows?t.uniform1i(o,u[0]):t.uniform1iv(o,u))}}}},e.prototype.initializeParameters=function(e){var t=e.gl,n=this.glProgram;e.setProgram(n);var r=this.parameters;for(var i in r)if(r.hasOwnProperty(i)){var s=r[i],o=s.info;if(o){var u=t.getUniformLocation(n,i);if(null!==u){s.location=u;if(o.sampler)t.uniform1i(u,s.textureUnit);else{var a=o.values,f;o.type==="float"?(f=o.columns,4===f?t.uniform4fv(u,a):3===f?t.uniform3fv(u,a):2===f?t.uniform2fv(u,a):1===o.rows?t.uniform1f(u,a[0]):t.uniform1fv(u,a)):(f=o.columns,4===f?t.uniform4iv(u,a):3===f?t.uniform3iv(u,a):2===f?t.uniform2iv(u,a):1===o.rows?t.uniform1i(u,a[0]):t.uniform1iv(u,a))}}}}},e.prototype.destroy=function(){delete this.glProgram,delete this.semanticsMask,delete this.parameters,delete this.states,delete this.statesSet},e.create=function(t,n,r){function O(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}var i=t.gl,s=new e;s.name=r.name||null;var o=n.programs,u=n.parameters,a=r.parameters,f=r.programs,l=r.semantics,c=r.states,h=f.join(":"),p=n.linkedPrograms[h],d,v,m,g;if(p===undefined){d=i.createProgram();var y=f.length;for(m=0;m<y;m+=1){var b=o[f[m]];b&&i.attachShader(d,b)}var w=l.length;v=0;for(g=0;g<w;g+=1){var E=l[g],S=t["SEMANTIC_"+E];if(S!==undefined){v|=1<<S;if(0===E.indexOf("ATTR"))i.bindAttribLocation(d,S,E);else{var x=e.semanticToAttr[E];i.bindAttribLocation(d,S,x)}}}i.linkProgram(d),n.linkedPrograms[h]={glProgram:d,semanticsMask:v}}else d=p.glProgram,v=p.semanticsMask;s.glProgram=d,s.semanticsMask=v;var T=0,N={};s.parameters=N;var C=a?a.length:0;for(m=0;m<C;m+=1){var k=a[m],L={};N[k]=L;var A=u[k];L.info=A,A&&(L.location=null,A.sampler?(L.textureUnit=T,T+=1):L.textureUnit=undefined)}s.numTextureUnits=T,s.numParameters=C;var M=t.stateHandlers,_=[],D={};s.states=_,s.statesSet=D;for(g in c)if(c.hasOwnProperty(g)){var P=M[g];if(P){var H=P.parse(c[g]);if(H!==null){if(O(P.defaultValues,H))continue;_.push({name:g,set:P.set,reset:P.reset,values:H}),D[g]=!0}else TurbulenzEngine.callOnError("Unknown value for state "+g+": "+c[g])}}return s},e.version=1,e.semanticToAttr={POSITION:"ATTR0",POSITION0:"ATTR0",BLENDWEIGHT:"ATTR1",BLENDWEIGHT0:"ATTR1",NORMAL:"ATTR2",NORMAL0:"ATTR2",COLOR:"ATTR3",COLOR0:"ATTR3",COLOR1:"ATTR4",SPECULAR:"ATTR4",FOGCOORD:"ATTR5",TESSFACTOR:"ATTR5",PSIZE0:"ATTR6",BLENDINDICES:"ATTR7",BLENDINDICES0:"ATTR7",TEXCOORD:"ATTR8",TEXCOORD0:"ATTR8",TEXCOORD1:"ATTR9",TEXCOORD2:"ATTR10",TEXCOORD3:"ATTR11",TEXCOORD4:"ATTR12",TEXCOORD5:"ATTR13",TEXCOORD6:"ATTR14",TEXCOORD7:"ATTR15",TANGENT:"ATTR14",TANGENT0:"ATTR14",BINORMAL0:"ATTR15",BINORMAL:"ATTR15",PSIZE:"ATTR6"},e}(),w=function(){function e(){}return e.prototype.getPass=function(e){var t=this.passes,n=t.length;if(typeof e=="string")for(var r=0;r<n;r+=1){var i=t[r];if(i.name===e)return i}else{e|=0;if(e<n)return t[e]}return null},e.prototype.activate=function(e){this.device=e,this.initialized||(this.shader.initialize(e),this.initialize(e))},e.prototype.deactivate=function(){this.device=null},e.prototype.checkProperties=function(e){var t={},n;for(n in this)n!=="version"&&n!=="name"&&n!=="id"&&n!=="passes"&&n!=="numPasses"&&n!=="device"&&n!=="numParameters"&&(t[n]=this[n]);if(t){var r=this.passes;r.length===1?e.setParametersImmediate(r[0].parameters,t):e.setParametersDeferred(e,r,t);for(n in t)t.hasOwnProperty(n)&&delete this[n]}},e.prototype.initialize=function(e){if(this.initialized)return;var t=this.passes;if(t){var n=t.length,r;for(r=0;r<n;r+=1)t[r].initializeParameters(e)}Object.defineProperty&&this.initializeParametersSetters(e),this.initialized=!0},e.prototype.initializeParametersSetters=function(e){function n(t,n){return function(r){this.device?e.setTexture(n.textureUnit,r,n.info.sampler):(t.dirty=!0,n.dirty=1,n.info.values=r)}}function r(e,n){function s(t){if(typeof t!="number"){var i=r.values,s=Math.min(r.numValues,t.length);for(var o=0;o<s;o+=1)i[o]=t[o];n.dirty=Math.max(s,n.dirty||0)}else r.values[0]=t,n.dirty=n.dirty||1;e.dirty=!0}var r=n.info,i=n.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?t.uniform1f(i,e):s(e)};return function(e){this.device?t.uniform1fv(i,e):s(e)};case 2:return function(e){this.device?t.uniform2fv(i,e):s(e)};case 3:return function(e){this.device?t.uniform3fv(i,e):s(e)};case 4:return function(e){this.device?t.uniform4fv(i,e):s(e)};default:return null}}function i(e,n){function s(t){if(typeof t!="number"){var i=r.values,s=Math.min(r.numValues,t.length);for(var o=0;o<s;o+=1)i[o]=t[o];n.dirty=Math.max(s,n.dirty||0)}else r.values[0]=t,n.dirty=n.dirty||1;e.dirty=!0}var r=n.info,i=n.location;switch(r.columns){case 1:if(1===r.numValues)return function(e){this.device?t.uniform1i(i,e):s(e)};return function(e){this.device?t.uniform1iv(i,e):s(e)};case 2:return function(e){this.device?t.uniform2iv(i,e):s(e)};case 3:return function(e){this.device?t.uniform3iv(i,e):s(e)};case 4:return function(e){this.device?t.uniform4iv(i,e):s(e)};default:return null}}var t=e.gl,s=this.passes,o=s.length,u,a,f,l,c,h;if(o===1){u=s[0],a=u.parameters;for(f in a)a.hasOwnProperty(f)&&(l=a[f],c=l.info,c&&undefined!==l.location&&(c.sampler?h=n(u,l):c.type==="float"?h=r(u,l):h=i(u,l),Object.defineProperty(this,f,{set:h,enumerable:!1,configurable:!1})));this.checkProperties=null}else Object.defineProperty(this,"device",{writable:!0,enumerable:!1,configurable:!1}),Object.defineProperty(this,"version",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"name",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"id",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"passes",{writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(this,"numParameters",{writable:!1,enumerable:!1,configurable:!1})},e.prototype.destroy=function(){var e=this.passes;if(e){var t=e.length,n;for(n=0;n<t;n+=1)e[n].destroy();e.length=0,delete this.passes}delete this.device},e.create=function(t,n,r,i){var s=new e;s.initialized=!1,s.shader=n,s.name=r;var o=i.length,u,a=0;s.passes=[],s.numPasses=o;for(u=0;u<o;u+=1){var f=i[u];f.parameters&&(a+=f.parameters.length),s.passes[u]=b.create(t,n,f)}return s.numParameters=a,s.device=null,s.id=++t.counters.techniques,1<o&&t.drawArray!==t.drawArrayMultiPass&&(t.drawArray=t.drawArrayMultiPass),s},e.version=1,e}(),E=function(){function e(){}return e.prototype.getTechnique=function(e){if(typeof e=="string")return this.techniques[e];var t=this.techniques;for(var n in t)if(t.hasOwnProperty(n)){if(e===0)return t[n];e-=1}return null},e.prototype.getParameter=function(e){if(typeof e=="string")return this.parameters[e];e|=0;var t=this.parameters;for(var n in t)if(t.hasOwnProperty(n)){if(e===0)return t[n];e-=1}return null},e.prototype.initialize=function(e){if(this.initialized)return;var t=e.gl,n,r=this.programs;for(n in r)if(r.hasOwnProperty(n)){var i=r[n],s=t.getShaderParameter(i,t.COMPILE_STATUS);if(!s){var o=t.getShaderInfoLog(i);TurbulenzEngine.callOnError('Program "'+n+'" failed to compile: '+o)}}var u=this.linkedPrograms;for(n in u)if(u.hasOwnProperty(n)){var a=u[n],f=a.glProgram;if(f){var l=t.getProgramParameter(f,t.LINK_STATUS);if(!l){var c=t.getProgramInfoLog(f);TurbulenzEngine.callOnError('Program "'+n+'" failed to link: '+c)}}}this.initialized=!0},e.prototype.destroy=function(){var e=this.gd;if(e){var t=e.gl,n,r=this.techniques;if(r){for(n in r)r.hasOwnProperty(n)&&r[n].destroy();delete this.techniques}var i=this.linkedPrograms;if(i){if(t)for(n in i)if(i.hasOwnProperty(n)){var s=i[n],o=s.glProgram;o&&(t.deleteProgram(o),delete s.glProgram)}delete this.linkedPrograms}var u=this.programs;if(u){if(t)for(n in u)u.hasOwnProperty(n)&&t.deleteShader(u[n]);delete this.programs}delete this.samplers,delete this.parameters,delete this.gd}},e.create=function(t,n){var r=t.gl,i=new e;i.initialized=!1;var s=n.techniques,o=n.parameters,u=n.programs,a=n.samplers,f;i.gd=t,i.name=n.name;var l={};i.programs=l;for(f in u)if(u.hasOwnProperty(f)){var c=u[f],h;c.type==="fragment"?h=r.FRAGMENT_SHADER:c.type==="vertex"&&(h=r.VERTEX_SHADER);var p=r.createShader(h),d=c.code;t.fixIE&&(d=d.replace(/#.*\n/g,""),d=d.replace(/TZ_LOWP/g,""),-1!==d.indexOf("texture2DProj")&&(d="vec4 texture2DProj(sampler2D s, vec3 uv){ return texture2D(s, uv.xy / uv.z); }\n"+d)),r.shaderSource(p,d),r.compileShader(p),l[f]=p}var v={};i.linkedPrograms=v;var m=t.DEFAULT_SAMPLER,g=t.maxAnisotropy;i.samplers={};var y;for(f in a)if(a.hasOwnProperty(f)){y=a[f];var b=y.MaxAnisotropy;b?b>g&&(b=g):b=m.maxAnisotropy,y={minFilter:y.MinFilter||m.minFilter,magFilter:y.MagFilter||m.magFilter,wrapS:y.WrapS||m.wrapS,wrapT:y.WrapT||m.wrapT,wrapR:y.WrapR||m.wrapR,maxAnisotropy:b},y.wrapS===10496&&(y.wrapS=r.CLAMP_TO_EDGE),y.wrapT===10496&&(y.wrapT=r.CLAMP_TO_EDGE),y.wrapR===10496&&(y.wrapR=r.CLAMP_TO_EDGE),i.samplers[f]=t.createSampler(y)}var E=0;i.parameters={};for(f in o)if(o.hasOwnProperty(f)){var S=o[f];S.columns||(S.columns=1),S.rows||(S.rows=1),S.numValues=S.columns*S.rows;var x=S.type;if(x==="float"||x==="int"||x==="bool"){var T=S.values;T?x==="float"?S.values=new Float32Array(T):S.values=new Int32Array(T):x==="float"?S.values=new Float32Array(S.numValues):S.values=new Int32Array(S.numValues),S.sampler=undefined}else y=i.samplers[f],y||(y=m,i.samplers[f]=m),S.sampler=y,S.values=null;S.name=f,i.parameters[f]=S,E+=1}i.numParameters=E;var N={},C=0;i.techniques=N;for(f in s)s.hasOwnProperty(f)&&(N[f]=w.create(t,i,f,s[f]),C+=1);return i.numTechniques=C,i.id=++t.counters.shaders,i},e.version=1,e}(),S=function(){function e(){}return e.create=function(t){var n=new e;if(t)for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},e}(),x=function(t){return Float32Array.prototype.map===undefined&&(Float32Array.prototype.map=function(t,n){function i(){var e=arguments.length;for(var n=0;n<e;n+=1){var i=arguments[n];typeof i=="number"?(r[t]=i,t+=1):(r.setData(i,t,i.length),t+=i.length)}}t===undefined&&(t=0);var r=this;return n===undefined&&(n=this.length),i},Float32Array.prototype.unmap=function(t){},Float32Array.prototype.setData=function(t,n,r){n===undefined&&(n=0),r===undefined&&(r=this.length);for(var i=0;i<r;i+=1,n+=1)this[n]=t[i]}),new Float32Array(t.numFloats)},T=function(){function e(){return this.sortKey=0,this.technique=null,this.endStreams=0,this.endTechniqueParameters=48,this.endInstances=56,this.indexBuffer=null,this.primitive=-1,this.count=0,this.firstIndex=0,this.userData=null,this[0]=null,this[1]=null,this[2]=0,this[48]=null,this[49]=null,this}return e.prototype.setTechniqueParameters=function(e,t){if(e<8){e+=48,this[e]=t;var n=this.endTechniqueParameters;if(t)n<=e&&(this.endTechniqueParameters=e+1);else{while(48<n&&!this[n-1])n-=1;this.endTechniqueParameters=n}}},e.prototype.setVertexBuffer=function(e,t){if(e<16){e*=3,this[e]=t;var n=this.endStreams;if(t)n<=e&&(this.endStreams=e+3);else{while(0<n&&!this[n-3])n-=3;this.endStreams=n}}},e.prototype.setSemantics=function(e,t){e<16&&(this[e*3+1]=t)},e.prototype.setOffset=function(e,t){e<16&&(this[e*3+2]=t)},e.prototype.getTechniqueParameters=function(e){return e<8?this[e+48]:undefined},e.prototype.getVertexBuffer=function(e){return e<16?this[e*3+0]:undefined},e.prototype.getSemantics=function(e){return e<16?this[e*3+1]:undefined},e.prototype.getOffset=function(e){return e<16?this[e*3+2]:undefined},e.prototype.addInstance=function(e){if(e){var t=this.endInstances;this.endInstances=t+1,this[t]=e}},e.prototype.removeInstances=function(){this.endInstances=56},e.prototype.getNumInstances=function(){return this.endInstances-56},e.create=function(){return new e},e.version=1,e}(),N=function(){function e(){}return e.prototype.drawIndexed=function(e,t,n){var r=this.gl,i=this.activeIndexBuffer,s;n?s=n*i.stride:s=0;var o=i.format,u=this.attributeMask,a=this.activeTechnique,f=a.passes,l=f.length,c;a.checkProperties&&a.checkProperties(this);if(1===l)c=f[0].semanticsMask&u,c!==this.clientStateMask&&this.enableClientState(c),r.drawElements(e,t,o,s);else for(var h=0;h<l;h+=1){var p=f[h];c=p.semanticsMask&u,c!==this.clientStateMask&&this.enableClientState(c),this.setPass(p),r.drawElements(e,t,o,s)}},e.prototype.draw=function(e,t,n){var r=this.gl,i=this.attributeMask,s=this.activeTechnique,o=s.passes,u=o.length,a;s.checkProperties&&s.checkProperties(this);if(1===u)a=o[0].semanticsMask&i,a!==this.clientStateMask&&this.enableClientState(a),r.drawArrays(e,n,t);else for(var f=0;f<u;f+=1){var l=o[f];a=l.semanticsMask&i,a!==this.clientStateMask&&this.enableClientState(a),this.setPass(l),r.drawArrays(e,n,t)}},e.prototype.setTechniqueParameters=function(){var e=this.activeTechnique,t=e.passes,n=arguments.length;if(1===t.length){var r=t[0].parameters;for(var i=0;i<n;i+=1)this.setParametersImmediate(r,arguments[i])}else for(var i=0;i<n;i+=1)this.setParametersDeferred(this,t,arguments[i])},e.prototype.setParametersImmediate=function(e,t){var n=this.gl;for(var r in t){var i=e[r];if(i!==undefined){var s=t[r];if(s!==undefined){var o=i.info,u,a;o.type==="float"?(u=o.columns,a=i.location,4===u?n.uniform4fv(a,s):3===u?n.uniform3fv(a,s):2===u?n.uniform2fv(a,s):1===o.rows?n.uniform1f(a,s):n.uniform1fv(a,s)):o.sampler!==undefined?this.setTexture(i.textureUnit,s,o.sampler):(u=o.columns,a=i.location,4===u?n.uniform4iv(a,s):3===u?n.uniform3iv(a,s):2===u?n.uniform2iv(a,s):1===o.rows?n.uniform1i(a,s):n.uniform1iv(a,s))}else delete t[r]}}},e.prototype.setParametersCaching=function(e,t){var n=this.gl;for(var r in t){var i=e[r];if(i!==undefined){var s=t[r];if(i.value!==s)if(s!==undefined){i.value=s;var o=i.info,u,a;o.type==="float"?(u=o.columns,a=i.location,4===u?n.uniform4fv(a,s):3===u?n.uniform3fv(a,s):2===u?n.uniform2fv(a,s):1===o.rows?n.uniform1f(a,s):n.uniform1fv(a,s)):o.sampler!==undefined?this.setTexture(i.textureUnit,s,o.sampler):(u=o.columns,a=i.location,4===u?n.
uniform4iv(a,s):3===u?n.uniform3iv(a,s):2===u?n.uniform2iv(a,s):1===o.rows?n.uniform1i(a,s):n.uniform1iv(a,s))}else delete t[r]}}},e.prototype.setParametersCachingMultiPass=function(e,t,n){e.setParametersCaching(t[0].parameters,n)},e.prototype.setParametersDeferred=function(e,t,n){var r=t.length,i=Math.min,s=Math.max;for(var o=0;o<r;o+=1){var u=t[o],a=u.parameters;u.dirty=!0;for(var f in n){var l=a[f];if(l){var c=n[f];if(c!==undefined){var h=l.info;if(h.sampler)h.values=c,l.dirty=1;else if(typeof c!="number"){var p=h.values,d=i(h.numValues,c.length);for(var v=0;v<d;v+=1)p[v]=c[v];l.dirty=s(d,l.dirty||0)}else h.values[0]=c,l.dirty=l.dirty||1}else delete n[f]}}}},e.prototype.setTechnique=function(e){var t=this.activeTechnique;if(t!==e){t&&t.deactivate(),this.activeTechnique=e,e.activate(this);var n=e.passes;1===n.length&&this.setPass(n[0])}},e.prototype.setTechniqueCaching=function(e){var t=e.passes[0],n=this.activeTechnique;n!==e&&(n&&n.deactivate(),this.activeTechnique=e,e.activate(this),this.setPass(t));var r=t.parameters;for(var i in r)r.hasOwnProperty(i)&&(r[i].value=null)},e.prototype.setStream=function(e,t,n){n?n*=e.strideInBytes:n=0,this.bindVertexBuffer(e.glBuffer);var r=t,i=r.length;i>e.numAttributes&&(i=e.numAttributes),this.attributeMask|=e.bindAttributes(i,r,n)},e.prototype.setIndexBuffer=function(e){if(this.activeIndexBuffer!==e){this.activeIndexBuffer=e;var t;e?t=e.glBuffer:t=null;var n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t)}},e.prototype.drawArray=function(e,t,n){var r=this.gl,i=r.ELEMENT_ARRAY_BUFFER,s=t.length,o=e.length;o>1&&n&&(n>0?e.sort(this._drawArraySortPositive):e.sort(this._drawArraySortNegative));var u=this.activeIndexBuffer,a=this.attributeMask,f=null,l=-1,c=null,h=null,p=0,d=!1,v=null,m=null,g=null,y=null,b=0,w=0,E=0,S=0;u&&(b=u.format,w=u.stride);for(var x=0;x<o;x+=1){var T=e[x],N=T.technique,C=T.endTechniqueParameters,k=T.endStreams,L=T.endInstances,A=T.indexBuffer,O=T.primitive,M=T.count,_=T.firstIndex;if(f!==N){f=N,this.setTechniqueCaching(N),m=N.passes[0],g=m.parameters,E=m.semanticsMask&a,E!==this.clientStateMask&&this.enableClientState(E),N.checkProperties&&N.checkProperties(this);for(S=0;S<s;S+=1)this.setParametersCaching(g,t[S])}for(S=48;S<C;S+=1)h=T[S],h&&this.setParametersCaching(g,h);d=l===k;for(p=0;d&&p<k;p+=3)d=c[p]===T[p]&&c[p+1]===T[p+1]&&c[p+2]===T[p+2];if(!d){l=k;for(p=0;p<k;p+=3)v=T[p],v&&this.setStream(v,T[p+1],T[p+2]);a=this.attributeMask,E=m.semanticsMask&a,E!==this.clientStateMask&&this.enableClientState(E)}c=T;if(A){u!==A&&(u=A,r.bindBuffer(i,A.glBuffer),b=A.format,w=A.stride),_*=w,S=56;if(S<L){do this.setParametersCaching(g,T[S]),r.drawElements(O,M,b,_),S+=1;while(S<L)}else r.drawElements(O,M,b,_)}else{S=56;if(S<L){do this.setParametersCaching(g,T[S]),r.drawArrays(O,_,M),S+=1;while(S<L)}else r.drawArrays(O,_,M)}}this.activeIndexBuffer=u},e.prototype.drawArrayMultiPass=function(e,t,n){var r=this.gl,i=r.ELEMENT_ARRAY_BUFFER,s=this.setParametersCachingMultiPass,o=this.setParametersDeferred,u=t.length,a=e.length;a>1&&n&&(n>0?e.sort(this._drawArraySortPositive):e.sort(this._drawArraySortNegative));var f=this.activeIndexBuffer,l=this.attributeMask,c=null,h=null,p=-1,d=null,v=null,m=0,g=!1,y=null,b=null,w=null,E=null,S=0,x=0,T=0,N=0,C=0;f&&(S=f.format,x=f.stride);for(var k=0;k<a;k+=1){var L=e[k],A=L.technique,O=L.endTechniqueParameters,M=L.endStreams,_=L.endInstances,D=L.indexBuffer,P=L.primitive,H=L.count,B=L.firstIndex;if(h!==A){h=A,b=A.passes,T=b.length,1===T?(this.setTechniqueCaching(A),c=s,N=b[0].semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N)):(this.setTechnique(A),c=o),A.checkProperties&&A.checkProperties(this);for(C=0;C<u;C+=1)c(this,b,t[C])}for(C=48;C<O;C+=1)v=L[C],v&&c(this,b,v);g=p===M;for(m=0;g&&m<M;m+=3)g=d[m]===L[m]&&d[m+1]===L[m+1]&&d[m+2]===L[m+2];if(!g){p=M;for(m=0;m<M;m+=3)y=L[m],y&&this.setStream(y,L[m+1],L[m+2]);l=this.attributeMask,1===T&&(N=b[0].semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N))}d=L;if(D){f!==D&&(f=D,r.bindBuffer(i,D.glBuffer),S=D.format,x=D.stride),B*=x;if(1===T){C=56;if(C<_){do c(this,b,L[C]),r.drawElements(P,H,S,B),C+=1;while(C<_)}else r.drawElements(P,H,S,B)}else{C=56;if(C<_){do{c(this,b,L[C]);for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawElements(P,H,S,B);C+=1}while(C<_)}else for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawElements(P,H,S,B)}}else if(1===T){C=56;if(C<_){do c(this,b,L[C]),r.drawArrays(P,B,H),C+=1;while(C<_)}else r.drawArrays(P,B,H)}else{C=56;if(C<_){do{c(this,b,L[C]);for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawArrays(P,B,H);C+=1}while(C<_)}else for(w=0;w<T;w+=1)E=b[w],N=E.semanticsMask&l,N!==this.clientStateMask&&this.enableClientState(N),this.setPass(E),r.drawArrays(P,B,H)}}this.activeIndexBuffer=f},e.prototype.beginDraw=function(e,t,n,r){this.immediatePrimitive=e;if(t){var i,s=this.immediateSemantics,o=r,u=o.length;s.length=u;for(i=0;i<u;i+=1){var a=o[i];typeof a=="string"&&(a=this["SEMANTIC_"+a]),s[i]=a}var f=this.immediateVertexBuffer,l=f.strideInBytes,c=l*f.numVertices,h=f.setAttributes(n);h!==l&&(f.numVertices=Math.floor(c/h));var p=h*t;return p>c&&f.resize(p),f.map(0,t)}return null},e.prototype.endDraw=function(e){var t=this.immediateVertexBuffer,n=e.getNumWrittenVertices();t.unmap(e);if(n){var r=this.gl,i=t.strideInBytes,s=0,o=t.attributes,u=this.immediateSemantics,a=u.length,f=0;for(var l=0;l<a;l+=1){var c=o[l],h=u[l];f|=1<<h,r.vertexAttribPointer(h,c.numComponents,c.format,c.normalized,i,s),s+=c.stride}this.attributeMask|=f,this.draw(this.immediatePrimitive,n,0)}},e.prototype.setViewport=function(e,t,n,r){var i=this.state.viewportBox;if(i[0]!==e||i[1]!==t||i[2]!==n||i[3]!==r)i[0]=e,i[1]=t,i[2]=n,i[3]=r,this.gl.viewport(e,t,n,r)},e.prototype.setScissor=function(e,t,n,r){var i=this.state.scissorBox;if(i[0]!==e||i[1]!==t||i[2]!==n||i[3]!==r)i[0]=e,i[1]=t,i[2]=n,i[3]=r,this.gl.scissor(e,t,n,r)},e.prototype.clear=function(e,t,n){var r=this.gl,i=this.state,s=0;if(e){s+=r.COLOR_BUFFER_BIT;var o=i.clearColor,u=e[0],a=e[1],f=e[2],l=e[3];if(o[0]!==u||o[1]!==a||o[2]!==f||o[3]!==l)o[0]=u,o[1]=a,o[2]=f,o[3]=l,r.clearColor(u,a,f,l)}typeof t=="number"&&(s+=r.DEPTH_BUFFER_BIT,i.clearDepth!==t&&(i.clearDepth=t,r.clearDepth(t)),typeof n=="number"&&(s+=r.STENCIL_BUFFER_BIT,i.clearStencil!==n&&(i.clearStencil=n,r.clearStencil(n))));if(s){var c=i.colorMask,h=c[0]||c[1]||c[2]||c[3],p=i.depthMask,d=i.program;e&&(h||r.colorMask(!0,!0,!0,!0)),typeof t=="number"&&(p||r.depthMask(!0)),d&&r.useProgram(null),r.clear(s),e&&(h||r.colorMask(!1,!1,!1,!1)),typeof t=="number"&&(p||r.depthMask(!1)),d&&r.useProgram(d)}},e.prototype.beginFrame=function(){var e=this.gl;this.attributeMask=0;var t=this.clientStateMask,n;if(t){for(n=0;n<16;n+=1)t&1<<n&&e.disableVertexAttribArray(n);this.clientStateMask=0}return this.resetStates(),this.setScissor(0,0,this.width,this.height),this.setViewport(0,0,this.width,this.height),!document.hidden&&!document.webkitHidden},e.prototype.beginRenderTarget=function(e){return this.activeRenderTarget=e,e.bind()},e.prototype.endRenderTarget=function(){this.activeRenderTarget.unbind(),this.activeRenderTarget=null},e.prototype.beginOcclusionQuery=function(){return!1},e.prototype.endOcclusionQuery=function(){},e.prototype.endFrame=function(){var e=this.gl;this.activeTechnique&&(this.activeTechnique.deactivate(),this.activeTechnique=null),this.activeIndexBuffer&&this.setIndexBuffer(null);var t=this.state;t.program&&(t.program=null,e.useProgram(null)),this.numFrames+=1;var n=TurbulenzEngine.getTime(),r=n-this.previousFrameTime;r>=1e3&&(this.fps=this.numFrames/(r*.001),this.numFrames=0,this.previousFrameTime=n);var i=e.canvas,s=e.drawingBufferWidth||i.width,o=e.drawingBufferHeight||i.height;if(this.width!==s||this.height!==o)this.width=s,this.height=o,this.setViewport(0,0,s,o),this.setScissor(0,0,s,o);this.checkFullScreen()},e.prototype.createTechniqueParameters=function(e){return S.create(e)},e.prototype.createSemantics=function(e){return g.create(this,e)},e.prototype.createVertexBuffer=function(e){return y.create(this,e)},e.prototype.createIndexBuffer=function(e){return m.create(this,e)},e.prototype.createTexture=function(e){return h.create(this,e)},e.prototype.createVideo=function(e){return p.create(e)},e.prototype.createShader=function(e){return E.create(this,e)},e.prototype.createTechniqueParameterBuffer=function(e){return x(e)},e.prototype.createRenderBuffer=function(e){return d.create(this,e)},e.prototype.createRenderTarget=function(e){return v.create(this,e)},e.prototype.createOcclusionQuery=function(){return null},e.prototype.createDrawParameters=function(){return T.create()},e.prototype.isSupported=function(e){var t=this.gl;if("OCCLUSION_QUERIES"===e)return!1;if("NPOT_MIPMAPPED_TEXTURES"===e)return!1;if("TEXTURE_DXT1"===e||"TEXTURE_DXT3"===e||"TEXTURE_DXT5"===e){var n=this.compressedTexturesExtension;if(n){var r=t.getParameter(t.COMPRESSED_TEXTURE_FORMATS);if(r){var i;"TEXTURE_DXT1"===e?i=n.COMPRESSED_RGBA_S3TC_DXT1_EXT:"TEXTURE_DXT3"===e?i=n.COMPRESSED_RGBA_S3TC_DXT3_EXT:i=n.COMPRESSED_RGBA_S3TC_DXT5_EXT;var s=r.length;for(var o=0;o<s;o+=1)if(r[o]===i)return!0}}return!1}return"TEXTURE_ETC1"===e?!1:"INDEXFORMAT_UINT"===e?t.getExtension("OES_element_index_uint")?!0:!1:"FILEFORMAT_WEBM"===e?"webm"in this.supportedVideoExtensions:"FILEFORMAT_MP4"===e?"mp4"in this.supportedVideoExtensions:"FILEFORMAT_JPG"===e?!0:"FILEFORMAT_PNG"===e?!0:"FILEFORMAT_DDS"===e?typeof c!="undefined":"FILEFORMAT_TGA"===e?typeof vt!="undefined":undefined},e.prototype.maxSupported=function(e){var t=this.gl;if("ANISOTROPY"===e)return this.maxAnisotropy;if("TEXTURE_SIZE"===e)return t.getParameter(t.MAX_TEXTURE_SIZE);if("CUBEMAP_TEXTURE_SIZE"===e)return t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE);if("3D_TEXTURE_SIZE"===e)return 0;if("RENDERTARGET_COLOR_TEXTURES"===e)return this.drawBuffersExtension?this.WEBGL_draw_buffers?t.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_WEBGL):t.getParameter(this.drawBuffersExtension.MAX_COLOR_ATTACHMENTS_EXT):1;if("RENDERBUFFER_SIZE"===e)return t.getParameter(t.MAX_RENDERBUFFER_SIZE);if("TEXTURE_UNITS"===e)return t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);if("VERTEX_TEXTURE_UNITS"===e)return t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);if("VERTEX_SHADER_PRECISION"===e||"FRAGMENT_SHADER_PRECISION"===e){var n;"VERTEX_SHADER_PRECISION"===e?n=t.VERTEX_SHADER:n=t.FRAGMENT_SHADER;if(!t.getShaderPrecisionFormat)return 0;var r=t.getShaderPrecisionFormat(n,t.HIGH_FLOAT);if(!r||!r.precision){r=t.getShaderPrecisionFormat(n,t.MEDIUM_FLOAT);if(!r||!r.precision){r=t.getShaderPrecisionFormat(n,t.LOW_FLOAT);if(!r||!r.precision)return 0}}return r.precision}return 0},e.prototype.loadTexturesArchive=function(e){var t=e.src;return typeof dt!="undefined"?(dt.create({gd:this,src:t,mipmaps:e.mipmaps,ontextureload:function(n){e.ontextureload(n)},onload:function(n,r){e.onload&&e.onload(n,r)},onerror:function(n){e.onload&&e.onload(!1,n)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+t),!1)},e.prototype.getScreenshot=function(e,t,n,r,i){var s=this.gl,o=s.canvas;if(e)return o.toDataURL("image/jpeg");t===undefined&&(t=0),n===undefined&&(n=0);var u=this.activeRenderTarget;u||(u=o),r===undefined&&(r=u.width),i===undefined&&(i=u.height);var a=new Uint8Array(4*r*i);return s.readPixels(t,n,r,i,s.RGBA,s.UNSIGNED_BYTE,a),a},e.prototype.flush=function(){this.gl.flush()},e.prototype.finish=function(){this.gl.finish()},e.prototype._drawArraySortPositive=function(e,t){return t.sortKey-e.sortKey},e.prototype._drawArraySortNegative=function(e,t){return e.sortKey-t.sortKey},e.prototype.checkFullScreen=function(){var e=this.fullscreen;this.oldFullscreen!==e&&(this.oldFullscreen=e,this.requestFullScreen(e))},e.prototype.requestFullScreen=function(e){if(e){var t=this.gl.canvas;t.webkitRequestFullScreenWithKeys?t.webkitRequestFullScreenWithKeys():t.requestFullScreenWithKeys?t.requestFullScreenWithKeys():t.webkitRequestFullScreen?t.webkitRequestFullScreen(t.ALLOW_KEYBOARD_INPUT):t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen?t.msRequestFullscreen():t.requestFullScreen?t.requestFullScreen():t.requestFullscreen&&t.requestFullscreen()}else document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.cancelFullScreen?document.cancelFullScreen():document.exitFullscreen&&document.exitFullscreen();return!0},e.prototype.createSampler=function(e){var t=e.minFilter.toString()+":"+e.magFilter.toString()+":"+e.wrapS.toString()+":"+e.wrapT.toString()+":"+e.wrapR.toString()+":"+e.maxAnisotropy.toString(),n=this.cachedSamplers,r=n[t];return r?r:(n[t]=e,e)},e.prototype.unsetIndexBuffer=function(e){if(this.activeIndexBuffer===e){this.activeIndexBuffer=null;var t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}},e.prototype.bindVertexBuffer=function(e){if(this.bindedVertexBuffer!==e){this.bindedVertexBuffer=e;var t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e)}},e.prototype.unbindVertexBuffer=function(e){if(this.bindedVertexBuffer===e){this.bindedVertexBuffer=null;var t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,null)}},e.prototype.bindTextureUnit=function(e,t,n){var r=this.state,i=this.gl;r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),i.bindTexture(t,n)},e.prototype.bindTexture=function(e,t){var n=this.state,r=this.gl,i=n.maxTextureUnit-1;n.activeTextureUnit!==i&&(n.activeTextureUnit=i,r.activeTexture(r.TEXTURE0+i)),r.bindTexture(e,t)},e.prototype.unbindTexture=function(e){var t=this.state,n=t.lastMaxTextureUnit,r=t.textureUnits;for(var i=0;i<n;i+=1){var s=r[i];s.texture===e&&(s.texture=null,this.bindTextureUnit(i,s.target,null))}},e.prototype.setSampler=function(e,t){if(e){var n=this.gl;n.texParameteri(t,n.TEXTURE_MIN_FILTER,e.minFilter),n.texParameteri(t,n.TEXTURE_MAG_FILTER,e.magFilter),n.texParameteri(t,n.TEXTURE_WRAP_S,e.wrapS),n.texParameteri(t,n.TEXTURE_WRAP_T,e.wrapT),this.TEXTURE_MAX_ANISOTROPY_EXT&&n.texParameteri(t,this.TEXTURE_MAX_ANISOTROPY_EXT,e.maxAnisotropy)}},e.prototype.setPass=function(e){var t=this.gl,n=this.state,r=e.statesSet,i=e.states,s=i.length,o,u;for(o=0;o<s;o+=1)u=i[o],u.set.apply(u,u.values);var a=n.renderStatesToReset,f=a.length;for(o=0;o<f;o+=1)u=a[o],u.name in r||u.reset();n.renderStatesToReset=i;var l=n.lastMaxTextureUnit,c=n.textureUnits,h=e.numTextureUnits;if(h<l){var p=h;do{var d=c[p];d.texture&&(d.texture=null,this.bindTextureUnit(p,d.target,null)),p+=1}while(p<l)}n.lastMaxTextureUnit=h;var v=e.glProgram;n.program!==v&&(n.program=v,t.useProgram(v)),e.dirty&&e.updateParametersData(this)},e.prototype.enableClientState=function(e){var t=this.gl,n=this.clientStateMask;this.clientStateMask=e;var r=n&~e,i=~n&e,s;if(r){(r&255)===0?(r>>=8,s=8):s=0;do 0!==(1&r)&&t.disableVertexAttribArray(s),s+=1,r>>=1;while(r)}if(i){(i&255)===0?(i>>=8,s=8):s=0;do 0!==(1&i)&&t.enableVertexAttribArray(s),s+=1,i>>=1;while(i)}},e.prototype.setTexture=function(e,t,n){var r=this.state,i=this.gl,s=r.textureUnits[e],o=s.target,u=s.texture;if(t){var a=t.target,f=t.glTexture;if(u!==f||o!==a)s.target=a,s.texture=f,r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),o!==a&&u&&i.bindTexture(o,null),i.bindTexture(a,f),t.sampler!==n&&(t.sampler=n,this.setSampler(n,a))}else o&&u&&(s.target=0,s.texture=null,r.activeTextureUnit!==e&&(r.activeTextureUnit=e,i.activeTexture(i.TEXTURE0+e)),i.bindTexture(o,null))},e.prototype.setProgram=function(e){var t=this.state;t.program!==e&&(t.program=e,this.gl.useProgram(e))},e.prototype.syncState=function(){var e=this.state,t=this.gl;e.depthTestEnable?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),t.depthFunc(e.depthFunc),t.depthMask(e.depthMask),e.blendEnable?t.enable(t.BLEND):t.disable(t.BLEND),t.blendFunc(e.blendSrc,e.blendDst),e.cullFaceEnable?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.cullFace(e.cullFace),t.frontFace(e.frontFace);var n=e.colorMask;t.colorMask(n[0],n[1],n[2],n[3]),e.stencilTestEnable?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),t.stencilFunc(e.stencilFunc,e.stencilRef,e.stencilMask),t.stencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass),e.polygonOffsetFillEnable?t.enable(t.POLYGON_OFFSET_FILL):t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(e.polygonOffsetFactor,e.polygonOffsetUnits),t.lineWidth(e.lineWidth),t.activeTexture(t.TEXTURE0+e.activeTextureUnit);var r=this.state.viewportBox;t.viewport(r[0],r[1],r[2],r[3]),r=this.state.scissorBox,t.scissor(r[0],r[1],r[2],r[3]);var i=e.clearColor;t.clearColor(i[0],i[1],i[2],i[3]),t.clearDepth(e.clearDepth),t.clearStencil(e.clearStencil)},e.prototype.resetStates=function(){var e=this.state,t=e.lastMaxTextureUnit,n=e.textureUnits;for(var r=0;r<t;r+=1){var i=n[r];i.texture&&(this.bindTextureUnit(r,i.target,null),i.texture=null,i.target=0)}},e.prototype.destroy=function(){delete this.activeTechnique,delete this.activeIndexBuffer,delete this.bindedVertexBuffer,this.immediateVertexBuffer&&(this.immediateVertexBuffer.destroy(),delete this.immediateVertexBuffer),delete this.gl,typeof c!="undefined"&&c.destroy()},e.create=function(t,n){function A(e){L.depthTestEnable!==e&&(L.depthTestEnable=e,e?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST))}function O(e){L.depthFunc!==e&&(L.depthFunc=e,i.depthFunc(e))}function M(e){L.depthMask!==e&&(L.depthMask=e,i.depthMask(e))}function _(e){L.blendEnable!==e&&(L.blendEnable=e,e?i.enable(i.BLEND):i.disable(i.BLEND))}function D(e,t){if(L.blendSrc!==e||L.blendDst!==t)L.blendSrc=e,L.blendDst=t,i.blendFunc(e,t)}function P(e){L.cullFaceEnable!==e&&(L.cullFaceEnable=e,e?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE))}function H(e){L.cullFace!==e&&(L.cullFace=e,i.cullFace(e))}function B(e){L.frontFace!==e&&(L.frontFace=e,i.frontFace(e))}function j(e,t,n,r){var s=L.colorMask;if(s[0]!==e||s[1]!==t||s[2]!==n||s[3]!==r)s[0]=e,s[1]=t,s[2]=n,s[3]=r,i.colorMask(e,t,n,r)}function F(e){L.stencilTestEnable!==e&&(L.stencilTestEnable=e,e?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST))}function I(e,t,n){if(L.stencilFunc!==e||L.stencilRef!==t||L.stencilMask!==n)L.stencilFunc=e,L.stencilRef=t,L.stencilMask=n,i.stencilFunc(e,t,n)}function q(e,t,n){if(L.stencilFail!==e||L.stencilZFail!==t||L.stencilZPass!==n)L.stencilFail=e,L.stencilZFail=t,L.stencilZPass=n,i.stencilOp(e,t,n)}function R(e){L.polygonOffsetFillEnable!==e&&(L.polygonOffsetFillEnable=e,e?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL))}function U(e,t){if(L.polygonOffsetFactor!==e||L.polygonOffsetUnits!==t)L.polygonOffsetFactor=e,L.polygonOffsetUnits=t,i.polygonOffset(e,t)}function z(e){L.lineWidth!==e&&(L.lineWidth=e,i.lineWidth(e))}function W(){L.depthTestEnable||(L.depthTestEnable=!0,i.enable(i.DEPTH_TEST))}function X(){var e=E;L.depthFunc!==e&&(L.depthFunc=e,i.depthFunc(e))}function V(){L.depthMask||(L.depthMask=!0,i.depthMask(!0))}function $(){L.blendEnable&&(L.blendEnable=!1,i.disable(i.BLEND))}function J(){var e=S,t=x;if(L.blendSrc!==e||L.blendDst!==t)L.blendSrc=e,L.blendDst=t,i.blendFunc(e,t)}function K(){L.cullFaceEnable||(L.cullFaceEnable=!0,i.enable(i.CULL_FACE))}function Q(){var e=T;L.cullFace!==e&&(L.cullFace=e,i.cullFace(e))}function G(){var e=N;L.frontFace!==e&&(L.frontFace=e,i.frontFace(e))}function Y(){var e=L.colorMask;if(e[0]!==!0||e[1]!==!0||e[2]!==!0||e[3]!==!0)e[0]=!0,e[1]=!0,e[2]=!0,e[3]=!0,i.colorMask(!0,!0,!0,!0)}function Z(){L.stencilTestEnable&&(L.stencilTestEnable=!1,i.disable(i.STENCIL_TEST))}function et(){var e=C;if(L.stencilFunc!==e||L.stencilRef!==0||L.stencilMask!==4294967295)L.stencilFunc=e,L.stencilRef=0,L.stencilMask=4294967295,i.stencilFunc(e,0,4294967295)}function tt(){var e=k;if(L.stencilFail!==e||L.stencilZFail!==e||L.stencilZPass!==e)L.stencilFail=e,L.stencilZFail=e,L.stencilZPass=e,i.stencilOp(e,e,e)}function nt(){L.polygonOffsetFillEnable&&(L.polygonOffsetFillEnable=!1,i.disable(i.POLYGON_OFFSET_FILL))}function rt(){if(L.polygonOffsetFactor!==0||L.polygonOffsetUnits!==0)L.polygonOffsetFactor=0,L.polygonOffsetUnits=0,i.polygonOffset(0,0)}function it(){L.lineWidth!==1&&(L.lineWidth=1,i.lineWidth(1))}function st(e){return typeof e!="boolean"?[e?!0:!1]:[e]}function ot(e){return typeof e!="number"?null:[e]}function ut(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function at(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:[t,n,r]}return null}function ft(e){return typeof e!="number"?null:[e]}function lt(e){if(typeof e=="object"){var t=e[0],n=e[1];return typeof t!="number"?null:typeof n!="number"?null:[t,n]}return null}function ct(e){if(typeof e=="object"){var t=e[0],n=e[1],r=e[2],i=e[3];return typeof t!="number"?null:typeof n!="number"?null:typeof r!="number"?null:typeof i!="number"?null:[t,n,r,i]}return null}var r=function(t,n,r){if(t.getContext){var i={alpha:!1,depth:!0,stencil:!0,antialias:!1},s=n.multisample;s!==undefined&&1<s&&(i.antialias=!0);var o=n.alpha;o&&(i.alpha=!0),n.depth===!1&&(i.depth=!1),n.stencil===!1&&(i.stencil=!1);var u=r.length,a;for(a=0;a<u;a+=1)try{var f=t.getContext(r[a],i);if(f)return f}catch(l){}}return null},i=r(t,n,["webgl","experimental-webgl"]);if(!i)return null;var s=i.drawingBufferWidth||t.width,o=i.drawingBufferHeight||t.height;i.enable(i.SCISSOR_TEST),i.depthRange(0,1),i.pixelStorei(i.UNPACK_ALIGNMENT,1);var u=new e;u.gl=i,u.width=s,u.height=o;var a=i.getSupportedExtensions(),f={},l=a.length,c;for(c=0;c<l;c+=1)f[a[c]]=!0;a?a=a.join(" "):a="",u.extensions=a,u.shadingLanguageVersion=i.getParameter(i.SHADING_LANGUAGE_VERSION),u.rendererVersion=i.getParameter(i.VERSION),u.renderer=i.getParameter(i.RENDERER),u.vendor=i.getParameter(i.VENDOR),f.WEBGL_compressed_texture_s3tc?(u.WEBGL_compressed_texture_s3tc=!0,u.compressedTexturesExtension=i.getExtension("WEBGL_compressed_texture_s3tc")):f.WEBKIT_WEBGL_compressed_texture_s3tc?(u.WEBGL_compressed_texture_s3tc=!0,u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")):f.MOZ_WEBGL_compressed_texture_s3tc?(u.WEBGL_compressed_texture_s3tc=!0,u.compressedTexturesExtension=i.getExtension("MOZ_WEBGL_compressed_texture_s3tc")):f.WEBKIT_WEBGL_compressed_textures&&(u.compressedTexturesExtension=i.getExtension("WEBKIT_WEBGL_compressed_textures"));var h;f.EXT_texture_filter_anisotropic?h=i.getExtension("EXT_texture_filter_anisotropic"):f.MOZ_EXT_texture_filter_anisotropic?h=i.getExtension("MOZ_EXT_texture_filter_anisotropic"):f.WEBKIT_EXT_texture_filter_anisotropic&&(h=i.getExtension("WEBKIT_EXT_texture_filter_anisotropic")),h?(u.TEXTURE_MAX_ANISOTROPY_EXT=h.TEXTURE_MAX_ANISOTROPY_EXT,u.maxAnisotropy=i.getParameter(h.MAX_TEXTURE_MAX_ANISOTROPY_EXT)):u.maxAnisotropy=1,i.getExtension("OES_element_index_uint"),f.WEBGL_draw_buffers?(u.WEBGL_draw_buffers=!0,u.drawBuffersExtension=i.getExtension("WEBGL_draw_buffers")):f.EXT_draw_buffers&&(u.drawBuffersExtension=i.getExtension("EXT_draw_buffers")),u.PRIMITIVE_POINTS=i.POINTS,u.PRIMITIVE_LINES=i.LINES,u.PRIMITIVE_LINE_LOOP=i.LINE_LOOP,u.PRIMITIVE_LINE_STRIP=i.LINE_STRIP,u.PRIMITIVE_TRIANGLES=i.TRIANGLES,u.PRIMITIVE_TRIANGLE_STRIP=i.TRIANGLE_STRIP,u.PRIMITIVE_TRIANGLE_FAN=i.TRIANGLE_FAN,u.INDEXFORMAT_UBYTE=i.UNSIGNED_BYTE,u.INDEXFORMAT_USHORT=i.UNSIGNED_SHORT,u.INDEXFORMAT_UINT=i.UNSIGNED_INT,u.fixIE=u.vendor==="Microsoft"&&-1!==u.rendererVersion.indexOf("0.9");var p=function(t){return t===i.BYTE?127:t===i.UNSIGNED_BYTE?255:t===i.SHORT?32767:t===i.UNSIGNED_SHORT?65535:t===i.INT?2147483647:t===i.UNSIGNED_INT?4294967295:1},d=function(t,n,r,s,o){var u={numComponents:n,stride:r,componentStride:r/n,format:s,name:o,normalized:undefined,normalizationScale:undefined,typedSetter:undefined,typedArray:undefined};return t?(u.normalized=!0,u.normalizationScale=p(s)):(u.normalized=!1,u.normalizationScale=1),typeof DataView!="undefined"&&"setFloat32"in DataView.prototype?s===i.BYTE?u.typedSetter=DataView.prototype.setInt8:s===i.UNSIGNED_BYTE?u.typedSetter=DataView.prototype.setUint8:s===i.SHORT?u.typedSetter=DataView.prototype.setInt16:s===i.UNSIGNED_SHORT?u.typedSetter=DataView.prototype.setUint16:s===i.INT?u.typedSetter=DataView.prototype.setInt32:s===i.UNSIGNED_INT?u.typedSetter=DataView.prototype.setUint32:u.typedSetter=DataView.prototype.setFloat32:s===i.BYTE?u.typedArray=Int8Array:s===i.UNSIGNED_BYTE?u.typedArray=Uint8Array:s===i.SHORT?u.typedArray=Int16Array:s===i.UNSIGNED_SHORT?u.typedArray=Uint16Array:s===i.INT?u.typedArray=Int32Array:s===i.UNSIGNED_INT?u.typedArray=Uint32Array:u.typedArray=Float32Array,u};u.fixIE?(u.VERTEXFORMAT_BYTE4=d(0,4,16,i.FLOAT,"BYTE4"),u.VERTEXFORMAT_BYTE4N=d(0,4,16,i.FLOAT,"BYTE4N"),u.VERTEXFORMAT_UBYTE4=d(0,4,16,i.FLOAT,"UBYTE4"),u.VERTEXFORMAT_UBYTE4N=d(0,4,16,i.FLOAT,"UBYTE4N"),u.VERTEXFORMAT_SHORT2=d(0,2,8,i.FLOAT,"SHORT2"),u.VERTEXFORMAT_SHORT2N=d(0,2,8,i.FLOAT,"SHORT2N"),u.VERTEXFORMAT_SHORT4=d(0,4,16,i.FLOAT,"SHORT4"),u.VERTEXFORMAT_SHORT4N=d(0,4,16,i.FLOAT,"SHORT4N"),u.VERTEXFORMAT_USHORT2=d(0,2,8,i.FLOAT,"USHORT2"),u.VERTEXFORMAT_USHORT2N=d(0,2,8,i.FLOAT,"USHORT2N"),u.VERTEXFORMAT_USHORT4=d(0,4,16,i.FLOAT,"USHORT4"),u.VERTEXFORMAT_USHORT4N=d(0,4,16,i.FLOAT,"USHORT4N"),u.VERTEXFORMAT_FLOAT1=d(0,1,4,i.FLOAT,"FLOAT1"),u.VERTEXFORMAT_FLOAT2=d(0,2,8,i.FLOAT,"FLOAT2"),u.VERTEXFORMAT_FLOAT3=d(0,3,12,i.FLOAT,"FLOAT3"),u.VERTEXFORMAT_FLOAT4=d(0,4,16,i.FLOAT,"FLOAT4")):(u.VERTEXFORMAT_BYTE4=d(0,4,4,i.BYTE,"BYTE4"),u.VERTEXFORMAT_BYTE4N=d(1,4,4,i.BYTE,"BYTE4N"),u.VERTEXFORMAT_UBYTE4=d(0,4,4,i.UNSIGNED_BYTE,"UBYTE4"),u.VERTEXFORMAT_UBYTE4N=d(1,4,4,i.UNSIGNED_BYTE,"UBYTE4N"),u.VERTEXFORMAT_SHORT2=d(0,2,4,i.SHORT,"SHORT2"),u.VERTEXFORMAT_SHORT2N=d(1,2,4,i.SHORT,"SHORT2N"),u.VERTEXFORMAT_SHORT4=d(0,4,8,i.SHORT,"SHORT4"),u.VERTEXFORMAT_SHORT4N=d(1,4,8,i.SHORT,"SHORT4N"),u.VERTEXFORMAT_USHORT2=d(0,2,4,i.UNSIGNED_SHORT,"USHORT2"),u.VERTEXFORMAT_USHORT2N=d(1,2,4,i.UNSIGNED_SHORT,"USHORT2N"),u.VERTEXFORMAT_USHORT4=d(0,4,8,i.UNSIGNED_SHORT,"USHORT4"),u.VERTEXFORMAT_USHORT4N=d(1,4,8,i.UNSIGNED_SHORT,"USHORT4N"),u.VERTEXFORMAT_FLOAT1=d(0,1,4,i.FLOAT,"FLOAT1"),u.VERTEXFORMAT_FLOAT2=d(0,2,8,i.FLOAT,"FLOAT2"),u.VERTEXFORMAT_FLOAT3=d(0,3,12,i.FLOAT,"FLOAT3"),u.VERTEXFORMAT_FLOAT4=d(0,4,16,i.FLOAT,"FLOAT4"));var v=i.getParameter(i.MAX_VERTEX_ATTRIBS);v<16&&(e.prototype.SEMANTIC_ATTR0=e.prototype.SEMANTIC_POSITION=e.prototype.SEMANTIC_POSITION0=0,e.prototype.SEMANTIC_ATTR1=e.prototype.SEMANTIC_BLENDWEIGHT=e.prototype.SEMANTIC_BLENDWEIGHT0=1,e.prototype.SEMANTIC_ATTR2=e.prototype.SEMANTIC_NORMAL=e.prototype.SEMANTIC_NORMAL0=2,e.prototype.SEMANTIC_ATTR3=e.prototype.SEMANTIC_COLOR=e.prototype.SEMANTIC_COLOR0=3,e.prototype.SEMANTIC_ATTR7=e.prototype.SEMANTIC_BLENDINDICES=e.prototype.SEMANTIC_BLENDINDICES0=4,e.prototype.SEMANTIC_ATTR8=e.prototype.SEMANTIC_TEXCOORD=e.prototype.SEMANTIC_TEXCOORD0=5,e.prototype.SEMANTIC_ATTR9=e.prototype.SEMANTIC_TEXCOORD1=6,e.prototype.SEMANTIC_ATTR14=e.prototype.SEMANTIC_TEXCOORD6=e.prototype.SEMANTIC_TANGENT=e.prototype.SEMANTIC_TANGENT0=7,e.prototype.SEMANTIC_ATTR15=e.prototype.SEMANTIC_TEXCOORD7=e.prototype.SEMANTIC_BINORMAL0=e.prototype.SEMANTIC_BINORMAL=8,e.prototype.SEMANTIC_ATTR10=e.prototype.SEMANTIC_TEXCOORD2=9,e.prototype.SEMANTIC_ATTR11=e.prototype.SEMANTIC_TEXCOORD3=10,e.prototype.SEMANTIC_ATTR12=e.prototype.SEMANTIC_TEXCOORD4=11,e.prototype.SEMANTIC_ATTR13=e.prototype.SEMANTIC_TEXCOORD5=12,e.prototype.SEMANTIC_ATTR4=e.prototype.SEMANTIC_COLOR1=e.prototype.SEMANTIC_SPECULAR=13,e.prototype.SEMANTIC_ATTR5=e.prototype.SEMANTIC_FOGCOORD=e.prototype.SEMANTIC_TESSFACTOR=14,e.prototype.SEMANTIC_ATTR6=e.prototype.SEMANTIC_PSIZE=e.prototype.SEMANTIC_PSIZE0=15),u.DEFAULT_SAMPLER={minFilter:i.LINEAR_MIPMAP_LINEAR,magFilter:i.LINEAR,wrapS:i.REPEAT,wrapT:i.REPEAT,wrapR:i.REPEAT,maxAnisotropy:1},u.cachedSamplers={};var m=1,y=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);m<y&&(m=y),y=i.getParameter(i.MAX_COMBINED_TEXTURE_IMAGE_UNITS),m<y&&(m=y);var b=[];b.length=m;for(var w=0;w<m;w+=1)b[w]={texture:null,target:0};var E=i.LEQUAL,S=i.SRC_ALPHA,x=i.ONE_MINUS_SRC_ALPHA,T=i.BACK,N=i.CCW,C=i.ALWAYS,k=i.KEEP,L={depthTestEnable:!0,blendEnable:!1,cullFaceEnable:!0,stencilTestEnable:!1,polygonOffsetFillEnable:!1,depthMask:!0,depthFunc:E,blendSrc:S,blendDst:x,cullFace:T,frontFace:N,colorMask:[!0,!0,!0,!0],stencilFunc:C,stencilRef:0,stencilMask:4294967295,stencilFail:k,stencilZFail:k,stencilZPass:k,polygonOffsetFactor:0,polygonOffsetUnits:0,lineWidth:1,renderStatesToReset:[],viewportBox:[0,0,s,o],scissorBox:[0,0,s,o],clearColor:[0,0,0,1],clearDepth:1,clearStencil:0,activeTextureUnit:0,maxTextureUnit:m,lastMaxTextureUnit:0,textureUnits:b,program:null};u.state=L,u.counters={textures:0,vertexBuffers:0,indexBuffers:0,renderTargets:0,renderBuffers:0,shaders:0,techniques:0};var ht={},pt=function(t,n,r,i,s){ht[t]={set:n,reset:r,parse:i,defaultValues:s}};pt("DepthTestEnable",A,W,st,[!0]),pt("DepthFunc",O,X,ot,[E]),pt("DepthMask",M,V,st,[!0]),pt("BlendEnable",_,$,st,[!1]),pt("BlendFunc",D,J,ut,[S,x]),pt("CullFaceEnable",P,K,st,[!0]),pt("CullFace",H,Q,ot,[T]),pt("FrontFace",B,G,ot,[N]),pt("ColorMask",j,Y,ct,[!0,!0,!0,!0]),pt("StencilTestEnable",F,Z,st,[!1]),pt("StencilFunc",I,et,at,[C,0,4294967295]),pt("StencilOp",q,tt,at,[k,k,k]),pt("PolygonOffsetFillEnable",R,nt,st,[!1]),pt("PolygonOffset",U,rt,lt,[0,0]),u.fixIE||pt("LineWidth",z,it,ft,[1]),u.stateHandlers=ht,u.syncState(),u.videoRam=0,u.desktopWidth=window.screen.width,u.desktopHeight=window.screen.height,Object.defineProperty?(Object.defineProperty(u,"fullscreen",{get:function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?!0:!1},set:function(t){u.requestFullScreen(t)},enumerable:!0,configurable:!1}),u.checkFullScreen=function(){}):(u.fullscreen=!1,u.oldFullscreen=!1),u.clientStateMask=0,u.attributeMask=0,u.activeTechnique=null,u.activeIndexBuffer=null,u.bindedVertexBuffer=null,u.activeRenderTarget=null,u.immediateVertexBuffer=u.createVertexBuffer({numVertices:16384,attributes:["FLOAT4"],dynamic:!0,"transient":!0}),u.immediatePrimitive=-1,u.immediateSemantics=g.create(u,[]),u.fps=0,u.numFrames=0,u.previousFrameTime=TurbulenzEngine.getTime();var dt=document.createElement("video"),vt={};return dt&&(dt.canPlayType("video/webm")&&(vt.webm=!0),dt.canPlayType("video/mp4")&&(vt.mp4=!0)),u.supportedVideoExtensions=vt,dt=null,u},e.version=1,e}();N.prototype.SEMANTIC_POSITION=0,N.prototype.SEMANTIC_POSITION0=0,N.prototype.SEMANTIC_BLENDWEIGHT=1,N.prototype.SEMANTIC_BLENDWEIGHT0=1,N.prototype.SEMANTIC_NORMAL=2,N.prototype.SEMANTIC_NORMAL0=2,N.prototype.SEMANTIC_COLOR=3,N.prototype.SEMANTIC_COLOR0=3,N.prototype.SEMANTIC_COLOR1=4,N.prototype.SEMANTIC_SPECULAR=4,N.prototype.SEMANTIC_FOGCOORD=5,N.prototype.SEMANTIC_TESSFACTOR=5,N.prototype.SEMANTIC_PSIZE0=6,N.prototype.SEMANTIC_BLENDINDICES=7,N.prototype.SEMANTIC_BLENDINDICES0=7,N.prototype.SEMANTIC_TEXCOORD=8,N.prototype.SEMANTIC_TEXCOORD0=8,N.prototype.SEMANTIC_TEXCOORD1=9,N.prototype.SEMANTIC_TEXCOORD2=10,N.prototype.SEMANTIC_TEXCOORD3=11,N.prototype.SEMANTIC_TEXCOORD4=12,N.prototype.SEMANTIC_TEXCOORD5=13,N.prototype.SEMANTIC_TEXCOORD6=14,N.prototype.SEMANTIC_TEXCOORD7=15,N.prototype.SEMANTIC_TANGENT=14,N.prototype.SEMANTIC_TANGENT0=14,N.prototype.SEMANTIC_BINORMAL0=15,N.prototype.SEMANTIC_BINORMAL=15,N.prototype.SEMANTIC_PSIZE=6,N.prototype.SEMANTIC_ATTR0=0,N.prototype.SEMANTIC_ATTR1=1,N.prototype.SEMANTIC_ATTR2=2,N.prototype.SEMANTIC_ATTR3=3,N.prototype.SEMANTIC_ATTR4=4,N.prototype.SEMANTIC_ATTR5=5,N.prototype.SEMANTIC_ATTR6=6,N.prototype.SEMANTIC_ATTR7=7,N.prototype.SEMANTIC_ATTR8=8,N.prototype.SEMANTIC_ATTR9=9,N.prototype.SEMANTIC_ATTR10=10,N.prototype.SEMANTIC_ATTR11=11,N.prototype.SEMANTIC_ATTR12=12,N.prototype.SEMANTIC_ATTR13=13,N.prototype.SEMANTIC_ATTR14=14,N.prototype.SEMANTIC_ATTR15=15,N.prototype.PIXELFORMAT_A8=0,N.prototype.PIXELFORMAT_L8=1,N.prototype.PIXELFORMAT_L8A8=2,N.prototype.PIXELFORMAT_R5G5B5A1=3,N.prototype.PIXELFORMAT_R5G6B5=4,N.prototype.PIXELFORMAT_R4G4B4A4=5,N.prototype.PIXELFORMAT_R8G8B8A8=6,N.prototype.PIXELFORMAT_R8G8B8=7,N.prototype.PIXELFORMAT_D24S8=8,N.prototype.PIXELFORMAT_D16=9,N.prototype.PIXELFORMAT_DXT1=10,N.prototype.PIXELFORMAT_DXT3=11,N.prototype.PIXELFORMAT_DXT5=12,N.prototype.PIXELFORMAT_S8=13;var C=function(){function e(){}return e.prototype.update=function(){if(!this.isWindowFocused)return;this.updateGamePad()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty
(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.lockMouse=function(){return this.isHovering&&this.isWindowFocused?(this.isMouseLocked=!0,this.hideMouse(),this.requestBrowserLock(),this.setEventHandlersLock(),!0):!1},e.prototype.unlockMouse=function(){return this.isMouseLocked?(this.isMouseLocked=!1,this.showMouse(),this.requestBrowserUnlock(),this.setEventHandlersUnlock(),this.isOutsideEngine&&(this.isOutsideEngine=!1,this.isHovering=!1,this.setEventHandlersMouseLeave(),this.sendEventToHandlers(this.handlers.mouseleave)),this.sendEventToHandlers(this.handlers.mouselocklost),!0):!1},e.prototype.isLocked=function(){return this.isMouseLocked},e.prototype.hideMouse=function(){return this.isHovering?(this.isCursorHidden||(this.isCursorHidden=!0,this.previousCursor=document.body.style.cursor,document.body.style.cursor="none",this.webkit&&(this.ignoreNextMouseMoves=2)),!0):!1},e.prototype.showMouse=function(){return this.isCursorHidden&&!this.isMouseLocked?(this.isCursorHidden=!1,document.body.style.cursor=this.previousCursor,!0):!1},e.prototype.isHidden=function(){return this.isCursorHidden},e.prototype.isFocused=function(){return this.isWindowFocused},e.prototype.convertToUnicode=function(e){var t=this.keyCodeToUnicode,n={},r=e.length,i,s;for(i=0;i<r;i+=1)s=e[i],n[s]=t[s]||"";return n},e.prototype.sendEventToHandlers=function(e,t,n,r,i,s,o){var u,a=e.length;if(a)for(u=0;u<a;u+=1)e[u](t,n,r,i,s,o)},e.prototype.sendEventToHandlersASync=function(t,n,r,i,s,o,u){var a=e.prototype.sendEventToHandlers;TurbulenzEngine.setTimeout(function(){a(t,n,r,i,s,o,u)},0)},e.prototype.updateGamePad=function(){var e,t,n=navigator.gamepads||navigator.webkitGamepads||navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads();if(n){var r=this.padAxisDeadZone,i=this.maxAxisRange,s=this.sendEventToHandlersASync,o=this.handlers,u=this.padButtons,a=this.padMap,f=0,l=0,c=0,h=0,p=n.length;for(var d=0;d<p;d+=1){var v=n[d];if(v){var m=v.buttons;if(this.padTimestampUpdate<v.timestamp){this.padTimestampUpdate=v.timestamp;var g=m.length;for(var y=0;y<g;y+=1){var b=m[y];typeof b=="object"&&(b=b.value);if(u[y]!==b){u[y]=b;var w=a[y];w!==undefined&&(b?s(o.paddown,w):s(o.padup,w))}}}var E=v.axes;if(E.length<=4){var S=E[0],x=-E[1];e=S*S+x*x,e>r*r&&(e=Math.sqrt(e),S/=e,x/=e,e>i&&(e=i),e-=r,t=e/(i-r),f=S*t,l=x*t);var T=E[2],N=-E[3];e=T*T+N*N,e>r*r&&(e=Math.sqrt(e),T/=e,N/=e,e>i&&(e=i),e-=r,t=e/(i-r),c=T*t,h=N*t),s(o.padmove,f,l,m[6],c,h,m[7])}break}}}},e.prototype.getLocale=function(){return""},e.prototype.getCanvasPosition=function(e,t){e.offsetX!==undefined?(t.x=e.offsetX,t.y=e.offsetY):e.layerX!==undefined&&(t.x=e.layerX,t.y=e.layerY)},e.prototype.resetKeyStates=function(){var e,t=this.pressedKeys,n=this.handlers.keyup;for(e in t)t.hasOwnProperty(e)&&t[e]&&(e=parseInt(e,10),t[e]=!1,this.sendEventToHandlers(n,e))},e.prototype.onMouseOver=function(e){var t={},n=this.handlers.mouseover;e.stopPropagation(),e.preventDefault(),this.getCanvasPosition(e,t),this.lastX=e.screenX,this.lastY=e.screenY,this.sendEventToHandlers(n,t.x,t.y)},e.prototype.onMouseMove=function(e){var t=this.handlers.mousemove,n,r;e.stopPropagation(),e.preventDefault();if(this.ignoreNextMouseMoves){this.ignoreNextMouseMoves-=1;return}if(e.movementX!==undefined)n=e.movementX,r=e.movementY;else if(e.mozMovementX!==undefined)n=e.mozMovementX,r=e.mozMovementY;else if(e.webkitMovementX!==undefined)n=e.webkitMovementX,r=e.webkitMovementY;else{n=e.screenX-this.lastX,r=e.screenY-this.lastY;if(0===n&&0===r)return}this.lastX=e.screenX,this.lastY=e.screenY,this.sendEventToHandlers(t,n,r)},e.prototype.onWheel=function(e){var t=this.handlers.mousewheel,n;e.stopPropagation(),e.preventDefault(),e.wheelDelta?window.opera?n=e.wheelDelta<0?1:-1:n=e.wheelDelta>0?1:-1:n=e.detail<0?1:-1,this.sendEventToHandlers(t,n)},e.prototype.emptyEvent=function(e){e.stopPropagation(),e.preventDefault()},e.prototype.onWindowFocus=function(){this.isHovering&&window.document.activeElement===this.canvas&&this.addInternalEventListener(window,"mousedown",this.onMouseDown)},e.prototype.onFocus=function(){var e=this.canvas,t=this.handlers,n=t.focus;this.isWindowFocused||(this.isWindowFocused=!0,window.focus(),e.focus(),this.setEventHandlersFocus(),e.oncontextmenu=function(){return!1},this.sendEventToHandlers(n))},e.prototype.onBlur=function(){if(this.ignoreNextBlur){this.ignoreNextBlur=!1;return}var e=this.canvas,t=this.handlers,n=t.blur;this.isMouseLocked&&this.unlockMouse(),this.isWindowFocused&&(this.isWindowFocused=!1,this.resetKeyStates(),this.setEventHandlersBlur(),e.oncontextmenu=null,this.sendEventToHandlers(n))},e.prototype.onMouseDown=function(e){var t=this.handlers;if(this.isHovering){var n=t.mousedown,r=e.button,i={};this.onFocus(),e.stopPropagation(),e.preventDefault(),r<3&&(r=this.mouseMap[r]),this.getCanvasPosition(e,i),this.sendEventToHandlers(n,r,i.x,i.y)}else this.onBlur()},e.prototype.onMouseUp=function(e){var t=this.handlers.mouseup;if(this.isHovering){var n=e.button,r={};e.stopPropagation(),e.preventDefault(),n<3&&(n=this.mouseMap[n]),this.getCanvasPosition(e,r),this.sendEventToHandlers(t,n,r.x,r.y)}},e.prototype.onKeyDown=function(e){var t=this.handlers.keydown,n=this.pressedKeys,r=this.keyCodes;e.stopPropagation(),e.preventDefault();var i=e.keyCode;i=this.keyMap[i];if(undefined!==i&&r.ESCAPE!==i){var s=typeof e.location=="number"?e.location:e.keyLocation;2===s&&(i+=1),n[i]||(n[i]=!0,this.sendEventToHandlers(t,i))}},e.prototype.onKeyUp=function(e){var t=this.handlers.keyup,n=this.pressedKeys,r=this.keyCodes;e.stopPropagation(),e.preventDefault();var i=e.keyCode;i=this.keyMap[i];if(i===r.ESCAPE){this.unlockMouse();if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():document.exitFullscreen&&document.exitFullscreen()}else if(undefined!==i){var s=typeof e.location=="number"?e.location:e.keyLocation;2===s&&(i+=1),n[i]&&(n[i]=!1,this.sendEventToHandlers(t,i),(627===i||628===i)&&this.macosx&&this.resetKeyStates())}},e.prototype.onTouchStart=function(e){var t=this.handlers.touchstart;e.preventDefault(),this.addTouches(e.changedTouches),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchEnd=function(e){var t=this.handlers.touchend;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.removeTouches(e.changedTouches),this.sendEventToHandlers(t,e)},e.prototype.onTouchMove=function(e){var t=this.handlers.touchmove;e.preventDefault(),this.addTouches(e.changedTouches),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchEnter=function(e){var t=this.handlers.touchenter;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchLeave=function(e){var t=this.handlers.touchleave;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.sendEventToHandlers(t,e)},e.prototype.onTouchCancel=function(e){var t=this.handlers.touchcancel;e.preventDefault(),e=this.convertW3TouchEventToTurbulenzTouchEvent(e),this.removeTouches(e.changedTouches),this.sendEventToHandlers(t,e)},e.prototype.convertW3TouchEventToTurbulenzTouchEvent=function(e){var t=this.convertW3TouchListToTurbulenzTouchList(e.changedTouches),n=this.convertW3TouchListToTurbulenzTouchList(e.targetTouches),r=this.convertW3TouchListToTurbulenzTouchList(e.touches),i={changedTouches:t,gameTouches:n,touches:r};return gt.create(i)},e.prototype.convertW3TouchListToTurbulenzTouchList=function(e){var t=e.length,n=[],r,i;n.length=t;for(i=0;i<t;i+=1)r=this.getTouchById(e[i].identifier),n[i]=r;return n},e.prototype.convertW3TouchToTurbulenzTouch=function(e){var t=this.canvas,n=t.getBoundingClientRect(),r={force:e.force||e.webkitForce||0,identifier:e.identifier,isGameTouch:e.target===t,positionX:e.pageX-n.left,positionY:e.pageY-n.top,radiusX:e.radiusX||e.webkitRadiusX||1,radiusY:e.radiusY||e.webkitRadiusY||1,rotationAngle:e.rotationAngle||e.webkitRotationAngle||0};return mt.create(r)},e.prototype.addTouches=function(e){var t=e.length,n,r;for(n=0;n<t;n+=1)r=this.convertW3TouchToTurbulenzTouch(e[n]),this.addTouch(r)},e.prototype.removeTouches=function(e){var t=e.length,n,r;for(n=0;n<t;n+=1)r=e[n].identifier,this.removeTouchById(r)},e.prototype.addTouch=function(e){this.touches[e.identifier]=e},e.prototype.getTouchById=function(e){return this.touches[e]},e.prototype.removeTouchById=function(e){delete this.touches[e]},e.prototype.canvasOnMouseOver=function(e){var t=this.handlers.mouseenter;this.isMouseLocked?this.isOutsideEngine=!1:(this.isHovering=!0,this.lastX=e.screenX,this.lastY=e.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(t))},e.prototype.canvasOnMouseOut=function(){var e=this.handlers.mouseleave;this.isMouseLocked?this.isOutsideEngine=!0:(this.isHovering=!1,this.isCursorHidden&&this.showMouse(),this.setEventHandlersMouseLeave(),this.sendEventToHandlers(e))},e.prototype.canvasOnMouseDown=function(e){var t=this.handlers.mouseenter;return this.canvas.onmousedown=null,this.isHovering||(this.isHovering=!0,this.lastX=e.screenX,this.lastY=e.screenY,this.setEventHandlersMouseEnter(),this.sendEventToHandlers(t),this.onMouseDown(e)),!1},e.prototype.onFullscreenChanged=function(){this.isMouseLocked&&(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement?(this.ignoreNextMouseMoves=2,this.requestBrowserLock()):this.unlockMouse())},e.prototype.setEventHandlersMouseEnter=function(){this.isFocused()||this.addInternalEventListener(window,"mousedown",this.onMouseDown),this.addInternalEventListener(window,"mouseup",this.onMouseUp),this.addInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.addInternalEventListener(window,"mousewheel",this.onWheel),this.addInternalEventListener(window,"click",this.emptyEvent)},e.prototype.setEventHandlersMouseLeave=function(){this.isFocused()||this.removeInternalEventListener(window,"mousedown",this.onMouseDown),this.removeInternalEventListener(window,"mouseup",this.onMouseUp),this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.removeInternalEventListener(window,"DOMMouseScroll",this.onWheel),this.removeInternalEventListener(window,"mousewheel",this.onWheel),this.removeInternalEventListener(window,"click",this.emptyEvent)},e.prototype.setEventHandlersFocus=function(){this.addInternalEventListener(window,"keydown",this.onKeyDown),this.addInternalEventListener(window,"keyup",this.onKeyUp)},e.prototype.setEventHandlersBlur=function(){this.removeInternalEventListener(window,"keydown",this.onKeyDown),this.removeInternalEventListener(window,"keyup",this.onKeyUp),this.removeInternalEventListener(window,"mousedown",this.onMouseDown)},e.prototype.setEventHandlersLock=function(){this.removeInternalEventListener(window,"mousemove",this.onMouseOver),this.addInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(document,"fullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged),this.addInternalEventListener(document,"MSFullscreenChange",this.onFullscreenChanged)},e.prototype.setEventHandlersUnlock=function(){this.removeInternalEventListener(document,"webkitfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"mozfullscreenchange",this.onFullscreenChanged),this.removeInternalEventListener(document,"MSFullscreenChange",this.onFullscreenChanged),this.removeInternalEventListener(window,"mousemove",this.onMouseMove),this.addInternalEventListener(window,"mousemove",this.onMouseOver)},e.prototype.setEventHandlersCanvas=function(){var e=this.canvas;this.addInternalEventListener(e,"mouseover",this.canvasOnMouseOver),this.addInternalEventListener(e,"mouseout",this.canvasOnMouseOut),this.addInternalEventListener(e,"mousedown",this.canvasOnMouseDown)},e.prototype.setEventHandlersWindow=function(){this.addInternalEventListener(window,"blur",this.onBlur),this.addInternalEventListener(window,"focus",this.onWindowFocus)},e.prototype.removeEventHandlersWindow=function(){this.removeInternalEventListener(window,"blur",this.onBlur),this.removeInternalEventListener(window,"focus",this.onWindowFocus)},e.prototype.setEventHandlersTouch=function(){var e=this.canvas;this.addInternalEventListener(e,"touchstart",this.onTouchStart),this.addInternalEventListener(e,"touchend",this.onTouchEnd),this.addInternalEventListener(e,"touchenter",this.onTouchEnter),this.addInternalEventListener(e,"touchleave",this.onTouchLeave),this.addInternalEventListener(e,"touchmove",this.onTouchMove),this.addInternalEventListener(e,"touchcancel",this.onTouchCancel)},e.prototype.addInternalEventListener=function(e,t,n){var r=this.elementEventFlags[e];r||(this.elementEventFlags[e]=r={});if(!r[t]){r[t]=!0;var i=this.boundFunctions[n];i||(this.boundFunctions[n]=i=n.bind(this)),e.addEventListener(t,i,!1)}},e.prototype.removeInternalEventListener=function(e,t,n){var r=this.elementEventFlags[e];if(r&&r[t]){r[t]=!1;var i=this.boundFunctions[n];e.removeEventListener(t,i,!1)}},e.prototype.destroy=function(){this.isLocked()&&this.setEventHandlersUnlock(),this.isHovering&&this.setEventHandlersMouseLeave(),this.isWindowFocused&&this.setEventHandlersBlur(),this.removeEventHandlersWindow();var e=this.canvas;e.onmouseover=null,e.onmouseout=null,e.onmousedown=null},e.prototype.isSupported=function(e){var t=this.canvas;if(t&&e==="POINTER_LOCK"){var n="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,r=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;if(n&&r)return!0}return!1},e.create=function(t){var n=new e;n.lastX=0,n.lastY=0,n.touches={},n.boundFunctions={},n.elementEventFlags={},n.canvas=t,n.isMouseLocked=!1,n.isHovering=!1,n.isWindowFocused=!1,n.isCursorHidden=!1,n.isOutsideEngine=!1,n.previousCursor="",n.ignoreNextMouseMoves=0,n.ignoreNextBlur=!1,n.pressedKeys={},n.handlers={keydown:[],keyup:[],mousedown:[],mouseup:[],mousewheel:[],mouseover:[],mousemove:[],paddown:[],padup:[],padmove:[],mouseenter:[],mouseleave:[],focus:[],blur:[],mouselocklost:[],touchstart:[],touchend:[],touchenter:[],touchleave:[],touchmove:[],touchcancel:[]};var r={},i=n.keyCodes;for(var s in i)if(i.hasOwnProperty(s)){var o=i[s];r[o]=s}r[i.SPACE]=" ",r[i.NUMBER_0]="0",r[i.NUMBER_1]="1",r[i.NUMBER_2]="2",r[i.NUMBER_3]="3",r[i.NUMBER_4]="4",r[i.NUMBER_5]="5",r[i.NUMBER_6]="6",r[i.NUMBER_7]="7",r[i.NUMBER_8]="8",r[i.NUMBER_9]="9",r[i.GRAVE]="`",r[i.MINUS]="-",r[i.EQUALS]="=",r[i.LEFT_BRACKET]="[",r[i.RIGHT_BRACKET]="]",r[i.SEMI_COLON]=";",r[i.APOSTROPHE]="'",r[i.COMMA]=",",r[i.PERIOD]=".",r[i.SLASH]="/",r[i.BACKSLASH]="\\";var u={};u[65]=0,u[66]=1,u[67]=2,u[68]=3,u[69]=4,u[70]=5,u[71]=6,u[72]=7,u[73]=8,u[74]=9,u[75]=10,u[76]=11,u[77]=12,u[78]=13,u[79]=14,u[80]=15,u[81]=16,u[82]=17,u[83]=18,u[84]=19,u[85]=20,u[86]=21,u[87]=22,u[88]=23,u[89]=24,u[90]=25,u[48]=100,u[49]=101,u[50]=102,u[51]=103,u[52]=104,u[53]=105,u[54]=106,u[55]=107,u[56]=108,u[57]=109,u[37]=200,u[39]=201,u[38]=202,u[40]=203,u[16]=300,u[17]=302,u[18]=304,u[0]=305,u[27]=400,u[9]=401,u[32]=402,u[8]=403,u[13]=404,u[223]=500,u[173]=501,u[189]=501,u[61]=502,u[187]=502,u[219]=503,u[221]=504,u[59]=505,u[186]=505,u[192]=500,u[188]=507,u[190]=508,u[222]=506,navigator.appVersion.indexOf("Mac")!==-1&&(u[0]=500),u[112]=600,u[113]=601,u[114]=602,u[115]=603,u[116]=604,u[117]=605,u[118]=606,u[119]=607,u[120]=608,u[121]=609,u[122]=610,u[123]=611,u[96]=612,u[97]=613,u[98]=614,u[99]=615,u[100]=616,u[12]=617,u[101]=617,u[144]=617,u[102]=618,u[103]=619,u[104]=620,u[105]=621,u[111]=623,u[191]=623,u[106]=624,u[107]=625,u[109]=626,u[91]=627,u[224]=627,u[92]=628,u[93]=628,u[20]=631,u[45]=632,u[46]=633,u[36]=634,u[35]=635,u[33]=636,u[34]=637,n.keyMap=u;var a={0:0,1:2,2:1};n.mouseMap=a;var f={0:4,1:5,2:6,3:7,4:10,5:11,8:19,9:18,10:12,11:15,12:0,13:2,14:1,15:3};n.padMap=f,n.keyCodeToUnicode=r,n.padButtons=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n.padMap=f,n.padAxisDeadZone=.26,n.maxAxisRange=1,n.padTimestampUpdate=0;var l=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock;if(l){var c=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;n.onPointerLockChanged=function(){var t=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;t!==n.canvas&&n.unlockMouse()},n.onPointerLockError=function(){n.unlockMouse()},"mozPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){this.ignoreNextBlur=!0,document.addEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("mozpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){this.ignoreNextBlur=!1,document.removeEventListener("mozpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("mozpointerlockerror",this.onPointerLockError,!1)}):"webkitPointerLockElement"in document?(n.setEventHandlersPointerLock=function(){document.addEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("webkitpointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("webkitpointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("webkitpointerlockerror",this.onPointerLockError,!1)}):"pointerLockElement"in document&&(n.setEventHandlersPointerLock=function(){document.addEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.addEventListener("pointerlockerror",this.onPointerLockError,!1)},n.setEventHandlersPointerUnlock=function(){document.removeEventListener("pointerlockchange",this.onPointerLockChanged,!1),document.removeEventListener("pointerlockerror",this.onPointerLockError,!1)}),n.requestBrowserLock=function(){var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n!==t&&(this.setEventHandlersPointerLock(),l.call(t))},n.requestBrowserUnlock=function(){this.setEventHandlersPointerUnlock();var n=document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement;n===t&&c.call(document)}}else{var h=navigator.pointer||navigator.webkitPointer;h?(n.requestBrowserLock=function(){h.isLocked||h.lock(t)},n.requestBrowserUnlock=function(){h.isLocked&&h.unlock()}):(n.requestBrowserLock=function(){},n.requestBrowserUnlock=function(){})}n.setEventHandlersCanvas(),n.setEventHandlersWindow(),n.setEventHandlersTouch();var p=TurbulenzEngine.getSystemInfo();return n.macosx="Darwin"===p.osName,n.webkit=/WebKit/.test(navigator.userAgent),n},e.version=1,e}();C.prototype.keyCodes={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,NUMBER_0:100,NUMBER_1:101,NUMBER_2:102,NUMBER_3:103,NUMBER_4:104,NUMBER_5:105,NUMBER_6:106,NUMBER_7:107,NUMBER_8:108,NUMBER_9:109,LEFT:200,RIGHT:201,UP:202,DOWN:203,LEFT_SHIFT:300,RIGHT_SHIFT:301,LEFT_CONTROL:302,RIGHT_CONTROL:303,LEFT_ALT:304,RIGHT_ALT:305,ESCAPE:400,TAB:401,SPACE:402,BACKSPACE:403,RETURN:404,GRAVE:500,MINUS:501,EQUALS:502,LEFT_BRACKET:503,RIGHT_BRACKET:504,SEMI_COLON:505,APOSTROPHE:506,COMMA:507,PERIOD:508,SLASH:509,BACKSLASH:510,F1:600,F2:601,F3:602,F4:603,F5:604,F6:605,F7:606,F8:607,F9:608,F10:609,F11:610,F12:611,NUMPAD_0:612,NUMPAD_1:613,NUMPAD_2:614,NUMPAD_3:615,NUMPAD_4:616,NUMPAD_5:617,NUMPAD_6:618,NUMPAD_7:619,NUMPAD_8:620,NUMPAD_9:621,NUMPAD_ENTER:622,NUMPAD_DIVIDE:623,NUMPAD_MULTIPLY:624,NUMPAD_ADD:625,NUMPAD_SUBTRACT:626,LEFT_WIN:627,RIGHT_WIN:628,LEFT_OPTION:629,RIGHT_OPTION:630,CAPS_LOCK:631,INSERT:632,DELETE:633,HOME:634,END:635,PAGE_UP:636,PAGE_DOWN:637,BACK:638},C.prototype.mouseCodes={BUTTON_0:0,BUTTON_1:1,BUTTON_2:2,DELTA_X:100,DELTA_Y:101,MOUSE_WHEEL:102},C.prototype.padCodes={UP:0,LEFT:1,DOWN:2,RIGHT:3,A:4,B:5,X:6,Y:7,LEFT_TRIGGER:8,RIGHT_TRIGGER:9,LEFT_SHOULDER:10,RIGHT_SHOULDER:11,LEFT_THUMB:12,LEFT_THUMB_X:13,LEFT_THUMB_Y:14,RIGHT_THUMB:15,RIGHT_THUMB_X:16,RIGHT_THUMB_Y:17,START:18,BACK:19},WebGLMathDevice=t;var k=function(){function e(){}return e.prototype.createWebSocket=function(e,t){var n=this.WebSocketConstructor;if(n){var r;return t?r=new n(e,t):r=new n(e),typeof r.destroy=="undefined"&&(r.destroy=function(){this.onopen=null,this.onerror=null,this.onclose=null,this.onmessage=null,this.close()}),r}return null},e.prototype.update=function(){},e.create=function(t){var n=new e;return n},e.version=1,e}();k.prototype.WebSocketConstructor=window.WebSocket?window.WebSocket:window.MozWebSocket;var L=function(){function e(){}return e.version=1,e}(),A={CONTACT_SLOP:.015,CONTACT_BAUMGRAUTE:.35,CONTACT_STATIC_BAUMGRAUTE:.65,CONTACT_MAX_Y_SEPERATION:.05,CONTACT_MAX_SQ_XZ_SEPERATION:2*.245*.245,CONTACT_INHERIT_SQ_SEPERATION:1.6875,CONTACT_EQUAL_SQ_SEPERATION:3e-6,GJK_EPA_DISTANCE_THRESHOLD:1e-4,GJK_FRACTIONAL_THRESHOLD:1e-4,CONTINUOUS_LINEAR_SQ:.35,CONTINUOUS_ANGULAR_SQ:.25,CONTINUOUS_LINEAR_BULLET:.75,CONTINUOUS_ANGULAR_BULLET:.5,CONTINUOUS_SLOP:.015,SLEEP_LINEAR_SQ:.01,SLEEP_ANGULAR_SQ:.1,SLEEP_DELAY:60,MAX_ANGULAR:Math.PI,QUADRATIC_THRESHOLD:1e-8,DONT_NORMALIZE_THRESHOLD:1e-8,COLLINEAR_THRESHOLD:1e-10,COPLANAR_THRESHOLD:1e-16},O=function(t,n){for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i===null||i===undefined)continue;typeof i=="object"&&r!=="shape"&&r!=="userData"&&r!=="world"&&r!=="object"&&r!=="arbiters"&&r!=="islandRoot"&&r!=="island"&&r!=="bodyA"&&r!=="bodyB"&&r!=="triangleArray"&&("slice"in i?i=i.slice():i=O({},i)),t[r]=i}return t},M=function(n,r,i){i||Object.defineProperty(n,"margin",{get:function(){return this._private.collisionRadius},set:function(t){var n=this._private;n.halfExtents[0]+=t-n.collisionRadius,n.halfExtents[1]+=t-n.collisionRadius,n.halfExtents[2]+=t-n.collisionRadius,n.radius+=t-n.collisionRadius,n.collisionRadius=t},enumerable:!0}),Object.defineProperty(n,"halfExtents",{get:function(){return t.v3Copy(this._private.halfExtents)},enumerable:!0}),Object.defineProperty(n,"inertia",{get:function(){return t.v3Copy(this._private.inertia)},enumerable:!0}),Object.defineProperty(n,"radius",{get:function(){return this._private.radius},enumerable:!0}),Object.defineProperty(n,"type",{value:r,enumerable:!0})},_=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.direction,r=e.origin,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=this.normal,c=l[0],h=l[1],p=l[2],d=i*c+s*h+o*p;if(d*d<A.COPLANAR_THRESHOLD)return null;var v=(this.distance-(u*c+a*h+f*p))/d;if(0<=v&&v<=e.maxFactor){d>0&&(c=-c,h=-h,p=-p);var m=u+i*v,g=a+s*v,y=f+o*v;return{factor:v,hitPoint:t.v3Build(m,g,y),hitNormal:t.v3Build(c,h,p)}}return null},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r,i.collisionRadius=n.margin!==undefined?n.margin:.04,i.distance=n.distance;var s=i.normal=t.v3Copy(n.normal),o=Math.abs,u=Number.MAX_VALUE;i.radius=u;var a=new Float32Array(6);return o(s[0])===1?i.halfExtents=t.v3Build(o(i.distance),u,u,a.subarray(0,3)):o(s[1])===1?i.halfExtents=t.v3Build(u,o(i.distance),u,a.subarray(0,3)):o(s[2])===1&&(i.halfExtents=t.v3Build(u,u,o(i.distance),a.subarray(0,3))),i.center=undefined,i.inertia=t.v3BuildZero(a.subarray(3,6)),M(r,"PLANE"),r},e.version=1,e}();_.prototype.type="PLANE";var D=function(){function e(){}return e.prototype.rayTestCap=function(e,n,r){var i=e.origin,s=e.direction,o=i[0],u=i[1],a=i[2],f=s[0],l=s[1],c=s[2],h=this.capsuleRadius,p=f*f+l*l+c*c,d=u-n,v=2*(f*o+l*d+c*a),m=o*o+d*d+a*a-h*h,g=v*v-4*p*m;if(g<0)return null;var y,b=1,w,E=1/(2*p),S=Math.sqrt(g);y=(-v-S)*E,w=u+l*y;if(y<0||r*(w-n)<0)y+=2*S*E,w=u+l*y,b=-1;if(r*(w-n)>=0&&0<=y&&y<=e.maxFactor){var x=o+f*y,T=a+c*y,N=b/h;return{factor:y,hitPoint:t.v3Build(x,w,T),hitNormal:t.v3Build(x*N,(w-n)*N,T*N)}}return null},e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.capsuleRadius,h=this.halfHeight,p=c*c,d,v=1,m,g,y,b=u*u+f*f;if(b>=A.QUADRATIC_THRESHOLD){var w=2*(i*u+o*f),E=i*i+o*o-p,S=w*w-4*b*E,x=1/(2*b);if(S<A.QUADRATIC_THRESHOLD)d=-w*x;else if(S>0){var T=Math.sqrt(S);d=(-w-T)*x,d<0&&(d+=T*2*x,v=-1)}var N;g=s+a*d;if(-h<=g&&g<=h)return 0<=d&&d<=l?(m=i+u*d,y=o+f*d,N=v/c,{factor:d,hitPoint:t.v3Build(m,g,y),hitNormal:t.v3Build(m*N,0,y*N)}):null}return this.rayTestCap(e,h,1)||this.rayTestCap(e,-h,-1)},e.prototype.localSupportWithoutMargin=function(e,t){t[0]=0,t[1]=e[1]>=0?this.halfHeight:-this.halfHeight,t[2]=0},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+a,l=o+s,c=f+s,h=o+s,p=2*l,d=2*c,v=2*h;p*=p,d*=d,v*=v;var m=1/12,g=new Float32Array(6);return i.radius=f+s,i.capsuleRadius=o,i.halfHeight=a,i.halfExtents=t.v3Build(l,c,h,g.subarray(0,3)),i.inertia=t.v3Build(m*(d+v),m*(p+v),m*(p+d),g.subarray(3,6)),i.collisionRadius=o+s,i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.capsuleRadius},set:function(t){var n=this._private;n.collisionRadius=n.capsuleRadius+t,n.halfExtents[0]=n.capsuleRadius+t,n.halfExtents[1]=n.capsuleRadius+n.halfHeight+t,n.halfExtents[2]=n.capsuleRadius+t,n.radius=n.capsuleRadius+n.halfHeight+t},enumerable:!0}),M(r,"CAPSULE",!0),r},e.version=1,e}();L.prototype.type="CAPSULE";var P=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=this.sphereRadius,s=r[0],o=r[1],u=r[2],a=n[0],f=n[1],l=n[2],c=s*s+o*o+u*u,h=2*(a*s+f*o+l*u),p=a*a+f*f+l*l-i*i,d,v=h*h-4*c*p;if(v<=0)return null;var m=1,g=1/(2*c),y=Math.sqrt(v);d=(-h-y)*g,d<0&&(d+=y*2*g,m=-1);if(0<=d&&d<e.maxFactor){var b=a+s*d,w=f+o*d,E=l+u*d,S=m/i;return{factor:d,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(b*S,w*S,E*S)}}return null},e.prototype.localSupportWithoutMargin=function(e,t){t[0]=t[1]=t[2]=0},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=.4*o*o,a=new Float32Array(6);return i.sphereRadius=o,i.radius=i.sphereRadius+s,i.collisionRadius=o+s,i.halfExtents=t.v3Build(o+s,o+s,o+s,a.subarray(0,3)),i.inertia=t.v3Build(u,u,u,a.subarray(3,6)),i.center=undefined,Object.defineProperty(r,"margin",{get:function(){return this._private.collisionRadius-this._private.radius},set:function(t){var n=this._private;n.collisionRadius=n.radius+t,n.halfExtents[0]=n.collisionRadius,n.halfExtents[1]=n.collisionRadius,n.halfExtents[2]=n.collisionRadius,n.radius=n.collisionRadius},enumerable:!0}),M(r,"SPHERE",!0),r},e.version=1,e}();P.prototype.type="SPHERE";var H=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=this.halfExtents,c=l[0],h=l[1],p=l[2],d,v,m,g,y,b;if(u!==0&&(u>0&&i<=-c||u<0&&i>=c)){g=u>0?i>=-c?c:-c:i<=c?-c:c,m=(g-i)/u;if(d===undefined||m<d)y=s+a*m,b=o+f*m,-h<=y&&y<=h&&-p<=b&&b<=p&&(d=m,v=0)}if(a!==0&&(a>0&&s<=-h||a<0&&s>=h)){g=a>0?s>=-h?h:-h:s<=h?-h:h,m=(g-s)/a;if(d===undefined||m<d)y=i+u*m,b=o+f*m,-c<=y&&y<=c&&-p<=b&&b<=p&&(d=m,v=1)}if(f!==0&&(f>0&&o<=-p||f<0&&o>=p)){g=f>0?o>=-p?p:-p:o<=p?-p:p,m=(g-o)/f;if(d===undefined||m<d)y=s+a*m,b=i+u*m,-h<=y&&y<=h&&-c<=b&&b<=c&&(d=m,v=2)}return d!==undefined&&d<e.maxFactor?{hitPoint:t.v3Build(i+u*d,s+a*d,o+f*d),hitNormal:t.v3Build(v===0?u>0?-1:1:0,v===1?a>0?-1:1:0,v===2?f>0?-1:1:0),factor:d}:null},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.halfExtents,o=s[0],u=s[1],a=s[2];t[0]=n<0?-o:o,t[1]=r<0?-u:u,t[2]=i<0?-a:a},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=2*u,c=2*a,h=2*f;l*=l,c*=c,h*=h;var p=new Float32Array(6);return i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f,p.subarray(0,3)),i.inertia=t.v3Build(1/12*(c+h),1/12*(l+h),1/12*(l+c),p.subarray(3,6)),i.collisionRadius=s,M(r,"BOX"),r},e.version=1,e}();H.prototype.type="BOX";var B=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.cylinderRadius,h=this.halfHeight,p=c*c,d=u*u+f*f,v=2*(i*u+o*f),m=i*i+o*o-p,g,y=1,b,w,E,S,x,T=v*v-4*d*m;if(T>=0){x=1/(2*d);var N=Math.sqrt(T);g=(-v-N)*x,g<0&&(g+=N*2*x,y=-1),w=s+a*g;if(-h<=w&&w<=h)return 0<=g&&g<=l?(b=i+u*g,E=o+f*g,S=y/c,{factor:g,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(b*S,0,E*S)}):null}if(a*a>=A.COPLANAR_THRESHOLD){S=a<0?-1:1,w=-S*h,x=1/a,g=(w-s)*x,g<0&&(w=S*h,g=(w-s)*x);if(0<=g&&g<=l){b=i+u*g,E=o+f*g;if(b*b+E*E<=p)return{factor:g,hitPoint:t.v3Build(b,w,E),hitNormal:t.v3Build(0,-S,0)}}}return null},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[2],i=n*n+r*r;if(i===0){e[1]>0?(t[0]=this.cylinderRadius,t[1]=this.halfHeight,t[2]=0):(t[0]=0,t[1]=-this.halfHeight,t[2]=-this.cylinderRadius);return}var s=this.cylinderRadius/Math.sqrt(i);t[0]=n*s,t[1]=(e[1]>0?1:-1)*this.halfHeight,t[2]=r*s},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.halfExtents,u=o[0]+s,a=o[1]+s,f=o[2]+s,l=u*u,c=4*a*a,h=1/12*c+.25*l,p=.5*l,d=new Float32Array(6);return i.center=undefined,i.radius=Math.sqrt(u*u+a*a+f*f),i.halfExtents=t.v3Build(u,a,f,d.subarray(0,3)),i.cylinderRadius=o[0],i.halfHeight=o[1],i.inertia=t.v3Build(h,p,h,d.subarray(3,6)),i.collisionRadius=s,M(r,"CYLINDER"),r},e.version=1,e}();B.prototype.type="CYLINDER";var j=function(){function e(){}return e.prototype.rayTest=function(e){var n=e.origin,r=e.direction,i=n[0],s=n[1],o=n[2],u=r[0],a=r[1],f=r[2],l=e.maxFactor,c=this.coneRadius,h=this.halfHeight,p=c/(2*h);p*=p;var d=s-h,v=u*u+f*f-p*a*a,m=2*(i*u+o*f-p*d*a),g=i*i+o*o-p*d*d,y,b=1,w,E,S,x=m*m-4*v*g;if(x>=0){var T=1/(2*v),N=Math.sqrt(x);y=(-m-N)*T,E=s+a*y;if(y<0||E<-h||E>h){y+=2*N*T,b=-1,E=s+a*y;if(y<0||E<-h||E>h)y=undefined}}var C;if(a!==0){C=(-h-s)/a,w=i+u*C,S=o+f*C;if(C<0||w*w+S*S>c*c)C=undefined}if(C===undefined&&y===undefined)return null;if(C===undefined||y!==undefined&&y<C){if(y>=l)return null;w=i+u*y,E=s+a*y,S=o+f*y;var k=p*(E-h),L=b/Math.sqrt(w*w+k*k+S*S);return{hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(L*w,L*k,L*S),factor:y}}return C>=l?null:(w=i+u*C,E=s+a*C,S=o+f*C,{hitPoint:t.v3Build(w,E,S),hitNormal:t.v3Build(0,s<-h?-1:1,0),factor:C})},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+i*i);-this.coneRadius*s+2*this.halfHeight*r>0?(t[0]=t[2]=0,t[1]=this.halfHeight):(s===0?(t[0]=this.coneRadius,t[2]=0):(t[0]=n*this.coneRadius/s,t[2]=i*this.coneRadius/s),t[1]=-this.halfHeight)},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.radius,u=n.height,a=.5*u,f=o+s,l=a+s,c=o+s,h=2*f,p=2*l,d=2*c;h*=h,p*=p,d*=d;var v=1/12,m=new Float32Array(6);return i.halfHeight=a,i.coneRadius=o,i.radius=Math.sqrt(f*f+l*l+c*c),i.halfExtents=t.v3Build(f,l,c,m.subarray(0,3)),i.inertia=t.v3Build(v*(p+d),v*(h+d),v*(h+p),m.subarray(3,6)),i.collisionRadius=s,i.center=undefined,M(r,"CONE"),r},e.version=1,e}();j.prototype.type="CONE";var F=function(){function e(){}return e.create=function(t){var n=new e,r=new I;n._private=r,r._public=n;var i=t.vertices,s=i.length/3,o=t.indices,u=o.length/3,a=t.minExtent,l=t.maxExtent,c,h,p;if(!a||!l){var d=i[0],v=i[1],m=i[2],g=d,y=v,b=m,w=i.length;for(var E=3;E<w;E+=3)c=i[E],h=i[E+1],p=i[E+2],d>c?d=c:g<c&&(g=c),v>h?v=h:y<h&&(y=h),m>p?m=p:b<p&&(b=p);a=[d,v,m],l=[g,y,b]}var S=new Float32Array(6);S[0]=a[0],S[1]=a[1],S[2]=a[2],S[3]=l[0],S[4]=l[1],S[5]=l[2],r.vertices=t.dontCopy?i:new Float32Array(i),r.numVertices=s,r.indices=t.dontCopy?o:s<65536?new Uint16Array(o):new Uint32Array(o),r.numTriangles=u,r.extents=S,Object.defineProperty(n,"vertices",{value:r.vertices,enumerable:!0}),Object.defineProperty(n,"indices",{value:r.indices,enumerable:!0});var x=new Float32Array(I.prototype.TRIANGLE_SIZE*u),T=null;u>=8&&(T=f.create(!0),S=new Float32Array(6));var N;for(N=0;N<u;N+=1){var C=N*3,k=N*I.prototype.TRIANGLE_SIZE,L=o[C]*3,A=o[C+1]*3,O=o[C+2]*3,M=i[L],_=i[L+1],D=i[L+2],P=i[A],H=i[A+1],B=i[A+2],j=i[O],F=i[O+1],q=i[O+2],R=P-M,U=H-_,z=B-D;c=j-M,h=F-_,p=q-D;var W=U*p-z*h,X=z*c-R*p,V=R*h-U*c,$=1/Math.sqrt(W*W+X*X+V*V),J=(W*M+X*_+V*D)*$,K=R*c+U*h+z*p,Q=R*R+U*U+z*z,G=c*c+h*h+p*p,Y=K*K-
Q*G;x[k]=W*$,x[k+1]=X*$,x[k+2]=V*$,x[k+3]=M,x[k+4]=_,x[k+5]=D,x[k+6]=R,x[k+7]=U,x[k+8]=z,x[k+9]=c,x[k+10]=h,x[k+11]=p,x[k+12]=Q,x[k+13]=G,x[k+14]=K,x[k+15]=Y,x[k+16]=J;if(T){S[0]=Math.min(M,P,j),S[1]=Math.min(_,H,F),S[2]=Math.min(D,B,q),S[3]=Math.max(M,P,j),S[4]=Math.max(_,H,F),S[5]=Math.max(D,B,q);var Z={index:k,spatialIndex:undefined};T.add(Z,S)}}return T&&T.finalize(),r.triangles=x,r.spatialMap=T,n},e.version=1,e}(),I=function(){function e(){}return e.prototype.rayTest=function(n){function s(e,n,i,s,o){var u=i.direction,a=u[0],f=u[1],l=u[2],c=i.origin,h=c[0],p=c[1],d=c[2],v=n.index,m=r[v],g=r[v+1],y=r[v+2],b=a*m+f*g+l*y;if(b*b<A.COPLANAR_THRESHOLD)return null;var w=r[v+16],E=r[v+3],S=r[v+4],x=r[v+5],T=(w-(h*m+p*g+d*y))/b;if(T<0||T>=o)return null;b>0&&(m=-m,g=-g,y=-y,b=-b);var N=h+a*T,C=p+f*T,k=d+l*T,L=N-E,O=C-S,M=k-x,_=r[v+12],D=r[v+13],P=r[v+14],H=r[v+15],B=r[v+6],j=r[v+7],F=r[v+8],I=r[v+9],q=r[v+10],R=r[v+11],U=L*B+O*j+M*F,z=L*I+O*q+M*R,W=P*z-D*U;if(W>0||W<H)return null;var X=P*U-_*z;return X>0||W+X<H?null:{factor:T,hitPoint:t.v3Build(N,C,k),hitNormal:t.v3Build(m,g,y)}}var r=this.triangles,i=this.spatialMap;if(i)return f.rayTest([i],n,s);var o=null,u=n.maxFactor,a={index:0},l,c=this.numTriangles*e.prototype.TRIANGLE_SIZE;for(l=0;l<c;l+=e.prototype.TRIANGLE_SIZE){a.index=l;var h=s(null,a,n,0,u);h&&(o=h,u=o.factor)}return o},e.version=1,e}();I.prototype.TRIANGLE_SIZE=17;var q={isPlanar:function(t){var n=A.COPLANAR_THRESHOLD,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v=1/Math.sqrt(h*h+p*p+d*d);h*=v,p*=v,d*=v;var m=-(r*h+i*p+s*d),g,y=t.length;for(g=0;g<y;g+=3){var b=t[g]*h+t[g+1]*p+t[g+2]*d+m;if(b*b>n)return!1}return!0},makePlanarConvexHull:function(t){var n=1e-6,r=t[0],i=t[1],s=t[2],o=t[3]-r,u=t[4]-i,a=t[5]-s,f=t[6]-r,l=t[7]-i,c=t[8]-s,h=u*c-a*l,p=a*f-o*c,d=o*l-u*f,v,m,g;h*h+d*d<n?(v=1,m=g=0):(v=-d,m=0,g=h);var y=p*g-d*m,b=d*v-h*g,w=h*m-p*v,E=t.length/3,S=new Float32Array(E*2),x,T,N,C;for(C=0;C<E;C+=1)x=t[C*3],T=t[C*3+1],N=t[C*3+2],S[C*2]=x*v+T*m+N*g,S[C*2+1]=x*y+T*b+N*w;var k=0;r=S[0],i=S[1];for(C=2;C<E*2;C+=2){x=S[C],T=S[C+1];if(x<r||x===r&&T<i)k=C/2,r=x,i=T}var L={};L[k]=0;var A=1,O=[],M=k;for(;;){var _,D,P,H=-1;for(C=0;C<E*2;C+=2){if(C===k*2)continue;x=S[C],T=S[C+1];var B=(x-r)*(x-r)+(T-i)*(T-i);if(H===-1){H=C/2,_=x,D=T,P=B;continue}var j=(_-r)*(T-i)-(D-i)*(x-r);if(j<0||j===0&&B>P)H=C/2,_=x,D=T,P=B}if(H in L)break;L[H]=A,A+=1,k!==M&&(O.push(M),O.push(k),O.push(H)),k=H,r=S[H*2],i=S[H*2+1]}return this.createArray(t,O,L,A)},makeConvexHull:function(t){var n=0,r=t[0],i=t[1],s=t[2],o,u,a,f,l=t.length/3;for(o=3;o<l*3;o+=3){u=t[o],a=t[o+1],f=t[o+2];if(u<r||u===r&&(a<i||a===i&&f<s))n=o/3,r=u,i=a,s=f}var c=-1,h=-2,p=0,d,v;for(o=0;o<l*3;o+=3){if(o===n*3)continue;u=t[o],a=t[o+1],d=u-r,v=a-i;var m=d*d+v*v;if(m===0){c===-1&&(c=o/3);continue}var g=v/Math.sqrt(m);if(g>h||g===h&&m>p)h=g,p=m,c=o/3}var y={},b=[n,c,c,n],w={};w[n]=0,w[c]=1;var E=2,S=[];while(b.length>0){c=b.pop(),n=b.pop();if(n+":"+c in y)continue;var x=-1,T,N,C,k,L;r=t[n*3],i=t[n*3+1],s=t[n*3+2];var O=t[c*3]-r,M=t[c*3+1]-i,_=t[c*3+2]-s,D=1/(O*O+M*M*_*_);for(o=0;o<l*3;o+=3){if(o===n*3||o===c*3)continue;u=t[o],a=t[o+1],f=t[o+2];var P=((u-r)*O+(a-i)*M+(f-s)*_)*D,H=u-(r+O*P),B=a-(i+M*P),j=f-(s+_*P),F=H*H+B*B+j*j;if(F<=A.COLLINEAR_THRESHOLD)continue;if(x===-1){x=o/3,T=H,N=B,C=j,k=F,L=P;continue}var I=B*C-j*N,q=j*T-H*C,R=H*N-B*T,U=H*(M*C-_*N)+B*(_*T-O*C)+j*(O*N-M*T);if(U*U<A.COPLANAR_THRESHOLD)if(H*T+B*N+j*C>=0){if(F>k||F===k&&P>L)x=o/3,T=H,N=B,C=j,k=F,L=P}else{d=u-r,v=a-i;var z=f-s;I=v*_-z*M,q=z*O-d*_,R=d*M-v*O;var W=!0,X;for(X=0;X<l*3;X+=3)if(I*(t[X]-r)+q*(t[X+1]-i)+R*(t[X+2]-s)<0){W=!1;break}W&&(x=o/3,T=H,N=B,C=j,k=F,L=P)}else{var V=I*O+q*M+R*_;if(V<0||V<=A.COLLINEAR_THRESHOLD&&F>k)x=o/3,T=H,N=B,C=j,k=F,L=P}}x in w||(w[x]=E,E+=1),n+":"+c in y||c+":"+x in y||x+":"+n in y||(S.push(n),S.push(c),S.push(x),y[n+":"+c]=!0,y[c+":"+x]=!0,y[x+":"+n]=!0,b.push(x),b.push(c),b.push(n),b.push(x))}return this.createArray(t,S,w,E)},createArray:function(t,n,r,i){var s=new Float32Array(i*3),o=n.length,u=i<65536?new Uint16Array(o):new Uint32Array(o),a=t.length/3,f;for(f=0;f<a;f+=1){if(!(f in r))continue;var l=r[f]*3;s[l]=t[f*3],s[l+1]=t[f*3+1],s[l+2]=t[f*3+2]}for(f=0;f<o;f+=1)u[f]=r[n[f]];return F.create({vertices:s,indices:u,dontCopy:!0})._private}},R=function(){function e(){}return e.prototype.rayTest=function(e){return this.triangleArray.rayTest(e)},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.triangleArray._private,u=o.extents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=.5*(c-a)+s,v=.5*(h-f)+s,m=.5*(p-l)+s,g=.5*(a+c),y=.5*(f+h),b=.5*(l+p),w=new Float32Array(6);return i.triangleArray=o,i.radius=Math.sqrt(d*d+v*v+m*m),i.halfExtents=t.v3Build(d,v,m,w.subarray(0,3)),g!==0||y!==0||b!==0?i.center=t.v3Build(g,y,b):i.center=undefined,i.inertia=t.v3Build(0,0,0,w.subarray(3,6)),i.collisionRadius=s,M(r,"TRIANGLE_MESH"),Object.defineProperty(r,"triangleArray",{get:function(){return this._private.triangleArray},enumerable:!0}),r},e.version=1,e}();R.prototype.type="TRIANGLE_MESH";var U=function(){function e(){}return e.prototype.rayTest=function(e){var t=this.triangleArray;return t===undefined?null:t.rayTest(e)},e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.supportTopology,o=this.triangleArray.vertices;this.lastSupport===undefined&&(this.lastSupport=0);var u=this.lastSupport,a=s[u],f=o[a]*n+o[a+1]*r+o[a+2]*i;for(;;){var l=-1,c,h=s[u+1];for(c=0;c<h;c+=1){var p=s[u+2+c];a=s[p];var d=o[a]*n+o[a+1]*r+o[a+2]*i;d>f&&(f=d,l=p)}if(l!==-1){u=l;continue}break}this.lastSupport=u,a=s[u],t[0]=o[a],t[1]=o[a+1],t[2]=o[a+2]},e.create=function(n){var r=new L,i=new e;r._private=i,i._public=r;var s=n.margin!==undefined?n.margin:.04,o=n.points,u=n.minExtent,a=n.maxExtent,f,l,c,h,p,d;if(!u||!a){f=o[0],l=o[1],c=o[2],h=f,p=l,d=c;var v=o.length,m,g,y,b;for(m=3;m<v;m+=3)g=o[m],y=o[m+1],b=o[m+2],f>g?f=g:h<g&&(h=g),l>y?l=y:p<y&&(p=y),c>b?c=b:d<b&&(d=b)}else f=u[0],l=u[1],c=u[2],h=a[0],p=a[1],d=a[2];var w=.5*(h-f)+s,E=.5*(p-l)+s,S=.5*(d-c)+s,x=.5*(f+h),T=.5*(l+p),N=.5*(c+d),C=2*w,k=2*E,A=2*S;C*=C,k*=k,A*=A;var O=1/12,_=new Float32Array(6);i.points=new Float32Array(o),i.radius=Math.sqrt(w*w+E*E+S*S),i.halfExtents=t.v3Build(w,E,S,_.subarray(0,3)),x!==0||T!==0||N!==0?i.center=t.v3Build(x,T,N):i.center=undefined,i.inertia=t.v3Build(O*(k+A),O*(C+A),O*(C+k),_.subarray(3,6)),i.collisionRadius=s;if(o.length<9)throw"At present time, WebGL PhysicsDevice does not permit a convex hull to contain less than 3 vertices";var D=q.isPlanar(o);D?i.triangleArray=q.makePlanarConvexHull(o):i.triangleArray=q.makeConvexHull(o);var P=[];o=i.triangleArray.vertices,v=o.length;for(m=0;m<v;m+=3)P[m/3]=[];var H;if(D)for(m=0;m<v/3;m+=1)H=(m+1)%(v/3),P[m].push(H),P[H].push(m);else{var B=i.triangleArray.indices;v=B.length;for(m=0;m<v;m+=3){var j=B[m],F=B[m+1],I=B[m+2];P[j].push(F),P[F].push(I),P[I].push(j)}}v=o.length;if(D&&v>=18||!D&&v>=30)for(m=0;m<v;m+=3){var R=Number.MAX_VALUE;g=o[m],y=o[m+1],b=o[m+2];var U;for(H=0;H<v;H+=3){var z=g*o[H]+y*o[H+1]+b*o[H+2];z<R&&(R=z,U=H)}P[m/3].push(U/3)}var W=[],X=0;for(m=0;m<v/3;m+=1)W.push(X),X+=P[m].length+2;i.supportTopology=X>65536?new Uint32Array(X):new Uint16Array(X);var V=0;for(m=0;m<v/3;m+=1){i.supportTopology[V]=m*3,V+=1;var $=P[m];i.supportTopology[V]=$.length,V+=1;for(H=0;H<$.length;H+=1)i.supportTopology[V]=W[$[H]],V+=1}return M(r,"CONVEX_HULL"),r},e.version=1,e}();U.prototype.type="CONVEX_HULL";var z=function(){function e(n,r){this._public=r,this.id=e.uniqueId,e.uniqueId+=1,this.world=null,this.shape=n.shape._private,this.friction=n.friction!==undefined?n.friction:.5,this.restitution=n.restitution!==undefined?n.restitution:0;var i=new Float32Array(78),s=0,o=n.transform;this.transform=o?t.m43Copy(o,i.subarray(s,s+12)):t.m43BuildIdentity(i.subarray(s,s+12)),s+=12,this.arbiters=[],this.constraints=[],this.velocity=i.subarray(s,s+12),s+=12;var u=n.linearVelocity;u&&(this.velocity[0]=u[0],this.velocity[1]=u[1],this.velocity[2]=u[2]),u=n.angularVelocity,u&&(this.velocity[3]=u[0],this.velocity[4]=u[1],this.velocity[5]=u[2]),this.linearDamping=n.linearDamping!==undefined?n.linearDamping:0,this.angularDamping=n.angularDamping!==undefined?n.angularDamping:0,this.extents=i.subarray(s,s+6),s+=6,this.startTransform=t.m43BuildIdentity(i.subarray(s,s+12)),s+=12,this.endTransform=t.m43BuildIdentity(i.subarray(s,s+12)),s+=12,this.prevTransform=t.m43Copy(this.transform,i.subarray(s,s+12)),s+=12,this.newTransform=t.m43BuildIdentity(i.subarray(s,s+12)),s+=12,this.island=null,this.islandRoot=this,this.islandRank=0,this.delaySleep=!0,this.group=0,this.mask=0,this.kinematic=!1,this.fixedRotation=!1,this.mass=0,this.inverseMass=0,this.inverseInertiaLocal=null,this.inverseInertia=null,this.collisionObject=!1,this.permitSleep=!1,this.sweepFrozen=!1,this.active=!1,this.contactCallbacks=null}return e.prototype.computeDeltaVelocity=function(e,n,r,i){var s=i||this.velocity,o=!1;s[0]=r[9]-n[9],s[1]=r[10]-n[10],s[2]=r[11]-n[11];if(s[0]!==0||s[1]!==0||s[2]!==0)o=!0;s[0]/=e,s[1]/=e,s[2]/=e;var u=n[0]*r[0]+n[3]*r[3]+n[6]*r[6],a=n[0]*r[1]+n[3]*r[4]+n[6]*r[7],f=n[0]*r[2]+n[3]*r[5]+n[6]*r[8],l=n[1]*r[0]+n[4]*r[3]+n[7]*r[6],c=n[1]*r[1]+n[4]*r[4]+n[7]*r[7],h=n[1]*r[2]+n[4]*r[5]+n[7]*r[8],p=n[2]*r[0]+n[5]*r[3]+n[8]*r[6],d=n[2]*r[1]+n[5]*r[4]+n[8]*r[7],v=n[2]*r[2]+n[5]*r[5]+n[8]*r[8],m,g,y,b,w,E=u+c+v+1;E>t.precision?(b=Math.sqrt(E)/2,m=(h-d)/(4*b),g=(p-f)/(4*b),y=(a-l)/(4*b)):u>c&&u>v?(w=Math.sqrt(1+u-c-v)*2,b=(h-d)/w,m=.25*w,g=(l+a)/w,y=(p+f)/w):c>v?(w=Math.sqrt(1+c-u-v)*2,b=(p-f)/w,m=(l+a)/w,g=.25*w,y=(d+h)/w):(w=Math.sqrt(1+v-u-c)*2,b=(a-l)/w,m=(p+f)/w,g=(d+h)/w,y=.25*w);var S=Math.acos(b)*2,x=1-b*b;if(x<t.precision||S===0)s[3]=s[4]=s[5]=0;else{var T=S/(e*Math.sqrt(x));s[3]=m*T,s[4]=g*T,s[5]=y*T,o=!0}return o},e.prototype.calculateSweptExtents=function(e){var t=this.shape,n=t.radius,r=this.startTransform,i=r[9],s=r[10],o=r[11],u=this.transform,a=u[9],f=u[10],l=u[11],c;i>a&&(c=i,i=a,a=c),s>f&&(c=s,s=f,f=c),o>l&&(c=o,o=l,l=c),e[0]=i-n,e[1]=s-n,e[2]=o-n,e[3]=a+n,e[4]=f+n,e[5]=l+n},e.prototype.calculateExtents=function(e){var t=this.shape,n=t.center,r=t.halfExtents,i=r[0],s=r[1],o=r[2],u=this.transform,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=u[6],v=u[7],m=u[8],g=u[9],y=u[10],b=u[11];if(n){var w=n[0],E=n[1],S=n[2];if(w!==0||E!==0||S!==0)g+=a*w+c*E+d*S,y+=f*w+h*E+v*S,b+=l*w+p*E+m*S}var x=(a<0?-a*i:a>0?a*i:0)+(c<0?-c*s:c>0?c*s:0)+(d<0?-d*o:d>0?d*o:0),T=(f<0?-f*i:f>0?f*i:0)+(h<0?-h*s:h>0?h*s:0)+(v<0?-v*o:v>0?v*o:0),N=(l<0?-l*i:l>0?l*i:0)+(p<0?-p*s:p>0?p*s:0)+(m<0?-m*o:m>0?m*o:0);e[0]=g-x,e[1]=y-T,e[2]=b-N,e[3]=g+x,e[4]=y+T,e[5]=b+N},e.prototype.rayTest=function(e){var n=this.transform,r={origin:at.prototype.m43InverseOrthonormalTransformPoint(n,e.origin),direction:at.prototype.m43InverseOrthonormalTransformVector(n,e.direction),maxFactor:e.maxFactor},i=this.shape.rayTest(r);return i!==null&&(i.hitPoint=t.m43TransformPoint(n,i.hitPoint,i.hitPoint),i.hitNormal=t.m43TransformVector(n,i.hitNormal,i.hitNormal)),i},e.prototype.integratePositionWithVelocities=function(e,t,n,r){var i=this.velocity,s=Math.sqrt;t[9]=e[9]+n*i[r],t[10]=e[10]+n*i[r+1],t[11]=e[11]+n*i[r+2];var o=i[r+3]*n,u=i[r+4]*n,a=i[r+5]*n,f=e[0],l=e[1],c=e[2],h=e[3],p=e[4],d=e[5],v=e[6],m=e[7],g=e[8],y=f-a*l+u*c,b=l+a*f-o*c,w=c-u*f+o*l,E=h-a*p+u*d,S=p+a*h-o*d,x=d-u*h+o*p,T=v-a*m+u*g,N=m+a*v-o*g,C=g-u*v+o*m,k=1/s(y*y+b*b+w*w);y*=k,b*=k,w*=k,k=-(y*E+b*S+w*x),E+=y*k,S+=b*k,x+=w*k,k=1/s(E*E+S*S+x*x),E*=k,S*=k,x*=k,k=-(y*T+b*N+w*C),T+=y*k,N+=b*k,C+=w*k,k=-(E*T+S*N+x*C),T+=E*k,N+=S*k,C+=x*k,k=1/s(T*T+N*N+C*C),T*=k,N*=k,C*=k,t[0]=y,t[1]=b,t[2]=w,t[3]=E,t[4]=S,t[5]=x,t[6]=T,t[7]=N,t[8]=C},e.prototype.applyBiasVelocities=function(e){var t=this.velocity;this.integratePositionWithVelocities(this.transform,this.startTransform,e,6),t[6]=t[7]=t[8]=0,t[9]=t[10]=t[11]=0},e.prototype.integratePosition=function(e){this.integratePositionWithVelocities(this.startTransform,this.transform,e,0)},e.prototype.refreshInertiaTensor=function(){var e=this.transform,t=this.inverseInertiaLocal,n=t[0],r=t[1],i=t[2],s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7],p=e[8],d=this.inverseInertia;d[0]=s*s*n+a*a*r+c*c*i,d[1]=s*o*n+a*f*r+c*h*i,d[2]=s*u*n+a*l*r+c*p*i,d[3]=o*s*n+f*a*r+h*c*i,d[4]=o*o*n+f*f*r+h*h*i,d[5]=o*u*n+f*l*r+h*p*i,d[6]=u*s*n+l*a*r+p*c*i,d[7]=u*o*n+l*f*r+p*h*i,d[8]=u*u*n+l*l*r+p*p*i},e.prototype.integrateVelocity=function(e,t){var n=this.velocity,r=Math.pow,i=r(1-this.linearDamping,t);n[0]=(n[0]+t*e[0])*i,n[1]=(n[1]+t*e[1])*i,n[2]=(n[2]+t*e[2])*i;var s=r(1-this.angularDamping,t),o=n[3]*s,u=n[4]*s,a=n[5]*s,f=A.MAX_ANGULAR/t,l=o*o+u*u+a*a;if(l>f*f){var c=f/Math.sqrt(l);o*=c,u*=c,a*=c}n[3]=o,n[4]=u,n[5]=a},e.prototype.isActiveVelocity=function(e,t){var n=this.shape.radius,r=this.velocity,i=r[0],s=r[1],o=r[2],u=i*i+s*s+o*o;return u>e*n*n?!0:(i=r[3],s=r[4],o=r[5],i*i+s*s+o*o>t?!0:!1)},e.prototype.isActive=function(){return this.permitSleep?this.isActiveVelocity(A.SLEEP_LINEAR_SQ,A.SLEEP_ANGULAR_SQ)?(this.wakeTimeStamp=this.world.timeStamp,!0):this.wakeTimeStamp+A.SLEEP_DELAY>this.world.timeStamp:!0},e.version=1,e.uniqueId=0,e}(),W=function(){function e(){}return e.prototype.calculateExtents=function(e){this._private.calculateExtents(e)},e.prototype.calculateTransform=function(e,n){var r=this._private.transform;n?t.m43NegOffset(r,n,e):(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11])},e.prototype.clone=function(){return e.create(this)},e.create=function(n){var r=new e,i=new z(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0});var s=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;if(r.kinematic||!r.world)t.m43Copy(n,r.transform),r.world&&r.world.wakeBody(r)},enumerable:!0});var o=n.group!==undefined?n.group:ft.prototype.FILTER_STATIC;Object.defineProperty(r,"group",{value:o,enumerable:!0});var u=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL^ft.prototype.FILTER_STATIC;return Object.defineProperty(r,"mask",{value:u,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"kinematic",{value:s,enumerable:!0}),i.group=o,i.mask=u,i.kinematic=s,i.fixedRotation=!s,i.mass=0,i.inverseMass=0,i.inverseInertiaLocal=e.sharedInverseInertiaLocal,i.inverseInertia=e.sharedInverseInertia,i.collisionObject=!0,i.permitSleep=!1,i.sweepFrozen=!0,i.active=s,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,u):i.contactCallbacks=null,r},e.version=1,e.sharedInverseInertiaLocal=t.v3BuildZero(),e.sharedInverseInertia=new Float32Array([0,0,0,0,0,0,0,0,0]),e}(),X=function(){function e(e,t){return this.mask=e.contactCallbacksMask!==undefined?e.contactCallbacksMask:t,this.added=!1,this.deferred=e.onAddedContacts||e.onProcessedContacts||e.onRemovedContacts,this.onPreSolveContact=e.onPreSolveContact||null,this.onAddedContacts=e.onAddedContacts||null,this.onProcessedContacts=e.onProcessedContacts||null,this.onRemovedContacts=e.onRemovedContacts||null,this.trigger=e.trigger||!1,this}return e}(),V=function(){function e(){this.calculateExtents=W.prototype.calculateExtents,this.calculateTransform=W.prototype.calculateTransform}return e.prototype.clone=function(){return e.create(this)},e.create=function(n){var r=new e,i=new z(n,r);r._private=i,r.userData="userData"in n?n.userData:null,Object.defineProperty(r,"shape",{value:n.shape,enumerable:!0}),Object.defineProperty(r,"linearVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.velocity;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(r,"angularVelocity",{get:function(){var n=this._private.velocity;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.velocity;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(r,"transform",{get:function(){return t.m43Copy(this._private.transform)},set:function(n){var r=this._private;t.m43Copy(n,r.transform);var i=r.arbiters,s,o=i.length;for(s=0;s<o;s+=1)i[s].skipDiscreteCollisions=!1},enumerable:!0}),Object.defineProperty(r,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeBody(n);else{var r=n.world.activeBodies;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1;var i=n.arbiters,s,o=i.length;for(s=0;s<o;s+=1){var u=i[s];if(!u.active)continue;u.active=!1;var a=n.world.activeArbiters;a[a.indexOf(u)]=a[a.length-1],a.pop()}n.world.syncBody(n)}else n.active=t},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_DYNAMIC;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0}),Object.defineProperty(r,"friction",{get:function(){return this._private.friction},set:function(t){var n=this._private;n.friction=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"restitution",{get:function(){return this._private.restitution},set:function(t){var n=this._private;n.restitution=t;var r=n.arbiters,i,s=r.length;for(i=0;i<s;i+=1)r[i].invalidateParameters()},enumerable:!0}),Object.defineProperty(r,"linearDamping",{get:function(){return this._private.linearDamping},set:function(t){this._private.linearDamping=t},enumerable:!0}),Object.defineProperty(r,"angularDamping",{get:function(){return this._private.angularDamping},set:function(t){this._private.angularDamping=t},enumerable:!0});var u=n.kinematic!==undefined?n.kinematic:!1;Object.defineProperty(r,"kinematic",{value:u,enumerable:!0});var a=n.mass!==undefined?n.mass:1;Object.defineProperty(r,"mass",{value:a,enumerable:!0});var f=n.inertia?t.v3Copy(n.inertia):t.v3ScalarMul(n.shape.inertia,a);return Object.defineProperty(r,"inertia",{get:function(){return t.v3Copy(f)},enumerable:!0}),i.group=s,i.mask=o,i.active=n.active!==undefined?n.active:n.frozen!==undefined?!n.frozen:!0,i.kinematic=u,i.fixedRotation=u||(n.fixedRotation!==undefined?n.fixedRotation:!1),i.inverseInertiaLocal=i.fixedRotation?t.v3BuildZero():t.v3Build(1/f[0],1/f[1],1/f[2]),i.inverseInertia=t.m33BuildIdentity(),i.mass=a,i.inverseMass=u?0:1/i.mass,i.collisionObject=!1,i.permitSleep=n.permitSleep!==undefined?n.permitSleep:!u,i.sweepFrozen=u,n.onPreSolveContact||n.onAddedContacts||n.onProcessedContacts||n.onRemovedContacts?i.contactCallbacks=new X(n,o):i.contactCallbacks=null,r},e.version=1,e}(),$=function(){function e(){}return e.prototype.preStep=function(e,t){},e.prototype.applyCachedImpulses=function(){},e.prototype.computeAndApplyImpulses=function(){},e.create=function(t,n){var r=new e;return r.world=null,r.userData=null,O(r,n),r.type=t,r},e.version=1,e}(),J=function(t,n){t.userData=n.userData;var r=t._private;r.world=null,r.bodyA=n.bodyA._private,Object.defineProperty(t,"bodyA",{value:n.bodyA,enumerable:!0}),r.bodyB=n.bodyB?n.bodyB._private:null,Object.defineProperty(t,"bodyB",{value:n.bodyB,enumerable:!0}),r.active=n.active!==undefined?n.active:!0,Object.defineProperty(t,"active",{get:function(){return this._private.active},set:function(t){var n=this._private;if(t===n.active)n.world&&t&&(n.wakeTimeStamp=n.world.timeStamp);else if(n.world)if(t)n.world.wakeConstraint(n);else{var r=n.world.activeConstraints;r[r.indexOf(n)]=r[r.length-1],r.pop(),n.active=!1}else n.active=t},enumerable:!0})},K=function(){function e(){}return e.create=function(n){var r=new e,i=new Q;r._private=i,J(r,n);var s=i.data;s[0]=n.pivotA[0],s[1]=n.pivotA[1],s[2]=n.pivotA[2],Object.defineProperty(r,"pivotA",{get:function(){var n=this._private.data;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private.data;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0});if(n.pivotB)s[3]=n.pivotB[0],s[4]=n.pivotB[1],s[5]=n.pivotB[2];else{var o=t.m43TransformPoint(i.bodyA.transform,n.pivotA);s[3]=o[0],s[4]=o[1],s[5]=o[2]}return Object.defineProperty(r,"pivotB",{get:function(){var n=this._private.data;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private.data;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),s[30]=n.force!==undefined?n.force:.3,Object.defineProperty(r,"force",{get:function(){return this._private.data[30]},set:function(t){this._private.data[30]=t},enumerable:!0}),s[31]=n.damping!==undefined?n.damping:1,Object.defineProperty(r,"damping",{get:function(){return this._private.data[31]},set:function(t){this._private.data[31]=t},enumerable:!0}),s[32]=n.impulseClamp!==undefined?n.impulseClamp:0,Object.defineProperty(r,"impulseClamp",{get:function(){return this._private.data[32]},set:function(t){this._private.data[32]=t},enumerable:!0}),r},e.version=1,e}();K.prototype.type="POINT2POINT";var Q=function(){function e(){return this.bodyA=null,this.bodyB=null,this.data=new Float32Array(46),this}return e.prototype.preStep=function(e,t){var n=this.bodyA,r=this.bodyB,i=this.data,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5],c=n.transform,h=i[6]=c[0]*s+c[3]*o+c[6]*u,p=i[7]=c[1]*s+c[4]*o+c[7]*u,d=i[8]=c[2]*s+c[5]*o+c[8]*u,v,m,g,y;r&&(y=r.transform,v=i[9]=y[0]*a+y[3]*f+y[6]*l,m=i[10]=y[1]*a+y[4]*f+y[7]*l,g=i[11]=y[2]*a+y[5]*f+y[8]*l);var b=n.inverseInertia;i[12]=-d*b[3]+p*b[6],i[13]=-d*b[4]+p*b[7],i[14]=-d*b[5]+p*b[8],i[15]=d*b[0]+ -h*b[6],i[16]=d*b[1]+ -h*b[7],i[17]=d*b[2]+ -h*b[8],i[18]=-p*b[0]+h*b[3],i[19]=-p*b[1]+h*b[4],i[20]=-p*b[2]+h*b[5];var w=n.inverseMass+(r?r.inverseMass:0),E=w+i[13]*-d+i[14]*p,S=w+i[15]*d+i[17]*-h,x=w+i[18]*-p+i[19]*h,T=i[12]*d+i[14]*-h,N=i[12]*-p+i[13]*h,C=i[15]*-p+i[16]*h;r&&(b=r.inverseInertia,i[21]=-g*b[3]+m*b[6],i[22]=-g*b[4]+m*b[7],i[23]=-g*b[5]+m*b[8],i[24]=g*b[0]+ -v*b[6],i[25]=g*b[1]+ -v*b[7],i[26]=g*b[2]+ -v*b[8],i[27]=-m*b[0]+v*b[3],i[28]=-m*b[1]+v*b[4],i[29]=-m*b[2]+v*b[5],E+=i[22]*-g+i[23]*m,S+=i[24]*g+i[26]*-v,x+=i[27]*-m+i[28]*v,T+=i[21]*g+i[23]*-v,N+=i[21]*-m+i[22]*v,C+=i[24]*-m+i[25]*v);var k=i[30],L=2/t*k*i[31]/(1-k),A=k/(L*L),O=1/(1+A);i[33]=1-A*O;var M=S*x-C*C,_=N*C-T*x,D=T*C-N*S,P=O/(E*M+T*_+N*D);i[34]=P*M,i[35]=P*_,i[36]=P*D,i[37]=P*(E*x-N*N),i[38]=P*(T*N-E*C),i[39]=P*(E*S-T*T);var H=h+c[9],B=p+c[10],j=d+c[11];r?(H-=v+y[9],B-=m+y[10],j-=g+y[11]):(H-=a,B-=f,j-=l);var F=-k/t;i[43]=H*F,i[44]=B*F,i[45]=j*F,i[40]*=e,i[41]*=e,i[42]*=e},e.prototype.applyCachedImpulses=function(){var e=this.data,t=e[40],n=e[41],r=e[42],i=this.bodyA,s=i.velocity,o=i.inverseMass;s[0]+=t*o,s[1]+=n*o,s[2]+=r*o,s[3]-=e[12]*t+e[15]*n+e[18]*r,s[4]-=e[13]*t+e[16]*n+e[19]*r,s[5]-=e[14]*t+e[17]*n+e[20]*r;var u=this.bodyB;u&&(s=u.velocity,o=u.inverseMass,s[0]-=t*o,s[1]-=n*o,s[2]-=r*o,s[3]+=e[21]*t+e[24]*n+e[27]*r,s[4]+=e[22]*t+e[25]*n+e[28]*r,s[5]+=e[23]*t+e[26]*n+e[29]*r)},e.prototype.computeAndApplyImpulses=function(){var e=this.bodyA,t=this.bodyB,n=this.data,r=n[40],i=n[41],s=n[42],o=e.velocity,u=n[43]-(o[0]+o[4]*n[8]-o[5]*n[7]),a=n[44]-(o[1]+o[5]*n[6]-o[3]*n[8]),f=n[45]-(o[2]+o[3]*n[7]-o[4]*n[6]),l;t&&(l=t.velocity,u+=l[0]+l[4]*n[11]-l[5]*n[10],a+=l[1]+l[5]*n[9]-l[3]*n[11],f+=l[2]+l[3]*n[10]-l[4]*n[9]);var c=n[33];r=r*c+n[34]*u+n[35]*a+n[36]*f,i=i*c+n[35]*u+n[37]*a+n[38]*f,s=s*c+n[36]*u+n[38]*a+n[39]*f;var h=n[32];if(h!==0){var p=r*r+i*i+s*s;p>h*h&&(p=h/Math.sqrt(p),r*=p,i*=p,s*=p)}var d=r-n[40],v=i-n[41],m=s-n[42];n[40]=r,n[41]=i,n[42]=s;var g=e.inverseMass;o[0]+=d*g,o[1]+=v*g,o[2]+=m*g,o[3]-=n[12]*d+n[15]*v+n[18]*m,o[4]-=n[13]*d+n[16]*v+n[19]*m,o[5]-=n[14]*d+n[17]*v+n[20]*m,t&&(g=t.inverseMass,l[0]-=d*g,l[1]-=v*g,l[2]-=m*g,l[3]+=n[21]*d+n[24]*v+n[27]*m,l[4]+=n[22]*d+n[25]*v+n[28]*m,l[5]+=n[23]*d+n[26]*v+n[29]*m)},e}(),G=function(){function e(){}return e.prototype.jump=function(){var e=this._private,t=e.rigidBody._private,n=t.world;n&&(t.velocity[1]=Math.sqrt(-2*(this.maxJumpHeight-this.stepHeight)*n.gravity[1]),t.transform[10]+=this.stepHeight,n.wakeBody(t))},e.prototype.calculateExtents=function(e){this._private.rigidBody.calculateExtents(e)},e.prototype.calculateTransform=function(e,t){this._private.rigidBody.calculateTransform(e,t)},e.create=function(n){var r=new e,i=new Y;r._private=i,r.userData=n.userData!==undefined?n.userData:null,Object.defineProperty(r,"crouch",{get:function(){return this._private.crouch},set:function(t){var n=this._private;if(!n.dead&&t!==n.crouch){var r=n.rigidBody._private,i=r.shape;n.crouch=t,t?(i.halfHeight=this.crouchHeight*.5-this.radius,r.transform[10]-=(this.height-this.crouchHeight)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.crouchHeight)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"dead",{get:function(){return this._private.dead},set:function(t){var n=this._private;if(n.dead!==t){var r=n.rigidBody._private,i=r.shape;n.dead=t,t?(i.halfHeight=0,r.transform[10]-=(this.height-this.radius)*.5):(i.halfHeight=this.height*.5-this.radius,r.transform[10]+=(this.height-this.radius)*.5),r.world&&r.world.wakeBody(r)}},enumerable:!0}),Object.defineProperty(r,"height",{value:n.height,enumerable:!0}),Object.defineProperty(r,"radius",{value:n.radius,enumerable:!0}),Object.defineProperty(r,"stepHeight",{value:n.stepHeight!==undefined?n.stepHeight:.35,enumerable:!0}),r.maxJumpHeight=n.maxJumpHeight!==undefined?n.maxJumpHeight:1,Object.defineProperty(r,"crouchHeight",{value:n.crouchHeight!==undefined?n.crouchHeight:.5*n.height,enumerable:!0}),Object.defineProperty(r,"onGround",{get:function(){var t=this._private,n=t.rigidBody._private;if(n.world){var r=n.transform,i=t.start,s=t.end;i[9]=r[9],i[10]=r[10],i[11]=r[11],s[9]=r[9],s[10]=r[10]-this.stepHeight*.5,s[11]=r[11];var o=n.world.convexSweepTest({shape:n.shape._public,from:i,to:s,group:ft.prototype.FILTER_CHARACTER},t.onGroundConvexCallback);return o!==null}return!1},enumerable:!0}),Object.defineProperty(r,"position",{get:function(){var n=this._private.rigidBody;return t.m43Pos(n._private.transform)},set:function(t){var n=this._private.rigidBody,r=n._private.transform;r[9]=t[0],r[10]=t[1],r[11]=t[2],n.transform=n._private.transform,n.active=!0},enumerable:!0}),Object.defineProperty(r,"velocity",{get:function(){var t=this._private.rigidBody;return t.linearVelocity},set:function(t){var n=this._private.rigidBody;n.linearVelocity=t,n.active=!0},enumerable:!0});var s=n.group!==undefined?n.group:ft.prototype.FILTER_CHARACTER;Object.defineProperty(r,"group",{value:s,enumerable:!0});var o=n.mask!==undefined?n.mask:ft.prototype.FILTER_ALL;Object.defineProperty(r,"mask",{value:o,enumerable:!0});var u=D.create({radius:r.radius,height:2*(r.height*.5-r.radius),margin:0}),a=V.create({shape:u,mass:n.mass,transform:n.transform,linearVelocity:n.velocity,group:s,mask:o,friction:n.friction,restitution:n.restitution,linearDamping:n.linearDamping,angularDamping:n.angularDamping,fixedRotation:!0});return i.rigidBody=a,a._private._public=r,r},e.version=1,e}(),Y=function(){function e(){return this.crouch=!1,this.dead=!1,this.start=t.m43BuildIdentity(),this.end=t.m43BuildIdentity(),this.rigidBody=null,this}return e.prototype.onGroundConvexCallback=function(e){return e.hitNormal[1]>=.26},e.version=1,e}(),Z=function(){function e(){}return e.prototype.removeVertex=function(e){this.numVertices-=1;var t=this.simplex,n=e*9,r=this.numVertices*9;t[n]=t[r],t[n+1]=t[r+1],t[n+2]=t[r+2],t[n+3]=t[r+3],t[n+4]=t[r+4],t[n+5]=t[r+5],t[n+6]=t[r+6],t[n+7]=t[r+7],t[n+8]=t[r+8]},e.prototype.reduceVertices=function(e){this.numVertices>=4&&e[3]===0&&(this.numVertices-=1);var t=this.simplex,n;this.numVertices>=3&&e[2]===0&&(this.numVertices-=1,n=this.numVertices*9,t[18]=t[n],t[19]=t[n+1],t[20]=t[n+2],t[21]=t[n+3],t[22]=t[n+4],t[23]=t[n+5],t[24]=t[n+6],t[25]=t[n+7],t[26]=t[n+8]),this.numVertices>=2&&e[1]===0&&(this.numVertices-=1,n=this.numVertices*9,t[9]=t[n],t[10]=t[n+1],t[11]=t[n+2],t[12]=t[n+3],t[13]=t[n+4],t[14]=t[n+5],t[15]=t[n+6],t[16]=t[n+7],t[17]=t[n+8]),this.numVertices>=1&&e[0]===0&&(this.numVertices-=1,n=this.numVertices*9,t[0]=t[n],t[1]=t[n+1],t[2]=t[n+2],t[3]=t[n+3],t[4]=t[n+4],t[5]=t[n+5],t[6]=t[n+6],t[7]=t[n+7],t[8]=t[n+8])},e.prototype.updateClosestPoints=function(){var e=this.numVertices;if(e===0)return!1;var t=this.simplex,n=this.closest,r;if(e===1)return n[0]=t[3],n[1]=t[4],n[2]=t[5],n[3]=t[6],n[4]=t[7],n[5]=t[8],!0;var i=t[0],s=t[1],o=t[2],u=t[9],a=t[10],f=t[11];if(e===2){var l=i-u,c=s-a,h=o-f,p=i*l+s*c+o*h;if(p>0){var d=l*l+c*c+h*h;if(p<d){p/=d;var v=1-p;return n[0]=t[3]*v+t[12]*p,n[1]=t[4]*v+t[13]*p,n[2]=t[5]*v+t[14]*p,n[3]=t[6]*v+t[15]*p,n[4]=t[7]*v+t[16]*p,n[5]=t[8]*v+t[17]*p,!0}this.removeVertex(0)}else this.removeVertex(1);for(r=0;r<6;r+=1)n[r]=t[r+3];return!0}var m=this.cachedCoords,g,y,b;if(e===3)return this.closestPointTriangle(0,9,18,m),this.reduceVertices(m),g=m[0],y=m[1],b=m[2],n[0]=g*t[3]+y*t[12]+b*t[21],n[1]=g*t[4]+y*t[13]+b*t[22],n[2]=g*t[5]+y*t[14]+b*t[23],n[3]=g*t[6]+y*t[15]+b*t[24],n[4]=g*t[7]+y*t[16]+b*t[25],n[5]=g*t[8]+y*t[17]+b*t[26],!0;if(e===4){var w=this.closestPointTetrahedron(m);if(w){this.reduceVertices(m),g=m[0],y=m[1],b=m[2];var E=m[3];return n[0]=g*t[3]+y*t[12]+b*t[21]+E*t[30],n[1]=g*t[4]+y*t[13]+b*t[22]+E*t[31],n[2]=g*t[5]+y*t[14]+b*t[23]+E*t[32],n[3]=g*t[6]+y*t[15]+b*t[24]+E*t[33],n[4]=g*t[7]+y*t[16]+b*t[25]+E*t[34],n[5]=g*t[8]+y*t[17]+b*t[26]+E*t[35],!0}return!1}return!1},e.prototype.closestPointTetrahedron=function(e){var t=this.simplex,n=t[0],r=t[1],i=t[2],s=t[9],o=t[10],u=t[11],a=t[18],f=t[19],l=t[20],c=t[27],h=t[28],p=t[29],d=s-n,v=o-r,m=u-i,g=a-n,y=f-r,b=l-i,w=c-n,E=h-r,S=p-i,x=a-s,T=f-o,N=l-u,C=c-s,k=h-o,L=p-u,A,O,M,_,D;A=v*b-m*y,O=m*g-d*b,M=d*y-v*g,_=w*A+E*O+S*M,D=-(n*A+r*O+i*M);var P=D*_<=0;A=y*S-b*E,O=b*w-g*S,M=g*E-y*w,_=d*A+v*O+m*M,D=-(n*A+r*O+i*M);var H=D*_<=0;A=E*m-S*v,O=S*d-w*m,M=w*v-E*d,_=g*A+y*O+b*M,D=-(n*A+r*O+i*M);var B=D*_<=0;A=k*N-L*T,O=L*x-C*N,M=C*T-k*x,_=d*A+v*O+m*M,D=s*A+o*O+u*M;var j=D*_<=0;e[0]=e[1]=e[2]=e[3]=0;if(!P&&!H&&!B&&!j)return!1;var F=this.tempCoords,I=Number.MAX_VALUE,q;return P&&(q=this.closestPointTriangle(0,9,18,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=F[1],e[2]=F[2],e[3]=0)),H&&(q=this.closestPointTriangle(0,18,27,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=0,e[2]=F[1],e[3]=F[2])),B&&(q=this.closestPointTriangle(0,27,9,F,!0),q<I&&(I=q,e[0]=F[0],e[1]=F[2],e[2]=0,e[3]=F[1])),j&&(q=this.closestPointTriangle(9,27,18,F,!0),q<I&&(I=q,e[0]=0,e[1]=F[0],e[2]=F[2],e[3]=F[1])),!0},e.prototype.closestPointTriangle=function(e,t,n,r,i){var s=this.simplex,o=s[e],u=s[e+1],a=s[e+2],f=s[t],l=s[t+1],c=s[t+2],h=s[n],p=s[n+1],d=s[n+2],v=o-f,m=u-l,g=a-c,y=o-h,b=u-p,w=a-d,E=o*v+u*m+a*g,S=o*y+u*b+a*w;if(E<=0&&S<=0)return r[0]=1,r[1]=r[2]=0,i?o*o+u*u+a*a:undefined;var x=f*v+l*m+c*g,T=f*y+l*b+c*w;if(x>=0&&T<=x)return r[1]=1,r[0]=r[2]=0,i?f*f+l*l+c*c:undefined;var N,C,k,L,A=E*T-x*S;if(A<=0&&E>=0&&x<=0)return N=E/(E-x),r[0]=1-N,r[1]=N,r[2]=0,i?(C=o-N*v,k=u-N*m,L=a-N*g,C*C+k*k+L*L):undefined;var O=h*v+p*m+d*g,M=h*y+p*b+d*w;if(M>=0&&O<=M)return r[0]=r[1]=0,r[2]=1,i?h*h+p*p+d*d:undefined;var _=O*S-E*M;if(_<=0&&S>=0&&M<=0)return N=S/(S-M),r[0]=1-N,r[1]=0,r[2]=N,i?(C=o-N*y,k=u-N*b,L=a-N*w,C*C+k*k+L*L):undefined;var D=x*M-O*T;if(D<=0&&T-x>=0&&O-M>=0)return N=(T-x)/(T-x+(O-M)),r[0]=0,r[1]=1-N,r[2]=N,i?(C=f*(1-N)+h*N,k=l*(1-N)+p*N,L=c*(1-N)+d*N,C*C+k*k+L*L):undefined;var P=1/(D+_+A);N=_*P;var H=A*P;return r[0]=1-N-H,r[1]=N,r[2]=H,i?(C=o-v*N-y*H,k=u-m*N-b*H,L=a-g*N-w*H,C*C+k*k+L*L):undefined},e.prototype.evaluate=function(e,t,n){var r=e.axis,i=e.shapeA,s=e.shapeB;this.numVertices=0;var o,u,a;o=u=a=Number.MAX_VALUE;var f=0,l=100,c=!1,h=Number.MAX_VALUE,p=t[0],d=t[1],v=t[2],m=t[3],g=t[4],y=t[5],b=t[6],w=t[7],E=t[8],S=t[9],x=t[10],T=t[11],N=n[0],C=n[1],k=n[2],L=n[3],O=n[4],M=n[5],_=n[6],D=n[7],P=n[8],H=n[9],B=n[10],j=n[11],F=r[0],I=r[1],q=r[2],R,U=e.closestA,z=e.closestB,W=this.closest,X=this.simplex,V=1e-4;for(;;){f+=1,U[0]=-(p*F+d*I+v*q),U[1]=-(m*F+g*I+y*q),U[2]=-(b*F+w*I+E*q),z[0]=N*F+C*I+k*q,z[1]=L*F+O*I+M*q,z[2]=_*F+D*I+P*q,i.localSupportWithoutMargin(U,U),s.localSupportWithoutMargin(z,z);var $=U[0],J=U[1],K=U[2],Q=U[0]=p*$+m*J+b*K+S,G=U[1]=d*$+g*J+w*K+x,Y=U[2]=v*$+y*J+E*K+T;$=z[0],J=z[1],K=z[2];var Z=z[0]=N*$+L*J+_*K+H,et=z[1]=C*$+O*J+D*K+B,tt=z[2]=k*$+M*J+P*K+j,nt=Q-Z,rt=G-et,it=Y-tt,st=!1,ot=this.numVertices*9,ut;for(ut=0;ut<ot;ut+=9)$=nt-X[ut],J=rt-X[ut+1],K=it-X[ut+2],$*$+J*J+K*K<V&&(st=!0);st||($=nt-o,J=
rt-u,K=it-a,st=$*$+J*J+K*K<V);if(st){c=!0;break}var at=F*nt+I*rt+q*it;if(h-at<=h*A.GJK_FRACTIONAL_THRESHOLD){c=!0;break}o=X[ot]=nt,u=X[ot+1]=rt,a=X[ot+2]=it,X[ot+3]=Q,X[ot+4]=G,X[ot+5]=Y,X[ot+6]=Z,X[ot+7]=et,X[ot+8]=tt,this.numVertices+=1;if(!this.updateClosestPoints()){c=!1;break}$=W[0]-W[3],J=W[1]-W[4],K=W[2]-W[5],R=$*$+J*J+K*K;if(R<=A.GJK_EPA_DISTANCE_THRESHOLD){c=!0;break}F=$,I=J,q=K;var ft=h;h=R;if(ft-h<=A.GJK_FRACTIONAL_THRESHOLD*ft){c=!0;break}if(f>=l){c=!0;break}if(this.numVertices===4)break}R=F*F+I*I+q*q;if(R<A.DONT_NORMALIZE_THRESHOLD)return r[0]=F,r[1]=I,r[2]=q,undefined;var lt=1/Math.sqrt(R);return r[0]=F*lt,r[1]=I*lt,r[2]=q*lt,c?(U[0]=W[0],U[1]=W[1],U[2]=W[2],z[0]=W[3],z[1]=W[4],z[2]=W[5],Math.sqrt(h)):undefined},e.create=function(){var t=new e;return t.simplex=new Float32Array(36),t.numVertices=0,t.closest=new Float32Array(6),t.cachedCoords=new Float32Array(4),t.tempCoords=new Float32Array(4),t},e.version=1,e}(),et=function(){function e(){}return e.prototype.bind=function(e,t,n,r){e.edge[t]=r,e.adjFace[t]=n,n.edge[r]=t,n.adjFace[r]=e},e.prototype.append=function(e,t){t.leaf0=null,t.leaf1=e.root,e.root&&(e.root.leaf0=t),e.root=t,e.count+=1},e.prototype.remove=function(e,t){var n=t.leaf0,r=t.leaf1;r&&(r.leaf0=n),n&&(n.leaf1=r),t===e.root&&(e.root=r),e.count-=1},e.prototype.findBest=function(){var e=this.hull.root,t=e.distance*e.distance,n;for(n=e.leaf1;n!==null;n=n.leaf1){var r=n.distance*n.distance;r<t&&(e=n,t=r)}return e},e.prototype.getEdgeDistance=function(e,t,n){var r=this.vertex_store,i=r[t],s=r[t+1],o=r[t+2],u=r[n],a=r[n+1],f=r[n+2],l=u-i,c=a-s,h=f-o,p=e.normal,d=p[0],v=p[1],m=p[2],g=c*m-h*v,y=h*d-l*m,b=l*v-c*d,w=i*g+s*y+o*b;if(w<=0){var E=l*l+c*c+h*h,S=i*l+s*c+o*h,x=u*l+a*h+f*h;if(S>=0)return Math.sqrt(i*i+s*s+o*o);if(x<=0)return Math.sqrt(u*u+a*a+f*f);var T=i*u+s*a+o*f,N=(i*i+s*s+o*o)*(u*u+a*a+f*f)-T*T;return N>=0?Math.sqrt(N/E):0}return undefined},e.prototype.buildNewFace=function(e,t,n,r){var i=this.stock.root;if(i===null)return null;i.pass=0,i.vertex[0]=e,i.vertex[1]=t,i.vertex[2]=n;var s=this.vertex_store,o=s[e],u=s[e+1],a=s[e+2],f=s[t],l=s[t+1],c=s[t+2],h=s[n],p=s[n+1],d=s[n+2],v=f-o,m=l-u,g=c-a,y=h-o,b=p-u,w=d-a,E=i.normal,S=E[0]=m*w-g*b,x=E[1]=g*y-v*w,T=E[2]=v*b-m*y,N=S*S+x*x+T*T;if(N>A.DONT_NORMALIZE_THRESHOLD){i.distance=this.getEdgeDistance(i,e,t),i.distance===undefined&&(i.distance=this.getEdgeDistance(i,t,n)),i.distance===undefined&&(i.distance=this.getEdgeDistance(i,n,e));var C=1/Math.sqrt(N);i.distance===undefined&&(i.distance=(o*S+u*x+a*T)*C);if(r||i.distance>=-0.000001)return E[0]*=C,E[1]*=C,E[2]*=C,this.remove(this.stock,i),this.append(this.hull,i),i}return null},e.prototype.expandFace=function(e,t,n,r,i){if(n.pass!==e){var s=n.normal,o=s[0],u=s[1],a=s[2],f=this.vertex_store,l=f[t],c=f[t+1],h=f[t+2],p=(r+1)%3;if(o*l+u*c+a*h-n.distance<-0.000001){var d=this.buildNewFace(n.vertex[p],n.vertex[r],t,!1);if(d)return this.bind(d,0,n,r),i.cf?this.bind(i.cf,1,d,2):i.ff=d,i.cf=d,i.numFaces+=1,!0}else{var v=(r+2)%3;n.pass=e;if(this.expandFace(e,t,n.adjFace[p],n.edge[p],i)&&this.expandFace(e,t,n.adjFace[v],n.edge[v],i))return this.remove(this.hull,n),this.append(this.stock,n),!0}}return!1},e.prototype.evaluate=function(e,n,r,i){var s=n.shapeA,o=n.shapeB,u=this.hull,a=this.stock;while(u.root){var f=u.root;this.remove(u,f),this.append(a,f)}var l=e[27],c=e[28],h=e[29],p,d,v=e[0]-l,m=e[1]-c,g=e[2]-h,y=e[9]-l,b=e[10]-c,w=e[11]-h,E=e[18]-l,S=e[19]-c,x=e[20]-h;v*(b*x-w*S)+m*(w*E-y*x)+g*(y*S-b*E)<0?(p=9,d=0):(p=0,d=9);var T=this.vertex_store,N;for(N=0;N<9;N+=1)T[N]=e[p+N],T[9+N]=e[d+N],T[18+N]=e[18+N],T[27+N]=e[27+N];var C=this.buildNewFace(0,9,18,!0),k=this.buildNewFace(9,0,27,!0),L=this.buildNewFace(18,9,27,!0),O=this.buildNewFace(0,18,27,!0),M=36;if(u.count!==4)return t.v3Build(e[3],e[4],e[5],n.closestA),t.v3Build(e[6],e[7],e[8],n.closestB),0;var _=this.findBest(),D=0,P=0;this.bind(C,0,k,0),this.bind(C,1,L,0),this.bind(C,2,O,0),this.bind(k,1,O,2),this.bind(k,2,L,1),this.bind(L,2,O,1);var H=r[0],B=r[1],j=r[2],F=r[3],I=r[4],q=r[5],R=r[6],U=r[7],z=r[8],W=r[9],X=r[10],V=r[11],$=i[0],J=i[1],K=i[2],Q=i[3],G=i[4],Y=i[5],Z=i[6],et=i[7],tt=i[8],nt=i[9],rt=i[10],it=i[11],st=n.closestA,ot=n.closestB,ut=this.horizon,at,ft,lt,ct;for(;P<100;P+=1){if(M>=this.MAX_VERTICES*9)break;ut.cf=ut.ff=null,ut.numFaces=0;var ht=M;M+=9,D+=1,_.pass=D,at=_.normal,ft=at[0],lt=at[1],ct=at[2],st[0]=H*ft+B*lt+j*ct,st[1]=F*ft+I*lt+q*ct,st[2]=R*ft+U*lt+z*ct,ot[0]=-($*ft+J*lt+K*ct),ot[1]=-(Q*ft+G*lt+Y*ct),ot[2]=-(Z*ft+et*lt+tt*ct),s.localSupportWithoutMargin(st,st),o.localSupportWithoutMargin(ot,ot),l=st[0],c=st[1],h=st[2],v=H*l+F*c+R*h+W,m=B*l+I*c+U*h+X,g=j*l+q*c+z*h+V,l=ot[0],c=ot[1],h=ot[2],y=$*l+Q*c+Z*h+nt,b=J*l+G*c+et*h+rt,w=K*l+Y*c+tt*h+it;var pt,dt,vt;T[ht+3]=v,T[ht+4]=m,T[ht+5]=g,T[ht+6]=y,T[ht+7]=b,T[ht+8]=w,T[ht]=pt=v-y,T[ht+1]=dt=m-b,T[ht+2]=vt=g-w;var mt=ft*pt+lt*dt+ct*vt-_.distance;if(!(mt>A.GJK_EPA_DISTANCE_THRESHOLD))break;var gt,yt=!0;for(gt=0;gt<3&&yt;gt+=1)yt=yt&&this.expandFace(D,ht,_.adjFace[gt],_.edge[gt],ut);if(!(yt&&ut.numFaces>=3))break;this.bind(ut.cf,1,ut.ff,2),this.remove(u,_),this.append(a,_),_=this.findBest()}at=_.normal,ft=at[0],lt=at[1],ct=at[2];var bt=_.distance,wt=ft*bt,Et=lt*bt,St=ct*bt;E=_.vertex[0],S=_.vertex[1],x=_.vertex[2];var xt=T[E]-wt,Tt=T[E+1]-Et,Nt=T[E+2]-St,Ct=T[S]-wt,kt=T[S+1]-Et,Lt=T[S+2]-St,At=T[x]-wt,Ot=T[x+1]-Et,Mt=T[x+2]-St;l=kt*Mt-Lt*Ot,c=Lt*At-Ct*Mt,h=Ct*Ot-kt*At;var _t=Math.sqrt(l*l+c*c+h*h);l=Ot*Nt-Mt*Tt,c=Mt*xt-At*Nt,h=At*Tt-Ot*xt;var Dt=Math.sqrt(l*l+c*c+h*h);l=Tt*Lt-Nt*kt,c=Nt*Ct-xt*Lt,h=xt*kt-Tt*Ct;var Pt=Math.sqrt(l*l+c*c+h*h),Ht=1/(_t+Dt+Pt);_t*=Ht,Dt*=Ht,Pt*=Ht,st[0]=st[1]=st[2]=0,ot[0]=ot[1]=ot[2]=0;for(N=0;N<3;N+=1)st[N]+=_t*T[E+3+N]+Dt*T[S+3+N]+Pt*T[x+3+N],ot[N]+=_t*T[E+6+N]+Dt*T[S+6+N]+Pt*T[x+6+N];var Bt=n.axis;return Bt[0]=-ft,Bt[1]=-lt,Bt[2]=-ct,-_.distance},e.create=function(){var n=new e,r;n.vertex_store=new Float32Array(n.MAX_VERTICES*9);var i=[];for(r=0;r<n.MAX_FACES;r+=1)i[r]={normal:t.v3BuildZero(),distance:0,vertex:new Int16Array(3),adjFace:[null,null,null],edge:new Int16Array(3),leaf0:null,leaf1:null,pass:0};n.hull={root:null,count:0},n.stock={root:null,count:0},n.horizon={cf:null,ff:null,numFaces:0};for(r=0;r<n.MAX_FACES;r+=1)n.append(n.stock,i[n.MAX_FACES-r-1]);return n},e.version=1,e}();et.prototype.MAX_VERTICES=64,et.prototype.MAX_FACES=128;var tt=function(){function e(){return this._private=null,this}return e.create=function(){var n=new e;return Object.defineProperty(n,"localPointOnA",{get:function(){var n=this._private;return t.v3Build(n[0],n[1],n[2])},set:function(t){var n=this._private;n[0]=t[0],n[1]=t[1],n[2]=t[2]},enumerable:!0}),Object.defineProperty(n,"localPointOnB",{get:function(){var n=this._private;return t.v3Build(n[3],n[4],n[5])},set:function(t){var n=this._private;n[3]=t[0],n[4]=t[1],n[5]=t[2]},enumerable:!0}),Object.defineProperty(n,"worldNormalOnB",{get:function(){var n=this._private;return t.v3Build(n[12],n[13],n[14])},set:function(t){var n=this._private;n[12]=t[0],n[13]=t[1],n[14]=t[2]},enumerable:!0}),Object.defineProperty(n,"added",{get:function(){var t=this._private;return 0<t[51]},enumerable:!0}),Object.defineProperty(n,"distance",{get:function(){var t=this._private;return t[21]},enumerable:!0}),n},e}(),nt={contactPool:[],contactPoolSize:0,contactPoolAllocationSize:128,publicContacts:[tt.create(),tt.create(),tt.create()],callbackContacts:[],allocate:function(){var t=this.contactPool;if(this.contactPoolSize===0){var n=this.contactPoolAllocationSize,r=new Float32Array(52*n),i=r.length,s;for(s=0;s<n;s+=1)i-=52,t[s]=r.subarray(i,i+52);this.contactPoolSize=n}this.contactPoolSize-=1;var o=t[this.contactPoolSize];return o[51]=1,o},deallocate:function(t){this.contactPool[this.contactPoolSize]=t,this.contactPoolSize+=1,t[40]=0}},rt=function(){function e(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.friction=0,this.restitution=0,this.contacts=[],this.activeContacts=[],this.active=!0,this.skipDiscreteCollisions=!1,this.contactFlags=0,this.trigger=!1,this}return e.prototype.insertContact=function(e,t,n,r,i){var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a<A.DONT_NORMALIZE_THRESHOLD)return;var f=1/Math.sqrt(a);s*=f,o*=f,u*=f;var l=this.objectA,c=this.objectB,h=l.transform,p=c.transform,d=e[0]-h[9],v=e[1]-h[10],m=e[2]-h[11],g=h[0]*d+h[1]*v+h[2]*m,y=h[3]*d+h[4]*v+h[5]*m,b=h[6]*d+h[7]*v+h[8]*m,w=0,E=0,S=Number.MAX_VALUE,x=this.contacts,T,N,C;while(E<x.length){var k=x[E];if(!i&&s*k[12]+o*k[13]+u*k[14]<.9){x[E]=x[x.length-1],x.pop(),nt.deallocate(k),this.contactFlags|=4;continue}T=g-k[0],N=y-k[1],C=b-k[2];var L=T*T+N*N+C*C;if(L<A.CONTACT_EQUAL_SQ_SEPERATION){w=k[40],x[E]=x[x.length-1],x.pop(),nt.deallocate(k),this.contactFlags|=4,S=L;continue}L<A.CONTACT_INHERIT_SQ_SEPERATION&&L<S&&(w=k[40],S=L),E+=1}var O=nt.allocate();O[0]=g,O[1]=y,O[2]=b,O[6]=d,O[7]=v,O[8]=m,O[9]=d=t[0]-p[9],O[10]=v=t[1]-p[10],O[11]=m=t[2]-p[11],O[3]=p[0]*d+p[1]*v+p[2]*m,O[4]=p[3]*d+p[4]*v+p[5]*m,O[5]=p[6]*d+p[7]*v+p[8]*m,O[21]=r,O[12]=s,O[13]=o,O[14]=u;var M,_;a=s*s+u*u,a<A.DONT_NORMALIZE_THRESHOLD?(O[15]=M=1,O[16]=0,O[17]=_=0):(f=1/Math.sqrt(a),O[15]=M=-u*f,O[16]=0,O[17]=_=s*f),O[18]=o*_,O[19]=u*M-s*_,O[20]=-(o*M),O[40]=w;var D,P;D=l.contactCallbacks,null!==D&&0!==(D.mask&c.group)&&(D.onPreSolveContact&&(P=nt.publicContacts[0],P._private=O,D.onPreSolveContact(l._public,c._public,P)),!D.added&&D.deferred&&(D.added=!0,l.world.contactCallbackObjects.push(l)),D.trigger&&(this.trigger=!0,l.sweepFrozen=!1,c.sweepFrozen=!1)),D=c.contactCallbacks,null!==D&&0!==(D.mask&l.group)&&(D.onPreSolveContact&&(P=nt.publicContacts[0],P._private=O,D.onPreSolveContact(l._public,c._public,P)),!D.added&&D.deferred&&(D.added=!0,c.world.contactCallbackObjects.push(c)),D.trigger&&(this.trigger=!0,l.sweepFrozen=!1,c.sweepFrozen=!1)),this.contactFlags|=1,x.push(O);if(x.length===4){var H=x[0][21],B=0;for(E=1;E<4;E+=1)O=x[E],O[21]<H&&(H=O[21],B=E);var j,F=-Number.MAX_VALUE,I=x[0],q=x[1],R=x[2],U=x[3],z=I[6]+I[9],W=I[7]+I[10],X=I[8]+I[11],V=q[6]+q[9],$=q[7]+q[10],J=q[8]+q[11],K=R[6]+R[9],Q=R[7]+R[10],G=R[8]+R[11];T=U[6]+U[9],N=U[7]+U[10],C=U[8]+U[11];var Y=V-z,Z=$-W,et=J-X,tt=K-z,rt=Q-W,it=G-X,st=T-z,ot=N-W,ut=C-X,at,ft,lt,ct;B!==1&&(at=rt*ut-it*ot,ft=it*st-tt*ut,lt=tt*ot-rt*st,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=1)),B!==2&&(at=Z*ut-et*ot,ft=et*st-Y*ut,lt=Y*ot-Z*st,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=2)),B!==3&&(at=Z*it-et*rt,ft=et*tt-Y*it,lt=Y*rt-Z*tt,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=3));if(B!==0){var ht=K-V,pt=Q-$,dt=G-J,vt=T-V,mt=N-$,gt=C-J;at=pt*gt-dt*mt,ft=dt*vt-ht*gt,lt=ht*mt-pt*vt,ct=at*at+ft*ft+lt*lt,ct>F&&(F=ct,j=0)}O=x[j],x[j]=x[3],x.pop(),nt.deallocate(O),this.contactFlags|=4}},e.prototype.refreshContacts=function(){var e=this.contacts,t=this.objectA,n=this.objectB,r=t.transform,i=n.transform,s=r[0],o=r[1],u=r[2],a=r[3],f=r[4],l=r[5],c=r[6],h=r[7],p=r[8],d=r[9],v=r[10],m=r[11],g=i[0],y=i[1],b=i[2],w=i[3],E=i[4],S=i[5],x=i[6],T=i[7],N=i[8],C=i[9],k=i[10],L=i[11],O,M=0;while(M<e.length){O=e[M];var _=O[0],D=O[1],P=O[2],H=O[6]=s*_+a*D+c*P,B=O[7]=o*_+f*D+h*P,j=O[8]=u*_+l*D+p*P;_=O[3],D=O[4],P=O[5];var F=O[9]=g*_+w*D+x*P,I=O[10]=y*_+E*D+T*P,q=O[11]=b*_+S*D+N*P;_=H+d-(F+C),D=B+v-(I+k),P=j+m-(q+L);var R=O[12],U=O[13],z=O[14],W=O[21]=R*_+U*D+z*P;if(W>A.CONTACT_MAX_Y_SEPERATION){e[M]=e[e.length-1],e.pop(),nt.deallocate(O),this.contactFlags|=4;continue}_-=R*W,D-=U*W,P-=z*W;if(_*_+D*D+P*P>A.CONTACT_MAX_SQ_XZ_SEPERATION){e[M]=e[e.length-1],e.pop(),nt.deallocate(O),this.contactFlags|=4;continue}M+=1}return this.contactFlags|=2,e.length===0},e.prototype.preStep=function(e,t){if(this.trigger){this.activeContacts.length=0;return}var n=this.objectA,r=this.objectB,i=n.inverseMass+r.inverseMass,s=n.velocity,o=r.velocity,u=n.inverseInertia,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d=u[6],v=u[7],m=u[8];u=r.inverseInertia;var g=u[0],y=u[1],b=u[2],w=u[3],E=u[4],S=u[5],x=u[6],T=u[7],N=u[8],C=this.activeContacts;C.length=0;var k=n.collisionObject||r.collisionObject?A.CONTACT_STATIC_BAUMGRAUTE:A.CONTACT_BAUMGRAUTE,L=this.contacts,O,M=L.length;for(O=0;O<M;O+=1){var _=L[O];if(_[21]>0)continue;C[C.length]=_,_[41]=_[42]=0;var D,P,H,B,j,F,I=_[12],q=_[13],R=_[14],U=_[6],z=_[7],W=_[8],X=_[9],V=_[10],$=_[11],J,K,Q,G=i;D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[22]=J=a*D+c*P+d*H,_[23]=K=f*D+h*P+v*H,_[24]=Q=l*D+p*P+m*H,G+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[25]=J=-(g*B+w*j+x*F),_[26]=K=-(y*B+E*j+T*F),_[27]=Q=-(b*B+S*j+N*F),G-=B*J+j*K+F*Q,_[45]=1/G,_[43]=k*Math.min(0,_[21]+A.CONTACT_SLOP)/t,_[44]=0;var Y=s[0]-o[0],Z=s[1]-o[1],et=s[2]-o[2];Y+=s[4]*W-s[5]*z,Z+=s[5]*U-s[3]*W,et+=s[3]*z-s[4]*U,Y-=o[4]*$-o[5]*V,Z-=o[5]*X-o[3]*$,et-=o[3]*V-o[4]*X;var tt=(Y*I+Z*q+et*R)*this.restitution;tt*tt<.01&&(tt=0),_[50]=tt;var nt=i;I=_[15],q=_[16],R=_[17],D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[28]=J=a*D+c*P+d*H,_[29]=K=f*D+h*P+v*H,_[30]=Q=l*D+p*P+m*H,nt+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[31]=J=-(g*B+w*j+x*F),_[32]=K=-(y*B+E*j+T*F),_[33]=Q=-(b*B+S*j+N*F),nt-=B*J+j*K+F*Q;var rt=i;I=_[18],q=_[19],R=_[20],D=z*R-W*q,P=W*I-U*R,H=U*q-z*I,_[34]=J=a*D+c*P+d*H,_[35]=K=f*D+h*P+v*H,_[36]=Q=l*D+p*P+m*H,rt+=D*J+P*K+H*Q,B=V*R-$*q,j=$*I-X*R,F=X*q-V*I,_[37]=J=-(g*B+w*j+x*F),_[38]=K=-(y*B+E*j+T*F),_[39]=Q=-(b*B+S*j+N*F),rt-=B*J+j*K+F*Q;var it=0;it+=D*_[28]+P*_[29]+H*_[30],it-=B*_[31]+j*_[32]+F*_[33];var st=1/(nt*rt-it*it);_[46]=rt*st,_[47]=-it*st,_[48]=nt*st,_[40]*=e}},e.prototype.applyCachedImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=t.velocity,i=e.inverseMass,s=t.inverseMass,o=this.activeContacts,u;for(u=0;u<o.length;u+=1){var a=o[u],f=a[40],l=a[12]*f,c=a[13]*f,h=a[14]*f;n[0]+=l*i,n[1]+=c*i,n[2]+=h*i,r[0]-=l*s,r[1]-=c*s,r[2]-=h*s,n[3]+=a[22]*f,n[4]+=a[23]*f,n[5]+=a[24]*f,r[3]+=a[25]*f,r[4]+=a[26]*f,r[5]+=a[27]*f}},e.prototype.computeAndApplyBiasImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=n[6],i=n[7],s=n[8],o=n[9],u=n[10],a=n[11];n=t.velocity;var f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=e.inverseMass,m=t.inverseMass,g=this.activeContacts,y=g.length,b,w;for(w=0;w<y;w+=1){b=g[w];var E=b[12],S=b[13],x=b[14],T=b[6],N=b[7],C=b[8],k=b[9],L=b[10],A=b[11],O=b[45]*(E*(f+(p*A-d*L)-(r+(u*C-a*N)))+S*(l+(d*k-h*A)-(i+(a*T-o*C)))+x*(c+(h*L-p*k)-(s+(o*N-u*T)))-b[43]),M=b[44],_=M+O;_<0&&(_=0),O=_-M,b[44]=_,E*=O,S*=O,x*=O,r+=E*v,i+=S*v,s+=x*v,f-=E*m,l-=S*m,c-=x*m,o+=b[22]*O,u+=b[23]*O,a+=b[24]*O,h+=b[25]*O,p+=b[26]*O,d+=b[27]*O}n=e.velocity,n[6]=r,n[7]=i,n[8]=s,n[9]=o,n[10]=u,n[11]=a,n=t.velocity,n[6]=f,n[7]=l,n[8]=c,n[9]=h,n[10]=p,n[11]=d},e.prototype.computeAndApplyImpulses=function(){if(this.trigger)return;var e=this.objectA,t=this.objectB,n=e.velocity,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5];n=t.velocity;var f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5],v=e.inverseMass,m=t.inverseMass,g=this.friction,y=this.activeContacts,b=y.length,w,E;for(E=0;E<b;E+=1){w=y[E];var S=w[12],x=w[13],T=w[14],N=w[15],C=w[16],k=w[17],L=w[18],A=w[19],O=w[20],M=w[6],_=w[7],D=w[8],P=w[9],H=w[10],B=w[11],j=w[45]*(S*(f+(p*B-d*H)-(r+(u*D-a*_)))+x*(l+(d*P-h*B)-(i+(a*M-o*D)))+T*(c+(h*H-p*P)-(s+(o*_-u*M)))-w[50]),F=w[40],I=F+j;I<0&&(I=0,j=-F),w[40]=I,S*=j,x*=j,T*=j,r+=S*v,i+=x*v,s+=T*v,f-=S*m,l-=x*m,c-=T*m,o+=w[22]*j,u+=w[23]*j,a+=w[24]*j,h+=w[25]*j,p+=w[26]*j,d+=w[27]*j,S=f-r+(p*B-d*H)-(u*D-a*_),x=l-i+(d*P-h*B)-(a*M-o*D),T=c-s+(h*H-p*P)-(o*_-u*M);var q=N*S+C*x+k*T,R=L*S+A*x+O*T;j=q*w[46]+R*w[47];var U=q*w[47]+R*w[48];F=w[41];var z=w[42];I=F+j;var W=z+U,X=g*w[40],V=I*I+W*W;V>X*X&&(V=X/Math.sqrt(V),I*=V,W*=V,j=I-F,U=W-z),w[41]=I,w[42]=W,S=N*j+L*U,x=C*j+A*U,T=k*j+O*U,r+=S*v,i+=x*v,s+=T*v,f-=S*m,l-=x*m,c-=T*m,o+=w[28]*j+w[34]*U,u+=w[29]*j+w[35]*U,a+=w[30]*j+w[36]*U,h+=w[31]*j+w[37]*U,p+=w[32]*j+w[38]*U,d+=w[33]*j+w[39]*U}n=e.velocity,n[0]=r,n[1]=i,n[2]=s,n[3]=o,n[4]=u,n[5]=a,n=t.velocity,n[0]=f,n[1]=l,n[2]=c,n[3]=h,n[4]=p,n[5]=d},e.prototype.invalidateParameters=function(){this.restitution=this.objectA.restitution*this.objectB.restitution,this.friction=this.objectA.friction*this.objectB.friction},e.allocate=function(t,n,r,i){var s;return this.arbiterPoolSize===0?s=new e:(s=this.arbiterPool[this.arbiterPoolSize-1],this.arbiterPoolSize-=1),s.active=!0,s.shapeA=t,s.shapeB=n,s.objectA=r,s.objectB=i,s.invalidateParameters(),s},e.deallocate=function(e){e.shapeA=null,e.shapeB=null,e.objectA=null,e.objectB=null,e.skipDiscreteCollisions=!1,e.activeContacts.length=0,e.contactFlags=0,e.trigger=!1,this.arbiterPool[this.arbiterPoolSize]=e,this.arbiterPoolSize+=1},e.version=1,e.arbiterPool=[],e.arbiterPoolSize=0,e}(),it=function(){function e(){return this.bodies=[],this.constraints=[],this.wakeTimeStamp=0,this.active=!1,this}return e.allocate=function(){var t;return this.islandPoolSize===0?t=new e:(t=this.islandPool[this.islandPoolSize-1],this.islandPoolSize-=1),t},e.deallocate=function(e){this.islandPool[this.islandPoolSize]=e,this.islandPoolSize+=1,e.wakeTimeStamp=0},e.version=1,e.islandPool=[],e.islandPoolSize=0,e}(),st=function(){function e(){return this.index=0,this.collisionRadius=0,this.triangleArray=null,this}return e.prototype.localSupportWithoutMargin=function(e,t){var n=e[0],r=e[1],i=e[2],s=this.triangleArray.triangles,o=this.index,u=s[o+3],a=s[o+4],f=s[o+5],l=s[o+6],c=s[o+7],h=s[o+8],p=s[o+9],d=s[o+10],v=s[o+11],m=n*l+r*c+i*h,g=n*p+r*d+i*v;m<=0&&g<=0?(t[0]=u,t[1]=a,t[2]=f):m>=g?(t[0]=u+l,t[1]=a+c,t[2]=f+h):(t[0]=u+p,t[1]=a+d,t[2]=f+v)},e.allocate=function(){var t;return this.trianglePoolSize===0?t=new e:(t=this.trianglePool[this.trianglePoolSize-1],this.trianglePoolSize-=1),t},e.deallocate=function(e){this.trianglePool[this.trianglePoolSize]=e,this.trianglePoolSize+=1,e.triangleArray=null},e.version=1,e.trianglePool=[],e.trianglePoolSize=0,e}();st.prototype.type="TRIANGLE_MESH_TRIANGLE";var ot=function(){function e(){return this.objectA=null,this.objectB=null,this.shapeA=null,this.shapeB=null,this.closestA=t.v3BuildZero(),this.closestB=t.v3BuildZero(),this.axis=t.v3BuildZero(),this.distance=0,this.toi=0,this.frozenA=!1,this.frozenB=!1,this.concave=!1,this}return e.allocate=function(){var t;return this.eventPoolSize===0?t=new e:(t=this.eventPool[this.eventPoolSize-1],this.eventPoolSize-=1),t},e.deallocate=function(e){this.eventPool[this.eventPoolSize]=e,this.eventPoolSize+=1,e.concave&&(st.deallocate(e.shapeB),e.concave=!1),e.objectA=null,e.objectB=null,e.shapeA=null,e.shapeB=null},e.version=1,e.eventPool=[],e.eventPoolSize=0,e}(),ut=function(){function e(){}return e.prototype.update=function(){this._private.update()},e.prototype.rayTest=function(e){return this._private.rayTest(e)},e.prototype.convexSweepTest=function(e){return this._private.convexSweepTest(e)},e.prototype.addCollisionObject=function(e){return this._private.addBody(e._private)},e.prototype.removeCollisionObject=function(e){return this._private.removeBody(e._private)},e.prototype.addRigidBody=function(e){return this._private.addBody(e._private)},e.prototype.removeRigidBody=function(e){return this._private.removeBody(e._private)},e.prototype.addConstraint=function(e){return this._private.addConstraint(e._private)},e.prototype.removeConstraint=function(e){return this._private.removeConstraint(e._private)},e.prototype.addCharacter=function(e){return this._private.addBody(e._private.rigidBody._private)},e.prototype.removeCharacter=function(e){return this._private.removeBody(e._private.rigidBody._private)},e.prototype.wakeBody=function(e){this._private.wakeBody(e)},e.prototype.flush=function(){this._private.flush()},e.create=function(n){var r=new e,i=new at;return r._private=i,i._public=r,i.gravity=n.gravity!==undefined?t.v3Copy(n.gravity):t.v3Build(0,-10,0),i.maxSubSteps=n.maxSubSteps!==undefined?n.maxSubSteps:10,i.fixedTimeStep=n.fixedTimeStep!==undefined?n.fixedTimeStep:1/60,i.variableMinStep=n.minimumTimeStep!==undefined?n.minimumTimeStep:1/70,i.variableMaxStep=n.maximumTimeStep!==undefined?n.maximumTimeStep:.02,i.variableStep=n.variableTimeSteps!==undefined?n.variableTimeSteps:!1,i.maxGiveUpTimeStep=n.maxGiveUpTimeStep!==undefined?n.maxGiveUpTimeStep:.05,Object.defineProperty(r,"maxSubSteps",{value:i.maxSubSteps,enumerable:!0}),Object.defineProperty(r,"maxGiveUpTimeStep",{value:i.maxGiveUpTimeStep,enumerable:!0}),i.variableStep?(Object.defineProperty(r,"minimumTimeStep",{value:i.variableMinStep,enumerable:!0}),Object.defineProperty(r,"maximumTimeStep",{value:i.variableMaxStep,enumerable:!0})):Object.defineProperty(r,"fixedTimeStep",{value:i.fixedTimeStep,enumerable:!0}),Object.defineProperty(r,"gravity",{get:function(){return t.v3Copy(this._private.gravity)},enumerable:!0}),i.staticSpatialMap=f.create(!0),i.dynamicSpatialMap=f.create(),i.sleepingSpatialMap=f.create(),i.collisionObjects=[],i.rigidBodies=[],i.constraints=[],i.kinematicBodies=[],i.activeArbiters=[],i.activeBodies=[],i.activeKinematics=[],i.activeConstraints=[],i.persistantObjectsList=[],i.persistantObjectsList2=[],i.persistantTrianglesList=[],i.persistantTOIEventList=[],i.timeStamp=0,i.performanceData={discrete:0,sleepComputation:0,prestepContacts:0,prestepConstraints:0,integrateVelocities:0,warmstartContacts:0,warmstartConstraints:0,physicsIterations:0,integratePositions:0,continuous:0},Object.defineProperty(r,"performanceData",{value:i.performanceData,enumerable:!0}),i.syncExtents=new Float32Array(6),i.contactCallbackObjects=[],i.contactCallbackRemovedArbiters=[],r},e.version=1,e}(),at=function(){function e(){}return e.prototype.m43InverseOrthonormalTransformVector=function(e,t,n){n===undefined&&(n=new Float32Array(3));var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r+e[1]*i+e[2]*s,n[1]=e[3]*r+e[4]*i+e[5]*s,n[2]=e[6]*r+e[7]*i+e[8]*s,n},e.prototype.m43InverseOrthonormalTransformPoint=function(e,t,n){n===undefined&&(n=new Float32Array(3));var r=t[0]-e[9],i=t[1]-e[10],s=t[2]-e[11];return n[0]=e[0]*r+e[1]*i+e[2]*s,n[1]=e[3]*r+e[4]*i+e[5]*s,n[2]=e[6]*r+e[7]*i+e[8]*s,n},e.prototype.trianglePlaneDiscard=function(e,n,r,i,s){this.planeAxis===undefined&&(this.planeAxis=t.v3BuildZero(),this.planeSA=t.v3BuildZero(),this.planeSB=t.v3BuildZero());var o=this.planeAxis,u=this.planeSA,a=this.planeSB,f=r.triangles,l=f[i],c=f[i+1],h=f[i+2],p=f[i+16],d=s[0],v=s[1],m=s[2],g=s[3],y=s[4],b=s[5],w=s[6],E=s[7],S=s[8],x=s[9],T=s[10],N=s[11],C=l*d+c*g+h*w,k=l*v+c*y+h*E,L=l*m+c*b+h*S;d=n[0],v=n[1],m=n[2],g=n[3],y=n[4],b=n[5],w=n[6],E=n[7],S=n[8],x-=n[9],T-=n[10],N-=n[11],l=d*C+v*k+m*L,c=g*C+y*k+b*L,h=w*C+E*k+S*L,p+=C*x+k*T+L*N,o[0]=l,o[1]=c,o[2]=h,e.localSupportWithoutMargin(o,u),o[0]=-l,o[1]=-c,o[2]=-h,e.localSupportWithoutMargin(o,a);var A=u[0]*l+u[1]*c+u[2]*h-p,O=a[0]*l+a[1]*c+a[2]*h-p;if(A*O<=0)return!1;var M;return A*A<O*O?M=A:M=O,M<0!=A*O<0&&(M=-M),M-e.collisionRadius>0},e.prototype.filtered=function(e,t){return e===t?!0:(e.collisionObject||e.kinematic)&&(t.collisionObject||t.kinematic)?!0:(e.mask&t.group)===0||(t.mask&e.group)===0?!0:!1},e.prototype.narrowPhase=function(e,n,r,i){this.narrowTriangle===undefined&&(this.narrowTriangle=st.allocate(),this.narrowCache={axis:t.v3Build(1,0,0),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.narrowCache2={axis:this.narrowCache.axis,shapeA:null,shapeB:null,closestA:this.narrowCache.closestA,closestB:this.narrowCache.closestB},this.narrowFakeBody={transform:t.m43BuildIdentity(),shape:null},this.narrowTransform=t.m43BuildIdentity(),this.narrowExtents=new Float32Array(6));var s=null,o=r.arbiters,u=i.arbiters,a=o.length<=u.length?o:u,f=0,l=a.length;for(f=0;f<l;f+=1){var c=a[f];if(c.shapeA===e&&c.shapeB===n&&c.objectA===r&&c.objectB===i){s=c;break}}if(s!==null&&s.skipDiscreteCollisions){s.skipDiscreteCollisions=!1;return}var h=s===null;h&&(s=rt.allocate(e,n,r,i));var p=this.narrowCache;p.shapeA=e,p.shapeB=n;if(s.contacts.length!==0){var d=s.contacts[0];p.axis[0]=d[12],p.axis[1]=d[13],p.axis[2]=d[14]}var v,m=!1;if(e.type==="TRIANGLE_MESH"||n.type==="TRIANGLE_MESH"){var g,y,b,w,E=this.narrowTriangle,S=this.narrowCache2;e.type==="TRIANGLE_MESH"?(g=e,b=r.transform,y=n,w=i.transform,S.shapeA=E,S.shapeB=p.shapeB):(g=n,b=i.transform,y=e,w=r.transform,S.shapeA=p.shapeA,S.shapeB=E);var x=g.triangleArray;E.triangleArray=x,E.collisionRadius=g.collisionRadius;var T;if(x.spatialMap){var N=this.narrowTransform,C=this.narrowFakeBody,k=this.narrowExtents;t.m43InverseOrthonormal(b,N),t.m43Mul(w,N,C.transform),C.shape=y,z.prototype.calculateExtents.call(C,k);var L=this.persistantTrianglesList;T=x.spatialMap.getOverlappingNodes(k,L,0);for(f=0;f<T;f+=1){var A=L[f].index;E.index=A,L[f]=undefined,this.trianglePlaneDiscard(y,w,x,A,b)||(v=this.contactPairTest(S,r.transform,i.transform),v<0&&(s.insertContact(S.closestA,S.closestB,S.axis,v,!0),m=!0))}}else{T=x.numTriangles;for(f=0;f<T;f+=1)E.index=f*I.prototype.TRIANGLE_SIZE,this.trianglePlaneDiscard(y,w,x,E.index,b)||(v=this.contactPairTest(S,r.transform,i.transform),v<0&&(s.insertContact(S.closestA,S.closestB,S.axis,v,!0),m=!0))}}else v=this.contactPairTest(p,r.transform,i.transform),v<0&&(s.insertContact(p.closestA,p.closestB,p.axis,v,!1),m=!0);m?(h&&(this.activeArbiters.push(s),s.active=!0,r.arbiters.push(s),i.arbiters.push(s)),r.permitSleep&&!r.active&&this.wakeBody(r),i.permitSleep&&!i.active&&this.wakeBody(i),s.active||(s.active=!0,this.activeArbiters.push(s))):h&&rt.deallocate(s)},e.prototype.computeSleeping=function(e){function t(e,t){var r=n(e),i=n(t);r!==i&&(r.islandRank<i.islandRank?r.islandRoot=i:r.islandRank>i.islandRank?i.islandRoot=r:(i.islandRoot=r,r.islandRank+=1))}function n(e){if(e===e.islandRoot)return e;var t=e,n=null,r;while(t!==t.islandRoot)r=t.islandRoot,t.islandRoot=n,n=t,t=r;while(n!==null)r=n.islandRoot,n.islandRoot=t,n=r;return t}var r,i,s=this.activeArbiters,o=this.activeBodies,u=this.activeConstraints,a,f=s.length;for(a=0;a<f;a+=1){var l=s[a];r=l.objectA,i=l.objectB,r.permitSleep&&i.permitSleep&&t(r,i)}f=u.length;var c;for(a=0;a<f;a+=1)c=u[a],r=c.bodyA,i=c.bodyB,r&&r.permitSleep&&t(r,c),i&&i.permitSleep&&t(i,c);var h=[],p,d,v;while(o.length>0)d=o.pop(),v=n(d),p=v.island,p||(p=v.island=it.allocate(),h.push(p),p.active=!1),d.island=p,p.bodies.push(d),p.active=p.active||d.isActive(e),d.wakeTimeStamp>p.wakeTimeStamp&&(p.wakeTimeStamp=d.wakeTimeStamp);while(u.length>0)c=u.pop(),v=n(c),p=v.island,p||(p=v.island=it.allocate(),h.push(p),p.active=!0),c.island=p,p.constraints.push(c),c.wakeTimeStamp>p.wakeTimeStamp&&(p.wakeTimeStamp=c.wakeTimeStamp);while(h.length>0){p=h.pop();if(p.active){while(p.bodies.length>0)d=p.bodies.pop(),d.wakeTimeStamp=p.wakeTimeStamp,o.push(d),d.islandRoot=d,d.islandRank=0,d.island=null;while(p.constraints.length>0)c=p.constraints.pop(),c.wakeTimeStamp=p.wakeTimeStamp,u.push(c),c.islandRoot=c,c.islandRank=0,c.island=null;it.deallocate(p)}else{f=p.bodies.length;for(a=0;a<f;a+=1)d=p.bodies[a],d.velocity[0]=d.velocity[1]=d.velocity[2]=0,d.velocity[3]=d.velocity[4]=d.velocity[5]=0,d.active=!1,this.syncBody(d),d.islandRoot=d,d.islandRank=0;f=p.constraints.length;for(a=0;a<f;a+=1)c=p.constraints[a],c.active=!1,c.islandRoot=c,c.islandRank=0}}},e.prototype.wakeIsland=function(e){while(e.bodies.length>0){var t=e.bodies.pop();t.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeBodies.push(t);var n,r=t.arbiters,i=r.length;for(n=0;n<i;n+=1){var s=r[n];s.active||(s.active=!0,this.activeArbiters.push(s))}t.active=!0,t.island=null,this.syncBody(t)}while(e.constraints.length>0){var o=e.constraints.pop();o.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),this.activeConstraints.push(o),o.active=!0,o.island=null}it.deallocate(e)},e.prototype.wakeRelated=function(e){var t=e.constraints,n,r=t.length;for(n=0;n<r;n+=1)this.wakeConstraint(t[n]);var i=e.arbiters;r=i.length;for(n=0;n<r;n+=1){var s=i[n];s.active||(s.active=!0,this.activeArbiters.push(s)),s.objectA.permitSleep&&!s.objectA.active&&this.wakeBody(s.objectA),s.objectB.permitSleep&&!s.objectB.active&&this.wakeBody(s.objectB)}},e.prototype.wakeBody=function(e){e.collisionObject&&!e.kinematic?(this.wakeRelated(e),this.syncBody(e)):e.kinematic?(e.delaySleep=!0,e.active||(e.active=!0,this.activeKinematics.push(e),this.wakeRelated(e),this.syncBody(e))):(e.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),e.active||(e.island?this.wakeIsland(e.island):(e.active=!0,this.activeBodies.push(e),this.wakeRelated(e),this.syncBody(e)),this.syncBody(e)))},e.prototype.syncBody=function(e){var t=this.syncExtents;e.calculateExtents(t),e.collisionObject&&!e.kinematic?this.staticSpatialMap.update(e,t):(e.active?e.previouslyActive?this.dynamicSpatialMap.update(e,t):(this.sleepingSpatialMap.remove(e),this.dynamicSpatialMap.add(e,t)):e.previouslyActive?(this.dynamicSpatialMap.remove(e),this.sleepingSpatialMap.add(e,t)):this.sleepingSpatialMap.update(e,t),e.previouslyActive=e.active)},e.prototype.wakeConstraint=function(e){e.wakeTimeStamp=this.timeStamp+(this.midStep?0:1),e.active||(e.island?this.wakeIsland(e.island):(e.active=!0,this.activeConstraints.push(e),e.bodyA&&this.wakeBody(e.bodyA),e.bodyB&&this.wakeBody(e.bodyB)))},e.prototype.dynamicSweep=function(e,t,n,r){var i=e.objectA,s=e.objectB,o=e.axis,u=i.velocity,a=-u[0],f=-u[1],l=-u[2],c=s.velocity;a+=c[0],f+=c[1],l+=c[2];if(a*a+f*f+l*l<A.DONT_NORMALIZE_THRESHOLD){e.toi=undefined;return}o[0]=a,o[1]=f,o[2]=l;var h=-a,p=-f,d=-l,v=0,m,g;i.fixedRotation||(m=i.shape.radius,v+=m*Math.sqrt(u[3]*u[3]+u[4]*u[4]+u[5]*u[5])),s.fixedRotation||(g=s.shape.radius,v+=g*Math.sqrt(c[3]*c[3]+c[4]*c[4]+c[5]*c[5]));if(v<A.CONTINUOUS_ANGULAR_BULLET/t){var y=m<g?m:g;y*=A.CONTINUOUS_LINEAR_BULLET/t;if(h*h+p*p+d*d<y*y){e.toi=undefined;return}}var b=0,w=100,E=n;for(;;){i.integratePosition(E*t),s.integratePosition(E*t);var S=this.contactPairTest(e,i.transform,s.transform),x=S;S!==undefined&&(x+=r);if(x===undefined||x<A.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(e)?E=undefined:e.distance=S;break}var T=o[0]*h+o[1]*p+o[2]*d,N=(v-T)*t;if(N<=0){E=undefined;break}E+=x/N;if(E>=1){E=undefined;break}b+=1;if(b>w){E=undefined;break}}e.toi=E},e.prototype.seperatingTOI=function(e){var t=e.objectA,n=e.objectB,r=e.closestA,i=e.closestB,s=t.velocity,o=n.velocity,u=s[0]-o[0],a=s[1]-o[1],f=s[2]-o[2];if(!t.fixedRotation){var l=r[0]-t.transform[9],c=r[1]-t.transform[10],h=r[2]-t.transform[11];u+=s[4]*h-s[5]*c,a+=s[5]*l-s[3]*h,f+=s[3]*c-s[4]*l}if(!n.fixedRotation){var p=i[0]-n.transform[9],d=i[1]-n.transform[10],v=i[2]-n.transform[11];u-=o[4]*v-o[5]*d,a-=o[5]*p-o[3]*v,f-=o[3]*d-o[4]*p}var m=e.axis,g=u*m[0]+a*m[1]+f*m[2];return g>=0},e.prototype.staticSweep=function(e,t,n,r){var i=e.objectA,s=e.objectB,o=e.axis,u=i.velocity,a=-u[0],f=-u[1],l=-u[2];if(a*a+f*f+l*l<A.DONT_NORMALIZE_THRESHOLD){e.toi=undefined;return}o[0]=a,o[1]=f,o[2]=l;var c=-a,h=-f,p=-l,d=0;i.fixedRotationtype||(d+=i.shape.radius*Math.sqrt(u[3]*u[3]+u[4]*u[4]+u[5]*u[5]));var v=0,m=100,g=n;for(;;){i.integratePosition(g*t);var y=this.contactPairTest(e,i.transform,s.transform),b=y;y!==undefined&&(b+=r);if(b===undefined||b<A.GJK_EPA_DISTANCE_THRESHOLD){this.seperatingTOI(e)?g=undefined:e.distance=y;break}var w=o[0]*c+o[1]*h+o[2]*p,E=(d-w)*t;if(E<=0){g=undefined;break}g+=b/E;if(g>=1){g=undefined;break}v+=1;if(v>m){g=undefined;break}}e.toi=g},e.prototype.performStaticTOIBase=function(e,n,r,i,s,o){var u=this.persistantTrianglesList;this.continuousFakeBody===undefined&&(this.continuousFakeBody={shape:null,transform:t.m43BuildIdentity(),startTransform:t.m43BuildIdentity()},this.continuousInvTransform=t.m43BuildIdentity(),this.continuousExtents=new Float32Array(6));var a=this.continuousFakeBody,f=this.continuousInvTransform,l=this.continuousExtents,c;if(o.shape.type==="TRIANGLE_MESH"){var h=o.shape.triangleArray,p,d;if(h.spatialMap){a.shape=s.shape,t.m43InverseOrthonormal(o.transform,f),t.m43Mul(s.startTransform,f,a.startTransform),t.m43Mul(s.endTransform,f,a.transform),z.prototype.calculateSweptExtents.call(a,l),p=h.spatialMap.getOverlappingNodes(l,u,0);for(d=0;d<p;d+=1){c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=st.allocate(),c.shapeB.index=u[d].index,u[d]=undefined,c.shapeB.triangleArray=o.shape.triangleArray,c.shapeB.collisionRadius=o.shape.collisionRadius,c.concave=!0,this.staticSweep(c,n,0,e);if(c.toi===undefined){ot.deallocate(c);continue}c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}}else{p=h.numTriangles;for(d=0;d<p;d+=1){c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=st.allocate(),c.shapeB.index=d*I.prototype.TRIANGLE_SIZE,c.shapeB.triangleArray=o.shape.triangleArray,c.shapeB.collisionRadius=o.shape.collisionRadius,c.concave=!0,this.staticSweep(c,n,0,e);if(c.toi===undefined){ot.deallocate(c);continue}c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}}}else{c=ot.allocate(),c.objectA=s,c.objectB=o,c.shapeA=s.shape,c.shapeB=o.shape,this.staticSweep(c,n,0,e);if(c.toi===undefined)return ot.deallocate(c),i;c.frozenA=!1,c.frozenB=!0,r[i]=c,i+=1}return i},e.prototype.update=function(){var e=this.dynamicSpatialMap,n=this.staticSpatialMap,r=this.sleepingSpatialMap,i=this.activeBodies,s=this.activeKinematics,o=this.activeConstraints,u=this.activeArbiters,a=this
.gravity,f=this.performanceData;f.discrete=0,f.sleepComputation=0,f.prestepContacts=0,f.prestepConstraints=0,f.integrateVelocities=0,f.warmstartContacts=0,f.warmstartConstraints=0,f.physicsIterations=0,f.integratePositions=0,f.continuous=0;var l=this.prevTimeStamp;if(l===undefined){this.prevTimeStamp=TurbulenzEngine.getTime()*.001;return}var c=TurbulenzEngine.getTime()*.001,h=c-l,p,d;if(this.variableStep){var v=this.variableMinStep,m=this.variableMaxStep;p=Math.ceil(h/m),d=h/p,d<v&&(d=v,p=Math.floor(h/d)),p>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(p=Math.ceil(h/this.maxGiveUpTimeStep),d=h/p)}else d=this.fixedTimeStep,p=Math.floor(h/d),p>this.maxSubSteps&&this.maxGiveUpTimeStep!==0&&(p=Math.ceil(h/this.maxGiveUpTimeStep),d=h/p);if(p<=0)return;this.prevTimeStamp+=d*p,p>this.maxSubSteps&&(p=this.maxSubSteps),this.midStep=!0;var g,y,b;g=s.length;for(y=0;y<g;)b=s[y],!b.computeDeltaVelocity(d*p,b.prevTransform,b.transform)&&!b.delaySleep?(b.active=!1,g-=1,s[y]=s[g],s.pop(),this.syncBody(b)):(t.m43Copy(b.transform,b.newTransform),t.m43Copy(b.prevTransform,b.transform),y+=1),b.delaySleep=!1;var w;for(w=0;w<p;w+=1){var E,S;this.timeStamp+=1;var x;this.prevTimeStep===undefined&&(this.prevTimeStep=d);var T=d/this.prevTimeStep;this.prevTimeStep=d,g=i.length;for(y=0;y<g;y+=1)b=i[y],S=b.extents,b.calculateExtents(S),e.update(b,S),b.refreshInertiaTensor();g=s.length;for(y=0;y<g;y+=1)b=s[y],S=b.extents,b.calculateExtents(S),e.update(b,S);x=TurbulenzEngine.getTime()*.001,n.finalize(),e.finalize(),r.finalize();var N=this.persistantObjectsList,C=e.getOverlappingPairs(N,0),k=C,L;g=i.length;for(y=0;y<g;y+=1)b=i[y],L=n.getOverlappingNodes(b.extents,N,k+1),L+=r.getOverlappingNodes(b.extents,N,k+1+L),L!==0&&(N[k]=b,k+=1+L,N[k]=b,k+=1);g=s.length;for(y=0;y<g;y+=1)b=s[y],L=r.getOverlappingNodes(b.extents,N,k+1),L!==0&&(N[k]=b,k+=1+L,N[k]=b,k+=1);var O,M;for(y=0;y<C;y+=2)O=N[y],M=N[y+1],N[y]=undefined,N[y+1]=undefined,this.filtered(O,M)||(O.id<M.id?this.narrowPhase(O.shape,M.shape,O,M):this.narrowPhase(M.shape,O.shape,M,O));for(y=C;y<k;){O=N[y],N[y]=undefined,y+=1;for(;;){M=N[y],N[y]=undefined,y+=1;if(O===M)break;this.filtered(O,M)||(O.id<M.id?this.narrowPhase(O.shape,M.shape,O,M):this.narrowPhase(M.shape,O.shape,M,O))}}f.discrete+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,this.computeSleeping(d),f.sleepComputation+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,y=0;var _;while(y<u.length){_=u[y];if(!_.objectA.active&&!_.objectB.active){_.active=!1,u[y]=u[u.length-1],u.pop();continue}if(_.refreshContacts()){u[y]=u[u.length-1],u.pop(),O=_.objectA,M=_.objectB;var D=O.arbiters;D[D.indexOf(_)]=D[D.length-1],D.pop(),D=M.arbiters,D[D.indexOf(_)]=D[D.length-1],D.pop(),O.contactCallbacks&&O.contactCallbacks.onRemovedContacts||M.contactCallbacks&&M.contactCallbacks.onRemovedContacts?this.contactCallbackRemovedArbiters.push(_):rt.deallocate(_);continue}_.preStep(T,d),y+=1}f.prestepContacts+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=o.length;for(y=0;y<g;y+=1)o[y].preStep(T,d);f.prestepConstraints+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=i.length;for(y=0;y<g;y+=1)b=i[y],b.integrateVelocity(a,d);f.integrateVelocities+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=u.length;for(y=0;y<g;y+=1)u[y].applyCachedImpulses();f.warmstartContacts+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,g=o.length;for(y=0;y<g;y+=1)o[y].applyCachedImpulses();f.warmstartConstraints+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001;var P=10;for(y=0;y<P;y+=1){g=u.length;for(E=0;E<g;E+=1)u[E].computeAndApplyImpulses();g=o.length;for(E=0;E<g;E+=1)o[E].computeAndApplyImpulses()}P=3,g=u.length;for(y=0;y<P;y+=1)for(E=0;E<g;E+=1)u[E].computeAndApplyBiasImpulses();f.physicsIterations+=TurbulenzEngine.getTime()*.001-x;var H=this.persistantObjectsList2,B=0;x=TurbulenzEngine.getTime()*.001,g=i.length;var j,F=d*d,I,q;for(y=0;y<g;y+=1){b=i[y],b.applyBiasVelocities(d),b.integratePosition(d);if(!b.isActiveVelocity(A.CONTINUOUS_LINEAR_SQ/d,A.CONTINUOUS_ANGULAR_SQ/d)){b.sweepFrozen=!0,b.bullet=!1;continue}I=b.transform,q=b.endTransform,q[0]=I[0],q[1]=I[1],q[2]=I[2],q[3]=I[3],q[4]=I[4],q[5]=I[5],q[6]=I[6],q[7]=I[7],q[8]=I[8],q[9]=I[9],q[10]=I[10],q[11]=I[11],j=b.shape.radius*A.CONTINUOUS_LINEAR_BULLET;var R=b.velocity,U=(R[0]*R[0]+R[1]*R[1]+R[2]*R[2])*F,z=(R[3]*R[3]+R[4]*R[4]+R[5]*R[5])*F;b.bullet=U>j*j||z>A.CONTINUOUS_ANGULAR_BULLET,S=b.extents,b.calculateSweptExtents(S),e.update(b,S),b.sweepFrozen=!1,H[B]=b,B+=1}g=s.length;for(y=0;y<g;y+=1)b=s[y],t.m43Copy(b.transform,b.startTransform),b.integratePosition(d),S=b.extents,b.calculateSweptExtents(S),e.update(b,S);f.integratePositions+=TurbulenzEngine.getTime()*.001-x,x=TurbulenzEngine.getTime()*.001,n.finalize(),e.finalize(),r.finalize();var W=A.CONTINUOUS_SLOP+A.CONTACT_SLOP,X=this.persistantTOIEventList,V=0,$;C=e.getOverlappingPairs(N,0);for(y=0;y<C;y+=2){O=N[y],M=N[y+1],N[y]=undefined,N[y+1]=undefined;if(!(O.bullet||O.kinematic||M.bullet||M.kinematic)||O.sweepFrozen&&M.sweepFrozen||this.filtered(O,M))continue;O.kinematic||M.kinematic?O.kinematic?V=this.performStaticTOIBase(W,d,X,V,M,O):V=this.performStaticTOIBase(W,d,X,V,O,M):($=ot.allocate(),$.objectA=O,$.objectB=M,$.shapeA=O.shape,$.shapeB=M.shape,this.dynamicSweep($,d,0,W),$.frozenA=O.sweepFrozen,$.frozenB=M.sweepFrozen,X[V]=$,V+=1)}for(y=0;y<B;y+=1){O=H[y],L=n.getOverlappingNodes(O.extents,N,0),L+=r.getOverlappingNodes(O.extents,N,L);for(E=0;E<L;E+=1){M=N[E],N[E]=undefined;if(this.filtered(O,M))continue;V=this.performStaticTOIBase(W,d,X,V,O,M)}}var J=0;while(J<1&&V>0){var K=null,Q;for(y=0;y<V;){$=X[y],O=$.objectA,M=$.objectB;if(O.sweepFrozen&&M.sweepFrozen){V-=1,y!==V&&(X[y]=X[V],X[V]=undefined),ot.deallocate($);continue}if($.frozenA!==O.sweepFrozen||$.frozenB!==M.sweepFrozen){$.frozenA=O.sweepFrozen,$.frozenB=M.sweepFrozen,$.frozenA&&($.objectA=M,$.objectB=O,$.shapeA=M.shape,$.shapeB=O.shape,$.frozenA=!1,$.frozenB=!0),this.staticSweep($,d,J,W);if($.toi===undefined){V-=1,y!==V&&(X[y]=X[V],X[V]=undefined),ot.deallocate($);continue}}$.toi!==undefined&&(K===null||$.toi<K.toi)&&(K=$,Q=y),y+=1}if(K===null)break;V-=1,Q!==V&&(X[Q]=X[V],X[V]=undefined),J=K.toi,O=K.objectA,M=K.objectB,O.collisionObject||(O.sweepFrozen||(O.integratePosition(d*J),O.sweepFrozen=!0),O.permitSleep&&!O.active&&this.wakeBody(O)),M.collisionObject||(M.sweepFrozen||(M.integratePosition(d*J),M.sweepFrozen=!0),M.permitSleep&&!M.active&&this.wakeBody(M));if(O.id>M.id){var G=O;O=M,M=G;var Y=K.closestA;K.closestA=K.closestB,K.closestB=Y,Y=K.axis,Y[0]=-Y[0],Y[1]=-Y[1],Y[2]=-Y[2]}var Z=O.shape,et=M.shape;_=null;var tt=O.arbiters,nt=M.arbiters,it=tt.length<=nt.length?tt:nt,st=it.length;for(y=0;y<st;y+=1){var ut=it[y];if(ut.shapeA===Z&&ut.shapeB===et&&ut.objectA===O&&ut.objectB===M){_=ut;break}}var at=_===null;at&&(_=rt.allocate(Z,et,O,M)),_.insertContact(K.closestA,K.closestB,K.axis,K.distance,K.concave),at&&(u.push(_),_.active=!0,O.arbiters.push(_),M.arbiters.push(_)),O.kinematic&&O.active||M.kinematic&&M.active||(_.skipDiscreteCollisions=!0),ot.deallocate(K)}while(V>0)V-=1,ot.deallocate(X[V]),X[V]=undefined;while(B>0)B-=1,O=H[B],H[B]=undefined,O.sweepFrozen||O.integratePosition(d);f.continuous+=TurbulenzEngine.getTime()*.001-x}g=s.length;for(y=0;y<g;y+=1)b=s[y],t.m43Copy(b.newTransform,b.transform),t.m43Copy(b.newTransform,b.prevTransform);this.updateContactCallbacks(),this.midStep=!1},e.prototype.rayTest=function(e){function o(e,t,s,o,u){var a=t._public;if(a===i||(t.mask&n)===0||(t.group&r)===0)return null;s.maxFactor=u;var f=t.rayTest(s);return f!==null&&(t.collisionObject?(f.collisionObject=a,f.body=null):(f.collisionObject=null,f.body=a)),f}var n=e.group,r=e.mask;n===undefined&&(n=ft.prototype.FILTER_DYNAMIC),r===undefined&&(r=ft.prototype.FILTER_ALL);var i=e.exclude,s={origin:e.from,direction:t.v3Sub(e.to,e.from),maxFactor:1};this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.sleepingSpatialMap.finalize();var u=f.rayTest([this.staticSpatialMap,this.dynamicSpatialMap,this.sleepingSpatialMap],s,o);return u!==null&&delete u.factor,u},e.prototype.contactPairTest=function(e,t,n){var r=e.axis,i=e.shapeA,s=e.shapeB,o=e.closestA,u=e.closestB;this.contactGJK===undefined&&(this.contactGJK=Z.create(),this.contactEPA=et.create());if(i.type==="PLANE"||s.type==="PLANE"){var a,f,l,c;i.type==="PLANE"?(a=i,l=t,f=s,c=n):(a=s,l=n,f=i,c=t);var h=l[0],p=l[1],d=l[2],v=l[3],m=l[4],g=l[5],y=l[6],b=l[7],w=l[8],E=l[9],S=l[10],x=l[11],T=a.normal,N=T[0],C=T[1],k=T[2],L=a.distance,A=N*h+C*v+k*y,O=N*p+C*m+k*b,M=N*d+C*g+k*w;h=c[0],p=c[1],d=c[2],v=c[3],m=c[4],g=c[5],y=c[6],b=c[7],w=c[8];var _=c[9],D=c[10],P=c[11];N=h*A+p*O+d*M,C=v*A+m*O+g*M,k=y*A+b*O+w*M,L+=A*(E-_)+O*(S-D)+M*(x-P),r[0]=N,r[1]=C,r[2]=k,f.localSupportWithoutMargin(r,o),r[0]=-N,r[1]=-C,r[2]=-k,f.localSupportWithoutMargin(r,u);var H=o[0]*N+o[1]*C+o[2]*k-L,B=u[0]*N+u[1]*C+u[2]*k-L,j,F,I,q;H*H<B*B?(F=o[0],I=o[1],q=o[2],j=H):(F=u[0],I=u[1],q=u[2],j=B),j<0!=H*B<0&&(j=-j,A=-A,O=-O,M=-M);var R=f.collisionRadius,U=a.collisionRadius,z=h*F+v*I+y*q+_,W=p*F+m*I+b*q+D,X=d*F+g*I+w*q+P,V=U-j,$=z+A*V,J=W+O*V,K=X+M*V;return z-=A*R,W-=O*R,X-=M*R,j-=R+U,i.type==="PLANE"?(r[0]=-A,r[1]=-O,r[2]=-M,o[0]=$,o[1]=J,o[2]=K,u[0]=z,u[1]=W,u[2]=X):(r[0]=A,r[1]=O,r[2]=M,o[0]=z,o[1]=W,o[2]=X,u[0]=$,u[1]=J,u[2]=K),j}var Q=this.contactGJK,G=Q.evaluate(e,t,n);G===undefined&&(G=this.contactEPA.evaluate(Q.simplex,e,t,n));if(G!==undefined){var Y=r[0],tt=r[1],nt=r[2],rt=i.collisionRadius,it=s.collisionRadius;return o[0]-=Y*rt,o[1]-=tt*rt,o[2]-=nt*rt,u[0]+=Y*it,u[1]+=tt*it,u[2]+=nt*it,G-rt-it}return undefined},e.prototype.convexSweepTest=function(e,n){function p(e,n,i,s,o,u){var a=i[0],f=i[1],l=i[2],c=r.axis,p=r.closestA,d=r.closestB;c[0]=-a,c[1]=-f,c[2]=-l,r.shapeA=e,r.shapeB=s;var v=0,m=0,g=100,y,b=Number.MAX_VALUE,w=!1;for(;;){var E=h.contactPairTest(r,n,o);if(E===undefined||E<A.GJK_EPA_DISTANCE_THRESHOLD){if(y!==undefined||E!==undefined)y===undefined&&(y=E),w=!0;break}if(E-b>=1)break;b=E;var S=d[0]-p[0],x=d[1]-p[1],T=d[2]-p[2],N=a*S+f*x+l*T;if(N<=A.COPLANAR_THRESHOLD)break;var C=E*E/N;v+=C;if(v>=u){y=undefined;break}y=E,n[9]+=a*C,n[10]+=f*C,n[11]+=l*C;if(y<=A.GJK_EPA_DISTANCE_THRESHOLD){w=!0;break}m+=1;if(m>g)break}return y===undefined||!w?null:{hitPoint:t.v3Copy(d),hitNormal:t.v3Copy(c),distance:v}}this.sweepCache===undefined&&(this.sweepCache={axis:t.v3BuildZero(),shapeA:null,shapeB:null,closestA:t.v3BuildZero(),closestB:t.v3BuildZero()},this.sweepTriangle=st.allocate(),this.sweepDelta=t.v3BuildZero(),this.sweepFromExtents=new Float32Array(6),this.sweepToExtents=new Float32Array(6),this.sweepExtents=new Float32Array(6),this.sweepFakeBody={shape:null,transform:null},this.sweepTransform=t.m43BuildIdentity(),this.sweepTransform2=t.m43BuildIdentity());var r=this.sweepCache,i=this.sweepTriangle,s=this.sweepDelta,o=this.sweepFromExtents,u=this.sweepToExtents,a=this.sweepExtents,f=this.sweepFakeBody,l=this.sweepTransform,c=this.sweepTransform2,h=this,d=e.shape._private,v=e.from,m=e.to,g=m[9]-v[9],y=m[10]-v[10],b=m[11]-v[11],w=Math.sqrt(g*g+y*y+b*b),E=1/w;s[0]=g*E,s[1]=y*E,s[2]=b*E;var S=e.group===undefined?ft.prototype.FILTER_DYNAMIC:e.group,x=e.mask===undefined?ft.prototype.FILTER_ALL:e.mask,T=e.exclude;f.shape=d,f.transform=v,z.prototype.calculateExtents.call(f,o),f.transform=m,z.prototype.calculateExtents.call(f,u),a[0]=o[0]<u[0]?o[0]:u[0],a[1]=o[1]<u[1]?o[1]:u[1],a[2]=o[2]<u[2]?o[2]:u[2],a[3]=o[3]>u[3]?o[3]:u[3],a[4]=o[4]>u[4]?o[4]:u[4],a[5]=o[5]>u[5]?o[5]:u[5],this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.sleepingSpatialMap.finalize();var N=this.persistantObjectsList,C=this.persistantTrianglesList,k=this.staticSpatialMap.getOverlappingNodes(a,N,0);k+=this.dynamicSpatialMap.getOverlappingNodes(a,N,k);var L=k+this.sleepingSpatialMap.getOverlappingNodes(a,N,k),O=null,M,_;for(M=0;M<L;M+=1){var D=N[M];N[M]=undefined;var P=D._public;if(P===T||D.shape===d||(D.mask&S)===0||(D.group&x)===0)continue;var H,B=D.shape;if(B.type==="TRIANGLE_MESH"){var j=B.triangleArray;i.triangleArray=j,i.collisionRadius=B.collisionRadius;var F;if(j.spatialMap){t.m43InverseOrthonormal(D.transform,c),t.m43Mul(v,c,l),f.transform=l,z.prototype.calculateExtents.call(f,o),t.m43Mul(m,c,l),z.prototype.calculateExtents.call(f,u),a[0]=o[0]<u[0]?o[0]:u[0],a[1]=o[1]<u[1]?o[1]:u[1],a[2]=o[2]<u[2]?o[2]:u[2],a[3]=o[3]>u[3]?o[3]:u[3],a[4]=o[4]>u[4]?o[4]:u[4],a[5]=o[5]>u[5]?o[5]:u[5],F=j.spatialMap.getOverlappingNodes(a,C,0);for(_=0;_<F;_+=1){i.index=C[_].index,C[_]=undefined,t.m43Copy(v,c),H=p(d,c,s,i,D.transform,w);if(H){H.collisionObject=P,H.body=null;if(!n||n(H))O=H,w=H.distance}}}else{F=j.numTriangles;for(_=0;_<F;_+=1){i.index=_*I.prototype.TRIANGLE_SIZE,t.m43Copy(v,c),H=p(d,c,s,i,D.transform,w);if(H){H.collisionObject=P,H.body=null;if(!n||n(H))O=H,w=H.distance}}}}else{t.m43Copy(v,c),H=p(d,c,s,B,D.transform,w);if(H){D.collisionObject?(H.collisionObject=P,H.body=null):(H.collisionObject=null,H.body=P);if(!n||n(H))O=H,w=H.distance}}if(w<1e-4){for(_=M;_<L;_+=1)N[_]=undefined;break}}return O&&delete O.distance,O},e.prototype.addBody=function(e){if(e.world)return!1;e.world=this;if(e.collisionObject&&!e.kinematic)return this.collisionObjects.push(e),this.syncBody(e),!0;e.kinematic?this.kinematicBodies.push(e):this.rigidBodies.push(e);var t=!e.active;return e.previouslyActive=!0,e.active=!1,e.islandRoot=e,e.islandRank=0,t?this.syncBody(e):this.wakeBody(e),!0},e.prototype.removeBody=function(e){if(e.world!==this)return!1;var t,n;e.collisionObject&&!e.kinematic?t=this.collisionObjects:e.kinematic?(t=this.kinematicBodies,n=this.activeKinematics):(t=this.rigidBodies,n=this.activeBodies),e.world=null,t[t.indexOf(e)]=t[t.length-1],t.pop(),n&&e.active?(n[n.indexOf(e)]=n[n.length-1],n.pop(),this.dynamicSpatialMap.remove(e)):e.collisionObject&&!e.kinematic?this.staticSpatialMap.remove(e):this.sleepingSpatialMap.remove(e),this.removeArbitersFromObject(e),this.removeFromContactCallbacks(e);var r=e.island;if(r){var i=r.bodies,s=i.indexOf(e);s!==-1&&(i[s]=i[i.length-1],i.pop()),e.island=null}return!0},e.prototype.addConstraint=function(e){if(e.world)return!1;e.world=this,this.constraints.push(e),e.bodyA&&e.bodyA.constraints.push(e),e.bodyB&&e.bodyB.constraints.push(e);var t=!e.active;return e.active=!1,e.islandRoot=e,e.islandRank=0,t||this.wakeConstraint(e),!0},e.prototype.removeConstraint=function(e){if(e.world!==this)return!1;e.world=null;var t=this.constraints;t[t.indexOf(e)]=t[t.length-1],t.pop(),e.bodyA&&(t=e.bodyA.constraints,t[t.indexOf(e)]=t[t.length-1],t.pop()),e.bodyB&&(t=e.bodyA.constraints,t[t.indexOf(e)]=t[t.length-1],t.pop()),e.active&&(t=this.activeConstraints,t[t.indexOf(e)]=t[t.length-1],t.pop());var n=e.island;if(n){var r=n.constraints,i=r.indexOf(e);i!==-1&&(r[i]=r[r.length-1],r.pop()),e.island=null}return!0},e.prototype.flush=function(){while(this.rigidBodies.length>0)this.removeBody(this.rigidBodies[0]);while(this.collisionObjects.length>0)this.removeBody(this.collisionObjects[0]);while(this.kinematicBodies.length>0)this.removeBody(this.kinematicBodies[0]);while(this.constraints.length>0)this.removeConstraint(this.constraints[0]);this.timeStamp=0},e.prototype.removeArbitersFromObject=function(e){var t=e.arbiters,n=this.activeArbiters;while(t.length>0){var r=t.pop(),i=r.objectA===e?r.objectB.arbiters:r.objectA.arbiters;i[i.indexOf(r)]=i[i.length-1],i.pop(),r.active&&(n[n.indexOf(r)]=n[n.length-1],n.pop());while(r.contacts.length>0){var s=r.contacts.pop();nt.deallocate(s)}rt.deallocate(r)}},e.prototype.removeFromContactCallbacks=function(e){var t=this.contactCallbackObjects,n=t.length,r;for(r=0;r<n;r+=1)if(t[r]===e){n-=1,r<n&&(t[r]=t[n]),t.length=n;break}e.addedToContactCallbacks=!1},e.prototype.updateContactCallbacks=function(){var e=this.contactCallbackObjects,t=e.length,n=nt.publicContacts,r=nt.callbackContacts,i,s,o,u,a,f=0;while(f<t){var l=e[f],c=l.arbiters,h=c.length;if(0===h)l.contactCallbacks.added=!1,t-=1,f<t&&(e[f]=e[t]),e.length=t;else{var p,d;for(p=0;p<h;p+=1){i=c[p];if(0!==i.contactFlags){var v=i.contacts,m=v.length;while(n.length<m)n[n.length]=tt.create();r.length=m;for(d=0;d<m;d+=1){var g=n[d];g._private=v[d],r[d]=g}s=i.objectA,o=i.objectB,u=s.contactCallbacks,a=o.contactCallbacks,i.contactFlags&1&&(null!==u&&u.onAddedContacts&&u.onAddedContacts(s._public,o._public,r),null!==a&&a.onAddedContacts&&a.onAddedContacts(s._public,o._public,r)),i.contactFlags&2&&(null!==u&&u.onProcessedContacts&&u.onProcessedContacts(s._public,o._public,r),null!==a&&a.onProcessedContacts&&a.onProcessedContacts(s._public,o._public,r)),i.contactFlags&4&&(null!==u&&u.onRemovedContacts&&u.onRemovedContacts(s._public,o._public,r),null!==a&&a.onRemovedContacts&&a.onRemovedContacts(s._public,o._public,r)),i.contactFlags=0;for(d=0;d<m;d+=1)v[d][51]=0}}f+=1}}var y=this.contactCallbackRemovedArbiters;t=y.length,r.length=0;for(f=0;f<t;f+=1)i=y[f],s=i.objectA,o=i.objectB,u=s.contactCallbacks,a=o.contactCallbacks,null!==u&&u.onRemovedContacts&&u.onRemovedContacts(s._public,o._public,r),null!==a&&a.onRemovedContacts&&a.onRemovedContacts(s._public,o._public,r),rt.deallocate(i);y.length=0},e.version=1,e}(),ft=function(){function e(){this.vendor="Turbulenz",this.genObjectId=0}return e.create=function(){return new e},e.prototype.createDynamicsWorld=function(e){return ut.create(e)},e.prototype.createPlaneShape=function(e){return _.create(e)},e.prototype.createBoxShape=function(e){return H.create(e)},e.prototype.createSphereShape=function(e){return P.create(e)},e.prototype.createCapsuleShape=function(e){return D.create(e)},e.prototype.createCylinderShape=function(e){return B.create(e)},e.prototype.createConeShape=function(e){return j.create(e)},e.prototype.createTriangleMeshShape=function(e){return R.create(e)},e.prototype.createConvexHullShape=function(e){return U.create(e)},e.prototype.createTriangleArray=function(e){return F.create(e)},e.prototype.createCollisionObject=function(e){return W.create(e)},e.prototype.createRigidBody=function(e){return V.create(e)},e.prototype.createPoint2PointConstraint=function(e){return K.create(e)},e.prototype.createHingeConstraint=function(e){return $.create("HINGE",e)},e.prototype.createConeTwistConstraint=function(e){return $.create("CONETWIST",e)},e.prototype.create6DOFConstraint=function(e){return $.create("D6",e)},e.prototype.createSliderConstraint=function(e){return $.create("SLIDER",e)},e.prototype.createCharacter=function(e){return G.create(e)},e.version=1,e}();ft.prototype.FILTER_DYNAMIC=1,ft.prototype.FILTER_STATIC=2,ft.prototype.FILTER_KINEMATIC=4,ft.prototype.FILTER_DEBRIS=8,ft.prototype.FILTER_TRIGGER=16,ft.prototype.FILTER_CHARACTER=32,ft.prototype.FILTER_PROJECTILE=64,ft.prototype.FILTER_USER_MIN=128,ft.prototype.FILTER_USER_MAX=32768,ft.prototype.FILTER_ALL=65535;var lt=function(){function e(){}return e.prototype.destroy=function(){if(this.buffer)this.buffer=null;else if(this.audio){var e=this.audio.src;e.indexOf("blob:")===0&&URL.revokeObjectURL(e),this.audio=null}this.blob&&(this.blob=null)},e.audioLoaded=function(e,t){var n=e.audio;e.frequency=n.sampleRate||n.mozSampleRate||0,e.channels=n.channels||n.mozChannels||0,e.bitrate=e.frequency*e.channels*2*8,e.length=n.duration;if(n.buffered&&n.buffered.length){if(isNaN(e.length)||e.length===Number.POSITIVE_INFINITY)e.length=n.buffered.end(0);t&&(e.length?t(e,200):t(null,0),t=null)}else{var r=function(){n.pause(),n.removeEventListener("play",r,!1),n.volume=1,t&&(t(e,200),t=null)};n.addEventListener("play",r,!1),n.volume=0,n.play()}},e.create=function(t,n){var r=new e,i=n.src;r.name=n.name||i,r.frequency=0,r.channels=0,r.bitrate=0,r.length=0,r.compressed=!n.uncompress;var s=n.onload,o=n.data,u,a,f,l=t.audioContext;if(l&&(r.forceUncompress||n.uncompress)){var c;if(i){if(!t.isResourceSupported(i))return s&&s(null,0),null;var h=function(t){t?(r.buffer=t,r.frequency=t.sampleRate,r.channels=t.numberOfChannels,r.bitrate=r.frequency*r.channels*2*8,r.length=t.duration,s&&s(r,200)):s&&s(null,0)},p=function(){s&&s(null,0)};if(o)l.decodeAudioData?l.decodeAudioData(o,h,p):(c=l.createBuffer(o,!1),h(c));else{var d;if(window.XMLHttpRequest)d=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return s&&s(null,0),null;d=new window.ActiveXObject("Microsoft.XMLHTTP")}d.onreadystatechange=function(){if(d.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=d.status,t=e!==0&&d.statusText||"No connection",n=d.response;if(d.getAllResponseHeaders()===""&&!n)s&&s(null,0);else if(e===200||e===0)if(l.decodeAudioData)l.decodeAudioData(n,h,p);else{var r=l.createBuffer(n,!1);h(r)}else s&&s(null,e)}d.onreadystatechange=null,d=null}},d.open("GET",i,!0),d.responseType="arraybuffer",d.setRequestHeader("Content-Type","text/plain"),d.send(null)}return r}if(o){u=o.length,a=n.channels||1,f=n.frequency;var v=Math.min(l.sampleRate,96e3),m,g,y,b;if(v===f){c=l.createBuffer(a,u/a,f);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(y=m,b=0;y<u;y+=a,b+=1)g[b]=o[y]}}else{var w=f/v,E=u/(w*a)|0;c=l.createBuffer(a,E,v);for(m=0;m<a;m+=1){g=c.getChannelData(m);for(b=0;b<E;b+=1)g[b]=o[m+(b*w|0)*a]}}if(c)return r.buffer=c,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),s&&s(r,200),r}}else{var S;if(i){var x=i.slice(-3);S=new Audio,S.preload="auto",S.autobuffer=!0,S.onerror=function(){s&&(s(null,0),s=null)},r.audio=S;var T=function(){return 3<=S.readyState?(e.audioLoaded(r,s),!0):!1};if(o){var N;o instanceof Uint8Array?N=o:N=new Uint8Array(o);if(typeof Blob!="undefined"&&typeof URL!="undefined"&&URL.createObjectURL){var C;N[0]===79&&N[1]===103&&N[2]===103&&N[3]===83?(x="ogg",C=new Blob([N],{type:"audio/ogg"})):N[0]===82&&N[1]===73&&N[2]===70&&N[3]===70?(x="wav",C=new Blob([N],{type:"audio/wav"})):(x="mp3",C=new Blob([N],{type:"audio/mpeg"})),r.blob=C,i=URL.createObjectURL(C)}else N[0]===79&&N[1]===103&&N[2]===103&&N[3]===83?(x="ogg",i="data:audio/ogg;base64,"):N[0]===82&&N[1]===73&&N[2]===70&&N[3]===70?(x="wav",i="data:audio/wav;base64,"):(x="mp3",i="data:audio/mpeg;base64,"),i+=TurbulenzEngine.base64Encode(N)}else if(typeof URL!="undefined"&&URL.createObjectURL){if(!t.supportedExtensions[x])return s&&s(null,0),null;var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(d.readyState===4)if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=d.status;e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200),d.getAllResponseHeaders()===""&&!d.response?s&&s(null,0):e===200||e===0?(r.blob=d.response,r.blob.type==="audio/x-mpg"&&(r.blob=r.blob.slice(0,r.blob.size,"audio/mpeg")),S.src=URL.createObjectURL(r.blob),t.addLoadingSound(T)):s&&s(null,e),d.onreadystatechange=null,d=null}},d.open("GET",i,!0),d.responseType="blob",d.send(),r}return t.supportedExtensions[x]?(S.src=i,t.addLoadingSound(T),r):(s&&s(null,0),null)}if(o){S=new Audio;if(S.mozSetup)return u=o.length,a=n.channels||1,f=n.frequency,S.mozSetup(a,f),r.data=o,r.frequency=f,r.channels=a,r.bitrate=f*a*2*8,r.length=u/(f*a),r.audio=S,s&&s(r,200),r;S=null}}return s&&s(null,0),null},e.version=1,e}(),ct=function(){function e(){}return e.prototype.play=function(e,t){t===undefined&&(t=0);if(this.sound===e)return this.seek(t);this.playing&&this._stop(),this.sound=e;var n=e.audio;if(n){e.data?(n=new Audio,n.mozSetup(e.channels,e.frequency)):n=n.cloneNode(!0),this.audio=n,n.loop=this.looping,n.addEventListener("ended",this.loopAudio,!1);if(.05<t)try{n.currentTime=t}catch(r){}}var i=this.audioContext;if(i)if(n)this.createMediaNode(e,n);else{var s=this.createBufferNode(e);if(0<t){var o=e.buffer;s.loop?s.start(0,t,o.duration):s.start(0,t,o.duration-t),this.playStart=i.currentTime-t}else s.start(0),this.playStart=i.currentTime}return n&&(e.data?n.mozWriteAudio(e.data):(this.updateAudioVolume(),n.play())),this.playing=!0,this.paused=!1,this.sd.addPlayingSource(this),!0},e.prototype._stop=function(){this.playing=!1,this.paused=!1,this.sound=null;var e=this.audio;if(e){this.audio=null;var t=this.mediaNode;t&&(this.mediaNode=null,t.disconnect()),e.pause(),e.removeEventListener("ended",this.loopAudio,!1)}else{var n=this.bufferNode;n&&(this.bufferNode=null,n.stop(0),n.disconnect())}},e.prototype.stop=function(){var e=this.playing;return e&&(this._stop(),this.sd.removePlayingSource(this)),e},e.prototype.pause=function(){if(this.playing){if(!this.paused){this.paused=!0;var e=this.audio;if(e)e.pause();else{var t=this.bufferNode;t&&(this.bufferNode=null,this.playPaused=this.audioContext.currentTime,t.stop(0),t.disconnect())}this.sd.removePlayingSource(this)}return!0}return!1},e.prototype.resume=function(e){if(this.paused){this.paused=!1;var t=this.audio;if(t){if(e!==undefined&&.05<Math.abs(t.currentTime-e))try{t.currentTime=e}catch(n){}t.play()}else{var r=this.audioContext;if(r){e===undefined&&(e=this.playPaused-this.playStart);var i=this.createBufferNode(this.sound);if(0<e){var s=this.sound.buffer;i.loop?i.start(0,e,s.duration):i.start(0,e,s.duration-e),this.playStart=r.currentTime-e}else i.start(0),this.playStart=r.currentTime}}return this.sd.addPlayingSource(this),!0}return!1},e.prototype.rewind=function(){if(this.playing){var e=this.audio;if(e)return e.currentTime=0,!0;var t=this.audioContext;if(t){var n=this.bufferNode;return n&&(n.stop(0),n.disconnect()),n=this.createBufferNode(this.sound),n.start(0),this.playStart=t.currentTime,!0}}return!1},e.prototype.seek=function(e){if(this.playing){var t=this.tell,n=Math.abs(t-e);this.looping&&(n=Math.min(Math.abs(t-(this.sound.length+e)),n));if(.05<n){var r=this.audio;if(r)try{r.currentTime=e}catch(i){}else{var s=this.audioContext;if(s){var o=this.bufferNode;o&&(o.stop(0),o.disconnect()),o=this.createBufferNode(this.sound);if(0<e){var u=this.sound.buffer;o.loop?o.start(0,e,u.duration):o.start(0,e,u.duration-e),this.playStart=s.currentTime-e}else o.start(0),this.playStart=s.currentTime}}}return!0}return!1},e.prototype.clear=function(){this.stop()},e.prototype.setAuxiliarySendFilter=function(e,t,n){return!1},e.prototype.setDirectFilter=function(e){return!1},e.prototype.destroy=function(){this.stop();var e=this.gainNode;e&&(this.gainNode=null,e.disconnect());var t=this.pannerNode;t&&(this.pannerNode=null,t.disconnect())},e.prototype.updateRelativePositionWebAudio=function(e,t,n){var r=this._position;this.pannerNode.setPosition(r[0]+e,r[1]+t,r[2]+n)},e.prototype.updateRelativePositionHTML5=function(e,t,n){var r=this.minDistance,i=this.maxDistance,s=this._position,o=s[0],u=s[1],a=s[2],f;if(this.relative)f=o*o+u*u+a*a;else{var l=e-o,c=t-u,h=n-a;f=l*l+c*c+h*h}var p;if(f<=r*r)p=1;else if(f>=i*i)p=0;else{var d=Math.sqrt(f);this.sd.linearDistance?p=(i-d)/(i-r):p=r/(r+this.rollOff*(d-r))}p*=this.sd.listenerGain,this.gainFactor!==p&&(this.gainFactor=p,this.updateAudioVolume())},e.prototype.createBufferNode=function(e){var t=e.buffer,n=this.audioContext.createBufferSource();return n.buffer=t,n.loop=this.looping,n.playbackRate&&(n.playbackRate.value=this.pitch),n.connect(this.gainNode),n.start||(n.start=function(t,n,r){arguments.length<=1?this.noteOn(t):this.noteGrainOn(t,n,r)}),n.stop||(n.stop=function(t){this.noteOff(t)}),this.bufferNode=n,n},e.prototype.createMediaNode=function(e,t){var n=this.audioContext.createMediaElementSource(t);n.connect(this.gainNode),this.mediaNode=n},e.create=function(n,r,i){var s=new e;s.sd=n,s.id=r,s.sound=null,s.audio=null,s.playing=!1,s.paused=!1;var o=new Float32Array(9);s._position=o.subarray(0,3),s._velocity=o.subarray(3,6),s._direction=o.subarray(6,9);var u=typeof i.gain=="number"?i.gain:1,a=i.looping||!1,f=i.pitch||1,l=n.audioContext;if(l){s.bufferNode=null,s.mediaNode=null,s.playStart=-1,s.playPaused=-1;var c=n.gainNode,h=l.createPanner();s.pannerNode=h,h.connect(c);var p=l.createGain?l.createGain():l.createGainNode();p.gain.value=u,s.gainNode=p,p.connect(h),n.linearDistance&&(typeof h.distanceModel=="string"?h.distanceModel="linear":typeof h.LINEAR_DISTANCE=="number"&&(h.distanceModel=h.LINEAR_DISTANCE)),typeof h.panningModel=="string"?h.panningModel="equalpower":h.panningModel=h.EQUALPOWER,s.updateRelativePosition=s.updateRelativePositionWebAudio,Object.defineProperty(s,"position",{get:function(){return this._position.slice()},set:function(t){var n=this._position;if(n[0]!==t[0]||n[1]!==t[1]||n[2]!==t[2])n[0]=t[0],n[1]=t[1],n[2]=t[2],this.relative||this.pannerNode.setPosition(t[0],t[1],t[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return this._direction.slice()},set:function(n){this._direction=t.v3Copy(n,this._direction),this.pannerNode.setOrientation(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return this._velocity.slice()},set:function(n){this._velocity=t.v3Copy(n,this._velocity),this.pannerNode.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return u},set:function(t){u!==t&&(u=t,this.gainNode.gain.value=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"looping",{get:function(){return a},set:function(t){a=t;var n=this.audio;if(n)n.loop=t;else{var r=this.bufferNode;r&&(r.loop=t)}},enumerable:!0,configurable:!1}),Object.defineProperty(s,"pitch",{get:function(){return f},set:function(t){f=t;var n=this.audio;if(n)n.playbackRate=t;else{var r=this.bufferNode;r&&r.playbackRate&&(r.playbackRate.value=t)}},enumerable:!0,configurable:!1}),Object.defineProperty(s,"tell",{get:function(){if(this.playing){var t=this.audio;return t?t.currentTime:this.paused?this.playPaused-this.playStart:l.currentTime-this.playStart}return 0},enumerable:!0,configurable:!1}),Object.defineProperty(s,"minDistance",{get:function(){return h.refDistance},set:function(t){this.pannerNode.maxDistance===t&&(t=this.pannerNode.maxDistance*.999),this.pannerNode.refDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"maxDistance",{get:function(){return h.maxDistance},set:function(t){this.pannerNode.refDistance===t&&(t=this.pannerNode.refDistance*1.001),this.pannerNode.maxDistance=t},enumerable:!0,configurable:!1}),Object.defineProperty(s,"rollOff",{get:function(){return h.rolloffFactor},set:function(t){this.pannerNode.rolloffFactor=t},enumerable:!0,configurable:!1}),s.loopAudio=function(){s.stop()}}else s.gainFactor=1,s.updateAudioVolume=function(){var t=this.audio;if(t){var n=Math.min(this.gainFactor*u,1);t.volume=n,0>=n?t.muted=!0:t.muted=!1}},s.updateRelativePosition=s.updateRelativePositionHTML5,Object.defineProperty(s,"position",{get:function(){return this._position.slice()},set:function(n){this._position=t.v3Copy(n,this._position)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"direction",{get:function(){return this._direction.slice()},set:function(n){this._direction=t.v3Copy(n,this._direction)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"velocity",{get:function(){return this._velocity.slice()},set:function(n){this._velocity=t.v3Copy(n,this._velocity)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"gain",{get:function(){return u},set:function(t){u=t,this.updateAudioVolume()},enumerable:!0,configurable:!1}),n.loopingSupported?(Object.defineProperty(s,"looping",{get:function(){return a},set:function(t){a=t;var n=this.audio;n&&(n.loop=t)},enumerable:!0,configurable:!1}),s.loopAudio=function(){s.stop()}):(s.looping=a,s.loopAudio=function(){var t=s.audio;t&&(this.looping?(t.currentTime=0,t.play()):s.stop())}),Object.defineProperty(s,"pitch",{get:function(){return f},set:function(t){f=t;var n=this.audio;n&&(n.playbackRate=t)},enumerable:!0,configurable:!1}),Object.defineProperty(s,"tell",{get:function(){if(this.playing){var t=this.audio;if(t)return t.currentTime}return 0},enumerable:!0,configurable:!1});return s.relative=i.relative||!1,s.minDistance=i.minDistance||1,s.maxDistance=i.maxDistance||3.402823466e38,s.rollOff=i.rollOff||1,i.position&&(s.position=i.position),i.velocity&&(s.velocity=i.velocity),i.direction&&(s.direction=i.direction),s},e.version=1,e}(),ht=function(){function e(){}return e.prototype.createSource=function(e){return this.lastSourceID+=1,ct.create(this,this.lastSourceID,e)},e.prototype.createSound=function(e){return lt.create(this,e)},e.prototype.loadSoundsArchive=function(e){var t=e.src;return typeof pt!="undefined"?(pt.create({sd:this,src:t,uncompress:e.uncompress,onsoundload:function(n){e.onsoundload(n)},onload:function(n,r){e.onload&&e.onload(n,r)},onerror:function(n){e.onload&&e.onload(!1,n)}}),!0):(TurbulenzEngine.callOnError("Missing archive loader required for "+t),!1)},e.prototype.createEffect=function(e){return null},e.prototype.createEffectSlot=function(e){return null},e.prototype.createFilter=function(e){return null},e.prototype.update=function(){var e=this.listenerTransform,t=e[9],n=e[10],r=e[11],i=this.numPlayingSources,s=this.playingSources,o;for(o=0;o<i;o+=1)s[o].updateRelativePosition
(t,n,r)},e.prototype.isSupported=function(e){return"FILEFORMAT_OGG"===e?this.supportedExtensions.ogg:"FILEFORMAT_MP3"===e?this.supportedExtensions.mp3:"FILEFORMAT_WAV"===e?this.supportedExtensions.wav:!1},e.prototype.addLoadingSound=function(e){var t=this.loadingSounds;t[t.length]=e;var n=this.loadingInterval,r=this;n===null&&(this.loadingInterval=n=window.setInterval(function(){var i=t.length,s=0;do{var o=t[s];o()?(i-=1,s<i&&(t[s]=t[i]),t.length=i):s+=1}while(s<i);i===0&&(window.clearInterval(n),r.loadingInterval=null)},100))},e.prototype.addPlayingSource=function(e){var t=e.id;if(!this.playingSourcesMap[t]){this.playingSourcesMap[t]=!0;var n=this.numPlayingSources;this.playingSources[n]=e,this.numPlayingSources=n+1}},e.prototype.removePlayingSource=function(e){delete this.playingSourcesMap[e.id];var t=this.numPlayingSources,n=this.playingSources,r;for(r=0;r<t;r+=1)if(n[r]===e){t-=1,n[r]=n[t],n[t]=null,this.numPlayingSources=t;break}},e.prototype.isResourceSupported=function(e){var t=e.slice(-3).toLowerCase();return this.supportedExtensions[t]},e.prototype.destroy=function(){var e=this.loadingInterval;e!==null&&(window.clearInterval(e),this.loadingInterval=null);var t=this.loadingSounds;t&&(t.length=0,this.loadingSounds=null);var n=this.numPlayingSources,r=this.playingSources,i;for(i=0;i<n;i+=1)r[i]._stop();this.numPlayingSources=0,this.playingSources=null,this.playingSourcesMap=null,lt.prototype.audioContext=null,ct.prototype.audioContext=null},e.create=function(n){var r=new e;r.extensions="",r.renderer="HTML5 Audio",r.alcVersion="0",r.alcExtensions="",r.alcEfxVersion="0",r.alcMaxAuxiliarySends=0,r.deviceSpecifier=n.deviceSpecifier||null,r.frequency=n.frequency||44100,r.dopplerFactor=n.dopplerFactor||1,r.dopplerVelocity=n.dopplerVelocity||1,r.speedOfSound=n.speedOfSound||343.29998779296875,r.linearDistance=n.linearDistance!==undefined?n.linearDistance:!0,r.loadingSounds=[],r.loadingInterval=null,r.numPlayingSources=0,r.playingSources=[],r.playingSourcesMap={},r.lastSourceID=0;var i;r.deviceSpecifier!=="audioelement"&&(i=window.AudioContext||window.webkitAudioContext);if(i){var s;try{s=new i}catch(o){return TurbulenzEngine.callOnError("Failed to create AudioContext:"+o),null}if(s.sampleRate===0)return null;lt.prototype.forceUncompress=!0,lt.prototype.audioContext=s,ct.prototype.audioContext=s,r.renderer="WebAudio",r.audioContext=s,r.frequency=s.sampleRate,r.gainNode=s.createGain?s.createGain():s.createGainNode(),r.gainNode.connect(s.destination);var u=s.listener;u.dopplerFactor=r.dopplerFactor,u.speedOfSound=r.speedOfSound;var a,f;Object.defineProperty(r,"listenerTransform",{get:function(){return a.slice()},set:function(n){a=t.m43Copy(n,a);var r=n[9],i=n[10],s=n[11];u.setPosition(r,i,s),u.setOrientation(-n[6],-n[7],-n[8],n[3],n[4],n[5])},enumerable:!0,configurable:!1}),Object.defineProperty(r,"listenerVelocity",{get:function(){return f.slice()},set:function(n){f=t.v3Copy(n,f),u.setVelocity(n[0],n[1],n[2])},enumerable:!0,configurable:!1}),r.update=function(){this.gainNode.gain.value=this.listenerGain;var t=a[9],n=a[10],r=a[11],i=this.numPlayingSources,o=this.playingSources,u=this.playingSourcesMap,f=s.currentTime,l=0;while(l<i){var c=o[l],h=c.bufferNode;if(h){var p=f-c.playStart,d=h.buffer.duration;if(d<p){if(!c.looping){h.disconnect(),c.playing=!1,c.sound=null,c.bufferNode=null,i-=1,o[l]=o[i],o[i]=null,delete u[c.id];continue}c.playStart=f-(p-d)}}c.relative&&c.updateRelativePosition(t,n,r),l+=1}this.numPlayingSources=i,i<o.length>>1&&(o.length=i)}}else lt.prototype.forceUncompress=!1;r.listenerTransform=n.listenerTransform||t.m43BuildIdentity(),r.listenerVelocity=n.listenerVelocity||t.v3BuildZero(),r.listenerGain=typeof n.listenerGain=="number"?n.listenerGain:1;var l;try{l=new Audio}catch(o){return TurbulenzEngine.callOnError("Failed to create Audio:"+o),null}if(r.audioContext)r.loopingSupported=!0;else{if(l.mozSetup)try{l.mozSetup(1,22050)}catch(c){return null}r.loopingSupported=typeof l.loop=="boolean"}var h={ogg:!1,mp3:!1,wav:!1};return l.canPlayType("application/ogg")&&(h.ogg=!0),l.canPlayType("audio/mp3")&&(h.mp3=!0),l.canPlayType("audio/wav")&&(h.wav=!0),r.supportedExtensions=h,l=null,r},e.version=1,e}();ht.prototype.vendor="Turbulenz",typeof ArrayBuffer!="undefined"&&ArrayBuffer.prototype!==undefined&&ArrayBuffer.prototype.slice===undefined&&(ArrayBuffer.prototype.slice=function(t,n){var r=this.byteLength;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Uint8Array(this,t,r),s=new Uint8Array(i);return s.buffer}return new ArrayBuffer(0)});var pt=function(){function e(){}return e.prototype.processBytes=function(e){function r(e){t+=e}function i(n){var r=t,i=r+n,s=e[r],o;if(s&&0<n){r+=1;var u=new Array(n),a=0;do u[a]=s,a+=1,s=e[r],r+=1;while(s&&a<n);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return t=i,o}function s(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function u(e){e.fileName=i(100),r(8),r(8),r(8),e.length=s(i(12)),r(12),r(8),e.fileType=i(1),r(100),e.ustarSignature=i(6),r(2),r(32),r(32),r(8),r(8),e.fileNamePrefix=i(155),t+=12}function p(e){h.soundsLoading-=1,e?l(e):c=!1}var t=0,n=e.length,o={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},a=this.sd,f=this.uncompress,l=this.onsoundload,c=!0;this.soundsLoading=0;var h=this;while(t+512<=n){u(o);if(0<o.length){var d;o.fileName==="././@LongLink"?(d=i(256),t+=256,u(o)):o.fileNamePrefix&&o.ustarSignature==="ustar"?d=o.fileNamePrefix+o.fileName:d=o.fileName;if(""===o.fileType||"0"===o.fileType)this.soundsLoading+=1,a.createSound({src:d,data:a.audioContext?e.buffer.slice(t,t+o.length):e.subarray(t,t+o.length),uncompress:f,onload:p});t+=Math.floor((o.length+511)/512)*512}}return e=null,c},e.prototype.isValidHeader=function(e){return!0},e.create=function(t){var n=new e;n.sd=t.sd,n.uncompress=t.uncompress,n.onsoundload=t.onsoundload,n.onload=t.onload,n.onerror=t.onerror,n.soundsLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length,a;s=[],s.length=u;for(a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}var f=n.processBytes(new Uint8Array(s));if(n.onload){var l=function(){0<n.soundsLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(l,100):n.onload(f,e)};l()}}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),typeof i.responseType=="string"||i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},e.version=1,e}(),dt=function(){function e(){}return e.prototype.processBytes=function(e){function r(e){t+=e}function i(n){var r=t,i=r+n,s=e[r],o;if(s&&0<n){r+=1;var u=new Array(n),a=0;do u[a]=s,a+=1,s=e[r],r+=1;while(s&&a<n);while(u[a-1]===32)a-=1;u.length=a,o=String.fromCharCode.apply(null,u)}else o="";return t=i,o}function s(e){return e=e.replace(/[^\d]/g,""),parseInt("0"+e,8)}function u(e){e.fileName=i(100),r(8),r(8),r(8),e.length=s(i(12)),r(12),r(8),e.fileType=i(1),r(100),e.ustarSignature=i(6),r(2),r(32),r(32),r(8),r(8),e.fileNamePrefix=i(155),t+=12}function p(e){h.texturesLoading-=1,e?l(e):(t=n,c=!1)}var t=0,n=e.length,o={fileName:null,length:0,fileType:null,ustarSignature:null,fileNamePrefix:null},a=this.gd,f=this.mipmaps,l=this.ontextureload,c=!0;this.texturesLoading=0;var h=this;while(t+512<=n){u(o);if(0<o.length){var d;o.fileName==="././@LongLink"?(d=i(256),t+=256,u(o)):o.fileNamePrefix&&o.ustarSignature==="ustar"?d=o.fileNamePrefix+o.fileName:d=o.fileName;if(""===o.fileType||"0"===o.fileType)this.texturesLoading+=1,a.createTexture({src:d,data:e.subarray(t,t+o.length),mipmaps:f,onload:p});t+=Math.floor((o.length+511)/512)*512}}return e=null,c},e.prototype.isValidHeader=function(){return!0},e.create=function(t){var n=new e;n.gd=t.gd,n.mipmaps=t.mipmaps,n.ontextureload=t.ontextureload,n.onload=t.onload,n.onerror=t.onerror,n.texturesLoading=0;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length;s=[],s.length=u;for(var a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}if(n.processBytes(new Uint8Array(s))){if(n.onload){var f=function(){0<n.texturesLoading?(!TurbulenzEngine||!TurbulenzEngine.isUnloading())&&window.setTimeout(f,100):n.onload(!0,e)};f()}}else n.onerror&&n.onerror(e)}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),typeof i.responseType=="string"||i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}return n},e.version=1,e}(),vt=function(){function e(){}return e.prototype.processBytes=function(e){var t=this.parseHeader(e);if(!this.isValidHeader(t))return;var n=18;this.width=t.width,this.height=t.height,this.bytesPerPixel=Math.floor(t.bpp/8),this.horzRev=t.descriptor&this.DESC_HORIZONTAL,this.vertRev=!(t.descriptor&this.DESC_VERTICAL);var r=!1,i=this.gd;switch(t.imageType){case this.TYPE_MAPPED_RLE:r=!0,t.colorMapSize>24?this.format=i.PIXELFORMAT_R8G8B8A8:t.colorMapSize>16?this.format=i.PIXELFORMAT_R8G8B8:this.format=i.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_MAPPED:t.colorMapSize>24?this.format=i.PIXELFORMAT_R8G8B8A8:t.colorMapSize>16?this.format=i.PIXELFORMAT_R8G8B8:this.format=i.PIXELFORMAT_R5G5B5A1;break;case this.TYPE_GRAY_RLE:r=!0,this.format=i.PIXELFORMAT_L8;break;case this.TYPE_GRAY:this.format=i.PIXELFORMAT_L8;break;case this.TYPE_COLOR_RLE:r=!0;switch(this.bytesPerPixel){case 4:this.format=i.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=i.PIXELFORMAT_R8G8B8;break;case 2:this.format=i.PIXELFORMAT_R5G5B5A1;break;default:return}break;case this.TYPE_COLOR:switch(this.bytesPerPixel){case 4:this.format=i.PIXELFORMAT_R8G8B8A8;break;case 3:this.format=i.PIXELFORMAT_R8G8B8;break;case 2:this.format=i.PIXELFORMAT_R5G5B5A1;break;default:return}break;default:return}if(t.idLength){n+=t.idLength;if(n>e.length)return}if(this.TYPE_MAPPED_RLE===t.imageType||this.TYPE_MAPPED===t.imageType){if(t.colorMapType!==1)return}else if(t.colorMapType!==0)return;if(t.colorMapType===1){var s=t.colorMapIndex,o=t.colorMapLength;if(o===0)return;var u=Math.floor(t.colorMapSize/8),a=o+s,f=[];f.length=a*u,this.colorMap=f,this.colorMapBytesPerPixel=u;var l;for(l=0;l<s*u;l+=1)f[l]=0;for(l=s*u;l<s*u;l+=1,n+=1)f[l]=e[n];n+=o*u;if(n>e.length)return;if(u>=3)for(l=s*u;l<o*u;l+=u){var c=f[l];f[l]=f[l+2],f[l+2]=c}}var h=e.subarray(n);e=null,r&&(h=this.expandRLE(h));var p=this.width*this.height*this.bytesPerPixel;if(h.length<p)return;this.horzRev&&this.flipHorz(h),this.vertRev&&this.flipVert(h),this.colorMap?h=this.expandColorMap(h):2<this.bytesPerPixel?this.convertBGR2RGB(h):2===this.bytesPerPixel&&(h=this.convertARGB2RGBA(h)),this.data=h},e.prototype.parseHeader=function(e){var t={idLength:e[0],colorMapType:e[1],imageType:e[2],colorMapIndex:e[4]<<8|e[3],colorMapLength:e[6]<<8|e[5],colorMapSize:e[7],xOrigin:e[9]<<8|e[8],yOrigin:e[11]<<8|e[10],width:e[13]<<8|e[12],height:e[15]<<8|e[14],bpp:e[16],descriptor:e[17]};return t},e.prototype.isValidHeader=function(e){if(this.TYPE_MAPPED_RLE===e.imageType||this.TYPE_MAPPED===e.imageType){if(e.colorMapType!==1)return!1}else if(e.colorMapType!==0)return!1;if(e.colorMapType===1&&e.colorMapLength===0)return!1;switch(e.imageType){case this.TYPE_MAPPED_RLE:case this.TYPE_MAPPED:break;case this.TYPE_GRAY_RLE:case this.TYPE_GRAY:break;case this.TYPE_COLOR_RLE:case this.TYPE_COLOR:switch(Math.floor(e.bpp/8)){case 4:case 3:case 2:break;default:return!1}break;default:return!1}return 16384<e.width?!1:16384<e.height?!1:!0},e.prototype.expandRLE=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=t,s=n*r*t,o=this.RLE_PACKETSIZE,u=new Uint8Array(s),a=0,f=0,l,c;do{var h=e[a];a+=1;var p=((h&~o)+1)*i;if(h&o)if(i===1){var d=e[a];a+=1;for(l=0;l<p;l+=1)u[f+c]=d}else{for(l=0;l<i;l+=1)u[f+l]=e[a+l];a+=i;for(c=i;c<p;c+=i)for(l=0;l<i;l+=1)u[f+c+l]=u[f+l]}else{for(l=0;l<p;l+=1)u[f+l]=e[a+l];a+=p}f+=p}while(f<s);return u},e.prototype.expandColorMap=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=n*r*t,s=new Uint8Array(i),o=0,u=0,a=this.colorMap;delete this.colorMap;if(t===2||t===3||t===4)do{var f=e[u]*t;u+=1;for(var l=0;l<t;l+=1)s[o]=a[f+l],o+=1}while(o<i);return t===2&&(s=this.convertARGB2RGBA(s)),s},e.prototype.flipHorz=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=Math.floor(n/2),s=n*t;for(var o=0;o<r;o+=1){for(var u=0;u<i;u+=1)for(var a=0;a<t;a+=1){var f=e[u*t+a];e[u*t+a]=e[(n-u-1)*t+a],e[(n-u-1)*t+a]=f}e+=s}},e.prototype.flipVert=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=Math.floor(r/2),s=n*t;for(var o=0;o<i;o+=1){var u=o*s,a=(r-o-1)*s;for(var f=0;f<s;f+=1){var l=e[u+f];e[u+f]=e[a+f],e[a+f]=l}}},e.prototype.convertBGR2RGB=function(e){var t=this.bytesPerPixel,n=this.width,r=this.height,i=n*r*t,s=0;do{var o=e[s];e[s]=e[s+2],e[s+2]=o,s+=t}while(s<i)},e.prototype.convertARGB2RGBA=function(e){var t=this.bytesPerPixel;if(t===2){var n=this.width,r=this.height,i=n*r*t,s=new Uint16Array(n*r),o=0,u=0,a,f,l,c,h=31,p=h,d=h<<5,v=h<<10;do{var m=o[1]<<8|o[0];o+=2,l=(m&p)<<1,f=(m&d)<<1,a=(m&v)<<1,c=m>>15,s[u]=a|f|l|c,u+=1}while(o<i);return s}return e},e.create=function(t){var n=new e;n.gd=t.gd,n.onload=t.onload,n.onerror=t.onerror;var r=t.src;if(r){n.src=r;var i;if(window.XMLHttpRequest)i=new window.XMLHttpRequest;else{if(!window.ActiveXObject)return t.onerror&&t.onerror(0),null;i=new window.ActiveXObject("Microsoft.XMLHTTP")}i.onreadystatechange=function(){if(i.readyState===4){if(!TurbulenzEngine||!TurbulenzEngine.isUnloading()){var e=i.status,t=i.status!==0&&i.statusText||"No connection";e===0&&(window.location.protocol==="file:"||window.location.protocol==="chrome-extension:")&&(e=200);if(i.getAllResponseHeaders()===""){var r;i.responseType==="arraybuffer"?r=!i.response:i.mozResponseArrayBuffer?r=!i.mozResponseArrayBuffer:r=!i.responseText;if(r){n.onerror&&n.onerror(0),i.onreadystatechange=null,i=null;return}}if(e===200||e===0){var s;if(i.responseType==="arraybuffer")s=i.response;else if(i.mozResponseArrayBuffer)s=i.mozResponseArrayBuffer;else{var o=i.responseText,u=o.length;s=[],s.length=u;for(var a=0;a<u;a+=1)s[a]=o.charCodeAt(a)&255}n.processBytes(new Uint8Array(s)),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,e):n.onerror&&n.onerror(e)}else n.onerror&&n.onerror(e)}i.onreadystatechange=null,i=null}},i.open("GET",t.src,!0),typeof i.responseType=="string"||i.hasOwnProperty&&i.hasOwnProperty("responseType")?i.responseType="arraybuffer":i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Content-Type","text/plain; charset=x-user-defined"),i.send(null)}else n.processBytes(t.data),n.data?n.onload&&n.onload(n.data,n.width,n.height,n.format,200):n.onerror&&n.onerror(0);return n},e.version=1,e}();vt.prototype.TYPE_MAPPED=1,vt.prototype.TYPE_COLOR=2,vt.prototype.TYPE_GRAY=3,vt.prototype.TYPE_MAPPED_RLE=9,vt.prototype.TYPE_COLOR_RLE=10,vt.prototype.TYPE_GRAY_RLE=11,vt.prototype.DESC_ABITS=15,vt.prototype.DESC_HORIZONTAL=16,vt.prototype.DESC_VERTICAL=32,vt.prototype.SIGNATURE="TRUEVISION-XFILE",vt.prototype.RLE_PACKETSIZE=128;var mt=function(){function e(){}return e.create=function(t){var n=new e;return n.force=t.force,n.identifier=t.identifier,n.isGameTouch=t.isGameTouch,n.positionX=t.positionX,n.positionY=t.positionY,n.radiusX=t.radiusX,n.radiusY=t.radiusY,n.rotationAngle=t.rotationAngle,n},e}(),gt=function(){function e(){}return e.create=function(t){var n=new e;return n.changedTouches=t.changedTouches,n.gameTouches=t.gameTouches,n.touches=t.touches,n},e}(),yt=function(){function e(){this.version="0.28.0.0"}return e.prototype.setInterval=function(e,t){var n=this;return window.setInterval(function(){n.updateTime(),e()},t)},e.prototype.clearInterval=function(e){window.clearInterval(e)},e.prototype.createGraphicsDevice=function(e){if(this.graphicsDevice)return this.callOnError("GraphicsDevice already created"),null;var t=N.create(this.canvas,e);return this.graphicsDevice=t,t},e.prototype.createPhysicsDevice=function(e){if(this.physicsDevice)return this.callOnError("PhysicsDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createPhysicsDevice(e):t=ft.create(),this.physicsDevice=t,t},e.prototype.createSoundDevice=function(e){if(this.soundDevice)return this.callOnError("SoundDevice already created"),null;var t,n=this.getPluginObject();return n?t=n.createSoundDevice(e):t=ht.create(e),this.soundDevice=t,t},e.prototype.createInputDevice=function(e){if(this.inputDevice)return this.callOnError("InputDevice already created"),null;var t=C.create(this.canvas);return this.inputDevice=t,t},e.prototype.createNetworkDevice=function(e){if(this.networkDevice)throw"NetworkDevice already created";var t=k.create(e);return this.networkDevice=t,t},e.prototype.createMathDevice=function(e){try{var n=new Float32Array([1,2,3]);t.v3Build.apply(t,n),n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0]}catch(r){}return WebGLMathDevice},e.prototype.createNativeMathDevice=function(e){return WebGLMathDevice},e.prototype.getGraphicsDevice=function(){var e=this.graphicsDevice;return e===null&&this.callOnError("GraphicsDevice not created yet."),e},e.prototype.getPhysicsDevice=function(){return this.physicsDevice},e.prototype.getSoundDevice=function(){return this.soundDevice},e.prototype.getInputDevice=function(){return this.inputDevice},e.prototype.getNetworkDevice=function(){return this.networkDevice},e.prototype.getMathDevice=function(){return WebGLMathDevice},e.prototype.getNativeMathDevice=function(){return WebGLMathDevice},e.prototype.getObjectStats=function(){return null},e.prototype.flush=function(){},e.prototype.run=function(){},e.prototype.encrypt=function(e){return e},e.prototype.decrypt=function(e){return e},e.prototype.generateSignature=function(e){return null},e.prototype.verifySignature=function(e,t){return!0},e.prototype.onerror=function(e){console.error(e)},e.prototype.onwarning=function(e){console.warn(e)},e.prototype.onperformancewarning=function(e){},e.prototype.getSystemInfo=function(){return this.systemInfo},e.prototype.request=function(e,t){var n=this,r;if(window.XMLHttpRequest)r=new window.XMLHttpRequest;else{if(!window.ActiveXObject){n.callOnError("No XMLHTTPRequest object could be created");return}r=new window.ActiveXObject("Microsoft.XMLHTTP")}var i=function(){if(r.readyState===4){if(!n.isUnloading()){var i=r.responseText,s=r.status;""===i&&(i=null);if(s===0&&i&&window.location.protocol==="file:")s=200;else if(null===r.getResponseHeader("Content-Type")&&""===r.getAllResponseHeaders()){t(null,0);return}s!==0?(404===s&&(i=null),t(i,s)):t(i,0)}r.onreadystatechange=null,r=null,t=null}};r.open("GET",e,!0),t&&(r.onreadystatechange=i),r.send()},e.prototype.destroy=function(){this.networkDevice&&delete this.networkDevice,this.inputDevice&&(this.inputDevice.destroy(),delete this.inputDevice),this.physicsDevice&&delete this.physicsDevice,this.soundDevice&&(this.soundDevice.destroy&&this.soundDevice.destroy(),delete this.soundDevice),this.graphicsDevice&&(this.graphicsDevice.destroy(),delete this.graphicsDevice),this.canvas&&delete this.canvas,this.resizeCanvas&&(window.removeEventListener("resize",this.resizeCanvas,!1),delete this.resizeCanvas),this.handleZeroTimeoutMessages&&(window.removeEventListener("message",this.handleZeroTimeoutMessages,!0),delete this.handleZeroTimeoutMessages)},e.prototype.getPluginObject=function(){return!this.plugin&&this.pluginId&&(this.plugin=document.getElementById(this.pluginId)),this.plugin},e.prototype.unload=function(){this.unloading||(this.unloading=!0,this.onunload&&this.onunload(),this.destroy&&this.destroy())},e.prototype.isUnloading=function(){return this.unloading},e.prototype.enableProfiling=function(){},e.prototype.startProfiling=function(){console&&console.profile&&console.profileEnd&&console.profile("turbulenz")},e.prototype.stopProfiling=function(){var e;return console&&console.profile&&console.profileEnd&&(console.profileEnd(),console.profiles&&(e=console.profiles[console.profiles.length-1])),e},e.prototype.callOnError=function(e){var t=this.onerror;t&&t(e)},e.create=function(t){var n=new e,r=t.canvas,i=t.fillParent;window.TurbulenzEngineCanvas=n,n.pluginId=t.pluginId,n.plugin=null;var s=Date.now,o=window.performance;o&&(o.now?s=function(){return o.now()}:o.webkitNow&&(s=function(){return o.webkitNow()})),n.getTime=s;var u=s(),a=!0,f=navigator.userAgent,l=f.indexOf("Version/6.0");-1!==l&&-1!==f.substring(l).indexOf("Safari/")&&(a=!1),a&&Object.defineProperty?(Object.defineProperty(n,"time",{get:function(){return(s()-u)*.001},set:function(e){typeof e=="number"?u=s()-e*1e3:n.callOnError("Must set 'time' attribute to a number")},enumerable:!1,configurable:!1}),n.updateTime=function(){}):n.updateTime=function(){this.time=(s()-u)*.001};if(window.postMessage){var c="0-timeout-message",h=[],p=0,d=function(t){p+=1;var n={id:p,fn:t};return h.push(n),window.postMessage(c,"*"),n},v=function(t){var n=t.id,r=h.length;for(var i=0;i<r;i+=1)if(h[i].id===n){h.splice(i,1);return}},m=function(t){if(t.source===window&&t.data===c){t.stopPropagation();if(h.length&&!n.isUnloading()){var r=h.shift(),i=r.fn;i()}}};n.handleZeroTimeoutMessages=m,window.addEventListener("message",m,!0),n.setTimeout=function(e,t){if(t<1)return d(e);var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},n.clearTimeout=function(e){return typeof e=="object"?v(e):window.clearTimeout(e)}}else n.setTimeout=function(e,t){var n=this;return window.setTimeout(function(){n.updateTime(),n.isUnloading()||e()},t)},n.clearTimeout=function(e){return window.clearTimeout(e)};var g=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame;g&&(n.setInterval=function(e,t){var n=this;if(Math.abs(t-1e3/60)<=1){var r={enabled:!0},i=s()+16.6,o=function a(){if(r.enabled){var t=s(),o=t-i;0<=o&&(o>50?i=t+16.6:i+=16.6,n.updateTime(),n.isUnloading()||e()),g(a,n.canvas)}};return g(o,n.canvas),r}var u=function(){n.updateTime(),n.isUnloading()||e()};return window.setInterval(u,t)},n.clearInterval=function(e){typeof e=="object"?e.enabled=!1:window.clearInterval(e)}),n.canvas=r,n.networkDevice=null,n.inputDevice=null,n.physicsDevice=null,n.soundDevice=null,n.graphicsDevice=null,i&&(n.resizeCanvas=function(){if(document.fullscreenElement===r||document.mozFullScreenElement===r||document.webkitFullscreenElement===r||document.msFullscreenElement===r)r.width=window.innerWidth,r.height=window.innerHeight;else{var e=r.parentNode;r.width=e.clientWidth,r.height=e.clientHeight}},n.resizeCanvas(),window.addEventListener("resize",n.resizeCanvas,!1));try{var y=window.onbeforeunload;window.onbeforeunload=function(){n.unload(),y&&y.call(this)}}catch(b){}n.time=0;var w={architecture:"",cpuDescription:"",cpuVendor:"",numPhysicalCores:1,numLogicalCores:1,ramInMegabytes:0,frequencyInMegaHZ:0,osVersionMajor:0,osVersionMinor:0,osVersionBuild:0,osName:navigator.platform,platformProfile:"desktop",userLocale:(navigator.language||navigator.userLanguage).replace("-","_")},E=function(){var t=Math.min(window.screen.height,window.screen.width);return t<900},S=navigator.userAgent,x=S.indexOf("Windows");x!==-1?(w.osName="Windows",navigator.platform==="Win64"?w.architecture="x86_64":navigator.platform==="Win32"&&(w.architecture="x86"),x+=7,S.slice(x,x+4)===" NT "&&(x+=4,w.osVersionMajor=parseInt(S.slice(x,x+1),10),w.osVersionMinor=parseInt(S.slice(x+2,x+4),10)),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Mac OS X"),x!==-1?(w.osName="Darwin",navigator.platform.indexOf("Intel")!==-1&&(w.architecture="x86"),x+=9,w.osVersionMajor=parseInt(S.slice(x,x+2),10),w.osVersionMinor=parseInt(S.slice(x+3,x+4),10),w.osVersionBuild=parseInt(S.slice(x+5,x+6),10)||0):(x=S.indexOf("Linux"),x!==-1?(w.osName="Linux",navigator.platform.indexOf("64")!==-1?w.architecture="x86_64":navigator.platform.indexOf("x86")!==-1&&(w.architecture="x86"),E()&&(w.platformProfile="tablet")):(x=S.indexOf("Android"),-1!==x?(w.osName="Android",navigator.platform.indexOf("arm")?w.architecture="arm":navigator.platform.indexOf("x86")&&(w.architecture="x86"),-1!==S.indexOf("Mobile")?w.platformProfile="smartphone":w.platformProfile="tablet"):-1!==S.indexOf("iPhone")||-1!==S.indexOf("iPod")?(w.osName="iOS",w.architecture="arm",w.platformProfile="smartphone"):-1!==S.indexOf("iPad")&&(w.osName="iOS",w.architecture="arm",w.platformProfile="tablet")))),n.systemInfo=w;var T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("");return n.base64Encode=function(t){var n="",r=t.length,i=T,s,o,u,a,f,l,c,h;s=0;while(s<r)o=t[s],s+=1,f=o>>2,s<r?(u=t[s],s+=1,s<r?(a=t[s],s+=1,l=(o&3)<<4|u>>4,c=(u&15)<<2|a>>6,h=a&63):(l=(o&3)<<4|u>>4,c=(u&15)<<2,h=64)):(l=(o&3)<<4,c=64,h=64),n+=i[f],n+=i[l],n+=i[c],n+=i[h];return n},n},e}();window.WebGLTurbulenzEngine=yt;var bt=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},wt=function(){function e(){this.viewOffsetX=0,this.viewOffsetY=0,this.recipViewWindowX=1,this.recipViewWindowY=1,this.infinite=!1,this.parallel=!1,this.aspectRatio=4/3,this.nearPlane=1,this.farPlane=1e3}return e.prototype.lookAt=function(e,t,n){var r=this.md,i=r.v3Normalize,s=r.v3Cross,o=r.v3Sub(n,e);i.call(r,o,o);var u=s.call(r,i.call(r,t,t),o);i.call(r,u,u);var a=s.call(r,o,u);this.matrix=r.m43Build(u,a,o,n,this.matrix)},e.prototype.updateProjectionMatrix=function(){var e=this.recipViewWindowX,t=this.recipViewWindowY*this.aspectRatio,n=e*this.viewOffsetX,r=t*this.viewOffsetY,i=this.farPlane,s=this.nearPlane,o;i!==s?o=1/(i-s):o=0;var u,a,f,l;this.parallel?(u=-2*o,f=-(i+s)*o,a=0,l=1):(this.infinite?u=-1:u=-(i+s)*o,f=-(2*i*s*o),a=-1,l=0),this.projectionMatrix=this.md.m44Build(e,0,0,0,0,t,0,0,-n,-r,u,a,0,0,f,l,this.projectionMatrix)},e.prototype.updateViewMatrix=function(){var e=this.md;this.viewMatrix=e.m43InverseOrthonormal(this.matrix,this.viewMatrix)},e.prototype.updateViewProjectionMatrix=function(){var e=this.md;this.viewProjectionMatrix=e.m43MulM44(this.viewMatrix,this.projectionMatrix,this.viewProjectionMatrix)},e.prototype.extractFrustumPlanes=function(e,t){var n=this.md,r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t||[],w=n.v4Build(o+r,l+u,d+c,-(y+v));return b[0]=n.planeNormalize(w,b[0]),n.v4Build(o-r,l-u,d-c,-(y-v),w),b[1]=n.planeNormalize(w,b[1]),n.v4Build(o-i,l-a,d-h,-(y-m),w),b[2]=n.planeNormalize(w,b[2]),n.v4Build(o+i,l+a,d+h,-(y+m),w),b[3]=n.planeNormalize(w,b[3]),n.v4Build(o+s,l+f,d+p,-(y+g),w),b[4]=n.planeNormalize(w,b[4]),n.v4Build(o-s,l-f,d-p,-(y-g),w),b[5]=n.planeNormalize(w,b[5]),b},e.prototype.updateFrustumPlanes=function(){this.frustumPlanes=this.extractFrustumPlanes(this.viewProjectionMatrix,this.frustumPlanes)},e.prototype.isVisiblePoint=function(e){var t=this.md;return t.isInsidePlanesPoint(e,this.frustumPlanes)},e.prototype.isVisibleSphere=function(e,t){var n=this.md;return n.isInsidePlanesSphere(e,t,this.frustumPlanes)},e.prototype.isVisibleBox=function(e,t){var n=this.md;return n.isInsidePlanesBox(e,t,this.frustumPlanes)},e.prototype.isVisibleAABB=function(e){var t=this.md;return t.aabbIsInsidePlanes(e,this.frustumPlanes)},e.prototype.isFullyInsideAABB=function(e){var t=this.md;return t.aabbIsFullyInsidePlanes(e,this.frustumPlanes)},e.prototype.getFrustumPoints=function(e,t,n){var r=this.md,i=this.viewOffsetX,s=this.viewOffsetY,o=1/this.recipViewWindowX,u=1/(this.recipViewWindowY*this.aspectRatio),a=this.matrix,f=e||this.farPlane,l=t!==undefined?t:this.nearPlane,c=n||new Array(8);if(!this.parallel){var h=a[0]*i+a[3]*s,p=a[1]*i+a[4]*s,d=a[2]*i+a[5]*s,v=a[0]*o,m=a[1]*o,g=a[2]*o,y=a[3]*u,b=a[4]*u,w=a[5]*u,E=h-a[6],S=p-a[7],x=d-a[8],T=a[9]+h,N=a[10]+p,C=a[11]+d,k=E+v+y,L=S+m+b,A=x+g+w,O=E-v+y,M=S-m+b,_=x-g+w,D=E-v-y,P=S-m-b,H=x-g-w,B=E+v-y,j=S+m-b,F=x+g-w;c[0]=r.v3Build(T+k*l,N+L*l,C+A*l,c[0]),c[1]=r.v3Build(T+O*l,N+M*l,C+_*l,c[1]),c[2]=r.v3Build(T+D*l,N+P*l,C+H*l,c[2]),c[3]=r.v3Build(T+B*l,N+j*l,C+F*l,c[3]),c[4]=r.v3Build(T+k*f,N+L*f,C+A*f,c[4]),c[5]=r.v3Build(T+O*f,N+M*f,C+_*f,c[5]),c[6]=r.v3Build(T+D*f,N+P*f,C+H*f,c[6]),c[7]=r.v3Build(T+B*f,N+j*f,C+F*f,c[7])}else{var I=(1-l)*i,q=(1-f)*i,R=(1-l)*s,U=(1-f)*s;c[0]=r.v3Build(o+I,u+R,l,c[0]),c[1]=r.v3Build(I-o,u+R,l,c[1]),c[2]=r.v3Build(I-o,R-u,l,c[2]),c[3]=r.v3Build(o+I,R-u,l,c[3]),c[4]=r.v3Build(o+q,u+U,f,c[4]),c[5]=r.v3Build(q-o,u+U,f,c[5]),c[6]=r.v3Build(q-o,U-u,f,c[6]),c[7]=r.v3Build(o+q,U-u,f,c[7]),r.m43TransformPoint(a,c[0],c[0]),r.m43TransformPoint(a,c[1],c[1]),r.m43TransformPoint(a,c[2],c[2]),r.m43TransformPoint(a,c[3],c[3]),r.m43TransformPoint(a,c[4],c[4]),r.m43TransformPoint(a,c[5],c[5]),r.m43TransformPoint(a,c[6],c[6]),r.m43TransformPoint(a,c[7],c[7])}return c},e.prototype.getFrustumFarPoints=function(e,t){var n=this.md,r=this.viewOffsetX,i=this.viewOffsetY,s=1/this.recipViewWindowX,o=1/(this.recipViewWindowY*this.aspectRatio),u=this.matrix,a=e||this.farPlane,f=t||new Array(4);if(!this.parallel){var l=u[0],c=u[1],h=u[2],p=u[3],d=u[4],v=u[5],m=u[6],g=u[7],y=u[8],b=u[9],w=u[10],E=u[11],S=l*r+p*i,x=c*r+d*i,T=h*r+v*i,N=l*s,C=c*s,k=h*s,L=p*o,A=d*o,O=v*o,M=S-m,_=x-g,D=T-y,P=b+S,H=w+x,B=E+T,j=(M+N+L)*a,F=(_+C+A)*a,I=(D+k+O)*a,q=(M-N+L)*a,R=(_-C+A)*a,U=(D-k+O)*a,z=(M-N-L)*a,W=(_-C-A)*a,X=(D-k-O)*a,V=(M+N-L)*a,$=(_+C-A)*a,J=(D+k-O)*a;f[0]=n.v3Build(P+j,H+F,B+I,f[0]),f[1]=n.v3Build(P+q,H+R,B+U,f[1]),f[2]=n.v3Build(P+z,H+W,B+X,f[2]),f[3]=n.v3Build(P+V,H+$,B+J,f[3])}else{var K=(1-a)*r,Q=(1-a)*i;f[0]=n.v3Build(s+K,o+Q,a,f[0]),f[1]=n.v3Build(K-s,o+Q,a,f[1]),f[2]=n.v3Build(K-s,Q-o,a,f[2]),f[3]=n.v3Build(s+K,Q-o,a,f[3]),n.m43TransformPoint(u,f[0],f[0]),n.m43TransformPoint(u,f[1],f[1]),n.m43TransformPoint(u,f[2],f[2]),n.m43TransformPoint(u,f[3],f[3])}return f},e.prototype.getFrustumExtents=function(e,t,n){var r=this.getFrustumPoints(t,n),i=r[0],s=i[0],o=i[1],u=i[2],a=s,f=o,l=u;for(var c=1;c<8;c+=1){i=r[c];var h=i[0],p=i[1],d=i[2];s>h?s=h:a<h&&(a=h),o>p?o=p:f<p&&(f=p),u>d?u=d:l<d&&(l=d)}e[0]=s,e[1]=o,e[2]=u,e[3]=a,e[4]=f,e[5]=l},e.create=function(t){var n=new e;return n.md=t,n.matrix=t.m43BuildIdentity(),n.viewMatrix=t.m43BuildIdentity(),n.updateProjectionMatrix(),n.viewProjectionMatrix=n.projectionMatrix.slice(),n.frustumPlanes=[],n.updateFrustumPlanes(),n},e.version=1,e}(),Et=function(){function e(){this.rotateSpeed=2,this.maxSpeed=1,this.mouseRotateFactor=.1}return e.prototype.rotate=function(e,t){var n=Math.PI/180,r=this.md,i=this.camera.matrix,s=r.m43Pos(i);r.m43SetPos(i,r.v3BuildZero());var o;if(t!==0){t*=this.rotateSpeed*n,t*=this.mouseRotateFactor;var u=r.v3Normalize(r.m43Right(i));r.m43SetRight(i,u),o=r.m43FromAxisRotation(u,t),i=r.m43Mul(i,o)}e!==0&&(e*=this.rotateSpeed*n,e*=this.mouseRotateFactor,o=r.m43FromAxisRotation(r.v3BuildYAxis(),e),i=r.m43Mul(i,o)),r.m43SetPos(i,s),this.camera.matrix=i},e.prototype.translate=function(e,t,n){var r=this.md,i=this.camera.matrix,s=r.m43Pos(i),o=this.maxSpeed;s=r.v3Add4(s,r.v3ScalarMul(r.m43Right(i),o*e),r.v3ScalarMul
(r.m43Up(i),o*t),r.v3ScalarMul(r.m43At(i),-(o*n))),r.m43SetPos(i,s)},e.prototype.update=function(){var e=!1;if(this.turn!==0||this.pitch!==0)e=!0,this.rotate(this.turn,this.pitch),this.turn=0,this.pitch=0;this.step>0?this.forward+=this.step:this.step<0&&(this.backward-=this.step);var t=this.right+this.padright-(this.left+this.padleft),n=this.up-this.down,r=this.forward+this.padforward-(this.backward+this.padbackward);if(t!==0||n!==0||r!==0)e=!0,this.translate(t,n,r),this.step>0?(this.forward-=this.step,this.step=0):this.step<0&&(this.backward+=this.step,this.step=0);e&&this.camera.updateViewMatrix()},e.create=function(t,n,r,i){var s=new e;s.md=r.md,s.camera=r,s.turn=0,s.pitch=0,s.right=0,s.left=0,s.up=0,s.down=0,s.forward=0,s.backward=0,s.step=0,s.padright=0,s.padleft=0,s.padforward=0,s.padbackward=0,s.looktouch={id:-1,originX:0,originY:0},s.movetouch={id:-1,originX:0,originY:0};var o;n&&(o=n.keyCodes);var u=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=1;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=1;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=1;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=1;break;case o.E:case o.NUMPAD_9:s.up=1;break;case o.Q:case o.NUMPAD_7:s.down=1}},a=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=0;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=0;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=0;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=0;break;case o.E:case o.NUMPAD_9:s.up=0;break;case o.Q:case o.NUMPAD_7:s.down=0;break;case o.RETURN:t.fullscreen=!t.fullscreen}};return i?(s.onkeydown=function(t){i.innerHTML+=" KeyDown:&nbsp;"+t,u(t)},s.onkeyup=function(t){t===o.BACKSPACE?i.innerHTML="":i.innerHTML+=" KeyUp:&nbsp;"+t,a(t)}):(s.onkeydown=u,s.onkeyup=a),s.onmouseup=function(){n.isLocked()||n.lockMouse()},s.onmousewheel=function(t){s.step=t*5},s.onmousemove=function(t,n){s.turn+=t,s.pitch+=n},s.onpadmove=function(t,n,r,i,o){s.turn+=t*10,s.pitch+=n*10,i>=0?(s.padright=i,s.padleft=0):(s.padright=0,s.padleft=-i),o>=0?(s.padforward=o,s.padbackward=0):(s.padforward=0,s.padbackward=-o)},s.onmouselocklost=function(){n.unlockMouse()},s.ontouchstart=function(n){var r=n.changedTouches,i=r.length,o,u=t.width*.5;for(o=0;o<i;o+=1){var a=r[o].identifier,f=r[o].positionX,l=r[o].positionY;f<u&&s.looktouch.id===-1?(s.looktouch.id=a,s.looktouch.originX=f,s.looktouch.originY=l):f>=u&&s.movetouch.id===-1&&(s.movetouch.id=a,s.movetouch.originX=f,s.movetouch.originY=l)}},s.ontouchend=function(t){var n=t.changedTouches,r=n.length,i;for(i=0;i<r;i+=1){var o=n[i].identifier;s.looktouch.id===o?(s.looktouch.id=-1,s.looktouch.originX=0,s.looktouch.originY=0,s.turn=0,s.pitch=0):s.movetouch.id===o&&(s.movetouch.id=-1,s.movetouch.originX=0,s.movetouch.originY=0,s.left=0,s.right=0,s.forward=0,s.backward=0)}},s.ontouchmove=function(t){var n=t.changedTouches,r=n.length,i=16,o;for(o=0;o<r;o+=1){var u=n[o].identifier,a=n[o].positionX,f=n[o].positionY;s.looktouch.id===u?(a-s.looktouch.originX>i||a-s.looktouch.originX<-i?s.turn=(a-s.looktouch.originX)/i:s.turn=0,f-s.looktouch.originY>i||f-s.looktouch.originY<-i?s.pitch=(f-s.looktouch.originY)/16:s.pitch=0):s.movetouch.id===u&&(a-s.movetouch.originX>i?(s.left=0,s.right=1):a-s.movetouch.originX<-i?(s.left=1,s.right=0):(s.left=0,s.right=0),f-s.movetouch.originY>i?(s.forward=0,s.backward=1):f-s.movetouch.originY<-i?(s.forward=1,s.backward=0):(s.forward=0,s.backward=0))}},s.attach=function(t){t.addEventListener("keydown",s.onkeydown),t.addEventListener("keyup",s.onkeyup),t.addEventListener("mouseup",s.onmouseup),t.addEventListener("mousewheel",s.onmousewheel),t.addEventListener("mousemove",s.onmousemove),t.addEventListener("padmove",s.onpadmove),t.addEventListener("mouselocklost",s.onmouselocklost),t.addEventListener("touchstart",s.ontouchstart),t.addEventListener("touchend",s.ontouchend),t.addEventListener("touchmove",s.ontouchmove)},n&&s.attach(n),s},e.version=1,e}(),St=function(){function e(){return this.semantics=null,this.vertexBuffer=null,this.vertexOffset=0,this.reference=s.create(this),this.surfaces={},this.type="rigid",this}return e.prototype.destroy=function(){this.vertexBufferAllocation&&(this.vertexBufferManager.free(this.vertexBufferAllocation),delete this.vertexBufferManager,delete this.vertexBufferAllocation),this.indexBufferAllocation&&(this.indexBufferManager.free(this.indexBufferAllocation),delete this.indexBufferManager,delete this.indexBufferAllocation),delete this.vertexBuffer,delete this.indexBuffer,delete this.vertexData,delete this.indexData,delete this.semantics,delete this.first,delete this.halfExtents,delete this.reference,delete this.surfaces},e.create=function(){return new e},e.version=1,e}(),xt=function(){function e(){}return e.prototype.clone=function(){var t=e.create(this.geometry,this.surface,this.sharedMaterial);return this.disabled&&(t.disabled=!0),t},e.prototype.isSkinned=function(){return this.geometry.skeleton?!0:!1},e.prototype.setNode=function(e){this.node&&this.hasCustomWorldExtents()&&this.node.renderableWorldExtentsRemoved(),this.node=e,this.node&&this.hasCustomWorldExtents()&&this.node.renderableWorldExtentsUpdated(!1),this.worldExtentsUpdate=-1},e.prototype.getNode=function(){return this.node},e.prototype.setMaterial=function(e){e.reference.add(),this.sharedMaterial.reference.remove(),this.sharedMaterial=e,this.renderUpdate=undefined,this.rendererInfo=undefined},e.prototype.getMaterial=function(){return this.sharedMaterial},e.prototype.getWorldExtents=function(){var e=this.node;return e.worldUpdate>this.worldExtentsUpdate&&(this.worldExtentsUpdate=e.worldUpdate,this.updateWorldExtents(e.world)),this.worldExtents},e.prototype.updateWorldExtents=function(e){var t=this.center,n=this.halfExtents,r=this.worldExtents,i=e[0],s=e[1],o=e[2],u=e[3],a=e[4],f=e[5],l=e[6],c=e[7],h=e[8],p=e[9],d=e[10],v=e[11];if(t){var m=t[0],g=t[1],y=t[2];p+=i*m+u*g+l*y,d+=s*m+a*g+c*y,v+=o*m+f*g+h*y}var b=n[0],w=n[1],E=n[2],S=(i<0?-i:i)*b+(u<0?-u:u)*w+(l<0?-l:l)*E,x=(s<0?-s:s)*b+(a<0?-a:a)*w+(c<0?-c:c)*E,T=(o<0?-o:o)*b+(f<0?-f:f)*w+(h<0?-h:h)*E;r[0]=p-S,r[1]=d-x,r[2]=v-T,r[3]=p+S,r[4]=d+x,r[5]=v+T},e.prototype.addCustomWorldExtents=function(t){var n=this.worldExtentsUpdate===e.maxUpdateValue,r=this.worldExtents;if(!n||t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||t[4]!==r[4]||t[5]!==r[5])this.worldExtentsUpdate=e.maxUpdateValue,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],this.node.renderableWorldExtentsUpdated(n)},e.prototype.removeCustomWorldExtents=function(){this.worldExtentsUpdate=-1,this.node.renderableWorldExtentsRemoved()},e.prototype.getCustomWorldExtents=function(){return this.worldExtentsUpdate===e.maxUpdateValue?this.worldExtents:undefined},e.prototype.hasCustomWorldExtents=function(){return this.worldExtentsUpdate===e.maxUpdateValue},e.prototype.destroy=function(){this.geometry.reference&&this.geometry.reference.remove(),this.sharedMaterial.reference&&this.sharedMaterial.reference.remove(),delete this.surface,delete this.geometry,delete this.sharedMaterial,delete this.techniqueParameters,delete this.halfExtents,delete this.center,delete this.worldExtentsUpdate,delete this.drawParameters,delete this.renderUpdate,delete this.rendererInfo},e.prototype.prepareDrawParameters=function(e){var t=this.surface,n=this.geometry;e.setVertexBuffer(0,n.vertexBuffer),e.setSemantics(0,this.semantics),e.setOffset(0,n.vertexOffset),e.primitive=t.primitive,e.firstIndex=t.first,t.indexBuffer?(e.indexBuffer=t.indexBuffer,e.count=t.numIndices):e.count=t.numVertices},e.create=function(t,n,r){var i=new e,s=TurbulenzEngine.getGraphicsDevice();return i.geometry=t,i.geometry.reference.add(),i.geometryType=t.type,i.surface=n,i.semantics=t.semantics,i.halfExtents=t.halfExtents,i.center=t.center,i.techniqueParameters=s?s.createTechniqueParameters():null,i.sharedMaterial=r,i.sharedMaterial&&i.sharedMaterial.reference.add(),i.worldExtents=new i.arrayConstructor(6),i.worldExtentsUpdate=-1,i.node=undefined,i.renderUpdate=undefined,i.rendererInfo=undefined,i},e.version=1,e.maxUpdateValue=Number.MAX_VALUE,e}();(function(){xt.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(xt.prototype.arrayConstructor=Float32Array)}})();var Tt=function(){function e(){}return e.create=function(t){var n=new e;return n.reference=s.create(n),n.techniqueParameters=t.createTechniqueParameters(),n.meta={},n.onTextureChanged=function(t){var r=t.texture,i=n,s=i.techniqueParameters,o=i.textureInstances;for(var u in o)o.hasOwnProperty(u)&&o[u]===t&&(s[u]=r)},n},e.prototype.getName=function(){return this.name},e.prototype.setName=function(e){this.name=e},e.prototype.clone=function(t){var n=e.create(t);this.effect&&(n.effect=this.effect),this.effectName&&(n.effectName=this.effectName);var r=this.meta,i=n.meta,s;for(s in r)r.hasOwnProperty(s)&&(i[s]=r[s]);var o=this.techniqueParameters,u=n.techniqueParameters;for(s in o)o.hasOwnProperty(s)&&(u[s]=o[s]);var a=this.texturesNames;if(a){var f=n.texturesNames;f||(n.texturesNames=f={});for(s in a)a.hasOwnProperty(s)&&(f[s]=a[s])}var l=this.textureInstances;if(l){var c=n.textureInstances;c||(n.textureInstances=c={});for(s in l)if(l.hasOwnProperty(s)){var h=l[s];c[s]=h,h.subscribeTextureChanged(n.onTextureChanged),h.reference.add()}}return n},e.prototype.loadTextures=function(e){var t=this.texturesNames;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];e.load(r),this.setTextureInstance(n,e.getInstance(r))}},e.prototype.setTextureInstance=function(e,t){this.textureInstances||(this.textureInstances={});var n=this.textureInstances[e];n!==t&&(n&&n.unsubscribeTextureChanged&&n.unsubscribeTextureChanged(this.onTextureChanged),this.textureInstances[e]=t,this.techniqueParameters[e]=t.texture,t.subscribeTextureChanged(this.onTextureChanged),t.reference.add())},e.prototype.isSimilar=function(e){function t(e,t){var n;for(n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n])return!1}for(n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function n(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}if(this.effect!==e.effect)return!1;if(this.effectName!==e.effectName)return!1;if(this.meta.materialIndex!==e.meta.materialIndex){var r=this.texturesNames,i=e.texturesNames;if(r||i){if(!r||!i)return!1;if(!t(r,i))return!1}}var s=this.techniqueParameters,o=e.techniqueParameters,u,a,f;for(u in s)if(s.hasOwnProperty(u)){if(!o.hasOwnProperty(u))return!1;a=s[u],f=o[u];if(a!==f){if(!(a&&typeof a!="number"&&f&&typeof f!="number"&&a.length===f.length&&a.length))return!1;if(!n(a,f))return!1}}for(u in o)if(o.hasOwnProperty(u)&&!s.hasOwnProperty(u))return!1;return!0},e.prototype.destroy=function(){delete this.techniqueParameters;var e,t=this.textureInstances;for(var n in t)t.hasOwnProperty(n)&&(e=t[n],e.unsubscribeTextureChanged(this.onTextureChanged),e.reference.remove());delete this.textureInstances,delete this.texturesNames},e.version=1,e}(),Nt=function(){function e(){}return e.prototype.clone=function(){var t=new e;return t.name=this.name,t.spot=this.spot,t.ambient=this.ambient,t.point=this.point,t.fog=this.fog,t.global=this.global,t.directional=this.directional,t.color=this.color&&this.color.slice(),t.direction=this.direction&&this.direction.slice(),t.origin=this.origin&&this.origin.slice(),t.frustum=this.frustum&&this.frustum.slice(),t.frustumNear=this.frustumNear,t.center=this.center&&this.center.slice(),t.halfExtents=this.halfExtents&&this.halfExtents.slice(),t.radius=this.radius,t.shadows=this.shadows,t.dynamicshadows=this.dynamicshadows,t.disabled=this.disabled,t.dynamic=this.dynamic,t.techniqueParameters=this.techniqueParameters,t},e.prototype.isGlobal=function(){return this.global},e.create=function(n){var r=new e,i=TurbulenzEngine.getMathDevice(),s=Math.abs,o=Math.max;n.name&&(r.name=n.name),r.color=n.color&&n.color.length?n.color:i.v3BuildOne(),n.directional?r.directional=!0:n.spot?r.spot=!0:n.ambient?r.ambient=!0:r.point=!0,r.origin=n.origin;var u=n.target;if(u||r.spot){u||(u=i.v3Build(0,0,-(n.radius||1)));var a=(n.falloff_angle||90)/360*Math.PI,f=Math.abs(u[2])*Math.tan(a),l=n.right||i.v3Build(f,0,0),c=n.up||i.v3Build(0,f,0),h=n.end||u;r.frustum=i.m33Build(l,c,h);var p=s(l[0])+s(c[0]),d=s(l[1])+s(c[1]),v=s(l[2])+s(c[2]),m=h[0],g=h[1],y=h[2],b,w,E,S=n.start;S?(u=i.v3Normalize(u),r.frustumNear=i.v3Dot(u,S)/i.v3Dot(u,h),b=(m+S[0])*.5,w=(g+S[1])*.5,E=(y+S[2])*.5):(r.frustumNear=0,b=m*.5,w=g*.5,E=y*.5),r.center=i.v3Build(b,w,E),r.halfExtents=i.v3Build(o(s(m-p-b),s(m+p-b)),o(s(g-d-w),s(g+d-w)),o(s(y-v-E),s(y+v-E)))}else{var x=n.halfExtents;if(x)r.halfExtents=x.length&&x||i.v3BuildZero();else{var T=n.radius;T?(r.radius=T,r.halfExtents=i.v3ScalarBuild(T)):r.ambient||(r.halfExtents=i.v3ScalarBuild(t.FLOAT_MAX))}}r.direction=n.direction,!n.halfExtents&&!n.radius&&!n.target&&(r.global=!0),!r.global&&(n.shadows||n.dynamicshadows)&&(r.shadows=!0,n.dynamicshadows&&(r.dynamicshadows=!0)),n.disabled&&(r.disabled=!0),n.dynamic&&(r.dynamic=!0);var N=n.material;if(N){var C=N.techniqueParameters;r.techniqueParameters=C;var k=N.meta;if(k){var L=k.ambient;L&&(r.ambient=!0);var A=k.fog;A&&(r.fog=!0)}}return r},e.version=1,e}(),Ct=function(){function e(){}return e.prototype.setMaterial=function(e){this.light.sharedMaterial=e;var t=e.meta;if(e.meta){var n=t.ambient;n?this.light.ambient=!0:this.light.ambient&&delete this.light.ambient;var r=t.fog;r?this.light.fog=!0:this.light.fog&&delete this.light.fog}},e.prototype.setNode=function(e){this.node=e,this.worldExtentsUpdate=-1},e.prototype.getNode=function(){return this.node},e.prototype.getWorldExtents=function(){var e=this.node;return e.worldUpdate!==this.worldExtentsUpdate&&(this.worldExtentsUpdate=e.worldUpdate,this.updateWorldExtents(e.world)),this.worldExtents},e.prototype.updateWorldExtents=function(e){var t=this.worldExtents,n=this.light,r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11];if(n.spot){var v,m,g,y,b,w,E,S,x;v=h,m=p,g=d,y=h,b=p,w=d;var T=n.frustum,N=T[0],C=T[1],k=T[2],L=T[3],A=T[4],O=T[5],M=T[6],_=T[7],D=T[8];h+=r*M+o*_+f*D,p+=i*M+u*_+l*D,d+=s*M+a*_+c*D;var P=Math.abs,H=P(r*N+o*C+f*k)+P(r*L+o*A+f*O),B=P(i*N+u*C+l*k)+P(i*L+u*A+l*O),j=P(s*N+a*C+c*k)+P(s*L+a*A+c*O);E=h-H,S=p-B,x=d-j,v>E&&(v=E),m>S&&(m=S),g>x&&(g=x),E=h+H,S=p+B,x=d+j,y<E&&(y=E),b<S&&(b=S),w<x&&(w=x),t[0]=v,t[1]=m,t[2]=g,t[3]=y,t[4]=b,t[5]=w}else{var F=n.center,I=n.halfExtents;if(F){var q=F[0],R=F[1],U=F[2];h+=r*q+o*R+f*U,p+=i*q+u*R+l*U,d+=s*q+a*R+c*U}var z=I[0],W=I[1],X=I[2],V=(r<0?-r:r)*z+(o<0?-o:o)*W+(f<0?-f:f)*X,$=(i<0?-i:i)*z+(u<0?-u:u)*W+(l<0?-l:l)*X,J=(s<0?-s:s)*z+(a<0?-a:a)*W+(c<0?-c:c)*X;t[0]=h-V,t[1]=p-$,t[2]=d-J,t[3]=h+V,t[4]=p+$,t[5]=d+J}},e.prototype.clone=function(){var t=e.create(this.light);return t},e.create=function(t){var n=new e;return n.node=undefined,n.light=t,n.worldExtents=new n.arrayConstructor(6),n.worldExtentsUpdate=-1,n},e.version=1,e}();(function(){Ct.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(Ct.prototype.arrayConstructor=Float32Array)}})();var kt=function(){function e(t){this.name=t.name;var n=this.mathDevice;n||(n=TurbulenzEngine.getMathDevice(),e.prototype.mathDevice=n),this.dynamic=t.dynamic||!1,this.disabled=t.disabled||!1,this.dirtyWorld=!1,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.worldUpdate=0,this.frameVisible=-1;var r=t.local;if(r)if(this.arrayConstructor!==Array){var i=new Float32Array(24);this.local=n.m43Copy(r,i.subarray(0,12)),this.world=n.m43Copy(this.local,i.subarray(12,24))}else this.local=n.m43Copy(r),this.world=n.m43Copy(this.local);else this.local=undefined,this.world=n.m43BuildIdentity();this.parent=undefined,this.notifiedParent=!1}return e.makePath=function(e,t){return e+"/"+t},e.invalidSetLocalTransform=function(){},e.prototype.getName=function(){return this.name},e.prototype.getPath=function(){return this.parent?e.makePath(this.parent.getPath(),this.name):this.name},e.prototype.getParent=function(){return this.parent},e.prototype.setParentHelper=function(e){this.parent=e,this.notifiedParent=!1,this.dirtyWorld=!1,this._setDirtyWorldTransform()},e.prototype.addChild=function(e){e.parent?e.parent.removeChild(e):e.scene&&e.scene.removeRootNode(e),this.children||(this.children=[],this.childNeedsUpdateCount=0),this.children.push(e),e.setParentHelper(this),this.dynamic&&!e.dynamic&&e.setDynamic()},e.prototype.removeChild=function(e){var t=this.children;if(t){e.notifiedParent&&this.childUpdated();var n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){var i=this.getRoot();i.scene&&e.removedFromScene(i.scene),t.splice(r,1),e.setParentHelper(null);return}}},e.prototype.findChild=function(e){var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)if(t[r].name===e)return t[r]}return undefined},e.prototype.clone=function(t){var n=e.create({name:t||this.name,local:this.local,dynamic:this.dynamic,disabled:this.disabled}),r=this.renderables;if(r){var i=r.length;for(var s=0;s<i;s+=1){var o=r[s];n.addRenderable(o.clone())}}var u=this.lightInstances;if(u){var a=u.length;for(var f=0;f<a;f+=1){var l=u[f];n.addLightInstance(l.clone())}}this.clonedObserver&&this.clonedObserver.notify({oldNode:this,newNode:n});var c=this.children;if(c){var h=c.length;for(var p=0;p<h;p+=1)n.addChild(c[p].clone())}return n},e.prototype.getRoot=function(){var e=this;while(e.parent)e=e.parent;return e},e.prototype.isInScene=function(){return this.getRoot().scene?!0:!1},e.prototype.removedFromScene=function(e){this.spatialIndex!==undefined&&(this.dynamic?e.dynamicSpatialMap.remove(this):(e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1));var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].removedFromScene(e)}},e.prototype.setLocalTransform=function(e){e!==this.local&&(this.local=this.mathDevice.m43Copy(e,this.local)),this.dirtyWorld||this._setDirtyWorldTransform()},e.prototype.getLocalTransform=function(){return this.local||(this.local=this.mathDevice.m43BuildIdentity()),this.local},e.prototype._setDirtyWorldTransform=function(){var t=this.parent;if(t)this.notifiedParent||(this.notifiedParent=!0,t.childNeedsUpdate());else{var n=this.scene;n&&n.addRootNodeToUpdate(this,this.name)}var r=e._tempDirtyNodes;r[0]=this;var i=1,s,o,u;do{i-=1,s=r[i],s.dirtyWorld=!0,!s.customWorldExtents&&s.localExtents&&(s.dirtyWorldExtents=!0);var a=s.children;if(a){var f=a.length;if(!s.childNeedsUpdateCount){s.childNeedsUpdateCount=f;for(o=0;o<f;o+=1)u=a[o],u.notifiedParent=!0,r[i]=u,i+=1}else for(o=0;o<f;o+=1)u=a[o],u.dirtyWorld||(u.notifiedParent||(u.notifiedParent=!0,s.childNeedsUpdateCount+=1),r[i]=u,i+=1)}}while(0<i)},e.prototype.getWorldTransform=function(){return this.dirtyWorld&&this.updateWorldTransform(),this.world},e.prototype.updateWorldTransform=function(){if(this.dirtyWorld){this.dirtyWorld=!1,this.worldUpdate+=1,this.checkUpdateRequired();var e=this.parent,t=this.local;if(e){var n=e.getWorldTransform();t?this.world=this.mathDevice.m43Mul(t,n,this.world):this.world=this.mathDevice.m43Copy(n,this.world)}else this.world=this.mathDevice.m43Copy(t,this.world)}},e.prototype.setDynamic=function(){if(!this.dynamic){if(this.spatialIndex!==undefined){var e=this.getRoot().scene;e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1,delete this.spatialIndex}delete this.setLocalTransform;var t=this.getWorldExtents();t&&this.getRoot().scene.dynamicSpatialMap.update(this,t),this.dynamic=!0}var n=this.children;if(n){var r=n.length;for(var i=0;i<r;i+=1)n[i].setDynamic()}},e.prototype.setStatic=function(){if(this.dynamic){this.spatialIndex!==undefined&&(this.getRoot().scene.dynamicSpatialMap.remove(this),delete this.spatialIndex),this.setLocalTransform=e.invalidSetLocalTransform;var t=this.getWorldExtents();if(t){var n=this.getRoot().scene;n&&(n.staticSpatialMap.update(this,t),n.staticNodesChangeCounter+=1)}delete this.dirtyWorldExtents,delete this.worldExtentsUpdate,delete this.dirtyWorld,delete this.notifiedParent,delete this.dynamic}var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s].setStatic()}},e.prototype.setDisabled=function(e){e?this.disabled=!0:this.disabled=!1},e.prototype.getDisabled=function(){return this.disabled},e.prototype.enableHierarchy=function(e){this.setDisabled(!e);var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].enableHierarchy(e)}},e.prototype.childUpdated=function(){this.childNeedsUpdateCount-=1,this.childNeedsUpdateCount===0&&this.dirtyWorld===!1&&this.dirtyWorldExtents===!1&&this.parent&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.childNeedsUpdate=function(){this.updateRequired(),this.childNeedsUpdateCount+=1},e.prototype.updateRequired=function(){var e=this.parent;if(e)this.notifiedParent||(this.notifiedParent=!0,e.childNeedsUpdate());else{var t=this.scene;t&&t.addRootNodeToUpdate(this,this.name)}},e.prototype.checkUpdateRequired=function(){this.notifiedParent&&!this.dirtyWorldExtents&&!this.dirtyWorld&&!this.childNeedsUpdateCount&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.update=function(t){var n=e._tempDirtyNodes;n[0]=this,e.updateNodes(this.mathDevice,t||this.scene,n,1)},e.updateNodes=function(t,n,r,i){var s=n.dynamicSpatialMap,o,u,a,f;do{i-=1,o=r[i];if(o.dirtyWorld){o.dirtyWorld=!1,o.worldUpdate+=1,u=o.parent;if(u){var l=o.local;l?o.world=t.m43Mul(l,u.world,o.world):o.world=t.m43Copy(u.world,o.world)}else o.world=t.m43Copy(o.local,o.world)}o.dirtyWorldExtents&&(o.customWorldExtents?o.worldExtents=o.customWorldExtents:(o.dirtyLocalExtents&&o.updateLocalExtents(),o.numCustomRenderableWorldExtents?o.updateCustomRenderableWorldExtents():o.localExtents?o.recalculateWorldExtents():delete o.worldExtents),o.dirtyWorldExtents=!1,o.worldExtentsUpdate=!0),o.worldExtentsUpdate&&(o.worldExtentsUpdate=!1,f=o.worldExtents,f?o.dynamic?s.update(o,f):(n.staticSpatialMap.update(o,f),n.staticNodesChangeCounter+=1,o.setLocalTransform=e.invalidSetLocalTransform,delete o.dirtyWorldExtents,delete o.worldExtentsUpdate,delete o.dirtyWorld,delete o.notifiedParent):o.spatialIndex!==undefined&&(o.dynamic?s.remove(o):(n.staticSpatialMap.remove(o),n.staticNodesChangeCounter+=1)));if(o.childNeedsUpdateCount){o.childNeedsUpdateCount=0;var c=o.children;if(c){var h=c.length;for(a=0;a<h;a+=1){var p=c[a];p.notifiedParent&&(r[i]=p,i+=1)}}}o.notifiedParent=!1}while(0<i)},e.prototype.updateLocalExtents=function(){var e,t,n,r=!1;if(this.customLocalExtents)this.localExtents=this.customLocalExtents,r=!0;else{var i=this.renderables,s=this.lightInstances,o=i?i.length:0,u=s?s.length:0;if(o||u){var a=Number.MAX_VALUE,f=-a,l=Math.min,c=Math.max,h,p,d,v,m,g,y,b=a,w=a,E=a,S=f,x=f,T=f;for(y=0;y<o;y+=1){var N=i[y];n=N.halfExtents,n&&!N.hasCustomWorldExtents()&&(h=n[0],p=n[1],d=n[2],t=N.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}for(y=0;y<u;y+=1){var C=s[y].light;n=C.halfExtents,n&&(h=n[0],p=n[1],d=n[2],t=C.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}if(this.arrayConstructor!==Array){var k=6;this.localHalfExtents||(k+=3),this.localExtentsCenter||(k+=3),this.worldExtents||(k+=6);var L=new Float32Array(k),A=0;this.localExtents=e=L.subarray(A,A+6),A+=6,this.localHalfExtents||(this.localHalfExtents=L.subarray(A,A+3),A+=3),this.localExtentsCenter||(this.localExtentsCenter=L.subarray(A,A+3),A+=3),this.worldExtents||(this.worldExtents=L.subarray(A,A+6),A+=6)}else this.localExtents=e=new Array(6),this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6));e[0]=b,e[1]=w,e[2]=E,e[3]=S,e[4]=x,e[5]=T,r=!0}}r?(e=this.localExtents,t=this.localExtentsCenter||new this.arrayConstructor(3),t[0]=(e[3]+e[0])*.5,t[1]=(e[4]+e[1])*.5,t[2]=(e[5]+e[2])*.5,this.localExtentsCenter=t,n=this.localHalfExtents||new this.arrayConstructor(3),n[0]=e[3]-t[0],n[1]=e[4]-t[1],n[2]=e[5]-t[2],this.localHalfExtents=n):(delete this.localExtents,delete this.localExtentsCenter,delete this.localHalfExtents),this.dirtyLocalExtents=!1},e.prototype.getLocalExtents=function(){return this.dirtyLocalExtents&&this.updateLocalExtents(),this.localExtents},e.prototype.updateWorldExtents=function(){this.dirtyWorld&&this.updateWorldTransform(),this.dirtyWorldExtents&&(this.customWorldExtents?this.worldExtents=this.customWorldExtents:(this.dirtyLocalExtents&&this.updateLocalExtents(),this.numCustomRenderableWorldExtents?this.updateCustomRenderableWorldExtents():this.localExtents?this.recalculateWorldExtents():delete this.worldExtents),this.dirtyWorldExtents=!1,this.worldExtentsUpdate=!0,this.checkUpdateRequired())},e.prototype.updateCustomRenderableWorldExtents=function(){var e,t,n,r,i,s,o,u,a,f=this.renderables,l=f.length,c=!0;for(e=0;e<l;e+=1){t=f[e],n=t.getCustomWorldExtents();if(n){r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],e+=1,c=!1;break}}for(;e<l;e+=1)t=f[e],n=t.getCustomWorldExtents(),n&&(r>n[0]&&(r=n[0]),i>n[1]&&(i=n[1]),s>n[2]&&(s=n[2]),o<n[3]&&(o=n[3]),u<n[4]&&(u=n[4]),a<n[5]&&(a=n[5]));if(c)delete this.worldExtents;else{var h=this.worldExtents;h||(h=new this.arrayConstructor(6),this.worldExtents=h),h[0]=r,h[1]=i,h[2]=s,h[3]=o,h[4]=u,h[5]=a}},e.prototype.recalculateWorldExtents=function(){var e=this.localExtentsCenter,t=this.localHalfExtents,n=e[0],r=e[1],i=e[2],s=t[0],o=t[1],u=t[2],a=this.world,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=a[5],v=a[6],m=a[7],g=a[8],y=a[9],b=a[10],w=a[11];if(n!==0||r!==0||i!==0)y+=f*n+h*r+v*i,b+=l*n+p*r+m*i,w+=c*n+d*r+g*i;var E=(f<0?-f:f)*s+(h<0?-h:h)*o+(v<0?-v:v)*u,S=(l<0?-l:l)*s+(p<0?-p:p)*o+(m<0?-m:m)*u,x=(c<0?-c:c)*s+(d<0?-d:d)*o+(g<0?-g:g)*u,T=this.worldExtents;T||(T=new this.arrayConstructor(6),this.worldExtents=T),T[0]=y-E,T[1]=b-S,T[2]=w-x,T[3]=y+E,T[4]=b+S,T[5]=w+x},e.prototype.getWorldExtents=function(){return this.dirtyWorldExtents&&this.updateWorldExtents(),this.worldExtents},e.prototype.addCustomLocalExtents=function(e){var t=this.customLocalExtents;if(!t){this.localExtents=undefined;if(this.arrayConstructor!==Array){var n=0;this.localHalfExtents||(n+=3),this.localExtentsCenter||(n+=3),this.worldExtents||(n+=6),n+=6;var r=new Float32Array(n),i=0;this.localHalfExtents||(this.localHalfExtents=r.subarray(i,i+3),i+=3),this.localExtentsCenter||(this.localExtentsCenter=r.subarray(i,i+3),i+=3),this.worldExtents||(this.worldExtents=r.subarray(i,i+6),i+=6),this.customLocalExtents=t=r.subarray(i,i+6),i+=6}else this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6)),this.customLocalExtents=t=new Array(6);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0}else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0;this.dirtyLocalExtents&&(this.dirtyWorldExtents=!0,this.updateRequired())},e.prototype.removeCustomLocalExtents=function(){delete this.customLocalExtents,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.updateRequired()},e.prototype.getCustomLocalExtents=function(){return this.customLocalExtents},e.prototype.addCustomWorldExtents=function(e){var t=this.customWorldExtents;if(!t)this.customWorldExtents=t=new this.arrayConstructor(6),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;this.dirtyWorldExtents&&this.updateRequired()},e.prototype.removeCustomWorldExtents=function(){delete this.customWorldExtents,this.dirtyWorldExtents=!0,this.updateRequired()},e.prototype.getCustomWorldExtents=function(){return this.customWorldExtents},e.prototype.renderableWorldExtentsUpdated=function(e){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),e||(this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents=this.numCustomRenderableWorldExtents?this.numCustomRenderableWorldExtents+1:1)},e.prototype.renderableWorldExtentsRemoved=function(){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents-=1},e.prototype.calculateHierarchyWorldExtents=function(e){var t=Number.MAX_VALUE,n=e;return n||(n=new this.arrayConstructor(6)),n[0]=t,n[1]=t,n[2]=t,n[3]=-t,n[4]=-t,n[5]=-t,this._calculateNodeExtents(n)?n:undefined},e.prototype._calculateNodeExtents=function(e){var t=!1,n=this.getWorldExtents();n&&(e[0]=e[0]<n[0]?e[0]:n[0],e[1]=e[1]<n[1]?e[1]:n[1],e[2]=e[2]<n[2]?e[2]:n[2],e[3]=e[3]>n[3]?e[3]:n[3],e[4]=e[4]>n[4]?e[4]:n[4],e[5]=e[5]>n[5]?e[5]:n[5],t=!0);var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s]._calculateNodeExtents(e)&&(t=!0)}return t},e.prototype.addRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]),this.renderables.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addRenderableArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]);var t=this.renderables,n=e.length;for(var r=0;r<n;r+=1)t.push(e[r]),e[r].setNode(this);this.dirtyLocalExtents=!0},e.prototype.removeRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.renderables,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t[r].setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasRenderables=function(){return this.renderables&&this.renderables.length?!0:!1},e.prototype.addLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]),this.lightInstances.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addLightInstanceArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]);var t=this.lightInstances,n=e.length;for(var r=0;r<n;r+=1)e[r].setNode(this),t.push(e[r]);this.dirtyLocalExtents=!0},e.prototype.removeLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.lightInstances,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){e.setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasLightInstances=function(){return this.lightInstances&&this.lightInstances.length},e.prototype.destroy=function(){this.destroyedObserver&&this.destroyedObserver.notify({node:this});var t=this.children;if(t){var n=t.length;for(var r=n-1;r>=0;r-=1){var i=t[r];this.removeChild(i),i.destroy()}}var s=this.renderables;if(s){var o=s.length;for(var u=o-1;u>=0;u-=1){var a=s[u];a.destroy&&a.destroy()}this.renderables=[]}this.lightInstances&&(this.lightInstances=[]),delete this.scene;var f=e._tempDirtyNodes,l=f.length,c;for(c=0;c<l;c+=1)f[c]=null},e.prototype.subscribeCloned=function(e){this.clonedObserver||(this.clonedObserver=l.create()),this.clonedObserver.subscribe(e)},e.prototype.unsubscribeCloned=function(e){this.clonedObserver.unsubscribe(e)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=l.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){return new e(t)},e.version=1,e._tempDirtyNodes=[],e}();kt.prototype.mathDevice=null,function(){kt.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(kt.prototype.arrayConstructor=Float32Array)}}();var Lt=function(){function e(e,t,n){this.md=e,this.staticSpatialMap=t||f.create(!0),this.dynamicSpatialMap=n||f.create(),this.clear();var r=this;this.onGeometryDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onGeometryDestroyed),delete r.shapes[t.name]},this.onMaterialDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onMaterialDestroyed),delete r.materials[t.name]}}return e.prototype.findNode=function(e){var t=this.rootNodesMap[e];if(t)return t;var n=e.split("/"),r=n[0];t=this.rootNodesMap[r];for(var i=1;t&&i<n.length;i+=1)t=t.findChild(n[i]);return t},e.prototype.addRootNode=function(e){var t=e.name;e.scene=this,e.worldExtentsUpdate=!0,this.rootNodes.push(e),this.rootNodesMap[t]=e,this.addRootNodeToUpdate(e,t)},e.prototype.removeRootNode=function(e){var t=e.name;e.removedFromScene(this);var n=this.rootNodes,r=n.indexOf(e);if(r!==-1)
{var i=n.length-1;r<i&&(n[r]=n[i]),n.length=i}delete this.rootNodesMap[t];if(this.dirtyRoots[t]===e){delete this.dirtyRoots[t];var s=this.nodesToUpdate,o=this.numNodesToUpdate;for(r=0;r<o;r+=1)if(s[r]===e){o-=1,r<o&&(s[r]=s[o]),s[o]=null,this.numNodesToUpdate=o;break}}delete e.scene},e.prototype.addLight=function(e){this.lights[e.name]=e,e.isGlobal()&&this.globalLights.push(e)},e.prototype.removeLight=function(e){delete this.lights[e.name];if(e.isGlobal()){var t=this.globalLights,n=t.length;for(var r=0;r<n;r+=1)if(e===t[r]){t.splice(r,1);break}}},e.prototype.getLight=function(e){return this.lights[e]},e.prototype.getGlobalLights=function(){return this.globalLights},e.prototype.calculateNumNodes=function(e){var t=e.length,n=t;for(var r=0;r<t;r+=1){var i=e[r].children;i&&(n+=this.calculateNumNodes(i))}return n},e.prototype.buildPortalPlanes=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s.length,f=0,l,c,h,p,d,v,m=[];m.length=u,c=0;do m[c]=0,c+=1;while(c<u);l=0;do{d=s[l];var g=d[0],y=d[1],b=d[2],w=d[3];v=0,c=0;do p=e[c],g*p[0]+y*p[1]+b*p[2]>=w?v+=1:m[c]|=1<<l,c+=1;while(c<u);if(v===0)return t.length=0,!1;v<u&&(t[f]=o.v4Copy(d,t[f]),f+=1),l+=1}while(l<a);var E=f===0,S=this.newPoints;c=0;do p=e[c],S[c]=o.v3Build(p[0]-n,p[1]-r,p[2]-i,S[c]),c+=1;while(c<u);var x=Math.sqrt;c=0;do{h=c+1,h>=u&&(h=0);if(0!==(m[c]&m[h])){c+=1;continue}p=S[c];var T=p[0],N=p[1],C=p[2];p=S[h];var k=p[0],L=p[1],A=p[2],O=N*A-C*L,M=C*k-T*A,_=T*L-N*k,D=O*O+M*M+_*_;if(D===0)return t.length=0,!1;var P=1/x(D);O*=P,M*=P,_*=P;var H=O*n+M*r+_*i;t[f]=o.v4Build(O,M,_,H,t[f]),f+=1,c+=1}while(c<u);return t.length=f,E},e.prototype.findAreaIndex=function(e,t,n,r){var i=e.length,s=0,o,u;do{o=e[s],u=o.plane,s=u[0]*t+u[1]*n+u[2]*r<u[3]?o.neg:o.pos;if(s<=0)return-(s+1)}while(s<i);return-1},e.prototype.findAreaIndicesAABB=function(e,t,n,r,i,s,o){var u=e.length,a=[],f=[],l=[0],c=1,h,p,d,v;do{c-=1,h=l[c];do{p=e[h],d=p.plane;var m=d[0],g=d[1],y=d[2],b=d[3];m*(m<0?t:i)+g*(g<0?n:s)+y*(y<0?r:o)<b?h=p.neg:(m*(m>0?t:i)+g*(g>0?n:s)+y*(y>0?r:o)<=b&&(h=p.neg,h<=0?h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v))):(l[c]=h,c+=1)),h=p.pos);if(h<=0){h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v)));break}}while(h<u)}while(0<c);return a},e.prototype.findVisiblePortals=function(e,t,n,r){var i=this.visiblePortals,s=i.length,o=this.frustumPlanes,u=o.length,a=this.getQueryCounter(),f=this.areas,l,c,h,p,d,v,m,g,y=0,b=this.nearPlane,w=b[0],E=b[1],S=b[2];o[u]=this.md.v4Build(w,E,S,w*t+E*n+S*r),d=f[e],l=d.portals,c=l.length;for(v=0;v<c;v+=1){h=l[v];if(h.disabled)continue;h.queryCounter=a,p=h.plane,p[0]*t+p[1]*n+p[2]*r<p[3]&&(y<s?(g=i[y],m=g.planes):m=[],this.buildPortalPlanes(h.points,m,t,n,r,o),0<m.length&&(y<s?(g.portal=h,g.area=h.area):i[y]={portal:h,planes:m,area:h.area},y+=1))}o.length=u;if(0<y){var x,T,N,C,k,L,A,O,M=0;do{g=i[M],M+=1,m=g.planes,x=m.length,h=g.portal,e=g.area,m[x]=h.plane,d=f[e],l=d.portals,c=l.length;for(v=0;v<c;v+=1)h=l[v],T=h.area,T!==e&&h.queryCounter!==a&&!h.disabled&&(p=h.plane,N=p[0],C=p[1],k=p[2],L=p[3],N*t+C*n+k*r<L?(y<s?(g=i[y],A=g.planes):A=[],O=this.buildPortalPlanes(h.points,A,t,n,r,m),0<A.length&&(O&&(h.queryCounter=a),y<s?(g.portal=h,g.area=T):i[y]={portal:h,planes:A,area:T},y+=1)):h.queryCounter=a);m.length=x}while(M<y)}y<s&&(i.length=y)},e.prototype.findVisibleNodes=function(e,t){var n=t.length,r=this.frustumPlanes,i=!0,s=this.areas;if(s){var o=e.matrix,u=o[9],a=o[10],f=o[11],l=this.findAreaIndex(this.bspNodes,u,a,f);this.cameraAreaIndex=l;if(l>=0){e.getFrustumExtents(this.cameraExtents);var c=this.cameraExtents[0],h=this.cameraExtents[1],p=this.cameraExtents[2],d=this.cameraExtents[3],v=this.cameraExtents[4],m=this.cameraExtents[5];this.findVisiblePortals(l,u,a,f);var g,y,b,w,E=s.length;for(y=0;y<E;y+=1)g=s[y],b=g.nodes,w=g.numStaticNodes,b.length>w&&(b.length=w),g.addedDynamicNodes=!1;var S=this.isInsidePlanesAABB,x=this.dynamicSpatialMap,T=this.visiblePortals,N=T.length,C=this.getQueryCounter(),k,L,A,O,M;g=s[l],b=g.nodes,g.addedDynamicNodes=!0;var _=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter=C,S(L.worldExtents,r)&&(t[n]=L,n+=1);for(A=0;A<N;A+=1){O=T[A],M=O.planes,g=s[O.area],b=g.nodes,g.addedDynamicNodes||(g.addedDynamicNodes=!0,_=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b)),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter!==C&&S(L.worldExtents,M)&&(L.queryCounter=C,t[n]=L,n+=1)}i=!1}}i&&(n+=this.staticSpatialMap.getVisibleNodes(r,t,n),this.dynamicSpatialMap.getVisibleNodes(r,t,n))},e.prototype.findVisibleNodesTree=function(e,t,n){var r=n.length,i=this.frustumPlanes,s=!0,o=this.areas;if(o){var u=this.cameraAreaIndex;if(u>=0){var a=this.cameraExtents[0],f=this.cameraExtents[1],l=this.cameraExtents[2],c=this.cameraExtents[3],h=this.cameraExtents[4],p=this.cameraExtents[5],d=this.externalNodesStack,v,m,g,y,b,w,E,S=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6),x,T,N,C,k=o.length;for(T=0;T<k;T+=1)x=o[T],N=x.externalNodes,N&&(d.push(N),x.externalNodes=null);var L=this.isInsidePlanesAABB,A=this.findOverlappingAreas,O=this.findAreaIndex,M=this.visiblePortals,_=M.length,D=this.getQueryCounter(),P=this.bspNodes,H,B,j,F,I,q,R,U,z,W,X,V;x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter=D,L(j.worldExtents,i)&&(n[r]=j,r+=1);for(I=0;I<_;I+=1){q=M[I],H=q.planes,u=q.area,x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter!==D&&L(j.worldExtents,H)&&(j.queryCounter=D,n[r]=j,r+=1)}s=!1}}s&&e.getVisibleNodes(i,n,r)},e.prototype.buildPortalPlanesNoFrustum=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s?s.length:0,f=a,l=this.newPoints,c,h;c=0;do h=e[c],l[c]=o.v3Build(h[0]-n,h[1]-r,h[2]-i,l[c]),c+=1;while(c<u);var p=Math.sqrt;c=0;do{h=l[c];var d=h[0],v=h[1],m=h[2];h=l[c+1<u?c+1:0];var g=h[0],y=h[1],b=h[2],w=v*b-m*y,E=m*g-d*b,S=d*y-v*g,x=w*w+E*E+S*S;if(x===0)return!1;var T=1/p(x);w*=T,E*=T,S*=T;var N=w*n+E*r+S*i;t[f]=o.v4Build(w,E,S,N,t[f]),f+=1,c+=1}while(c<u);for(c=0;c<a;c+=1)t[c]=o.v4Copy(s[c],t[c]);return t.length=f,!0},e.prototype.findOverlappingPortals=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y=this.getQueryCounter(),b=this.areas,w=0,E,S=i[0],x=i[1],T=i[2],N=i[3],C=i[4],k=i[5];v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1){f=o[a];if(f.disabled)continue;f.queryCounter=y,m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T&&(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d&&(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,null)&&(E.portal=f,E.area=f.area,w+=1)))}if(0<w){var L,A,O=0;do{E=s[O],O+=1,L=E.planes,e=E.area,f=E.portal,v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1)f=o[a],A=f.area,A!==e&&f.queryCounter!==y&&!f.disabled&&(m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T?(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d?(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,L)&&(f.queryCounter=y,E.portal=f,E.area=A,w+=1)):f.queryCounter=y):f.queryCounter=y)}while(O<w)}return w},e.prototype.findOverlappingNodes=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingNodesAreas(e,t,n,r)),i&&e.getOverlappingNodes(n,r)},e.prototype.findStaticOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingNodesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=this.externalNodesStack,f=this.areas,l,c,h,p,d=f.length;for(l=0;l<d;l+=1)c=f[l],h=c.externalNodes,h&&(a.push(h),c.externalNodes=null);var v=n[0],m=n[1],g=n[2],y=n[3],b=n[4],w=n[5];c=f[u];var E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],L=this.overlappingPortals,A=this.findOverlappingPortals(u,i,s,o,n,L),O=this.isInsidePlanesAABB,M=this.getQueryCounter(),_=r.length,D,P,H,B,j;0<a.length?h=a.pop():h=[],c.externalNodes=h;var F=this.testExtents;F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter=M,r[_]=H,_+=1;for(B=0;B<A;B+=1){j=L[B],D=j.planes,c=f[j.area],h=c.externalNodes,h||(0<a.length?h=a.pop():h=[],c.externalNodes=h,E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0)),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter!==M&&O(H.worldExtents,D)&&(H.queryCounter=M,r[_]=H,_+=1)}return!0},e.prototype.findOverlappingRenderables=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingRenderablesAreas(e,t,n,r)),i&&this._findOverlappingRenderablesNoAreas(e,n,r)},e.prototype.findStaticOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingRenderablesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=r.length,f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5],v,m,g,y,b,w,E,S,x,T=this.externalNodesStack,N=this.areas,C,k,L,A=N.length;for(C=0;C<A;C+=1)k=N[C],L=k.externalNodes,L&&(T.push(L),k.externalNodes=null);k=N[u];var O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],j=this.overlappingPortals,F=this.findOverlappingPortals(u,i,s,o,n,j),I=this.isInsidePlanesAABB,q=this.isFullyInsidePlanesAABB,R=this.getQueryCounter(),U,z,W,X,V;0<T.length?L=T.pop():L=[],k.externalNodes=L;var $=this.testExtents;$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0),m=L.length;for(g=0;g<m;g+=1){v=L[g],v.queryCounter=R,b=v.renderables;if(b){w=b.length;if(w===1)r[a]=b[0],a+=1;else{E=v.worldExtents;if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)for(S=0;S<w;S+=1)r[a]=b[S],a+=1;else for(S=0;S<w;S+=1)y=b[S],x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&(r[a]=y,a+=1)}}}for(W=0;W<F;W+=1){X=j[W],U=X.planes,k=N[X.area],L=k.externalNodes,L||(0<T.length?L=T.pop():L=[],k.externalNodes=L,O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0)),m=L.length;for(z=0;z<m;z+=1){v=L[z];if(v.queryCounter!==R){V=!0,b=v.renderables;if(b){E=v.worldExtents;if(I(E,U)){w=b.length;if(w===1)y=b[0],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(I(y.getWorldExtents(),U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&I(x,U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1)}else V=!1}V&&(v.queryCounter=R)}}}return!0},e.prototype._findOverlappingRenderablesNoAreas=function(e,t,n){var r=n.length,i=t[0],s=t[1],o=t[2],u=t[3],a=t[4],f=t[5],l=this.queryVisibleNodes,c,h,p,d,v,m,g,y,b;h=e.getOverlappingNodes(t,l,0);for(p=0;p<h;p+=1){c=l[p],v=c.renderables;if(v){m=v.length;if(m===1)n[r]=v[0],r+=1;else{g=c.worldExtents;if(g[0]>=i&&g[1]>=s&&g[2]>=o&&g[3]<=u&&g[4]<=a&&g[5]<=f)for(y=0;y<m;y+=1)n[r]=v[y],r+=1;else for(y=0;y<m;y+=1)d=v[y],b=d.getWorldExtents(),b[3]>=i&&b[4]>=s&&b[5]>=o&&b[0]<=u&&b[1]<=a&&b[2]<=f&&(n[r]=d,r+=1)}}}},e.prototype.cloneRootNode=function(e,t){var n=e.clone(t);return this.addRootNode(n),n},e.prototype.updateVisibleNodes=function(e){var t=!0;this.areas&&(t=!this._updateVisibleNodesAreas(e)),t&&this._updateVisibleNodesNoAreas(e),this.frameIndex+=1},e.prototype._updateVisibleNodesNoAreas=function(e){var t=this.visibleNodes,n=0,r=this.visibleRenderables,i=0,s=this.visibleLights,o=0;this.extractFrustumPlanes(e);var u=this.frustumPlanes,a=this.frameIndex,f=this.nearPlane,l=f[0],c=f[1],h=f[2],p=f[3],d=0,v,m,g=this.isFullyInsidePlanesAABB,y=this.isInsidePlanesAABB,b=this.queryVisibleNodes,w=this.staticSpatialMap.getVisibleNodes(u,b,0);w+=this.dynamicSpatialMap.getVisibleNodes(u,b,w);for(v=0;v<w;v+=1){m=b[v];if(!m.disabled){var E=m.worldExtents,S,x,T,N,C;m.frameVisible=a,S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,m.distance=S;if(0<S){t[n]=m,n+=1;var k=m.renderables,L=k?k.length:0,A=m.lightInstances,O=A?A.length:0,M=1<O+L?g(E,u):!1;if(k)if(L===1&&!A)x=k[0],x.disabled||(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1);else for(T=0;T<L;T+=1){x=k[T];if(!x.disabled){E=x.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1)}}if(A)if(O===1&&!k)N=A[0],!N.disabled&&!N.light.isGlobal()&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1);else for(C=0;C<O;C+=1){N=A[C];if(!N.disabled&&!N.light.isGlobal()){E=N.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1)}}}}}this.maxDistance=d+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,n,i,o):(r.length=i,s.length=o,t.length=n)},e.prototype._updateVisibleNodesAreas=function(e){function D(e,t){var n=e.worldExtents,r=!0,i;e.frameVisible!==p?(e.frameVisible=p,i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,e.distance=i,0<i&&(o[u]=e,u+=1)):i=e.distance;if(0<i){var s,h,d,w,E=e.renderables,T=E?E.length:0,N=e.lightInstances,C=N?N.length:0,k=1<C+T?S(n,t):!1;if(E)if(T===1&&!N)s=E[0],!s.disabled&&s.queryCounter!==_&&(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1);else for(h=0;h<T;h+=1)s=E[h],!s.disabled&&s.queryCounter!==_&&(n=s.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1):r=!1):r=!1);if(N)if(C===1&&!E)d=N[0],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1);else for(w=0;w<C;w+=1)d=N[w],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(n=d.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1):r=!1):r=!1)}r&&(e.queryCounter=_)}var t=e.matrix,n=t[9],r=t[10],i=t[11],s=this.findAreaIndex(this.bspNodes,n,r,i);this.cameraAreaIndex=s;if(s<0)return!1;var o=this.visibleNodes,u=0,a=this.visibleRenderables,f=0,l=this.visibleLights,c=0;this.extractFrustumPlanes(e);var h=this.frustumPlanes,p=this.frameIndex,d=this.nearPlane,v=d[0],m=d[1],g=d[2],y=d[3],b=0,w=0,E,S=this.isFullyInsidePlanesAABB,x=this.isInsidePlanesAABB,T=this.cameraExtents;e.getFrustumExtents(T);var N=T[0],C=T[1],k=T[2],L=T[3],A=T[4],O=T[5],M=this.areas,_=this.getQueryCounter();this.findVisiblePortals(s,n,r,i);var P,H,B,j,F=M.length;for(H=0;H<F;H+=1)P=M[H],B=P.nodes,j=P.numStaticNodes,B.length>j&&(B.length=j),P.addedDynamicNodes=!1;var I=this.dynamicSpatialMap,q=this.visiblePortals,R=q.length,U,z,W;P=M[s],B=P.nodes,P.addedDynamicNodes=!0;var X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5],Y=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter=_,!E.disabled&&x(E.worldExtents,h)&&D(E,h);for(U=0;U<R;U+=1){z=q[U],W=z.planes,P=M[z.area],B=P.nodes,X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5];if(L>V&&A>$&&O>J&&K>N&&Q>C&&G>k){P.addedDynamicNodes||(P.addedDynamicNodes=!0,Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B)),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter!==_&&(E.disabled?E.queryCounter=_:x(E.worldExtents,W)&&D(E,W))}}return this.maxDistance=b+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,u,f,c):(a.length=f,l.length=c,o.length=u),!0},e.prototype._filterVisibleNodesForCameraBox=function(e,t,n,r){var i=this.visibleNodes,s=this.visibleRenderables,o=this.visibleLights,u=n,a=r,f=this.cameraExtents;e.getFrustumExtents(f,this.maxDistance);var l=f[0],c=f[1],h=f[2],p=f[3],d=f[4],v=f[5],m,g,y,b,w=0;while(w<n){g=s[w],b=g.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){g.frameVisible-=1,n-=1;if(!(w<n))break;s[w]=s[n]}else w+=1}w=0;while(w<r){y=o[w],b=y.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){y.frameVisible-=1,r-=1;if(!(w<r))break;o[w]=o[r]}else w+=1}if(u!==n||a!==r){w=0;while(w<t){m=i[w],b=m.worldExtents;if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){m.frameVisible-=1,t-=1;if(!(w<t))break;i[w]=i[t]}else w+=1}}s.length=n,o.length=r,i.length=t},e.prototype.getCurrentVisibleNodes=function(){return this.visibleNodes},e.prototype.getCurrentVisibleRenderables=function(){return this.visibleRenderables},e.prototype.getCurrentVisibleLights=function(){return this.visibleLights},e.prototype.addRootNodeToUpdate=function(e,t){var n=this.dirtyRoots;if(n[t]!==e){n[t]=e;var r=this.numNodesToUpdate;this.nodesToUpdate[r]=e,this.numNodesToUpdate=r+1}},e.prototype.updateNodes=function(){var e=this.numNodesToUpdate;if(0<e){var t=this.nodesToUpdate,n=this.dirtyRoots,r;for(r=0;r<e;r+=1)n[t[r].name]=null;kt.updateNodes(this.md,this,t,e),this.numNodesToUpdate=0}},e.prototype.update=function(){this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents(),this.areas&&this.staticNodesChangeCounter!==this.areaInitalizeStaticNodesChangeCounter&&this.initializeAreas()},e.prototype.updateExtents=function(){var e=this.staticSpatialMap.getExtents(),t=this.dynamicSpatialMap.getExtents(),n=this.extents;if(e)if(t){var r,i,s,o,u,a,f,l,c,h,p,d;r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=t[0],l=t[1],c=t[2],h=t[3],p=t[4],d=t[5],n[0]=r<f?r:f,n[1]=i<l?i:l,n[2]=s<c?s:c,n[3]=o>h?o:h,n[4]=u>p?u:p,n[5]=a>d?a:d}else n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5];else t?(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5]):(n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=0)},e.prototype.getExtents=function(){return 0<this.numNodesToUpdate&&(this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents()),this.extents},e.prototype.loadMaterial=function(e,t,n,r,i){var s=this.materials;if(!s[r]){var o=i.effect||"default",u=this.createMaterial(r,i,o,null,null,e);if(u){delete u.effectName;var a=n.get(o);return a&&a.prepareMaterial(u),u.loadTextures(t),!0}}return!1},e.prototype.hasMaterial=function(e){var t=this.materials[e];return t?!0:!1},e.prototype.getMaterial=function(e){return this.materials[e]},e.prototype.drawNodesArray=function(e,t,n,r,i){var s=e.length;if(s>0){var o=t.setTechnique,u=t.setTechniqueParameters,a=t.setStream,f=t.setIndexBuffer,l=t.drawIndexed,c=t.draw,h=null,p=null,d=null,v=-1,m,g,y,b,w,E,S,x,T,N,C,k,L,A=0;o.call(t,r),u.call(t,n);do{m=e[A],N=m.renderables;if(N){k=N.length;for(L=0;L<k;L+=1){C=N[L],i.call(C),g=C.geometry,w=g.vertexBuffer,S=g.vertexOffset,E=g.semantics,x=C.surface,y=C.sharedMaterial.techniqueParameters,b=C.techniqueParameters,h!==y?(h=y,u.call(t,y,b)):u.call(t,b);if(p!==w||d!==E||v!==S)p=w,d=E,v=S,a.call(t,w,E,S);T=x.indexBuffer,T?(f.call(t,T),l.call(t,x.primitive,x.numIndices,x.first)):c.call(t,x.primitive,x.numVertices,x.first)}}A+=1}while(A<s)}},e.prototype.drawVisibleNodes=function(e,t,n,r){this.drawNodesArray(this.visibleNodes,e,t,n,r)},e.prototype.clearMaterials=function(){var e=this.onMaterialDestroyed,t=this.materials;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.materials={}},e.prototype.clearShapes=function(){var e=this.onGeometryDestroyed,t=this.shapes;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.shapes={}},e.prototype.clearShapesVertexData=function(){var e=this.shapes,t;if(e)for(var n in e)if(e.hasOwnProperty(n)){t=e[n],delete t.vertexData,delete t.indexData;var r=t.surfaces;if(r)for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];delete s.vertexData,delete s.indexData}}},e.prototype.clearRootNodes=function(){var e=this.rootNodes;if(e){var t=e.length;for(var n=0;n<t;n+=1)e[n].destroy()}this.rootNodes=[],this.rootNodesMap={},this.dirtyRoots={},this.nodesToUpdate=[],this.numNodesToUpdate=0},e.prototype.clear=function(){this.effects=[],this.effectsMap={},this.semantics={},this.lights={},this.globalLights=[],this.clearRootNodes(),this.clearMaterials(),this.clearShapes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear(),this.frustumPlanes=[],this.animations={},this.skeletons={},this.extents=this.md.aabbBuildEmpty(),this.visibleNodes=[],this.visibleRenderables=[],this.visibleLights=[],this.cameraAreaIndex=-1,this.cameraExtents=this.md.aabbBuildEmpty(),this.visiblePortals=[],this.frameIndex=0,this.queryCounter=0,this.staticNodesChangeCounter=0,this.testExtents=this.md.aabbBuildEmpty(),this.externalNodesStack=[],this.overlappingPortals=[],this.newPoints=[],this.queryVisibleNodes=[]},e.prototype.endLoading=function(e){this.initializeNodes(),this.initializeAreas(),e&&e(this)},e.prototype.initializeNodes=function(){var e=this.numNodesToUpdate;0<e&&(this.numNodesToUpdate=0,this.dirtyRoots={},kt.updateNodes(this.md,this,this.nodesToUpdate,e)),this.staticSpatialMap.finalize(),this.updateExtents()},e.prototype.addAreaStaticNodes=function(){var e=this.findAreaIndicesAABB,t=this.findAreaIndex,n=this,r=function(s,o){if(this.dynamic)return;if(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents){var u=this.worldExtents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d,v,m,g,y;if(!this.hasRenderables()&&this.lightInstances.length===1&&this.lightInstances[0].light.spot){var b=this.world;m=b[9],g=b[10],y=b[11]}else m=(a+c)*.5,g=(f+h)*.5,y=(l+p)*.5;var w=t(s,m,g,y);if(w>=0){d=o[w],d.nodes.push(this);var E=n.findOverlappingAreas(w,u),S=E.length;for(v=0;v<S;v+=1)E[v].nodes.push(this)}else{var x=!1,T;for(;;){var N=e(s,a,f,l,c,h,p),C=N.length;if(0<C){v=0;do d=o[N[v]],T=d.extents,T[0]<=c&&T[1]<=h&&T[2]<=p&&T[3]>=a&&T[4]>=f&&T[5]>=l&&(d.nodes.push(this),x=!0),v+=1;while(v<C);if(!x){v=0;do o[N[v]].nodes.push(this),v+=1;while(v<C)}break}var k=Math.max(c-a,h-f,p-l)/20;a-=k,f-=k,l-=k,c+=k,h+=k,p+=k}}}var L=this.children;if(L){var A=L.length;for(var O=0;O<A;O+=1)r.call(L[O],s,o)}},i=this.rootNodes,s=i.length,o=this.bspNodes,u=this.areas;for(var a=0;a<s;a+=1)r.call(i[a],o,u)},e.prototype.findOverlappingAreas=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v=this.getQueryCounter(),m=this.areas,g=[],y=0,b=[],w=0,E=t[0],S=t[1],x=t[2],T=t[3],N=t[4],C=t[5];r=m[e],r.queryCounter=v,i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1))}while(0<y){y-=1,u=g[y],p=u.area,r=m[p],r.queryCounter!==v&&(r.queryCounter=v,b[w]=r,w+=1),i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;d=u.area,d!==p&&d!==e&&u.queryCounter!==v&&(u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1)))}}return b},e.prototype.checkAreaDynamicNodes=function(){var e=this.findAreaIndicesAABB,t=this.dynamicSpatialMap,n=this.bspNodes,r=this.areas,i=function(){if(this.dynamic&&(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents)){var o=this.worldExtents,u=o[0],a=o[1],f=o[2],l=o[3],c=o[4],h=o[5],p=!1,d=!1,v;for(;;){var m=e(n,u,a,f,l,c,h),g=m.length;if(0<g){v=0;do{var y=r[m[v]],b=y.extents;if(b[0]<=l&&b[1]<=c&&b[2]<=h&&b[3]>=u&&b[4]>=a&&b[5]>=f){d=!0;break}v+=1}while(v<g)}if(d)break;var w=Math.max(l-u,c-a,h-f)/20;u-=w,a-=w,f-=w,l+=w,c+=w,h+=w,p=!0}p&&(o[0]=u,o[1]=a,o[2]=f,o[3]=l,o[4]=c,o[5]=h,t.update(this,o))}var E=this.children;if(E){var S=E.length;for(var x=0;x<S;x+=1)i.call(E[x])}},s=this.rootNodes,o=s.length;for(var u=0;u<o;u+=1)i.call(s[u])},e.prototype.initializeAreas=function(){var e=this.areas;if(e){var t=e.length,n,r,i,s,o;for(n=0;n<t;n+=1)r=e[n],i=r.target,r.nodes=[],s=i.calculateHierarchyWorldExtents(),s&&(o=r.extents,o[0]=s[0]<o[0]?s[0]:o[0],o[1]=s[1]<o[1]?s[1]:o[1],o[2]=s[2]<o[2]?s[2]:o[2],o[3]=s[3]>o[3]?s[3]:o[3],o[4]=s[4]>o[4]?s[4]:o[4],o[5]=s[5]>o[5]?s[5]:o[5]);this.addAreaStaticNodes(),this.checkAreaDynamicNodes();for(n=0;n<t;n+=1)r=e[n],r.numStaticNodes=r.nodes.length}this.areaInitalizeStaticNodesChangeCounter=this.staticNodesChangeCounter},e.prototype.createMaterial=function(e,t,n,r,i,s){var o=this.materials,u=Tt.create(s),a,f,l,c,h;if(r){var p=r[n];if(p){var d=p.parameters;for(c in d)d.hasOwnProperty(c)&&(a=d[c],typeof a=="string"?(i?f=i[a]||a:f=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[c]=f,u.techniqueParameters[c]=null):u.techniqueParameters[c]=a);l=p.type,h=p.meta}else l=n}else l=n;var v=t.parameters;for(c in v)v.hasOwnProperty(c)&&(a=v[c],typeof a=="string"?(i?f=i[a]||a:f=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[c]=f,u.techniqueParameters[c]=null):u.techniqueParameters[c]=a);u.effectName=l;var m=t.meta;if(m){if(h)for(c in h)h.hasOwnProperty(c)&&!m.hasOwnProperty(c)&&(m[c]=h[c]);u.meta=m}else h&&(u.meta=h);return o[e]=u,u.name=e,u.reference.subscribeDestroyed(this.onMaterialDestroyed),u},e.prototype.loadMaterials=function(e){var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=this.createMaterial;e.append||(this.effects=[],this.effectsMap={},this.clearMaterials());var s=t.materials;if(s){var o=t.images,u=t.effects,a=this.materials;for(var f in s)if(s.hasOwnProperty(f)&&!a[f]){var l=s[f],c=l.effect||"default";i.call(this,f,l,c,u,o,n,r)}}},e.prototype.loadSkeletons=function(e){var t=e.data,n=t.skeletons,r=this.md,i=r.m43Build,s,o;for(var u in n)if(n.hasOwnProperty(u)){var a=n[u],f=a.numNodes,l=a.invBoneLTMs,c=a.bindPoses;for(var h=0;h<f;h+=1)s=l[h],o=c[h],l[h]=i.apply(r,s),c[h]=i.apply(r,o);e.skeletonNamePrefix&&(u=e.skeletonNamePrefix+u),this.skeletons[u]=a}},e.prototype._updateSingleIndexTables=function(e,t,n,r,i){var s=e.faces,o=s.length,u=[];u.length=o;var a=n.length,f=0,l=0,c,h,p,d,v,m;while(l<o){d=r,c=l,h=l+(t-1);do p=s[c],v=d[p],v===undefined&&(d[p]=v={}),d=v,c+=1;while(c<h);p=s[c],m=d[p];if(m===undefined){d[p]=m=i,i+=1,c=l;do n[a]=s[c],a+=1,c+=1;while(c<h);n[a]=p,a+=1}u[f]=m,f+=1,l+=t}return u.length=f,e.faces=u,i},e.prototype._isSequentialIndices=function(e,t){var n=e[0],r;for(r=1;r<t;r+=1)if(e[r]!==n+r)return!1;return!0},e.prototype._optimizeRenderables=function(e,t){function g(e){var t=new e.constructor,n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}var n=e.renderables,r=n.length,i=t.PRIMITIVE_TRIANGLES,s={},o=[],u=0,a,f,l,c,h,p,d,v,m=!1;for(a=0;a<r;a+=1)f=n[a],c=f.surface,c.primitive===i&&f.geometryType==="rigid"?(l=f.geometry,h=l.vertexBuffer.id,p=s[h],p===undefined&&(s[h]=p={}),c.indexBuffer?d=c.indexBuffer.id:d="null",v=p[d],v===undefined?p[d]=[f]:(v.push(f),m=!0)):(o[u]=f,u+=1);if(m){var y=Math.max,b=Math.min,w=this.float32ArrayConstructor?this.float32ArrayConstructor:Array,E=new w(6),S,x,T,N,C,k,L,A,O,M,_,D=function(){var t=g(S.surface);S.surface=t,t.indexBuffer?(t.numIndices=N-t.first,t.numVertices=C):t.numVertices=N-t.first;var n=(E[3]+E[0])*.5,r=(E[4]+E[1])*.5,i=(E[5]+E[2])*.5;if(n!==0||r!==0||i!==0){var s=S.center||new w(3);S.center=s,s[0]=n,s[1]=r,s[2]=i}else S.center=null;var o=S.halfExtents||new w(3);S.halfExtents=o,o[0]=(E[3]-E[0])*.5,o[1]=(E[4]-E[1])*.5,o[2]=(E[5]-E[2])*.5};r=0;for(h in s)if(s.hasOwnProperty(h)){p=s[h];for(d in p)if(p.hasOwnProperty(d)){v=p[d],k=v.length;if(k===1)n[r]=v[0],r+=1;else{v.sort(function(e,t){return e.geometry.vertexOffset-t.geometry.vertexOffset||e.surface.first-t.surface.first}),L=0,A=null,S=null,C=0,T=-1,N=0,x=0;do f=v[L],l=f.geometry,c=f.surface,O=f.sharedMaterial,M=f.center,_=f.halfExtents,T!==l.vertexOffset||N!==c.first||!A||A!==O&&!A.isSimilar(O)?(0<x&&(1<x&&D(),n[r]=S,r+=1),A=O,S=f,C=0,x=1,T=l.vertexOffset,M?(E[0]=M[0]-_[0],E[1]=M[1]-_[1],E[2]=M[2]-_[2],E[3]=M[0]+_[0],E[4]=M[1]+_[1],E[5]=M[2]+_[2]):(E[0]=-_[0],E[1]=-_[1],E[2]=-_[2],E[3]=_[0],E[4]=_[1],E[5]=_[2])):(x+=1,M?(E[0]=b(E[0],M[0]-_[0]),E[1]=b(E[1],M[1]-_[1]),E[2]=b(E[2],M[2]-_[2]),E[3]=y(E[3],M[0]+_[0]),E[4]=y(E[4],M[1]+_[1]),E[5]=y(E[5],M[2]+_[2])):(E[0]=b(E[0],-_[0]),E[1]=b(E[1],-_[1]),E[2]=b(E[2],-_[2]),E[3]=y(E[3],_[0]),E[4]=y(E[4],_[1]),E[5]=y(E[5],_[2]))),c.indexBuffer?(N=c.first+c.numIndices,C+=c.numVertices):N=c.first+c.numVertices,L+=1;while(L<k);1<x&&D(),n[r]=S,r+=1}}}for(a=0;a<u;a+=1)n[r]=o[a],r+=1;for(a=r;a<n.length;a+=1)n[a].setNode(null);n.length=r}},e.prototype.loadShape=function(e,t,n){var r=this.shapes[e];if(!r){var i=this.semantics,s=n.data,o=n.graphicsDevice,u=n.keepVertexData,a=s.geometries,f=a[t],l=f.sources,c=f.inputs,h=n.skeletonNamePrefix?n.skeletonNamePrefix+f.skeleton:f.skeleton;r=St.create();if(h){var p=this.skeletons[h];p?(r.skeleton=p,r.type="skinned"):r.type="rigid"}else r.type="rigid";if(o){var d,v,m,g,y=0,b=[],w=function(t,n){return t>=0&&n<=255&&n>=0},E=function(t,n,r){var i=t.length;if(n.length!==i)return!1;for(var s=0;s<i;s+=1)if(!r(t[s],n[s]))return!1;return!0},S=n.vertexFormatMap||{},x;for(var T in c)if(c.hasOwnProperty(T)){if(o["SEMANTIC_"+T]===undefined)continue;x=c[T],d=x.offset,d>y&&(y=d);var N=l[x.source],C=N.stride;g=S[T],m=C,g&&(g.indexOf("4")?m=4:g.indexOf("3")?m=3:g.indexOf("2")?m=2:g.indexOf("1")?m=1:g=null),g||(T==="BLENDINDICES"||T==="BLENDINDICES0")&&C===4&&E(N.min,N.max,w)&&(g="UBYTE4"),g||(g="FLOAT"+C),b.push({semantic:T,offset:d,data:N.data,stride:C,destFormat:g,destStride:m})}var k=y+1;if(0<y){var L=function(e,t){if(e.offset===t.offset){var n=e.semantic;typeof n=="string"&&(n=o["SEMANTIC_"+n]);var r=t.semantic;return typeof r=="string"&&(r=o["SEMANTIC_"+r]),n-r}return e.offset-t.offset};b.sort(L)}var A=b.length,O=[],M=[],_=this.float32ArrayConstructor?!0:!1,D=0,P,H;for(P=0;P<A;P+=1)H=b[P],O[P]=H.semantic,g=H.destFormat,_&&(typeof g=="string"?g[0]!=="F"&&(_=!1):g!==o.VERTEXFORMAT_FLOAT1&&g!==o.VERTEXFORMAT_FLOAT2&&g!==o.VERTEXFORMAT_FLOAT3&&g!==o.VERTEXFORMAT_FLOAT4&&(_=!1)),M[P]=g,D+=H.stride;var B,j=0,F=!1,I=f.surfaces;I||(F=!0,I={singleSurface:{triangles:f.triangles,lines:f.lines,numPrimitives:f.numPrimitives}});var q,R,U,z;for(z in I)if(I.hasOwnProperty(z)){q=I[z],R={},r.surfaces[z]=R,U=q.triangles;var W,X;U?(W=o.PRIMITIVE_TRIANGLES,X=3):(U=q.lines,U&&(W=o.PRIMITIVE_LINES,X=2)),R.primitive=W,R.faces=U,U&&(1<k?(B=q.numPrimitives*X,R.numVertices=B):(B=b[0].data.length/b[0].stride,B>U.length&&(B=U.length),R.numVertices=B))}if(k>1){j=0;var V=[],$={},J=r.surfaces;for(z in J)if(J.hasOwnProperty(z)){var K=J[z];j=this._updateSingleIndexTables(K,k,V,$,j)}$=null;for(P=0;P<A;P+=1){H=b[P];var Q=H.offset,G=H.stride,Y=H.data,Z=new Array(G*j),et=0,tt=Q;while(et<j){var nt=G*et,rt=G*V[tt];for(var it=0;it<G;it+=1)Z[nt+it]=Y[rt+it];et+=1,tt+=k}H.data=Z,H.offset=0}V.length=0,V=null,k=1}j=b[0].data.length/b[0].stride;var st=n.vertexBufferManager||this.vertexBufferManager;st||(st=nn.create(o),this.vertexBufferManager=st);var ot=n.indexBufferManager||this.indexBufferManager;ot||(ot=rn.create(o),this.indexBufferManager=ot);var ut,at=null,ft=st.allocate(j,M);at=ft
.vertexBuffer;if(!at)return undefined;r.vertexBuffer=at,r.vertexBufferManager=st,r.vertexBufferAllocation=ft,ut=ft.baseIndex;var lt,ct,ht,pt,dt=_?new this.float32ArrayConstructor(j*D):new Array(j*D),vt=0;for(ct=0;ct<j;ct+=1){P=0;do{H=b[P];var mt=H.data;v=H.stride,ht=ct*v,pt=ht+v,m=H.destStride;do dt[vt]=mt[ht],vt+=1,ht+=1;while(ht<pt);while(v<m)dt[vt]=0,vt+=1,m-=1;P+=1}while(P<A)}at.setData(dt,ut,j),u&&!_&&this.float32ArrayConstructor&&(dt=new this.float32ArrayConstructor(dt));var gt=0,yt;for(z in I)if(I.hasOwnProperty(z)){R=r.surfaces[z],U=R.faces;if(U){yt=U.length;if(yt===6&&j===4&&R.primitive===o.PRIMITIVE_TRIANGLES){var bt=U[0];if(bt===U[3]||bt===U[4]||bt===U[5]){U[0]=U[1],U[1]=U[2],U[2]=bt,bt=U[0];if(bt===U[3]||bt===U[4]||bt===U[5])U[0]=U[1],U[1]=U[2],U[2]=bt}var wt=U[5];if(wt===U[1]||wt===U[2]){U[5]=U[4],U[4]=U[3],U[3]=wt,wt=U[5];if(wt===U[1]||wt===U[2])U[5]=U[4],U[4]=U[3],U[3]=wt}U[1]===U[4]&&U[2]===U[3]&&(R.primitive=o.PRIMITIVE_TRIANGLE_STRIP,yt=4,U=[U[0],U[1],U[2],U[5]],R.faces=U)}this._isSequentialIndices(U,yt)||(gt+=yt)}}var Et,xt,Tt,Nt,Ct;if(0<gt){Ct=ut+j-1;if(Ct>=65536)if(j<=65536){var kt=ut>>>16<<16;ut-=kt,ut+j>65536?(kt+=ut+j-65536,ut=65536-j,Ct=65535):Ct=ut+j-1,r.vertexOffset=kt}else r.vertexOffset=0;else r.vertexOffset=0;lt=ot.allocate(gt,Ct<65536?"USHORT":"UINT"),Et=lt.indexBuffer;if(!Et)return undefined;r.indexBufferManager=ot,r.indexBufferAllocation=lt,Ct<65536&&this.uint16ArrayConstructor?xt=new this.uint16ArrayConstructor(gt):this.uint32ArrayConstructor?xt=new this.uint32ArrayConstructor(gt):xt=new Array(gt),Tt=lt.baseIndex,Nt=0}for(z in I)if(I.hasOwnProperty(z)){R=r.surfaces[z],U=R.faces,delete R.faces;if(U){yt=U.length;if(!this._isSequentialIndices(U,yt)){R.indexBuffer=Et,R.numIndices=yt,R.first=Tt+Nt,R.numVertices=j;if(ut)for(ct=0;ct<yt;ct+=1)xt[Nt]=ut+U[ct],Nt+=1;else for(ct=0;ct<yt;ct+=1)xt[Nt]=U[ct],Nt+=1;u&&(Ct<65536&&this.uint16ArrayConstructor?R.indexData=new this.uint16ArrayConstructor(U):this.uint32ArrayConstructor?R.indexData=new this.uint32ArrayConstructor(U):R.indexData=U)}else R.first=ut+U[0];U=null,u&&(R.vertexData=dt)}else delete r.surfaces[z]}Et&&(Et.setData(xt,Tt,gt),xt=null);var Lt=O.join(),At=i[Lt];At||(At=o.createSemantics(O),i[Lt]=At),r.semantics=At,F&&(q=r.surfaces.singleSurface,q&&(r.primitive=q.primitive,u&&(r.vertexData=q.vertexData),r.first=q.first,r.numVertices=q.numVertices,q.indexBuffer&&(r.indexBuffer=q.indexBuffer,r.numIndices=q.numIndices,u&&(r.indexData=q.indexData))),delete r.surfaces)}if(c.POSITION){var Ot=l[c.POSITION.source],Mt=Ot.min,_t=Ot.max;if(Mt&&_t){var Dt=Mt[0],Pt=Mt[1],Ht=Mt[2],Bt=_t[0],jt=_t[1],Ft=_t[2],It,qt;if(Dt!==-Bt||Pt!==-jt||Ht!==-Ft){if(this.float32ArrayConstructor){var Rt=new this.float32ArrayConstructor(6);qt=Rt.subarray(0,3),It=Rt.subarray(3,6)}else qt=new Array(3),It=new Array(3);qt[0]=(Dt+Bt)*.5,qt[1]=(Pt+jt)*.5,qt[2]=(Ht+Ft)*.5,It[0]=Bt-qt[0],It[1]=jt-qt[1],It[2]=Ft-qt[2]}else It=this.float32ArrayConstructor?new this.float32ArrayConstructor(3):new Array(3),It[0]=(Bt-Dt)*.5,It[1]=(jt-Pt)*.5,It[2]=(Ft-Ht)*.5;r.center=qt,r.halfExtents=It}}return this.shapes[e]=r,r.name=e,r.reference.subscribeDestroyed(this.onGeometryDestroyed),r}throw"Geometry '"+e+"' already exists in the scene"},e.prototype.streamShapes=function(e,t){var n=e.yieldFn,r=this,i=e.shapesNamePrefix,s=e.data,o=s.geometries,u=e.loadCustomShapeFn,a=[],f=[];for(var l in o)if(o.hasOwnProperty(l)){var c=o[l];c.meta&&c.meta.graphics&&(c.meta.custom?f.push(l):a.push(l))}var h=function(){var o=a.pop(),u=i?i+"-"+o:o;r.loadShape(u,o,e),a.length?n(h):n(t)},p=function(){var o=f.pop(),l=i?i+"-"+o:o;u.call(r,l,o,e),f.length?n(p):a.length?n(h):n(t)};f.length?n(p):a.length?n(h):n(t)},e.prototype.loadLights=function(e){var t=e.data,n=e.textureManager;e.append||(this.lights={},this.globalLights=[]);var i=t.lights,s=this.lights,o=this.globalLights,u=this.materials,a=r.beget,f=e.mathDevice,l=f.v3Build;for(var c in i)if(i.hasOwnProperty(c)&&!s[c]){var h=i[c],p=a(h),d=h.type;d==="directional"?p.directional=!0:d==="spot"?p.spot=!0:d==="ambient"?p.ambient=!0:p.point=!0,p.color=h.color&&l.apply(f,h.color),p.origin=h.origin&&l.apply(f,h.origin),p.center=h.center&&l.apply(f,h.center),p.target=h.target&&l.apply(f,h.target),p.right=h.right&&l.apply(f,h.right),p.up=h.up&&l.apply(f,h.up),p.start=h.start&&l.apply(f,h.start),p.end=h.end&&l.apply(f,h.end),p.direction=h.direction&&l.apply(f,h.direction),p.halfExtents=h.halfextents&&l.apply(f,h.halfextents);var v=h.material;if(v){var m=u[v];m&&(p.material=m,m.effectName&&(delete m.effectName,m.loadTextures(n)))}var g=Nt.create(p);s[c]=g,g.isGlobal()&&o.push(g)}},e.prototype.loadNodes=function(e){function E(e,t){function n(e){var t=Math.abs;return t(1-e[0])<1e-5&&t(0-e[1])<1e-5&&t(0-e[2])<1e-5&&t(0-e[3])<1e-5&&t(1-e[4])<1e-5&&t(0-e[5])<1e-5&&t(0-e[6])<1e-5&&t(0-e[7])<1e-5&&t(1-e[8])<1e-5&&t(0-e[9])<1e-5&&t(0-e[10])<1e-5&&t(0-e[11])<1e-5}if((!t.camera||!e.camera)&&t.disabled===e.disabled&&t.dynamic===e.dynamic&&t.kinematic===e.kinematic&&(!t.local||n(t.local))){t.renderables&&e.addRenderableArray(t.renderables),t.lightInstances&&e.addLightInstanceArray(t.lightInstances),t.camera&&(e.camera=t.camera);var r=t.children;if(r){var i,s=r;for(i=0;i<s;i+=1)E(e,t)||e.addChild(t)}return!0}return!1}var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=e.effectManager,s=e.baseScene,o=e.keepCameras,u=e.keepLights,a=e.optimizeHierarchy,f=e.optimizeRenderables,l=e.disabled;e.append||(this.clearRootNodes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear());var c=e.loadCustomGeometryInstanceFn,h=this.md,p=h.m43Build,d=this.materials,v=this.lights,m=this,g;s&&(g=s.materials);var y=e.baseMatrix,b=e.nodesNamePrefix,w=e.shapesNamePrefix,S=function(y,b,x,T){var N=b?b+"/"+y:y,C=kt.create({name:y,local:this.matrix&&p.apply(h,this.matrix),dynamic:this.dynamic||x.dynamic||e.dynamic}),k,L=this.customgeometryinstances;if(L&&c)for(var A in L)if(L.hasOwnProperty(A)){var O=L[A],M=c.call(m,O,e);M&&C.addRenderable(M)}var _=this.geometryinstances;if(_)for(var D in _)if(_.hasOwnProperty(D)){var P=_[D],H=P.geometry,B=w?w+"-"+H:H,j=m.shapes[B];j||(j=m.loadShape(B,H,e));if(n){var F=P.material;if(T&&t.skins){var I=t.skins[T];if(I){var q=I[F];q&&(F=q)}}var R=d[F];if(!R){g&&(R=g[F]);if(!R)return undefined;d[F]=R,R.name=F,R.reference.subscribeDestroyed(m.onMaterialDestroyed)}k=R.effect;if(!k){R.loadTextures(r);var U=R.effectName;delete R.effectName,k=i.get(U),k&&k.prepareMaterial(R)}var z=j.surfaces,W=z?z[P.surface]:j,X=xt.create(j,W,R);C.addRenderable(X),P.disabled&&(X.disabled=!0)}else C.addRenderable(xt.create(j,null,null))}this.camera&&o&&(C.camera=this.camera);var V=this.lightinstances;if(V&&u)for(var $ in V)if(V.hasOwnProperty($)){var J=V[$],K=v[J.light];if(K&&!K.global){var Q=Ct.create(K);C.addLightInstance(Q),J.disabled&&(Q.disabled=!0)}}this.reference&&alert("Found unresolved node reference during scene loading");if(this.kinematic||x.kinematic)C.kinematic=!0;(this.disabled||x.disabled)&&l!==!1&&(C.disabled=!0);var G=this.nodes;if(G)for(var Y in G)if(G.hasOwnProperty(Y)&&!C.findChild(Y)){var Z=S.call(G[Y],Y,N,C,this.skin||T);Z&&(!a||!E(C,Z))&&C.addChild(Z)}return f&&C.renderables&&1<C.renderables.length&&m._optimizeRenderables(C,n),C},x=t.nodes,T=e.parentNode,N={};for(var C in x)if(x.hasOwnProperty(C)){var k=x[C],L=C,A=b?b+"/"+C:C,O=m.findNode(A),M=S.call(k,L,b,O||T||N,k.skin||e.materialSkin);if(M){T&&!O&&T.addChild(M),y?M.local?M.setLocalTransform(h.m43Mul(M.getLocalTransform(),y)):M.setLocalTransform(y):M.local||M.setLocalTransform(h.m43BuildIdentity()),l&&M.enableHierarchy(!1);if(O){var _=O.local;_&&M.local&&(M.local=h.m43Mul(M.local,_),O.setLocalTransform(M.local),delete M.local);var D=O.children;if(D&&M.children)while(M.children.length){var P=M.children[0];O.findChild(P.name)||O.addChild(P),M.removeChild(P)}for(var H in M)M.hasOwnProperty(H)&&(O[H]=M[H]);M=null}else T||this.addRootNode(M)}}},e.prototype.loadAreas=function(e){var t=e.data,n=t.areas;if(!n)return;var r=n.length;if(r<=0)return;e.append||delete this.areas;var i=this.areas;i||(i=[],this.areas=i);var s=e.nodesNamePrefix,o=this.md,u=this.planeNormalize,a=i.length,f=Number.MAX_VALUE,l,c;for(var h=0;h<r;h+=1){var p=n[h],d=p.target;s&&(d=s+"/"+d);var v=this.findNode(d);if(!v){a-=1;continue}var m=v.getWorldTransform(),g=m[0],y=m[1],b=m[2],w=m[3],E=m[4],S=m[5],x=m[6],T=m[7],N=m[8],C=m[9],k=m[10],L=m[11],A=f,O=f,M=f,_=-f,D=-f,P=-f,H=p.portals,B=H.length,j=[],F,I,q,R,U,z,W;this.float32ArrayConstructor?(l=new this.float32ArrayConstructor(6+B*13),c=0,W=l.subarray(c,c+6),c+=6):W=new Array(6);for(var X=0;X<B;X+=1){var V=f,$=f,J=f,K=-f,Q=-f,G=-f,Y=0,Z=0,et=0;F=H[X],I=F.points,R=I.length,q=[];for(U=0;U<R;U+=1){z=I[U];var tt=z[0],nt=z[1],rt=z[2],it=g*tt+w*nt+x*rt+C,st=y*tt+E*nt+T*rt+k,ot=b*tt+S*nt+N*rt+L;it<V&&(V=it),st<$&&($=st),ot<J&&(J=ot),it>K&&(K=it),st>Q&&(Q=st),ot>G&&(G=ot),Y+=it,Z+=st,et+=ot,q.push(o.v3Build(it,st,ot))}V<A&&(A=V),$<O&&(O=$),J<M&&(M=J),K>_&&(_=K),Q>D&&(D=Q),G>P&&(P=G);var ut=o.v3Cross(o.v3Sub(q[1],q[0]),o.v3Sub(q[2],q[0])),at,ft,lt;this.float32ArrayConstructor?(at=l.subarray(c,c+6),c+=6,ft=l.subarray(c,c+3),c+=3,lt=l.subarray(c,c+4),c+=4):(at=new Array(6),ft=new Array(3),lt=new Array(4)),at[0]=V,at[1]=$,at[2]=J,at[3]=K,at[4]=Q,at[5]=G,ft[0]=Y/R,ft[1]=Z/R,ft[2]=et/R,lt=u(ut[0],ut[1],ut[2],o.v3Dot(ut,q[0]),lt);var ct={area:a+F.area,points:q,origin:ft,extents:at,plane:lt};j.push(ct)}W[0]=A,W[1]=O,W[2]=M,W[3]=_,W[4]=D,W[5]=P;var ht={target:v,portals:j,extents:W,externalNodes:null};i.push(ht)}var pt=t.bspnodes,dt=pt.length,vt=[];vt.length=dt,this.bspNodes=vt,this.float32ArrayConstructor&&(l=new this.float32ArrayConstructor(4*dt),c=0);for(var mt=0;mt<dt;mt+=1){var gt=pt[mt],yt=gt.plane,bt;this.float32ArrayConstructor?(bt=l.subarray(c,c+4),c+=4):bt=new Array(4),bt[0]=yt[0],bt[1]=yt[1],bt[2]=yt[2],bt[3]=-yt[3],vt[mt]={plane:bt,pos:gt.pos,neg:gt.neg}}},e.prototype.load=function(e){var t=this;e.append||(this.clearShapes(),this.semantics={});var n=function(){e.keepLights&&t.loadLights(e),t.loadNodes(e),e.physicsManager&&e.physicsManager.loadNodes(e,t),t.loadAreas(e),t.endLoading(e.onload)};e.graphicsDevice&&this.loadMaterials(e),t.loadSkeletons(e);var r=e.yieldFn;if(r){var i=function(){t.streamShapes(e,n)};r(i)}else n()},e.prototype.planeNormalize=function(t,n,r,i,s){var o=s;if(!o){var u=e.prototype.float32ArrayConstructor;o=u?new u(4):new Array(4)}var a=t*t+n*n+r*r;if(a>0){var f=1/Math.sqrt(a);o[0]=t*f,o[1]=n*f,o[2]=r*f,o[3]=i*f}else o[0]=0,o[1]=0,o[2]=0,o[3]=0;return o},e.prototype.isInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c<0?n:s)+h*(h<0?r:o)+p*(p<0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.isFullyInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c>0?n:s)+h*(h>0?r:o)+p*(p>0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.extractFrustumPlanes=function(e){var t=this.planeNormalize,n=e.viewProjectionMatrix,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=n[12],m=n[13],g=n[14],y=n[15],b=this.frustumPlanes;return b[0]=t(o+r,l+u,d+c,-(y+v),b[0]),b[1]=t(o-r,l-u,d-c,-(y-v),b[1]),b[2]=t(o-i,l-a,d-h,-(y-m),b[2]),b[3]=t(o+i,l+a,d+h,-(y+m),b[3]),this.areas?b.length>4&&(b.length=4):b[4]=t(o-s,l-f,d-p,-(y-g),b[4]),this.nearPlane=t(o+s,l+f,d+p,-(y+g),this.nearPlane),b},e.prototype.calculateHullScreenExtents=function(e,t){var n=function(t,n,r,i,s){var o=t[r],u=n[r],a=t[3],f=n[3],l=0,c=!0;if(i)if(o>a){if(!(u<=f))return;u<f&&(l=(a-o)/(u-o-(f-a)))}else u>f&&(o<a&&(l=(a-o)/(u-o-(f-a))),c=!1);else if(o<-a){if(!(u>=-f))return;u>-f&&(l=(-a-o)/(u-o+(f-a)))}else u<-f&&(o>-a&&(l=(-a-o)/(u-o+(f-a))),c=!1);if(l>0){var h=t[0],p=t[1],d=t[2],v=n[0],m=n[1],g=n[2];s.push([h+l*(v-h),p+l*(m-p),d+l*(g-d),a+l*(f-a)])}c&&s.push(n)},r=1,i=-1,s=1,o=-1,u=e.length;for(var a=0;a<u;a+=1){var f=e[a],l,c,h,p,d;for(var v=0;v<2;v+=1)for(var m=0;m<3;m+=1){l=f.length;if(!l)break;d=[];for(c=0;c<l;c+=1)c<1?h=f[l-1]:h=f[c-1],p=f[c],n(h,p,m,v,d);f=d}l=f.length;for(c=0;c<l;c+=1){h=f[c];var g=h[0],y=h[1],b=h[3];if(b===0)g=g>=0?1:-1,y=y>=0?1:-1;else{var w=1/b;g*=w,y*=w}r>g&&(r=g),i<g&&(i=g),s>y&&(s=y),o<y&&(o=y)}}return r>=i||s>=o?undefined:(r<-1&&(r=-1),i>1&&(i=1),s<-1&&(s=-1),o>1&&(o=1),t||(t=this.float32ArrayConstructor?new this.float32ArrayConstructor(4):new Array(4)),t[0]=r,t[1]=s,t[2]=i,t[3]=o,t)},e.prototype.calculateLightsScreenExtents=function(e){var t=this.visibleLights,n=t.length;if(n>0){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=e.viewProjectionMatrix,T=this.calculateHullScreenExtents,N=this.md,C=N.m44Transform,k=N.m43MulM44,L=N.v4Build,A=L.call(N,-1,-1,1,1),O=L.call(N,1,-1,1,1),M=L.call(N,-1,1,1,1),_=L.call(N,1,1,1,1),D=0;do{w=t[D],E=w.light;if(E){if(E.global)continue;r=w.node.world,E.spot?(i=N.m33MulM43(E.frustum,r,i),S=k.call(N,i,x,S),l=C.call(N,S,A,l),c=C.call(N,S,O,c),h=C.call(N,S,M,h),p=C.call(N,S,_,p),y=L.call(N,r[9],r[10],r[11],1,y),y=C.call(N,x,y,y),b=[[y,l,c],[y,c,p],[y,h,l],[y,p,h],[h,p,c,l]]):(s=E.halfExtents,E.fog||(o=E.center,o&&(r=i=N.m43Offset(r,o,i))),u=s[0],a=s[1],f=s[2],S=k.call(N,r,x,S),l=C.call(N,S,L.call(N,-u,-a,-f,1,l),l),c=C.call(N,S,L.call(N,+u,-a,-f,1,c),c),h=C.call(N,S,L.call(N,+u,-a,+f,1,h),h),p=C.call(N,S,L.call(N,-u,-a,+f,1,p),p),d=C.call(N,S,L.call(N,-u,+a,-f,1,d),d),v=C.call(N,S,L.call(N,+u,+a,-f,1,v),v),m=C.call(N,S,L.call(N,+u,+a,+f,1,m),m),g=C.call(N,S,L.call(N,-u,+a,+f,1,g),g),b=[[p,h,c,l],[d,v,m,g],[l,c,v,d],[g,m,h,p],[d,g,p,l],[c,h,m,v]]),w.screenExtents=T(b,w.screenExtents)}D+=1}while(D<n)}},e.prototype.destroy=function(){this.clear(),this.vertexBufferManager&&(this.vertexBufferManager.destroy(),delete this.vertexBufferManager),this.indexBufferManager&&(this.indexBufferManager.destroy(),delete this.indexBufferManager)},e.prototype.getQueryCounter=function(){var e=this.queryCounter;return this.queryCounter=e+1,e},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}();(function(){var e,t;typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(Lt.prototype.uint16ArrayConstructor=Uint16Array)),typeof Uint32Array!="undefined"&&(e=new Uint32Array(4),t=Object.prototype.toString.call(e),t==="[object Uint32Array]"&&(Lt.prototype.uint32ArrayConstructor=Uint32Array)),typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(Lt.prototype.float32ArrayConstructor=Float32Array))})();var At=function(){function e(){}return e.create=function(t){var n=new e;return n.name=t,n.geometryType={},n.numMaterials=0,n.materialsMap={},n},e.prototype.hashMaterial=function(e){var t=e.texturesNames,n=[],r=0;for(var i in t)t.hasOwnProperty(i)&&(n[r]=t[i],r+=1);if(1<r)return n.sort(),n.join(",");if(0<r)return n[0];var s=e.techniqueParameters.materialColor;if(s){var o=s.length,u;for(u=0;u<o;u+=1)n[u]=s[u].toFixed(3).replace(".000","");return n.join(",")}return e.name},e.prototype.prepareMaterial=function(e){var t=this.hashMaterial(e),n=this.materialsMap[t];n===undefined&&(n=this.numMaterials,this.numMaterials+=1,this.materialsMap[t]=n),e.meta.materialIndex=n,e.effect=this},e.prototype.add=function(e,t){this.geometryType[e]=t},e.prototype.remove=function(e){delete this.geometryType[e]},e.prototype.get=function(e){return this.geometryType[e]},e.prototype.prepare=function(e){var t=this.geometryType[e.geometryType];t&&t.prepare(e)},e.version=1,e}(),Ot=function(){function e(){}return e.create=function(){var t=new e;return t.effects={},t},e.prototype.add=function(e){this.effects[e.name]=e},e.prototype.remove=function(e){delete this.effects[e]},e.prototype.map=function(e,t){this.effects[e]=this.effects[t]},e.prototype.get=function(e){var t=this.effects[e];return t?t:this.effects["default"]},e.version=1,e}(),Mt=function(){function e(){}return e.prototype.get=function(e){return null},e.create=function(t,n,r,i,s){function y(e){var t=e.parameters,n=e.techniques,r=e.programs,i,s,o,u,a,f,l,c,h,p,d,v,m,y,b;for(i in t)if(t.hasOwnProperty(i)){s=g[i];if(s!==undefined){t[i].rows=s,o={};for(u in n)if(n.hasOwnProperty(u)){a=n[u],f=a.length;for(l=0;l<f;l+=1){c=a[l];if(c.parameters.indexOf(i)!==-1){h=c.programs,p=h.length;for(d=0;d<p;d+=1)o[h[d]]=!0}}}v=new RegExp("uniform\\s+(\\w+)\\s+"+i+"\\s*\\[[^\\]]+\\]","mg"),m="uniform $1 "+i+"["+s+"]";for(y in o)o.hasOwnProperty(y)&&(b=r[y],b.code=b.code.replace(v,m))}}}i||(i=function(){});var o="default",u;if(r)u=r;else{var a={version:1,name:"default.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},diffuse:{type:"sampler2D"}},techniques:{textured3D:[{parameters:["worldViewProjection","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!0,CullFaceEnable:!0,CullFace:1029,BlendEnable:!1},programs:["vp","fp"]}]},programs:{fp:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];vec4 _ret_0;uniform sampler2D diffuse;void main()\n{_ret_0=texture2D(diffuse,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OUTpos1;vec2 _OUTuv1;uniform vec4 worldViewProjection[4];void main()\n{_OUTpos1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[1]+ATTR0.zzzz*worldViewProjection[2]+worldViewProjection[3];_OUTuv1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OUTpos1;}"}}};u=t.createShader(a),u||i("Default shader not created.")}var f={},c={},h={},p=0,d=null,v="",m=!1,g={};f[o]=u;var b=function(r,o){r===undefined&&i("Invalid texture path passed to ShaderManager.Load");var a=f[r];if(!a){if(!c[r]){c[r]=!0,p+=1;var g=l.create();h[r]=g,o&&g.subscribe(o);var b=function(n){if(n){var i=JSON.parse(n);m&&y(i);var o=t.createShader(i);o?f[r]=o:delete f[r],g.notify(o),delete h[r]}else s&&(s.innerHTML+="ShaderManager.load:&nbsp;'"+r+"' failed to load<br>"),delete f[r];delete c[r],p-=1};n.request({src:d&&d[r]||v+r,onload:b})}else o&&h[r].subscribe(o);return u}return o&&TurbulenzEngine.setTimeout(function(){o(a)},0),a},w=function(t,n){f[t]=f[n]},E=function(t){var n=f[t];return n?n:u},S=function(t){typeof f[t]!="undefined"&&delete f[t]},x=function(t,n){S(t),b(t,n)},T=new e;return s?(T.load=function(t,n){return s.innerHTML+="ShaderManager.load:&nbsp;'"+t+"'<br>",b(t,n)},T.map=function(t,n){s.innerHTML+="ShaderManager.map:&nbsp;'"+n+"' -> '"+t+"'<br>",w(t,n)},T.get=function(t){return s.innerHTML+="ShaderManager.get:&nbsp;'"+t+"'<br>",E(t)},T.remove=function(t){s.innerHTML+="ShaderManager.remove:&nbsp;'"+t+"'<br>",S(t)},T.reload=function(t,n){s.innerHTML+="ShaderManager. reload:&nbsp;'"+t+"'<br>",x(t,n)}):(T.load=b,T.map=w,T.get=E,T.remove=S,T.reload=x),T.reloadAll=function(){for(var t in f)f.hasOwnProperty(t)&&t!==o&&x(t)},T.getAll=function(){return f},T.getNumPendingShaders=function(){return p},T.isShaderLoaded=function(t){return!c[t]},T.isShaderMissing=function(t){return!f[t]},T.setPathRemapping=function(t,n){d=t,v=n},T.setAutomaticParameterResize=function(t,n){m=!0,g[t]=n},T.destroy=function(){if(f){var r;for(r in f)if(f.hasOwnProperty(r)){var i=f[r];i&&i.destroy()}f=null}u=null,c=null,h=null,p=0,d=null,v=null,n=null,t=null},T},e.version=1,e}(),_t=function(){function e(){}return e.prototype.setTexture=function(e){this.texture=e,this.textureChangedObserver&&this.textureChangedObserver.notify(this)},e.prototype.getTexture=function(){return this.texture},e.prototype.subscribeTextureChanged=function(e){this.textureChangedObserver||(this.textureChangedObserver=l.create()),this.textureChangedObserver.subscribe(e)},e.prototype.unsubscribeTextureChanged=function(e){this.textureChangedObserver.unsubscribe(e)},e.prototype.destroy=function(){this.texture.name!=="default"&&this.texture.destroy(),delete this.texture,delete this.textureChangedObserver},e.create=function(t,n){var r=new e;return r.name=t,r.texture=n,r.reference=s.create(r),r},e.version=1,e}(),Dt=function(){function e(){}return e.prototype.add=function(e,t,n){var r=this.textureInstances[e];r?r.setTexture(t):(this.textureInstances[e]=_t.create(e,t),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),n&&(this.internalTexture[e]=!0,this.textureInstances[e].reference.add())},e.prototype.get=function(e){var t=this.textureInstances[e];return t?t.getTexture():this.defaultTexture},e.prototype.getInstance=function(e){return this.textureInstances[e]},e.prototype.load=function(e,t,n){var r=this;e===undefined&&this.errorCallback("Invalid texture path passed to TextureManager.Load");var i=this.textureInstances[e];if(!i||i.texture===this.defaultTexture&&e!=="default"){i||this.add(e,this.defaultTexture,!1);if(e in this.loadingTexture)n&&this.loadedTextureObservers[e].subscribe(n);else{if(0!==this.numLoadingArchives)return this.delayedTextures[e]={nomipmaps:t,onload:n},this.get(e);this.loadingTexture[e]=!0,this.numLoadingTextures+=1;var s=!0;t&&(s=!1);var o=l.create();this.loadedTextureObservers[e]=o,n&&o.subscribe(n);var u=function(n,i){i===200&&n&&r.add(e,n,!1),o.notify(n),delete r.loadedTextureObservers[e],delete r.loadingTexture[e],r.numLoadingTextures-=1},a=function(t,n){var i=r.graphicsDevice.createTexture({src:t,mipmaps:s,onload:n});i||r.errorCallback("Texture '"+t+"' not created.")};this.requestHandler.request({src:this.pathRemapping&&this.pathRemapping[e]||this.pathPrefix+e,requestFn:a,onload:u})}return this.get(e)}var f=this.get(e);return n&&TurbulenzEngine.setTimeout(function(){n(f)},0),f},e.prototype.map=function(e,t){this.textureInstances[e]?this.textureInstances[e].setTexture(this.textureInstances[t].getTexture()):(this.textureInstances[e]=_t.create(e,this.textureInstances[t].getTexture()),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),this.internalTexture[e]=!0},e.prototype.remove=function(e){this.internalTexture[e]||e in this.textureInstances&&(this.textureInstances[e].reference.unsubscribeDestroyed(this.onTextureInstanceDestroyed),delete this.textureInstances[e])},e.prototype.loadArchive=function(e,t,n,r){var i=this,s=this.archivesLoaded[e];if(!s)if(e in this.loadingArchives)n&&this.loadedArchiveObservers[e].subscribe(function(){var s=i.archivesLoaded[e],o=s.textures,u;for(u in o)o.hasOwnProperty(u)&&n(o[u]);r&&r(s)});else{var o=!0;t&&(o=!1),this.loadingArchives[e]={textures:{}},this.numLoadingArchives+=1;var u=l.create();this.loadedArchiveObservers[e]=u,r&&u.subscribe(r);var a=function(n,r){var s;r===200&&n&&(s={textures:i.loadingArchives[e].textures},i.archivesLoaded[e]=s),u.notify(s),delete i.loadedArchiveObservers[e],delete i.loadingArchives[e],i.numLoadingArchives-=1;if(0===i.numLoadingArchives){var o;for(o in i.delayedTextures)if(i.delayedTextures.hasOwnProperty(o)){var a=i.delayedTextures[o];i.load(o,a.nomipmaps,a.onload)}i.delayedTextures={}}},f=function(r,s){var u=function(r){var s=r.name;if(!(s in i.textureInstances)||i.textureInstances[s].texture===i.defaultTexture)i.add(s,r,!1),i.loadingArchives[e].textures[s]=r;n&&n(r),delete i.delayedTextures[s],e in i.loadingTexture&&(delete i.loadingTexture[e],i.numLoadingTextures-=1)};i.graphicsDevice.loadTexturesArchive({src:r,mipmaps:o,ontextureload:u,onload:s})||i.errorCallback("Archive '"+e+"' not loaded.")};i.requestHandler.request({src:i.pathRemapping&&i.pathRemapping[e]||i.pathPrefix+e,requestFn:f,onload:a})}else if(n){var c=s.textures,h=0,p=function(t){return function(){n(t),h-=1,h===0&&r&&r(s)}},d;for(d in c)c.hasOwnProperty(d)&&(h+=1,TurbulenzEngine.setTimeout(p(c[d]),0))}},e.prototype.isArchiveLoaded=function(e){return e in this.archivesLoaded},e.prototype.removeArchive=function(e){if(e in this.archivesLoaded){var t=this.archivesLoaded[e].textures,n;for(n in t)t.hasOwnProperty(n)&&this.remove(n);delete this.archivesLoaded[e]}},e.prototype.getAll=function(){return this.textureInstances},e.prototype.getNumPendingTextures=function(){return this.numLoadingTextures+this.numLoadingArchives},e.prototype.isTextureLoaded=function(e){return!(e in this.loadingTexture)&&!(e in this.delayedTextures)},e.prototype.isTextureMissing=function(e){return!(e in this.textureInstances)},e.prototype.setPathRemapping=function(e,t){this.pathRemapping=e,this.pathPrefix=t},e.prototype.addProceduralTexture=function(e){var t=e.name,n=this.graphicsDevice.createTexture(e);n?this.add(t,n,!0):this.errorCallback("Failed to create '"+t+"' texture.")},e.prototype.destroy=function(){if(this.textureInstances){var e;for(e in this.textureInstances)if(this.textureInstances.hasOwnProperty(e)){var t=this.textureInstances[e];t&&t.destroy()}this.textureInstances=null}this.defaultTexture&&(this.defaultTexture.destroy(),this.defaultTexture=null),this.loadingTexture=null,this.loadedTextureObservers=null,this.delayedTextures=null,this.numLoadingTextures=0,this.archivesLoaded=null,this.loadingArchives=null,this.loadedArchiveObservers=null,this.numLoadingArchives=0,this.internalTexture=null,this.pathRemapping=null,this.pathPrefix=null,this.requestHandler=null,this.graphicsDevice=null},e.create=function(t,n,r,i,s){var o=new e;i||(i=function(){});var u="default",a;r?a=r:(a=t.createTexture({name:u,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),a||i("Default texture not created.")),o.textureInstances={},o.loadingTexture={},o.loadedTextureObservers={},o.delayedTextures={},o.numLoadingTextures=0,o.archivesLoaded={},o.loadingArchives={},o.loadedArchiveObservers={},o.numLoadingArchives=0,o.internalTexture={},o.pathRemapping=null,o.pathPrefix="",o.graphicsDevice=t,o.requestHandler=n,o.defaultTexture=a,o.errorCallback=i;var f=function(t){t.reference.unsubscribeDestroyed(f),delete o.textureInstances[t.name]};o.onTextureInstanceDestroyed=f,s&&(o.add=function(n,r){return s.innerHTML+="TextureManager.add:&nbsp;'"+n+"'",e.prototype.add.call(o,n,r)},o.load=function(n,r){return s.innerHTML+="TextureManager.load:&nbsp;'"+n+"'",e.prototype.load.call(o,n,r)},o.loadArchive=function(n,r){return s.innerHTML+="TextureManager.loadArchive:&nbsp;'"+n+"'",e.prototype.loadArchive.call(o,n,r)},o.isArchiveLoaded=function(n){return s.innerHTML+="TextureManager.isArchiveLoaded:&nbsp;'"+n+"'",e.prototype.isArchiveLoaded.call(o,n)},o.removeArchive=function(n){return s.innerHTML+="TextureManager.removeArchive:&nbsp;'"+n+"'",e.prototype.removeArchive.call(o,n)},o.map=function(n,r){s.innerHTML+="TextureManager.map:&nbsp;'"+r+"' -> '"+n+"'",e.prototype.map.call(o,n,r)},o.get=function(n){return s.innerHTML+="TextureManager.get:&nbsp;'"+n+"'",e.prototype.get.call(o,n)},o.getInstance=function(n){return s.innerHTML+="TextureManager.getInstance:&nbsp;'"+n+"'",e.prototype.getInstance.call(o,n)},o.remove=function(n){s.innerHTML+="TextureManager.remove:&nbsp;'"+n+"'",e.prototype.remove.call(o,n)}),o.add(u,a,!0),o.addProceduralTexture({name:"white",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]}),o.addProceduralTexture({name:"black",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]}),o.addProceduralTexture({name:"flat",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[128,128,255,255,128,128,255,255,128,128,255,255,128,128,255,255]});var l=Math.abs,c,h,p=[];for(h=0;h<4;h+=1)for(c=0;c<32;c+=1){var d=(c+.5)*(2/32)-1;d=l(d)-1/32;var v=1-d*2+d*d;v<=0?p.push(0):v>=1?p.push(255):p.push(v*255)}o.addProceduralTexture({name:"quadratic",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:p}),p=null;var m=[];for(h=0;h<4;h+=1){m.push(0);for(c=1;c<31;c+=1)m.push(255);m.push(0)}return o.addProceduralTexture({name:"nofalloff",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:m}),m=null,o},e.version=1,e}(),Pt=function(t){var n=Pt,r=n.techniquesIndexMap[t];return r===undefined&&(r=n.numTechniques,n.techniquesIndexMap[t]=r,n.numTechniques+=1),r};Pt.techniquesIndexMap={},Pt.numTechniques=0;var jt=function(t){var n=this.array;n[n.length]=t},Ft=function(){function e(){}return e.prototype.updateShader=function(){},e.prototype.sortRenderablesAndLights=function(t,n){var r=e.passIndex.opaque,i=e.passIndex.decal,s=e.passIndex.transparent,o=this.passes,u=o[r],a=o[i],f=o[s],l=0,c=0,h=0,p,d,v,m,g=n.getCurrentVisibleRenderables(),y=g.length;if(y>0){var b,w,E=0;do{b=g[E];if(!b.renderUpdate){var S=b.sharedMaterial.effect;S.prepare&&S.prepare(b)}b.renderUpdate(t),p=b.drawParameters,d=p.length;for(m=0;m<d;m+=1)v=p[m],w=v.userData.passIndex,w===r?(u[l]=v,l+=1):w===s?(b.sharedMaterial.meta.far?v.sortKey=1e38:v.sortKey=b.distance,f[h]=v,h+=1):w===i&&(a[c]=v,c+=1);E+=1}while(E<y)}u.length=l,a.length=c,f.length=h},e.prototype.update=function(e,t,n,r){n.updateVisibleNodes(t),this.sortRenderablesAndLights(t,n);var i=t.matrix;i[9]!==this.eyePosition[0]||i[10]!==this.eyePosition[1]||i[11]!==this.eyePosition[2]?(this.eyePositionUpdated=!0,this.eyePosition[0]=i[9],this.eyePosition[1]=i[10],this.eyePosition[2]=i[11]):this.eyePositionUpdated=!1,this.globalTechniqueParameters.time=r,this.camera=t,this.scene=n},e.prototype.updateBuffers=function(e,t,n){return!0},e.prototype.draw=function(t,n,r,i,s){t.clear(n,1,0);if(this.wireframe)this.scene.drawWireframe(t,this.sm,this.camera,this.wireframeInfo),r&&r(),i&&i();else{var o=this.globalTechniqueParametersArray,u=this.passes;t.drawArray(u[e.passIndex.opaque],o,-1),t.drawArray(u[e.passIndex.decal],o,-1),r&&r(),t.drawArray(u[e.passIndex.transparent],o,1),i&&i()}s&&s(),this.lightPositionUpdated=!1},e.prototype.setGlobalLightPosition=function(e){this.lightPositionUpdated=!0,this.lightPosition[0]=e[0],this.lightPosition[1]=e[1],this.lightPosition[2]=e[2]},e.prototype.setGlobalLightColor=function(e){this.globalTechniqueParameters.lightColor=e},e.prototype.setAmbientColor=function(e){this.globalTechniqueParameters.ambientColor=e},e.prototype.setDefaultTexture=function(e){this.globalTechniqueParameters.diffuse=e},e.prototype.setWireframe=function(e,t){this.wireframeInfo=t,this.wireframe=e},e.prototype.getDefaultSkinBufferSize=function(){return this.defaultSkinBufferSize},e.prototype.destroy=function(){delete this.globalTechniqueParametersArray,delete this.globalTechniqueParameters,delete this.lightPosition,delete this.eyePosition,delete this.passes},e.defaultPrepareFn=function(t){var n=TurbulenzEngine.getGraphicsDevice().createDrawParameters();n.userData={},t.drawParameters=[n],t.prepareDrawParameters(n);var r=t.sharedMaterial,i=t.techniqueParameters;!r.techniqueParameters.materialColor&&!i.materialColor&&(r.techniqueParameters.materialColor=e.v4One),!r.techniqueParameters.uvTransform&&!i.uvTransform&&(r.techniqueParameters.uvTransform=e.identityUVTransform),n.technique=this.technique,n.setTechniqueParameters(0,r.techniqueParameters),n.setTechniqueParameters(1,i),r.meta.decal?n.userData.passIndex=e.passIndex.decal:r.meta.transparent?n.userData.passIndex=e.passIndex.transparent:n.userData.passIndex=e.passIndex.opaque;var s=t.node;if(!s.rendererInfo){var o=TurbulenzEngine.getMathDevice();s.rendererInfo={id:e.nextRenderinfoID,frameVisible:-1,worldUpdate:-1,worldViewProjection:o.m44BuildIdentity(),worldInverse:o.m43BuildIdentity(),eyePosition:o.v3BuildZero(),lightPosition:o.v3BuildZero()},e.nextRenderinfoID+=1}var u=s.rendererInfo;i.worldViewProjection=u.worldViewProjection,i.lightPosition=u.lightPosition;var a=this.technique.name;a.indexOf("flat")===-1&&a.indexOf("lambert")===-1&&(i.eyePosition=u.eyePosition);var f=t.skinController;f?(i.skinBones=f.output,f.index===undefined&&(f.index=e.nextSkinID,e.nextSkinID+=1),n.sortKey=-Ht(this.techniqueIndex,f.index,r.meta.materialIndex)):n.sortKey=Ht(this.techniqueIndex,r.meta.materialIndex,u.id),t.renderUpdate=this.update},e.create=function(t,n,r,i){var s=new e;s.md=n,s.sm=r,s.lightPositionUpdated=!0,s.lightPosition=n.v3Build(1e3,1e3,0),s.eyePositionUpdated=!0,s.eyePosition=n.v3BuildZero(),s.globalTechniqueParameters=t.createTechniqueParameters({lightColor:n.v3BuildOne(),ambientColor:n.v3Build(.2,.2,.3),time:0}),s.globalTechniqueParametersArray=[s.globalTechniqueParameters],s.passes=[[],[],[]];var o=function(t){var n=t.getParameter("skinBones");s.defaultSkinBufferSize=n.rows*n.columns};r.load("shaders/defaultrendering.cgfx",o),r.load("shaders/debug.cgfx");var u=function(t,r,i){var o=s.lightPositionUpdated,u=s.eyePositionUpdated,a=t.world;r.worldUpdate!==t.worldUpdate&&(r.worldUpdate=t.worldUpdate,o=!0,u=!0,r.worldInverse=n.m43Inverse(a,r.worldInverse)),o&&(r.lightPosition=n.m43TransformPoint(r.worldInverse,s.lightPosition,r.lightPosition)),u&&(r.eyePosition=
n.m43TransformPoint(r.worldInverse,s.eyePosition,r.eyePosition)),r.worldViewProjection=n.m43MulM44(a,i.viewProjectionMatrix,r.worldViewProjection)},a=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,u(n,r,t))},f=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,u(n,r,t));var i=this.skinController;i&&i.update()},l=function(t){var r=this.node.world,i=this.techniqueParameters;i.worldViewProjection=n.m43MulM44(r,t.viewProjectionMatrix,i.worldViewProjection),i.worldInverseTranspose=n.m33InverseTranspose(r,i.worldInverseTranspose)},c=function(t){var r=this.node.world,i=this.techniqueParameters;i.worldViewProjection=n.m43MulM44(r,t.viewProjectionMatrix,i.worldViewProjection),i.worldInverseTranspose=n.m33InverseTranspose(r,i.worldInverseTranspose);var s=this.skinController;s&&s.update()},h=function(t){var r=this.node,i=r.rendererInfo;i.frameVisible!==r.frameVisible&&(i.frameVisible=r.frameVisible,u(r,i,t));if(i.worldUpdateEnv!==r.worldUpdate){i.worldUpdateEnv=r.worldUpdate;var s=r.world;i.worldInverseTranspose=n.m33InverseTranspose(s,i.worldInverseTranspose)}var o=this.techniqueParameters;o.worldInverseTranspose=i.worldInverseTranspose},p=function(t){h.call(this,t);var n=this.skinController;n&&n.update()},d=function(n){e.defaultPrepareFn.call(this,n);var r=n.techniqueParameters;r.constantColor=n.sharedMaterial.meta.constantColor},v=function(i){e.defaultPrepareFn.call(this,i);var s=i.sharedMaterial.techniqueParameters,o=s.diffuse;o===undefined?s.materialColor||(s.materialColor=n.v4BuildOne()):o.length===4&&(s.materialColor=n.v4Build.apply(n,o),o=s.diffuse_map,s.diffuse=o);if(!o){var u=r.get("shaders/defaultrendering.cgfx");i.geometryType==="skinned"?i.drawParameters[0].technique=u.getTechnique("flat_skinned"):i.drawParameters[0].technique=u.getTechnique("flat")}},m=function(r){e.defaultPrepareFn.call(this,r);var i=r.sharedMaterial.techniqueParameters,s=i.diffuse;s===undefined?i.materialColor||(i.materialColor=n.v4BuildOne()):s.length===4&&(i.materialColor=n.v4Build.apply(n,s),i.diffuse=undefined)},g=function(t){var n=this,r=function(t){n.shader=t,n.technique=t.getTechnique(n.techniqueName),n.techniqueIndex=n.technique.id};t.load(this.shaderName,r)};s.defaultPrepareFn=v,s.defaultUpdateFn=a,s.defaultSkinnedUpdateFn=f,s.loadTechniquesFn=g;var y,b,w="skinned",E="rigid";return y=At.create("constant"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("constant_nocull"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_nocull",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_skinned_nocull",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("lambert"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lambert",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lambert_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("blinn"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("blinn_nocull"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_nocull",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_skinned_nocull",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("phong"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"phong",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"phong_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("debug_lines_constant"),i.add(y),b={prepare:d,shaderName:"shaders/debug.cgfx",techniqueName:"debug_lines_constant",update:l,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("debug_normals"),i.add(y),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_normals",update:l,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_normals_skinned",update:c,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("debug_tangents"),i.add(y),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_tangents",update:l,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_tangents_skinned",update:c,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("debug_binormals"),i.add(y),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_binormals",update:l,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_binormals_skinned",update:c,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap_specularmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap_specularmap_alphamap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphamap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("normalmap_alphatest"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_alphatest",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_alphatest_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap_specularmap_alphatest"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap_glowmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_glowmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_glowmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("normalmap_specularmap_glowmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap_specularmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap_alphatest"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap_specularmap_alphatest"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap_glowmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("rxgb_normalmap_specularmap_glowmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("add"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("add_particle"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add_particle",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("blend"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("blend_particle"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend_particle",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("translucent"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("translucent_particle"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent_particle",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("filter"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"filter",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"filter_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("invfilter"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"invfilter",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("invfilter_particle"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"invfilter_particle",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("glass"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glass",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("glass_env"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glass_env",update:h,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("modulate2"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"modulate2",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"modulate2_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("skybox"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"skybox",update:h,loadTechniques:g},b.loadTechniques(r),y.add(E,b),y=At.create("env"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"env",update:h,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"env_skinned",update:p,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("flare"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),i.map("default","blinn"),y=At.create("glowmap"),i.add(y),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glowmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),b={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glowmap_skinned",update:f,loadTechniques:g},b.loadTechniques(r),y.add(w,b),y=At.create("lightmap"),i.add(y),b={prepare:v,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lightmap",update:a,loadTechniques:g},b.loadTechniques(r),y.add(E,b),s},e.version=1,e.numPasses=3,e.passIndex={opaque:0,decal:1,transparent:2},e.nextRenderinfoID=0,e.nextSkinID=0,e.v4One=new Float32Array([1,1,1,1]),e.identityUVTransform=new Float32Array([1,0,0,1,0,0]),e}(),It=function(){function e(){}return e.prototype.clear=function(){this.nodesMap={},this.referencesPending={},this.numReferencesPending=0,this.animationsPending={}},e.prototype.endLoading=function(e){this.referencesPending={},this.animationsPending={},e&&e(this.data)},e.prototype.resolveShapes=function(e){var t=function(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},n=e.shapesNamePrefix,r=e.shapesNamePrefix,i=e.data,s=i.geometries,o=this.data.geometries;o||(o={},this.data.geometries=o);for(var u in s)if(s.hasOwnProperty(u)){var a=s[u],f=n?n+"-"+u:u,l=a.skeleton;l?(o[f]=t(a),o[f].skeleton=r?r+"-"+l:l):o[f]=a}},e.prototype.resolveSkeletons=function(e){var t=e.shapesNamePrefix,n=e.data,r=n.skeletons,i=this.data.skeletons;i||(i={},this.data.skeletons=i);for(var s in r)if(r.hasOwnProperty(s)){var o=r[s],u=t?t+"-"+s:s;i[u]=o}},e.prototype.resolveAnimations=function(e){var t=e.data,n=t.animations;if(!n)return;var r=this,i=r.data.animations;i||(i={},r.data.animations=i);var s=function(n){if(n){var s=JSON.parse(n),o=s.animations;for(var u in o)o.hasOwnProperty(u)&&(i[u]=o[u])}r.numReferencesPending-=1,r.numReferencesPending<=0&&r.endLoading(e.onload)},o=e.request?e:TurbulenzEngine;for(var u in n)if(n.hasOwnProperty(u)){var a=n[u].reference;a?this.animationsPending[u]||(this.animationsPending[u]=!0,this.numReferencesPending+=1,delete n[u].reference,e.requestHandler.request({src:a,requestOwner:o,onload:s})):i[u]=n[u]}},e.prototype.resolveNodes=function(e){var n=e.data,r=this.referencesPending,i=0,s=this.nodesMap,o=this,u=e.nodesNamePrefix,a=e.shapesNamePrefix,f=e.request?e:TurbulenzEngine,l=function(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},c=function(n,u,h){var p=l(n),d=h?h+"/"+u:u,v=p.reference;if(v){var m=v.indexOf("#");if(m===-1){var g=r[v];if(!g||g.length===0||!p.inplace){i+=1;var y=l(e);y.append=!0,p.inplace?(y.nodesNamePrefix=h,y.shapesNamePrefix=null,y.parentNode=null):(y.nodesNamePrefix=d,y.shapesNamePrefix=v,y.parentNode=p),p.skin&&(y.skin=p.skin);if(!g||g.length===0){g=[y],r[v]=g;var b=function(e){var t=g.length,n;e?n=JSON.parse(e):n={};var r;for(var i=0;i<t;i+=1)r=g[i],r.data=n,r.isReference=!0,o.resolve(r);g.length=0};e.requestHandler.request({src:v,requestOwner:f,onload:b})}else g.push(y)}}delete p.reference,delete p.inplace}var w=p.geometryinstances;if(a&&w){p.geometryinstances={};for(var E in w)if(w.hasOwnProperty(E)){p.geometryinstances[E]=l(w[E]);var S=p.geometryinstances[E];S.geometry=a+"-"+S.geometry}}var x=n.nodes;if(x){p.nodes={};for(var T in x)if(x.hasOwnProperty(T)){var N=d+"/"+T;s[N]||(p.nodes[T]=c(x[T],T,d),s[N]=p.nodes[T])}}return p},h=n.nodes,p=e.parentNode;for(var d in h)if(h.hasOwnProperty(d)&&h[d]){var v=d,m=c(h[d],v,u),g=u?u+"/"+d:d,y=s[g];if(y){var b=y.matrix;b&&m.matrix&&(y.matrix=t.m43Mul(m.matrix,b),b=null);var w=y.nodes;if(w&&m.nodes)for(var E in m.nodes)m.nodes.hasOwnProperty(E)&&(w[E]=m.nodes[E]);else m.nodes&&(y.nodes=m.nodes);for(var S in m)m.hasOwnProperty(S)&&(y[S]=m[S]);m=y}else e.isReference&&p?(p.nodes||(p.nodes={}),p.nodes[d]=m):this.data.nodes[d]=m,s[g]=m}this.numReferencesPending+=i},e.prototype.resolvePhysicsNodes=function(e){function i(e){var t=function(){};return t.prototype=e,new t}var t=e.data,n=e.nodesNamePrefix,r=e.shapesNamePrefix,s=t.physicsmodels,o=this.data.physicsmodels;o||(o={},this.data.physicsmodels=o);for(var u in s)if(s.hasOwnProperty(u)){var a=s[u];if(r){var f=r?r+"-"+u:u,l=i(a);o[f]=l;var c=l.geometry;c&&(l.geometry=r?r+"-"+c:c)}else o[u]=a}var h=t.physicsnodes,p=this.data.physicsnodes;p||(p={},this.data.physicsnodes=p);for(var d in h)if(h.hasOwnProperty(d)){var v=h[d];if(n||r){var m=v.target;m=n?n+"/"+m:m;var g=i(v);g.target=m,g.body=r?r+"-"+v.body:v.body;var y=n?n+"/"+d:d;p[y]=g}else p[d]=v}},e.prototype.resolveAreas=function(e){var t=e.data,n=t.areas;if(!n)return;var r=n.length;if(r<=0)return;var i=this.data.areas;i||(i=[],this.data.areas=i);var s=e.nodesNamePrefix;for(var o=0;o<r;o+=1){var u=n[o];if(s){var a=u.target;u.target=s+"/"+a}i.push(u)}},e.prototype.resolve=function(e){e.append||(this.data={nodes:{}});var t=e.data;for(var n in t)if(n!=="nodes"&&n!=="skeletons"&&n!=="geometries"&&n!=="animations"&&n!=="areas"&&n!=="physicsnodes"&&n!=="physicsmodels"&&t.hasOwnProperty(n)){var r=t[n],i=this.data[n];if(!i)this.data[n]=r;else for(var s in r)r.hasOwnProperty(s)&&!i[s]&&(i[s]=r[s])}this.resolveShapes(e),this.resolveSkeletons(e),this.resolveAnimations(e),this.resolveNodes(e),this.resolvePhysicsNodes(e),this.resolveAreas(e),e.isReference&&(this.numReferencesPending-=1),this.numReferencesPending<=0&&this.endLoading(e.onload)},e.prototype.load=function(e,t){var n=this,r=function(r){var i={};r&&(i=JSON.parse(r)),t.data=i,t.append=!1,n.resolve(t)};t.requestHandler.request({src:e,requestOwner:t.request?t:TurbulenzEngine,onload:r})},e.create=function(){var t=new e;return t.clear(),t.skeletonNames={},t},e.version=1,e}(),qt=function(){function e(){}return e.prototype.loadFile=function(e,t){},e.prototype.loadData=function(e,t){},e.prototype.get=function(e){return null},e.prototype.remove=function(e){},e.prototype.nodeHasSkeleton=function(e){return null},e.prototype.getAll=function(){return null},e.prototype.setPathRemapping=function(e,t){},e.create=function(t,n){t||(t=function(e){});var r={},i=null,s="",o=function(t,n){var i=t.animations,s;for(s in i)if(i.hasOwnProperty(s)){var o=n?n+s:s;if(r[o]){i[s]=r[o];continue}var u=i[s],a=u.numNodes,f=u.nodeData,l;for(l=0;l<a;l+=1){var c=f[l],h=c.baseframe;h&&(h.rotation&&(h.rotation=this.mathDevice.quatBuild(h.rotation[0],h.rotation[1],h.rotation[2],h.rotation[3])),h.translation&&(h.translation=this.mathDevice.v3Build(h.translation[0],h.translation[1],h.translation[2])),h.scale&&(h.scale=this.mathDevice.v3Build(h.scale[0],h.scale[1],h.scale[2])));var p=c.keyframes;if(p&&p[0].hasOwnProperty("time")){var d=p.length,v,m,g={},y,b,w,E,S;c.channels=g;for(v=0;v<d;v+=1){m=p[v];for(b in m)m.hasOwnProperty(b)&&b!=="time"&&(y=g[b],y||(y={count:0,offset:0,stride:m[b].length+1},g[b]=y,y.firstKey=v),y.lastKey=v,y.count+=1)}var x=0;for(b in g)g.hasOwnProperty(b)&&(y=g[b],y.count=1+y.lastKey-y.firstKey,y.firstKey&&(y.count+=1),y.lastKey!==d-1&&(y.count+=1),y.offset=x,y.writeIndex=x,x+=y.stride*y.count);var T=null;x&&(T=new Float32Array(x));for(b in g)if(g.hasOwnProperty(b)){y=g[b];if(y.firstKey){T[y.writeIndex]=p[y.firstKey-1].time,w=h[b];for(S=0;S<y.stride-1;S+=1)T[y.writeIndex+1+S]=w[S];y.writeIndex+=y.stride}if(y.lastKey!==d-1){E=y.offset+(y.count-1)*y.stride,T[E]=p[y.lastKey+1].time,w=h[b];for(S=0;S<y.stride-1;S+=1)T[E+1+S]=w[S]}}for(v=0;v<d;v+=1){m=p[v];for(b in g)if(g.hasOwnProperty(b)){y=g[b];if(v>=y.firstKey&&v<=y.lastKey){m[b]?w=m[b]:w=h[b],T[y.writeIndex]=m.time;for(S=0;S<y.stride-1;S+=1)T[y.writeIndex+1+S]=w[S];y.writeIndex+=y.stride}}}for(b in g)g.hasOwnProperty(b)&&delete y.writeIndex;c.keyframes=T}else p&&(c.keyframes=new Float32Array(p))}var N=u.bounds,C=N.length,k;for(k=0;k<C;k+=1){var L=N[k];L.center=this.mathDevice.v3Build(L.center[0],L.center[1],L.center[2]),L.halfExtent=this.mathDevice.v3Build(L.halfExtent[0],L.halfExtent[1],L.halfExtent[2])}r[o]=u}},u=function(t,n){},a=function(t){var n=r[t];return n},f=function(t){typeof r[t]!="undefined"&&delete r[t]},l=function(t){var n=t.renderables;if(n){var r,i=n.length,s;for(s=0;s<i;s+=1)if(n[s].geometry){r=n[s].geometry.skeleton;if(r)return r}}var o=t.children;if(o){var u=o.length,a;for(a=0;a<u;a+=1){var f=l(o[a]);if(f)return f}}return undefined},c=new e;return c.mathDevice=TurbulenzEngine.getMathDevice(),n?(c.loadFile=function(t,r){return n.innerHTML+="AnimationManager.loadFile:&nbsp;'"+t+"'",u(t,r)},c.loadData=function(t,r){return n.innerHTML+="AnimationManager.loadData",o(t,r)},c.get=function(t){return n.innerHTML+="AnimationManager.get:&nbsp;'"+t+"'",a(t)},c.remove=function(t){n.innerHTML+="AnimationManager.remove:&nbsp;'"+t+"'",f(t)}):(c.loadFile=u,c.loadData=o,c.get=a,c.remove=f,c.nodeHasSkeleton=l),c.getAll=function(){return r},c.setPathRemapping=function(t,n){i=t,s=n},c},e.version=1,e}(),Rt={quatPosscalefromm43:function(t,n){var r=n.v3Length,i=n.v3ScalarMul,s=n.v3Build,o=n.m43Right(t),u=n.m43Up(t),a=n.m43At(t),f=r.call(n,o),l=r.call(n,u),c=r.call(n,a),h=n.m43Determinant(t),p=s.call(n,f,l,c),d=s.call(n,1,1,1);!n.v3Equal(p,d)||h<0?(h<0&&(f*=-1,p=s.call(n,f,l,c)),n.m43SetRight(t,i.call(n,o,1/f)),n.m43SetUp(t,i.call(n,u,1/l)),n.m43SetAt(t,i.call(n,a,1/c))):p=d;var v=n.quatFromM43(t),m=n.m43Pos(t),g={rotation:v,translation:m,scale:p};return g}},Ut={copy:function(t){var n={},r;for(r in t)t.hasOwnProperty(r)&&(n[r]=!0);return n},union:function(t,n){var r={},i;for(i in t)t.hasOwnProperty(i)&&(r[i]=!0);for(i in n)n.hasOwnProperty(i)&&(r[i]=!0);return r},add:function(t,n){var r;for(r in n)n.hasOwnProperty(r)&&(t[r]=!0)}},zt={minKeyframeDelta:1e-4,standardGetJointWorldTransform:function(t,n,r,i){var s=r.m43FromRT,o=r.quatCopy,u=r.v3Copy,a=t.output,f=t.outputChannels.scale,l=a[n],c=t.getHierarchy().parents,h=c[n],p;if(f){var d=r.m43Mul,v,m=r.m43FromRTS(l.rotation,l.translation,l.scale);while(h!==-1)p=a[h],v=r.m43FromRTS(p.rotation,p.translation,p.scale,v),m=d.call(r,m,v,m),h=c[h];if(i)return m;var g=Rt.quatPosscalefromm43(m,r);return{rotation:g.rotation,translation:g.translation}}var y=o.call(r,l.rotation),b=u.call(r,l.translation);while(h!==-1)p=a[h],r.quatMulTranslate(p.rotation,p.translation,y,b,y,b),h=c[h];return i?s.call(r,y,b):{rotation:y,translation:b}}},Wt=function(){function e(){}return e.prototype.addTime=function(e){this.currentTime+=e*this.rate,this.dirty=!0,this.dirtyBounds=!0;var t=this.currentAnim,n=t.length;while(this.currentTime>n){var r=this.hierarchy.numNodes,i;for(i=0;i<r;i+=1)this.translationEndFrames[i]=0,this.rotationEndFrames[i]=0,this.scaleEndFrames[i]=0;if(this.onUpdateCallback){var s=this.currentTime;this.currentTime=n,this.onUpdateCallback(this);if(this.currentTime===n)this.currentTime=s;else if(this.currentTime<n)return}if(!this.looping){if(this.onFinishedCallback&&!this.onFinishedCallback(this))return;this.currentTime=n;break}if(this.onLoopCallback&&!this.onLoopCallback(this))return;if(0===n){this.currentTime=0;break}this.currentTime-=n}this.onUpdateCallback&&this.onUpdateCallback(this)},e.prototype.update=function(){var t=this.mathDevice,n=this.currentAnim,r=n.nodeData,i=this.hierarchy.numNodes,s=this.output,o=n.channels.scale,u;o&&(u=t.v3Build(1,1,1));var a=e.prototype.scratchPad,f=a.v1,l=a.v2,c=a.q1,h=a.q2,p,d;for(d=0;d<i;d+=1){var v=r[d],m=v.channels,g=m?m.scale:o,y=g||o,b=v.keyframes,w=v.baseframe,E,S,x,T=s[d];w&&(E=w.rotation,S=w.translation,x=w.scale,g=g||x!==undefined);if(!b)T.rotation=t.quatCopy(E,T.rotation),T.translation=t.v3Copy(S,T.translation),y&&(g?T.scale=t.v3Copy(x,T.scale):T.scale=t.v3Copy(u,T.scale));else{var N=0,C=0,k=0,L=0,A=v.channels;if(A.rotation){C=A.rotation.stride,N=A.rotation.offset,L=N+(A.rotation.count-1)*C;if(this.currentTime<=b[N])T.rotation=t.quatBuild(b[N+1],b[N+2],b[N+3],b[N+4],T.rotation);else if(this.currentTime>=b[L])T.rotation=t.quatBuild(b[L+1],b[L+2],b[L+3],b[L+4],T.rotation);else{N=this.rotationEndFrames[d]||N;while(this.currentTime>b[N])N+=C;this.rotationEndFrames[d]=N,k=N-C,p=(this.currentTime-b[k])/(b[N]-b[k]),c[0]=b[k+1],c[1]=b[k+2],c[2]=b[k+3],c[3]=b[k+4],h[0]=b[N+1],h[1]=b[N+2],h[2]=b[N+3],h[3]=b[N+4],T.rotation=t.quatSlerp(c,h,p,T.rotation)}}else T.rotation=t.quatCopy(E,T.rotation);if(A.translation){C=A.translation.stride,N=A.translation.offset,L=N+(A.translation.count-1)*C;if(this.currentTime<=b[N])T.translation=t.v3Build(b[N+1],b[N+2],b[N+3],T.translation);else if(this.currentTime>=b[L])T.translation=t.v3Build(b[L+1],b[L+2],b[L+3],T.translation);else{N=this.translationEndFrames[d]||N;while(this.currentTime>b[N])N+=C;this.translationEndFrames[d]=N,k=N-C,p=(this.currentTime-b[k])/(b[N]-b[k]),f[0]=b[k+1],f[1]=b[k+2],f[2]=b[k+3],l[0]=b[N+1],l[1]=b[N+2],l[2]=b[N+3],T.translation=t.v3Lerp(f,l,p,T.translation)}}else T.translation=t.v3Copy(S,T.translation);if(A.scale){C=A.scale.stride,N=A.scale.offset,L=N+(A.scale.count-1)*C;if(this.currentTime<=b[N])T.scale=t.v3Build(b[N+1],b[N+2],b[N+3],T.scale);else if(this.currentTime>=b[L])T.scale=t.v3Build(b[L+1],b[L+2],b[L+3],T.scale);else{N=this.scaleEndFrames[d]||N;while(this.currentTime>b[N])N+=C;this.scaleEndFrames[d]=N,k=N-C,p=(this.currentTime-b[k])/(b[N]-b[k]),f[0]=b[k+1],f[1]=b[k+2],f[2]=b[k+3],l[0]=b[N+1],l[1]=b[N+2],l[2]=b[N+3],T.scale=t.v3Lerp(f,l,p,T.scale)}}else y&&(g?T.scale=t.v3Copy(x,T.scale):T.scale=t.v3Copy(u,T.scale))}}this.dirty=!1,this.dirtyBounds&&this.updateBounds()},e.prototype.updateBounds=function(){if(!this.dirtyBounds)return;this.dirtyBounds=!1;var e=this.currentTime,t=this.currentAnim,n=this.mathDevice,r=this.bounds,i=t.bounds,s=i.length;if(e>i[s-1].time){var o=i[s-1];r.center=n.v3Copy(o.center,r.center),r.halfExtent=n.v3Copy(o.halfExtent,r.halfExtent);return}if(e<i[0].time){var u=i[0];r.center=n.v3Copy(u.center,r.center),r.halfExtent=n.v3Copy(u.halfExtent,r.halfExtent);return}var a=1;while(e>i[a].time)a+=1;var f=a-1,l=i[f],c=i[a],h=l.time,p=c.time,d=(e-h)/(p-h),v=zt.minKeyframeDelta;if(d<v)r.center=n.v3Copy(l.center,r.center),r.halfExtent=n.v3Copy(l.halfExtent,r.halfExtent);else if(1-d<v)r.center=n.v3Copy(c.center,r.center),r.halfExtent=n.v3Copy(c.halfExtent,r.halfExtent);else{var m=n.v3Add(l.center,c.center,r.center),g=n.v3ScalarMul(m,.5,m);r.center=g;var y=n.v3Max(l.halfExtent,c.halfExtent,r.halfExtent),b=n.v3Sub(l.center,g,this.scratchPad.v1);b=n.v3Abs(b,b),r.halfExtent=n.v3Add(y,b,y)}},e.prototype._updateBoundsNoop=function(){this.dirtyBounds=!1},e.prototype.getJointTransform=function(e){var t=this.mathDevice,n=t.m43FromRTS,r=t.m43FromRT,i=t.quatSlerp,s=t.v3Lerp,o=this.currentAnim,u=o.channels.scale;if(this.dirty){var a=o.nodeData,f=a[e].keyframes,l=a[e].jointBase,c=a[e].channels,h=c?c.scale:u,p=h||u,d,v,m;l&&(d=l.rotation,v=l.translation,m=l.scale);if(!f)return p?n.call(t,d,v,m||t.v3Build(1,1,1)):r.call(t,d,v);var g=1;while(this.currentTime>f[g].time)g+=1;var y=g-1,b=f[y].time,w=f[g].time,E=(this.currentTime-b)/(w-b);if(E<zt.minKeyframeDelta){var S=f[y];return p?n.call(t,S.rotation||d,S.translation||v,S.scale||m||t.v3Build(1,1,1)):r.call(t,S.rotation||d,S.translation||v)}var x=f[y],T=f[g],N=x.rotation||d,C=T.rotation||d,k=i.call(t,N,C,E),L=x.translation||v,A=T.translation||v,O=s.call(t,L,A,E);if(p){var M;if(h){var _=x.scale||m,D=T.scale||m;M=s.call(t,_,D,E)}else M=t.v3Build(1,1,1);return n.call(t,k,O,M)}return r.call(t,k,O)}var P=this.output[e];return u?n.call(t,P.rotation,P.translation,P.scale):r.call(t,P.rotation,P.translation)},e.prototype.getJointWorldTransform=function(e,t){return this.dirty&&this.update(),zt.standardGetJointWorldTransform(this,e,this.mathDevice,t)},e.prototype.setAnimation=function(t,n){this.currentAnim=t,this.currentTime=0;var r,i=this.hierarchy.numNodes;if(!this.translationEndFrames||this.translationEndFrames.length!==i)this.translationEndFrames=new Uint32Array(i),this.rotationEndFrames=new Uint32Array(i),this.scaleEndFrames=new Uint32Array(i);else for(r=0;r<i;r+=1)this.translationEndFrames[r]=0,this.rotationEndFrames[r]=0,this.scaleEndFrames[r]=0;this.dirty=!0,this.dirtyBounds=!0,n?this.looping=!0:this.looping=!1,this.outputChannels=Ut.copy(t.channels);var s=t.bounds,o=s.length,u=s[0].center,a=s[0].halfExtent,f;for(f=1;f<o;f+=1){var l=s[f],c=l.center,h=l.halfExtent;if(u[0]!==c[0]||u[1]!==c[1]||u[2]!==c[2]||a[0]!==h[0]||a[1]!==h[1]||a[2]!==h[2])break}if(f<o)this.updateBounds=e.prototype.updateBounds;else{this.updateBounds=e.prototype._updateBoundsNoop;var p=this.bounds,d=this.mathDevice;p.center=d.v3Copy(u,p.center),p.halfExtent=d.v3Copy(a,p.halfExtent)}},e.prototype.setTime=function(e){this.currentTime=e,this.dirty=!0,this.dirtyBounds=!0;var t=this.hierarchy.numNodes,n;for(n=0;n<t;n+=1)this.translationEndFrames[n]=0,this.rotationEndFrames[n]=0,this.scaleEndFrames[n]=0},e.prototype.setRate=function(e){this.rate=e},e.prototype.getHierarchy=function(){return this.hierarchy},e.create=function(t){var n=new e;n.hierarchy=t;var r=TurbulenzEngine.getMathDevice();n.mathDevice=r,n.bounds={center:r.v3BuildZero(),halfExtent:r.v3BuildZero()};var i=[];n.output=i,n.outputChannels={};var s=t.numNodes;for(var o=0;o<s;o+=1)i[o]={};return n.rate=1,n.currentTime=0,n.looping=!1,n.dirty=!0,n.dirtyBounds=!0,e.prototype.scratchPad||(e.prototype.scratchPad={v1:r.v3BuildZero(),v2:r.v3BuildZero(),q1:r.quatBuild(0,0,0,1),q2:r.quatBuild(0,0,0,1)}),n},e.version=1,e}();Wt.prototype.scratchV3=null;var Xt=function(){function e(){}return e.prototype.addTime=function(e){this.dirty=!0,this.dirtyBounds=!0,this.baseController.addTime(e)},e.prototype.update=function(){this.baseController.update();var e=this.nodeOverloads,t=e.length,n=this.output;for(var r=0;r<t;r+=1){var i=e[r],s=i.sourceController;s.dirty&&s.update(),n[i.overloadIndex]=s.getJointWorldTransform(i.sourceIndex),this.outputChannels.scale&&!s.outputChannels.scale&&(n[i.overloadIndex].scale=this.mathDevice.v3Build(1,1,1))}this.dirty=!1,this.dirtyBounds&&(this.baseController.updateBounds(),this.dirtyBounds=!1)},e.prototype.updateBounds=function(){this.dirtyBounds&&(this.baseController.updateBounds(),this.dirtyBounds=!1)},e.prototype.getJointTransform=function(e){return this.baseController.getJointTransform(e)},e.prototype.getJointWorldTransform=function(e,t){return this.baseController.getJointWorldTransform(e,t)},e.prototype.getHierarchy=function(){return this.baseController.getHierarchy()},e.prototype.addOverload=function(e,t,n){Ut.add(this.outputChannels,e.outputChannels),this.nodeOverloads.push({sourceController:e,sourceIndex:t,overloadIndex:n})},e.create=function(t){var n=new e;return n.baseController=t,n.bounds=t.bounds,n.output=t.output,n.outputChannels={},n.nodeOverloads=[],n.dirty=!0,n.dirtyBounds=!0,n.mathDevice=TurbulenzEngine.getMathDevice(),n},e.version=1,e}(),Vt=function(){function e(){}return e.create=function(t){var n=new e;n.__proto__=t;var r=function(t){var n=this.referenceSource;delete this.referenceSource,delete this.setReferenceController;for(var i in this)this.hasOwnProperty(i)&&(n[i]=this[i],delete this[i]);this.__proto__=t,this.referenceSource=t,this.setReferenceController=r};return n.referenceSource=t,n.setReferenceController=r,n},e}(),$t=function(){function e(){}return e.prototype.addTime=function(e){this.dirty=!0,this.transitionTime+=e;while(this.transitionTime>this.transitionLength){if(this.onFinishedTransitionCallback&&!this.onFinishedTransitionCallback
(this))return;this.transitionTime=this.transitionLength}this.onUpdateCallback&&this.onUpdateCallback(this)},e.prototype.update=function(){var e=this.mathDevice,t=e.quatSlerp,n=e.v3Lerp,r=e.v3Copy;this.startController.update(),this.endController.update();var i=this.output,s=this.outputChannels,o=s.scale,u=this.startController.outputChannels.scale,a=this.endController.outputChannels.scale,f=this.startController.output,l=this.endController.output,c=this.transitionTime/this.transitionLength,h=this.startController.getHierarchy().numNodes;for(var p=0;p<h;p+=1){var d=i[p];d||(i[p]=d={});var v=f[p],m=l[p];d.rotation=t.call(e,v.rotation,m.rotation,c,d.rotation),d.translation=n.call(e,v.translation,m.translation,c,d.translation),o&&(u?a?d.scale=n.call(e,v.scale,m.scale,c,d.scale):d.scale=r.call(e,v.scale,d.scale):a&&(d.scale=r.call(e,m.scale,d.scale)))}this.dirty=!1,this.dirtyBounds&&this.updateBounds()},e.prototype.updateBounds=function(){var e=this.startController,t=this.endController;e.dirtyBounds&&e.updateBounds(),t.dirtyBounds&&t.updateBounds();var n=e.bounds,r=t.bounds,i=this.mathDevice,s=i.v3Add,o=s.call(i,n.center,r.center),u=i.v3ScalarMul(o,.5,o);this.bounds.center=u;var a=i.v3Max(n.halfExtent,r.halfExtent),f=Math.max,l=f(a[0],f(a[1],a[2]));a=i.v3Build(l,l,l);var c=i.v3Sub(n.center,u);c=i.v3Abs(c,c),this.bounds.halfExtent=s.call(i,a,c,a),this.dirtyBounds=!1},e.prototype.getJointTransform=function(e){this.dirty&&this.update();var t=this.output,n=t[e];return n},e.prototype.getJointWorldTransform=function(e,t){return this.dirty&&this.update(),zt.standardGetJointWorldTransform(this,e,this.mathDevice,t)},e.prototype.setStartController=function(e){this.startController=e,this.outputChannels=Ut.union(this.startController.outputChannels,this.endController.outputChannels),this.dirty=!0,this.dirtyBounds=!0},e.prototype.setEndController=function(e){this.endController=e,this.outputChannels=Ut.union(this.startController.outputChannels,this.endController.outputChannels),this.dirty=!0,this.dirtyBounds=!0},e.prototype.setTransitionLength=function(e){this.transitionLength=e,this.dirty=!0,this.dirtyBounds=!0},e.prototype.setTime=function(e){this.transitionTime=e,this.dirty=!0,this.dirtyBounds=!0},e.prototype.setRate=function(e){this.rate=e},e.prototype.getHierarchy=function(){return this.startController.getHierarchy()},e.create=function(t,n,r){var i=new e,s=TurbulenzEngine.getMathDevice();return i.mathDevice=s,i.bounds={center:s.v3BuildZero(),halfExtent:s.v3BuildZero()},i.startController=t,i.endController=n,i.outputChannels=Ut.union(t.outputChannels,n.outputChannels),i.output=[],i.transitionTime=0,i.transitionLength=r,i.dirty=!0,i.dirtyBounds=!0,i},e.version=1,e}(),Jt=function(){function e(){}return e.prototype.addTime=function(e){this.dirty=!0,this.dirtyBounds=!0;var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1){var i=t[r];i.addTime(e)}},e.prototype.update=function(){var e=this.mathDevice,t=e.quatSlerp,n=e.v3Lerp,r=e.v3Copy,i=this.controllers,s=i.length,o=1/(s-1),u=Math.floor(this.blendDelta/o),a=Math.min(u+1,s-1),f=(this.blendDelta-u*o)/o,l=i[u],c=i[a];l.update(),c.update();var h=this.output,p=this.outputChannels,d=p.scale,v=l.outputChannels.scale,m=c.outputChannels.scale,g=l.output,y=c.output,b=l.getHierarchy().numNodes;for(var w=0;w<b;w+=1){var E=h[w];E||(h[w]=E={});var S=g[w],x=y[w];E.rotation=t.call(e,S.rotation,x.rotation,f,E.rotation),E.translation=n.call(e,S.translation,x.translation,f,E.translation),d&&(v?m?E.scale=n.call(e,S.scale,x.scale,f,E.scale):E.scale=r.call(e,S.scale,E.scale):m&&(E.scale=r.call(e,x.scale,E.scale)))}this.dirty=!1,this.dirtyBounds&&this.updateBounds()},e.prototype.updateBounds=function(){var e=this.controllers,t=e.length,n=1/(t-1),r=Math.floor(this.blendDelta/n),i=Math.min(r+1,t-1),s=e[r],o=e[i];s.dirtyBounds&&s.updateBounds(),o.dirtyBounds&&o.updateBounds();var u=s.bounds,a=o.bounds,f=this.mathDevice,l=f.v3Add,c=l.call(f,u.center,a.center),h=f.v3ScalarMul(c,.5,c);this.bounds.center=h;var p=f.v3Max(u.halfExtent,a.halfExtent),d=f.v3Sub(u.center,h);d=f.v3Abs(d,d),this.bounds.halfExtent=l.call(f,p,d,p),this.dirtyBounds=!1},e.prototype.getJointTransform=function(e){return this.dirty&&this.update(),this.output[e]},e.prototype.getJointWorldTransform=function(e,t){return this.dirty&&this.update(),zt.standardGetJointWorldTransform(this,e,this.mathDevice,t)},e.prototype.setBlendDelta=function(e){this.blendDelta=0<e?e:0,this.dirty=!0,this.dirtyBounds=!0},e.prototype.setTime=function(e){var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1){var i=t[r];i.setTime(e)}this.dirty=!0,this.dirtyBounds=!0},e.prototype.setRate=function(e){var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1)t[r].setRate(e)},e.prototype.getHierarchy=function(){return this.controllers[0].getHierarchy()},e.create=function(t){var n=new e;n.outputChannels={},n.controllers=[];var r=t.length;n.controllers.length=r;for(var i=0;i<r;i+=1){var s=t[i];n.controllers[i]=s,Ut.add(n.outputChannels,s.outputChannels)}var o=TurbulenzEngine.getMathDevice();return n.mathDevice=o,n.bounds={center:o.v3BuildZero(),halfExtent:o.v3BuildZero()},n.output=[],n.blendDelta=0,n.dirty=!0,n.dirtyBounds=!0,n},e.version=1,e}(),Kt=function(){function e(){}return e.prototype.addTime=function(e){this.dirty=!0,this.dirtyBounds=!0;var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1){var i=t[r];i.addTime(e)}},e.prototype.update=function(){var e=this.output,t=this.outputChannels,n=t.scale,r=this.mathDevice,i=this.controllers,s=i.length,o=this.masks;for(var u=0;u<s;u+=1){var a=i[u];a.update();var f=a.output,l=a.outputChannels.scale,c=n&&!l,h=o[u],p=a.getHierarchy().numNodes;for(var d=0;d<p;d+=1){var v=e[d];v||(e[d]=v={}),h[d]&&(v.rotation=r.quatCopy(f[d].rotation,v.rotation),v.translation=r.v3Copy(f[d].translation,v.translation),c?v.scale=r.v3BuildOne(v.scale):n&&(v.scale=r.v3Copy(f[d].scale,v.scale)))}}this.dirty=!1,this.dirtyBounds&&this.updateBounds()},e.prototype.updateBounds=function(){var e=this.controllers,t=e.length;if(t){for(var n=0;n<t;n+=1)e[n].updateBounds();var r=e[0].bounds,i={center:r.center,halfExtent:r.halfExtent},s=this.mathDevice,o=s.v3Add,u=s.v3ScalarMul,a=s.v3Max,f=s.v3Sub,l=s.v3Abs;for(n=1;n<t;n+=1){var c=e[n],h=c.bounds,p=o.call(s,i.center,h.center),d=u.call(s,p,.5,p);i.center=d;var v=a.call(s,i.halfExtent,h.halfExtent),m=f.call(s,i.center,d);m=l.call(s,m,m),i.halfExtent=o.call(s,v,m,v)}this.bounds=i}this.dirtyBounds=!1},e.prototype.getJointTransform=function(e){return this.dirty&&this.update(),this.output[e]},e.prototype.getJointWorldTransform=function(e,t){return this.dirty&&this.update(),zt.standardGetJointWorldTransform(this,e,this.mathDevice,t)},e.prototype.setTime=function(e){var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1){var i=t[r];i.setTime(e)}this.dirty=!0,this.dirtyBounds=!0},e.prototype.setRate=function(e){var t=this.controllers,n=t.length;for(var r=0;r<n;r+=1)t[r].setRate(e)},e.prototype.setMask=function(e,t,n){var r=this.controllers[e],i=r.getHierarchy(),s=i.names,o=i.parents,u=i.numNodes,a,f;if(n)f=n.slice();else{f=[];for(a=0;a<u;a+=1)f[a]=!1}this.masks[e]=f;var l={};for(a=0;a<u;a+=1)l[s[a]]=a;var c=function(t,n){while(t!==-1){if(t===n)return!0;t=o[t]}return!1},h=t.split(" "),p=h.length;for(var d=0;d<p;d+=1){var v=!0,m=h[d];if(m!==""){m[0]==="-"&&(v=!1,m=m.slice(1));if(m[0]==="*"){m=m.slice(1);var g=l[m];for(a=0;a<u;a+=1)if(a===g||c(a,g))f[a]=v}else f[l[m]]=v}}},e.prototype.getHierarchy=function(){return this.controllers[0].getHierarchy()},e.create=function(t){var n=new e;n.outputChannels={},n.controllers=[],n.masks=[];var r=t.length;n.controllers.length=r;for(var i=0;i<r;i+=1){var s=t[i];n.controllers[i]=s,Ut.add(n.outputChannels,s.outputChannels)}var o=TurbulenzEngine.getMathDevice();return n.mathDevice=o,n.bounds={center:o.v3BuildZero(),halfExtent:o.v3BuildZero()},n.output=[],n.dirty=!0,n.dirtyBounds=!0,n},e.version=1,e}(),Qt=function(){function e(){}return e.prototype.addTime=function(e){},e.prototype.update=function(){},e.prototype.updateBounds=function(){if(this.dirtyBounds){var e=this.mathDevice,t=this.output,n=this.hierarchy.numNodes,r=this.hierarchy.parents,i=[],s,o;for(var u=0;u<n;u+=1){o=t[u],o.scale?s=e.m43FromRTS(o.rotation,o.translation,o.scale,s):s=e.m43FromRT(o.rotation,o.translation,s);var a=r[u];a!==-1?i[u]=e.m43Mul(s,i[a],i[u]):i[u]=e.m43Copy(s,i[u])}var f=Number.MAX_VALUE,l=e.v3Build(f,f,f),c=e.v3Build(-f,-f,-f);for(u=0;u<n;u+=1){s=i[u];var h=e.m43Pos(s);l=e.v3Min(l,h),c=e.v3Max(c,h)}this.bounds.center=e.v3ScalarMul(e.v3Add(l,c),.5),this.bounds.halfExtent=e.v3ScalarMul(e.v3Sub(c,l),.5)}this.dirtyBounds=!1},e.prototype.getJointTransform=function(e){var t=this.output;return t[e]},e.prototype.getJointWorldTransform=function(e,t){return zt.standardGetJointWorldTransform(this,e,this.mathDevice,t)},e.prototype.setTime=function(e){},e.prototype.setRate=function(e){},e.prototype.setOutputChannels=function(e){this.outputChannels=e},e.prototype.setJointPose=function(e,t,n,r){this.output[e].rotation=t,this.output[e].translation=n,this.output[e].scale=r,this.dirtyBounds=!0},e.prototype.getHierarchy=function(){return this.hierarchy},e.create=function(t){var n=TurbulenzEngine.getMathDevice(),r=new e;r.hierarchy=t;var i=TurbulenzEngine.getMathDevice();r.mathDevice=i,r.bounds={center:i.v3BuildZero(),halfExtent:i.v3BuildZero()};var s=[];r.output=s,r.outputChannels={};var o=n.quatBuild(0,0,0,1),u=n.v3BuildZero(),a=n.v3BuildOne(),f=t.numNodes;for(var l=0;l<f;l+=1)s[l]={rotation:o,translation:u,scale:a};return r.dirtyBounds=!0,r},e.version=1,e}(),Gt=function(){function e(){}return e.prototype.addTime=function(e){this.inputController.addTime(e),this.dirty=!0},e.prototype.setInputController=function(e){this.inputController=e,this.dirty=!0},e.prototype.setHierarchy=function(e,t){var n=function(t,r,i,s,o,u){i[t]=r;var a=t+1;while(a<s){var f=u[a],l=o[a];if(f!==t)return a;var c=!1,h;if(r){var p=l,d=r.children;if(d){var v=d.length;for(var m=0;m<v;m+=1){var g=r.children[m];g.name===p&&(c=!0,a=n(a,g,i,s,o,u))}}}c||(a=n(a,h,i,s,o,u))}return a};this.hierarchy=e,this.dirty=!0;var r=e.names,i=e.parents,s=e.numNodes;for(var o=0;o<s;o+=1){var u=i[o];if(u===-1){var a=null;t&&t.name===r[o]?a=t:a=this.scene.findNode(r[o]),a&&(o=n(o,a,this.nodesMap,s,r,i),o-=1)}}},e.prototype.setScene=function(e){this.scene=e,this.setHierarchy(this.hierarchy)},e.prototype.update=function(){if(!this.dirty&&!this.inputController.dirty)return;this.inputController.dirty&&this.inputController.update();var e=this.mathDevice,t,n=this.inputController.output,r=this.inputController.outputChannels,i=r.scale,s=this.hierarchy,o=this.nodesMap,u=this.ltms,a=s.numNodes,f,l;for(var c=0;c<a;c+=1){var h=n[c];i?f=e.m43FromRTS(h.rotation,h.translation,h.scale,f):(l=e.quatPosBuild(h.rotation,h.translation,l),f=e.m43FromQuatPos(l,u[c])),t=o[c],t&&t.setLocalTransform(f)}this.dirty=!1},e.create=function(t,n){var r=new e,i=t.numNodes;return r.dirty=!0,r.ltms=[],r.ltms.length=i,r.nodesMap=[],r.nodesMap.length=i,r.scene=n,r.setHierarchy(t),r.mathDevice=TurbulenzEngine.getMathDevice(),r},e.version=1,e}(),Yt=function(){function e(){}return e.prototype.setInputController=function(e){this.inputController=e,this.dirty=!0},e.prototype.setSkeleton=function(e){this.skeleton=e,this.dirty=!0;var t=e.numNodes;this.ltms.length=t,this.output.length=t},e.prototype.update=function(){if(!this.dirty&&!this.inputController.dirty)return;this.inputController.dirty&&this.inputController.update();var e=this.md,t=this.inputController.output,n=this.inputController.outputChannels,r=n.scale,i=this.skeleton.invBoneLTMs,s=this.skeleton.parents,o=this.ltms,u=this.output,a=this.skeleton.numNodes;for(var f=0;f<a;f+=1){var l=t[f],c;r?c=e.m43FromRTS(l.rotation,l.translation,l.scale,o[f]):c=e.m43FromRT(l.rotation,l.translation,o[f]);var h=s[f];h!==-1&&(c=e.m43Mul(c,o[h],o[f])),o[f]=c,u[f]=e.m43MulTranspose(i[f],c,u[f])}this.dirty=!1},e.create=function(t){var n=new e;return n.md=t,n.dirty=!0,n.ltms=[],n.output=[],n},e.version=1,e}(),Zt=function(){function e(){}return e.prototype.setInputController=function(e){this.inputController=e,this.dirty=!0},e.prototype.setSkeleton=function(e){var t=-1;this.skeleton&&(t=this.skeleton.numNodes),this.skeleton=e,this.dirty=!0;var n=e.numNodes;if(t!==n){this.ltms.length=n;var r=this.bufferSize||n*12;this.output=this.gd.createTechniqueParameterBuffer({numFloats:r,dynamic:!0})}},e.prototype.update=function(){if(!this.dirty&&!this.inputController.dirty)return;this.inputController.dirty&&this.inputController.update();var e=this.output,t=this.md,n=this.inputController.output,r=this.inputController.outputChannels,i=r.scale,s=this.skeleton.invBoneLTMs,o=this.skeleton.parents,u=this.ltms,a=this.outputMat,f=this.convertedquatPos,l=this.skeleton.numNodes,c=0,h;for(var p=0;p<l;p+=1){var d=n[p],v=o[p];v!==-1?(i?f=t.m43FromRTS(d.rotation,d.translation,d.scale,f):f=t.m43FromRT(d.rotation,d.translation,f),u[p]=h=t.m43Mul(f,u[v],u[p])):i?u[p]=h=t.m43FromRTS(d.rotation,d.translation,d.scale,u[p]):u[p]=h=t.m43FromRT(d.rotation,d.translation,u[p]),a=t.m43MulTranspose(s[p],h,a),e.setData(a,c,12),c+=12}this.dirty=!1},e.setDefaultBufferSize=function(t){e.prototype.defaultBufferSize=t},e.create=function(t,n,r){var i=new e;return i.md=n,i.gd=t,i.dirty=!0,i.ltms=[],i.outputMat=n.m34BuildIdentity(),i.convertedquatPos=n.m43BuildIdentity(),i.bufferSize=r||e.prototype.defaultBufferSize,i},e.version=1,e}();Zt.prototype.defaultBufferSize=undefined;var en=function(){function e(){}return e.prototype.addTime=function(e){this.input.addTime(e),this.skinController.dirty=!0},e.prototype.setNodeHierarchyBoneMatricesAndBounds=function(e,t,n){var r=!e.lightInstances||e.lightInstances.length===0,i=e.renderables;if(i){var s=i.length;for(var o=0;o<s;o+=1){var u=i[o];u.isSkinned()?(u.skinController=n,u.addCustomWorldExtents(t)):r=!1}}var a=e.children;if(a){var f=a.length;for(var l=0;l<f;l+=1){var c=this.setNodeHierarchyBoneMatricesAndBounds(a[l],t,n);c||(r=!1)}}return r?e.addCustomWorldExtents(t):e.getCustomWorldExtents()&&e.removeCustomWorldExtents(),r},e.prototype.update=function(e){var t=this.skinController;e?t.update():this.input.dirtyBounds&&this.input.updateBounds();var n=t.inputController.bounds,r=this.scratchExtents,i=this.node.getWorldTransform(),s=n.center[0],o=n.center[1],u=n.center[2],a=n.halfExtent[0],f=n.halfExtent[1],l=n.halfExtent[2];if(i){var c=Math.abs,h=i[0],p=i[1],d=i[2],v=i[3],m=i[4],g=i[5],y=i[6],b=i[7],w=i[8],E,S,x;s!==0||o!==0||u!==0?(E=h*s+v*o+y*u+i[9],S=p*s+m*o+b*u+i[10],x=d*s+g*o+w*u+i[11]):(E=i[9],S=i[10],x=i[11]);var T=c(h)*a+c(v)*f+c(y)*l,N=c(p)*a+c(m)*f+c(b)*l,C=c(d)*a+c(g)*f+c(w)*l;r[0]=E-T,r[1]=S-N,r[2]=x-C,r[3]=E+T,r[4]=S+N,r[5]=x+C}else r[0]=s-a,r[1]=o-f,r[2]=u-l,r[3]=s+a,r[4]=o+f,r[5]=u+l;this.setNodeHierarchyBoneMatricesAndBounds(this.node,r,t)},e.prototype.getJointIndex=function(e){var t=this.skinController.skeleton.names,n=this.skinController.skeleton.numNodes,r=-1;for(var i=0;i<n;i+=1)if(t[i]===e){r=i;break}return r},e.prototype.getJointLTM=function(e,t){this.input.dirty&&this.input.update();var n=this.md,r=this.input.output,i=this.input.outputChannels,s=i.scale,o=this.skinController.skeleton.parents,u=r[e],a;s?a=n.m43FromRTS(u.rotation,u.translation,u.scale,t):a=n.m43FromRT(u.rotation,u.translation,t);var f=this.scratchM43;while(o[e]!==-1)e=o[e],u=r[e],s?f=n.m43FromRTS(u.rotation,u.translation,u.scale,f):f=n.m43FromRT(u.rotation,u.translation,f),a=n.m43Mul(a,f,a);return a},e.prototype.setInputController=function(e){this.input=e,this.skinController.setInputController(e),this.skinController.dirty=!0},e.prototype.getSkeleton=function(){return this.skinController.skeleton},e.create=function(t,n,r,i,s,o){var u=new e;return u.md=n,u.input=s,t?u.skinController=Zt.create(t,n,o):u.skinController=Yt.create(n),u.input&&u.skinController.setInputController(u.input),u.skinController.setSkeleton(i),u.node=r,u.scratchM43===null&&(e.prototype.scratchM43=n.m43BuildIdentity()),u.scratchExtents===null&&(e.prototype.scratchExtents=n.aabbBuildEmpty()),u},e.version=1,e}();en.prototype.scratchM43=null,en.prototype.scratchExtents=null;var tn=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480||s===504){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(t){var n=new e;n.initialRetryTime=t.initialRetryTime||500,n.notifyTime=t.notifyTime||4e3,n.maxRetryTime=t.maxRetryTime||8e3,n.notifiedConnectionLost=!1,n.connected=!0,n.reconnectedObserver=l.create(),n.reconnectTest=null,n.onReconnected=t.onReconnected||function(){},n.onRequestTimeout=t.onRequestTimeout||function(){};var r={eventOnload:[]};return n.handlers=r,n},e}(),nn=function(){function e(){this.maxVerticesPerVertexBuffer=65535,this.numBuckets=10}return e.prototype.bucket=function(e){if(e<=64)return e<=16?e<=8?0:1:e<=32?2:3;if(e<=512)return e<=256?e<=128?4:5:6;return e<=2048?e<=1024?7:8:9},e.prototype.makeBuckets=function(){var e=[];for(var t=0;t<this.numBuckets;t+=1)e.push({headChunk:null});return e},e.prototype.allocate=function(e,t){var n=null,r=0,i={numVertices:undefined,attributes:t,dynamic:this.dynamicVertexBuffers},s,o=this.maxVerticesPerVertexBuffer,u="",a,f;for(a=0;a<t.length;a+=1)f=t[a],f.name?u+=f.name:typeof f=="number"?u+=f:u+=f.toString(),u+=",";var l=this.vertexBuffersPools.length,c;for(s=0;s<l;s+=1)if(this.vertexBuffersPools[s].attributesHash===u){c=this.vertexBuffersPools[s];break}c||(c={attributesHash:u,vertexBufferData:[]},this.vertexBuffersPools.push(c));var h;if(e<o){for(var p=this.bucket(e);!n&&p<this.numBuckets;p+=1){var d;for(var v=0;!n&&v<c.vertexBufferData.length;v+=1){h=c.vertexBufferData[v],d=null;for(var m=h.bucket[p].headChunk;m;m=m.nextChunk){if(e<=m.length){n=h.vertexBuffer,r=m.baseIndex;if(e<m.length){m.baseIndex=r+e,m.length-=e;var g=this.bucket(m.length);g!==p&&(d?d.nextChunk=m.nextChunk:h.bucket[p].headChunk=m.nextChunk,m.nextChunk=h.bucket[g].headChunk,h.bucket[g].headChunk=m)}else d?d.nextChunk=m.nextChunk:h.bucket[p].headChunk=m.nextChunk,m.vertexBuffer=null;break}d=m}}}n||(i.numVertices=o,n=this.graphicsDevice.createVertexBuffer(i),this.debugCreatedVertexBuffers+=1,n&&(h={vertexBuffer:n,bucket:this.makeBuckets()},h.bucket[this.bucket(o-e)].headChunk={baseIndex:e,length:o-e,nextChunk:null},c.vertexBufferData.push(h)))}return n||(i.numVertices=e,n=this.graphicsDevice.createVertexBuffer(i),this.debugCreatedVertexBuffers+=1,n&&c.vertexBufferData.push({vertexBuffer:n,bucket:this.makeBuckets()})),{vertexBuffer:n,baseIndex:r,length:e,poolIndex:s}},e.prototype.free=function(e){var t=this.vertexBuffersPools[e.poolIndex],n;for(var r=0;r<t.vertexBufferData.length;r+=1)if(e.vertexBuffer===t.vertexBufferData[r].vertexBuffer){n=t.vertexBufferData[r];break}var i,s,o,u,a;for(var f=0;(!i||!o)&&f<this.numBuckets;f+=1){a=null;for(var l=n.bucket[f].headChunk;l&&(!i||!o);l=l.nextChunk)i||l.baseIndex+l.length===e.baseIndex&&(i=l,s=a),o||l.baseIndex===e.baseIndex+e.length&&(o=l,u=a),a=l}var c,h;if(i&&o)c=this.bucket(i.length),i.length+=e.length+o.length,u?(u.nextChunk=o.nextChunk,o===s&&(s=u)):(n.bucket[this.bucket(o.length)].headChunk=o.nextChunk,o===s&&(s=null)),h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(i)c=this.bucket(i.length),i.length+=e.length,h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(o)c=this.bucket(o.length),o.baseIndex=e.baseIndex,o.length+=e.length,h=this.bucket(o.length),h!==c&&(u?u.nextChunk=o.nextChunk:n.bucket[c].headChunk=o.nextChunk,o.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=o);else{var p=n.bucket[this.bucket(e.length)];p.headChunk={baseIndex:e.baseIndex,length:e.length,nextChunk:p.headChunk}}var d=n.bucket[this.numBuckets-1].headChunk;d&&d.length>=this.maxVerticesPerVertexBuffer&&(t.vertexBufferData.splice(r,1),n.vertexBuffer.destroy(),n.vertexBuffer=null,n.bucket.length=0,n.bucket=null)},e.prototype.destroy=function(){var e=this.vertexBuffersPools;if(e){var t=e.length,n,r;for(n=0;n<t;n+=1){var i=e[n],s=i.vertexBufferData,o=s.length;for(r=0;r<o;r+=1){var u=s[r],a=u.bucket;a&&(a.length=0,u.bucket=null);var f=u.vertexBuffer;f&&(f.destroy(),u.vertexBuffer=null)}s.length=0}e.length=0,this.vertexBuffersPools=null}this.graphicsDevice=null},e.create=function(t,n){var r=new e;return r.vertexBuffersPools=[],r.debugCreatedVertexBuffers=0,r.graphicsDevice=t,r.dynamicVertexBuffers=n?!0:!1,r},e.version=1,e}(),rn=function(){function e(){this.maxIndicesPerIndexBuffer=262144,this.numBuckets=10}return e.prototype.bucket=function(e){if(e<=64)return e<=16?e<=8?0:1:e<=32?2:3;if(e<=512)return e<=256?e<=128?4:5:6;return e<=2048?e<=1024?7:8:9},e.prototype.makeBuckets=function(){var e=[];for(var t=0;t<this.numBuckets;t+=1)e.push({headChunk:null});return e},e.prototype.allocate=function(e,t){var n=null,r=0;typeof t=="string"&&(t=this.graphicsDevice["INDEXFORMAT_"+t]);var i={numIndices:undefined,format:t,dynamic:this.dynamicIndexBuffers},s,o=this.maxIndicesPerIndexBuffer,u=this.indexBuffersPools.length,a;for(s=0;s<u;s+=1)if(this.indexBuffersPools[s].format===t){a=this.indexBuffersPools[s];break}a||(a={format:t,indexBufferData:[]},this.indexBuffersPools.push(a));var f;if(e<o){for(var l=this.bucket(e);!n&&l<this.numBuckets;l+=1){var c;for(var h=0;!n&&h<a.indexBufferData.length;h+=1){f=a.indexBufferData[h],c=null;for(var p=f.bucket[l].headChunk;p;p=p.nextChunk){if(e<=p.length){n=f.indexBuffer,r=p.baseIndex;if(e<p.length){p.baseIndex=r+e,p.length-=e;var d=this.bucket(p.length);d!==l&&(c?c.nextChunk=p.nextChunk:f.bucket[l].headChunk=p.nextChunk,p.nextChunk=f.bucket[d].headChunk,f.bucket[d].headChunk=p)}else c?c.nextChunk=p.nextChunk:f.bucket[l].headChunk=p.nextChunk,p.indexBuffer=null;break}c=p}}}n||(i.numIndices=o,n=this.graphicsDevice.createIndexBuffer(i),this.debugCreatedIndexBuffers+=1,n&&(f={indexBuffer:n,bucket:this.makeBuckets()},f.bucket[this.bucket(o-e)].headChunk={baseIndex:e,length:o-e,nextChunk:null},a.indexBufferData.push(f)))}return n||(i.numIndices=e,n=this.graphicsDevice.createIndexBuffer(i),this.debugCreatedIndexBuffers+=1,n&&a.indexBufferData.push({indexBuffer:n,bucket:this.makeBuckets()})),{indexBuffer:n,baseIndex:r,length:e,poolIndex:s}},e.prototype.free=function(e){var t=this.indexBuffersPools[e.poolIndex],n;for(var r=0;r<t.indexBufferData.length;r+=1)if(e.indexBuffer===t.indexBufferData[r].indexBuffer){n=t.indexBufferData[r];break}var i,s,o,u,a;for(var f=0;(!i||!o)&&f<this.numBuckets;f+=1){a=null;for(var l=n.bucket[f].headChunk;l&&(!i||!o);l=l.nextChunk)i||l.baseIndex+l.length===e.baseIndex&&(i=l,s=a),o||l.baseIndex===e.baseIndex+e.length&&(o=l,u=a),a=l}var c,h;if(i&&o)c=this.bucket(i.length),i.length+=e.length+o.length,u?(u.nextChunk=o.nextChunk,o===s&&(s=u)):(n.bucket[this.bucket(o.length)].headChunk=o.nextChunk,o===s&&(s=null)),h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(i)c=this.bucket(i.length),i.length+=e.length,h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(o)c=this.bucket(o.length),o.baseIndex=e.baseIndex,o.length+=e.length,h=this.bucket(o.length),h!==c&&(u?u.nextChunk=o.nextChunk:n.bucket[c].headChunk=o.nextChunk,o.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=o);else{var p=n.bucket[this.bucket(e.length)];p.headChunk={baseIndex:e.baseIndex,length:e.length,nextChunk:p.headChunk}}var d=n.bucket[this.numBuckets-1].headChunk;d&&d.length>=this.maxIndicesPerIndexBuffer&&(t.indexBufferData.splice(r,1),n.indexBuffer.destroy(),n.indexBuffer=null,n.bucket.length=0,n.bucket=null)},e.prototype.destroy=function(){var e=this.indexBuffersPools;if(e){var t=e.length,n,r;for(n=0;n<t;n+=1){var i=e[n],s=i.indexBufferData,o=s.length;for(r=0;r<o;r+=1){var u=s[r],a=u.bucket;a&&(a.length=0,u.bucket=null);var f=u.indexBuffer;f&&(f.destroy(),u.indexBuffer=null)}s.length=0}e.length=0,this.indexBuffersPools=null}this.graphicsDevice=null},e.create=function(t,n){var r=new e;return r.indexBuffersPools=[],r.debugCreatedIndexBuffers=0,r.graphicsDevice=t,r.dynamicIndexBuffers=n?!0:!1,r},e.version=1,e}(),sn=function(){function e(){}return e.create=function(){return new e},e}(),on=function(){function e(){}return e.prototype.push=function(e,t){var n=sn.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var t=new e;return t.events=[],t},e}(),un=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,i=this.serviceStatusObserver,s;s=function(o,u){u?e.neverDiscard||(i.unsubscribe(s),t()):o&&(i.unsubscribe(s),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,i.subscribe(s)),!0);var o=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,p=h?h.discardRequests:!0;return n.discardRequests=p,p&&!e.neverDiscard?t():i.subscribe(s),an.serviceUnavailable(n,u),!1}return o?o.call(e.requestHandler,u,a,f,l):!0},r.ajax(e),!0},e.create=function(t,n){var r=new e;return n||(n={}),r.running=!0,r.discardRequests=!1,r.serviceStatusObserver=l.create(),r.serviceName=t,r.onServiceUnavailable=n.onServiceUnavailable,r.onServiceAvailable=n.onServiceAvailable,r},e}(),an=function(){function e(){}return e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var e=window.top.Turbulenz,t=e&&e.Data||{},n=t.joinMultiplayerSessionId,r=this,i=function(t){r.multiplayerJoinRequestQueue.push(t)},s=function(t){var n=JSON.parse(t);n.mode&&(r.mode=n.mode),n.joinMultiplayerSessionId&&r.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),r.bridgeServices=!!n.bridgeServices};n&&this.multiplayerJoinRequestQueue.push(n),fn.setOnMultiplayerSessionToJoin(i),fn.setOnReceiveConfig(s),fn.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,fn.on("bridgeservices.response",function(e){r.routeResponse(e)})},e.callOnBridge=function(e,t,n){var r={data:t,key:undefined};n&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=n,r.key=this.responseIndex),fn.emit("bridgeservices."+e,JSON.stringify(r))},e.addSignature=function(e,t){var n;return e.requestUrl=t,n=TurbulenzEngine.encrypt(JSON.stringify(e)),e.str=n,e.signature=TurbulenzEngine.generateSignature(n),e},e.routeResponse=function(e){var t=JSON.parse(e),n=t.key||0,r=this.responseHandlers[n];r&&(this.responseHandlers[n]=null,r(t.data))},e.onServiceUnavailable=function(e,t){},e.onServiceAvailable=function(e,t){},e.createGameSession=function(e,t,n){return ln.create(e,t,n)},e.createMappingTable=function(t,n,r,i,s){var o,u=n&&n.mappingTable,a,f,l;u?(a=u.mappingTableURL,f=u.mappingTablePrefix,l=u.assetPrefix):i?(a=i.mappingTableURL||(i.mappingTableURL===""?"":"mapping_table.json"),f=i.mappingTablePrefix||(i.mappingTablePrefix===""?"":"staticmax/"),l=i.assetPrefix||(i.assetPrefix===""?"":"missing/")):(a="mapping_table.json",f="staticmax/",l="missing/");var c=function(n){var r=i&&(i.urnMapping||{}),u=s||e.defaultErrorCallback;o.setMapping(r),u(n)},h={mappingTableURL:a,mappingTablePrefix:f,assetPrefix:l,requestHandler:t,onload:r,errorCallback:c};return o=cn.create(h),o},e.createLeaderboardManager=function(e,t,n,r){return LeaderboardManager.create(e,t,n,r)},e.createBadgeManager=function(e,t){return BadgeManager.create(e,t)},e.createStoreManager=function(e,t,n,r){return StoreManager.create(e,t,n,r)},e.createNotificationsManager=function(e,t,n,r){return NotificationsManager.create(e,t,n,r)},e.createMultiplayerSessionManager=function(e,t){return MultiPlayerSessionManager.create(e,t)},e.createUserProfile=function(t,n,r){var i={};r||(r=e.defaultErrorCallback);var s=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n])}},o="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:o,method:"GET",callback:function(t,o){o===200?s(t):r&&r("TurbulenzServices.createUserProfile error with HTTP status "+o+": "+t.msg,o),n&&n(i)},requestHandler:t}),i},e.upgradeAnonymousUser=function(e){if(e){var t=function(n){e()};fn.on("user.upgrade.occurred",t)}fn.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(t,n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof t||0===t.length){s("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof n||isNaN(n)||!isFinite(n)){if("[object Array]"!==Object.prototype.toString.call(n)){s("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var o,u=n.length;for(o=0;o<u;o+=1)if("number"!=typeof n[o]||isNaN(n[o])||!isFinite(n[o])){s("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+i.gameSlug,method:"POST",data:{key:t,value:n,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.sendCustomMetricEventBatch=function(t,n,r,i){i||(i=e.defaultErrorCallback);if(!e.available()){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var s=TurbulenzEngine.time,o=t.events,u,a=o.length;for(u=0;u<a;u+=1){var f=o[u].key,l=o[u].value,c=o[u].timeOffset;if("string"!=typeof f||0===f.length){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof l||isNaN(l)||!isFinite(l)){if("[object Array]"!==Object.prototype.toString.call(l)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var h,p=l.length;for(h=0;h<p;h+=1)if("number"!=typeof l[h]||isNaN(l[h])||!isFinite(l[h])){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers"
,0);return}}if("number"!=typeof c||isNaN(c)||!isFinite(c)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}o[u].timeOffset=c-s}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+r.gameSlug,method:"POST",data:{batch:o,gameSessionId:r.gameSessionId},callback:function(t,n){n!==200&&i&&i("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:n,encrypt:!0})},e.getService=function(e){var t=this.services;if(t.hasOwnProperty(e))return t[e];var n=un.create(e);return t[e]=n,n},e.serviceUnavailable=function(t,n){var i=this.waitingServices,s=t.serviceName;if(i.hasOwnProperty(s))return;i[s]=t,t.running=!1;var o=function(r){var i=n.onServiceUnavailable;i&&i.call(r,n),r.onServiceUnavailable&&r.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(r)};t.discardRequests&&o(t);if(this.pollingServiceStatus)return;var u=this,a,f="/api/v1/service-status/game/read/"+window.gameSlug,l=function(r,s){if(s===200){var f=r.data,l=f.services,c=!1,h;for(h in i)if(i.hasOwnProperty(h)){var p=i[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=n.onServiceAvailable;m&&m.call(p,n),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete i[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&(p.discardRequests=!0,o(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(a,f.pollInterval*1e3)}else TurbulenzEngine.setTimeout(a,u.defaultPollInterval)};a=function(){r.ajax({url:f,method:"GET",callback:l})},a()},e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.defaultErrorCallback=function(e,t){},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e}();typeof fn!="undefined"&&an.addBridgeEvents();var fn=function(){function e(){}return e._initInstance=function(){var e=window.top.Turbulenz;if(e&&e.Services){var t=e.Services.bridge;if(!t)return;this._bridge=t,this.emit=t.emit,this.on=t.gameListenerOn||t.addListener||t.setListener,this.addListener=t.gameListenerOn||t.addListener||t.setListener,this.setListener=t.gameListenerOn||t.setListener}typeof an!="undefined"&&an.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(e,t,n){},e.on=function(e,t){},e.addListener=function(){},e.setListener=function(e,t){},e.setOnReceiveConfig=function(e){this.on("config.set",e)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(e){this.emit("game.session.created",e)},e.destroyedGameSession=function(e){this.emit("game.session.destroyed",e)},e.setGameSessionStatus=function(e,t){this.emit("game.session.status",e,t)},e.setGameSessionInfo=function(e){this.emit("game.session.info",e)},e.updateUserBadge=function(e){this.emit("userbadge.update",e)},e.updateLeaderBoard=function(e){this.emit("leaderboards.update",e)},e.setOnMultiplayerSessionToJoin=function(e){this.on("multiplayer.session.join",e)},e.triggerJoinedMultiplayerSession=function(e){this.emit("multiplayer.session.joined",e)},e.triggerLeaveMultiplayerSession=function(e){this.emit("multiplayer.session.leave",e)},e.triggerMultiplayerSessionMakePublic=function(e){this.emit("multiplayer.session.makepublic",e)},e.setOnBasketUpdate=function(e){this.on("basket.site.update",e)},e.triggerBasketUpdate=function(e){this.emit("basket.game.update.v2",e)},e.triggerUserStoreUpdate=function(e){this.emit("store.user.update",e)},e.setOnPurchaseConfirmed=function(e){this.on("purchase.confirmed",e)},e.setOnPurchaseRejected=function(e){this.on("purchase.rejected",e)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(e){this.on("store.meta.v2",e)},e.triggerSendInstantNotification=function(e){this.emit("notifications.ingame.sendInstant",e)},e.triggerSendDelayedNotification=function(e){this.emit("notifications.ingame.sendDelayed",e)},e.setOnNotificationSent=function(e){this.on("notifications.ingame.sent",e)},e.triggerCancelNotificationByID=function(e){this.emit("notifications.ingame.cancelByID",e)},e.triggerCancelNotificationsByKey=function(e){this.emit("notifications.ingame.cancelByKey",e)},e.triggerCancelAllNotifications=function(e){this.emit("notifications.ingame.cancelAll",e)},e.triggerInitNotificationManager=function(e){this.emit("notifications.ingame.initNotificationManager",e)},e.setOnReceiveNotification=function(e){this.on("notifications.ingame.receive",e)},e.changeAspectRatio=function(e){this.emit("change.viewport.ratio",e)},e.setOnViewportHide=function(e){this.on("change.viewport.hide",e)},e.setOnViewportShow=function(e){this.on("change.viewport.show",e)},e.setOnFullscreenOn=function(e){this.on("change.viewport.fullscreen.on",e)},e.setOnFullscreenOff=function(e){this.on("change.viewport.fullscreen.off",e)},e.setOnMenuStateChange=function(e){this.on("change.menu.state",e)},e.setOnUserStateChange=function(e){this.on("change.user.state",e)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(e){this.emit("query.viewport.fullscreen",e)},e.queryViewportVisibility=function(e){this.emit("query.viewport.visibility",e)},e.queryMenuState=function(e){this.emit("query.menu.state",e)},e.queryUserState=function(e){this.emit("query.user.state",e)},e._bridge=undefined,e}();fn.isInitialised()||fn._initInstance();var ln=function(){function e(){this.post_delay=1e3}return e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,fn.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(fn.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},an.bridgeServices?an.callOnBridge("gamesession.destroy",t,e):r.ajax({url:"/api/v1/games/destroy-session",method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(t,n,r){var i=new e,s=window.gameSlug,o=window.top.Turbulenz,u=o&&o.Data||{},a=u.mode||an.mode,f="/api/v1/games/create-session/"+s;i.info={sessionData:{},playerSessionData:{}},i.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},i.postData=function(){fn.setGameSessionInfo(JSON.stringify(i.info)),i.pendingUpdate=null},i.pendingUpdate=null,i.gameSlug=s,i.requestHandler=t,i.errorCallbackFn=r||an.defaultErrorCallback,i.gameSessionId=null,i.service=an.getService("gameSessions"),i.status=null;if(!an.available())return n&&TurbulenzEngine.setTimeout(function(){n(i)},0),i;var l=function(t,r){r===200?(i.mappingTable=t.mappingTable,i.gameSessionId=t.gameSessionId,n&&n(i),fn.createdGameSession(i.gameSessionId)):404===r?(window.gameSlug=undefined,i.gameSlug=undefined,n&&n(i)):i.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+r+": "+t.msg,r)};return a&&(f+="/"+a),i.service.request({url:f,method:"POST",callback:l,requestHandler:t,neverDiscard:!0}),i},e.version=1,e}(),cn=function(){function e(){}return e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(t){var n=new e;n.mappingTableURL=t.mappingTableURL,n.tablePrefix=t.mappingTablePrefix,n.assetPrefix=t.assetPrefix,n.overrides={},n.errorCallbackFn=t.errorCallback||an.defaultErrorCallback,n.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var r=function(r){var i=r.urnmapping||r.urnremapping||{},s=r.overrides||{};n.urlMapping=i,n.overrides=s;var o=n.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}t.onload(n)};return n.mappingTableURL?t.requestHandler.request({src:n.mappingTableURL,onload:function(t,i){if(i===200){var s=JSON.parse(t);r(s)}else n.urlMapping={},t=t||{msg:"(no response)"},n.errorCallbackFn("MappingTable.create: HTTP status "+i+": "+t.msg,i)}}):t.mappingTableData?TurbulenzEngine.setTimeout(function(){r(JSON.parse(t.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){n.errorCallbackFn("!! mappingtable params contain no url or data")},0),n},e.version=1,e}(),hn=function(){function e(){}return e.prototype.complete=function(){return this.dependenciesLoaded||this.sceneAssetsRequested&&0===this.textureManager.getNumPendingTextures()&&(!this.shaderManager||0===this.shaderManager.getNumPendingShaders())&&(this.dependenciesLoaded=!0),this.dependenciesLoaded},e.prototype.load=function(e){function i(e,t){r.request({src:n&&n[e]||this.pathPrefix+e,onload:t})}function s(){t.postSceneLoadFn&&t.postSceneLoadFn(t.scene),t.sceneAssetsRequested=!0}function o(n){function o(e){TurbulenzEngine.setTimeout(e,0)}function u(e){var t=function(){};return t.prototype=e,new t}function f(e){t.animationManager&&t.animationManager.loadData(e),a.data=e,a.yieldFn=o,a.onload=s,t.scene.load(a)}var i=JSON.parse(n);i||(i={}),e.preSceneLoadFn&&e.preSceneLoadFn(i);var a=u(e),l=It.create();l.resolve({data:i,request:this.request,onload:f,requestHandler:r})}var t=this;this.sceneAssetsRequested=!1,this.scene=e.scene,this.assetPath=e.assetPath,this.textureManager=e.textureManager,this.shaderManager=e.shaderManager,this.effectManager=e.effectManager,this.animationManager=e.animationManager,this.requestHandler=e.requestHandler,e.keepLights!==undefined&&(this.keepLights=e.keepLights),e.keepCameras!==undefined&&(this.keepCameras=e.keepCameras),this.preSceneLoadFn=e.preSceneLoadFn,this.postSceneLoadFn=e.postSceneLoadFn,this.dependenciesLoaded=!1,this.sceneLoaded=!1,e.append||this.scene.clear();var n=this.pathRemapping,r=this.requestHandler;e.request?this.request=e.request:this.request=i,this.request(e.assetPath,o)},e.prototype.setPathRemapping=function(e,t){this.pathRemapping=e,this.pathPrefix=t},e.create=function(){var t=new e;return t.scene=null,t.assetPath=null,t.textureManager=null,t.shaderManager=null,t.effectManager=null,t.animationManager=null,t.preSceneLoadFn=null,t.postSceneLoadFn=null,t.dependenciesLoaded=!1,t.sceneAssetsRequested=!1,t.pathPrefix="",t},e}(),pn=function(){function e(){this.pi2=2*Math.PI,this.rotationType={none:0,weave2D:1,rotate:2},this.movementType={none:0,constant:1,pulse:2},this.directionType={none:0,circular2D:1,linear:2},this.movementRate=1,this.isMovementForward=!0,this.circularRadius=1,this.rotationRate=1,this.rotationVariation=1}return e.prototype.setCircularMovement=function(e,t){var n=this.md,r=this.circularCenter;r[0]=t[0],r[2]=t[2],e>0&&(this.circularRadius=e),this.centerPosition=n.v3Build(r[0],0,r[2],this.centerPosition),this.dirMode=this.directionType.circular2D},e.prototype.setRailMovement=function(e,t){this.rotMode=this.rotationType.none,this.dirMode=this.directionType.linear,this.movMode=this.movementType.constant,t>0&&(this.movementRate=t),this.atTarget=!1,this.targetPosition=e},e.prototype.setConstantMotion=function(e){e>0&&(this.movementRate=e),this.movMode=this.movementType.constant},e.prototype.setDuckMotion=function(e,t,n){e>0&&(this.movementRate=e),t>0&&(this.rotationRate=t),n<0||n>1||(this.rotationVariation=n),this.rotMode=this.rotationType.weave2D,this.movMode=this.movementType.pulse},e.prototype.setConstantRotation=function(e){e>0&&(this.rotationRate=e),this.rotMode=this.rotationType.rotate},e.prototype.setUpdateMatrix=function(e){this.matrix=e},e.prototype.setBaseOrientation=function(e){var t=this.md;this.baseRotation=t.m43FromAxisRotation(this.up,e,this.baseRotation)},e.prototype.reverseDirection=function(){this.isMovementForward=!this.isMovementForward},e.prototype.getMovementRate=function(){return this.movementRate},e.prototype.getRotationRate=function(){return this.rotationRate},e.prototype.updateRotation=function(e){var t=this.md,n=this.up,r=this.baseRotation,i=this.centerPosition,s=this.endPosition,o=this.matrix,u=this.variantRotation,a=this.xaxis,f=this.yaxis,l=this.zaxis,c=this.rotMode,h=this.rotationType.weave2D,p=this.rotationType.rotate;h===c?(u=t.m43FromAxisRotation(n,this.rotationVariation*this.motionWaveSin,u),a=t.v3Sub(s,i,a),t.v3Normalize(a,a),l=t.v3Cross(a,n,l),t.v3Normalize(l,l)):p===c?(u=t.m43FromAxisRotation(n,this.motionPhase,u),a=t.v3Build(1,0,0,a),f=t.v3Build(0,1,0,f),l=t.v3Build(0,0,1,l)):(u=t.m43FromAxisRotation(n,0,u),a=t.v3Build(1,0,0,a),l=t.v3Cross(a,n,l),t.v3Normalize(l,l)),o=t.m43Build(a,n,l,s,o),o=t.m43Mul(o,r,o),this.matrix=t.m43Mul(o,u,o)},e.prototype.updateMovement=function(e){var t=this.movMode,n=this.movementType.pulse,r=this.movementType.constant;n===t?this.movementDelta=this.movementRate*((1-this.motionWaveSin)*.5+.2)*e:r===t&&(this.movementDelta=this.movementRate*e)},e.prototype.updateDirection=function(e){var t=this.md,n=this.movementDelta*this.pi2,r=this.movementDelta;this.isMovementForward||(n*=-1),this.circularAngle+=n;var i=this.circularAngle,s=this.circularCenter,o=this.circularRadius,u=this.position,a=this.targetPosition,f=this.v3temp,l=this.atTarget,c=this.atTargetDelta,h=this.dirMode,p=this.directionType;if(p.circular2D===h)u[0]=o*Math.sin(i)+s[0],u[2]=o*Math.cos(i)+s[2];else if(p.linear===h&&!l){var d=u[0],v=u[1],m=u[2];f[0]=a[0]-d,f[1]=a[1]-v,f[2]=a[2]-m,t.v3LengthSq(f)<c?this.atTarget=!0:(r<1&&(f=t.v3ScalarMul(f,r,f)),u[0]=d+f[0],u[1]=v+f[1],u[2]=m+f[2])}this.endPosition=t.v3Copy(this.position,this.endPosition)},e.prototype.update=function(e){var t=this.md,n=this.pi2,r=e*n;this.move&&(this.motionPhase+=this.rotationRate*r,this.motionWaveSin=Math.sin(this.motionPhase),this.motionWaveCos=Math.cos(this.motionPhase),this.updateMovement(e),this.updateDirection(e),this.updateRotation(r),t.m43SetPos(this.matrix,this.endPosition))},e.create=function(t,n){var r=new e;return r.md=t,r.name=n,r.matrix=t.m43BuildIdentity(),r.rotMode=r.rotationType.none,r.movMode=r.movementType.none,r.dirMode=r.directionType.none,r.up=t.v3Build(0,1,0),r.position=t.v3BuildZero(),r.endPosition=t.v3BuildZero(),r.circularAngle=0,r.circularCenter=t.v3BuildZero(),r.centerPosition=t.v3Build(r.circularCenter[0],r.circularCenter[1],r.circularCenter[2]),r.motionPhase=0,r.motionWaveSin=Math.sin(r.motionPhase),r.motionWaveCos=Math.cos(r.motionPhase),r.move=!0,r.atTarget=!0,r.atTargetDelta=.001,r.targetPosition=t.v3BuildZero(),r.xaxis=t.v3BuildZero(),r.yaxis=t.v3BuildZero(),r.zaxis=t.v3BuildZero(),r.v3temp=t.v3BuildZero(),r.baseRotation=t.m43BuildIdentity(),r.variantRotation=t.m43BuildIdentity(),r},e.version=3,e}(),dn=function(){function e(){this.version=1}return e.prototype.setSelectedRadio=function(e,t){var n=this.radioControls[e],r;n&&(r=n.controls[t],r&&(n.selected=t,this.updateRadio(r.id,!0)))},e.prototype.addRadioControl=function(e){var t=this.radioControls,n=e.groupName,r=e.radioIndex,i=e.id,s=e.fn,o=e.isDefault;if(n===undefined||n===null||r<0||i===undefined||i===null||s===undefined||s===null)return;var u=t[n];u||(t[n]={},u=t[n],u.controls=[],u.selected=0),u.controls[r]=e,o&&(u.selected=r),this.updateRadio(i,o)},e.prototype.addCheckboxControl=function(e){var t=this.checkboxControls,n=e.id,r=e.value;t[r]=e,this.updateCheckbox(n,e.isSelected)},e.prototype.addButtonControl=function(e){var t=this.buttonControls,n=e.id;t[n]=e},e.prototype.addSliderControl=function(e){var t=this.sliderControls;t[e.id]=e},e.prototype.getSliderValue=function(e){var t=window.$("#"+e).value;return t?parseInt(t,10):undefined},e.prototype.getHandler=function(){var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls;return function(r){var i;r||(r=window.event),r.target?i=r.target:r.srcElement&&(i=r.srcElement),i.nodeType===3&&(i=i.parentNode);var s=i.id,o;switch(i.type){case"radio":for(var u in e)if(e.hasOwnProperty(u)){var a=0,f=e[u].controls,l=f.length;while(a<l){o=f[a];if(o.id===s){o.fn();return}a+=1}}break;case"checkbox":for(var c in t)if(t.hasOwnProperty(c)){o=t[c];if(o.id===s){var h=o.fn();h!==undefined&&(document.getElementById(o.id).checked=!!h);return}}break;case"button":for(var p in n)if(n.hasOwnProperty(p)){o=n[p];if(p===s){o.fn();return}}break;default:}}},e.prototype.register=function(){function d(e){return function(t,n){var r=window.$("#"+e+"input");r.val(n.value),r.change()}}function v(e,t){return function(){var n=parseFloat(this.value);if(!window.$)return;var r=window.$("#"+t),i=window.$("#"+t+"input");if(!r||!i)return;var s=r.slider("value");if(n===undefined||isNaN(n)||s===undefined||isNaN(s)||s===n)return;var o=r.slider("option","min"),u=r.slider("option","max");n<o?n=o:n>u&&(n=u),i.val(n),e.value=n,e.fn()}}var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls,r=this.sliderControls,i,s,o;for(var u in e)if(e.hasOwnProperty(u)){var a=e[u].selected,f=e[u].controls,l=f.length;for(var c=0;c<l;c+=1)i=f[c],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.name=i.groupName,s.onclick=this.getHandler(),s.checked=a===i.radioIndex?"checked":"")}for(var h in t)t.hasOwnProperty(h)&&(i=t[h],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler(),s.checked=i.isSelected?"checked":""));for(var p in n)n.hasOwnProperty(p)&&(i=n[p],o=p,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler()));for(var m in r)if(r.hasOwnProperty(m)){i=r[m],o=i.id;if(!window.$)return;var g=window.$("#"+o),y=window.$("#"+o+"input");if(!g||!y)return;g.slider({value:i.value,min:i.min,max:i.max,step:i.step,slide:d(o)}),y.val(g.slider("value")),y.change(v(i,o))}this.registered=!0},e.prototype.updateRadio=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateCheckbox=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateSlider=function(e,t){if(!this.registered)return;if(window.$){var n=window.$("#"+e);n&&n.slider("option","value",t)}},e.create=function(){var t=new e;return t.radioControls={},t.checkboxControls={},t.buttonControls={},t.sliderControls={},t.registered=!1,t},e}();void 0,TurbulenzEngine.onload=function(){var n=function(t){window.alert(t)},r={},i=TurbulenzEngine.createGraphicsDevice(r);if(!i.shadingLanguageVersion){n("No shading language support detected.\nPlease check your graphics drivers are up to date."),i=null;return}var s=[.5,.5,.5,1];i.beginFrame()&&(i.clear(s),i.endFrame());var o={},u=TurbulenzEngine.createMathDevice(o),a={},f=tn.create(a),l=Dt.create(i,f,null,n),c=Mt.create(i,f,null,n),h=Ot.create(),p=qt.create(n);c.setAutomaticParameterResize("skinBones",60);var d=It.create(),v=Lt.create(u),m=hn.create(),g,y,b=u.v3BuildYAxis(),w=wt.create(u);w.nearPlane=.05,w.updateViewMatrix();var E,S,x=1.2,T=[-1,1,-1],N={animScale:1,defaultRate:1,drawDebug:!1,drawInterpolators:!1,drawWireframe:!1,loopAnimation:!0},C="models/Seymour.dae",k={count:64,max:400,min:1,lastCount:1,startPos:[0,0,0],gridSpace:.1,baseAngle:135,varAngle:270,height:.1},L=Math.PI/180,A={seymour10:{parameters:{diffuse:"textures/boy_10.png"},effect:"lambert"},seymour20:{parameters:{diffuse:"textures/boy_20.png"},effect:"lambert"},seymour30:{parameters:{diffuse:"textures/boy_30.png"},effect:"lambert"},seymour40:{parameters:{diffuse:"textures/boy_40.png"},effect:"lambert"},seymour50:{parameters:{diffuse:"textures/boy_50.png"},effect:"lambert"}},O=function(t,n,r){var i=n.renderables;if(i){var s=t.getMaterial(r),o=i.length;for(var u=0;u<o;u+=1)i[u].setMaterial(s)}var a=n.children;if(a){var f=a.length;for(var l=0;l<f;l+=1){var c=a[l];O(t,c,r)}}},M=["models/Seymour_anim2_rot90_anim_only.dae"],_=["default_astroboy_w_skel02_gog_polySurface5","default_astroboy_w_skel02_polySurface5","default_astroboy_w_skel02c_gog_polySurface5","default_astroboy_w_skel02c_polySurface5","default_gog_polySurface5","default_polySurface5"],D,P=function(t){var n=M.length-D;p.loadData(t,"AnimExtra"+n+"-"),D-=1},H=function(){D=M.length;for(var t=0;t<M.length;t+=1){var n=M[t];d.load(g.getURL(n),{append:!0,onload:P,requestHandler:f})}},B=function(t){var n=t.animations,r;if(n)for(var i=0;i<_.length;i+=1)r=_[i],n[r]&&delete n[r]},j=function(n){var r=Math.ceil,i=k.gridSpace*r(Math.sqrt(k.count));E=u.v3BuildZero(),S=u.v3Build(i,k.height,i);var s=u.v3ScalarMul(u.v3Add(S,E),.5),o=u.v3Sub(s,E);n.lookAt(s,b,u.v3Build(s[0]+o[0]*x*T[0],s[1]+o[1]*x*T[1]*4,s[2]+o[2]*x*T[2])),n.updateViewMatrix();var a=t.v3Length(o);a<4?n.nearPlane=a*.1:n.nearPlane=1,n.farPlane=r(a)*100,n.updateProjectionMatrix()},F=dn.create(),I="slider1";F.addSliderControl({id:I,value:k.count,max:k.max,min:k.min,step:1,fn:function(){var e=this.value;k.count=e,F.updateSlider(I,e)}}),F.register();var q=function(){var t,n,r,i,s,o,a,f,l=p.nodeHasSkeleton,c=v.rootNodes,h=c.length,d=Math.random,m=Math.floor,g=Math.ceil,y=g(Math.sqrt(k.max)),w=k.gridSpace,E=k.startPos[0],S=k.startPos[2],x=k.varAngle,T=x/2,N=k.baseAngle,C=0,A=[],M=[];M.push("seymour10"),M.push("seymour20"),M.push("seymour30"),M.push("seymour40"),M.push("seymour50");var _=M.length,D,P,H,B,j,F,I=u.v3Build,q=u.m43FromAxisRotation,R=u.m43SetPos;for(t=0;t<h;t+=1){a=c[t];var U=l(a);if(U)for(n=0;n<y;n+=1)for(r=0;r<y;r+=1){if(n===0&&r===0){a.gridNum=1;continue}P=m(_*d())%_,H=M[P],typeof H=="string"?(j=a.name+"_"+H,B=v.cloneRootNode(a,j),O(v,B,H),M[P]=B):B=v.cloneRootNode(H,H.name+C),f=N+(T-x*d()),s=n*w+E,o=r*w+S,D=I.call(u,s,0,o),F=q.call(u,b,f*L),R.call(u,F,D),B.setLocalTransform(F),B.gridX=n,B.gridY=r,n>r?(i=n+1,i*=i,B.gridNum=i-2*n+r):(i=r+1,i*=i,B.gridNum=i-r+n),A.push(B),C+=1}}},R=function(t){var n,r,s,o,a,f=p.nodeHasSkeleton,l=t.rootNodes,c=p.getAll(),h=l.length,d=Math.random,v=Math.floor,m=[],g=0;for(n in c)c.hasOwnProperty(n)&&m.push(c[n]);g=m.length,t.skinnedNodes=[];var y=0;for(r=0;r<h;r+=1){a=l[r];var b=f(a);if(b){y=(v(d()*100)+y)%g;var w=m[y];s=Wt.create(w.hierarchy),s.setAnimation(w,N.loopAnimation),s.setTime(w.length*d()),s.setRate(N.defaultRate),o=en.create(i,u,a,b,s),o.active=!1,t.skinnedNodes.push(o)}}return!0},U=0,z=0,W=document.getElementById("fpscounter"),X="",V=function(){W.innerHTML=X+" fps"},$=function(){var t,n,r,o,u,a=k.count,f=!1,l=TurbulenzEngine.getTime(),c=(l-U)*.001;c>.1&&(c=.1);if(l>=z){z=l+.5,f=a!==k.lastCount,k.lastCount=a;if(W){var h=i.fps.toFixed(2);X!==h&&(X=h,TurbulenzEngine.setTimeout(V,1))}}f&&j(w);var p=i.width,d=i.height,m=p/d;m!==w.aspectRatio&&(w.aspectRatio=m,w.updateProjectionMatrix()),w.updateViewProjectionMatrix(),t=v.skinnedNodes,n=t.length;for(u=0;u<n;u+=1){r=t[u],o=r.node;if(f){var g=o.gridNum;g!==undefined?r.active=g<=a:r.active=!0}r.active?(o.getDisabled()&&o.enableHierarchy(!0),r.addTime(c),r.update(!0)):o.getDisabled()||o.enableHierarchy(!1)}v.update(),y.update(i,w,v,l),i.beginFrame()&&(y.updateBuffers(i,p,d)&&y.draw(i,s),i.endFrame()),U=l},J,K=function(){m.complete()&&D===0&&(TurbulenzEngine.clearInterval(J),q(),R(v),j(w),y.updateShader(c),F.updateSlider(I,undefined),J=TurbulenzEngine.setInterval($,1e3/60),U=TurbulenzEngine.getTime())};J=TurbulenzEngine.setInterval(K,100);var Q=function(){y=Ft.create(i,u,c,h),y.setGlobalLightPosition(u.v3Build(.5,100,.5)),y.setAmbientColor(u.v3Build(.3,.3,.4)),y.setDefaultTexture(l.get("default"));for(var t in A)if(A.hasOwnProperty(t)){var n=A[t];n.loaded||(n.loaded=v.hasMaterial(t)),n.loaded||(n.loaded=v.loadMaterial(i,l,h,t,n))}m.load({scene:v,assetPath:C,graphicsDevice:i,mathDevice:u,textureManager:l,effectManager:h,shaderManager:c,animationManager:p,requestHandler:f,preSceneLoadFn:function(e){H(),B(e)},keepLights:!0,append:!0,vertexFormatMap:{BLENDINDICES:"UBYTE4",NORMAL:"BYTE4N",BLENDWEIGHT:"UBYTE4N"}})},G=function(t){l.setPathRemapping(t.urlMapping,t.assetPrefix),c.setPathRemapping(t.urlMapping,t.assetPrefix),m.setPathRemapping(t.urlMapping,t.assetPrefix),Q()},Y=function(t){g=an.createMappingTable(f,t,G)},Z=an.createGameSession(f,Y);TurbulenzEngine.onunload=function(){TurbulenzEngine.clearInterval(J),Z&&(Z.destroy(),Z=null),g=null,v&&(v.destroy(),v=null),f=null,m=null,F=null,y&&(y.destroy(),y=null),M=null,_=null,A=null,N=null,k=null,w=null,T=null,E=[],S=[],s=[],b=[],l&&(l.destroy(),l=null),c&&(c.destroy(),c=null),h=null,W=null,TurbulenzEngine.flush(),i=null,u=null}},window.TurbulenzEngine=TurbulenzEngine})();