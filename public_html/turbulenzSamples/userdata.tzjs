(function(){function w(e,t,n){var r=e*65536+t%65536;return n&&(r+=1/(1+n)),r}function E(e){var t={far:e.sharedMaterial.meta.far};e.rendererInfo=t;var n=e.sharedMaterial.effect;return n.prepare&&n.prepare(e),t}var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(n,r){r===undefined&&(r=new e(9));var i=h*m-p*v,s=p*d-c*m,o=c*v-h*d,u=a*i+f*s+l*o;if(u===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var a=n[0],f=n[1],l=n[2],c=n[3],h=n[4],p=n[5],d=n[6],v=n[7],m=n[8],g=1/u;return r[0]=i*g,r[1]=(v*l-m*f)*g,r[2]=(f*p-l*h)*g,r[3]=s*g,r[4]=(m*a-d*l)*g,r[5]=(c*l-a*p)*g,r[6]=o*g,r[7]=(d*f-v*a)*g,r[8]=(a*h-c*f)*g,r},m33InverseTranspose:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=f*p-l*h,v=l*c-a*p,m=a*h-f*c,g=s*d+o*v+u*m;if(g===0)i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0;else{var y=1/g;i[0]=d*y,i[3]=(h*u-p*o)*y,i[6]=(o*l-u*f)*y,i[1]=v*y,i[4]=(p*s-c*u)*y,i[7]=(a*u-s*l)*y,i[2]=m*y,i[5]=(c*o-h*s)*y,i[8]=(s*f-a*o)*y}return i},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=a*h-f*c,g=f*l-u*h,y=u*c-a*l,b=i*m+s*g+o*y;if(b===0)return r;r===undefined&&(r=new e(12));var w=1/b;return r[0]=m*w,r[1]=(c*o-h*s)*w,r[2]=(s*f-o*a)*w,r[3]=g*w,r[4]=(h*i-l*o)*w,r[5]=(u*o-i*f)*w,r[6]=y*w,r[7]=(l*s-c*i)*w,r[8]=(i*a-u*s)*w,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*w,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*w,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*w,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a,s[1]=n[1]*o+n[4]*u+n[7]*a,s[2]=n[2]*o+n[5]*u+n[8]*a,s},m43TransformPoint:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a+n[9],s[1]=n[1]*o+n[4]*u+n[7]*a+n[10],s[2]=n[2]*o+n[5]*u+n[8]*a+n[11],s},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===
undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}t.arrayConstructor=e,TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r=function(){function e(e,t,n){return this.escapeNodeOffset=t,this.externalNode=n,this.extents=e,this}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s,o,u){this.escapeNodeOffset=o,this.externalNode=u;var a=this.extents;a[0]=e,a[1]=t,a[2]=n,a[3]=r,a[4]=i,a[5]=s},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=t,e[3]=-t,e[4]=-t,e[5]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),i=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e,this.ignoreY=!1,this.nodesStack=new Array(32)}return e.allocateNode=function(){var e=this.nodesPool;if(!e.length){var t=this.nodesPoolAllocationSize,n=this.useFloat32Array,i,s;n&&(i=new Float32Array(t*6),s=0);var o,u;for(o=0;o<t;o+=1)n?(u=i.subarray(s,s+6),s+=6):u=[0,0,0,0,0,0],e[o]=r.create(u,1,undefined)}return e.pop()},e.releaseNode=function(e){var t=this.nodesPool;t.length<this.nodesPoolAllocationSize&&(e.clear(),t.push(e))},e.recycleNodes=function(e,t){var n=e.length,r;for(r=t;r<n;r+=1){var i=e[r];i&&this.releaseNode(i)}e.length=t},e.prototype.add=function(t,n){var r=this.endNode;t.spatialIndex=r;var i=e.allocateNode();i.escapeNodeOffset=1,i.externalNode=t;var s=i.extents;s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],this.nodes[r]=i,this.endNode=r+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.spatialIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.spatialIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.spatialIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=this.needsRebuild,l=this.needsRebound,c=this.nodes,h=c[n],p=h.extents,d=f||l||p[0]>r||p[1]>i||p[2]>s||p[3]<o||p[4]<u||p[5]<a;p[0]=r,p[1]=i,p[2]=s,p[3]=o,p[4]=u,p[5]=a;if(d&&!f&&1<c.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!l)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var v=this.findParent(n),m=v.extents;if(m[0]>r||m[1]>i||m[2]>s||m[3]<o||m[4]<u||m[5]<a)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=this.nodesStack,i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3],g=h[4],y=h[5];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v>h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),g<h[4]&&(g=h[4]),y<h[5]&&(y=h[5]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,h[4]=g,h[5]=y,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var t=this.nodes,n,r,i,s;if(this.numExternalNodes===t.length)r=t,i=t.length,t=[],this.nodes=t;else{r=[],r.length=this.numExternalNodes,i=0,s=this.endNode;for(n=0;n<s;n+=1){var o=t[n];o.externalNode&&(t[n]=undefined,r[i]=o,i+=1)}r.length>i&&(r.length=i)}var u;if(i>1){i>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this._sortNodesHighQuality(r):this.ignoreY?this._sortNodesNoY(r):this._sortNodes(r));var a=this._predictNumNodes(0,i,0);t.length>a&&e.recycleNodes(t,a),this._recursiveBuild(r,0,i,0),s=t[0].escapeNodeOffset,t.length>s&&e.recycleNodes(t,s),this.endNode=s,u=t[0];var f=u.extents,l=f[3]-f[0],c=f[4]-f[1],h=f[5]-f[2];this.ignoreY=4*c<(l<=h?l:h)}else u=r[0],u.externalNode.spatialIndex=0,t.length=1,t[0]=u,this.endNode=1;r=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype._sortNodes=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return-(t[0]+t[3])}function u(e){var t=e.extents;return-(t[1]+t[4])}function a(e){var t=e.extents;return-(t[2]+t[5])}function h(e,n,p){var d=n+p>>1;c===0?l?f(e,n,d,p,o):f(e,n,d,p,r):c===2?l?f(e,n,d,p,a):f(e,n,d,p,s):l?f(e,n,d,p,u):f(e,n,d,p,i),c===0?c=2:c===2?c=1:c=0,l=!l,n+t<d&&h(e,n,d),d+t<p&&h(e,d,p)}var t=this.numNodesLeaf,n=e.length,f=this._nthElement,l=!1,c=0;h(e,0,n)},e.prototype._sortNodesNoY=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[2]+t[5]}function s(e){var t=e.extents;return-(t[0]+t[3])}function o(e){var t=e.extents;return-(t[2]+t[5])}function l(e,n,c){var h=n+c>>1;f===0?a?u(e,n,h,c,s):u(e,n,h,c,r):a?u(e,n,h,c,o):u(e,n,h,c,i),f===0?f=2:f=0,a=!a,n+t<h&&l(e,n,h),h+t<c&&l(e,h,c)}var t=this.numNodesLeaf,n=e.length,u=this._nthElement,a=!1,f=0;l(e,0,n)},e.prototype._sortNodesHighQuality=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return t[0]+t[2]+t[3]+t[5]}function u(e){var t=e.extents;return t[0]-t[2]+t[3]-t[5]}function a(e){var t=e.extents;return-(t[0]+t[3])}function f(e){var t=e.extents;return-(t[1]+t[4])}function l(e){var t=e.extents;return-(t[2]+t[5])}function c(e){var t=e.extents;return-(t[0]+t[2]+t[3]+t[5])}function h(e){var t=e.extents;return-(t[0]-t[2]+t[3]-t[5])}function m(e,n,g){var y=n+g>>1;p(e,n,y,g,r);var b=d(e,n,y)+d(e,y,g);p(e,n,y,g,i);var w=d(e,n,y)+d(e,y,g);p(e,n,y,g,s);var E=d(e,n,y)+d(e,y,g);p(e,n,y,g,o);var S=d(e,n,y)+d(e,y,g);p(e,n,y,g,u);var x=d(e,n,y)+d(e,y,g);b<=w&&b<=E&&b<=S&&b<=x?v?p(e,n,y,g,a):p(e,n,y,g,r):E<=w&&E<=S&&E<=x?v?p(e,n,y,g,l):p(e,n,y,g,s):w<=S&&w<=x?v?p(e,n,y,g,f):p(e,n,y,g,i):S<=x?v?p(e,n,y,g,c):p(e,n,y,g,o):v?p(e,n,y,g,h):p(e,n,y,g,u),v=!v,n+t<y&&m(e,n,y),y+t<g&&m(e,y,g)}var t=this.numNodesLeaf,n=e.length,p=this._nthElement,d=this._calculateSAH,v=!1;m(e,0,n)},e.prototype._calculateSAH=function(e,t,n){var r,i,s,o,u,a,f,l;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5];for(var c=t+1;c<n;c+=1)r=e[c],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u>i[2]&&(u=i[2]),a<i[3]&&(a=i[3]),f<i[4]&&(f=i[4]),l<i[5]&&(l=i[5]);return a-s+(f-o)+(l-u)},e.prototype._nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype._recursiveBuild=function(t,n,r,i){var s=this.nodes,o=i;i+=1;var u,a,f,l,c,h,p,d,v;if(n+this.numNodesLeaf>=r){d=t[n],p=d.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);for(var m=n+1;m<r;m+=1)d=t[m],p=d.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5]),i+=1,d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);v=s[i]}else{var g=n+r>>1;n+1>=g?(d=t[n],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,n,g,i),v=s[i],p=v.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],i+=v.escapeNodeOffset,g+1>=r?(d=t[g],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,g,r,i),v=s[i],p=v.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5])}var y=s[o];y===undefined&&(s[o]=y=e.allocateNode()),y.reset(u,a,f,l,c,h,i+v.escapeNodeOffset-o)},e.prototype._replaceNode=function(t,n,r){var i=t[n];t[n]=r,i!==undefined&&e.releaseNode(i)},e.prototype._predictNumNodes=function(e,t,n){n+=1;if(e+this.numNodesLeaf>=t)n+=t-e;else{var r=e+t>>1;e+1>=r?n+=1:n=this._predictNumNodes(e,r,n),r+1>=t?n+=1:n=this._predictNumNodes(r,t,n)}return n},e.prototype.getVisibleNodes=function(e,t,n){var r=0;if(this.numExternalNodes>0){var i=this.nodes,s=this.endNode,o=e.length,u=n===undefined?t.length:n,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=0;for(;;){a=i[T],f=a.extents,c=f[0],h=f[1],p=f[2],d=f[3],v=f[4],m=f[5],g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w<0?c:d)+E*(E<0?h:v)+S*(S<0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g)if(a.externalNode){t[u]=a.externalNode,u+=1,r+=1,T+=1;if(T>=s)break}else{g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w>0?c:d)+E*(E>0?h:v)+S*(S>0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g){l=T+a.escapeNodeOffset,T+=1;do a=i[T],a.externalNode&&(t[u]=a.externalNode,u+=1,r+=1),T+=1;while(T<l);if(T>=s)break}else T+=1}else{T+=a.escapeNodeOffset;if(T>=s)break}}}return r},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=this.nodes,l=this.endNode,c,h,p,d=0,v=n===undefined?t.length:n,m=0;for(;;){c=f[m],h=c.extents;var g=h[0],y=h[1],b=h[2],w=h[3],E=h[4],S=h[5];if(r<=w&&i<=E&&s<=S&&o>=g&&u>=y&&a>=b)if(c.externalNode){t[v]=c.externalNode,v+=1,d+=1,m+=1;if(m>=l)break}else if(o>=w&&u>=E&&a>=S&&r<=g&&i<=y&&s<=b){p=m+c.escapeNodeOffset,m+=1;do c=f[m],c.externalNode&&(t[v]=c.externalNode,v+=1,d+=1),m+=1;while(m<p);if(m>=l)break}else m+=1;else{m+=c.escapeNodeOffset;if(m>=l)break}}return d}return 0},e.prototype.getSphereOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=e[2],u=this.nodes,a=this.endNode,f,l,c=n.length,h=0;for(;;){f=u[h],l=f.extents;var p=l[0],d=l[1],v=l[2],m=l[3],g=l[4],y=l[5],b=0,w;i<p?(w=p-i,b+=w*w):i>m&&(w=i-m,b+=w*w),s<d?(w=d-s,b+=w*w):s>g&&(w=s-g,b+=w*w),o<v?(w=v-o,b+=w*w):o>y&&(w=o-y,b+=w*w);if(b<=r){h+=1;if(f.externalNode){n[c]=f.externalNode,c+=1;if(h>=a)break}}else{h+=f.escapeNodeOffset;if(h>=a)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3],m=u[4],g=u[5];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[3]&&p<=u[4]&&d<=u[5]&&v>=u[0]&&m>=u[1]&&g>=u[2]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getExtents=function(){return 0<this.nodes.length?this.nodes[0].extents:null},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes.length&&e.recycleNodes(this.nodes,0),this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.ignoreY=!1},e.rayTest=function(e,t,n){function d(e,t){var n=e[0],r=e[1],i=e[2],d=e[3],v=e[4],m=e[5];if(n<=s&&s<=d&&r<=o&&o<=v&&i<=u&&u<=m)return 0;var g,y,b,w,E;a>=0?(E=n-s,g=E===0?0:E*c,E=d-s,y=E===0?0:E*c):(g=(d-s)*c,y=(n-s)*c),f>=0?(E=r-o,b=E===0?0:E*h,E=v-o,w=E===0?0:E*h):(b=(v-o)*h,w=(r-o)*h);if(g>w||b>y)return undefined;b>g&&(g=b),w<y&&(y=w);var S,x;return l>=0?(E=i-u,S=E===0?0:E*p,E=m-u,x=E===0?0:E*p):(S=(m-u)*p,x=(i-u)*p),g>x||S>y?undefined:(S>g&&(g=S),x<y&&(y=x),g<0&&(g=y),0<=g&&g<t?g:undefined)}function g(e,r,i){var s=e.getNodes(),o=s[r],u=d(o.extents,i);if(u===undefined)return i;if(o.externalNode){var a=n(e,o.externalNode,t,u,i);a&&(m=a,i=a.factor)}else{var f=v.length,l;for(l=0;l<f;l+=1){var c=v[l];if(u>c.distance)break}v.splice(l-1,0,{tree:e,nodeIndex:r,distance:u})}return i}var r=t.origin,i=t.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=1/a,h=1/f,p=1/l,v=[],m=null,y=t.maxFactor,b,w;for(w=0;w<e.length;w+=1)b=e[w],b.endNode!==0&&(y=g(b,0,y));while(v.length!==0){var E=v.pop();if(E.distance>=y)continue;var S=E.nodeIndex;b=E.tree;var x=b.getNodes(),T=x[S],N=S+T.escapeNodeOffset,C=S+1;do y=g(b,C,y),C+=x[C].escapeNodeOffset;while(C<N)}return m},e.create=function(t){return new e(t?!0:!1)},e.version=1,e.useFloat32Array=!1,e.nodesPoolAllocationSize=128,e.nodesPool=[],e}();(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(i.useFloat32Array=!0)}})();var s=function(){function e(){this.viewOffsetX=0,this.viewOffsetY=0,this.recipViewWindowX=1,this.recipViewWindowY=1,this.infinite=!1,this.parallel=!1,this.aspectRatio=4/3,this.nearPlane=1,this.farPlane=1e3}return e.prototype.lookAt=function(e,t,n){var r=this.md,i=r.v3Normalize,s=r.v3Cross,o=r.v3Sub(n,e);i.call(r,o,o);var u=s.call(r,i.call(r,t,t),o);i.call(r,u,u);var a=s.call(r,o,u);this.matrix=r.m43Build(u,a,o,n,this.matrix)},e.prototype.updateProjectionMatrix=function(){var e=this.recipViewWindowX,t=this.recipViewWindowY*this.aspectRatio,n=e*this.viewOffsetX,r=t*this.viewOffsetY,i=this.farPlane,s=this.nearPlane,o;i!==s?o=1/(i-s):o=0;var u,a,f,l;this.parallel?(u=-2*o,f=-(i+s)*o,a=0,l=1):(this.infinite?u=-1:u=-(i+s)*o,f=-(2*i*s*o),a=-1,l=0),this.projectionMatrix=this.md.m44Build(e,0,0,0,0,t,0,0,-n,-r,u,a,0,0,f,l,this.projectionMatrix)},e.prototype.updateViewMatrix=function(){var e=this.md;this.viewMatrix=e.m43InverseOrthonormal(this.matrix,this.viewMatrix)},e.prototype.updateViewProjectionMatrix=function(){var e=this.md;this.viewProjectionMatrix=e.m43MulM44(this.viewMatrix,this.projectionMatrix,this.viewProjectionMatrix)},e.prototype.extractFrustumPlanes=function(e,t){var n=this.md,r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t||[],w=n.v4Build(o+r,l+u,d+c,-(y+v));return b[0]=n.planeNormalize(w,b[0]),n.v4Build(o-r,l-u,d-c,-(y-v),w),b[1]=n.planeNormalize(w,b[1]),n.v4Build(o-i,l-a,d-h,-(y-m),w),b[2]=n.planeNormalize(w,b[2]),n.v4Build(o+i,l+a,d+h,-(y+m),w),b[3]=n.planeNormalize(w,b[3]),n.v4Build(o+s,l+f,d+p,-(y+g),w),b[4]=n.planeNormalize(w,b[4]),n.v4Build(o-s,l-f,d-p,-(y-g),w),b[5]=n.planeNormalize(w,b[5]),b},e.prototype.updateFrustumPlanes=function(){this.frustumPlanes=this.extractFrustumPlanes(this.viewProjectionMatrix,this.frustumPlanes)},e.prototype.isVisiblePoint=function(e){var t=this.md;return t.isInsidePlanesPoint(e,this.frustumPlanes)},e.prototype.isVisibleSphere=function(e,t){var n=this.md;return n.isInsidePlanesSphere(e,t,this.frustumPlanes)},e.prototype.isVisibleBox=function(e,t){var n=this.md;return n.isInsidePlanesBox(e,t,this.frustumPlanes)},e.prototype.isVisibleAABB=function(e){var t=this.md;return t.aabbIsInsidePlanes(e,this.frustumPlanes)},e.prototype.isFullyInsideAABB=function(e){var t=this.md;return t.aabbIsFullyInsidePlanes(e,this.frustumPlanes)},e.prototype.getFrustumPoints=function(e,t,n){var r=this.md,i=this.viewOffsetX,s=this.viewOffsetY,o=1/this.recipViewWindowX,u=1/(this.recipViewWindowY*this.aspectRatio),a=this.matrix,f=e||this.farPlane,l=t!==undefined?t:this.nearPlane,c=n||new Array(8);if(!this.parallel){var h=a[0]*i+a[3]*s,p=a[1]*i+a[4]*s,d=a[2]*i+a[5]*s,v=a[0]*o,m=a[1]*o,g=a[2]*o,y=a[3]*u,b=a[4]*u,w=a[5]*u,E=h-a[6],S=p-a[7],x=d-a[8],T=a[9]+h,N=a[10]+p,C=a[11]+d,k=E+v+y,L=S+m+b,A=x+g+w,O=E-v+y,M=S-m+b,_=x-g+w,D=E-v-y,P=S-m-b,H=x-g-w,B=E+v-y,j=S+m-b,F=x+g-w;c[0]=r.v3Build(T+k*l,N+L*l,C+A*l,c[0]),c[1]=r.v3Build(T+O*l,N+M*l,C+_*l,c[1]),c[2]=r.v3Build(T+D*l,N+P*l,C+H*l,c[2]),c[3]=r.v3Build(T+B*l,N+j*l,C+F*l,c[3]),c[4]=r.v3Build(T+k*f,N+L*f,C+A*f,c[4]),c[5]=r.v3Build(T+O*f,N+M*f,C+_*f,c[5]),c[6]=r.v3Build(T+D*f,N+P*f,C+H*f,c[6]),c[7]=r.v3Build(T+B*f,N+j*f,C+F*f,c[7])}else{var I=(1-l)*i,q=(1-f)*i,R=(1-l)*s,U=(1-f)*s;c[0]=r.v3Build(o+I,u+R,l,c[0]),c[1]=r.v3Build(I-o,u+R,l,c[1]),c[2]=r.v3Build(I-o,R-u,l,c[2]),c[3]=r.v3Build(o+I,R-u,l,c[3]),c[4]=r.v3Build(o+q,u+U,f,c[4]),c[5]=r.v3Build(q-o,u+U,f,c[5]),c[6]=r.v3Build(q-o,U-u,f,c[6]),c[7]=r.v3Build(o+q,U-u,f,c[7]),r.m43TransformPoint(a,c[0],c[0]),r.m43TransformPoint(a,c[1],c[1]),r.m43TransformPoint(a,c[2],c[2]),r.m43TransformPoint(a,c[3],c[3]),r.m43TransformPoint(a,c[4],c[4]),r.m43TransformPoint(a,c[5],c[5]),r.m43TransformPoint(a,c[6],c[6]),r.m43TransformPoint(a,c[7],c[7])}return c},e.prototype.getFrustumFarPoints=function(e,t){var n=this.md,r=this.viewOffsetX,i=this.viewOffsetY,s=1/this.recipViewWindowX,o=1/(this.recipViewWindowY*this.aspectRatio),u=this.matrix,a=e||this.farPlane,f=t||new Array(4);if(!this.parallel){var l=u[0],c=u[1],h=u[2],p=u[3],d=u[4],v=u[5],m=u[6],g=u[7],y=u[8],b=u[9],w=u[10],E=u[11],S=l*r+p*i,x=c*r+d*i,T=h*r+v*i,N=l*s,C=c*s,k=h*s,L=p*o,A=d*o,O=v*o,M=S-m,_=x-g,D=T-y,P=b+S,H=w+x,B=E+T,j=(M+N+L)*a,F=(_+C+A)*a,I=(D+k+O)*a,q=(M-N+L)*a,R=(_-C+A)*a,U=(D-k+O)*a,z=(M-N-L)*a,W=(_-C-A)*a,X=(D-k-O)*a,V=(M+N-L)*a,$=(_+C-A)*a,J=(D+k-O)*a;f[0]=n.v3Build(P+j,H+F,B+I,f[0]),f[1]=n.v3Build(P+q,H+R,B+U,f[1]),f[2]=n.v3Build(P+z,H+W,B+X,f[2]),f[3]=n.v3Build(P+V,H+$,B+J,f[3])}else{var K=(1-a)*r,Q=(1-a)*i;f[0]=n.v3Build(s+K,o+Q,a,f[0]),f[1]=n.v3Build(K-s,o+Q,a,f[1]),f[2]=n.v3Build(K-s,Q-o,a,f[2]),f[3]=n.v3Build(s+K,Q-o,a,f[3]),n.m43TransformPoint(u,f[0],f[0]),n.m43TransformPoint(u,f[1],f[1]),n.m43TransformPoint(u,f[2],f[2]),n.m43TransformPoint(u,f[3],f[3])}return f},e.prototype.getFrustumExtents=function(e,t,n){var r=this.getFrustumPoints(t,n),i=r[0],s=i[0],o=i[1],u=i[2],a=s,f=o,l=u;for(var c=1;c<8;c+=1){i=r[c];var h=i[0],p=i[1],d=i[2];s>h?s=h:a<h&&(a=h),o>p?o=p:f<p&&(f=p),u>d?u=d:l<d&&(l=d)}e[0]=s,e[1]=o,e[2]=u,e[3]=a,e[4]=f,e[5]=l},e.create=function(t){var n=new e;return n.md=t,n.matrix=t.m43BuildIdentity(),n.viewMatrix=t.m43BuildIdentity(),n.updateProjectionMatrix(),n.viewProjectionMatrix=n.projectionMatrix.slice(),n.frustumPlanes=[],n.updateFrustumPlanes(),n},e.version=1,e}(),o=function(){function e(){this.rotateSpeed=2,this.maxSpeed=1,this.mouseRotateFactor=.1}return e.prototype.rotate=function(e,t){var n=Math.PI/180,r=this.md,i=this.camera.matrix,s=r.m43Pos(i);r.m43SetPos(i,r.v3BuildZero());var o;if(t!==0){t*=this.rotateSpeed*n,t*=this.mouseRotateFactor;var u=r.v3Normalize(r.m43Right(i));r.m43SetRight(i,u),o=r.m43FromAxisRotation(u,t),i=r.m43Mul(i,o)}e!==0&&(e*=this.rotateSpeed*n,e*=this.mouseRotateFactor,o=r.m43FromAxisRotation(r.v3BuildYAxis(),e),i=r.m43Mul(i,o)),r.m43SetPos(i,s),this.camera.matrix=i},e.prototype.translate=function(e,t,n){var r=this.md,i=this.camera.matrix,s=r.m43Pos(i),o=this.maxSpeed;s=r.v3Add4(s,r.v3ScalarMul(r.m43Right(i),o*e),r.v3ScalarMul(r.m43Up(i),o*t),r.v3ScalarMul(r.m43At(i),-(o*n))),r.m43SetPos(i,s)},e.prototype.update=function(){var e=!1;if(this.turn!==0||this.pitch!==0)e=!0,this.rotate(this.turn,this.pitch),this.turn=0,this.pitch=0;this.step>0?this.forward+=this.step:this.step<0&&(this.backward-=this.step);var t=this.right+this.padright-(this.left+this.padleft),n=this.up-this.down,r=this.forward+this.padforward-(this.backward+this.padbackward);if(t!==0||n!==0||r!==0)e=!0,this.translate(t,n,r),this.step>0?(this.forward-=this.step,this.step=0):this.step<0&&(this.backward+=this.step,this.step=0);e&&this.camera.updateViewMatrix()},e.create=function(t,n,r,i){var s=new e;s.md=r.md,s.camera=r,s.turn=0,s.pitch=0,s.right=0,s.left=0,s.up=0,s.down=0,s.forward=0,s.backward=0,s.step=0,s.padright=0,s.padleft=0,s.padforward=0,s.padbackward=0,s.looktouch={id:-1,originX:0,originY:0},s.movetouch={id:-1,originX:0,originY:0};var o;n&&(o=n.keyCodes);var u=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=1;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=1;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=1;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=1;break;case o.E:case o.NUMPAD_9:s.up=1;break;case o.Q:case o.NUMPAD_7:s.down=1}},a=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=0;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=0;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=0;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=0;break;case o.E:case o.NUMPAD_9:s.up=0;break;case o.Q:case o.NUMPAD_7:s.down=0;break;case o.RETURN:t.fullscreen=!t.fullscreen}};return i?(s.onkeydown=function(t){i.innerHTML+=" KeyDown:&nbsp;"+t,u(t)},s.onkeyup=function(t){t===o.BACKSPACE?i.innerHTML="":i.innerHTML+=" KeyUp:&nbsp;"+t,a(t)}):(s.onkeydown=u,s.onkeyup=a),s.onmouseup=function(){n.isLocked()||n.lockMouse()},s.onmousewheel=function(t){s.step=t*5},s.onmousemove=function(t,n){s.turn+=t,s.pitch+=n},s.onpadmove=function(t,n,r,i,o){s.turn+=t*10,s.pitch+=n*10,i>=0?(s.padright=i,s.padleft=0):(s.padright=0,s.padleft=-i),o>=0?(s.padforward=o,s.padbackward=0):(s.padforward=0,s.padbackward=-o)},s.onmouselocklost=function(){n.unlockMouse()},s.ontouchstart=function(n){var r=n.changedTouches,i=r.length,o,u=t.width*.5;for(o=0;o<i;o+=1){var a=r[o].identifier,f=r[o].positionX,l=r[o].positionY;f<u&&s.looktouch.id===-1?(s.looktouch.id=a,s.looktouch.originX=f,s.looktouch.originY=l):f>=u&&s.movetouch.id===-1&&(s.movetouch.id=a,s.movetouch.originX=f,s.movetouch.originY=l)}},s.ontouchend=function(t){var n=t.changedTouches,r=n.length,i;for(i=0;i<r;i+=1){var o=n[i].identifier;s.looktouch.id===o?(s.looktouch.id=-1,s.looktouch.originX=0,s.looktouch.originY=0,s.turn=0,s.pitch=0):s.movetouch.id===o&&(s.movetouch.id=-1,s.movetouch.originX=0,s.movetouch.originY=0,s.left=0,s.right=0,s.forward=0,s.backward=0)}},s.ontouchmove=function(t){var n=
t.changedTouches,r=n.length,i=16,o;for(o=0;o<r;o+=1){var u=n[o].identifier,a=n[o].positionX,f=n[o].positionY;s.looktouch.id===u?(a-s.looktouch.originX>i||a-s.looktouch.originX<-i?s.turn=(a-s.looktouch.originX)/i:s.turn=0,f-s.looktouch.originY>i||f-s.looktouch.originY<-i?s.pitch=(f-s.looktouch.originY)/16:s.pitch=0):s.movetouch.id===u&&(a-s.movetouch.originX>i?(s.left=0,s.right=1):a-s.movetouch.originX<-i?(s.left=1,s.right=0):(s.left=0,s.right=0),f-s.movetouch.originY>i?(s.forward=0,s.backward=1):f-s.movetouch.originY<-i?(s.forward=1,s.backward=0):(s.forward=0,s.backward=0))}},s.attach=function(t){t.addEventListener("keydown",s.onkeydown),t.addEventListener("keyup",s.onkeyup),t.addEventListener("mouseup",s.onmouseup),t.addEventListener("mousewheel",s.onmousewheel),t.addEventListener("mousemove",s.onmousemove),t.addEventListener("padmove",s.onpadmove),t.addEventListener("mouselocklost",s.onmouselocklost),t.addEventListener("touchstart",s.ontouchstart),t.addEventListener("touchend",s.ontouchend),t.addEventListener("touchmove",s.ontouchmove)},n&&s.attach(n),s},e.version=1,e}(),u=function(){function e(){return this.semantics=null,this.vertexBuffer=null,this.vertexOffset=0,this.reference=L.create(this),this.surfaces={},this.type="rigid",this}return e.prototype.destroy=function(){this.vertexBufferAllocation&&(this.vertexBufferManager.free(this.vertexBufferAllocation),delete this.vertexBufferManager,delete this.vertexBufferAllocation),this.indexBufferAllocation&&(this.indexBufferManager.free(this.indexBufferAllocation),delete this.indexBufferManager,delete this.indexBufferAllocation),delete this.vertexBuffer,delete this.indexBuffer,delete this.vertexData,delete this.indexData,delete this.semantics,delete this.first,delete this.halfExtents,delete this.reference,delete this.surfaces},e.create=function(){return new e},e.version=1,e}(),a=function(){function e(){}return e.prototype.clone=function(){var t=e.create(this.geometry,this.surface,this.sharedMaterial);return this.disabled&&(t.disabled=!0),t},e.prototype.isSkinned=function(){return this.geometry.skeleton?!0:!1},e.prototype.setNode=function(e){this.node&&this.hasCustomWorldExtents()&&this.node.renderableWorldExtentsRemoved(),this.node=e,this.node&&this.hasCustomWorldExtents()&&this.node.renderableWorldExtentsUpdated(!1),this.worldExtentsUpdate=-1},e.prototype.getNode=function(){return this.node},e.prototype.setMaterial=function(e){e.reference.add(),this.sharedMaterial.reference.remove(),this.sharedMaterial=e,this.renderUpdate=undefined,this.rendererInfo=undefined},e.prototype.getMaterial=function(){return this.sharedMaterial},e.prototype.getWorldExtents=function(){var e=this.node;return e.worldUpdate>this.worldExtentsUpdate&&(this.worldExtentsUpdate=e.worldUpdate,this.updateWorldExtents(e.world)),this.worldExtents},e.prototype.updateWorldExtents=function(e){var t=this.center,n=this.halfExtents,r=this.worldExtents,i=e[0],s=e[1],o=e[2],u=e[3],a=e[4],f=e[5],l=e[6],c=e[7],h=e[8],p=e[9],d=e[10],v=e[11];if(t){var m=t[0],g=t[1],y=t[2];p+=i*m+u*g+l*y,d+=s*m+a*g+c*y,v+=o*m+f*g+h*y}var b=n[0],w=n[1],E=n[2],S=(i<0?-i:i)*b+(u<0?-u:u)*w+(l<0?-l:l)*E,x=(s<0?-s:s)*b+(a<0?-a:a)*w+(c<0?-c:c)*E,T=(o<0?-o:o)*b+(f<0?-f:f)*w+(h<0?-h:h)*E;r[0]=p-S,r[1]=d-x,r[2]=v-T,r[3]=p+S,r[4]=d+x,r[5]=v+T},e.prototype.addCustomWorldExtents=function(t){var n=this.worldExtentsUpdate===e.maxUpdateValue,r=this.worldExtents;if(!n||t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||t[4]!==r[4]||t[5]!==r[5])this.worldExtentsUpdate=e.maxUpdateValue,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],this.node.renderableWorldExtentsUpdated(n)},e.prototype.removeCustomWorldExtents=function(){this.worldExtentsUpdate=-1,this.node.renderableWorldExtentsRemoved()},e.prototype.getCustomWorldExtents=function(){return this.worldExtentsUpdate===e.maxUpdateValue?this.worldExtents:undefined},e.prototype.hasCustomWorldExtents=function(){return this.worldExtentsUpdate===e.maxUpdateValue},e.prototype.destroy=function(){this.geometry.reference&&this.geometry.reference.remove(),this.sharedMaterial.reference&&this.sharedMaterial.reference.remove(),delete this.surface,delete this.geometry,delete this.sharedMaterial,delete this.techniqueParameters,delete this.halfExtents,delete this.center,delete this.worldExtentsUpdate,delete this.drawParameters,delete this.renderUpdate,delete this.rendererInfo},e.prototype.prepareDrawParameters=function(e){var t=this.surface,n=this.geometry;e.setVertexBuffer(0,n.vertexBuffer),e.setSemantics(0,this.semantics),e.setOffset(0,n.vertexOffset),e.primitive=t.primitive,e.firstIndex=t.first,t.indexBuffer?(e.indexBuffer=t.indexBuffer,e.count=t.numIndices):e.count=t.numVertices},e.create=function(t,n,r){var i=new e,s=TurbulenzEngine.getGraphicsDevice();return i.geometry=t,i.geometry.reference.add(),i.geometryType=t.type,i.surface=n,i.semantics=t.semantics,i.halfExtents=t.halfExtents,i.center=t.center,i.techniqueParameters=s?s.createTechniqueParameters():null,i.sharedMaterial=r,i.sharedMaterial&&i.sharedMaterial.reference.add(),i.worldExtents=new i.arrayConstructor(6),i.worldExtentsUpdate=-1,i.node=undefined,i.renderUpdate=undefined,i.rendererInfo=undefined,i},e.version=1,e.maxUpdateValue=Number.MAX_VALUE,e}();(function(){a.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(a.prototype.arrayConstructor=Float32Array)}})();var f=function(){function e(){}return e.create=function(t){var n=new e;return n.reference=L.create(n),n.techniqueParameters=t.createTechniqueParameters(),n.meta={},n.onTextureChanged=function(t){var r=t.texture,i=n,s=i.techniqueParameters,o=i.textureInstances;for(var u in o)o.hasOwnProperty(u)&&o[u]===t&&(s[u]=r)},n},e.prototype.getName=function(){return this.name},e.prototype.setName=function(e){this.name=e},e.prototype.clone=function(t){var n=e.create(t);this.effect&&(n.effect=this.effect),this.effectName&&(n.effectName=this.effectName);var r=this.meta,i=n.meta,s;for(s in r)r.hasOwnProperty(s)&&(i[s]=r[s]);var o=this.techniqueParameters,u=n.techniqueParameters;for(s in o)o.hasOwnProperty(s)&&(u[s]=o[s]);var a=this.texturesNames;if(a){var f=n.texturesNames;f||(n.texturesNames=f={});for(s in a)a.hasOwnProperty(s)&&(f[s]=a[s])}var l=this.textureInstances;if(l){var c=n.textureInstances;c||(n.textureInstances=c={});for(s in l)if(l.hasOwnProperty(s)){var h=l[s];c[s]=h,h.subscribeTextureChanged(n.onTextureChanged),h.reference.add()}}return n},e.prototype.loadTextures=function(e){var t=this.texturesNames;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];e.load(r),this.setTextureInstance(n,e.getInstance(r))}},e.prototype.setTextureInstance=function(e,t){this.textureInstances||(this.textureInstances={});var n=this.textureInstances[e];n!==t&&(n&&n.unsubscribeTextureChanged&&n.unsubscribeTextureChanged(this.onTextureChanged),this.textureInstances[e]=t,this.techniqueParameters[e]=t.texture,t.subscribeTextureChanged(this.onTextureChanged),t.reference.add())},e.prototype.isSimilar=function(e){function t(e,t){var n;for(n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n])return!1}for(n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function n(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}if(this.effect!==e.effect)return!1;if(this.effectName!==e.effectName)return!1;if(this.meta.materialIndex!==e.meta.materialIndex){var r=this.texturesNames,i=e.texturesNames;if(r||i){if(!r||!i)return!1;if(!t(r,i))return!1}}var s=this.techniqueParameters,o=e.techniqueParameters,u,a,f;for(u in s)if(s.hasOwnProperty(u)){if(!o.hasOwnProperty(u))return!1;a=s[u],f=o[u];if(a!==f){if(!(a&&typeof a!="number"&&f&&typeof f!="number"&&a.length===f.length&&a.length))return!1;if(!n(a,f))return!1}}for(u in o)if(o.hasOwnProperty(u)&&!s.hasOwnProperty(u))return!1;return!0},e.prototype.destroy=function(){delete this.techniqueParameters;var e,t=this.textureInstances;for(var n in t)t.hasOwnProperty(n)&&(e=t[n],e.unsubscribeTextureChanged(this.onTextureChanged),e.reference.remove());delete this.textureInstances,delete this.texturesNames},e.version=1,e}(),l=function(){function e(){}return e.prototype.clone=function(){var t=new e;return t.name=this.name,t.spot=this.spot,t.ambient=this.ambient,t.point=this.point,t.fog=this.fog,t.global=this.global,t.directional=this.directional,t.color=this.color&&this.color.slice(),t.direction=this.direction&&this.direction.slice(),t.origin=this.origin&&this.origin.slice(),t.frustum=this.frustum&&this.frustum.slice(),t.frustumNear=this.frustumNear,t.center=this.center&&this.center.slice(),t.halfExtents=this.halfExtents&&this.halfExtents.slice(),t.radius=this.radius,t.shadows=this.shadows,t.dynamicshadows=this.dynamicshadows,t.disabled=this.disabled,t.dynamic=this.dynamic,t.techniqueParameters=this.techniqueParameters,t},e.prototype.isGlobal=function(){return this.global},e.create=function(n){var r=new e,i=TurbulenzEngine.getMathDevice(),s=Math.abs,o=Math.max;n.name&&(r.name=n.name),r.color=n.color&&n.color.length?n.color:i.v3BuildOne(),n.directional?r.directional=!0:n.spot?r.spot=!0:n.ambient?r.ambient=!0:r.point=!0,r.origin=n.origin;var u=n.target;if(u||r.spot){u||(u=i.v3Build(0,0,-(n.radius||1)));var a=(n.falloff_angle||90)/360*Math.PI,f=Math.abs(u[2])*Math.tan(a),l=n.right||i.v3Build(f,0,0),c=n.up||i.v3Build(0,f,0),h=n.end||u;r.frustum=i.m33Build(l,c,h);var p=s(l[0])+s(c[0]),d=s(l[1])+s(c[1]),v=s(l[2])+s(c[2]),m=h[0],g=h[1],y=h[2],b,w,E,S=n.start;S?(u=i.v3Normalize(u),r.frustumNear=i.v3Dot(u,S)/i.v3Dot(u,h),b=(m+S[0])*.5,w=(g+S[1])*.5,E=(y+S[2])*.5):(r.frustumNear=0,b=m*.5,w=g*.5,E=y*.5),r.center=i.v3Build(b,w,E),r.halfExtents=i.v3Build(o(s(m-p-b),s(m+p-b)),o(s(g-d-w),s(g+d-w)),o(s(y-v-E),s(y+v-E)))}else{var x=n.halfExtents;if(x)r.halfExtents=x.length&&x||i.v3BuildZero();else{var T=n.radius;T?(r.radius=T,r.halfExtents=i.v3ScalarBuild(T)):r.ambient||(r.halfExtents=i.v3ScalarBuild(t.FLOAT_MAX))}}r.direction=n.direction,!n.halfExtents&&!n.radius&&!n.target&&(r.global=!0),!r.global&&(n.shadows||n.dynamicshadows)&&(r.shadows=!0,n.dynamicshadows&&(r.dynamicshadows=!0)),n.disabled&&(r.disabled=!0),n.dynamic&&(r.dynamic=!0);var N=n.material;if(N){var C=N.techniqueParameters;r.techniqueParameters=C;var k=N.meta;if(k){var L=k.ambient;L&&(r.ambient=!0);var A=k.fog;A&&(r.fog=!0)}}return r},e.version=1,e}(),c=function(){function e(){}return e.prototype.setMaterial=function(e){this.light.sharedMaterial=e;var t=e.meta;if(e.meta){var n=t.ambient;n?this.light.ambient=!0:this.light.ambient&&delete this.light.ambient;var r=t.fog;r?this.light.fog=!0:this.light.fog&&delete this.light.fog}},e.prototype.setNode=function(e){this.node=e,this.worldExtentsUpdate=-1},e.prototype.getNode=function(){return this.node},e.prototype.getWorldExtents=function(){var e=this.node;return e.worldUpdate!==this.worldExtentsUpdate&&(this.worldExtentsUpdate=e.worldUpdate,this.updateWorldExtents(e.world)),this.worldExtents},e.prototype.updateWorldExtents=function(e){var t=this.worldExtents,n=this.light,r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11];if(n.spot){var v,m,g,y,b,w,E,S,x;v=h,m=p,g=d,y=h,b=p,w=d;var T=n.frustum,N=T[0],C=T[1],k=T[2],L=T[3],A=T[4],O=T[5],M=T[6],_=T[7],D=T[8];h+=r*M+o*_+f*D,p+=i*M+u*_+l*D,d+=s*M+a*_+c*D;var P=Math.abs,H=P(r*N+o*C+f*k)+P(r*L+o*A+f*O),B=P(i*N+u*C+l*k)+P(i*L+u*A+l*O),j=P(s*N+a*C+c*k)+P(s*L+a*A+c*O);E=h-H,S=p-B,x=d-j,v>E&&(v=E),m>S&&(m=S),g>x&&(g=x),E=h+H,S=p+B,x=d+j,y<E&&(y=E),b<S&&(b=S),w<x&&(w=x),t[0]=v,t[1]=m,t[2]=g,t[3]=y,t[4]=b,t[5]=w}else{var F=n.center,I=n.halfExtents;if(F){var q=F[0],R=F[1],U=F[2];h+=r*q+o*R+f*U,p+=i*q+u*R+l*U,d+=s*q+a*R+c*U}var z=I[0],W=I[1],X=I[2],V=(r<0?-r:r)*z+(o<0?-o:o)*W+(f<0?-f:f)*X,$=(i<0?-i:i)*z+(u<0?-u:u)*W+(l<0?-l:l)*X,J=(s<0?-s:s)*z+(a<0?-a:a)*W+(c<0?-c:c)*X;t[0]=h-V,t[1]=p-$,t[2]=d-J,t[3]=h+V,t[4]=p+$,t[5]=d+J}},e.prototype.clone=function(){var t=e.create(this.light);return t},e.create=function(t){var n=new e;return n.node=undefined,n.light=t,n.worldExtents=new n.arrayConstructor(6),n.worldExtentsUpdate=-1,n},e.version=1,e}();(function(){c.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(c.prototype.arrayConstructor=Float32Array)}})();var h=function(){function e(t){this.name=t.name;var n=this.mathDevice;n||(n=TurbulenzEngine.getMathDevice(),e.prototype.mathDevice=n),this.dynamic=t.dynamic||!1,this.disabled=t.disabled||!1,this.dirtyWorld=!1,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.worldUpdate=0,this.frameVisible=-1;var r=t.local;if(r)if(this.arrayConstructor!==Array){var i=new Float32Array(24);this.local=n.m43Copy(r,i.subarray(0,12)),this.world=n.m43Copy(this.local,i.subarray(12,24))}else this.local=n.m43Copy(r),this.world=n.m43Copy(this.local);else this.local=undefined,this.world=n.m43BuildIdentity();this.parent=undefined,this.notifiedParent=!1}return e.makePath=function(e,t){return e+"/"+t},e.invalidSetLocalTransform=function(){},e.prototype.getName=function(){return this.name},e.prototype.getPath=function(){return this.parent?e.makePath(this.parent.getPath(),this.name):this.name},e.prototype.getParent=function(){return this.parent},e.prototype.setParentHelper=function(e){this.parent=e,this.notifiedParent=!1,this.dirtyWorld=!1,this._setDirtyWorldTransform()},e.prototype.addChild=function(e){e.parent?e.parent.removeChild(e):e.scene&&e.scene.removeRootNode(e),this.children||(this.children=[],this.childNeedsUpdateCount=0),this.children.push(e),e.setParentHelper(this),this.dynamic&&!e.dynamic&&e.setDynamic()},e.prototype.removeChild=function(e){var t=this.children;if(t){e.notifiedParent&&this.childUpdated();var n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){var i=this.getRoot();i.scene&&e.removedFromScene(i.scene),t.splice(r,1),e.setParentHelper(null);return}}},e.prototype.findChild=function(e){var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)if(t[r].name===e)return t[r]}return undefined},e.prototype.clone=function(t){var n=e.create({name:t||this.name,local:this.local,dynamic:this.dynamic,disabled:this.disabled}),r=this.renderables;if(r){var i=r.length;for(var s=0;s<i;s+=1){var o=r[s];n.addRenderable(o.clone())}}var u=this.lightInstances;if(u){var a=u.length;for(var f=0;f<a;f+=1){var l=u[f];n.addLightInstance(l.clone())}}this.clonedObserver&&this.clonedObserver.notify({oldNode:this,newNode:n});var c=this.children;if(c){var h=c.length;for(var p=0;p<h;p+=1)n.addChild(c[p].clone())}return n},e.prototype.getRoot=function(){var e=this;while(e.parent)e=e.parent;return e},e.prototype.isInScene=function(){return this.getRoot().scene?!0:!1},e.prototype.removedFromScene=function(e){this.spatialIndex!==undefined&&(this.dynamic?e.dynamicSpatialMap.remove(this):(e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1));var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].removedFromScene(e)}},e.prototype.setLocalTransform=function(e){e!==this.local&&(this.local=this.mathDevice.m43Copy(e,this.local)),this.dirtyWorld||this._setDirtyWorldTransform()},e.prototype.getLocalTransform=function(){return this.local||(this.local=this.mathDevice.m43BuildIdentity()),this.local},e.prototype._setDirtyWorldTransform=function(){var t=this.parent;if(t)this.notifiedParent||(this.notifiedParent=!0,t.childNeedsUpdate());else{var n=this.scene;n&&n.addRootNodeToUpdate(this,this.name)}var r=e._tempDirtyNodes;r[0]=this;var i=1,s,o,u;do{i-=1,s=r[i],s.dirtyWorld=!0,!s.customWorldExtents&&s.localExtents&&(s.dirtyWorldExtents=!0);var a=s.children;if(a){var f=a.length;if(!s.childNeedsUpdateCount){s.childNeedsUpdateCount=f;for(o=0;o<f;o+=1)u=a[o],u.notifiedParent=!0,r[i]=u,i+=1}else for(o=0;o<f;o+=1)u=a[o],u.dirtyWorld||(u.notifiedParent||(u.notifiedParent=!0,s.childNeedsUpdateCount+=1),r[i]=u,i+=1)}}while(0<i)},e.prototype.getWorldTransform=function(){return this.dirtyWorld&&this.updateWorldTransform(),this.world},e.prototype.updateWorldTransform=function(){if(this.dirtyWorld){this.dirtyWorld=!1,this.worldUpdate+=1,this.checkUpdateRequired();var e=this.parent,t=this.local;if(e){var n=e.getWorldTransform();t?this.world=this.mathDevice.m43Mul(t,n,this.world):this.world=this.mathDevice.m43Copy(n,this.world)}else this.world=this.mathDevice.m43Copy(t,this.world)}},e.prototype.setDynamic=function(){if(!this.dynamic){if(this.spatialIndex!==undefined){var e=this.getRoot().scene;e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1,delete this.spatialIndex}delete this.setLocalTransform;var t=this.getWorldExtents();t&&this.getRoot().scene.dynamicSpatialMap.update(this,t),this.dynamic=!0}var n=this.children;if(n){var r=n.length;for(var i=0;i<r;i+=1)n[i].setDynamic()}},e.prototype.setStatic=function(){if(this.dynamic){this.spatialIndex!==undefined&&(this.getRoot().scene.dynamicSpatialMap.remove(this),delete this.spatialIndex),this.setLocalTransform=e.invalidSetLocalTransform;var t=this.getWorldExtents();if(t){var n=this.getRoot().scene;n&&(n.staticSpatialMap.update(this,t),n.staticNodesChangeCounter+=1)}delete this.dirtyWorldExtents,delete this.worldExtentsUpdate,delete this.dirtyWorld,delete this.notifiedParent,delete this.dynamic}var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s].setStatic()}},e.prototype.setDisabled=function(e){e?this.disabled=!0:this.disabled=!1},e.prototype.getDisabled=function(){return this.disabled},e.prototype.enableHierarchy=function(e){this.setDisabled(!e);var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].enableHierarchy(e)}},e.prototype.childUpdated=function(){this.childNeedsUpdateCount-=1,this.childNeedsUpdateCount===0&&this.dirtyWorld===!1&&this.dirtyWorldExtents===!1&&this.parent&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.childNeedsUpdate=function(){this.updateRequired(),this.childNeedsUpdateCount+=1},e.prototype.updateRequired=function(){var e=this.parent;if(e)this.notifiedParent||(this.notifiedParent=!0,e.childNeedsUpdate());else{var t=this.scene;t&&t.addRootNodeToUpdate(this,this.name)}},e.prototype.checkUpdateRequired=function(){this.notifiedParent&&!this.dirtyWorldExtents&&!this.dirtyWorld&&!this.childNeedsUpdateCount&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.update=function(t){var n=e._tempDirtyNodes;n[0]=this,e.updateNodes(this.mathDevice,t||this.scene,n,1)},e.updateNodes=function(t,n,r,i){var s=n.dynamicSpatialMap,o,u,a,f;do{i-=1,o=r[i];if(o.dirtyWorld){o.dirtyWorld=!1,o.worldUpdate+=1,u=o.parent;if(u){var l=o.local;l?o.world=t.m43Mul(l,u.world,o.world):o.world=t.m43Copy(u.world,o.world)}else o.world=t.m43Copy(o.local,o.world)}o.dirtyWorldExtents&&(o.customWorldExtents?o.worldExtents=o.customWorldExtents:(o.dirtyLocalExtents&&o.updateLocalExtents(),o.numCustomRenderableWorldExtents?o.updateCustomRenderableWorldExtents():o.localExtents?o.recalculateWorldExtents():delete o.worldExtents),o.dirtyWorldExtents=!1,o.worldExtentsUpdate=!0),o.worldExtentsUpdate&&(o.worldExtentsUpdate=!1,f=o.worldExtents,f?o.dynamic?s.update(o,f):(n.staticSpatialMap.update(o,f),n.staticNodesChangeCounter+=1,o.setLocalTransform=e.invalidSetLocalTransform,delete o.dirtyWorldExtents,delete o.worldExtentsUpdate,delete o.dirtyWorld,delete o.notifiedParent):o.spatialIndex!==undefined&&(o.dynamic?s.remove(o):(n.staticSpatialMap.remove(o),n.staticNodesChangeCounter+=1)));if(o.childNeedsUpdateCount){o.childNeedsUpdateCount=0;var c=o.children;if(c){var h=c.length;for(a=0;a<h;a+=1){var p=c[a];p.notifiedParent&&(r[i]=p,i+=1)}}}o.notifiedParent=!1}while(0<i)},e.prototype.updateLocalExtents=function(){var e,t,n,r=!1;if(this.customLocalExtents)this.localExtents=this.customLocalExtents,r=!0;else{var i=this.renderables,s=this.lightInstances,o=i?i.length:0,u=s?s.length:0;if(o||u){var a=Number.MAX_VALUE,f=-a,l=Math.min,c=Math.max,h,p,d,v,m,g,y,b=a,w=a,E=a,S=f,x=f,T=f;for(y=0;y<o;y+=1){var N=i[y];n=N.halfExtents,n&&!N.hasCustomWorldExtents()&&(h=n[0],p=n[1],d=n[2],t=N.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}for(y=0;y<u;y+=1){var C=s[y].light;n=C.halfExtents,n&&(h=n[0],p=n[1],d=n[2],t=C.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}if(this.arrayConstructor!==Array){var k=6;this.localHalfExtents||(k+=3),this.localExtentsCenter||(k+=3),this.worldExtents||(k+=6);var L=new Float32Array(k),A=0;this.localExtents=e=L.subarray(A,A+6),A+=6,this.localHalfExtents||(this.localHalfExtents=L.subarray(A,A+3),A+=3),this.localExtentsCenter||(this.localExtentsCenter=L.subarray(A,A+3),A+=3),this.worldExtents||(this.worldExtents=L.subarray(A,A+6),A+=6)}else this.localExtents=e=new Array(6),this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6));e[0]=b,e[1]=w,e[2]=E,e[3]=S,e[4]=x,e[5]=T,r=!0}}r?(e=this.localExtents,t=this.localExtentsCenter||new this.arrayConstructor(3),t[0]=(e[3]+e[0])*.5,t[1]=(e[4]+e[1])*.5,t[2]=(e[5]+e[2])*.5,this.localExtentsCenter=t,n=this.localHalfExtents||new this.arrayConstructor(3),n[0]=e[3]-t[0],n[1]=e[4]-t[1],n[2]=e[5]-t[2],this.localHalfExtents=n):(delete this.localExtents,delete this.localExtentsCenter,delete this.localHalfExtents),this.dirtyLocalExtents=!1},e.prototype.getLocalExtents=function(){return this.dirtyLocalExtents&&this.updateLocalExtents(),this.localExtents},e.prototype.updateWorldExtents=function(){this.dirtyWorld&&this.updateWorldTransform(),this.dirtyWorldExtents&&(this.customWorldExtents?this.worldExtents=this.customWorldExtents:(this.dirtyLocalExtents&&this.updateLocalExtents(),this.numCustomRenderableWorldExtents?this.updateCustomRenderableWorldExtents():this.localExtents?this.recalculateWorldExtents():delete this.worldExtents),this.dirtyWorldExtents=!1,this.worldExtentsUpdate=!0,this.checkUpdateRequired())},e.prototype.updateCustomRenderableWorldExtents=function(){var e,t,n,r,i,s,o,u,a,f=this.renderables,l=f.length,c=!0;for(e=0;e<l;e+=1){t=f[e],n=t.getCustomWorldExtents();if(n){r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],e+=1,c=!1;break}}for(;e<l;e+=1)t=f[e],n=t.getCustomWorldExtents(),n&&(r>n[0]&&(r=n[0]),i>n[1]&&(i=n[1]),s>n[2]&&(s=n[2]),o<n[3]&&(o=n[3]),u<n[4]&&(u=n[4]),a<n[5]&&(a=n[5]));if(c)delete this.worldExtents;else{var h=this.worldExtents;h||(h=new this.arrayConstructor(6),this.worldExtents=h),h[0]=r,h[1]=i,h[2]=s,h[3]=o,h[4]=u,h[5]=a}},e.prototype.recalculateWorldExtents=function(){var e=this.localExtentsCenter,t=this.localHalfExtents,n=e[0],r=e[1],i=e[2],s=t[0],o=t[1],u=t[2],a=this.world,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=a[5],v=a[6],m=a[7],g=a[8],y=a[9],b=a[10],w=a[11];if(n!==0||r!==0||i!==0)y+=f*n+h*r+v*i,b+=l*n+p*r+m*i,w+=c*n+d*r+g*i;var E=(f<0?-f:f)*s+(h<0?-h:h)*o+(v<0?-v:v)*u,S=(l<0?-l:l)*s+(p<0?-p:p)*o+(m<0?-m:m)*u,x=(c<0?-c:c)*s+(d<0?-d:d)*o+(g<0?-g:g)*u,T=this.worldExtents;T||(T=new this.arrayConstructor(6),this.worldExtents=T),T[0]=y-E,T[1]=b-S,T[2]=w-x,T[3]=y+E,T[4]=b+S,T[5]=w+x},e.prototype.getWorldExtents=function(){return this.dirtyWorldExtents&&this.updateWorldExtents(),this.worldExtents},e.prototype.addCustomLocalExtents=function(e){var t=this.customLocalExtents;if(!t){this.localExtents=undefined;if(this.arrayConstructor!==Array){var n=0;this.localHalfExtents||(n+=3),this.localExtentsCenter||(n+=3),this.worldExtents||(n+=6),n+=6;var r=new Float32Array(n),i=0;this.localHalfExtents||(this.localHalfExtents=r.subarray(i,i+3),i+=3),this.localExtentsCenter||(this.localExtentsCenter=r.subarray(i,i+3),i+=3),this.worldExtents||(this.worldExtents=r.subarray(i,i+6),i+=6),this.customLocalExtents=t=r.subarray(i,i+6),i+=6}else this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6)),this.customLocalExtents=t=new Array(6);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0}else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0;this.dirtyLocalExtents&&(this.dirtyWorldExtents=!0,this.updateRequired())},e.prototype.removeCustomLocalExtents=function(){delete this.customLocalExtents,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.updateRequired()},e.prototype.getCustomLocalExtents=function(){return this.customLocalExtents},e.prototype.addCustomWorldExtents=function(e){var t=this.customWorldExtents;if(!t)this.customWorldExtents=t=new this.arrayConstructor(6),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;this.dirtyWorldExtents&&this.updateRequired()},e.prototype.removeCustomWorldExtents=function(){delete this.customWorldExtents,this.dirtyWorldExtents=!0,this.updateRequired()},e.prototype.getCustomWorldExtents=function(){return this.customWorldExtents},e.prototype.renderableWorldExtentsUpdated=function(e){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),e||(this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents=this.numCustomRenderableWorldExtents?this.numCustomRenderableWorldExtents+1:1)},e.prototype.renderableWorldExtentsRemoved=function(){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents-=1},e.prototype.calculateHierarchyWorldExtents=function(e){var t=Number.MAX_VALUE,n=e;return n||(n=new this.arrayConstructor(6)),n[0]=t,n[1]=t,n[2]=t,n[3]=-t,n[4]=-t,n[5]=-t,this._calculateNodeExtents(n)?n:undefined},e.prototype._calculateNodeExtents=function(e){var t=!1,n=this.getWorldExtents();n&&(e[0]=e[0]<n[0]?e[0]:n[0],e[1]=e[1]<n[1]?e[1]:n[1],e[2]=e[2]<n[2]?e[2]:n[2],e[3]=e[3]>n[3]?e[3]:n[3],e[4]=e[4]>n[4]?e[4]:n[4],e[5]=e[5]>n[5]?e[5]:n[5],t=!0);var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s]._calculateNodeExtents(e)&&(t=!0)}return t},e.prototype.addRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]),this.renderables.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addRenderableArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]);var t=this.renderables,n=e.length;for(var r=0;r<n;r+=1)t.push(e[r]),e[r].setNode(this);this.dirtyLocalExtents=!0},e.prototype.removeRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.renderables,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t[r].setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasRenderables=function(){return this.renderables&&this.renderables.length?!0:!1},e.prototype.addLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]),this.lightInstances.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addLightInstanceArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]);var t=this.lightInstances,n=e.length;for(var r=0;r<n;r+=1)e[r].setNode(this),t.push(e[r]);this.dirtyLocalExtents=!0},e.prototype.removeLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.lightInstances,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){e.setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasLightInstances=function(){return this.lightInstances&&this.lightInstances.length},e.prototype.destroy=function(){this.destroyedObserver&&this.destroyedObserver.notify({node:this});var t=this.children;if(t){var n=t.length;for(var r=n-1;r>=0;r-=1){var i=t[r];this.removeChild(i),i.destroy()}}var s=this.renderables;if(s){var o=s.length;for(var u=o-1;u>=0;u-=1){var a=s[u];a.destroy&&a.destroy()}this.renderables=[]}this.lightInstances&&(this.lightInstances=[]),delete this.scene;var f=e._tempDirtyNodes,l=f.length,c;for(c=0;c<l;c+=1)f[c]=null},e.prototype.subscribeCloned=function(e){this.clonedObserver||(this.clonedObserver=T.create()),this.clonedObserver.subscribe(e)},e.prototype.unsubscribeCloned=function(e){this.clonedObserver.unsubscribe(e)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=T.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){return new e(t)},e.version=1,e._tempDirtyNodes=[],e}();h.prototype.mathDevice=null,function(){h.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(h.prototype.arrayConstructor=Float32Array)}}();var p=function(){function e(e,t,n){this.md=e,this.staticSpatialMap=t||i.create(!0),this.dynamicSpatialMap=n||i.create(),this.clear();var r=this;this.onGeometryDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onGeometryDestroyed),delete r.shapes[t.name]},this.onMaterialDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onMaterialDestroyed),delete r.materials[t.name]}}return e.prototype.findNode=function(e){var t=this.rootNodesMap[e];if(t)return t;var n=e.split("/"),r=n[0];t=this.rootNodesMap[r];for(var i=1;t&&i<n.length;i+=1)t=t.findChild(n[i]);return t},e.prototype.addRootNode=function(e){var t=e.name;e.scene=this,e.worldExtentsUpdate=!0,this.rootNodes.push(e),this.rootNodesMap[t]=e,this.addRootNodeToUpdate(e,t)},e.prototype.removeRootNode=function(e){var t=e.name;e.removedFromScene(this);var n=this.rootNodes,r=n.indexOf(e);if(r!==-1){var i=n.length-1;r<i&&(n[r]=n[i]),n.length=i}delete this.rootNodesMap[t];if(this.dirtyRoots[t]===e){delete this.dirtyRoots[t];var s=this.nodesToUpdate,o=this.numNodesToUpdate;for(r=0;r<o;r+=1)if(s[r]===e){o-=1,r<o&&(s[r]=s[o]),s[o]=null,this.numNodesToUpdate=o;break}}delete e.scene},e.prototype.addLight=function(e){this.lights[e.name]=e,e.isGlobal()&&this.globalLights.push(e)},e.prototype.removeLight=function(e){delete this.lights[e.name];if(e.isGlobal()){var t=this.globalLights,n=t.length;for(var r=0;r<n;r+=1)if(e===t[r]){t.splice(r,1);break}}},e.prototype.getLight=function(e){return this.lights[e]},e.prototype.getGlobalLights=function(){return this.globalLights},e.prototype.calculateNumNodes=function(e){var t=e.length,n=t;for(var r=0;r<t;r+=1){var i=e[r].children;i&&(n+=this.calculateNumNodes(i))}return n},e.prototype.buildPortalPlanes=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s.length,f=0,l,c,h,p,d,v,m=[];m.length=u,c=0;do m[c]=0,c+=1;while(c<u);l=0;do{d=s[l];var g=d[0],y=d[1],b=d[2],w=d[3];v=0,c=0;do p=e[c],g*p[0]+y*p[1]+b*p[2]>=w?v+=1:m[c]|=1<<l,c+=1;while(c<u);if(v===0)return t.length=0,!1;v<u&&(t[f]=o.v4Copy(d,t[f]),f+=1),l+=1}while(l<a);var E=f===0,S=this.newPoints;c=0;do p=e[c],S[c]=o.v3Build(p[0]-n,p[1]-r,p[2]-i,S[c]),c+=1;while(c<u);var x=Math.sqrt;c=0;do{h=c+1,h>=u&&(h=0);if(0!==(m[c]&m[h])){c+=1;continue}p=S[c];var T=p[0],N=p[1],C=p[2];p=S[h];var k=p[0],L=p[1],A=p[2],O=N*A-C*L,M=C*k-T*A,_=T*L-N*k,D=O*O+M*M+_*_;if(D===0)return t.length=0,!1;var P=1/x(D);O*=P,M*=P,_*=P;var H=O*n+M*r+_*i;t[f]=o.v4Build(O,M,_,H,t[f]),f+=1,c+=1}while(c<u);return t.length=f,E},e.prototype.findAreaIndex=function(e,t,n,r){var i=e.length,s=0,o,u;do{o=e[s],u=o.plane,s=u[0]*t+u[1]*n+u[2]*r<u[3]?o.neg:o.pos;if(s<=0)return-(s+1)}while(s<i);return-1},e.prototype.findAreaIndicesAABB=function(e,t,n,r,i,s,o){var u=e.length,a=[],f=[],l=[0],c=1,h,p,d,v;do{c-=1,h=l[c];do{p=e[h],d=p.plane;var m=d[0],g=d[1],y=d[2],b=d[3];m*(m<0?t:i)+g*(g<0?n:s)+y*(y<0?r:o)<b?h=p.neg:(m*(m>0?t:i)+g*(g>0?n:s)+y*(y>0?r:o)<=b&&(h=p.neg,h<=0?h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v))):(l[c]=h,c+=1)),h=p.pos);if(h<=0){h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v)));break}}while(h<u)}while(0<c);return a},e.prototype.findVisiblePortals=function(e,t,n,r){var i=this.visiblePortals,s=i.length,o=this.frustumPlanes,u=o.length,a=this.getQueryCounter(),f=this.areas,l,c,h,p,d,v,m,g,y=0,b=this.nearPlane,w=b[0],E=b[1],S=b[2];o[u]=this.md.v4Build(w,E,S,w*t+E*n+S*r),d=f[e],l=d.portals,c=l.length;for(v=0;v<c;v+=1){h=l[v];if(h.disabled)continue;h.queryCounter=a,p=h.plane,p[0]*t+p[1]*n+p[2]*r<p[3]&&(y<s?(g=i[y],m=g.planes):m=[],this.buildPortalPlanes(h.points,m,t,n,r,o),0<m.length&&(y<s?(g.portal=h,g.area=h.area):i[y]={portal:h,planes:m,area:h.area},y+=1))}o.length=u;if(0<y){var x,T,N,C,k,L,A,O,M=0;do{g=i[M],M+=1,m=g.planes,x=m.length,h=g.portal,e=g.area,m[x]=h.plane,d=f[e],l=d.portals,
c=l.length;for(v=0;v<c;v+=1)h=l[v],T=h.area,T!==e&&h.queryCounter!==a&&!h.disabled&&(p=h.plane,N=p[0],C=p[1],k=p[2],L=p[3],N*t+C*n+k*r<L?(y<s?(g=i[y],A=g.planes):A=[],O=this.buildPortalPlanes(h.points,A,t,n,r,m),0<A.length&&(O&&(h.queryCounter=a),y<s?(g.portal=h,g.area=T):i[y]={portal:h,planes:A,area:T},y+=1)):h.queryCounter=a);m.length=x}while(M<y)}y<s&&(i.length=y)},e.prototype.findVisibleNodes=function(e,t){var n=t.length,r=this.frustumPlanes,i=!0,s=this.areas;if(s){var o=e.matrix,u=o[9],a=o[10],f=o[11],l=this.findAreaIndex(this.bspNodes,u,a,f);this.cameraAreaIndex=l;if(l>=0){e.getFrustumExtents(this.cameraExtents);var c=this.cameraExtents[0],h=this.cameraExtents[1],p=this.cameraExtents[2],d=this.cameraExtents[3],v=this.cameraExtents[4],m=this.cameraExtents[5];this.findVisiblePortals(l,u,a,f);var g,y,b,w,E=s.length;for(y=0;y<E;y+=1)g=s[y],b=g.nodes,w=g.numStaticNodes,b.length>w&&(b.length=w),g.addedDynamicNodes=!1;var S=this.isInsidePlanesAABB,x=this.dynamicSpatialMap,T=this.visiblePortals,N=T.length,C=this.getQueryCounter(),k,L,A,O,M;g=s[l],b=g.nodes,g.addedDynamicNodes=!0;var _=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter=C,S(L.worldExtents,r)&&(t[n]=L,n+=1);for(A=0;A<N;A+=1){O=T[A],M=O.planes,g=s[O.area],b=g.nodes,g.addedDynamicNodes||(g.addedDynamicNodes=!0,_=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b)),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter!==C&&S(L.worldExtents,M)&&(L.queryCounter=C,t[n]=L,n+=1)}i=!1}}i&&(n+=this.staticSpatialMap.getVisibleNodes(r,t,n),this.dynamicSpatialMap.getVisibleNodes(r,t,n))},e.prototype.findVisibleNodesTree=function(e,t,n){var r=n.length,i=this.frustumPlanes,s=!0,o=this.areas;if(o){var u=this.cameraAreaIndex;if(u>=0){var a=this.cameraExtents[0],f=this.cameraExtents[1],l=this.cameraExtents[2],c=this.cameraExtents[3],h=this.cameraExtents[4],p=this.cameraExtents[5],d=this.externalNodesStack,v,m,g,y,b,w,E,S=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6),x,T,N,C,k=o.length;for(T=0;T<k;T+=1)x=o[T],N=x.externalNodes,N&&(d.push(N),x.externalNodes=null);var L=this.isInsidePlanesAABB,A=this.findOverlappingAreas,O=this.findAreaIndex,M=this.visiblePortals,_=M.length,D=this.getQueryCounter(),P=this.bspNodes,H,B,j,F,I,q,R,U,z,W,X,V;x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter=D,L(j.worldExtents,i)&&(n[r]=j,r+=1);for(I=0;I<_;I+=1){q=M[I],H=q.planes,u=q.area,x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter!==D&&L(j.worldExtents,H)&&(j.queryCounter=D,n[r]=j,r+=1)}s=!1}}s&&e.getVisibleNodes(i,n,r)},e.prototype.buildPortalPlanesNoFrustum=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s?s.length:0,f=a,l=this.newPoints,c,h;c=0;do h=e[c],l[c]=o.v3Build(h[0]-n,h[1]-r,h[2]-i,l[c]),c+=1;while(c<u);var p=Math.sqrt;c=0;do{h=l[c];var d=h[0],v=h[1],m=h[2];h=l[c+1<u?c+1:0];var g=h[0],y=h[1],b=h[2],w=v*b-m*y,E=m*g-d*b,S=d*y-v*g,x=w*w+E*E+S*S;if(x===0)return!1;var T=1/p(x);w*=T,E*=T,S*=T;var N=w*n+E*r+S*i;t[f]=o.v4Build(w,E,S,N,t[f]),f+=1,c+=1}while(c<u);for(c=0;c<a;c+=1)t[c]=o.v4Copy(s[c],t[c]);return t.length=f,!0},e.prototype.findOverlappingPortals=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y=this.getQueryCounter(),b=this.areas,w=0,E,S=i[0],x=i[1],T=i[2],N=i[3],C=i[4],k=i[5];v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1){f=o[a];if(f.disabled)continue;f.queryCounter=y,m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T&&(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d&&(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,null)&&(E.portal=f,E.area=f.area,w+=1)))}if(0<w){var L,A,O=0;do{E=s[O],O+=1,L=E.planes,e=E.area,f=E.portal,v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1)f=o[a],A=f.area,A!==e&&f.queryCounter!==y&&!f.disabled&&(m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T?(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d?(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,L)&&(f.queryCounter=y,E.portal=f,E.area=A,w+=1)):f.queryCounter=y):f.queryCounter=y)}while(O<w)}return w},e.prototype.findOverlappingNodes=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingNodesAreas(e,t,n,r)),i&&e.getOverlappingNodes(n,r)},e.prototype.findStaticOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingNodesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=this.externalNodesStack,f=this.areas,l,c,h,p,d=f.length;for(l=0;l<d;l+=1)c=f[l],h=c.externalNodes,h&&(a.push(h),c.externalNodes=null);var v=n[0],m=n[1],g=n[2],y=n[3],b=n[4],w=n[5];c=f[u];var E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],L=this.overlappingPortals,A=this.findOverlappingPortals(u,i,s,o,n,L),O=this.isInsidePlanesAABB,M=this.getQueryCounter(),_=r.length,D,P,H,B,j;0<a.length?h=a.pop():h=[],c.externalNodes=h;var F=this.testExtents;F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter=M,r[_]=H,_+=1;for(B=0;B<A;B+=1){j=L[B],D=j.planes,c=f[j.area],h=c.externalNodes,h||(0<a.length?h=a.pop():h=[],c.externalNodes=h,E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0)),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter!==M&&O(H.worldExtents,D)&&(H.queryCounter=M,r[_]=H,_+=1)}return!0},e.prototype.findOverlappingRenderables=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingRenderablesAreas(e,t,n,r)),i&&this._findOverlappingRenderablesNoAreas(e,n,r)},e.prototype.findStaticOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingRenderablesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=r.length,f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5],v,m,g,y,b,w,E,S,x,T=this.externalNodesStack,N=this.areas,C,k,L,A=N.length;for(C=0;C<A;C+=1)k=N[C],L=k.externalNodes,L&&(T.push(L),k.externalNodes=null);k=N[u];var O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],j=this.overlappingPortals,F=this.findOverlappingPortals(u,i,s,o,n,j),I=this.isInsidePlanesAABB,q=this.isFullyInsidePlanesAABB,R=this.getQueryCounter(),U,z,W,X,V;0<T.length?L=T.pop():L=[],k.externalNodes=L;var $=this.testExtents;$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0),m=L.length;for(g=0;g<m;g+=1){v=L[g],v.queryCounter=R,b=v.renderables;if(b){w=b.length;if(w===1)r[a]=b[0],a+=1;else{E=v.worldExtents;if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)for(S=0;S<w;S+=1)r[a]=b[S],a+=1;else for(S=0;S<w;S+=1)y=b[S],x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&(r[a]=y,a+=1)}}}for(W=0;W<F;W+=1){X=j[W],U=X.planes,k=N[X.area],L=k.externalNodes,L||(0<T.length?L=T.pop():L=[],k.externalNodes=L,O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0)),m=L.length;for(z=0;z<m;z+=1){v=L[z];if(v.queryCounter!==R){V=!0,b=v.renderables;if(b){E=v.worldExtents;if(I(E,U)){w=b.length;if(w===1)y=b[0],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(I(y.getWorldExtents(),U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&I(x,U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1)}else V=!1}V&&(v.queryCounter=R)}}}return!0},e.prototype._findOverlappingRenderablesNoAreas=function(e,t,n){var r=n.length,i=t[0],s=t[1],o=t[2],u=t[3],a=t[4],f=t[5],l=this.queryVisibleNodes,c,h,p,d,v,m,g,y,b;h=e.getOverlappingNodes(t,l,0);for(p=0;p<h;p+=1){c=l[p],v=c.renderables;if(v){m=v.length;if(m===1)n[r]=v[0],r+=1;else{g=c.worldExtents;if(g[0]>=i&&g[1]>=s&&g[2]>=o&&g[3]<=u&&g[4]<=a&&g[5]<=f)for(y=0;y<m;y+=1)n[r]=v[y],r+=1;else for(y=0;y<m;y+=1)d=v[y],b=d.getWorldExtents(),b[3]>=i&&b[4]>=s&&b[5]>=o&&b[0]<=u&&b[1]<=a&&b[2]<=f&&(n[r]=d,r+=1)}}}},e.prototype.cloneRootNode=function(e,t){var n=e.clone(t);return this.addRootNode(n),n},e.prototype.updateVisibleNodes=function(e){var t=!0;this.areas&&(t=!this._updateVisibleNodesAreas(e)),t&&this._updateVisibleNodesNoAreas(e),this.frameIndex+=1},e.prototype._updateVisibleNodesNoAreas=function(e){var t=this.visibleNodes,n=0,r=this.visibleRenderables,i=0,s=this.visibleLights,o=0;this.extractFrustumPlanes(e);var u=this.frustumPlanes,a=this.frameIndex,f=this.nearPlane,l=f[0],c=f[1],h=f[2],p=f[3],d=0,v,m,g=this.isFullyInsidePlanesAABB,y=this.isInsidePlanesAABB,b=this.queryVisibleNodes,w=this.staticSpatialMap.getVisibleNodes(u,b,0);w+=this.dynamicSpatialMap.getVisibleNodes(u,b,w);for(v=0;v<w;v+=1){m=b[v];if(!m.disabled){var E=m.worldExtents,S,x,T,N,C;m.frameVisible=a,S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,m.distance=S;if(0<S){t[n]=m,n+=1;var k=m.renderables,L=k?k.length:0,A=m.lightInstances,O=A?A.length:0,M=1<O+L?g(E,u):!1;if(k)if(L===1&&!A)x=k[0],x.disabled||(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1);else for(T=0;T<L;T+=1){x=k[T];if(!x.disabled){E=x.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1)}}if(A)if(O===1&&!k)N=A[0],!N.disabled&&!N.light.isGlobal()&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1);else for(C=0;C<O;C+=1){N=A[C];if(!N.disabled&&!N.light.isGlobal()){E=N.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1)}}}}}this.maxDistance=d+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,n,i,o):(r.length=i,s.length=o,t.length=n)},e.prototype._updateVisibleNodesAreas=function(e){function D(e,t){var n=e.worldExtents,r=!0,i;e.frameVisible!==p?(e.frameVisible=p,i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,e.distance=i,0<i&&(o[u]=e,u+=1)):i=e.distance;if(0<i){var s,h,d,w,E=e.renderables,T=E?E.length:0,N=e.lightInstances,C=N?N.length:0,k=1<C+T?S(n,t):!1;if(E)if(T===1&&!N)s=E[0],!s.disabled&&s.queryCounter!==_&&(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1);else for(h=0;h<T;h+=1)s=E[h],!s.disabled&&s.queryCounter!==_&&(n=s.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1):r=!1):r=!1);if(N)if(C===1&&!E)d=N[0],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1);else for(w=0;w<C;w+=1)d=N[w],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(n=d.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1):r=!1):r=!1)}r&&(e.queryCounter=_)}var t=e.matrix,n=t[9],r=t[10],i=t[11],s=this.findAreaIndex(this.bspNodes,n,r,i);this.cameraAreaIndex=s;if(s<0)return!1;var o=this.visibleNodes,u=0,a=this.visibleRenderables,f=0,l=this.visibleLights,c=0;this.extractFrustumPlanes(e);var h=this.frustumPlanes,p=this.frameIndex,d=this.nearPlane,v=d[0],m=d[1],g=d[2],y=d[3],b=0,w=0,E,S=this.isFullyInsidePlanesAABB,x=this.isInsidePlanesAABB,T=this.cameraExtents;e.getFrustumExtents(T);var N=T[0],C=T[1],k=T[2],L=T[3],A=T[4],O=T[5],M=this.areas,_=this.getQueryCounter();this.findVisiblePortals(s,n,r,i);var P,H,B,j,F=M.length;for(H=0;H<F;H+=1)P=M[H],B=P.nodes,j=P.numStaticNodes,B.length>j&&(B.length=j),P.addedDynamicNodes=!1;var I=this.dynamicSpatialMap,q=this.visiblePortals,R=q.length,U,z,W;P=M[s],B=P.nodes,P.addedDynamicNodes=!0;var X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5],Y=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter=_,!E.disabled&&x(E.worldExtents,h)&&D(E,h);for(U=0;U<R;U+=1){z=q[U],W=z.planes,P=M[z.area],B=P.nodes,X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5];if(L>V&&A>$&&O>J&&K>N&&Q>C&&G>k){P.addedDynamicNodes||(P.addedDynamicNodes=!0,Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B)),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter!==_&&(E.disabled?E.queryCounter=_:x(E.worldExtents,W)&&D(E,W))}}return this.maxDistance=b+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,u,f,c):(a.length=f,l.length=c,o.length=u),!0},e.prototype._filterVisibleNodesForCameraBox=function(e,t,n,r){var i=this.visibleNodes,s=this.visibleRenderables,o=this.visibleLights,u=n,a=r,f=this.cameraExtents;e.getFrustumExtents(f,this.maxDistance);var l=f[0],c=f[1],h=f[2],p=f[3],d=f[4],v=f[5],m,g,y,b,w=0;while(w<n){g=s[w],b=g.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){g.frameVisible-=1,n-=1;if(!(w<n))break;s[w]=s[n]}else w+=1}w=0;while(w<r){y=o[w],b=y.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){y.frameVisible-=1,r-=1;if(!(w<r))break;o[w]=o[r]}else w+=1}if(u!==n||a!==r){w=0;while(w<t){m=i[w],b=m.worldExtents;if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){m.frameVisible-=1,t-=1;if(!(w<t))break;i[w]=i[t]}else w+=1}}s.length=n,o.length=r,i.length=t},e.prototype.getCurrentVisibleNodes=function(){return this.visibleNodes},e.prototype.getCurrentVisibleRenderables=function(){return this.visibleRenderables},e.prototype.getCurrentVisibleLights=function(){return this.visibleLights},e.prototype.addRootNodeToUpdate=function(e,t){var n=this.dirtyRoots;if(n[t]!==e){n[t]=e;var r=this.numNodesToUpdate;this.nodesToUpdate[r]=e,this.numNodesToUpdate=r+1}},e.prototype.updateNodes=function(){var e=this.numNodesToUpdate;if(0<e){var t=this.nodesToUpdate,n=this.dirtyRoots,r;for(r=0;r<e;r+=1)n[t[r].name]=null;h.updateNodes(this.md,this,t,e),this.numNodesToUpdate=0}},e.prototype.update=function(){this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents(),this.areas&&this.staticNodesChangeCounter!==this.areaInitalizeStaticNodesChangeCounter&&this.initializeAreas()},e.prototype.updateExtents=function(){var e=this.staticSpatialMap.getExtents(),t=this.dynamicSpatialMap.getExtents(),n=this.extents;if(e)if(t){var r,i,s,o,u,a,f,l,c,h,p,d;r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=t[0],l=t[1],c=t[2],h=t[3],p=t[4],d=t[5],n[0]=r<f?r:f,n[1]=i<l?i:l,n[2]=s<c?s:c,n[3]=o>h?o:h,n[4]=u>p?u:p,n[5]=a>d?a:d}else n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5];else t?(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5]):(n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=0)},e.prototype.getExtents=function(){return 0<this.numNodesToUpdate&&(this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents()),this.extents},e.prototype.loadMaterial=function(e,t,n,r,i){var s=this.materials;if(!s[r]){var o=i.effect||"default",u=this.createMaterial(r,i,o,null,null,e);if(u){delete u.effectName;var a=n.get(o);return a&&a.prepareMaterial(u),u.loadTextures(t),!0}}return!1},e.prototype.hasMaterial=function(e){var t=this.materials[e];return t?!0:!1},e.prototype.getMaterial=function(e){return this.materials[e]},e.prototype.drawNodesArray=function(e,t,n,r,i){var s=e.length;if(s>0){var o=t.setTechnique,u=t.setTechniqueParameters,a=t.setStream,f=t.setIndexBuffer,l=t.drawIndexed,c=t.draw,h=null,p=null,d=null,v=-1,m,g,y,b,w,E,S,x,T,N,C,k,L,A=0;o.call(t,r),u.call(t,n);do{m=e[A],N=m.renderables;if(N){k=N.length;for(L=0;L<k;L+=1){C=N[L],i.call(C),g=C.geometry,w=g.vertexBuffer,S=g.vertexOffset,E=g.semantics,x=C.surface,y=C.sharedMaterial.techniqueParameters,b=C.techniqueParameters,h!==y?(h=y,u.call(t,y,b)):u.call(t,b);if(p!==w||d!==E||v!==S)p=w,d=E,v=S,a.call(t,w,E,S);T=x.indexBuffer,T?(f.call(t,T),l.call(t,x.primitive,x.numIndices,x.first)):c.call(t,x.primitive,x.numVertices,x.first)}}A+=1}while(A<s)}},e.prototype.drawVisibleNodes=function(e,t,n,r){this.drawNodesArray(this.visibleNodes,e,t,n,r)},e.prototype.clearMaterials=function(){var e=this.onMaterialDestroyed,t=this.materials;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.materials={}},e.prototype.clearShapes=function(){var e=this.onGeometryDestroyed,t=this.shapes;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.shapes={}},e.prototype.clearShapesVertexData=function(){var e=this.shapes,t;if(e)for(var n in e)if(e.hasOwnProperty(n)){t=e[n],delete t.vertexData,delete t.indexData;var r=t.surfaces;if(r)for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];delete s.vertexData,delete s.indexData}}},e.prototype.clearRootNodes=function(){var e=this.rootNodes;if(e){var t=e.length;for(var n=0;n<t;n+=1)e[n].destroy()}this.rootNodes=[],this.rootNodesMap={},this.dirtyRoots={},this.nodesToUpdate=[],this.numNodesToUpdate=0},e.prototype.clear=function(){this.effects=[],this.effectsMap={},this.semantics={},this.lights={},this.globalLights=[],this.clearRootNodes(),this.clearMaterials(),this.clearShapes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear(),this.frustumPlanes=[],this.animations={},this.skeletons={},this.extents=this.md.aabbBuildEmpty(),this.visibleNodes=[],this.visibleRenderables=[],this.visibleLights=[],this.cameraAreaIndex=-1,this.cameraExtents=this.md.aabbBuildEmpty(),this.visiblePortals=[],this.frameIndex=0,this.queryCounter=0,this.staticNodesChangeCounter=0,this.testExtents=this.md.aabbBuildEmpty(),this.externalNodesStack=[],this.overlappingPortals=[],this.newPoints=[],this.queryVisibleNodes=[]},e.prototype.endLoading=function(e){this.initializeNodes(),this.initializeAreas(),e&&e(this)},e.prototype.initializeNodes=function(){var e=this.numNodesToUpdate;0<e&&(this.numNodesToUpdate=0,this.dirtyRoots={},h.updateNodes(this.md,this,this.nodesToUpdate,e)),this.staticSpatialMap.finalize(),this.updateExtents()},e.prototype.addAreaStaticNodes=function(){var e=this.findAreaIndicesAABB,t=this.findAreaIndex,n=this,r=function(s,o){if(this.dynamic)return;if(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents){var u=this.worldExtents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d,v,m,g,y;if(!this.hasRenderables()&&this.lightInstances.length===1&&this.lightInstances[0].light.spot){var b=this.world;m=b[9],g=b[10],y=b[11]}else m=(a+c)*.5,g=(f+h)*.5,y=(l+p)*.5;var w=t(s,m,g,y);if(w>=0){d=o[w],d.nodes.push(this);var E=n.findOverlappingAreas(w,u),S=E.length;for(v=0;v<S;v+=1)E[v].nodes.push(this)}else{var x=!1,T;for(;;){var N=e(s,a,f,l,c,h,p),C=N.length;if(0<C){v=0;do d=o[N[v]],T=d.extents,T[0]<=c&&T[1]<=h&&T[2]<=p&&T[3]>=a&&T[4]>=f&&T[5]>=l&&(d.nodes.push(this),x=!0),v+=1;while(v<C);if(!x){v=0;do o[N[v]].nodes.push(this),v+=1;while(v<C)}break}var k=Math.max(c-a,h-f,p-l)/20;a-=k,f-=k,l-=k,c+=k,h+=k,p+=k}}}var L=this.children;if(L){var A=L.length;for(var O=0;O<A;O+=1)r.call(L[O],s,o)}},i=this.rootNodes,s=i.length,o=this.bspNodes,u=this.areas;for(var a=0;a<s;a+=1)r.call(i[a],o,u)},e.prototype.findOverlappingAreas=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v=this.getQueryCounter(),m=this.areas,g=[],y=0,b=[],w=0,E=t[0],S=t[1],x=t[2],T=t[3],N=t[4],C=t[5];r=m[e],r.queryCounter=v,i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1))}while(0<y){y-=1,u=g[y],p=u.area,r=m[p],r.queryCounter!==v&&(r.queryCounter=v,b[w]=r,w+=1),i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;d=u.area,d!==p&&d!==e&&u.queryCounter!==v&&(u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1)))}}return b},e.prototype.checkAreaDynamicNodes=function(){var e=this.findAreaIndicesAABB,t=this.dynamicSpatialMap,n=this.bspNodes,r=this.areas,i=function(){if(this.dynamic&&(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents)){var o=this.worldExtents,u=o[0],a=o[1],f=o[2],l=o[3],c=o[4],h=o[5],p=!1,d=!1,v;for(;;){var m=e(n,u,a,f,l,c,h),g=m.length;if(0<g){v=0;do{var y=r[m[v]],b=y.extents;if(b[0]<=l&&b[1]<=c&&b[2]<=h&&b[3]>=u&&b[4]>=a&&b[5]>=f){d=!0;break}v+=1}while(v<g)}if(d)break;var w=Math.max(l-u,c-a,h-f)/20;u-=w,a-=w,f-=w,l+=w,c+=w,h+=w,p=!0}p&&(o[0]=u,o[1]=a,o[2]=f,o[3]=l,o[4]=c,o[5]=h,t.update(this,o))}var E=this.children;if(E){var S=E.length;for(var x=0;x<S;x+=1)i.call(E[x])}},s=this.rootNodes,o=s.length;for(var u=0;u<o;u+=1)i.call(s[u])},e.prototype.initializeAreas=function(){var e=this.areas;if(e){var t=e.length,n,r,i,s,o;for(n=0;n<t;n+=1)r=e[n],i=r.target,r.nodes=[],s=i.calculateHierarchyWorldExtents(),s&&(o=r.extents,o[0]=s[0]<o[0]?s[0]:o[0],o[1]=s[1]<o[1]?s[1]:o[1],o[2]=s[2]<o[2]?s[2]:o[2],o[3]=s[3]>o[3]?s[3]:o[3],o[4]=s[4]>o[4]?s[4]:o[4],o[5]=s[5]>o[5]?s[5]:o[5]);this.addAreaStaticNodes(),this.checkAreaDynamicNodes();for(n=0;n<t;n+=1)r=e[n],r.numStaticNodes=r.nodes.length}this.areaInitalizeStaticNodesChangeCounter=this.staticNodesChangeCounter},e.prototype.createMaterial=function(e,t,n,r,i,s){var o=this.materials,u=f.create(s),a,l,c,h,p;if(r){var d=r[n];if(d){var v=d.parameters;for(h in v)v.hasOwnProperty(h)&&(a=v[h],typeof a=="string"?(i?l=i[a]||a:l=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[h]=l,u.techniqueParameters[h]=null):u.techniqueParameters[h]=a);c=d.type,p=d.meta}else c=n}else c=n;var m=t.parameters;for(h in m)m.hasOwnProperty(h)&&(a=m[h],typeof a=="string"?(i?l=i[a]||a:l=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[h]=l,u.techniqueParameters[h]=null):u.techniqueParameters[h]=a);u.effectName=c;var g=t.meta;if(g){if(p)for(h in p)p.hasOwnProperty(h)&&!g.hasOwnProperty(h)&&(g[h]=p[h]);u.meta=g}else p&&(u.meta=p);return o[e]=u,u.name=e,u.reference.subscribeDestroyed(this.onMaterialDestroyed),u},e.prototype.loadMaterials=function(e){var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=this.createMaterial;e.append||(this.effects=[],this.effectsMap={},this.clearMaterials());var s=t.materials;if(s){var o=t.images,u=t.effects,a=this.materials;for(var f in s)if(s.hasOwnProperty(f)&&!a[f]){var l=s[f],c=l.effect||"default";i.call(this,f,l,c,u,o,n,r)}}},e.prototype.loadSkeletons=function(e){var t=e.data,n=t.skeletons,r=this.md,i=r.m43Build,s,o;for(var u in n)if(n.hasOwnProperty(u)){var a=n[u],f=a.numNodes,l=a.invBoneLTMs,c=a.bindPoses;for(var h=0;h<f;h+=1)s=l[h],o=c[h],l[h]=i.apply(r,s),c[h]=i.apply(r,o);e.skeletonNamePrefix&&(u=e.skeletonNamePrefix+u),this.skeletons[u]=a}},e.prototype._updateSingleIndexTables=function(e,t,n,r,i){var s=e.faces,o=s.length,u=[];u.length=o;var a=n.length,f=0,l=0,c,h,p,d,v,m;while(l<o){d=r,c=l,h=l+(t-1);do p=s[c],v=d[p],v===undefined&&(d[p]=v={}),d=v,c+=1;while(c<h);p=s[c],m=d[p];if(m===undefined){d[p]=m=i,i+=1,c=l;do n[a]=s[c],a+=1,c+=1;while(c<h);n[a]=p,a+=1}u[f]=m,f+=1,l+=t}return u.length=f,e.faces=u,i},e.prototype._isSequentialIndices=function(e,t){var n=e[0],r;for(r=1;r<t;r+=1)if(e[r]!==n+r)return!1;return!0},e.prototype._optimizeRenderables=function(e,t){function g(e){var t=new e.constructor,n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}var n=e.renderables,r=n.length,i=t.PRIMITIVE_TRIANGLES,s={},o=[],u=0,a,f,l,c,h,p,d,v,m=!1;for(a=0;a<r;a+=1)f=n[a],c=f.surface,c.primitive===i&&f.geometryType==="rigid"?(l=f.geometry,h=l.vertexBuffer.id,p=s[h],p===undefined&&(s[h]=p={}),c.indexBuffer?d=c.indexBuffer.id:d="null",v=p[d],v===undefined?p[d]=[f]:(v.push(f),m=!0)):(o[u]=f,u+=1);if(m){var y=Math.max,b=Math.min,w=this.float32ArrayConstructor?this.float32ArrayConstructor:Array,E=new w(6),S,x,T,N,C,k,L,A,O,M,_,D=function(){var t=g(S.surface);S.surface=t,t.indexBuffer?(t.numIndices=N-t.first,t.numVertices=C):t.numVertices=N-t.first;var n=(E[3]+E[0])*.5,r=(E[4]+E[1])*.5,i=(E[5]+E[2])*.5;if(n!==0||r!==0||i!==0){var s=S.center||new w(3);S.center=s,s[0]=n,s[1]=r,s[2]=i}else S.center=null;var o=S.halfExtents||new w(3);S.halfExtents=o,o[0]=(E[3]-E[0])*.5,o[1]=(E[4]-E[1])*.5,o[2]=(E[5]-E[2])*.5};r=0;for(h in s)if(s.hasOwnProperty(h)){p=s[h];for(d in p)if(p.hasOwnProperty(d)){v=p[d],k=v.length;if(k===1)n[r]=v[0],r+=1;else{v.sort(function(e,t){return e.geometry.vertexOffset-t.geometry.vertexOffset||e.surface.first-t.surface.first}),L=0,A=null,S=null,C=0,T=-1,N=0,x=0;do f=v[L],l=f.geometry,c=f.surface,O=f.sharedMaterial,M=f.center,_=f.halfExtents,T!==l.vertexOffset||N!==c.first||!A||A!==O&&!A.isSimilar(O)?(0<x&&(1<x&&D(),n[r]=S,r+=1),A=O,S=f,C=0,x=1,T=l.vertexOffset,M?(E[0]=M[0]-_[0],E[1]=M[1]-_[1],E[2]=M[2]-_[2],E[3]=M[0]+_[0],E[4]=M[1]+_[1],E[5]=M[2]+_[2]):(E[0]=-_[0],E[1]=-_[1],E[2]=-_[2],E[3]=_[0],E[4]=_[1],E[5]=_[2])):(x+=1,M?(E[0]=b(E[0],M[0]-_[0]),E[1]=b(E[1],M[1]-_[1]),E[2]=b(E[2],M[2]-_[2]),E[3]=y(E[3],M[0]+_[0]),E[4]=y(E[4],M[1]+_[1]),E[5]=y(E[5],M[2]+_[2])):(E[0]=b(E[0],-_[0]),E[1]=b(E[1],-_[1]),E[2]=b(E[2],-_[2]),E[3]=y(E[3],_[0]),E[4]=y(E[4],_[1]),E[5]=y(E[5],_[2]))),c.indexBuffer?(N=c.first+c.numIndices,C+=c.numVertices):N=c.first+c.numVertices,L+=1;while(L<k);1<x&&D(),n[r]=S,r+=1}}}for(a=0;a<u;a+=1)n[r]=o[a],r+=1;for(a=r;a<n.length;a+=1)n[a].setNode(null);n.length=r}},e.prototype.loadShape=function(e,t,n){var r=this.shapes[e];if(!r){var i=this.semantics,s=n.data,o=n.graphicsDevice,a=n.keepVertexData,f=s.geometries,l=f[t],c=l.sources,h=l.inputs,p=n.skeletonNamePrefix?n.skeletonNamePrefix+l.skeleton:l.skeleton;r=u.create();if(p){var d=this.skeletons[p];d?(r.skeleton=d,r.type="skinned"):r.type="rigid"}else r.type="rigid";if(o){var v,m,g,y,b=0,w=[],E=function(t,n){return t>=0&&n<=255&&n>=0},S=function(t,n,r){var i=t.length;if(n.length!==i)return!1;for(var s=0;s<i;s+=1)if(!r(t[s],n[s]))return!1;return!0},x=n.vertexFormatMap||{},T;for(var N in h)if(h.hasOwnProperty(N)){if(o["SEMANTIC_"+N]===undefined)continue;T=h[N],v=T.offset,v>b&&(b=v);var C=c[T.source],k=C.stride;y=x[N],g=k,y&&(y.indexOf("4")?g=4:y.indexOf("3")?g=3:y.indexOf("2")?g=2:y.indexOf("1")?g=1:y=null),y||(N==="BLENDINDICES"||N==="BLENDINDICES0")&&k===4&&S(C.min,C.max,E)&&(y="UBYTE4"),y||(y="FLOAT"+k),w.push({semantic:N,offset:v,data:C.data,stride:k,destFormat:y,destStride:g})}var L=b+1;if(0<b){var A=function(e,t){if(e.offset===t.offset){var n=e.semantic;typeof n=="string"&&(n=o["SEMANTIC_"+n]);var r=t.semantic;return typeof r=="string"&&(r=o["SEMANTIC_"+r]),n-r}return e.offset-t.offset};w.sort(A)}var O=w.length,M=[],P=[],H=this.float32ArrayConstructor?!0:!1,B=0,j,F;for(j=0;j<O;j+=1)F=w[j],M[j]=F.semantic,y=F.destFormat,H&&(typeof y=="string"?y[0]!=="F"&&(H=!1):y!==o.VERTEXFORMAT_FLOAT1&&y!==o.VERTEXFORMAT_FLOAT2&&y!==o.VERTEXFORMAT_FLOAT3&&y!==o.VERTEXFORMAT_FLOAT4&&(H=!1)),P[j]=y,B+=F.stride;var I,q=0,R=!1,U=l.surfaces;U||(R=!0,U={singleSurface:{triangles:l.triangles,lines:l.lines,numPrimitives:l.numPrimitives}});var z,W,X,V;for(V in U)if(U.hasOwnProperty(V)){z=U[V],W={},r.surfaces[V]=W,X=z.triangles;var $,J;X?($=o.PRIMITIVE_TRIANGLES,J=3):(X=z.lines,X&&($=o.PRIMITIVE_LINES,J=2)),W.primitive=$,W.faces=X,X&&(1<L?(I=z.numPrimitives*J,W.numVertices=I):(I=w[0].data.length/w[0].stride,I>X.length&&(I=X.length),W.numVertices=I))}if(L>1){q=0;var K=[],Q={},G=r.surfaces;for(V in G)if(G.hasOwnProperty(V)){var Y=G[V];q=this._updateSingleIndexTables(Y,L,K,Q,q)}Q=null;for(j=0;j<O;j+=1){F=w[j];var Z=F.offset,et=F.stride,tt=F.data,nt=new Array(et*q),rt=0,it=Z;while(rt<q){var st=et*rt,ot=et*K[it];for(var ut=0;ut<et;ut+=1)nt[st+ut]=tt[ot+ut];rt+=1,it+=L}F.data=nt,F.offset=0}K.length=0,K=null,L=1}q=w[0].data.length/w[0].stride;var at=n.vertexBufferManager||this.vertexBufferManager;at||(at=_.create(o),this.vertexBufferManager=at);var ft=n.indexBufferManager||this.indexBufferManager;ft||(ft=D.create(o),this.indexBufferManager=ft);var lt,ct=null,ht=at.allocate(q,P);ct=ht.vertexBuffer;if(!ct)return undefined;r.vertexBuffer=ct,r.vertexBufferManager=at,r.vertexBufferAllocation=ht,lt=ht.baseIndex;var pt,dt,vt,mt,gt=H?new this.float32ArrayConstructor(q*B):new Array(q*B),yt=0;for(dt=0;dt<q;dt+=1){j=0;do{F=w[j];var bt=F.data;m=F.stride,vt=dt*m,mt=vt+m,g=F.destStride;do gt[yt]=bt[vt],yt+=1,vt+=1;while(vt<mt);while(m<g)gt[yt]=0,yt+=1,g-=1;j+=1}while(j<O)}ct.setData(gt,lt,q),a&&!H&&this.float32ArrayConstructor&&(gt=new this.float32ArrayConstructor(gt));var wt=0,Et;for(V in U)if(U.hasOwnProperty(V)){W=r.surfaces[V],X=W.faces;if(X){Et=X.length;if(Et===6&&q===4&&W.primitive===o.PRIMITIVE_TRIANGLES){var St=X[0];if(St===X[3]||St===X[4]||St===X[5]){X[0]=X[1],X[1]=X[2],X[2]=St,St=X[0];if(St===X[3]||St===X[4]||St===X[5])X[0]=X[1],X[1]=X[2],X[2]=St}var xt=X[5];if(xt===X[1]||xt===X[2]){X[5]=X[4],X[4]=X[3],X[3]=xt,xt=X[5];if(xt===X[1]||xt===X[2])X[5]=X[4],X[4]=X[3],X[3]=xt}X[1]===X[4]&&X[2]===X[3]&&(W.primitive=o.PRIMITIVE_TRIANGLE_STRIP,Et=4,X=[X[0],X[1],X[2],X[5]],W.faces=X)}this._isSequentialIndices(X,Et)||(wt+=Et)}}var Tt,Nt,Ct,kt,Lt;if(0<wt){Lt=lt+q-1;if(Lt>=65536)if(q<=65536){var At=lt>>>16<<16;lt-=At,lt+q>65536?(At+=lt+q-65536,lt=65536-q,Lt=65535):Lt=lt+q-1,r.vertexOffset=At}else r.vertexOffset=0;else r.vertexOffset=0;pt=ft.allocate(wt,Lt<65536?"USHORT":"UINT"),Tt=pt.indexBuffer;if(!Tt)return undefined;r.indexBufferManager=ft,r.indexBufferAllocation=pt,Lt<65536&&this.uint16ArrayConstructor?Nt=new this.uint16ArrayConstructor(wt):this.uint32ArrayConstructor?Nt=new this.uint32ArrayConstructor(wt):Nt=new Array(wt),Ct=pt.baseIndex,kt=0}for(V in U)if(U.hasOwnProperty(V)){W=r.surfaces[V],X=W.faces,delete W.faces;if(X){Et=X.length;if(!this._isSequentialIndices(X,Et)){W.indexBuffer=Tt,W.numIndices=Et,W.first=Ct+kt,W.numVertices=q;if(lt)for(dt=0;dt<Et;dt+=1)Nt[kt]=lt+X[dt],kt+=1;else for(dt=0;dt<Et;dt+=1)Nt[kt]=X[dt],kt+=1;a&&(Lt<65536&&this.uint16ArrayConstructor?W.indexData=new this.uint16ArrayConstructor(X):this.uint32ArrayConstructor?W.indexData=new this.uint32ArrayConstructor(X):W.indexData=X)}else W.first=lt+X[0];X=null,a&&(W.vertexData=gt)}else delete r.surfaces[V]}Tt&&(Tt.setData(Nt,Ct,wt),Nt=null);var Ot=M.join(),Mt=i[Ot];Mt||(Mt=o.createSemantics(M),i[Ot]=Mt),r.semantics=Mt,R&&(z=r.surfaces.singleSurface,z&&(r.primitive=z.primitive,a&&(r.vertexData=z.vertexData),r.first=z.first,r.numVertices=z.numVertices,z.indexBuffer&&(r.indexBuffer=z.indexBuffer,r.numIndices=z.numIndices,a&&(r.indexData=z.indexData))),delete r.surfaces)}if(h.POSITION){var _t=c[h.POSITION.source],Dt=_t.min,Pt=_t.max;if(Dt&&Pt){var Ht=Dt[0],Bt=Dt[1],jt=Dt[2],Ft=Pt[0],It=Pt[1],qt=Pt[2],Rt,Ut;if(Ht!==-Ft||Bt!==-It||jt!==-qt){if(this.float32ArrayConstructor){var zt=new this.float32ArrayConstructor(6);Ut=zt.subarray(0,3),Rt=zt.subarray(3,6)}else Ut=new Array(3),Rt=new Array(3);Ut[0]=(Ht+Ft)*.5,Ut[1]=(Bt+It)*.5,Ut[2]=(jt+qt)*.5,Rt[0]=
Ft-Ut[0],Rt[1]=It-Ut[1],Rt[2]=qt-Ut[2]}else Rt=this.float32ArrayConstructor?new this.float32ArrayConstructor(3):new Array(3),Rt[0]=(Ft-Ht)*.5,Rt[1]=(It-Bt)*.5,Rt[2]=(qt-jt)*.5;r.center=Ut,r.halfExtents=Rt}}return this.shapes[e]=r,r.name=e,r.reference.subscribeDestroyed(this.onGeometryDestroyed),r}throw"Geometry '"+e+"' already exists in the scene"},e.prototype.streamShapes=function(e,t){var n=e.yieldFn,r=this,i=e.shapesNamePrefix,s=e.data,o=s.geometries,u=e.loadCustomShapeFn,a=[],f=[];for(var l in o)if(o.hasOwnProperty(l)){var c=o[l];c.meta&&c.meta.graphics&&(c.meta.custom?f.push(l):a.push(l))}var h=function(){var o=a.pop(),u=i?i+"-"+o:o;r.loadShape(u,o,e),a.length?n(h):n(t)},p=function(){var o=f.pop(),l=i?i+"-"+o:o;u.call(r,l,o,e),f.length?n(p):a.length?n(h):n(t)};f.length?n(p):a.length?n(h):n(t)},e.prototype.loadLights=function(e){var t=e.data,n=e.textureManager;e.append||(this.lights={},this.globalLights=[]);var r=t.lights,i=this.lights,s=this.globalLights,o=this.materials,u=C.beget,a=e.mathDevice,f=a.v3Build;for(var c in r)if(r.hasOwnProperty(c)&&!i[c]){var h=r[c],p=u(h),d=h.type;d==="directional"?p.directional=!0:d==="spot"?p.spot=!0:d==="ambient"?p.ambient=!0:p.point=!0,p.color=h.color&&f.apply(a,h.color),p.origin=h.origin&&f.apply(a,h.origin),p.center=h.center&&f.apply(a,h.center),p.target=h.target&&f.apply(a,h.target),p.right=h.right&&f.apply(a,h.right),p.up=h.up&&f.apply(a,h.up),p.start=h.start&&f.apply(a,h.start),p.end=h.end&&f.apply(a,h.end),p.direction=h.direction&&f.apply(a,h.direction),p.halfExtents=h.halfextents&&f.apply(a,h.halfextents);var v=h.material;if(v){var m=o[v];m&&(p.material=m,m.effectName&&(delete m.effectName,m.loadTextures(n)))}var g=l.create(p);i[c]=g,g.isGlobal()&&s.push(g)}},e.prototype.loadNodes=function(e){function T(e,t){function n(e){var t=Math.abs;return t(1-e[0])<1e-5&&t(0-e[1])<1e-5&&t(0-e[2])<1e-5&&t(0-e[3])<1e-5&&t(1-e[4])<1e-5&&t(0-e[5])<1e-5&&t(0-e[6])<1e-5&&t(0-e[7])<1e-5&&t(1-e[8])<1e-5&&t(0-e[9])<1e-5&&t(0-e[10])<1e-5&&t(0-e[11])<1e-5}if((!t.camera||!e.camera)&&t.disabled===e.disabled&&t.dynamic===e.dynamic&&t.kinematic===e.kinematic&&(!t.local||n(t.local))){t.renderables&&e.addRenderableArray(t.renderables),t.lightInstances&&e.addLightInstanceArray(t.lightInstances),t.camera&&(e.camera=t.camera);var r=t.children;if(r){var i,s=r;for(i=0;i<s;i+=1)T(e,t)||e.addChild(t)}return!0}return!1}var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=e.effectManager,s=e.baseScene,o=e.keepCameras,u=e.keepLights,f=e.optimizeHierarchy,l=e.optimizeRenderables,p=e.disabled;e.append||(this.clearRootNodes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear());var d=e.loadCustomGeometryInstanceFn,v=this.md,m=v.m43Build,g=this.materials,y=this.lights,b=this,w;s&&(w=s.materials);var E=e.baseMatrix,S=e.nodesNamePrefix,x=e.shapesNamePrefix,N=function(E,S,C,k){var L=S?S+"/"+E:E,A=h.create({name:E,local:this.matrix&&m.apply(v,this.matrix),dynamic:this.dynamic||C.dynamic||e.dynamic}),O,M=this.customgeometryinstances;if(M&&d)for(var _ in M)if(M.hasOwnProperty(_)){var D=M[_],P=d.call(b,D,e);P&&A.addRenderable(P)}var H=this.geometryinstances;if(H)for(var B in H)if(H.hasOwnProperty(B)){var j=H[B],F=j.geometry,I=x?x+"-"+F:F,q=b.shapes[I];q||(q=b.loadShape(I,F,e));if(n){var R=j.material;if(k&&t.skins){var U=t.skins[k];if(U){var z=U[R];z&&(R=z)}}var W=g[R];if(!W){w&&(W=w[R]);if(!W)return undefined;g[R]=W,W.name=R,W.reference.subscribeDestroyed(b.onMaterialDestroyed)}O=W.effect;if(!O){W.loadTextures(r);var X=W.effectName;delete W.effectName,O=i.get(X),O&&O.prepareMaterial(W)}var V=q.surfaces,$=V?V[j.surface]:q,J=a.create(q,$,W);A.addRenderable(J),j.disabled&&(J.disabled=!0)}else A.addRenderable(a.create(q,null,null))}this.camera&&o&&(A.camera=this.camera);var K=this.lightinstances;if(K&&u)for(var Q in K)if(K.hasOwnProperty(Q)){var G=K[Q],Y=y[G.light];if(Y&&!Y.global){var Z=c.create(Y);A.addLightInstance(Z),G.disabled&&(Z.disabled=!0)}}this.reference&&alert("Found unresolved node reference during scene loading");if(this.kinematic||C.kinematic)A.kinematic=!0;(this.disabled||C.disabled)&&p!==!1&&(A.disabled=!0);var et=this.nodes;if(et)for(var tt in et)if(et.hasOwnProperty(tt)&&!A.findChild(tt)){var nt=N.call(et[tt],tt,L,A,this.skin||k);nt&&(!f||!T(A,nt))&&A.addChild(nt)}return l&&A.renderables&&1<A.renderables.length&&b._optimizeRenderables(A,n),A},C=t.nodes,k=e.parentNode,L={};for(var A in C)if(C.hasOwnProperty(A)){var O=C[A],M=A,_=S?S+"/"+A:A,D=b.findNode(_),P=N.call(O,M,S,D||k||L,O.skin||e.materialSkin);if(P){k&&!D&&k.addChild(P),E?P.local?P.setLocalTransform(v.m43Mul(P.getLocalTransform(),E)):P.setLocalTransform(E):P.local||P.setLocalTransform(v.m43BuildIdentity()),p&&P.enableHierarchy(!1);if(D){var H=D.local;H&&P.local&&(P.local=v.m43Mul(P.local,H),D.setLocalTransform(P.local),delete P.local);var B=D.children;if(B&&P.children)while(P.children.length){var j=P.children[0];D.findChild(j.name)||D.addChild(j),P.removeChild(j)}for(var F in P)P.hasOwnProperty(F)&&(D[F]=P[F]);P=null}else k||this.addRootNode(P)}}},e.prototype.loadAreas=function(e){var t=e.data,n=t.areas;if(!n)return;var r=n.length;if(r<=0)return;e.append||delete this.areas;var i=this.areas;i||(i=[],this.areas=i);var s=e.nodesNamePrefix,o=this.md,u=this.planeNormalize,a=i.length,f=Number.MAX_VALUE,l,c;for(var h=0;h<r;h+=1){var p=n[h],d=p.target;s&&(d=s+"/"+d);var v=this.findNode(d);if(!v){a-=1;continue}var m=v.getWorldTransform(),g=m[0],y=m[1],b=m[2],w=m[3],E=m[4],S=m[5],x=m[6],T=m[7],N=m[8],C=m[9],k=m[10],L=m[11],A=f,O=f,M=f,_=-f,D=-f,P=-f,H=p.portals,B=H.length,j=[],F,I,q,R,U,z,W;this.float32ArrayConstructor?(l=new this.float32ArrayConstructor(6+B*13),c=0,W=l.subarray(c,c+6),c+=6):W=new Array(6);for(var X=0;X<B;X+=1){var V=f,$=f,J=f,K=-f,Q=-f,G=-f,Y=0,Z=0,et=0;F=H[X],I=F.points,R=I.length,q=[];for(U=0;U<R;U+=1){z=I[U];var tt=z[0],nt=z[1],rt=z[2],it=g*tt+w*nt+x*rt+C,st=y*tt+E*nt+T*rt+k,ot=b*tt+S*nt+N*rt+L;it<V&&(V=it),st<$&&($=st),ot<J&&(J=ot),it>K&&(K=it),st>Q&&(Q=st),ot>G&&(G=ot),Y+=it,Z+=st,et+=ot,q.push(o.v3Build(it,st,ot))}V<A&&(A=V),$<O&&(O=$),J<M&&(M=J),K>_&&(_=K),Q>D&&(D=Q),G>P&&(P=G);var ut=o.v3Cross(o.v3Sub(q[1],q[0]),o.v3Sub(q[2],q[0])),at,ft,lt;this.float32ArrayConstructor?(at=l.subarray(c,c+6),c+=6,ft=l.subarray(c,c+3),c+=3,lt=l.subarray(c,c+4),c+=4):(at=new Array(6),ft=new Array(3),lt=new Array(4)),at[0]=V,at[1]=$,at[2]=J,at[3]=K,at[4]=Q,at[5]=G,ft[0]=Y/R,ft[1]=Z/R,ft[2]=et/R,lt=u(ut[0],ut[1],ut[2],o.v3Dot(ut,q[0]),lt);var ct={area:a+F.area,points:q,origin:ft,extents:at,plane:lt};j.push(ct)}W[0]=A,W[1]=O,W[2]=M,W[3]=_,W[4]=D,W[5]=P;var ht={target:v,portals:j,extents:W,externalNodes:null};i.push(ht)}var pt=t.bspnodes,dt=pt.length,vt=[];vt.length=dt,this.bspNodes=vt,this.float32ArrayConstructor&&(l=new this.float32ArrayConstructor(4*dt),c=0);for(var mt=0;mt<dt;mt+=1){var gt=pt[mt],yt=gt.plane,bt;this.float32ArrayConstructor?(bt=l.subarray(c,c+4),c+=4):bt=new Array(4),bt[0]=yt[0],bt[1]=yt[1],bt[2]=yt[2],bt[3]=-yt[3],vt[mt]={plane:bt,pos:gt.pos,neg:gt.neg}}},e.prototype.load=function(e){var t=this;e.append||(this.clearShapes(),this.semantics={});var n=function(){e.keepLights&&t.loadLights(e),t.loadNodes(e),e.physicsManager&&e.physicsManager.loadNodes(e,t),t.loadAreas(e),t.endLoading(e.onload)};e.graphicsDevice&&this.loadMaterials(e),t.loadSkeletons(e);var r=e.yieldFn;if(r){var i=function(){t.streamShapes(e,n)};r(i)}else n()},e.prototype.planeNormalize=function(t,n,r,i,s){var o=s;if(!o){var u=e.prototype.float32ArrayConstructor;o=u?new u(4):new Array(4)}var a=t*t+n*n+r*r;if(a>0){var f=1/Math.sqrt(a);o[0]=t*f,o[1]=n*f,o[2]=r*f,o[3]=i*f}else o[0]=0,o[1]=0,o[2]=0,o[3]=0;return o},e.prototype.isInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c<0?n:s)+h*(h<0?r:o)+p*(p<0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.isFullyInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c>0?n:s)+h*(h>0?r:o)+p*(p>0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.extractFrustumPlanes=function(e){var t=this.planeNormalize,n=e.viewProjectionMatrix,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=n[12],m=n[13],g=n[14],y=n[15],b=this.frustumPlanes;return b[0]=t(o+r,l+u,d+c,-(y+v),b[0]),b[1]=t(o-r,l-u,d-c,-(y-v),b[1]),b[2]=t(o-i,l-a,d-h,-(y-m),b[2]),b[3]=t(o+i,l+a,d+h,-(y+m),b[3]),this.areas?b.length>4&&(b.length=4):b[4]=t(o-s,l-f,d-p,-(y-g),b[4]),this.nearPlane=t(o+s,l+f,d+p,-(y+g),this.nearPlane),b},e.prototype.calculateHullScreenExtents=function(e,t){var n=function(t,n,r,i,s){var o=t[r],u=n[r],a=t[3],f=n[3],l=0,c=!0;if(i)if(o>a){if(!(u<=f))return;u<f&&(l=(a-o)/(u-o-(f-a)))}else u>f&&(o<a&&(l=(a-o)/(u-o-(f-a))),c=!1);else if(o<-a){if(!(u>=-f))return;u>-f&&(l=(-a-o)/(u-o+(f-a)))}else u<-f&&(o>-a&&(l=(-a-o)/(u-o+(f-a))),c=!1);if(l>0){var h=t[0],p=t[1],d=t[2],v=n[0],m=n[1],g=n[2];s.push([h+l*(v-h),p+l*(m-p),d+l*(g-d),a+l*(f-a)])}c&&s.push(n)},r=1,i=-1,s=1,o=-1,u=e.length;for(var a=0;a<u;a+=1){var f=e[a],l,c,h,p,d;for(var v=0;v<2;v+=1)for(var m=0;m<3;m+=1){l=f.length;if(!l)break;d=[];for(c=0;c<l;c+=1)c<1?h=f[l-1]:h=f[c-1],p=f[c],n(h,p,m,v,d);f=d}l=f.length;for(c=0;c<l;c+=1){h=f[c];var g=h[0],y=h[1],b=h[3];if(b===0)g=g>=0?1:-1,y=y>=0?1:-1;else{var w=1/b;g*=w,y*=w}r>g&&(r=g),i<g&&(i=g),s>y&&(s=y),o<y&&(o=y)}}return r>=i||s>=o?undefined:(r<-1&&(r=-1),i>1&&(i=1),s<-1&&(s=-1),o>1&&(o=1),t||(t=this.float32ArrayConstructor?new this.float32ArrayConstructor(4):new Array(4)),t[0]=r,t[1]=s,t[2]=i,t[3]=o,t)},e.prototype.calculateLightsScreenExtents=function(e){var t=this.visibleLights,n=t.length;if(n>0){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=e.viewProjectionMatrix,T=this.calculateHullScreenExtents,N=this.md,C=N.m44Transform,k=N.m43MulM44,L=N.v4Build,A=L.call(N,-1,-1,1,1),O=L.call(N,1,-1,1,1),M=L.call(N,-1,1,1,1),_=L.call(N,1,1,1,1),D=0;do{w=t[D],E=w.light;if(E){if(E.global)continue;r=w.node.world,E.spot?(i=N.m33MulM43(E.frustum,r,i),S=k.call(N,i,x,S),l=C.call(N,S,A,l),c=C.call(N,S,O,c),h=C.call(N,S,M,h),p=C.call(N,S,_,p),y=L.call(N,r[9],r[10],r[11],1,y),y=C.call(N,x,y,y),b=[[y,l,c],[y,c,p],[y,h,l],[y,p,h],[h,p,c,l]]):(s=E.halfExtents,E.fog||(o=E.center,o&&(r=i=N.m43Offset(r,o,i))),u=s[0],a=s[1],f=s[2],S=k.call(N,r,x,S),l=C.call(N,S,L.call(N,-u,-a,-f,1,l),l),c=C.call(N,S,L.call(N,+u,-a,-f,1,c),c),h=C.call(N,S,L.call(N,+u,-a,+f,1,h),h),p=C.call(N,S,L.call(N,-u,-a,+f,1,p),p),d=C.call(N,S,L.call(N,-u,+a,-f,1,d),d),v=C.call(N,S,L.call(N,+u,+a,-f,1,v),v),m=C.call(N,S,L.call(N,+u,+a,+f,1,m),m),g=C.call(N,S,L.call(N,-u,+a,+f,1,g),g),b=[[p,h,c,l],[d,v,m,g],[l,c,v,d],[g,m,h,p],[d,g,p,l],[c,h,m,v]]),w.screenExtents=T(b,w.screenExtents)}D+=1}while(D<n)}},e.prototype.destroy=function(){this.clear(),this.vertexBufferManager&&(this.vertexBufferManager.destroy(),delete this.vertexBufferManager),this.indexBufferManager&&(this.indexBufferManager.destroy(),delete this.indexBufferManager)},e.prototype.getQueryCounter=function(){var e=this.queryCounter;return this.queryCounter=e+1,e},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}();(function(){var e,t;typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(p.prototype.uint16ArrayConstructor=Uint16Array)),typeof Uint32Array!="undefined"&&(e=new Uint32Array(4),t=Object.prototype.toString.call(e),t==="[object Uint32Array]"&&(p.prototype.uint32ArrayConstructor=Uint32Array)),typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(p.prototype.float32ArrayConstructor=Float32Array))})();var d=function(){function e(){}return e.create=function(t){var n=new e;return n.name=t,n.geometryType={},n.numMaterials=0,n.materialsMap={},n},e.prototype.hashMaterial=function(e){var t=e.texturesNames,n=[],r=0;for(var i in t)t.hasOwnProperty(i)&&(n[r]=t[i],r+=1);if(1<r)return n.sort(),n.join(",");if(0<r)return n[0];var s=e.techniqueParameters.materialColor;if(s){var o=s.length,u;for(u=0;u<o;u+=1)n[u]=s[u].toFixed(3).replace(".000","");return n.join(",")}return e.name},e.prototype.prepareMaterial=function(e){var t=this.hashMaterial(e),n=this.materialsMap[t];n===undefined&&(n=this.numMaterials,this.numMaterials+=1,this.materialsMap[t]=n),e.meta.materialIndex=n,e.effect=this},e.prototype.add=function(e,t){this.geometryType[e]=t},e.prototype.remove=function(e){delete this.geometryType[e]},e.prototype.get=function(e){return this.geometryType[e]},e.prototype.prepare=function(e){var t=this.geometryType[e.geometryType];t&&t.prepare(e)},e.version=1,e}(),v=function(){function e(){}return e.create=function(){var t=new e;return t.effects={},t},e.prototype.add=function(e){this.effects[e.name]=e},e.prototype.remove=function(e){delete this.effects[e]},e.prototype.map=function(e,t){this.effects[e]=this.effects[t]},e.prototype.get=function(e){var t=this.effects[e];return t?t:this.effects["default"]},e.version=1,e}(),m=function(){function e(){}return e.prototype.get=function(e){return null},e.create=function(t,n,r,i,s){function g(e){var t=e.parameters,n=e.techniques,r=e.programs,i,s,o,u,a,f,l,c,h,p,d,v,g,y,b;for(i in t)if(t.hasOwnProperty(i)){s=m[i];if(s!==undefined){t[i].rows=s,o={};for(u in n)if(n.hasOwnProperty(u)){a=n[u],f=a.length;for(l=0;l<f;l+=1){c=a[l];if(c.parameters.indexOf(i)!==-1){h=c.programs,p=h.length;for(d=0;d<p;d+=1)o[h[d]]=!0}}}v=new RegExp("uniform\\s+(\\w+)\\s+"+i+"\\s*\\[[^\\]]+\\]","mg"),g="uniform $1 "+i+"["+s+"]";for(y in o)o.hasOwnProperty(y)&&(b=r[y],b.code=b.code.replace(v,g))}}}i||(i=function(){});var o="default",u;if(r)u=r;else{var a={version:1,name:"default.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},diffuse:{type:"sampler2D"}},techniques:{textured3D:[{parameters:["worldViewProjection","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!0,CullFaceEnable:!0,CullFace:1029,BlendEnable:!1},programs:["vp","fp"]}]},programs:{fp:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];vec4 _ret_0;uniform sampler2D diffuse;void main()\n{_ret_0=texture2D(diffuse,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OUTpos1;vec2 _OUTuv1;uniform vec4 worldViewProjection[4];void main()\n{_OUTpos1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[1]+ATTR0.zzzz*worldViewProjection[2]+worldViewProjection[3];_OUTuv1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OUTpos1;}"}}};u=t.createShader(a),u||i("Default shader not created.")}var f={},l={},c={},h=0,p=null,d="",v=!1,m={};f[o]=u;var y=function(r,o){r===undefined&&i("Invalid texture path passed to ShaderManager.Load");var a=f[r];if(!a){if(!l[r]){l[r]=!0,h+=1;var m=T.create();c[r]=m,o&&m.subscribe(o);var y=function(n){if(n){var i=JSON.parse(n);v&&g(i);var o=t.createShader(i);o?f[r]=o:delete f[r],m.notify(o),delete c[r]}else s&&(s.innerHTML+="ShaderManager.load:&nbsp;'"+r+"' failed to load<br>"),delete f[r];delete l[r],h-=1};n.request({src:p&&p[r]||d+r,onload:y})}else o&&c[r].subscribe(o);return u}return o&&TurbulenzEngine.setTimeout(function(){o(a)},0),a},b=function(t,n){f[t]=f[n]},w=function(t){var n=f[t];return n?n:u},E=function(t){typeof f[t]!="undefined"&&delete f[t]},S=function(t,n){E(t),y(t,n)},x=new e;return s?(x.load=function(t,n){return s.innerHTML+="ShaderManager.load:&nbsp;'"+t+"'<br>",y(t,n)},x.map=function(t,n){s.innerHTML+="ShaderManager.map:&nbsp;'"+n+"' -> '"+t+"'<br>",b(t,n)},x.get=function(t){return s.innerHTML+="ShaderManager.get:&nbsp;'"+t+"'<br>",w(t)},x.remove=function(t){s.innerHTML+="ShaderManager.remove:&nbsp;'"+t+"'<br>",E(t)},x.reload=function(t,n){s.innerHTML+="ShaderManager. reload:&nbsp;'"+t+"'<br>",S(t,n)}):(x.load=y,x.map=b,x.get=w,x.remove=E,x.reload=S),x.reloadAll=function(){for(var t in f)f.hasOwnProperty(t)&&t!==o&&S(t)},x.getAll=function(){return f},x.getNumPendingShaders=function(){return h},x.isShaderLoaded=function(t){return!l[t]},x.isShaderMissing=function(t){return!f[t]},x.setPathRemapping=function(t,n){p=t,d=n},x.setAutomaticParameterResize=function(t,n){v=!0,m[t]=n},x.destroy=function(){if(f){var r;for(r in f)if(f.hasOwnProperty(r)){var i=f[r];i&&i.destroy()}f=null}u=null,l=null,c=null,h=0,p=null,d=null,n=null,t=null},x},e.version=1,e}(),g=function(){function e(){}return e.prototype.setTexture=function(e){this.texture=e,this.textureChangedObserver&&this.textureChangedObserver.notify(this)},e.prototype.getTexture=function(){return this.texture},e.prototype.subscribeTextureChanged=function(e){this.textureChangedObserver||(this.textureChangedObserver=T.create()),this.textureChangedObserver.subscribe(e)},e.prototype.unsubscribeTextureChanged=function(e){this.textureChangedObserver.unsubscribe(e)},e.prototype.destroy=function(){this.texture.name!=="default"&&this.texture.destroy(),delete this.texture,delete this.textureChangedObserver},e.create=function(t,n){var r=new e;return r.name=t,r.texture=n,r.reference=L.create(r),r},e.version=1,e}(),y=function(){function e(){}return e.prototype.add=function(e,t,n){var r=this.textureInstances[e];r?r.setTexture(t):(this.textureInstances[e]=g.create(e,t),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),n&&(this.internalTexture[e]=!0,this.textureInstances[e].reference.add())},e.prototype.get=function(e){var t=this.textureInstances[e];return t?t.getTexture():this.defaultTexture},e.prototype.getInstance=function(e){return this.textureInstances[e]},e.prototype.load=function(e,t,n){var r=this;e===undefined&&this.errorCallback("Invalid texture path passed to TextureManager.Load");var i=this.textureInstances[e];if(!i||i.texture===this.defaultTexture&&e!=="default"){i||this.add(e,this.defaultTexture,!1);if(e in this.loadingTexture)n&&this.loadedTextureObservers[e].subscribe(n);else{if(0!==this.numLoadingArchives)return this.delayedTextures[e]={nomipmaps:t,onload:n},this.get(e);this.loadingTexture[e]=!0,this.numLoadingTextures+=1;var s=!0;t&&(s=!1);var o=T.create();this.loadedTextureObservers[e]=o,n&&o.subscribe(n);var u=function(n,i){i===200&&n&&r.add(e,n,!1),o.notify(n),delete r.loadedTextureObservers[e],delete r.loadingTexture[e],r.numLoadingTextures-=1},a=function(t,n){var i=r.graphicsDevice.createTexture({src:t,mipmaps:s,onload:n});i||r.errorCallback("Texture '"+t+"' not created.")};this.requestHandler.request({src:this.pathRemapping&&this.pathRemapping[e]||this.pathPrefix+e,requestFn:a,onload:u})}return this.get(e)}var f=this.get(e);return n&&TurbulenzEngine.setTimeout(function(){n(f)},0),f},e.prototype.map=function(e,t){this.textureInstances[e]?this.textureInstances[e].setTexture(this.textureInstances[t].getTexture()):(this.textureInstances[e]=g.create(e,this.textureInstances[t].getTexture()),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),this.internalTexture[e]=!0},e.prototype.remove=function(e){this.internalTexture[e]||e in this.textureInstances&&(this.textureInstances[e].reference.unsubscribeDestroyed(this.onTextureInstanceDestroyed),delete this.textureInstances[e])},e.prototype.loadArchive=function(e,t,n,r){var i=this,s=this.archivesLoaded[e];if(!s)if(e in this.loadingArchives)n&&this.loadedArchiveObservers[e].subscribe(function(){var s=i.archivesLoaded[e],o=s.textures,u;for(u in o)o.hasOwnProperty(u)&&n(o[u]);r&&r(s)});else{var o=!0;t&&(o=!1),this.loadingArchives[e]={textures:{}},this.numLoadingArchives+=1;var u=T.create();this.loadedArchiveObservers[e]=u,r&&u.subscribe(r);var a=function(n,r){var s;r===200&&n&&(s={textures:i.loadingArchives[e].textures},i.archivesLoaded[e]=s),u.notify(s),delete i.loadedArchiveObservers[e],delete i.loadingArchives[e],i.numLoadingArchives-=1;if(0===i.numLoadingArchives){var o;for(o in i.delayedTextures)if(i.delayedTextures.hasOwnProperty(o)){var a=i.delayedTextures[o];i.load(o,a.nomipmaps,a.onload)}i.delayedTextures={}}},f=function(r,s){var u=function(r){var s=r.name;if(!(s in i.textureInstances)||i.textureInstances[s].texture===i.defaultTexture)i.add(s,r,!1),i.loadingArchives[e].textures[s]=r;n&&n(r),delete i.delayedTextures[s],e in i.loadingTexture&&(delete i.loadingTexture[e],i.numLoadingTextures-=1)};i.graphicsDevice.loadTexturesArchive({src:r,mipmaps:o,ontextureload:u,onload:s})||i.errorCallback("Archive '"+e+"' not loaded.")};i.requestHandler.request({src:i.pathRemapping&&i.pathRemapping[e]||i.pathPrefix+e,requestFn:f,onload:a})}else if(n){var l=s.textures,c=0,h=function(t){return function(){n(t),c-=1,c===0&&r&&r(s)}},p;for(p in l)l.hasOwnProperty(p)&&(c+=1,TurbulenzEngine.setTimeout(h(l[p]),0))}},e.prototype.isArchiveLoaded=function(e){return e in this.archivesLoaded},e.prototype.removeArchive=function(e){if(e in this.archivesLoaded){var t=this.archivesLoaded[e].textures,n;for(n in t)t.hasOwnProperty(n)&&this.remove(n);delete this.archivesLoaded[e]}},e.prototype.getAll=function(){return this.textureInstances},e.prototype.getNumPendingTextures=function(){return this.numLoadingTextures+this.numLoadingArchives},e.prototype.isTextureLoaded=function(e){return!(e in this.loadingTexture)&&!(e in this.delayedTextures)},e.prototype.isTextureMissing=function(e){return!(e in this.textureInstances)},e.prototype.setPathRemapping=function(e,t){this.pathRemapping=e,this.pathPrefix=t},e.prototype.addProceduralTexture=function(e){var t=e.name,n=this.graphicsDevice.createTexture(e);n?this.add(t,n,!0):this.errorCallback("Failed to create '"+t+"' texture.")},e.prototype.destroy=function(){if(this.textureInstances){var e;for(e in this.textureInstances)if(this.textureInstances.hasOwnProperty(e)){var t=this.textureInstances[e];t&&t.destroy()}this.textureInstances=null}this.defaultTexture&&(this.defaultTexture.destroy(),this.defaultTexture=null),this.loadingTexture=null,this.loadedTextureObservers=null,this.delayedTextures=null,this.numLoadingTextures=0,this.archivesLoaded=null,this.loadingArchives=null,this.loadedArchiveObservers=null,this.numLoadingArchives=0,this.internalTexture=null,this.pathRemapping=null,this.pathPrefix=null,this.requestHandler=null,this.graphicsDevice=null},e.create=function(t,n,r,i,s){var o=new e;i||(i=function(){});var u="default",a;r?a=r:(a=t.createTexture({name:u,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),a||i("Default texture not created.")),o.textureInstances={},o.loadingTexture={},o.loadedTextureObservers={},o.delayedTextures={},o.numLoadingTextures=0,o.archivesLoaded={},o.loadingArchives={},o.loadedArchiveObservers={},o.numLoadingArchives=0,o.internalTexture={},o.pathRemapping=null,o.pathPrefix="",o.graphicsDevice=t,o.requestHandler=n,o.defaultTexture=a,o.errorCallback=i;var f=function(t){t.reference.unsubscribeDestroyed(f),delete o.textureInstances[t.name]};o.onTextureInstanceDestroyed=f,s&&(o.add=function(n,r){return s.innerHTML+="TextureManager.add:&nbsp;'"+n+"'",e.prototype.add.call(o,n,r)},o.load=function(n,r){return s.innerHTML+="TextureManager.load:&nbsp;'"+n+"'",e.prototype.load.call(o,n,r)},o.loadArchive=function(n,r){return s.innerHTML+="TextureManager.loadArchive:&nbsp;'"+n+"'",e.prototype.loadArchive.call(o,n,r)},o.isArchiveLoaded=function(n){return s.innerHTML+="TextureManager.isArchiveLoaded:&nbsp;'"+n+"'",e.prototype.isArchiveLoaded.call(o,n)},o.removeArchive=function(n){return s.innerHTML+="TextureManager.removeArchive:&nbsp;'"+n+"'",e.prototype.removeArchive.call(o,n)},o.map=function(n,r){s.innerHTML+="TextureManager.map:&nbsp;'"+r+"' -> '"+n+"'",e.prototype.map.call(o,n,r)},o.get=function(n){return s.innerHTML+="TextureManager.get:&nbsp;'"+n+"'",e.prototype.get.call(o,n)},o.getInstance=function(n){return s.innerHTML+="TextureManager.getInstance:&nbsp;'"+n+"'",e.prototype.getInstance.call(o,n)},o.remove=function(n){s.innerHTML+="TextureManager.remove:&nbsp;'"+n+"'",e.prototype.remove.call(o,n)}),o.add(u,a,!0),o.addProceduralTexture({name:"white",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]}),o.addProceduralTexture({name:"black",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]}),o.addProceduralTexture({name:"flat",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[128,128,255,255,128,128,255,255,128,128,255,255,128,128,255,255]});var l=Math.abs,c,h,p=[];for(h=0;h<4;h+=1)for(c=0;c<32;c+=1){var d=(c+.5)*(2/32)-1;d=l(d)-1/32;var v=1-d*2+d*d;v<=0?p.push(0):v>=1?p.push(255):p.push(v*255)}o.addProceduralTexture({name:"quadratic",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:p}),p=null;var m=[];for(h=0;h<4;h+=1){m.push(0);for(c=1;c<31;c+=1)m.push(255);m.push(0)}return o.addProceduralTexture({name:"nofalloff",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:m}),m=null,o},e.version=1,e}(),b=function(t){var n=b,r=n.techniquesIndexMap[t];return r===undefined&&(r=n.numTechniques,n.techniquesIndexMap[t]=r,n.numTechniques+=1),r};b.techniquesIndexMap={},b.numTechniques=0;var S=function(t){var n=this.array;n[n.length]=t},x=function(){function e(){}return e.prototype.updateShader=function(){},e.prototype.sortRenderablesAndLights=function(t,n){var r=e.passIndex.opaque,i=e.passIndex.decal,s=e.passIndex.transparent,o=this.passes,u=o[r],a=o[i],f=o[s],l=0,c=0,h=0,p,d,v,m,g=n.getCurrentVisibleRenderables(),y=g.length;if(y>0){var b,w,E=0;do{b=g[E];if(!b.renderUpdate){var S=b.sharedMaterial.effect;S.prepare&&S.prepare(b)}b.renderUpdate(t),p=b.drawParameters,d=p.length;for(m=0;m<d;m+=1)v=p[m],w=v.userData.passIndex,w===r?(u[l]=v,l+=1):w===s?(b.sharedMaterial.meta.far?v.sortKey=1e38:v.sortKey=b.distance,f[h]=v,h+=1):w===i&&(a[c]=v,c+=1);E+=1}while(E<y)}u.length=l,a.length=c,f.length=h},e.prototype.update=function(e,t,n,r){n.updateVisibleNodes(t),this.sortRenderablesAndLights(t,n);var i=t.matrix;i[9]!==this.eyePosition[0]||i[10]!==this.eyePosition[1]||i[11]!==this.eyePosition[2]?(this.eyePositionUpdated=!0,this.eyePosition[0]=i[9],this.eyePosition[1]=i[10],this.eyePosition[2]=i[11]):this.eyePositionUpdated=!1,this.globalTechniqueParameters.time=r,this.camera=t,this.scene=n},e.prototype.updateBuffers=function(e,t,n){return!0},e.prototype.draw=function(t,n,r,i,s){t.clear(n,1,0);if(this.wireframe)this.scene.drawWireframe(t,this.sm,this.camera,this.wireframeInfo),r&&r(),i&&i();else{var o=this.globalTechniqueParametersArray,u=this.passes;t.drawArray(u[e.passIndex.opaque],o,-1),t.drawArray(u[e.passIndex.decal],o,-1),r&&r(),t.drawArray(u[e.passIndex.transparent],o,1),i&&i()}s&&s(),this.lightPositionUpdated=!1},e.prototype.setGlobalLightPosition=function(e){this.lightPositionUpdated=!0,this.lightPosition[0]=e[0],this.lightPosition[1]=e[1],this.lightPosition[2]=e[2]},e.prototype.setGlobalLightColor=function(e){this.globalTechniqueParameters.lightColor=e},e.prototype.setAmbientColor=function(e){this.globalTechniqueParameters.ambientColor=e},e.prototype.setDefaultTexture=function(e){this.globalTechniqueParameters.diffuse=e},e.prototype.setWireframe=function(e,t){this.wireframeInfo=t,this.wireframe=e},e.prototype.getDefaultSkinBufferSize=function(){return this.defaultSkinBufferSize},e.prototype.destroy=function(){delete this.globalTechniqueParametersArray,delete this.globalTechniqueParameters,delete this.lightPosition,delete this.eyePosition,delete this.passes},e.defaultPrepareFn=function(t){var n=TurbulenzEngine.getGraphicsDevice().createDrawParameters();n.userData={},t.drawParameters=[n],t.prepareDrawParameters(n);var r=t.sharedMaterial,i=t.techniqueParameters;!r.techniqueParameters.materialColor&&!i.materialColor&&(r.techniqueParameters.materialColor=e.v4One),!r.techniqueParameters.uvTransform&&!i.uvTransform&&(r.techniqueParameters.uvTransform=e.identityUVTransform),n.technique=this.technique,n.setTechniqueParameters(0,r.techniqueParameters),n.setTechniqueParameters(1,i),r.meta.decal?n.userData.passIndex=e.passIndex.decal:r.meta.transparent?n.userData.passIndex=e.passIndex.transparent:n.userData.passIndex=e.passIndex.opaque;var s=t.node;if(!s.rendererInfo){var o=TurbulenzEngine.getMathDevice();s.rendererInfo={id:e.nextRenderinfoID,frameVisible:-1,worldUpdate:-1,worldViewProjection:o.m44BuildIdentity(),worldInverse:o.m43BuildIdentity(),eyePosition:o.v3BuildZero(),lightPosition:o.v3BuildZero()},e.nextRenderinfoID+=1}var u=s.rendererInfo;i.worldViewProjection=u.worldViewProjection,i.lightPosition=u.lightPosition;var a=this.technique.name;a.indexOf("flat")===-1&&a.indexOf("lambert")===-1&&(i.eyePosition=u.eyePosition);var f=t.skinController;f?(i.skinBones=f.output,f.index===undefined&&(f.index=e.nextSkinID,e.nextSkinID+=1),n.sortKey=-w(this.techniqueIndex,f.index,r.meta.materialIndex)):n.sortKey=w(this.techniqueIndex,r.meta.materialIndex,u.id),t.renderUpdate=this.update},e.create=function(t,n,r,i){var s=new e;s.md=n,s.sm=r,s.lightPositionUpdated=!0,s.lightPosition=n.v3Build(1e3,1e3,0),s.eyePositionUpdated=!0,s.eyePosition=n.v3BuildZero(),s.globalTechniqueParameters=t.createTechniqueParameters({lightColor:n.v3BuildOne(),ambientColor:n.v3Build(.2,.2,.3),time:0}),s.globalTechniqueParametersArray=[s.globalTechniqueParameters],s.passes=[[],[],[]];var o=function(t){var n=t.getParameter("skinBones");s.defaultSkinBufferSize=n.rows*n.columns};r.load("shaders/defaultrendering.cgfx",o),r.load("shaders/debug.cgfx");var u=function(t,r,i){var o=s.lightPositionUpdated,u=s.eyePositionUpdated,a=t.world;r.worldUpdate!==t.worldUpdate&&(r.worldUpdate=t.worldUpdate,o=!0,u=!0,r.worldInverse=n.m43Inverse(a,r.worldInverse)),o&&(r.lightPosition=n.m43TransformPoint(r.worldInverse,s.lightPosition,r.lightPosition)),u&&(r.eyePosition=n.m43TransformPoint(r.worldInverse,s.eyePosition,r.eyePosition)),r.worldViewProjection=n.m43MulM44(a,i.viewProjectionMatrix,r.worldViewProjection)},a=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,u(n,r,t))},f=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,u(n,r,t));var i=this.skinController;i&&i.update()},l=function(t){var r=this.node.world,i=this.techniqueParameters;i.worldViewProjection=n.m43MulM44(r,t.viewProjectionMatrix,i.worldViewProjection),i.worldInverseTranspose=n.m33InverseTranspose(r,i.worldInverseTranspose)},c=function(t){var r=this.node.world,i=this.techniqueParameters;i.worldViewProjection=n.m43MulM44(r,t.viewProjectionMatrix,i.worldViewProjection),i.worldInverseTranspose=n.m33InverseTranspose(r,i.worldInverseTranspose);var s=this.skinController;s&&s.update()},h=function(t){var r=this.node,i=r.rendererInfo;i.frameVisible!==r.frameVisible&&(i.frameVisible=r.frameVisible,u(r,i,t));if(i.worldUpdateEnv!==r.worldUpdate){i.worldUpdateEnv=r.worldUpdate;var s=r.world;i.worldInverseTranspose=n.m33InverseTranspose(s,i.worldInverseTranspose)}var o=this.techniqueParameters;o.worldInverseTranspose=i.worldInverseTranspose},p=function(t){h.call(this,t);var n=this.skinController;n&&n.update()},v=function(n){e.defaultPrepareFn.call(this,n);var r=n.techniqueParameters;r.constantColor=n.sharedMaterial.meta.constantColor},m=function(i){e.defaultPrepareFn.call(this,i);var s=i.sharedMaterial.techniqueParameters,o=s.diffuse;o===undefined?s.materialColor||(s.materialColor=n.v4BuildOne()):o.length===4&&(s.materialColor=n.v4Build.apply(n,o),o=s.diffuse_map,s.diffuse=o);if(!o){var u=r.get("shaders/defaultrendering.cgfx");i.geometryType==="skinned"?i.drawParameters[0].technique=u.getTechnique("flat_skinned"):i.drawParameters[0].technique=u.getTechnique("flat")}},g=function(r){e.defaultPrepareFn.call(this,r);var i=r.sharedMaterial.techniqueParameters,s=i.diffuse;s===undefined?i.materialColor||(i.materialColor=n.v4BuildOne()):s.length===4&&(i.materialColor=n.v4Build.apply(n,s),i.diffuse=undefined)},y=function(t){var n=this,r=function(t){n.shader=t,n.technique=t.getTechnique(n.techniqueName),n.techniqueIndex=n.technique.id};t.load(this.shaderName,r)};s.defaultPrepareFn=m,s.defaultUpdateFn=a,s.defaultSkinnedUpdateFn=f,s.loadTechniquesFn=y;var b,w,E="skinned",S="rigid";return b=d.create("constant"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("constant_nocull"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_nocull",update:a,loadTechniques
:y},w.loadTechniques(r),b.add(S,w),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"flat_skinned_nocull",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("lambert"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lambert",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lambert_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("blinn"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("blinn_nocull"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_nocull",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blinn_skinned_nocull",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("phong"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"phong",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"phong_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("debug_lines_constant"),i.add(b),w={prepare:v,shaderName:"shaders/debug.cgfx",techniqueName:"debug_lines_constant",update:l,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("debug_normals"),i.add(b),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_normals",update:l,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_normals_skinned",update:c,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("debug_tangents"),i.add(b),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_tangents",update:l,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_tangents_skinned",update:c,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("debug_binormals"),i.add(b),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_binormals",update:l,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:e.defaultPrepareFn,shaderName:"shaders/debug.cgfx",techniqueName:"debug_binormals_skinned",update:c,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap_specularmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap_specularmap_alphamap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphamap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("normalmap_alphatest"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_alphatest",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_alphatest_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap_specularmap_alphatest"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap_glowmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_glowmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_glowmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("normalmap_specularmap_glowmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap_specularmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap_alphatest"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap_specularmap_alphatest"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap_glowmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("rxgb_normalmap_specularmap_glowmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("add"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("add_particle"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add_particle",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("blend"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("blend_particle"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"blend_particle",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("translucent"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("translucent_particle"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"translucent_particle",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("filter"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"filter",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"filter_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("invfilter"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"invfilter",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("invfilter_particle"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"invfilter_particle",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("glass"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glass",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("glass_env"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glass_env",update:h,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("modulate2"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"modulate2",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"modulate2_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("skybox"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"skybox",update:h,loadTechniques:y},w.loadTechniques(r),b.add(S,w),b=d.create("env"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"env",update:h,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"env_skinned",update:p,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("flare"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"add",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),i.map("default","blinn"),b=d.create("glowmap"),i.add(b),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glowmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),w={prepare:g,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"glowmap_skinned",update:f,loadTechniques:y},w.loadTechniques(r),b.add(E,w),b=d.create("lightmap"),i.add(b),w={prepare:m,shaderName:"shaders/defaultrendering.cgfx",techniqueName:"lightmap",update:a,loadTechniques:y},w.loadTechniques(r),b.add(S,w),s},e.version=1,e.numPasses=3,e.passIndex={opaque:0,decal:1,transparent:2},e.nextRenderinfoID=0,e.nextSkinID=0,e.v4One=new Float32Array([1,1,1,1]),e.identityUVTransform=new Float32Array([1,0,0,1,0,0]),e}(),T=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var t=new e;return t.subscribers=[],t},e}(),N=function(){function e(){}return e.prototype.clear=function(){this.nodesMap={},this.referencesPending={},this.numReferencesPending=0,this.animationsPending={}},e.prototype.endLoading=function(e){this.referencesPending={},this.animationsPending={},e&&e(this.data)},e.prototype.resolveShapes=function(e){var t=function(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},n=e.shapesNamePrefix,r=e.shapesNamePrefix,i=e.data,s=i.geometries,o=this.data.geometries;o||(o={},this.data.geometries=o);for(var u in s)if(s.hasOwnProperty(u)){var a=s[u],f=n?n+"-"+u:u,l=a.skeleton;l?(o[f]=t(a),o[f].skeleton=r?r+"-"+l:l):o[f]=a}},e.prototype.resolveSkeletons=function(e){var t=e.shapesNamePrefix,n=e.data,r=n.skeletons,i=this.data.skeletons;i||(i={},this.data.skeletons=i);for(var s in r)if(r.hasOwnProperty(s)){var o=r[s],u=t?t+"-"+s:s;i[u]=o}},e.prototype.resolveAnimations=function(e){var t=e.data,n=t.animations;if(!n)return;var r=this,i=r.data.animations;i||(i={},r.data.animations=i);var s=function(n){if(n){var s=JSON.parse(n),o=s.animations;for(var u in o)o.hasOwnProperty(u)&&(i[u]=o[u])}r.numReferencesPending-=1,r.numReferencesPending<=0&&r.endLoading(e.onload)},o=e.request?e:TurbulenzEngine;for(var u in n)if(n.hasOwnProperty(u)){var a=n[u].reference;a?this.animationsPending[u]||(this.animationsPending[u]=!0,this.numReferencesPending+=1,delete n[u].reference,e.requestHandler.request({src:a,requestOwner:o,onload:s})):i[u]=n[u]}},e.prototype.resolveNodes=function(e){var n=e.data,r=this.referencesPending,i=0,s=this.nodesMap,o=this,u=e.nodesNamePrefix,a=e.shapesNamePrefix,f=e.request?e:TurbulenzEngine,l=function(t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);return n},c=function(n,u,h){var p=l(n),d=h?h+"/"+u:u,v=p.reference;if(v){var m=v.indexOf("#");if(m===-1){var g=r[v];if(!g||g.length===0||!p.inplace){i+=1;var y=l(e);y.append=!0,p.inplace?(y.nodesNamePrefix=h,y.shapesNamePrefix=null,y.parentNode=null):(y.nodesNamePrefix=d,y.shapesNamePrefix=v,y.parentNode=p),p.skin&&(y.skin=p.skin);if(!g||g.length===0){g=[y],r[v]=g;var b=function(e){var t=g.length,n;e?n=JSON.parse(e):n={};var r;for(var i=0;i<t;i+=1)r=g[i],r.data=n,r.isReference=!0,o.resolve(r);g.length=0};e.requestHandler.request({src:v,requestOwner:f,onload:b})}else g.push(y)}}delete p.reference,delete p.inplace}var w=p.geometryinstances;if(a&&w){p.geometryinstances={};for(var E in w)if(w.hasOwnProperty(E)){p.geometryinstances[E]=l(w[E]);var S=p.geometryinstances[E];S.geometry=a+"-"+S.geometry}}var x=n.nodes;if(x){p.nodes={};for(var T in x)if(x.hasOwnProperty(T)){var N=d+"/"+T;s[N]||(p.nodes[T]=c(x[T],T,d),s[N]=p.nodes[T])}}return p},h=n.nodes,p=e.parentNode;for(var d in h)if(h.hasOwnProperty(d)&&h[d]){var v=d,m=c(h[d],v,u),g=u?u+"/"+d:d,y=s[g];if(y){var b=y.matrix;b&&m.matrix&&(y.matrix=t.m43Mul(m.matrix,b),b=null);var w=y.nodes;if(w&&m.nodes)for(var E in m.nodes)m.nodes.hasOwnProperty(E)&&(w[E]=m.nodes[E]);else m.nodes&&(y.nodes=m.nodes);for(var S in m)m.hasOwnProperty(S)&&(y[S]=m[S]);m=y}else e.isReference&&p?(p.nodes||(p.nodes={}),p.nodes[d]=m):this.data.nodes[d]=m,s[g]=m}this.numReferencesPending+=i},e.prototype.resolvePhysicsNodes=function(e){function i(e){var t=function(){};return t.prototype=e,new t}var t=e.data,n=e.nodesNamePrefix,r=e.shapesNamePrefix,s=t.physicsmodels,o=this.data.physicsmodels;o||(o={},this.data.physicsmodels=o);for(var u in s)if(s.hasOwnProperty(u)){var a=s[u];if(r){var f=r?r+"-"+u:u,l=i(a);o[f]=l;var c=l.geometry;c&&(l.geometry=r?r+"-"+c:c)}else o[u]=a}var h=t.physicsnodes,p=this.data.physicsnodes;p||(p={},this.data.physicsnodes=p);for(var d in h)if(h.hasOwnProperty(d)){var v=h[d];if(n||r){var m=v.target;m=n?n+"/"+m:m;var g=i(v);g.target=m,g.body=r?r+"-"+v.body:v.body;var y=n?n+"/"+d:d;p[y]=g}else p[d]=v}},e.prototype.resolveAreas=function(e){var t=e.data,n=t.areas;if(!n)return;var r=n.length;if(r<=0)return;var i=this.data.areas;i||(i=[],this.data.areas=i);var s=e.nodesNamePrefix;for(var o=0;o<r;o+=1){var u=n[o];if(s){var a=u.target;u.target=s+"/"+a}i.push(u)}},e.prototype.resolve=function(e){e.append||(this.data={nodes:{}});var t=e.data;for(var n in t)if(n!=="nodes"&&n!=="skeletons"&&n!=="geometries"&&n!=="animations"&&n!=="areas"&&n!=="physicsnodes"&&n!=="physicsmodels"&&t.hasOwnProperty(n)){var r=t[n],i=this.data[n];if(!i)this.data[n]=r;else for(var s in r)r.hasOwnProperty(s)&&!i[s]&&(i[s]=r[s])}this.resolveShapes(e),this.resolveSkeletons(e),this.resolveAnimations(e),this.resolveNodes(e),this.resolvePhysicsNodes(e),this.resolveAreas(e),e.isReference&&(this.numReferencesPending-=1),this.numReferencesPending<=0&&this.endLoading(e.onload)},e.prototype.load=function(e,t){var n=this,r=function(r){var i={};r&&(i=JSON.parse(r)),t.data=i,t.append=!1,n.resolve(t)};t.requestHandler.request({src:e,requestOwner:t.request?t:TurbulenzEngine,onload:r})},e.create=function(){var t=new e;return t.clear(),t.skeletonNames={},t},e.version=1,e}(),C={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",r=t.method,i=t.data||{},s=t.encrypt,o=null,u=t.url,a=t.requestHandler,f=t.callback;if(s){i.requestUrl=u;var l=JSON.stringify(i);r==="POST"&&(l=TurbulenzEngine.encrypt(l)),n+="data="+encodeURIComponent(l)+"&",n+="gameSessionId="+encodeURIComponent(i.gameSessionId),o=TurbulenzEngine.generateSignature(l)}else if(i){var c;for(c in i)i.hasOwnProperty(c)&&(n.length!==0&&(n+="&"),r==="POST"?n+=c+"="+i[c]:n+=encodeURIComponent(c)+"="+encodeURIComponent(i[c]))}var h=function(t,n){var r=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;if(r.getResponseHeader("Content-Type")!=="application/json; charset=utf-8")TurbulenzEngine.setTimeout(function(){f({msg:"HttpStatus "+n+" "+C.ajaxStatusCodes[n]},n),f=null},0);else{var i=JSON.parse(t);if(s){var o=r.getResponseHeader("X-TZ-Signature"),a=TurbulenzEngine.verifySignature(t,o);t=null,TurbulenzEngine.setTimeout(function(){var e=i.requestUrl;if(a)if(!TurbulenzEngine.encryptionEnabled||e===u){f(i,n),f=null;return}n===400?f(i,n,"Verification Failed"):f({msg:"Verification failed",ok:!1},400,"Verification Failed"),f=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){f(i,n),f=null},0)}},p=function(i,s,u){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}u.xhr=a;var l=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(u,t,n)}};a.open(r,n&&r!=="POST"?i+"?"+n:i,!0),f&&(a.onreadystatechange=l),o&&a.setRequestHeader("X-TZ-Signature",o),r==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(a)a.request({src:u,requestFn:p,responseFilter:t.responseFilter,onload:h});else{var d={src:u};p(u,h,d)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},k={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},L=function(){function e(){}return e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=T.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){var n=new e;return n.object=t,n.referenceCount=0,n},e.version=1,e}(),A={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,o;for(o in this.profiles)this.profiles.hasOwnProperty(o)&&(i=this.profiles[o],s<i.duration&&(s=i.duration),r.push(i));var u;t===A.sortMode.alphabetical?u=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===A.sortMode.max?u=function(t,n){return n.max-t.max}:t===A.sortMode.min?u=function(t,n){return n.min-t.min}:t===A.sortMode.calls?u=function(t,n){return n.calls-t.calls}:u=function(t,n){return n.duration-t.duration},r.sort(u);var a,f="",l=n?n.precision:8,c=n?n.percentagePrecision:1,h=n?n.seperator:" ",p=r.length,d,v,m;for(m=0;m<p;m+=1)i=r[m],a=i.name,a+=h+i.calls,a+=h+i.duration.toFixed(l),a+=h+i.max.toFixed(l),a+=h+i.min.toFixed(l),v=i.duration/i.calls,a+=h+v.toFixed(l),d=Math.sqrt(i.sumOfSquares/i.calls-v*v),a+=h+d.toFixed(l),a+=h+(100*i.duration/s).toFixed(c)+"%\n",f+=a;return f}},O={};O.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},O.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var M=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480||s===504){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(t){var n=new e;n.initialRetryTime=t.initialRetryTime||500,n.notifyTime=t.notifyTime||4e3,n.maxRetryTime=t.maxRetryTime||8e3,n.notifiedConnectionLost=!1,n.connected=!0,n.reconnectedObserver=T.create(),n.reconnectTest=null,n.onReconnected=t.onReconnected||function(){},n.onRequestTimeout=t.onRequestTimeout||function(){};var r={eventOnload:[]};return n.handlers=r,n},e}(),_=function(){function e(){this.maxVerticesPerVertexBuffer=65535,this.numBuckets=10}return e.prototype.bucket=function(e){if(e<=64)return e<=16?e<=8?0:1:e<=32?2:3;if(e<=512)return e<=256?e<=128?4:5:6;return e<=2048?e<=1024?7:8:9},e.prototype.makeBuckets=function(){var e=[];for(var t=0;t<this.numBuckets;t+=1)e.push({headChunk:null});return e},e.prototype.allocate=function(e,t){var n=null,r=0,i={numVertices:undefined,attributes:t,dynamic:this.dynamicVertexBuffers},s,o=this.maxVerticesPerVertexBuffer,u="",a,f;for(a=0;a<t.length;a+=1)f=t[a],f.name?u+=f.name:typeof f=="number"?u+=f:u+=f.toString(),u+=",";var l=this.vertexBuffersPools.length,c;for(s=0;s<l;s+=1)if(this.vertexBuffersPools[s].attributesHash===u){c=this.vertexBuffersPools[s];break}c||(c={attributesHash:u,vertexBufferData:[]},this.vertexBuffersPools.push(c));var h;if(e<o){for(var p=this.bucket(e);!n&&p<this.numBuckets;p+=1){var d;for(var v=0;!n&&v<c.vertexBufferData.length;v+=1){h=c.vertexBufferData[v],d=null;for(var m=h.bucket[p].headChunk;m;m=m.nextChunk){if(e<=m.length){n=h.vertexBuffer,r=m.baseIndex;if(e<m.length){m.baseIndex=r+e,m.length-=e;var g=this.bucket(m.length);g!==p&&(d?d.nextChunk=m.nextChunk:h.bucket[p].headChunk=m.nextChunk,m.nextChunk=h.bucket[g].headChunk,h.bucket[g].headChunk=m)}else d?d.nextChunk=m.nextChunk:h.bucket[p].headChunk=m.nextChunk,m.vertexBuffer=null;break}d=m}}}n||(i.numVertices=o,n=this.graphicsDevice.createVertexBuffer(i),this.debugCreatedVertexBuffers+=1,n&&(h={vertexBuffer:n,bucket:this.makeBuckets()},h.bucket[this.bucket(o-e)].headChunk={baseIndex:e,length:o-e,nextChunk:null},c.vertexBufferData.push(h)))}return n||(i.numVertices=e,n=this.graphicsDevice.createVertexBuffer(i),this.debugCreatedVertexBuffers+=1,n&&c.vertexBufferData.push({vertexBuffer:n,bucket:this.makeBuckets()})),{vertexBuffer:n,baseIndex:r,length:e,poolIndex:s}},e.prototype.free=function(e){var t=this.vertexBuffersPools[e.poolIndex],n;for(var r=0;r<t.vertexBufferData.length;r+=1)if(e.vertexBuffer===t.vertexBufferData[r].vertexBuffer){n=t.vertexBufferData[r];break}var i,s,o,u,a;for(var f=0;(!i||!o)&&f<this.numBuckets;f+=1){a=null;for(var l=n.bucket[f].headChunk;l&&(!i||!o);l=l.nextChunk)i||l.baseIndex+l.length===e.baseIndex&&(i=l,s=a),o||l.baseIndex===e.baseIndex+e.length&&(o=l,u=a),a=l}var c,h;if(i&&o)c=this.bucket(i.length),i.length+=e.length+o.length,u?(u.nextChunk=o.nextChunk,o===s&&(s=u)):(n.bucket[this.bucket(o.length)].headChunk=o.nextChunk,o===s&&(s=null)),h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(i)c=this.bucket(i.length),i.length+=e.length,h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(o)c=this.bucket(o.length),o.baseIndex=e.baseIndex,o.length+=e.length,h=this.bucket(o.length),h!==c&&(u?u.nextChunk=o.nextChunk:n.bucket[c].headChunk=o.nextChunk,o.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=o);else{var p=n.bucket[this.bucket(e.length)];p.headChunk={baseIndex:e.baseIndex,length:e.length,nextChunk:p.headChunk}}var d=n.bucket[this.numBuckets-1].headChunk;d&&d.length>=this.maxVerticesPerVertexBuffer&&(t.vertexBufferData.splice(r,1),n.vertexBuffer.destroy(),n.vertexBuffer=null,n.bucket.length=0,n.bucket=null)},e.prototype.destroy=function(){var e=this.vertexBuffersPools;if(e){var t=e.length,n,r;for(n=0;n<t;n+=1){var i=e[n],s=i.vertexBufferData,o=s.length;for(r=0;r<o;r+=1){var u=s[r],a=u.bucket;a&&(a.length=0,u.bucket=null);var f=u.vertexBuffer;f&&(f.destroy(),u.vertexBuffer=null)}s.length=0}e.length=0,this.vertexBuffersPools=null}this.graphicsDevice=null},e.create=function(t,n){var r=new e;return r.vertexBuffersPools=[],r.debugCreatedVertexBuffers=0,r.graphicsDevice=t,r.dynamicVertexBuffers=n?!0:!1,r},e.version=1,e}(),D=function(){function e(){this.maxIndicesPerIndexBuffer=262144,this.numBuckets=10}return e.prototype.bucket=function(e){if(e<=64)return e<=16?e<=8?0:1:e<=32?2:3;if(e<=512)return e<=256?e<=128?4:5:6;return e<=2048?e<=1024?7:8:9},e.prototype.makeBuckets=function(){var e=[];for(var t=0;t<this.numBuckets;t+=1)e.push({headChunk:null});return e},e.prototype.allocate=function(e,t){var n=null,r=0;typeof t=="string"&&(t=this.graphicsDevice["INDEXFORMAT_"+t]);var i={numIndices:undefined,format:t,dynamic:this.dynamicIndexBuffers},s,o=this.maxIndicesPerIndexBuffer,u=this.indexBuffersPools.length,a;for(s=0;s<u;s+=1)if(this.indexBuffersPools[s].format===t){a=this.indexBuffersPools[s];break}a||(a={format:t,indexBufferData:[]},this.indexBuffersPools.push(a));var f;if(e<o){for(var l=this.bucket(e);!n&&l<this.numBuckets;l+=1){var c;for(var h=0;!n&&h<a.indexBufferData.length;h+=1){f=a.indexBufferData[h],c=null;for(var p=f.bucket[l].headChunk;p;p=p.nextChunk){if(e<=p.length){n=f.indexBuffer,r=p.baseIndex;if(e<p.length){p.baseIndex=r+e,p.length-=e;var d=this.bucket(p.length);d!==l&&(c?c.nextChunk=p.nextChunk:f.bucket[l].headChunk=p.nextChunk,p.nextChunk=f.bucket[d].headChunk,f.bucket
[d].headChunk=p)}else c?c.nextChunk=p.nextChunk:f.bucket[l].headChunk=p.nextChunk,p.indexBuffer=null;break}c=p}}}n||(i.numIndices=o,n=this.graphicsDevice.createIndexBuffer(i),this.debugCreatedIndexBuffers+=1,n&&(f={indexBuffer:n,bucket:this.makeBuckets()},f.bucket[this.bucket(o-e)].headChunk={baseIndex:e,length:o-e,nextChunk:null},a.indexBufferData.push(f)))}return n||(i.numIndices=e,n=this.graphicsDevice.createIndexBuffer(i),this.debugCreatedIndexBuffers+=1,n&&a.indexBufferData.push({indexBuffer:n,bucket:this.makeBuckets()})),{indexBuffer:n,baseIndex:r,length:e,poolIndex:s}},e.prototype.free=function(e){var t=this.indexBuffersPools[e.poolIndex],n;for(var r=0;r<t.indexBufferData.length;r+=1)if(e.indexBuffer===t.indexBufferData[r].indexBuffer){n=t.indexBufferData[r];break}var i,s,o,u,a;for(var f=0;(!i||!o)&&f<this.numBuckets;f+=1){a=null;for(var l=n.bucket[f].headChunk;l&&(!i||!o);l=l.nextChunk)i||l.baseIndex+l.length===e.baseIndex&&(i=l,s=a),o||l.baseIndex===e.baseIndex+e.length&&(o=l,u=a),a=l}var c,h;if(i&&o)c=this.bucket(i.length),i.length+=e.length+o.length,u?(u.nextChunk=o.nextChunk,o===s&&(s=u)):(n.bucket[this.bucket(o.length)].headChunk=o.nextChunk,o===s&&(s=null)),h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(i)c=this.bucket(i.length),i.length+=e.length,h=this.bucket(i.length),h!==c&&(s?s.nextChunk=i.nextChunk:n.bucket[c].headChunk=i.nextChunk,i.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=i);else if(o)c=this.bucket(o.length),o.baseIndex=e.baseIndex,o.length+=e.length,h=this.bucket(o.length),h!==c&&(u?u.nextChunk=o.nextChunk:n.bucket[c].headChunk=o.nextChunk,o.nextChunk=n.bucket[h].headChunk,n.bucket[h].headChunk=o);else{var p=n.bucket[this.bucket(e.length)];p.headChunk={baseIndex:e.baseIndex,length:e.length,nextChunk:p.headChunk}}var d=n.bucket[this.numBuckets-1].headChunk;d&&d.length>=this.maxIndicesPerIndexBuffer&&(t.indexBufferData.splice(r,1),n.indexBuffer.destroy(),n.indexBuffer=null,n.bucket.length=0,n.bucket=null)},e.prototype.destroy=function(){var e=this.indexBuffersPools;if(e){var t=e.length,n,r;for(n=0;n<t;n+=1){var i=e[n],s=i.indexBufferData,o=s.length;for(r=0;r<o;r+=1){var u=s[r],a=u.bucket;a&&(a.length=0,u.bucket=null);var f=u.indexBuffer;f&&(f.destroy(),u.indexBuffer=null)}s.length=0}e.length=0,this.indexBuffersPools=null}this.graphicsDevice=null},e.create=function(t,n){var r=new e;return r.indexBuffersPools=[],r.debugCreatedIndexBuffers=0,r.graphicsDevice=t,r.dynamicIndexBuffers=n?!0:!1,r},e.version=1,e}(),P=function(){function e(){}return e.create=function(){return new e},e}(),H=function(){function e(){}return e.prototype.push=function(e,t){var n=P.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var t=new e;return t.events=[],t},e}(),B=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,r=this.serviceStatusObserver,i;i=function(o,u){u?e.neverDiscard||(r.unsubscribe(i),t()):o&&(r.unsubscribe(i),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,r.subscribe(i)),!0);var s=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,p=h?h.discardRequests:!0;return n.discardRequests=p,p&&!e.neverDiscard?t():r.subscribe(i),j.serviceUnavailable(n,u),!1}return s?s.call(e.requestHandler,u,a,f,l):!0},C.ajax(e),!0},e.create=function(t,n){var r=new e;return n||(n={}),r.running=!0,r.discardRequests=!1,r.serviceStatusObserver=T.create(),r.serviceName=t,r.onServiceUnavailable=n.onServiceUnavailable,r.onServiceAvailable=n.onServiceAvailable,r},e}(),j=function(){function e(){}return e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var e=window.top.Turbulenz,t=e&&e.Data||{},n=t.joinMultiplayerSessionId,r=this,i=function(t){r.multiplayerJoinRequestQueue.push(t)},s=function(t){var n=JSON.parse(t);n.mode&&(r.mode=n.mode),n.joinMultiplayerSessionId&&r.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),r.bridgeServices=!!n.bridgeServices};n&&this.multiplayerJoinRequestQueue.push(n),F.setOnMultiplayerSessionToJoin(i),F.setOnReceiveConfig(s),F.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,F.on("bridgeservices.response",function(e){r.routeResponse(e)})},e.callOnBridge=function(e,t,n){var r={data:t,key:undefined};n&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=n,r.key=this.responseIndex),F.emit("bridgeservices."+e,JSON.stringify(r))},e.addSignature=function(e,t){var n;return e.requestUrl=t,n=TurbulenzEngine.encrypt(JSON.stringify(e)),e.str=n,e.signature=TurbulenzEngine.generateSignature(n),e},e.routeResponse=function(e){var t=JSON.parse(e),n=t.key||0,r=this.responseHandlers[n];r&&(this.responseHandlers[n]=null,r(t.data))},e.onServiceUnavailable=function(e,t){},e.onServiceAvailable=function(e,t){},e.createGameSession=function(e,t,n){return I.create(e,t,n)},e.createMappingTable=function(t,n,r,i,s){var o,u=n&&n.mappingTable,a,f,l;u?(a=u.mappingTableURL,f=u.mappingTablePrefix,l=u.assetPrefix):i?(a=i.mappingTableURL||(i.mappingTableURL===""?"":"mapping_table.json"),f=i.mappingTablePrefix||(i.mappingTablePrefix===""?"":"staticmax/"),l=i.assetPrefix||(i.assetPrefix===""?"":"missing/")):(a="mapping_table.json",f="staticmax/",l="missing/");var c=function(n){var r=i&&(i.urnMapping||{}),u=s||e.defaultErrorCallback;o.setMapping(r),u(n)},h={mappingTableURL:a,mappingTablePrefix:f,assetPrefix:l,requestHandler:t,onload:r,errorCallback:c};return o=q.create(h),o},e.createLeaderboardManager=function(e,t,n,r){return LeaderboardManager.create(e,t,n,r)},e.createBadgeManager=function(e,t){return BadgeManager.create(e,t)},e.createStoreManager=function(e,t,n,r){return StoreManager.create(e,t,n,r)},e.createNotificationsManager=function(e,t,n,r){return NotificationsManager.create(e,t,n,r)},e.createMultiplayerSessionManager=function(e,t){return MultiPlayerSessionManager.create(e,t)},e.createUserProfile=function(t,n,r){var i={};r||(r=e.defaultErrorCallback);var s=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n])}},o="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:o,method:"GET",callback:function(t,o){o===200?s(t):r&&r("TurbulenzServices.createUserProfile error with HTTP status "+o+": "+t.msg,o),n&&n(i)},requestHandler:t}),i},e.upgradeAnonymousUser=function(e){if(e){var t=function(n){e()};F.on("user.upgrade.occurred",t)}F.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(t,n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof t||0===t.length){s("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof n||isNaN(n)||!isFinite(n)){if("[object Array]"!==Object.prototype.toString.call(n)){s("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var o,u=n.length;for(o=0;o<u;o+=1)if("number"!=typeof n[o]||isNaN(n[o])||!isFinite(n[o])){s("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+i.gameSlug,method:"POST",data:{key:t,value:n,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.sendCustomMetricEventBatch=function(t,n,r,i){i||(i=e.defaultErrorCallback);if(!e.available()){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var s=TurbulenzEngine.time,o=t.events,u,a=o.length;for(u=0;u<a;u+=1){var f=o[u].key,l=o[u].value,c=o[u].timeOffset;if("string"!=typeof f||0===f.length){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof l||isNaN(l)||!isFinite(l)){if("[object Array]"!==Object.prototype.toString.call(l)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var h,p=l.length;for(h=0;h<p;h+=1)if("number"!=typeof l[h]||isNaN(l[h])||!isFinite(l[h])){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers",0);return}}if("number"!=typeof c||isNaN(c)||!isFinite(c)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}o[u].timeOffset=c-s}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+r.gameSlug,method:"POST",data:{batch:o,gameSessionId:r.gameSessionId},callback:function(t,n){n!==200&&i&&i("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:n,encrypt:!0})},e.getService=function(e){var t=this.services;if(t.hasOwnProperty(e))return t[e];var n=B.create(e);return t[e]=n,n},e.serviceUnavailable=function(t,n){var r=this.waitingServices,i=t.serviceName;if(r.hasOwnProperty(i))return;r[i]=t,t.running=!1;var s=function(r){var i=n.onServiceUnavailable;i&&i.call(r,n),r.onServiceUnavailable&&r.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(r)};t.discardRequests&&s(t);if(this.pollingServiceStatus)return;var o=this,u,a="/api/v1/service-status/game/read/"+window.gameSlug,f=function(i,a){if(a===200){var f=i.data,l=f.services,c=!1,h;for(h in r)if(r.hasOwnProperty(h)){var p=r[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=n.onServiceAvailable;m&&m.call(p,n),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete r[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&(p.discardRequests=!0,s(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(u,f.pollInterval*1e3)}else TurbulenzEngine.setTimeout(u,o.defaultPollInterval)};u=function(){C.ajax({url:a,method:"GET",callback:f})},u()},e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.defaultErrorCallback=function(e,t){},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e}();typeof F!="undefined"&&j.addBridgeEvents();var F=function(){function e(){}return e._initInstance=function(){var e=window.top.Turbulenz;if(e&&e.Services){var t=e.Services.bridge;if(!t)return;this._bridge=t,this.emit=t.emit,this.on=t.gameListenerOn||t.addListener||t.setListener,this.addListener=t.gameListenerOn||t.addListener||t.setListener,this.setListener=t.gameListenerOn||t.setListener}typeof j!="undefined"&&j.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(e,t,n){},e.on=function(e,t){},e.addListener=function(){},e.setListener=function(e,t){},e.setOnReceiveConfig=function(e){this.on("config.set",e)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(e){this.emit("game.session.created",e)},e.destroyedGameSession=function(e){this.emit("game.session.destroyed",e)},e.setGameSessionStatus=function(e,t){this.emit("game.session.status",e,t)},e.setGameSessionInfo=function(e){this.emit("game.session.info",e)},e.updateUserBadge=function(e){this.emit("userbadge.update",e)},e.updateLeaderBoard=function(e){this.emit("leaderboards.update",e)},e.setOnMultiplayerSessionToJoin=function(e){this.on("multiplayer.session.join",e)},e.triggerJoinedMultiplayerSession=function(e){this.emit("multiplayer.session.joined",e)},e.triggerLeaveMultiplayerSession=function(e){this.emit("multiplayer.session.leave",e)},e.triggerMultiplayerSessionMakePublic=function(e){this.emit("multiplayer.session.makepublic",e)},e.setOnBasketUpdate=function(e){this.on("basket.site.update",e)},e.triggerBasketUpdate=function(e){this.emit("basket.game.update.v2",e)},e.triggerUserStoreUpdate=function(e){this.emit("store.user.update",e)},e.setOnPurchaseConfirmed=function(e){this.on("purchase.confirmed",e)},e.setOnPurchaseRejected=function(e){this.on("purchase.rejected",e)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(e){this.on("store.meta.v2",e)},e.triggerSendInstantNotification=function(e){this.emit("notifications.ingame.sendInstant",e)},e.triggerSendDelayedNotification=function(e){this.emit("notifications.ingame.sendDelayed",e)},e.setOnNotificationSent=function(e){this.on("notifications.ingame.sent",e)},e.triggerCancelNotificationByID=function(e){this.emit("notifications.ingame.cancelByID",e)},e.triggerCancelNotificationsByKey=function(e){this.emit("notifications.ingame.cancelByKey",e)},e.triggerCancelAllNotifications=function(e){this.emit("notifications.ingame.cancelAll",e)},e.triggerInitNotificationManager=function(e){this.emit("notifications.ingame.initNotificationManager",e)},e.setOnReceiveNotification=function(e){this.on("notifications.ingame.receive",e)},e.changeAspectRatio=function(e){this.emit("change.viewport.ratio",e)},e.setOnViewportHide=function(e){this.on("change.viewport.hide",e)},e.setOnViewportShow=function(e){this.on("change.viewport.show",e)},e.setOnFullscreenOn=function(e){this.on("change.viewport.fullscreen.on",e)},e.setOnFullscreenOff=function(e){this.on("change.viewport.fullscreen.off",e)},e.setOnMenuStateChange=function(e){this.on("change.menu.state",e)},e.setOnUserStateChange=function(e){this.on("change.user.state",e)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(e){this.emit("query.viewport.fullscreen",e)},e.queryViewportVisibility=function(e){this.emit("query.viewport.visibility",e)},e.queryMenuState=function(e){this.emit("query.menu.state",e)},e.queryUserState=function(e){this.emit("query.user.state",e)},e._bridge=undefined,e}();F.isInitialised()||F._initInstance();var I=function(){function e(){this.post_delay=1e3}return e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,F.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(F.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},j.bridgeServices?j.callOnBridge("gamesession.destroy",t,e):C.ajax({url:"/api/v1/games/destroy-session",method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(t,n,r){var i=new e,s=window.gameSlug,o=window.top.Turbulenz,u=o&&o.Data||{},a=u.mode||j.mode,f="/api/v1/games/create-session/"+s;i.info={sessionData:{},playerSessionData:{}},i.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},i.postData=function(){F.setGameSessionInfo(JSON.stringify(i.info)),i.pendingUpdate=null},i.pendingUpdate=null,i.gameSlug=s,i.requestHandler=t,i.errorCallbackFn=r||j.defaultErrorCallback,i.gameSessionId=null,i.service=j.getService("gameSessions"),i.status=null;if(!j.available())return n&&TurbulenzEngine.setTimeout(function(){n(i)},0),i;var l=function(t,r){r===200?(i.mappingTable=t.mappingTable,i.gameSessionId=t.gameSessionId,n&&n(i),F.createdGameSession(i.gameSessionId)):404===r?(window.gameSlug=undefined,i.gameSlug=undefined,n&&n(i)):i.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+r+": "+t.msg,r)};return a&&(f+="/"+a),i.service.request({url:f,method:"POST",callback:l,requestHandler:t,neverDiscard:!0}),i},e.version=1,e}(),q=function(){function e(){}return e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(t){var n=new e;n.mappingTableURL=t.mappingTableURL,n.tablePrefix=t.mappingTablePrefix,n.assetPrefix=t.assetPrefix,n.overrides={},n.errorCallbackFn=t.errorCallback||j.defaultErrorCallback,n.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var r=function(r){var i=r.urnmapping||r.urnremapping||{},s=r.overrides||{};n.urlMapping=i,n.overrides=s;var o=n.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}t.onload(n)};return n.mappingTableURL?t.requestHandler.request({src:n.mappingTableURL,onload:function(t,i){if(i===200){var s=JSON.parse(t);r(s)}else n.urlMapping={},t=t||{msg:"(no response)"},n.errorCallbackFn("MappingTable.create: HTTP status "+i+": "+t.msg,i)}}):t.mappingTableData?TurbulenzEngine.setTimeout(function(){r(JSON.parse(t.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){n.errorCallbackFn("!! mappingtable params contain no url or data")},0),n},e.version=1,e}(),R=function(){function e(){this.keyValidate=new RegExp("^[A-Za-z0-9]+([\\-\\.][A-Za-z0-9]+)*$")}return e.prototype.validateKey=function(e){return!e||typeof e!="string"?(this.errorCallbackFn("Invalid key string (Key string is empty or not a string)"),!1):this.keyValidate.test(e)?e:(this.errorCallbackFn("Invalid key string (Only alphanumeric characters and .- are permitted)"),!1)},e.prototype.getKeys=function(e,t){var n=this,r=function(i,s){if(s===200)e(i.keys||i.array);else{var o=t||n.errorCallbackFn;o("UserDataManager.getKeys failed with status "+s+": "+i.msg,s,n.getKeys,[e])}},i={gameSessionId:n.gameSessionId};j.bridgeServices?j.callOnBridge("userdata.getkeys",null,e):this.service.request({url:"/api/v1/user-data/get-keys",method:"GET",data:i,callback:r,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.exists=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e,s.exists);else{var u=n||r.errorCallbackFn;u("UserDataManager.exists failed with status "+o+": "+s.msg,o,r.exists,[e,t])}},s={gameSessionId:r.gameSessionId};j.bridgeServices?j.callOnBridge("userdata.exists",e,function(r){t(e,r)}):this.service.request({url:"/api/v1/user-data/exists/"+e,method:"GET",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.get=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e,s.value);else if(o===404)t(e,null);else{var u=n||r.errorCallbackFn;u("UserDataManager.get failed with status "+o+": "+s.msg,o,r.get,[e,t])}},s={gameSessionId:r.gameSessionId};j.bridgeServices?j.callOnBridge("userdata.get",e,function(r){t(e,r)}):this.service.request({url:"/api/v1/user-data/get/"+e,method:"GET",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.set=function(e,t,n,r){if(!this.validateKey(e))return;if(!t){this.remove(e,n);return}var i=this,s=function(o,u){if(u===200)n(e);else{var a=r||i.errorCallbackFn;a("UserDataManager.set failed with status "+u+": "+o.msg,u,i.set,[e,t,n])}},o={gameSessionId:i.gameSessionId,value:t},u="/api/v1/user-data/set/"+e;j.bridgeServices?(j.addSignature(o,u),o.key=e,j.callOnBridge("userdata.set",o,function(){n(e)})):this.service.request({url:u,method:"POST",data:o,callback:s,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.remove=function(e,t,n){if(!this.validateKey(e))return;var r=this,i=function(s,o){if(o===200)t(e);else if(o===404)t(e);else{var u=n||r.errorCallbackFn;u("UserDataManager.remove failed with status "+o+": "+s.msg,o,r.remove,[e,t])}},s={gameSessionId:r.gameSessionId};j.bridgeServices?j.callOnBridge("userdata.remove",e,function(){t(e)}):this.service.request({url:"/api/v1/user-data/remove/"+e,method:"POST",data:s,callback:i,requestHandler:this.requestHandler,encrypt:!0})},e.prototype.removeAll=function(e,t){var n=this,r=function(i,s){if(s===200)e();else{var o=t||n.errorCallbackFn;o("UserDataManager.removeAll failed with status "+s+": "+i.msg,s,n.removeAll,[e])}},i={gameSessionId:n.gameSessionId};j.bridgeServices?j.callOnBridge("userdata.removeall",null,e):this.service.request({url:"/api/v1/user-data/remove-all",method:"POST",data:i,callback:r,requestHandler:this.requestHandler,encrypt:!0})},e.create=function(t,n,r){var i;return j.available()?(i=new e,i.requestHandler=t,i.errorCallbackFn=r||j.defaultErrorCallback,i.gameSessionId=n.gameSessionId,i.service=j.getService("userdata"),i):null},e.version=1,e}(),U=function(){function e(){}return e.prototype.startLoading=function(){try{var e=this.topLevelDocument;e&&e.osdStartLoading&&e.osdStartLoading()}catch(t){}},e.prototype.startSaving=function(){try{var e=this.topLevelDocument;e&&e.osdStartSaving&&e.osdStartSaving()}catch(t){}},e.prototype.stopLoading=function(){try{var e=this.topLevelDocument;e&&e.osdStopLoading&&e.osdStopLoading()}catch(t){}},e.prototype.stopSaving=function(){try{var e=this.topLevelDocument;e&&e.osdStopSaving&&e.osdStopSaving()}catch(t){}},e.create=function(){var t=new e,n=window,r=15;while(n.parent!==n&&r>0)n=n.parent,r-=1;return t.topLevelDocument=n.document,t},e.version=1,e}(),z=function(){function e(){}return e.prototype.complete=function(){return this.dependenciesLoaded||this.sceneAssetsRequested&&0===this.textureManager.getNumPendingTextures()&&(!this.shaderManager||0===this.shaderManager.getNumPendingShaders())&&(this.dependenciesLoaded=!0),this.dependenciesLoaded},e.prototype.load=function(e){function i(e,t){r.request({src:n&&n[e]||this.pathPrefix+e,onload:t})}function s(){t.postSceneLoadFn&&t.postSceneLoadFn(t.scene),t.sceneAssetsRequested=!0}function o(n){function o(e){TurbulenzEngine.setTimeout(e,0)}function u(e){var t=function(){};return t.prototype=e,new t}function f(e){t.animationManager&&t.animationManager.loadData(e),a.data=e,a.yieldFn=o,a.onload=s,t.scene.load(a)}var i=JSON.parse(n);i||(i={}),e.preSceneLoadFn&&e.preSceneLoadFn(i);var a=u(e),l=N.create();l.resolve({data:i,request:this.request,onload:f,requestHandler:r})}var t=this;this.sceneAssetsRequested=!1,this.scene=e.scene,this.assetPath=e.assetPath,this.textureManager=e.textureManager,this.shaderManager=e.shaderManager,this.effectManager=e.effectManager,this.animationManager=e.animationManager,this.requestHandler=e.requestHandler,e.keepLights!==undefined&&(this.keepLights=e.keepLights),e.keepCameras!==undefined&&(this.keepCameras=e.keepCameras),this.preSceneLoadFn=e.preSceneLoadFn,this.postSceneLoadFn=e.postSceneLoadFn,this.dependenciesLoaded=!1,this.sceneLoaded=!1,e.append||this.scene.clear();var n=this.pathRemapping,r=this.requestHandler;e.request?this.request=e.request:this.request=i,this.request(e.assetPath,o)},e.prototype.setPathRemapping=function(e,t){this.pathRemapping=e,this.pathPrefix=t},e.create=function(){var t=new e;return t.scene=null,t.assetPath=null,t.textureManager=null,t.shaderManager=null,t.effectManager=null,t.animationManager=null,t.preSceneLoadFn=null,t.postSceneLoadFn=null,t.dependenciesLoaded=!1,t.sceneAssetsRequested=!1,t.pathPrefix="",t},e}(),W=function(){function e(){this.version=1}return e.prototype.setSelectedRadio=function(e,t){var n=this.radioControls[e],r;n&&(r=n.controls[t],r&&(n.selected=t,this.updateRadio(r.id,!0)))},e.prototype.addRadioControl=function(e){var t=this.radioControls,n=e.groupName,r=e.radioIndex,i=e.id,s=e.fn,o=e.isDefault;if(n===undefined||n===null||r<0||i===undefined||i===null||s===undefined||s===null)return;var u=t[n];u||(t[n]={},u=t[n],u.controls=[],u.selected=0),u.controls[r]=e,o&&(u.selected=r),this.updateRadio(i,o)},e.prototype.addCheckboxControl=function(e){var t=this.checkboxControls,n=e.id,r=e.value;t[r]=e,this.updateCheckbox(n,e.isSelected)},e.prototype.addButtonControl=function(e){var t=this.buttonControls,n=e.id;t[n]=e},e.prototype.addSliderControl=function(e){var t=this.sliderControls;t[e.id]=e},e.prototype.getSliderValue=function(e){var t=window.$("#"+e).value;return t?parseInt(t,10):undefined},e.prototype.getHandler=function(){var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls;return function(r){var i;r||(r=window.event),r.target?i=r.target:r.srcElement&&(i=r.srcElement),i.nodeType===3&&(i=i.parentNode);var s=i.id,o;switch(i.type){case"radio":for(var u in e)if(e.hasOwnProperty(u)){var a=0,f=e[u].controls,l=f.length;while(a<l){o=f[a];if(o.id===s){o.fn();return}a+=1}}break;case"checkbox":for(var c in t)if(t.hasOwnProperty(c)){o=t[c];if(o.id===s){var h=o.fn();h!==undefined&&(document.getElementById(o.id).checked=!!h);return}}break;case"button":for(var p in n)if(n.hasOwnProperty(p)){o=n[p];if(p===s){o.fn();return}}break;default:}}},e.prototype.register=function(){function d(e){return function(t,n){var r=window.$("#"+e+"input");r.val(n.value),r.change()}}function v(e,t){return function(){var n=parseFloat(this.value);if(!window.$)return;var r=window.$("#"+t),i=window.$("#"+t+"input");if(!r||!i)return;var s=r.slider("value");if(n===undefined||isNaN(n)||s===undefined||isNaN(s)||s===n)return;var o=r.slider("option","min"),u=r.slider("option","max");n<o?n=o:n>u&&(n=u),i.val(n),e.value=n,e.fn()}}var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls,r=this.sliderControls,i,s,o;for(var u in e)if(e.hasOwnProperty(u)){var a=e[u].selected,f=e[u].controls,l=f.length;for(var c=0;c<l;c+=1)i=f[c],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.name=i.groupName,s.onclick=this.getHandler(),s.checked=a===i.radioIndex?"checked":"")}for(var h in t)t.hasOwnProperty(h)&&(i=t[h],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler(),s.checked=i.isSelected?"checked":""));for(var p in n)n.hasOwnProperty(p)&&(i=n[p],o=p,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler()));for(var m in r)if(r.hasOwnProperty(m)){i=r[m],o=i.id;if(!window.$)return;var g=window.$("#"+o),y=window.$("#"+o+"input");if(!g||!y)return;g.slider({value:i.value,min:i.min,max:i.max,step:i.step,slide:d(o)}),y.val(g.slider("value")),y.change(v(i,o))}this.registered=!0},e.prototype.updateRadio=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateCheckbox=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateSlider=function(e,t){if(!this.registered)return;if(window.$){var n=window.$("#"+e);n&&n.slider("option","value",t)}},e.create=function(){var t=new e;return t.radioControls={},t.checkboxControls={},t.buttonControls={},t.sliderControls={},t.registered=!1,t},e}();TurbulenzEngine.onload=function(){var t=function(t){window.alert(t)},n=U.create();n.startLoading();var r=TurbulenzEngine.createInputDevice({}),i={},o=TurbulenzEngine.createGraphicsDevice(i);if(!o.shadingLanguageVersion){t("No shading language support detected.\nPlease check your graphics drivers are up to date."),o=null;return}var u=[.87,.87,.87,1];o.beginFrame()&&(o.clear(u),o.endFrame());var a={},f=TurbulenzEngine.createMathDevice(a),l={},c=M.create(l),h=y.create(o,c,null,t),d=m.create(o,c,null,t),g=v.create(),b=p.create(f),w=z.create(),E,S=f.v3BuildYAxis(),T=s.create(f),N=1;T.nearPlane=.05;var C="LOD3sp",L=null,A=0,O=f.m43BuildIdentity(),_=f.m43BuildIdentity(),D=f.m43BuildIdentity(),P=.1,H=1,B=1,F=document.getElementById("userDataSet"),I=document.getElementById("userDataGet"),q=document.getElementById("userDataDuck"),X=document.getElementById("userDataGetKeys"),V=function(t,n){t&&(t.innerHTML=n)},$=function(t,n){t&&(t.innerHTML+=n)},J=document.getElementById("buttonLoadDuck"),K=document.getElementById("buttonSaveDuck"),Q=document.getElementById("buttonRemoveDuck"),G=J&&K&&Q,Y=function(t){G&&(J.disabled=t,K.disabled=t,Q.disabled=t)};Y(!0);var Z,et,tt=!1,nt=function(){var t=function(t){V(X,"Key list:<br />");var n=t.length;for(var r=0;r<n;r+=1){var i=t[r];$(X,i+"<br />")}};V(X,"Getting keys...<br />"),et.getKeys(t)},rt=function(){var t=2,n=function(){t-=1,t||$(I,"All keys successfully retrieved<br />")};et.get("demo",function(t,r){$(I,'Key "'+t+'" has value "'+r+'"<br />'),n()}),et.get("complex-object",function(t,r){var i=JSON.parse(r);$(I,'Key "'+t+'" has value '+r+"<br />"),$(I,"It can be parsed to get "+i.can.have[2]["we want"]+"<br />"),n()})},it=function(){var t=2,n=function(n){var r='Key "'+n+'" has been successfully set';$(F,r+"<br />"),window.console.log(r),t-=1,t||($(F,"All keys successfully set<br />"),rt(),nt())};et.set("demo","hello world",n);var r={a:"complex object",can:{have:["any","structure",{"we want":438}]}};et.set("complex-object",JSON.stringify(r),n)},st=function(t,n,r){window.console.log("userDataErrorFn: "+t),r===et.set?$(F,t+"<br />"):r===et.get?$(I,t+"<br />"):r===et.getKeys&&$(X,t+"<br />")},ot=function(t){$(q,"Failed<br />"+t),Y(!1),tt=!1},ut=W.create(),at=function(){window.console.log("Loading duck ...");var t=function(t,r){if(r){var i=JSON.parse(r);if(i){var s=i.transform;k.arrayToM43(f,s,O),H=i.direction,ut.updateCheckbox("checkReverseDuck",H===1),A=0}$(q,"Complete")}else $(q,"No duck save!");tt=!1,Y(!1),n.stopLoading(),window.console.log("... finished loading duck data")};tt=!0,V(q,"Loading the duck...<br />"),Y(!0),n.startLoading(),et.get("duck.state"+B,t,ot)},ft=function(){var t=function(){$(q,"Complete"),tt=!1,Y(!1),nt()};tt=!0,V(q,"Removing the duck save...<br />"),Y(!0),et.remove("duck.state"+B,t,ot)},lt=function(){window.console.log("Saving duck data ...");var t=function(){$(q,"Complete"),Y(!1),tt=!1,n.stopSaving(),nt(),window.console.log("... finished setting duck data")};V(q,"Saving the duck...<br />"),Y(!0),tt=!0,n.startSaving();var r={transform:k.m43ToArray(L.getLocalTransform()),direction:H};et.set("duck.state"+B,JSON.stringify(r),t,ot)},ct=function(){if(j.available())et=R.create(c,Z,st),V(document.getElementById("duckHeading"),"<h3>Duck state</h3>"),V(document.getElementById("getKeysHeading"),"<h3>Get Keys status</h3>"),V(F,"<h3>Set status</h3>"),V(I,"<h3>Get status</h3>"),Y(!1),it(),at();else{var t=document.getElementById("userDataStatus");V(t,"<h3>Turbulenz Services Unavailable</h3>"),$(t,"You must run this sample from the local server")}},ht=!1;r.addEventListener("mouseup",function(){ht?at():lt(),ht=!ht}),ut.addButtonControl({id:"buttonLoadDuck",value:"Get",fn:at}),ut.addButtonControl({id:"buttonSaveDuck",value:"Set",fn:lt}),ut.addButtonControl({id:"buttonRemoveDuck",value:"Remove",fn:ft}),ut.addCheckboxControl({id:"checkReverseDuck",value:"Clockwise",isSelected:H===1,fn:function(){return H=-H,H===1}}),ut.addRadioControl({id:"radioSave01"
,groupName:"saveId",radioIndex:0,value:"pos01",fn:function(){B=1},isDefault:!0}),ut.addRadioControl({id:"radioSave02",groupName:"saveId",radioIndex:1,value:"pos02",fn:function(){B=2},isDefault:!1}),ut.addRadioControl({id:"radioSave03",groupName:"saveId",radioIndex:2,value:"pos03",fn:function(){B=3},isDefault:!1}),ut.register();var pt=TurbulenzEngine.time,dt=function(){var t=TurbulenzEngine.time,n=t-pt;n>.1&&(n=.1);var r=o.width,i=o.height,s=r/i;s!==T.aspectRatio&&(T.aspectRatio=s,T.updateProjectionMatrix()),T.updateViewProjectionMatrix(),L&&(A+=n*P*H,A>2*Math.PI?A-=2*Math.PI:A<0&&(A+=2*Math.PI),f.m43FromAxisRotation(S,A,_),f.m43Mul(_,O,D),L.setLocalTransform(D)),b.update(),E.update(o,T,b,t),o.beginFrame()&&(E.updateBuffers(o,r,i)&&E.draw(o,u),o.endFrame())},vt,mt=function(){if(w.complete()){TurbulenzEngine.clearInterval(vt),L=b.findNode(C);var t=b.getExtents(),r=f.v3Build(t[0],t[1],t[2]),i=f.v3Build(t[3],t[4],t[5]),s=f.v3ScalarMul(f.v3Add(i,r),.5),o=f.v3Sub(s,r);T.lookAt(s,S,f.v3Build(s[0]+o[0]*2*N,s[1]+o[1]*N,s[2]+o[2]*2*N)),T.updateViewMatrix(),E.updateShader(d),n.stopLoading(),ct(),vt=TurbulenzEngine.setInterval(dt,1e3/60)}};vt=TurbulenzEngine.setInterval(mt,100);var gt=function(){E=x.create(o,f,d,g),E.setGlobalLightPosition(f.v3Build(.5,100,.5)),E.setAmbientColor(f.v3Build(.3,.3,.4)),w.load({scene:b,assetPath:"models/duck.dae",graphicsDevice:o,mathDevice:f,textureManager:h,effectManager:g,shaderManager:d,requestHandler:c,append:!1,dynamic:!0})},yt=function(t){h.setPathRemapping(t.urlMapping,t.assetPrefix),d.setPathRemapping(t.urlMapping,t.assetPrefix),w.setPathRemapping(t.urlMapping,t.assetPrefix),gt()},bt=function(t){j.createMappingTable(c,t,yt)};Z=j.createGameSession(c,bt),TurbulenzEngine.onunload=function(){TurbulenzEngine.clearInterval(vt),vt=null,Z&&(Z.destroy(),Z=null),u=null,A=null,b&&(b.destroy(),b=null),w=null,c=null,T=null,et=null,E&&(E.destroy(),E=null),h&&(h.destroy(),h=null),d&&(d.destroy(),d=null),g=null,TurbulenzEngine.flush(),o=null,f=null}};if(!TurbulenzEngine.onload){window.alert("Entry point 'TurbulenzEngine.onload' must be defined.");return}TurbulenzEngine.onload.call(this)})();