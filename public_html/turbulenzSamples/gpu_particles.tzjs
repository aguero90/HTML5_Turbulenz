(function(){function M(e,t,n){var r=e*65536+t%65536;return n&&(r+=1/(1+n)),r}function _(e){var t={far:e.sharedMaterial.meta.far};e.rendererInfo=t;var n=e.sharedMaterial.effect;return n.prepare&&n.prepare(e),t}var e=Array;typeof Float32Array!="undefined"&&Float32Array.prototype!==undefined&&Float32Array.prototype.slice===undefined&&(Float32Array.prototype.slice=function(t,n){var r=this.length;t===undefined?t=0:t<0&&(t+=r),n===undefined?n=r:n<0&&(n+=r),r=n-t;if(0<r){var i=new Float32Array(r),s=0;do i[s]=this[t],s+=1,t+=1;while(t<n);return i}return new Float32Array(0)});var t={version:1,precision:1e-6,FLOAT_MAX:3.402823466e38,select:function(t,n,r){return t?n:r},reciprocal:function(t){if(t!==0)return 1/t;throw"Division by zero"},truncate:function(t){return t|0},v2BuildZero:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=0,n},v2BuildOne:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=1,n},v2BuildXAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=1,n[1]=0,n},v2BuildYAxis:function(n){return n===undefined&&(n=new e(2)),n[0]=0,n[1]=1,n},v2Build:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n,i[1]=r,i},v2Copy:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n[0],r[1]=n[1],r},v2Set:function(t,n){t[0]=n[0],t[1]=n[1]},v2Neg:function(n,r){return r===undefined&&(r=new e(2)),r[0]=-n[0],r[1]=-n[1],r},v2Add:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i},v2Add3:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s},v2Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(2)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o},v2Sub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i},v2Mul:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i},v2MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s},v2Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]},v2PerpDot:function(t,n){return t[0]*n[1]-t[1]*n[0]},v2LengthSq:function(t){var n=t[0],r=t[1];return n*n+r*r},v2Length:function(t){var n=t[0],r=t[1];return Math.sqrt(n*n+r*r)},v2Reciprocal:function(r,i){i===undefined&&(i=new e(2));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i},v2Normalize:function(n,r){r===undefined&&(r=new e(2));var i=n[0],s=n[1],o=i*i+s*s;if(o>0){var u=1/Math.sqrt(o);r[0]=i*u,r[1]=s*u}else r[0]=0,r[1]=0;return r},v2Abs:function(n,r){r===undefined&&(r=new e(2));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r},v2Max:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Min:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i},v2Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r},v2MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s]},v2MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1]]},v2MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1]]},v2MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1]]},v2MaskNot:function(t){return[!t[0],!t[1]]},v2MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1]]},v2MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1]]},v2Select:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s},v2ScalarBuild:function(n,r){return r===undefined&&(r=new e(2)),r[0]=n,r[1]=n,r},v2ScalarMax:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarMin:function(n,r,i){i===undefined&&(i=new e(2));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i},v2ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]+r,i[1]=n[1]+r,i},v2ScalarSub:function(n,r,i){return i===undefined&&(i=new e(2)),i[0]=n[0]-r,i[1]=n[1]-r,i},v2ScalarMul:function(n,r,i){return i===undefined&&(i=new e(2)),r===0?(i[0]=0,i[1]=0):(i[0]=n[0]*r,i[1]=n[1]*r),i},v2AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s},v2EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s]},v2LessScalarMask:function(t,n){return[t[0]<n,t[1]<n]},v2GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n]},v2GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n]},v2Lerp:function(n,r,i,s){return s===undefined&&(s=new e(2)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s},v3BuildZero:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=0,r},v3BuildOne:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=1,r[2]=1,r},v3BuildXAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=1,r[1]=0,r[2]=0,r},v3BuildYAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=1,r[2]=0,r},v3BuildZAxis:function(n){var r=n;return r===undefined&&(r=new e(3)),r[0]=0,r[1]=0,r[2]=1,r},v3Build:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n,o[1]=r,o[2]=i,o},v3Copy:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},v3Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},v3Neg:function(n,r){return r===undefined&&(r=new e(3)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r},v3Add:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0],s[1]=n[1]+r[1],s[2]=n[2]+r[2],s},v3Add3:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s},v3Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(3)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o},v3Sub:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),s[0]=n[0]-r[0],s[1]=n[1]-r[1],s[2]=n[2]-r[2],s},v3Mul:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i},v3MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s},v3Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},v3Cross:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=n[0],u=n[1],a=n[2],f=r[0],l=r[1],c=r[2];return s[0]=u*c-a*l,s[1]=a*f-o*c,s[2]=o*l-u*f,s},v3LengthSq:function(t){var n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i},v3Length:function(t){var n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)},v3Reciprocal:function(r,i){i===undefined&&(i=new e(3));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i},v3Normalize:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=n[0],o=n[1],u=n[2],a=s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);i[0]=s*f,i[1]=o*f,i[2]=u*f}else i[0]=0,i[1]=0,i[2]=0;return i},v3Abs:function(n,r){var i=r;i===undefined&&(i=new e(3));var s=Math.abs;return i[0]=s(n[0]),i[1]=s(n[1]),i[2]=s(n[2]),i},v3Max:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.max;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Min:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=Math.min;return s[0]=o(n[0],r[0]),s[1]=o(n[1],r[1]),s[2]=o(n[2],r[2]),s},v3Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r},v3MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s]},v3MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2]]},v3MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2]]},v3MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2]]},v3MaskNot:function(t){return[!t[0],!t[1],!t[2]]},v3MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2]]},v3MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2]]},v3Select:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s},v3ScalarBuild:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n,r[1]=n,r[2]=n,r},v3ScalarMax:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarMin:function(n,r,i){i===undefined&&(i=new e(3));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i},v3ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i},v3ScalarSub:function(n,r,i){return i===undefined&&(i=new e(3)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i},v3ScalarMul:function(n,r,i){var s=i;return s===undefined&&(s=new e(3)),r===0?(s[0]=0,s[1]=0,s[2]=0):(s[0]=n[0]*r,s[1]=n[1]*r,s[2]=n[2]*r),s},v3AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(3)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s},v3EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s]},v3LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n]},v3GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n]},v3GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n]},v3Lerp:function(n,r,i,s){var o=s;return o===undefined&&(o=new e(3)),o[0]=n[0]+(r[0]-n[0])*i,o[1]=n[1]+(r[1]-n[1])*i,o[2]=n[2]+(r[2]-n[2])*i,o},v4BuildZero:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=0,r[1]=0,r[2]=0,r[3]=0,r},v4BuildOne:function(n){var r=n;return r===undefined&&(r=new e(4)),r[0]=1,r[1]=1,r[2]=1,r[3]=1,r},v4Build:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},v4Copy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},v4Set:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},v4Neg:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=-n[3],r},v4Add:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r[0],i[1]=n[1]+r[1],i[2]=n[2]+r[2],i[3]=n[3]+r[3],i},v4Add3:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]+i[0],s[1]=n[1]+r[1]+i[1],s[2]=n[2]+r[2]+i[2],s[3]=n[3]+r[3]+i[3],s},v4Add4:function(n,r,i,s,o){return o===undefined&&(o=new e(4)),o[0]=n[0]+r[0]+i[0]+s[0],o[1]=n[1]+r[1]+i[1]+s[1],o[2]=n[2]+r[2]+i[2]+s[2],o[3]=n[3]+r[3]+i[3]+s[3],o},v4Sub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r[0],i[1]=n[1]-r[1],i[2]=n[2]-r[2],i[3]=n[3]-r[3],i},v4Mul:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]*r[0],i[1]=n[1]*r[1],i[2]=n[2]*r[2],i[3]=n[3]*r[3],i},v4MulAdd:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]*r[0]+i[0],s[1]=n[1]*r[1]+i[1],s[2]=n[2]*r[2]+i[2],s[3]=n[3]*r[3]+i[3],s},v4Dot:function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3]},v4LengthSq:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return n*n+r*r+i*i+s*s},v4Length:function(t){var n=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(n*n+r*r+i*i+s*s)},v4Reciprocal:function(r,i){i===undefined&&(i=new e(4));var s=t.reciprocal;return i[0]=s(r[0]),i[1]=s(r[1]),i[2]=s(r[2]),i[3]=s(r[3]),i},v4Normalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=n[3],a=i*i+s*s+o*o+u*u;if(a>0){var f=1/Math.sqrt(a);r[0]=i*f,r[1]=s*f,r[2]=o*f,r[3]=u*f}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},v4Abs:function(n,r){r===undefined&&(r=new e(4));var i=Math.abs;return r[0]=i(n[0]),r[1]=i(n[1]),r[2]=i(n[2]),r[3]=i(n[3]),r},v4Max:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Min:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r[0]),i[1]=s(n[1],r[1]),i[2]=s(n[2],r[2]),i[3]=s(n[3],r[3]),i},v4Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},v4MaskEqual:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r[0])<=s,i(n[1]-r[1])<=s,i(n[2]-r[2])<=s,i(n[3]-r[3])<=s]},v4MaskLess:function(t,n){return[t[0]<n[0],t[1]<n[1],t[2]<n[2],t[3]<n[3]]},v4MaskGreater:function(t,n){return[t[0]>n[0],t[1]>n[1],t[2]>n[2],t[3]>n[3]]},v4MaskGreaterEq:function(t,n){return[t[0]>=n[0],t[1]>=n[1],t[2]>=n[2],t[3]>=n[3]]},v4MaskNot:function(t){return[!t[0],!t[1],!t[2],!t[3]]},v4MaskOr:function(t,n){return[t[0]||n[0],t[1]||n[1],t[2]||n[2],t[3]||n[3]]},v4MaskAnd:function(t,n){return[t[0]&&n[0],t[1]&&n[1],t[2]&&n[2],t[3]&&n[3]]},v4Many:function(t){return t[0]||t[1]||t[2]||t[3]},v4MaskAll:function(t){return t[0]&&t[1]&&t[2]&&t[3]},v4Select:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]?r[0]:i[0],s[1]=n[1]?r[1]:i[1],s[2]=n[2]?r[2]:i[2],s[3]=n[3]?r[3]:i[3],s},v4ScalarBuild:function(n,r){return r===undefined&&(r=new e(4)),r[0]=n,r[1]=n,r[2]=n,r[3]=n,r},v4ScalarMax:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.max;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarMin:function(n,r,i){i===undefined&&(i=new e(4));var s=Math.min;return i[0]=s(n[0],r),i[1]=s(n[1],r),i[2]=s(n[2],r),i[3]=s(n[3],r),i},v4ScalarAdd:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]+r,i[1]=n[1]+r,i[2]=n[2]+r,i[3]=n[3]+r,i},v4ScalarSub:function(n,r,i){return i===undefined&&(i=new e(4)),i[0]=n[0]-r,i[1]=n[1]-r,i[2]=n[2]-r,i[3]=n[3]-r,i},v4ScalarMul:function(r,i,s){return i===0?t.v4BuildZero(s):(s===undefined&&(s=new e(4)),s[0]=r[0]*i,s[1]=r[1]*i,s[2]=r[2]*i,s[3]=r[3]*i,s)},v4AddScalarMul:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+r[0]*i,s[1]=n[1]+r[1]*i,s[2]=n[2]+r[2]*i,s[3]=n[3]+r[3]*i,s},v4ScalarEqual:function(n,r){var i=Math.abs,s=t.precision;return i(n[0]-r)<=s&&i(n[1]-r)<=s&&i(n[2]-r)<=s&&i(n[3]-r)<=s},v4EqualScalarMask:function(n,r){var i=Math.abs,s=t.precision;return[i(n[0]-r)<=s,i(n[1]-r)<=s,i(n[2]-r)<=s,i(n[3]-r)<=s]},v4LessScalarMask:function(t,n){return[t[0]<n,t[1]<n,t[2]<n,t[3]<n]},v4GreaterScalarMask:function(t,n){return[t[0]>n,t[1]>n,t[2]>n,t[3]>n]},v4GreaterEqScalarMask:function(t,n){return[t[0]>=n,t[1]>=n,t[2]>=n,t[3]>=n]},v4Lerp:function(n,r,i,s){return s===undefined&&(s=new e(4)),s[0]=n[0]+(r[0]-n[0])*i,s[1]=n[1]+(r[1]-n[1])*i,s[2]=n[2]+(r[2]-n[2])*i,s[3]=n[3]+(r[3]-n[3])*i,s},aabbBuild:function(n,r,i,s,o,u,a){var f=a;return f===undefined&&(f=new e(6)),f[0]=n,f[1]=r,f[2]=i,f[3]=s,f[4]=o,f[5]=u,f},aabbBuildEmpty:function(n){var r=this.FLOAT_MAX,i=n;return i===undefined&&(i=new e(6)),i[0]=r,i[1]=r,i[2]=r,i[3]=-r,i[4]=-r,i[5]=-r,i},aabbCopy:function(n,r){var i=r;return i===undefined&&(i=new e(6)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i},aabbSet:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5]},aabbIsEmpty:function(t){return t[0]>t[3]},aabbMin:function(t,n){return n===undefined?t.slice(0,3):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n)},aabbMax:function(t,n){return n===undefined?t.slice(3,6):(n[0]=t[3],n[1]=t[4],n[2]=t[5],n)},aabbGetCenterAndHalf:function(t,n,r){var i=(t[0]+t[3])*.5,s=(t[1]+t[4])*.5,o=(t[2]+t[5])*.5;n[0]=i,n[1]=s,n[2]=o,r[0]=t[3]-i,r[1]=t[4]-s,r[2]=t[5]-o},aabbIsInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o<0?t[0]:t[3])+u*(u<0?t[1]:t[4])+a*(a<0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbIsFullyInsidePlanes:function(t,n){var r=n.length,i=0;do{var s=n[i],o=s[0],u=s[1],a=s[2],f=o*(o>0?t[0]:t[3])+u*(u>0?t[1]:t[4])+a*(a>0?t[2]:t[5]);if(f<s[3])return!1;i+=1}while(i<r);return!0},aabbUnion:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]<r[0]?n[0]:r[0],i[1]=n[1]<r[1]?n[1]:r[1],i[2]=n[2]<r[2]?n[2]:r[2],i[3]=n[3]>r[3]?n[3]:r[3],i[4]=n[4]>r[4]?n[4]:r[4],i[5]=n[5]>r[5]?n[5]:r[5],i},aabbUnionArray:function(r,i){i===undefined&&(i=new e(6)),t.aabbCopy(r[0],i);var s=r.length;for(var o=1;o<s;o+=1){var u=r[o];i[0]=i[0]<u[0]?i[0]:u[0],i[1]=i[1]<u[1]?i[1]:u[1],i[2]=i[2]<u[2]?i[2]:u[2],i[3]=i[3]>u[3]?i[3]:u[3],i[4]=i[4]>u[4]?i[4]:u[4],i[5]=i[5]>u[5]?i[5]:u[5]}return i},aabbAddPoints:function(t,n){var r,i=n.length,s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c,h,p,d;for(r=0;r<i;r+=1)c=n[r],h=c[0],p=c[1],d=c[2],s=s<h?s:h,o=o<p?o:p,u=u<d?u:d,a=a>h?a:h,f=f>p?f:p,l=l>d?l:d;t[0]=s,t[1]=o,t[2]=u,t[3]=a,t[4]=f,t[5]=l},aabbTransform:function(n,r,i){i===undefined&&(i=new e(6));var s=(n[0]+n[3])*.5,o=(n[1]+n[4])*.5,u=(n[2]+n[5])*.5,a=n[3]-s,f=n[4]-o,l=n[5]-u,c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9]+(c*s+d*o+g*u),E=r[10]+(h*s+v*o+y*u),S=r[11]+(p*s+m*o+b*u),x=Math.abs,T=x(c)*a+x(d)*f+x(g)*l,N=x(h)*a+x(v)*f+x(y)*l,C=x(p)*a+x(m)*f+x(b)*l;return i[0]=w-T,i[1]=E-N,i[2]=S-C,i[3]=w+T,i[4]=E+N,i[5]=S+C,i},aabbIntercept:function(n,r,i){return i===undefined&&(i=new e(6)),i[0]=n[0]>r[0]?n[0]:r[0],i[1]=n[1]>r[1]?n[1]:r[1],i[2]=n[2]>r[2]?n[2]:r[2],i[3]=n[3]<r[3]?n[3]:r[3],i[4]=n[4]<r[4]?n[4]:r[4],i[5]=n[5]<r[5]?n[5]:r[5],i},aabbOverlaps:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]},aabbSphereOverlaps:function(t,n,r){var i=n[0],s=n[1],o=n[2],u=r*r,a=t[0],f=t[1],l=t[2],c=t[3],h=t[4],p=t[5],d=0,v;return i<a?(v=a-i,d+=v*v):i>c&&(v=i-c,d+=v*v),s<f?(v=f-s,d+=v*v):s>h&&(v=s-h,d+=v*v),o<l?(v=l-o,d+=v*v):o>p&&(v=o-p,d+=v*v),d<=u},aabbIsInside:function(t,n){return t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]},aabbTestInside:function(t,n){return t[0]<=n[3]&&t[1]<=n[4]&&t[2]<=n[5]&&t[3]>=n[0]&&t[4]>=n[1]&&t[5]>=n[2]?t[0]>=n[0]&&t[1]>=n[1]&&t[2]>=n[2]&&t[3]<=n[3]&&t[4]<=n[4]&&t[5]<=n[5]?2:1:0},m33BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(9)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},m33Build:function(n,r,i,s){var o,u=arguments.length;return u>=9?(u>9?(o=arguments[9],o===undefined&&(o=new e(9))):o=new e(9),o[0]=arguments[0],o[1]=arguments[1],o[2]=arguments[2],o[3]=arguments[3],o[4]=arguments[4],o[5]=arguments[5],o[6]=arguments[6],o[7]=arguments[7],o[8]=arguments[8]):(o=s,o===undefined&&(o=new e(9)),o[0]=n[0],o[1]=n[1],o[2]=n[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],o[6]=i[0],o[7]=i[1],o[8]=i[2]),o},m33Copy:function(n,r){var i=r;return i===undefined&&(i=new e(9)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i},m33FromAxisRotation:function(n,r,i){var s=i;s===undefined&&(s=new e(9));var o=Math.sin(r),u=Math.cos(r),a=1-u,f=n[0],l=n[1],c=n[2],h=a*f,p=a*l,d=a*c,v=o*f,m=o*l,g=o*c;return s[0]=h*f+u,s[1]=h*l-g,s[2]=h*c+m,s[3]=p*f+g,s[4]=p*l+u,s[5]=p*c-v,s[6]=d*f-m,s[7]=d*l+v,s[8]=d*c+u,s},m33FromQuat:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a;return i[0]=1-l-c,i[1]=h-p,i[2]=d+v,i[3]=h+p,i[4]=1-f-c,i[5]=m-g,i[6]=d-v,i[7]=m+g,i[8]=1-f-l,i},m33Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m33Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m33At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m33SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m33SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m33SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m33Transpose:function(n,r){r===undefined&&(r=new e(9));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r},m33Determinant:function(t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return n*(o*l-u*f)+r*(u*a-s*l)+i*(s*f-o*a)},m33Inverse:function(n,r){r===undefined&&(r=new e(9));var i=h*m-p*v,s=p*d-c*m,o=c*v-h*d,u=a*i+f*s+l*o;if(u===0)return r[0]=r[1]=r[2]=0,r[3]=r[4]=r[5]=0,r[6]=r[7]=r[8]=0,r;var a=n[0],f=n[1],l=n[2],c=n[3],h=n[4],p=n[5],d=n[6],v=n[7],m=n[8],g=1/u;return r[0]=i*g,r[1]=(v*l-m*f)*g,r[2]=(f*p-l*h)*g,r[3]=s*g,r[4]=(m*a-d*l)*g,r[5]=(c*l-a*p)*g,r[6]=o*g,r[7]=(d*f-v*a)*g,r[8]=(a*h-c*f)*g,r},m33InverseTranspose:function(n,r){var i=r;i===undefined&&(i=new e(9));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=f*p-l*h,v=l*c-a*p,m=a*h-f*c,g=s*d+o*v+u*m;if(g===0)i[0]=i[1]=i[2]=0,i[3]=i[4]=i[5]=0,i[6]=i[7]=i[8]=0;else{var y=1/g;i[0]=d*y,i[3]=(h*u-p*o)*y,i[6]=(o*l-u*f)*y,i[1]=v*y,i[4]=(p*s-c*u)*y,i[7]=(a*u-s*l)*y,i[2]=m*y,i[5]=(c*o-h*s)*y,i[8]=(s*f-a*o)*y}return i},m33Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i===undefined&&(i=new e(9)),i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i},m33Transform:function(n,r,i){i===undefined&&(i=new e(3));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s+n[3]*o+n[6]*u,i[1]=n[1]*s+n[4]*o+n[7]*u,i[2]=n[2]*s+n[5]*o+n[8]*u,i},m33Equal:function(t,n,r){var i=Math.abs;return r===undefined&&(r=this.precision),i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r&&i(t[4]-n[4])<=r&&i(t[5]-n[5])<=r&&i(t[6]-n[6])<=r&&i(t[7]-n[7])<=r&&i(t[8]-n[8])<=r},m33MulM43:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8];return i[0]=d*s+g*o+w*u,i[1]=v*s+y*o+E*u,i[2]=m*s+b*o+S*u,i[3]=d*a+g*f+w*l,i[4]=v*a+y*f+E*l,i[5]=m*a+b*f+S*l,i[6]=d*c+g*h+w*p,i[7]=v*c+y*h+E*p,i[8]=m*c+b*h+S*p,i[9]=r[9],i[10]=r[10],i[11]=r[11],i},m33MulM44:function(n,r,i){i===undefined&&(i=new e(16));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=r[0],v=r[1],m=r[2],g=r[3],y=r[4],b=r[5],w=r[6],E=r[7],S=r[8],x=r[9],T=r[10],N=r[11];return i[0]=d*s+y*o+S*u,i[1]=v*s+b*o+x*u,i[2]=m*s+w*o+T*u,i[3]=g*s+E*o+N*u,i[4]=d*a+y*f+S*l,i[5]=v*a+b*f+x*l,i[6]=m*a+w*f+T*l,i[7]=g*a+E*f+N*l,i[8]=d*c+y*h+S*p,i[9]=v*c+b*h+x*p,i[10]=m*c+w*h+T*p,i[11]=g*c+E*h+N*p,i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],i},m33ScalarAdd:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]+r;return i},m33ScalarSub:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]-r;return i},m33ScalarMul:function(n,r,i){i===undefined&&(i=new e(9));for(var s=0;s<9;s+=1)i[s]=n[s]*r;return i},m34BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r},m34Pos:function(n,r){return r===undefined&&(r=new e(3)),r[0]=n[3],r[1]=n[7],r[2]=n[11],r},m34Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3],i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7],i[8]=n[8]*u,i[9]=n[9]*u,i[10]=n[10]*u,i[11]=n[11],i},m43BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(12)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r[9]=0,r[10]=0,r[11]=0,r},m43Build:function(n,r,i,s,o,u,a,f,l,c,h,p,d){var v,m=arguments.length;return m>=12?(m>12?(v=arguments[12],v===undefined&&(v=new e(12))):v=new e(12),v[0]=arguments[0],v[1]=arguments[1],v[2]=arguments[2],v[3]=arguments[3],v[4]=arguments[4],v[5]=arguments[5],v[6]=arguments[6],v[7]=arguments[7],v[8]=arguments[8],v[9]=arguments[9],v[10]=arguments[10],v[11]=arguments[11]):(v=o,v===undefined&&(v=new e(12)),v[0]=n[0],v[1]=n[1],v[2]=n[2],v[3]=r[0],v[4]=r[1],v[5]=r[2],v[6]=i[0],v[7]=i[1],v[8]=i[2],v[9]=s[0],v[10]=s[1],v[11]=s[2]),v},m43BuildTranslation:function(n,r,i,s){var o;return 3<=arguments.length?(o=s,o===undefined&&(o=new e(12)),o[9]=n,o[10]=r,o[11]=i):(o=r,o===undefined&&(o=new e(12)),o[9]=n[0],o[10]=n[1],o[11]=n[2]),o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1,o},m43Copy:function(n,r){var i=r;return i===undefined&&(i=new e(12)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43FromM33V3:function(n,r,i){var s=i;return s===undefined&&(s=new e(12)),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],s[6]=n[6],s[7]=n[7],s[8]=n[8],s[9]=r[0],s[10]=r[1],s[11]=r[2],s},m43FromAxisRotation:function(n,r,i){var s=Math.sin(r),o=Math.cos(r),u=1-o,a=n[0],f=n[1],l=n[2],c=u*a,h=u*f,p=u*l,d=s*a,v=s*f,m=s*l,g=i;return g===undefined&&(g=new e(12)),g[0]=c*a+o,g[1]=c*f-m,g[2]=c*l+v,g[3]=h*a+m,g[4]=h*f+o,g[5]=h*l-d,g[6]=p*a-v,g[7]=p*f+d,g[8]=p*l+o,g[9]=0,g[10]=0,g[11]=0,g},m43FromQuatPos:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=2*s*s,p=2*o*o,d=2*u*u,v=2*s*o,m=2*u*a,g=2*s*u,y=2*o*a,b=2*o*u,w=2*s*a;return i[0]=1-p-d,i[1]=v-m,i[2]=g+y,i[3]=v+m,i[4]=1-h-d,i[5]=b-w,i[6]=g-y,i[7]=b+w,i[8]=1-h-p,i[9]=f,i[10]=l,i[11]=c,i},m43FromRTS:function(n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=2*o*o,c=2*u*u,h=2*a*a,p=2*o*u,d=2*a*f,v=2*o*a,m=2*u*f,g=2*u*a,y=2*o*f,b=i[0],w=i[1],E=i[2],S=s;return S===undefined&&(S=new e(12)),S[0]=b*(1-c-h),S[1]=b*(p-d),S[2]=b*(v+m),S[3]=w*(p+d),S[4]=w*(1-l-h),S[5]=w*(g-y),S[6]=E*(v-m),S[7]=E*(g+y),S[8]=E*(1-l-c),S[9]=r[0],S[10]=r[1],S[11]=r[2],S},m43FromRT:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=2*s*s,l=2*o*o,c=2*u*u,h=2*s*o,p=2*u*a,d=2*s*u,v=2*o*a,m=2*o*u,g=2*s*a,y=i;return y===undefined&&(y=new e(12)),y[0]=1-l-c,y[1]=h-p,y[2]=d+v,y[3]=h+p,y[4]=1-f-c,y[5]=m-g,y[6]=d-v,y[7]=m+g,y[8]=1-f-l,y[9]=r[0],y[10]=r[1],y[11]=r[2],y},m43Right:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i},m43Up:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[3],i[1]=n[4],i[2]=n[5],i},m43At:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[6],i[1]=n[7],i[2]=n[8],i},m43Pos:function(n,r){var i=r;return i===undefined&&(i=new e(3)),i[0]=n[9],i[1]=n[10],i[2]=n[11],i},m43SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2]},m43SetUp:function(t,n){t[3]=n[0],t[4]=n[1],t[5]=n[2]},m43SetAt:function(t,n){t[6]=n[0],t[7]=n[1],t[8]=n[2]},m43SetPos:function(t,n){t[9]=n[0],t[10]=n[1],t[11]=n[2]},m43SetAxisRotation:function(t,n,r){var i=Math.sin(r),s=Math.cos(r),o=1-s,u=n[0],a=n[1],f=n[2],l=o*u,c=o*a,h=o*f,p=i*u,d=i*a,v=i*f;t[0]=l*u+s,t[1]=l*a-v,t[2]=l*f+d,t[3]=c*u+v,t[4]=c*a+s,t[5]=c*f-p,t[6]=h*u-d,t[7]=h*a+p,t[8]=h*f+s},m43InverseOrthonormal:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11];return r[0]=i,r[1]=u,r[2]=l,r[3]=s,r[4]=a,r[5]=c,r[6]=o,r[7]=f,r[8]=h,r[9]=-(p*i+d*s+v*o),r[10]=-(p*u+d*a+v*f),r[11]=-(p*l+d*c+v*h),r},m43Orthonormalize:function(r,i){var s=t.v3Normalize,o=t.v3Length,u=t.v3Dot,a=t.v3Cross,f=Math.abs,l=t.m43Right(r),c=t.m43Up(r),h=t.m43At(r),p=t.m43Pos(r),d=o(l),v=o(c),m=o(h);s(l,l),s(c,c),s(h,h);var g,y,b;if(d>0)if(v>0)if(m>0){var w=f(u(c,h)),E=f(u(h,l)),S=f(u(l,c));w<E?w<S?(g=c,y=h,b=l):(g=l,y=c,b=h):E<S?(g=h,y=l,b=c):(g=l,y=c,b=h)}else g=l,y=c,b=h;else g=h,y=l,b=c;else g=c,y=h,b=l;return a(g,y,b),s(b,b),a(b,g,y),s(y,y),i===undefined&&(i=new e(12)),i[0]=l[0],i[1]=l[1],i[2]=l[2],i[3]=c[0],i[4]=c[1],i[5]=c[2],i[6]=h[0],i[7]=h[1],i[8]=h[2],i[9]=p[0],i[10]=p[1],i[11]=p[2],i},m43Determinant:function(t){return t[0]*(t[4]*t[8]-t[5]*t[7])+t[1]*(t[5]*t[6]-t[3]*t[8])+t[2]*(t[3]*t[7]-t[4]*t[6])},m43Inverse:function(n,r){r===undefined&&(r=new e(12));var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=a*h-f*c,g=f*l-u*h,y=u*c-a*l,b=i*m+s*g+o*y;if(b===0)return r;r===undefined&&(r=new e(12));var w=1/b;return r[0]=m*w,r[1]=(c*o-h*s)*w,r[2]=(s*f-o*a)*w,r[3]=g*w,r[4]=(h*i-l*o)*w,r[5]=(u*o-i*f)*w,r[6]=y*w,r[7]=(l*s-c*i)*w,r[8]=(i*a-u*s)*w,r[9]=(u*(d*h-c*v)+a*(l*v-p*h)+f*(p*c-l*d))*w,r[10]=(l*(o*d-s*v)+c*(i*v-p*o)+h*(p*s-i*d))*w,r[11]=(p*(o*a-s*f)+d*(i*f-u*o)+v*(u*s-i*a))*w,r},m43Translate:function(t,n){t[9]+=n[0],t[10]+=n[1],t[11]+=n[2]},m43Scale:function(n,r,i){i===undefined&&(i=new e(12));var s=r[0],o=r[1],u=r[2];return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[3]=n[3]*o,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*u,i[7]=n[7]*u,i[8]=n[8]*u,i[9]=n[9],i[10]=n[10],i[11]=n[11],i},m43TransformVector:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a,s[1]=n[1]*o+n[4]*u+n[7]*a,s[2]=n[2]*o+n[5]*u+n[8]*a,s},m43TransformPoint:function(n,r,i){var s=i;s===undefined&&(s=new e(3));var o=r[0],u=r[1],a=r[2];return s[0]=n[0]*o+n[3]*u+n[6]*a+n[9],s[1]=n[1]*o+n[4]*u+n[7]*a+n[10],s[2]=n[2]*o+n[5]*u+n[8]*a+n[11],s},m43Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=i;return C===undefined&&(C=new e(12)),C[0]=g*s+w*o+x*u,C[1]=y*s+E*o+T*u,C[2]=b*s+S*o+N*u,C[3]=g*a+w*f+x*l,C[4]=y*a+E*f+T*l,C[5]=b*a+S*f+N*l,C[6]=g*c+w*h+x*p,C[7]=y*c+E*h+T*p,C[8]=b*c+S*h+N*p,C[9]=g*d+w*v+x*m+r[9],C[10]=y*d+E*v+T*m+r[10],C[11]=b*d+S*v+N*m+r[11],C},m43MulM44:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(16)),A[0]=g*s+E*o+N*u,A[1]=y*s+S*o+C*u,A[2]=b*s+x*o+k*u,A[3]=w*s+T*o+L*u,A[4]=g*a+E*f+N*l,A[5]=y*a+S*f+C*l,A[6]=b*a+x*f+k*l,A[7]=w*a+T*f+L*l,A[8]=g*c+E*h+N*p,A[9]=y*c+S*h+C*p,A[10]=b*c+x*h+k*p,A[11]=w*c+T*h+L*p,A[12]=g*d+E*v+N*m+r[12],A[13]=y*d+S*v+C*m+r[13],A[14]=b*d+x*v+k*m+r[14],A[15]=w*d+T*v+L*m+r[15],A},m43Transpose:function(n,r){var i=r;i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11];return i[0]=s,i[1]=a,i[2]=c,i[3]=d,i[4]=o,i[5]=f,i[6]=h,i[7]=v,i[8]=u,i[9]=l,i[10]=p,i[11]=m,i},m43MulTranspose:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2],w=r[3],E=r[4],S=r[5],x=r[6],T=r[7],N=r[8],C=r[9],k=r[10],L=r[11],A=i;return A===undefined&&(A=new e(12)),A[0]=g*s+w*o+x*u,A[1]=g*a+w*f+x*l,A[2]=g*c+w*h+x*p,A[3]=g*d+w*v+x*m+C,A[4]=y*s+E*o+T*u,A[5]=y*a+E*f+T*l,A[6]=y*c+E*h+T*p,A[7]=y*d+E*v+T*m+k,A[8]=b*s+S*o+N*u,A[9]=b*a+S*f+N*l,A[10]=b*c+S*h+N*p,A[11]=b*d+S*v+N*m+L,A},m43Offset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=r[0],y=r[1],b=r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43NegOffset:function(n,r,i){i===undefined&&(i=new e(12));var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=-r[0],y=-r[1],b=-r[2];return i[0]=s,i[1]=o,i[2]=u,i[3]=a,i[4]=f,i[5]=l,i[6]=c,i[7]=h,i[8]=p,i[9]=s*g+a*y+c*b+d,i[10]=o*g+f*y+h*b+v,i[11]=u*g+l*y+p*b+m,i},m43InverseTransposeProjection:function(n,r,i){i===undefined&&(i=new e(12));var s=.5/r[0],o=.5/r[1],u=.5/r[2],a=n[0]*s,f=n[1]*s,l=n[2]*s,c=n[3]*o,h=n[4]*o,p=n[5]*o,d=n[6]*u,v=n[7]*u,m=n[8]*u,g=n[9],y=n[10],b=n[11];return i[0]=a,i[1]=f,i[2]=l,i[3]=.5-(g*a+y*f+b*l),i[4]=c,i[5]=h,i[6]=p,i[7]=.5-(g*c+y*h+b*p),i[8]=d,i[9]=v,i[10]=m,i[11]=.5-(g*d+y*v+b*m),i},m43ScalarAdd:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]+r;return i},m43ScalarSub:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]-r;return i},m43ScalarMul:function(n,r,i){i===undefined&&(i=new e(12));for(var s=0;s<12;s+=1)i[s]=n[s]*r;return i},m44BuildIdentity:function(n){var r=n;return r===undefined&&(r=new e(16)),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},m44Build:function(n,r,i,s,o){var u,a=arguments.length;return a>=16?(a>16?(u=arguments[16],u===undefined&&(u=new e(16))):u=new e(16),u[0]=arguments[0],u[1]=arguments[1],u[2]=arguments[2],u[3]=arguments[3],u[4]=arguments[4],u[5]=arguments[5],u[6]=arguments[6],u[7]=arguments[7],u[8]=arguments[8],u[9]=arguments[9],u[10]=arguments[10],u[11]=arguments[11],u[12]=arguments[12],u[13]=arguments[13],u[14]=arguments[14],u[15]=arguments[15]):(u=o,u===undefined&&(u=new e(16)),u[0]=n[0],u[1]=n[1],u[2]=n[2],u[3]=n[3],u[4]=r[0],u[5]=r[1],u[6]=r[2],u[7]=r[3],u[8]=i[0],u[9]=i[1],u[10]=i[2],u[11]=i[3],u[12]=s[0],u[13]=s[1],u[14]=s[2],u[15]=s[3]),u},m44Copy:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],r},m44Right:function(t,n){return n===undefined?t.slice(0,4):(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n)},m44Up:function(t,n){return n===undefined?t.slice(4,8):(n[0]=t[4],n[1]=t[5],n[2]=t[6],n[3]=t[7],n)},m44At:function(t,n){return n===undefined?t.slice(8,12):(n[0]=t[8],n[1]=t[9],n[2]=t[10],n[3]=t[11],n)},m44Pos:function(t,n){return n===undefined?t.slice(12):(n[0]=t[12],n[1]=t[13],n[2]=t[14],n[3]=t[15],n)},m44SetRight:function(t,n){t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]},m44SetUp:function(t,n){t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3]},m44SetAt:function(t,n){t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=n[3]},m44SetPos:function(t,n){t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=n[3]},m44Translate:function(t,n){t[12]+=n[0],t[13]+=n[1],t[14]+=n[2],t[15]+=n[3]},m44Scale:function(n,r,i){return i===
undefined&&(i=new e(16)),i[0]=n[0]*r[0],i[1]=n[1]*r[0],i[2]=n[2]*r[0],i[3]=n[3],i[4]=n[4]*r[1],i[5]=n[5]*r[1],i[6]=n[6]*r[1],i[7]=n[7],i[8]=n[8]*r[2],i[9]=n[9]*r[2],i[10]=n[10]*r[2],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i},m44Transform:function(n,r,i){var s=r[0],o=r[1],u=r[2],a=r[3];return i===undefined&&(i=new e(4)),a!==1?(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12]*a,i[1]=n[1]*s+n[5]*o+n[9]*u+n[13]*a,i[2]=n[2]*s+n[6]*o+n[10]*u+n[14]*a,i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]*a):(i[0]=n[0]*s+n[4]*o+n[8]*u+n[12],i[1]=n[1]*s+n[5]*o+n[9]*u+n[13],i[2]=n[2]*s+n[6]*o+n[10]*u+n[14],i[3]=n[3]*s+n[7]*o+n[11]*u+n[15]),i},m44Mul:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r[0],S=r[1],x=r[2],T=r[3],N=r[4],C=r[5],k=r[6],L=r[7],A=r[8],O=r[9],M=r[10],_=r[11],D=r[12],P=r[13],H=r[14],B=r[15];return i===undefined&&(i=new e(16)),i[0]=E*s+N*o+A*u+D*a,i[1]=S*s+C*o+O*u+P*a,i[2]=x*s+k*o+M*u+H*a,i[3]=T*s+L*o+_*u+B*a,i[4]=E*f+N*l+A*c+D*h,i[5]=S*f+C*l+O*c+P*h,i[6]=x*f+k*l+M*c+H*h,i[7]=T*f+L*l+_*c+B*h,i[8]=E*p+N*d+A*v+D*m,i[9]=S*p+C*d+O*v+P*m,i[10]=x*p+k*d+M*v+H*m,i[11]=T*p+L*d+_*v+B*m,i[12]=E*g+N*y+A*b+D*w,i[13]=S*g+C*y+O*b+P*w,i[14]=x*g+k*y+M*b+H*w,i[15]=T*g+L*y+_*b+B*w,i},m44Inverse:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15];r===undefined&&(r=new e(16));var w=i*f-s*a,E=i*l-o*a,S=i*c-u*a,x=s*l-o*f,T=s*c-u*f,N=o*c-u*l,C=h*g-p*m,k=h*y-d*m,L=h*b-v*m,A=p*y-d*g,O=p*b-v*g,M=d*b-v*y,_=w*M-E*O+S*A+x*L-T*k+N*C;if(_===0)r[0]=0,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=0;else{var D=1/_;r[0]=(+(f*M)-l*O+c*A)*D,r[4]=(-(a*M)+l*L-c*k)*D,r[8]=(+(a*O)-f*L+c*C)*D,r[12]=(-(a*A)+f*k-l*C)*D,r[1]=(-(s*M)+o*O-u*A)*D,r[5]=(+(i*M)-o*L+u*k)*D,r[9]=(-(i*O)+s*L-u*C)*D,r[13]=(+(i*A)-s*k+o*C)*D,r[2]=(+(g*N)-y*T+b*x)*D,r[6]=(-(m*N)+y*S-b*E)*D,r[10]=(+(m*T)-g*S+b*w)*D,r[14]=(-(m*x)+g*E-y*w)*D,r[3]=(-(p*N)+d*T-v*x)*D,r[7]=(+(h*N)-d*S+v*E)*D,r[11]=(-(h*T)+p*S-v*w)*D,r[15]=(+(h*x)-p*E+d*w)*D}return r},m44Transpose:function(n,r){return r===undefined&&(r=new e(16)),r[0]=n[0],r[1]=n[4],r[2]=n[8],r[3]=n[12],r[4]=n[1],r[5]=n[5],r[6]=n[9],r[7]=n[13],r[8]=n[2],r[9]=n[6],r[10]=n[10],r[11]=n[14],r[12]=n[3],r[13]=n[7],r[14]=n[11],r[15]=n[15],r},m44ScalarAdd:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]+r;return i},m44ScalarSub:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]-r;return i},m44ScalarMul:function(n,r,i){i===undefined&&(i=new e(16));for(var s=0;s<16;s+=1)i[s]=n[s]*r;return i},quatBuild:function(n,r,i,s,o){var u=o;return u===undefined&&(u=new e(4)),u[0]=n,u[1]=r,u[2]=i,u[3]=s,u},quatCopy:function(n,r){var i=r;return i===undefined&&(i=new e(4)),i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i},quatIsSimilar:function(n,r,i){i===undefined&&(i=this.precision);var s=n;n[3]*r[3]<0&&(s=t.v4Neg(n));var o=t.v4LengthSq(t.v4Sub(s,r)),u=i*i;return o<u},quatLength:function(n){return t.v4Length(n)},quatDot:function(n,r){return t.v4Dot(n,r)},quatMul:function(n,r,i){i===undefined&&(i=new e(4));var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=r[3],p=c*o-l*u,d=f*u-c*s,v=l*s-f*o;return i[0]=s*h+f*a+p,i[1]=o*h+l*a+d,i[2]=u*h+c*a+v,i[3]=h*a-(f*s+l*o+c*u),i},quatMulTranslate:function(t,n,r,i,s,o){var u=t[0],a=t[1],f=t[2],l=t[3],c=r[0],h=r[1],p=r[2],d=r[3],v=f*h-a*p,m=u*p-f*c,g=a*c-u*h;s[0]=c*l+u*d+v,s[1]=h*l+a*d+m,s[2]=p*l+f*d+g,s[3]=l*d-(u*c+a*h+f*p);var y=n[0],b=n[1],w=n[2],E=i[0],S=i[1],x=i[2],T=l*l-(u*u+a*a+f*f),N=E*T,C=S*T,k=x*T;T=u*E+a*S+f*x;var L=T+T;N+=u*L,C+=a*L,k+=f*L,v=f*S-a*x,m=u*x-f*E,g=a*E-u*S;var A=l+l;N+=v*A,C+=m*A,k+=g*A,o[0]=N+y,o[1]=C+b,o[2]=k+w},quatNormalize:function(n,r){var i=t.quatDot(n,n);if(i===0)return t.v4BuildZero(r);var s=1/Math.sqrt(i);return t.v4ScalarMul(n,s,r)},quatConjugate:function(n,r){return r===undefined&&(r=new e(4)),r[0]=-n[0],r[1]=-n[1],r[2]=-n[2],r[3]=n[3],r},quatLerp:function(n,r,i,s){s===undefined&&(s=new e(4));var o=n[0],u=n[1],a=n[2],f=n[3],l=r[0],c=r[1],h=r[2],p=r[3];return s[0]=(l-o)*i+o,s[1]=(c-u)*i+u,s[2]=(h-a)*i+a,s[3]=(p-f)*i+f,s},cosMinSlerpAngle:Math.cos(Math.PI/40),quatSlerp:function(r,i,s,o){var u=o;u===undefined&&(u=new e(4));var a=r[0],f=r[1],l=r[2],c=r[3],h=i[0],p=i[1],d=i[2],v=i[3],m=a*h+f*p+l*d+c*v,g=m;g<0&&(a=-a,f=-f,l=-l,c=-c,g=-g);if(g>t.cosMinSlerpAngle){if(g>1-1e-6)return u[0]=a,u[1]=f,u[2]=l,u[3]=c,u;var y=s;m<=0&&(y=-s);var b=(h-a)*y+a,w=(p-f)*y+f,E=(d-l)*y+l,S=(v-c)*y+c,x=Math.sqrt(b*b+w*w+E*E+S*S),T=1/x;return u[0]=b*T,u[1]=w*T,u[2]=E*T,u[3]=S*T,u}var N=Math.sin,C=Math.acos(g),k=1/N(C),L=N((1-s)*C)*k;return a*=L,f*=L,l*=L,c*=L,L=N(s*C)*k,h*=L,p*=L,d*=L,v*=L,u[0]=a+h,u[1]=f+p,u[2]=l+d,u[3]=c+v,u},quatFromM43:function(n,r){var i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p,d,v,m,g,y=i+a+h+1;y>t.precision?(m=Math.sqrt(y)/2,p=(f-c)/(4*m),d=(l-o)/(4*m),v=(s-u)/(4*m)):i>a&&i>h?(g=Math.sqrt(1+i-a-h)*2,m=(f-c)/g,p=.25*g,d=(u+s)/g,v=(l+o)/g):a>h?(g=Math.sqrt(1+a-i-h)*2,m=(l-o)/g,p=(u+s)/g,d=.25*g,v=(c+f)/g):(g=Math.sqrt(1+h-i-a)*2,m=(s-u)/g,p=(l+o)/g,d=(c+f)/g,v=.25*g);var b=t.quatNormalize([p,d,v,m],r);return t.quatConjugate(b,r)},quatFromAxisRotation:function(r,i,s){var o=.5*i,u=Math.sin(o),a=Math.cos(o),f=s;return f===undefined&&(f=new e(4)),f[0]=r[0]*u,f[1]=r[1]*u,f[2]=r[2]*u,f[3]=a,t.quatNormalize(f,f)},quatToAxisRotation:function(r,i){i===undefined&&(i=new e(4));var s=r[3],o=Math.acos(s)*2,u=1-s*s;if(u<t.precision)i[0]=1,i[1]=0,i[2]=0,i[3]=o;else{var a=1/Math.sqrt(u);i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=o}return i},quatTransformVector:function(n,r,i){var s=n[0],o=n[1],u=n[2],a=n[3],f=r[0],l=r[1],c=r[2],h=a*a-(s*s+o*o+u*u),p=f*h,d=l*h,v=c*h;h=s*f+o*l+u*c;var m=h+h;p+=s*m,d+=o*m,v+=u*m;var g=u*l-o*c,y=s*c-u*f,b=o*f-s*l,w=a+a;return p+=g*w,d+=y*w,v+=b*w,i===undefined&&(i=new e(3)),i[0]=p,i[1]=d,i[2]=v,i},quatEqual:function(t,n,r){r===undefined&&(r=this.precision);var i=Math.abs;return i(t[0]-n[0])<=r&&i(t[1]-n[1])<=r&&i(t[2]-n[2])<=r&&i(t[3]-n[3])<=r},quatPosBuild:function(n,r,i,s,o,u,a,f){var l;return arguments.length<7?(l=i,l===undefined&&(l=new e(7)),l[0]=n[0],l[1]=n[1],l[2]=n[2],l[3]=n[3],l[4]=r[0],l[5]=r[1],l[6]=r[2]):(l=f,l===undefined&&(l=new e(7)),l[0]=n,l[1]=r,l[2]=i,l[3]=s,l[4]=o,l[5]=u,l[6]=a),l},quatPosTransformVector:function(n,r,i){return t.quatTransformVector(n,r,i)},quatPosTransformPoint:function(n,r){var i=n.slice(4,7),s=t.quatTransformVector(n,r);return t.v3Add(s,i)},quatPosMul:function(n,r){var i=r.slice(4,7),s=t.quatMul(n,r),o=t.quatPosTransformPoint(n,i);return s[4]=o[0],s[5]=o[1],s[6]=o[2],s},isVisibleBox:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=n[0],f=n[1],l=n[2],c=r[0],h=r[1],p=r[2],d=r[3],v=r[4],m=r[5],g=r[6],y=r[7],b=r[8],w=r[9],E=r[10],S=r[11],x=c*a,T=h*a,N=p*a,C=d*a,k=v*f,L=m*f,A=g*f,O=y*f,M=b*l,_=w*l,D=E*l,P=S*l,H=c*s+v*o+b*u+r[12],B=h*s+m*o+w*u+r[13],j=p*s+g*o+E*u+r[14],F=d*s+y*o+S*u+r[15];return!(H-F>i(x-C)+i(k-O)+i(M-P)||H+F<-(i(x+C)+i(k+O)+i(M+P))||B-F>i(T-C)+i(L-O)+i(_-P)||B+F<-(i(T+C)+i(L+O)+i(_+P))||j-F>i(N-C)+i(A-O)+i(D-P)||j+F<-(i(N+C)+i(A+O)+i(D+P))||F+F<-(i(C+C)+i(O+O)+i(P+P)))},isVisibleBoxOrigin:function(t,n){var r=Math.abs,i=t[0],s=t[1],o=t[2],u=n[0]*i,a=n[1]*i,f=n[2]*i,l=n[3]*i,c=n[4]*s,h=n[5]*s,p=n[6]*s,d=n[7]*s,v=n[8]*o,m=n[9]*o,g=n[10]*o,y=n[11]*o,b=n[12],w=n[13],E=n[14],S=n[15];return!(b-S>r(u-l)+r(c-d)+r(v-y)||b+S<-(r(u+l)+r(c+d)+r(v+y))||w-S>r(a-l)+r(h-d)+r(m-y)||w+S<-(r(a+l)+r(h+d)+r(m+y))||E-S>r(f-l)+r(p-d)+r(g-y)||E+S<-(r(f+l)+r(p+d)+r(g+y))||S+S<-(r(l+l)+r(d+d)+r(y+y)))},isVisibleSphere:function(t,n,r){var i=Math.abs,s=t[0],o=t[1],u=t[2],a=r[0],f=r[1],l=r[2],c=r[3],h=r[4],p=r[5],d=r[6],v=r[7],m=r[8],g=r[9],y=r[10],b=r[11],w=a,E=f,S=l,x=c,T=h,N=p,C=d,k=v,L=m,A=g,O=y,M=b,_=a*s+h*o+m*u+r[12],D=f*s+p*o+g*u+r[13],P=l*s+d*o+y*u+r[14],H=c*s+v*o+b*u+r[15],B=-n;return!(_-H>n*(i(w-x)+i(T-k)+i(L-M))||_+H<B*(i(w+x)+i(T+k)+i(L+M))||D-H>n*(i(E-x)+i(N-k)+i(A-M))||D+H<B*(i(E+x)+i(N+k)+i(A+M))||P-H>n*(i(S-x)+i(C-k)+i(O-M))||P+H<B*(i(S+x)+i(C+k)+i(O+M))||H+H<B*(i(x+x)+i(k+k)+i(M+M)))},isVisibleSphereOrigin:function(t,n){var r=Math.abs,i=n[0],s=n[1],o=n[2],u=n[3],a=n[4],f=n[5],l=n[6],c=n[7],h=n[8],p=n[9],d=n[10],v=n[11],m=n[12],g=n[13],y=n[14],b=n[15],w=-t;return!(m-b>t*(r(i-u)+r(a-c)+r(h-v))||m+b<w*(r(i+u)+r(a+c)+r(h+v))||g-b>t*(r(s-u)+r(f-c)+r(p-v))||g+b<w*(r(s+u)+r(f+c)+r(p+v))||y-b>t*(r(o-u)+r(l-c)+r(d-v))||y+b<w*(r(o+u)+r(l+c)+r(d+v))||b+b<w*(r(u+u)+r(c+c)+r(v+v)))},isVisibleSphereUnit:function(t){var n=Math.abs,r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15];return!(v-y>n(r-o)+n(u-l)+n(c-d)||v+y<-(n(r+o)+n(u+l)+n(c+d))||m-y>n(i-o)+n(a-l)+n(h-d)||m+y<-(n(i+o)+n(a+l)+n(h+d))||g-y>n(s-o)+n(f-l)+n(p-d)||g+y<-(n(s+o)+n(f+l)+n(p+d))||y+y<-(n(o+o)+n(l+l)+n(d+d)))},transformBox:function(n,r,i){var s=Math.abs,o=i[0],u=i[1],a=i[2],f=i[3],l=i[4],c=i[5],h=i[6],p=i[7],d=i[8],v=n[0],m=n[1],g=n[2],y=r[0],b=r[1],w=r[2],E=new e(3);E[0]=o*v+f*m+h*g+i[9],E[1]=u*v+l*m+p*g+i[10],E[2]=a*v+c*m+d*g+i[11];var S=new e(3);return S[0]=s(o)*y+s(f)*b+s(h)*w,S[1]=s(u)*y+s(l)*b+s(p)*w,S[2]=s(a)*y+s(c)*b+s(d)*w,{center:E,halfExtents:E}},planeNormalize:function(n,r){r===undefined&&(r=new e(4));var i=n[0],s=n[1],o=n[2],u=i*i+s*s+o*o;if(u>0){var a=1/Math.sqrt(u);r[0]=i*a,r[1]=s*a,r[2]=o*a,r[3]=n[3]*a}else r[0]=0,r[1]=0,r[2]=0,r[3]=0;return r},extractFrustumPlanes:function(n,r){var i=t.planeNormalize,s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c=n[6],h=n[7],p=n[8],d=n[9],v=n[10],m=n[11],g=n[12],y=n[13],b=n[14],w=n[15],E=r||[];return E[0]=i([a+s,h+f,m+p,-(w+g)],E[0]),E[1]=i([a-s,h-f,m-p,-(w-g)],E[1]),E[2]=i([a-o,h-l,m-d,-(w-y)],E[2]),E[3]=i([a+o,h+l,m+d,-(w+y)],E[3]),E[4]=i([a+u,h+c,m+v,-(w+b)],E[4]),E[5]=i([a-u,h-c,m-v,-(w-b)],E[5]),E},isInsidePlanesPoint:function(t,n){var r=t[0],i=t[1],s=t[2],o=n.length,u=0;do{var a=n[u];if(a[0]*r+a[1]*i+a[2]*s<a[3])return!1;u+=1}while(u<o);return!0},isInsidePlanesSphere:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=r.length,a=0;do{var f=r[a];if(f[0]*i+f[1]*s+f[2]*o<f[3]-n)return!1;a+=1}while(a<u);return!0},isInsidePlanesBox:function(t,n,r){var i=t[0],s=t[1],o=t[2],u=n[0],a=n[1],f=n[2],l=i+u,c=s+a,h=o+f,p=i-u,d=s-a,v=o-f,m=r.length,g=0;do{var y=r[g],b=y[0],w=y[1],E=y[2];if(b*(b<0?p:l)+w*(w<0?d:c)+E*(E<0?v:h)<y[3])return!1;g+=1}while(g<m);return!0},extractIntersectingPlanes:function(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n.length,l=[],c=0,h=0;do{var p=n[h],d=p[0],v=p[1],m=p[2];d*(d>0?r:o)+v*(v>0?i:u)+m*(m>0?s:a)<p[3]&&(l[c]=p,c+=1),h+=1}while(h<f);return l}};if(typeof Float32Array!="undefined"){var n=new Float32Array([1,2,3]);n[0]=t.FLOAT_MAX,t.FLOAT_MAX=n[0],e=Float32Array}t.arrayConstructor=e,TurbulenzEngine.hasOwnProperty("VMath")&&(TurbulenzEngine.VMath=t);var r=function(){function e(){}return e.prototype.subscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e)return;t.push(e)},e.prototype.unsubscribe=function(e){var t=this.subscribers,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t.splice(r,1);break}},e.prototype.unsubscribeAll=function(){this.subscribers.length=0},e.prototype.notify=function(e,t,n,r,i,s,o,u,a,f,l,c){var h=this.subscribers,p=this.subscribers.length,d=0;while(d<p)h[d].apply(null,arguments),h.length===p?d+=1:p=h.length},e.create=function(){var t=new e;return t.subscribers=[],t},e}(),i=function(){function e(){this.reasonConnectionLost=0,this.reasonServiceBusy=1}return e.prototype.retryExponential=function(e,t,n){if(!this.notifiedConnectionLost&&TurbulenzEngine.time-this.connectionLostTime>this.notifyTime*.001){this.notifiedConnectionLost=!0;var r;n===0?r=this.reasonConnectionLost:r=this.reasonServiceBusy,e.reason=r,this.onRequestTimeout(r,e)}if(this.connected)this.connectionLostTime=TurbulenzEngine.time,this.notifiedConnectionLost=!1,this.connected=!1,this.reconnectTest=e,e.status=n;else if(this.reconnectTest!==e){var i=this.reconnectedObserver,s=function(){i.unsubscribe(s),t()};i.subscribe(s);return}e.expTime?(e.expTime=2*e.expTime,e.expTime>this.maxRetryTime&&(e.expTime=this.maxRetryTime)):e.expTime=this.initialRetryTime,e.retries?e.retries+=1:e.retries=1,TurbulenzEngine.setTimeout(t,e.expTime)},e.prototype.retryAfter=function(e,t,n,r){e.retries?e.retries+=1:(e.firstRetry=TurbulenzEngine.time,e.retries=1);if(!e.notifiedMaxRetries&&TurbulenzEngine.time-e.firstRetry+t>this.notifyTime){e.notifiedMaxRetries=!0;var i=this.reasonServiceBusy;e.reason=i,this.onRequestTimeout(i,e)}TurbulenzEngine.setTimeout(n,t*1e3)},e.prototype.request=function(e){var t,n=this,r=function(i,s){if(n.destroyed)return;var o=n.sendEventToHandlers,u=n.handlers;if(s===0||s===408||s===429||s===480||s===504){n.retryExponential(e,t,s);return}n.connected||(n.connected=!0,n.reconnectTest===e&&n.notifiedConnectionLost&&n.onReconnected(n.reconnectTest.reason,n.reconnectTest),n.reconnectTest=null,n.reconnectedObserver.notify());if(e.responseFilter&&!e.responseFilter.call(this,e,t,i,s))return;if(n.responseFilter&&!n.responseFilter(e,t,i,s))return;if(e.onload){var a;i&&i.name?a=i.name:a=e.src,o(u.eventOnload,{eventType:"eventOnload",name:a}),e.onload(i,s,e),e.onload=null}e=null};t=function(){if(n.destroyed)return;e.requestFn?e.requestOwner?e.requestFn.call(e.requestOwner,e.src,r,e):e.requestFn(e.src,r,e):e.requestOwner?e.requestOwner.request(e.src,r,e):TurbulenzEngine.request(e.src,r)},t()},e.prototype.addEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t)return;i.push(t)}}},e.prototype.removeEventListener=function(e,t){var n,r,i;if(this.handlers.hasOwnProperty(e)){i=this.handlers[e];if(t){r=i.length;for(n=0;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}}}},e.prototype.sendEventToHandlers=function(e,t){var n,r=e.length;if(r)for(n=0;n<r;n+=1)e[n](t)},e.prototype.destroy=function(){this.destroyed=!0,this.handlers=null,this.onReconnected=null,this.onRequestTimeout=null},e.create=function(t){var n=new e;n.initialRetryTime=t.initialRetryTime||500,n.notifyTime=t.notifyTime||4e3,n.maxRetryTime=t.maxRetryTime||8e3,n.notifiedConnectionLost=!1,n.connected=!0,n.reconnectedObserver=r.create(),n.reconnectTest=null,n.onReconnected=t.onReconnected||function(){},n.onRequestTimeout=t.onRequestTimeout||function(){};var i={eventOnload:[]};return n.handlers=i,n},e}(),s={skipAsserts:!1,assert:function(t,n){t||this.skipAsserts||this.breakInDebugger.doesNotExist()},beget:function(t){var n=function(){};return n.prototype=t,new n},log:function(t,n){var r=window.console;if(r)switch(arguments.length){case 1:r.log(arguments[0]);break;case 2:r.log(arguments[0],arguments[1]);break;case 3:r.log(arguments[0],arguments[1],arguments[2]);break;case 4:r.log(arguments[0],arguments[1],arguments[2],arguments[3]);break;default:var i=[].splice.call(arguments,0);r.log(i.join(" "))}},nearestLowerPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t-(t>>>1)},nearestUpperPow2:function(t){return t-=1,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t+1},ajax:function(t){var n="",r=t.method,i=t.data||{},o=t.encrypt,u=null,a=t.url,f=t.requestHandler,l=t.callback;if(o){i.requestUrl=a;var c=JSON.stringify(i);r==="POST"&&(c=TurbulenzEngine.encrypt(c)),n+="data="+encodeURIComponent(c)+"&",n+="gameSessionId="+encodeURIComponent(i.gameSessionId),u=TurbulenzEngine.generateSignature(c)}else if(i){var h;for(h in i)i.hasOwnProperty(h)&&(n.length!==0&&(n+="&"),r==="POST"?n+=h+"="+i[h]:n+=encodeURIComponent(h)+"="+encodeURIComponent(i[h]))}var p=function(t,n){var r=this.xhr;this.xhr.onreadystatechange=null,this.xhr=null;if(r.getResponseHeader("Content-Type")!=="application/json; charset=utf-8")TurbulenzEngine.setTimeout(function(){l({msg:"HttpStatus "+n+" "+s.ajaxStatusCodes[n]},n),l=null},0);else{var i=JSON.parse(t);if(o){var u=r.getResponseHeader("X-TZ-Signature"),f=TurbulenzEngine.verifySignature(t,u);t=null,TurbulenzEngine.setTimeout(function(){var e=i.requestUrl;if(f)if(!TurbulenzEngine.encryptionEnabled||e===a){l(i,n),l=null;return}n===400?l(i,n,"Verification Failed"):l({msg:"Verification failed",ok:!1},400,"Verification Failed"),l=null},0)}else t=null,TurbulenzEngine.setTimeout(function(){l(i,n),l=null},0)}},d=function(i,s,o){var a;if(window.XMLHttpRequest)a=new window.XMLHttpRequest;else{if(!window.ActiveXObject){t.error&&t.error("No XMLHTTPRequest object could be created");return}a=new window.ActiveXObject("Microsoft.XMLHTTP")}o.xhr=a;var f=function(){if(a.readyState===4&&TurbulenzEngine&&!TurbulenzEngine.isUnloading()){var t=a.responseText,n=a.status,r=n!==0&&a.statusText||"No connection or cross domain request";if(a.getAllResponseHeaders()===""&&t===""&&n===200&&r==="OK"){s("",0);return}s.call(o,t,n)}};a.open(r,n&&r!=="POST"?i+"?"+n:i,!0),l&&(a.onreadystatechange=f),u&&a.setRequestHeader("X-TZ-Signature",u),r==="POST"?(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),a.send(n)):a.send()};if(f)f.request({src:a,requestFn:d,responseFilter:t.responseFilter,onload:p});else{var v={src:a};d(a,p,v)}},ajaxStatusCodes:{0:"No Connection, Timeout Or Cross Domain Request",100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Time-out",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Large",415:"Unsupported Media Type",416:"Requested range not satisfiable",417:"Expectation Failed",429:"Too Many Requests",480:"Temporarily Unavailable",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Time-out",505:"HTTP Version not supported"}},o={v2ToArray:function(t){return[t[0],t[1]]},arrayToV2:function(t,n,r){return t.v2Build(n[0],n[1],r)},v3ToArray:function(t){return[t[0],t[1],t[2]]},arrayToV3:function(t,n,r){return t.v3Build(n[0],n[1],n[2],r)},v4ToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToV4:function(t,n,r){return t.v4Build(n[0],n[1],n[2],n[3],r)},quatToArray:function(t){return[t[0],t[1],t[2],t[3]]},arrayToQuat:function(t,n,r){return t.quatBuild(n[0],n[1],n[2],n[3],r)},aabbToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]},arrayToAABB:function(t,n,r){return t.aabbBuild(n[0],n[1],n[2],n[3],n[4],n[5],r)},quatPosToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6]]},arrayToQuatPos:function(t,n,r){return t.quatPosBuild(n[0],n[1],n[2],n[3],n[4],n[5],n[6],r)},m33ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},arrayToM33:function(t,n,r){return t.m33Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],r)},m43ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},arrayToM43:function(t,n,r){return t.m43Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],r)},m34ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11]]},m44ToArray:function(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},arrayToM44:function(t,n,r){return t.m44Build(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],r)}},u=function(){function e(){}return e.prototype.add=function(){this.referenceCount+=1},e.prototype.remove=function(){this.referenceCount-=1,this.referenceCount===0&&(this.destroyedObserver&&this.destroyedObserver.notify(this.object),this.object.destroy(),this.object=null)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=r.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){var n=new e;return n.object=t,n.referenceCount=0,n},e.version=1,e}(),a={profiles:{},sortMode:{alphabetical:0,duration:1,max:2,min:3,calls:4},start:function(t){var n=this.profiles[t];n||(n={name:t,calls:0,duration:0,min:Number.MAX_VALUE,max:0,sumOfSquares:0},this.profiles[t]=n),n.start=TurbulenzEngine.time},stop:function(t){var n=TurbulenzEngine.time,r=this.profiles[t];if(r){var i=n-r.start;r.duration+=i,r.calls+=1,r.sumOfSquares+=i*i,i>r.max&&(r.max=i),i<r.min&&(r.min=i)}},reset:function(){this.profiles={}},getReport:function(t,n){var r=[],i,s=0,o;for(o in this.profiles)this.profiles.hasOwnProperty(o)&&(i=this.profiles[o],s<i.duration&&(s=i.duration),r.push(i));var u;t===a.sortMode.alphabetical?u=function(t,n){return t.name<n.name?-1:t.name>n.name?1:0}:t===a.sortMode.max?u=function(t,n){return n.max-t.max}:t===a.sortMode.min?u=function(t,n){return n.min-t.min}:t===a.sortMode.calls?u=function(t,n){return n.calls-t.calls}:u=function(t,n){return n.duration-t.duration},r.sort(u);var f,l="",c=n?n.precision:8,h=n?n.percentagePrecision:1,p=n?n.seperator:" ",d=r.length,v,m,g;for(g=0;g<d;g+=1)i=r[g],f=i.name,f+=p+i.calls,f+=p+i.duration.toFixed(c),f+=p+i.max.toFixed(c),f+=p+i.min.toFixed(c),m=i.duration/i.calls,f+=p+m.toFixed(c),v=Math.sqrt(i.sumOfSquares/i.calls-m*m),f+=p+v.toFixed(c),f+=p+(100*i.duration/s).toFixed(h)+"%\n",l+=f;return l}},f={};f.createArray=function(t){var n={},r=[];t.head&&(t=t.head);var i=function(t){var s=n[t.url];s||(s={},n[t.url]=s);var o=t.functionName===""?"(anonymous)":t.functionName,u=s[o];u||(u={},s[o]=u);var a=u[t.lineNumber];if(!a){var f={functionName:o,numberOfCalls:t.numberOfCalls,totalTime:t.totalTime,selfTime:t.selfTime,url:t.url,lineNumber:t.lineNumber};r[r.length]=f,u[t.lineNumber]=f}else a.totalTime+=t.totalTime,a.selfTime+=t.selfTime,a.numberOfCalls+=t.numberOfCalls;var l=typeof t.children=="function"?t.children():t.children;if(l){var c=l.length,h;for(h=0;h<c;h+=1)i(l[h])}};return i(t),r},f.sort=function(t,n,r){n||(n="totalTime");var i=function(e,t){return e[n]-t[n]},s=function(e,t){return t[n]-e[n]};r===!1?t.sort(i):t.sort(s)};var l=function(){function e(){}return e.create=function(t,n){var r=new e,i=null,s=t.PRIMITIVE_LINES,o=[t.VERTEXFORMAT_FLOAT2],u=t.createSemantics([t.SEMANTIC_POSITION]),a=t.createTechniqueParameters(),f=Number.MAX_VALUE,l=Math.abs,c=Math.floor,h=Math.ceil,p=f,d=f,v=-f,m=-f,g=function(t,n){p>t&&(p=t),d>n&&(d=n),v<t&&(v=t),m<n&&(m=n)},y=function(t,n){var r=t[1],i=n[1],s;r>0?i<0?(s=-r/(i-r),g(t[0]+s*(n[0]-t[0]),t[2]+s*(n[2]-t[2]))):i===0&&g(n[0],n[2]):r<0?i>0?(s=-r/(i-r),g(t[0]+s*(n[0]-t[0]),t[2]+s*(n[2]-t[2]))):i===0&&g(n[0],n[2]):(g(t[0],t[2]),i===0&&g(n[0],n[2]))};r.render=function(t,r){p=f,d=f,v=-f,m=-f;var g=r.getFrustumPoints(r.farPlane,r.nearPlane,this._frustumPoints);y(g[0],g[4]),y(g[1],g[5]),y(g[2],g[6]),y(g[3],g[7]),y(g[0],g[3]),y(g[1],g[2]),y(g[4],g[7]),y(g[5],g[6]);if(this.numLines>0&&p<v&&d<m){var b=this.numLines/2,w=r.farPlane,E=c(c(2*w)/c(b));E===0&&(E=1);var S=r.matrix,x=c(S[9]/E)*E,T=c(S[11]/E)*E,N=r.viewProjectionMatrix,C=n.m44Right(N),k=n.m44At(N),L=n.m44Pos(N),A=n.v4ScalarMul(C,w),O=n.m44Up(N),M=n.v4ScalarMul(k,w),_=n.v4Add3(n.v4ScalarMul(C,x),n.v4ScalarMul(k,T),L);a.worldViewProjection=n.m44Build(A,O,M,_,a.worldViewProjection),a.color=this.color,a.fadeToColor=this.fadeToColor,t.setTechnique(i),t.setTechniqueParameters(a);var D=1/E,P=1/w,H=(c(p*D)*E-x)*P,B=(c(d*D)*E-T)*P,j=(h(v*D)*E-x)*P,F=(h(m*D)*E-T)*P,I=2/b,q=c(b*(l(F-B)/2))+1,R=c(b*(l(j-H)/2))+1,U,z,W;U=t.beginDraw(s,q*2+R*2,o,u);if(U){z=B;for(W=0;W<q;W+=1)U(H,z),U(j,z),z+=I;z=H;for(W=0;W<R;W+=1)U(z,B),U(z,F),z+=I;t.endDraw(U),U=null}}};var b={version:1,name:"floor.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},color:{type:"float",columns:4},fadeToColor:{type:"float",columns:4}},techniques:{floor:[{parameters:["worldViewProjection","color","fadeToColor"],semantics:["POSITION"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_floor","fp_floor"]}]},programs:{fp_floor:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvec4 _ret_0;float _TMP11;float _a0012;float _TMP15;float _b0020;uniform vec4 color;uniform vec4 fadeToColor;varying vec4 tz_TexCoord[1];void main()\n{_a0012=dot(tz_TexCoord[0].xy,tz_TexCoord[0].xy);_TMP11=1.0/inversesqrt(_a0012);_b0020=min(1.0,_TMP11);_TMP15=max(0.0,_b0020);_ret_0=color+_TMP15*(fadeToColor-color);gl_FragColor=_ret_0;}"},vp_floor:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;\nvec4 _OUTPosition1;vec2 _OUTDistance1;uniform vec4 worldViewProjection[4];void main()\n{_OUTPosition1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[2]+worldViewProjection[3];_OUTDistance1=ATTR0.xy;tz_TexCoord[0].xy=ATTR0.xy;gl_Position=_OUTPosition1;}"}}},w=t.createShader(b);return w?(i=w.getTechnique(0),r):null},e.version=1,e}();l.prototype.color=[.1,.1,1,1],l.prototype.fadeToColor=[.95,.95,1,1],l.prototype.numLines=200,l.prototype._frustumPoints=[];var c=function(){function e(){}return e.create=function(){return new e},e}(),h=function(){function e(){}return e.prototype.push=function(e,t){var n=c.create();n.key=e,n.value=t,n.timeOffset=TurbulenzEngine.time,this.events.push(n)},e.prototype.length=function(){return this.events.length},e.prototype.clear=function(){this.events.length=0},e.create=function(){var t=new e;return t.events=[],t},e}(),p=function(){function e(){}return e.prototype.request=function(e){var t=function(){e.callback&&e.callback({ok:!1,msg:"Service Unavailable. Discarding request"},503)},n=this,r=this.serviceStatusObserver,i;i=function(o,u){u?e.neverDiscard||(r.unsubscribe(i),t()):o&&(r.unsubscribe(i),n.request(e))};if(!this.running)return this.discardRequests&&!e.neverDiscard?(TurbulenzEngine.setTimeout(t,0),!1):(e.waiting||(e.waiting=!0,r.subscribe(i)),!0);var o=e.responseFilter;return e.responseFilter=function(u,a,f,l){if(l===503){var c=JSON.parse(f),h=c.data,p=h?h.discardRequests:!0;return n.discardRequests=p,p&&!e.neverDiscard?t():r.subscribe(i),d.serviceUnavailable(n,u),!1}return o?o.call(e.requestHandler,u,a,f,l):!0},s.ajax(e),!0},e.create=function(t,n){var i=new e;return n||(n={}),i.running=!0,i.discardRequests=!1,i.serviceStatusObserver=r.create(),i.serviceName=t,i.onServiceUnavailable=n.onServiceUnavailable,i.onServiceAvailable=n.onServiceAvailable,i},e}(),d=function(){function e(){}return e.available=function(){return window.gameSlug!==undefined},e.addBridgeEvents=function(){var e=window.top.Turbulenz,t=e&&e.Data||{},n=t.joinMultiplayerSessionId,r=this,i=function(t){r.multiplayerJoinRequestQueue.push(t)},s=function(t){var n=JSON.parse(t);n.mode&&(r.mode=n.mode),n.joinMultiplayerSessionId&&r.multiplayerJoinRequestQueue.push(n.joinMultiplayerSessionId),r.bridgeServices=!!n.bridgeServices};n&&this.multiplayerJoinRequestQueue.push(n),v.setOnMultiplayerSessionToJoin(i),v.setOnReceiveConfig(s),v.triggerRequestConfig(),this.responseHandlers=[null],this.responseIndex=0,v.on("bridgeservices.response",function(e){r.routeResponse(e)})},e.callOnBridge=function(e,t,n){var r={data:t,key:undefined};n&&(this.responseIndex+=1,this.responseHandlers[this.responseIndex]=n,r.key=this.responseIndex),v.emit("bridgeservices."+e,JSON.stringify(r))},e.addSignature=function(e,t){var n;return e.requestUrl=t,n=TurbulenzEngine.encrypt(JSON.stringify(e)),e.str=n,e.signature=TurbulenzEngine.generateSignature(n),e},e.routeResponse=function(e){var t=JSON.parse(e),n=t.key||0,r=this.responseHandlers[n];r&&(this.responseHandlers[n]=null,r(t.data))},e.onServiceUnavailable=function(e,t){},e.onServiceAvailable=function(e,t){},e.createGameSession=function(e,t,n){return m.create(e,t,n)},e.createMappingTable=function(t,n,r,i,s){var o,u=n&&n.mappingTable,a,f,l;u?(a=u.mappingTableURL,f=u.mappingTablePrefix,l=u.assetPrefix):i?(a=i.mappingTableURL||(i.mappingTableURL===""?"":"mapping_table.json"),f=i.mappingTablePrefix||(i.mappingTablePrefix===""?"":"staticmax/"),l=i.assetPrefix||(i.assetPrefix===""?"":"missing/")):(a="mapping_table.json",f="staticmax/",l="missing/");var c=function(n){var r=i&&(i.urnMapping||{}),u=s||e.defaultErrorCallback;o.setMapping(r),u(n)},h={mappingTableURL:a,mappingTablePrefix:f,assetPrefix:l,requestHandler:t,onload:r,errorCallback:c};return o=g.create(h),o},e.createLeaderboardManager=function(e,t,n,r){return LeaderboardManager.create(e,t,n,r)},e.createBadgeManager=function(e,t){return BadgeManager.create(e,t)},e.createStoreManager=function(e,t,n,r){return StoreManager.create(e,t,n,r)},e.createNotificationsManager=function(e,t,n,r){return NotificationsManager.create(e,t,n,r)},e.createMultiplayerSessionManager=function(e,t){return MultiPlayerSessionManager.create(e,t)},e.createUserProfile=function(t,n,r){var i={};r||(r=e.defaultErrorCallback);var s=function(t){if(t&&t.ok){t=t.data;var n;for(n in t)t.hasOwnProperty(n)&&(i[n]=t[n])}},o="/api/v1/profiles/user";return e.available()&&this.getService("profiles").request({url:o,method:"GET",callback:function(t,o){o===200?s(t):r&&r("TurbulenzServices.createUserProfile error with HTTP status "+o+": "+t.msg,o),n&&n(i)},requestHandler:t}),i},e.upgradeAnonymousUser=function(e){if(e){var t=function(n){e()};v.on("user.upgrade.occurred",t)}v.emit("user.upgrade.show")},e.sendCustomMetricEvent=function(t,n,r,i,s){s||(s=e.defaultErrorCallback);if(!e.available()){s("TurbulenzServices.sendCustomMetricEvent failed: Service not available",0);return}if("string"!=typeof t||0===t.length){s("TurbulenzServices.sendCustomMetricEvent failed: Event key must be a non-empty string",0);return}if("number"!=typeof n||isNaN(n)||!isFinite(n)){if("[object Array]"!==Object.prototype.toString.call(n)){s("TurbulenzServices.sendCustomMetricEvent failed: Event value must be a number or an array of numbers",0);return}var o,u=n.length;for(o=0;o<u;o+=1)if("number"!=typeof n[o]||isNaN(n[o])||!isFinite(n[o])){s("TurbulenzServices.sendCustomMetricEvent failed: Event value array elements must be numbers",0);return}}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event/"+i.gameSlug,method:"POST",data:{key:t,value:n,gameSessionId:i.gameSessionId},callback:function(t,n){n!==200&&s("TurbulenzServices.sendCustomMetricEvent error with HTTP status "+n+": "+t.msg,n)},requestHandler:r,encrypt:!0})},e.sendCustomMetricEventBatch=function(t,n,r,i){i||(i=e.defaultErrorCallback);if(!e.available()){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Service not available",0);return}var s=TurbulenzEngine.time,o=t.events,u,a=o.length;for(u=0;u<a;u+=1){var f=o[u].key,l=o[u].value,c=o[u].timeOffset;if("string"!=typeof f||0===f.length){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event key must be a non-empty string",0);return}if("number"!=typeof l||isNaN(l)||!isFinite(l)){if("[object Array]"!==Object.prototype.toString.call(l)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value must be a number or an array of numbers",0);return}var h,p=l.length;for(h=0;h<p;h+=1)if("number"!=typeof l[h]||isNaN(l[h])||!isFinite(l[h])){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event value array elements must be numbers",0);return}}if("number"!=typeof c||isNaN(c)||!isFinite(c)){i&&i("TurbulenzServices.sendCustomMetricEventBatch failed: Event time offset is corrupted",0);return}o[u].timeOffset=c-s}this.getService("customMetrics").request({url:"/api/v1/custommetrics/add-event-batch/"+r.gameSlug,method:"POST",data:{batch:o,gameSessionId:r.gameSessionId},callback:function(t,n){n!==200&&i&&i("TurbulenzServices.sendCustomMetricEventBatch error with HTTP status "+n+": "+t.msg,n)},requestHandler:n,encrypt:!0})},e.getService=function(e){var t=this.services;if(t.hasOwnProperty(e))return t[e];var n=p.create(e);return t[e]=n,n},e.serviceUnavailable=function(t,n){var r=this.waitingServices,i=t.serviceName;if(r.hasOwnProperty(i))return;r[i]=t,t.running=!1;var o=function(r){var i=n.onServiceUnavailable;i&&i.call(r,n),r.onServiceUnavailable&&r.onServiceUnavailable(),e.onServiceUnavailable&&e.onServiceUnavailable(r)};t.discardRequests&&o(t);if(this.pollingServiceStatus)return;var u=this,a,f="/api/v1/service-status/game/read/"+window.gameSlug,l=function(i,s){if(s===200){var f=i.data,l=f.services,c=!1,h;for(h in r)if(r.hasOwnProperty(h)){var p=r[h],d=l[h],v=d.running;p.running=v,p.description=d.description;if(v){if(p.discardRequests){var m=n.onServiceAvailable;m&&m.call(p,n),p.onServiceAvailable&&p.onServiceAvailable(),e.onServiceAvailable&&e.onServiceAvailable(p)}delete r[h],p.discardRequests=!1,p.serviceStatusObserver.notify(v,p.discardRequests)}else d.discardRequests&&!p.discardRequests&&
(p.discardRequests=!0,o(p),p.serviceStatusObserver.notify(v,p.discardRequests)),c=!0}if(!c){this.pollingServiceStatus=!1;return}TurbulenzEngine.setTimeout(a,f.pollInterval*1e3)}else TurbulenzEngine.setTimeout(a,u.defaultPollInterval)};a=function(){s.ajax({url:f,method:"GET",callback:l})},a()},e.multiplayerJoinRequestQueue={argsQueue:[],handler:function(){},context:undefined,paused:!0,onEvent:function(t,n){this.handler=t,this.context=n},push:function(t){var n=[t];this.paused?this.argsQueue.push(n):this.handler.apply(this.context,n)},shift:function(){var t=this.argsQueue.shift();return t?t[0]:undefined},clear:function(){this.argsQueue=[]},pause:function(){this.paused=!0},resume:function(){this.paused=!1;while(this.argsQueue.length){this.handler.apply(this.context,this.argsQueue.shift());if(this.paused)break}}},e.defaultErrorCallback=function(e,t){},e.services={},e.waitingServices={},e.pollingServiceStatus=!1,e.defaultPollInterval=4e3,e}();typeof v!="undefined"&&d.addBridgeEvents();var v=function(){function e(){}return e._initInstance=function(){var e=window.top.Turbulenz;if(e&&e.Services){var t=e.Services.bridge;if(!t)return;this._bridge=t,this.emit=t.emit,this.on=t.gameListenerOn||t.addListener||t.setListener,this.addListener=t.gameListenerOn||t.addListener||t.setListener,this.setListener=t.gameListenerOn||t.setListener}typeof d!="undefined"&&d.addBridgeEvents()},e.isInitialised=function(){return this._bridge!==undefined},e.emit=function(e,t,n){},e.on=function(e,t){},e.addListener=function(){},e.setListener=function(e,t){},e.setOnReceiveConfig=function(e){this.on("config.set",e)},e.triggerRequestConfig=function(){this.emit("config.request")},e.startLoading=function(){this.emit("status.loading.start")},e.startSaving=function(){this.emit("status.saving.start")},e.stopLoading=function(){this.emit("status.loading.stop")},e.stopSaving=function(){this.emit("status.saving.stop")},e.createdGameSession=function(e){this.emit("game.session.created",e)},e.destroyedGameSession=function(e){this.emit("game.session.destroyed",e)},e.setGameSessionStatus=function(e,t){this.emit("game.session.status",e,t)},e.setGameSessionInfo=function(e){this.emit("game.session.info",e)},e.updateUserBadge=function(e){this.emit("userbadge.update",e)},e.updateLeaderBoard=function(e){this.emit("leaderboards.update",e)},e.setOnMultiplayerSessionToJoin=function(e){this.on("multiplayer.session.join",e)},e.triggerJoinedMultiplayerSession=function(e){this.emit("multiplayer.session.joined",e)},e.triggerLeaveMultiplayerSession=function(e){this.emit("multiplayer.session.leave",e)},e.triggerMultiplayerSessionMakePublic=function(e){this.emit("multiplayer.session.makepublic",e)},e.setOnBasketUpdate=function(e){this.on("basket.site.update",e)},e.triggerBasketUpdate=function(e){this.emit("basket.game.update.v2",e)},e.triggerUserStoreUpdate=function(e){this.emit("store.user.update",e)},e.setOnPurchaseConfirmed=function(e){this.on("purchase.confirmed",e)},e.setOnPurchaseRejected=function(e){this.on("purchase.rejected",e)},e.triggerShowConfirmPurchase=function(){this.emit("purchase.show.confirm")},e.triggerFetchStoreMeta=function(){this.emit("fetch.store.meta")},e.setOnStoreMeta=function(e){this.on("store.meta.v2",e)},e.triggerSendInstantNotification=function(e){this.emit("notifications.ingame.sendInstant",e)},e.triggerSendDelayedNotification=function(e){this.emit("notifications.ingame.sendDelayed",e)},e.setOnNotificationSent=function(e){this.on("notifications.ingame.sent",e)},e.triggerCancelNotificationByID=function(e){this.emit("notifications.ingame.cancelByID",e)},e.triggerCancelNotificationsByKey=function(e){this.emit("notifications.ingame.cancelByKey",e)},e.triggerCancelAllNotifications=function(e){this.emit("notifications.ingame.cancelAll",e)},e.triggerInitNotificationManager=function(e){this.emit("notifications.ingame.initNotificationManager",e)},e.setOnReceiveNotification=function(e){this.on("notifications.ingame.receive",e)},e.changeAspectRatio=function(e){this.emit("change.viewport.ratio",e)},e.setOnViewportHide=function(e){this.on("change.viewport.hide",e)},e.setOnViewportShow=function(e){this.on("change.viewport.show",e)},e.setOnFullscreenOn=function(e){this.on("change.viewport.fullscreen.on",e)},e.setOnFullscreenOff=function(e){this.on("change.viewport.fullscreen.off",e)},e.setOnMenuStateChange=function(e){this.on("change.menu.state",e)},e.setOnUserStateChange=function(e){this.on("change.user.state",e)},e.triggerOnFullscreen=function(){this.emit("trigger.viewport.fullscreen")},e.triggerOnViewportVisibility=function(){this.emit("trigger.viewport.visibility")},e.triggerOnMenuStateChange=function(){this.emit("trigger.menu.state")},e.triggerOnUserStateChange=function(){this.emit("trigger.user.state")},e.queryFullscreen=function(e){this.emit("query.viewport.fullscreen",e)},e.queryViewportVisibility=function(e){this.emit("query.viewport.visibility",e)},e.queryMenuState=function(e){this.emit("query.menu.state",e)},e.queryUserState=function(e){this.emit("query.user.state",e)},e._bridge=undefined,e}();v.isInitialised()||v._initInstance();var m=function(){function e(){this.post_delay=1e3}return e.prototype.setStatus=function(e){if(this.destroyed||this.status===e)return;this.status=e,v.setGameSessionStatus(this.gameSessionId,e)},e.prototype.destroy=function(e){var t;this.pendingUpdate&&(TurbulenzEngine.clearTimeout(this.pendingUpdate),this.pendingUpdate=null),!this.destroyed&&this.gameSessionId?(v.destroyedGameSession(this.gameSessionId),this.destroyed=!0,t={gameSessionId:this.gameSessionId},d.bridgeServices?d.callOnBridge("gamesession.destroy",t,e):s.ajax({url:"/api/v1/games/destroy-session",method:"POST",data:t,callback:e,requestHandler:this.requestHandler})):e&&TurbulenzEngine.setTimeout(e,0)},e.prototype.setTeamInfo=function(e){var t=this.info.sessionData,n=t.teamList||[];e.join("#")!==n.join("#")&&(t.teamList=e,this.update())},e.prototype.setPlayerInfo=function(e,t){var n=this.info.playerSessionData[e],r,i=!1;n||(n={},this.info.playerSessionData[e]=n,i=!0);for(r in t)if(t.hasOwnProperty(r)){if(!this.templatePlayerData.hasOwnProperty(r))throw"unknown session data property "+r;n[r]!==t[r]&&(n[r]=t[r],i=!0)}i&&this.update()},e.prototype.removePlayerInfo=function(e){delete this.info.playerSessionData[e],this.update()},e.prototype.clearAllPlayerInfo=function(){this.info.playerSessionData={},this.update()},e.prototype.update=function(){this.pendingUpdate||(this.pendingUpdate=TurbulenzEngine.setTimeout(this.postData,this.post_delay))},e.create=function(t,n,r){var i=new e,s=window.gameSlug,o=window.top.Turbulenz,u=o&&o.Data||{},a=u.mode||d.mode,f="/api/v1/games/create-session/"+s;i.info={sessionData:{},playerSessionData:{}},i.templatePlayerData={team:null,color:null,status:null,rank:null,score:null,sortkey:null},i.postData=function(){v.setGameSessionInfo(JSON.stringify(i.info)),i.pendingUpdate=null},i.pendingUpdate=null,i.gameSlug=s,i.requestHandler=t,i.errorCallbackFn=r||d.defaultErrorCallback,i.gameSessionId=null,i.service=d.getService("gameSessions"),i.status=null;if(!d.available())return n&&TurbulenzEngine.setTimeout(function(){n(i)},0),i;var l=function(t,r){r===200?(i.mappingTable=t.mappingTable,i.gameSessionId=t.gameSessionId,n&&n(i),v.createdGameSession(i.gameSessionId)):404===r?(window.gameSlug=undefined,i.gameSlug=undefined,n&&n(i)):i.errorCallbackFn("TurbulenzServices.createGameSession error with HTTP status "+r+": "+t.msg,r)};return a&&(f+="/"+a),i.service.request({url:f,method:"POST",callback:l,requestHandler:t,neverDiscard:!0}),i},e.version=1,e}(),g=function(){function e(){}return e.prototype.getURL=function(e,t){var n=this.overrides,r=this.currentProfile,i=n[r],s;while(i){s=i.urnmapping[e];if(s)return s;i=n[i.parent]}return s=this.urlMapping[e],s?s:(t&&t(e),this.assetPrefix+e)},e.prototype.setMapping=function(e){this.urlMapping=e},e.prototype.map=function(e,t){this.urlMapping[e]=t},e.prototype.alias=function(e,t){var n=this.urlMapping;n[e]=n[t]},e.prototype.getCurrentProfile=function(){return this.currentProfile},e.prototype.setProfile=function(e){this.overrides.hasOwnProperty(e)?this.currentProfile=e:this.currentProfile=undefined},e.create=function(t){var n=new e;n.mappingTableURL=t.mappingTableURL,n.tablePrefix=t.mappingTablePrefix,n.assetPrefix=t.assetPrefix,n.overrides={},n.errorCallbackFn=t.errorCallback||d.defaultErrorCallback,n.currentProfile=TurbulenzEngine.getSystemInfo().platformProfile;var r=function(r){var i=r.urnmapping||r.urnremapping||{},s=r.overrides||{};n.urlMapping=i,n.overrides=s;var o=n.tablePrefix;if(o){var u=function(t){var n;for(n in t)t.hasOwnProperty(n)&&(t[n]=o+t[n])};u(i);var a;for(a in s)s.hasOwnProperty(a)&&u(s[a].urnmapping)}t.onload(n)};return n.mappingTableURL?t.requestHandler.request({src:n.mappingTableURL,onload:function(t,i){if(i===200){var s=JSON.parse(t);r(s)}else n.urlMapping={},t=t||{msg:"(no response)"},n.errorCallbackFn("MappingTable.create: HTTP status "+i+": "+t.msg,i)}}):t.mappingTableData?TurbulenzEngine.setTimeout(function(){r(JSON.parse(t.mappingTableData))},0):TurbulenzEngine.setTimeout(function(){n.errorCallbackFn("!! mappingtable params contain no url or data")},0),n},e.version=1,e}(),y=function(){function e(){this.viewOffsetX=0,this.viewOffsetY=0,this.recipViewWindowX=1,this.recipViewWindowY=1,this.infinite=!1,this.parallel=!1,this.aspectRatio=4/3,this.nearPlane=1,this.farPlane=1e3}return e.prototype.lookAt=function(e,t,n){var r=this.md,i=r.v3Normalize,s=r.v3Cross,o=r.v3Sub(n,e);i.call(r,o,o);var u=s.call(r,i.call(r,t,t),o);i.call(r,u,u);var a=s.call(r,o,u);this.matrix=r.m43Build(u,a,o,n,this.matrix)},e.prototype.updateProjectionMatrix=function(){var e=this.recipViewWindowX,t=this.recipViewWindowY*this.aspectRatio,n=e*this.viewOffsetX,r=t*this.viewOffsetY,i=this.farPlane,s=this.nearPlane,o;i!==s?o=1/(i-s):o=0;var u,a,f,l;this.parallel?(u=-2*o,f=-(i+s)*o,a=0,l=1):(this.infinite?u=-1:u=-(i+s)*o,f=-(2*i*s*o),a=-1,l=0),this.projectionMatrix=this.md.m44Build(e,0,0,0,0,t,0,0,-n,-r,u,a,0,0,f,l,this.projectionMatrix)},e.prototype.updateViewMatrix=function(){var e=this.md;this.viewMatrix=e.m43InverseOrthonormal(this.matrix,this.viewMatrix)},e.prototype.updateViewProjectionMatrix=function(){var e=this.md;this.viewProjectionMatrix=e.m43MulM44(this.viewMatrix,this.projectionMatrix,this.viewProjectionMatrix)},e.prototype.extractFrustumPlanes=function(e,t){var n=this.md,r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t||[],w=n.v4Build(o+r,l+u,d+c,-(y+v));return b[0]=n.planeNormalize(w,b[0]),n.v4Build(o-r,l-u,d-c,-(y-v),w),b[1]=n.planeNormalize(w,b[1]),n.v4Build(o-i,l-a,d-h,-(y-m),w),b[2]=n.planeNormalize(w,b[2]),n.v4Build(o+i,l+a,d+h,-(y+m),w),b[3]=n.planeNormalize(w,b[3]),n.v4Build(o+s,l+f,d+p,-(y+g),w),b[4]=n.planeNormalize(w,b[4]),n.v4Build(o-s,l-f,d-p,-(y-g),w),b[5]=n.planeNormalize(w,b[5]),b},e.prototype.updateFrustumPlanes=function(){this.frustumPlanes=this.extractFrustumPlanes(this.viewProjectionMatrix,this.frustumPlanes)},e.prototype.isVisiblePoint=function(e){var t=this.md;return t.isInsidePlanesPoint(e,this.frustumPlanes)},e.prototype.isVisibleSphere=function(e,t){var n=this.md;return n.isInsidePlanesSphere(e,t,this.frustumPlanes)},e.prototype.isVisibleBox=function(e,t){var n=this.md;return n.isInsidePlanesBox(e,t,this.frustumPlanes)},e.prototype.isVisibleAABB=function(e){var t=this.md;return t.aabbIsInsidePlanes(e,this.frustumPlanes)},e.prototype.isFullyInsideAABB=function(e){var t=this.md;return t.aabbIsFullyInsidePlanes(e,this.frustumPlanes)},e.prototype.getFrustumPoints=function(e,t,n){var r=this.md,i=this.viewOffsetX,s=this.viewOffsetY,o=1/this.recipViewWindowX,u=1/(this.recipViewWindowY*this.aspectRatio),a=this.matrix,f=e||this.farPlane,l=t!==undefined?t:this.nearPlane,c=n||new Array(8);if(!this.parallel){var h=a[0]*i+a[3]*s,p=a[1]*i+a[4]*s,d=a[2]*i+a[5]*s,v=a[0]*o,m=a[1]*o,g=a[2]*o,y=a[3]*u,b=a[4]*u,w=a[5]*u,E=h-a[6],S=p-a[7],x=d-a[8],T=a[9]+h,N=a[10]+p,C=a[11]+d,k=E+v+y,L=S+m+b,A=x+g+w,O=E-v+y,M=S-m+b,_=x-g+w,D=E-v-y,P=S-m-b,H=x-g-w,B=E+v-y,j=S+m-b,F=x+g-w;c[0]=r.v3Build(T+k*l,N+L*l,C+A*l,c[0]),c[1]=r.v3Build(T+O*l,N+M*l,C+_*l,c[1]),c[2]=r.v3Build(T+D*l,N+P*l,C+H*l,c[2]),c[3]=r.v3Build(T+B*l,N+j*l,C+F*l,c[3]),c[4]=r.v3Build(T+k*f,N+L*f,C+A*f,c[4]),c[5]=r.v3Build(T+O*f,N+M*f,C+_*f,c[5]),c[6]=r.v3Build(T+D*f,N+P*f,C+H*f,c[6]),c[7]=r.v3Build(T+B*f,N+j*f,C+F*f,c[7])}else{var I=(1-l)*i,q=(1-f)*i,R=(1-l)*s,U=(1-f)*s;c[0]=r.v3Build(o+I,u+R,l,c[0]),c[1]=r.v3Build(I-o,u+R,l,c[1]),c[2]=r.v3Build(I-o,R-u,l,c[2]),c[3]=r.v3Build(o+I,R-u,l,c[3]),c[4]=r.v3Build(o+q,u+U,f,c[4]),c[5]=r.v3Build(q-o,u+U,f,c[5]),c[6]=r.v3Build(q-o,U-u,f,c[6]),c[7]=r.v3Build(o+q,U-u,f,c[7]),r.m43TransformPoint(a,c[0],c[0]),r.m43TransformPoint(a,c[1],c[1]),r.m43TransformPoint(a,c[2],c[2]),r.m43TransformPoint(a,c[3],c[3]),r.m43TransformPoint(a,c[4],c[4]),r.m43TransformPoint(a,c[5],c[5]),r.m43TransformPoint(a,c[6],c[6]),r.m43TransformPoint(a,c[7],c[7])}return c},e.prototype.getFrustumFarPoints=function(e,t){var n=this.md,r=this.viewOffsetX,i=this.viewOffsetY,s=1/this.recipViewWindowX,o=1/(this.recipViewWindowY*this.aspectRatio),u=this.matrix,a=e||this.farPlane,f=t||new Array(4);if(!this.parallel){var l=u[0],c=u[1],h=u[2],p=u[3],d=u[4],v=u[5],m=u[6],g=u[7],y=u[8],b=u[9],w=u[10],E=u[11],S=l*r+p*i,x=c*r+d*i,T=h*r+v*i,N=l*s,C=c*s,k=h*s,L=p*o,A=d*o,O=v*o,M=S-m,_=x-g,D=T-y,P=b+S,H=w+x,B=E+T,j=(M+N+L)*a,F=(_+C+A)*a,I=(D+k+O)*a,q=(M-N+L)*a,R=(_-C+A)*a,U=(D-k+O)*a,z=(M-N-L)*a,W=(_-C-A)*a,X=(D-k-O)*a,V=(M+N-L)*a,$=(_+C-A)*a,J=(D+k-O)*a;f[0]=n.v3Build(P+j,H+F,B+I,f[0]),f[1]=n.v3Build(P+q,H+R,B+U,f[1]),f[2]=n.v3Build(P+z,H+W,B+X,f[2]),f[3]=n.v3Build(P+V,H+$,B+J,f[3])}else{var K=(1-a)*r,Q=(1-a)*i;f[0]=n.v3Build(s+K,o+Q,a,f[0]),f[1]=n.v3Build(K-s,o+Q,a,f[1]),f[2]=n.v3Build(K-s,Q-o,a,f[2]),f[3]=n.v3Build(s+K,Q-o,a,f[3]),n.m43TransformPoint(u,f[0],f[0]),n.m43TransformPoint(u,f[1],f[1]),n.m43TransformPoint(u,f[2],f[2]),n.m43TransformPoint(u,f[3],f[3])}return f},e.prototype.getFrustumExtents=function(e,t,n){var r=this.getFrustumPoints(t,n),i=r[0],s=i[0],o=i[1],u=i[2],a=s,f=o,l=u;for(var c=1;c<8;c+=1){i=r[c];var h=i[0],p=i[1],d=i[2];s>h?s=h:a<h&&(a=h),o>p?o=p:f<p&&(f=p),u>d?u=d:l<d&&(l=d)}e[0]=s,e[1]=o,e[2]=u,e[3]=a,e[4]=f,e[5]=l},e.create=function(t){var n=new e;return n.md=t,n.matrix=t.m43BuildIdentity(),n.viewMatrix=t.m43BuildIdentity(),n.updateProjectionMatrix(),n.viewProjectionMatrix=n.projectionMatrix.slice(),n.frustumPlanes=[],n.updateFrustumPlanes(),n},e.version=1,e}(),b=function(){function e(){this.rotateSpeed=2,this.maxSpeed=1,this.mouseRotateFactor=.1}return e.prototype.rotate=function(e,t){var n=Math.PI/180,r=this.md,i=this.camera.matrix,s=r.m43Pos(i);r.m43SetPos(i,r.v3BuildZero());var o;if(t!==0){t*=this.rotateSpeed*n,t*=this.mouseRotateFactor;var u=r.v3Normalize(r.m43Right(i));r.m43SetRight(i,u),o=r.m43FromAxisRotation(u,t),i=r.m43Mul(i,o)}e!==0&&(e*=this.rotateSpeed*n,e*=this.mouseRotateFactor,o=r.m43FromAxisRotation(r.v3BuildYAxis(),e),i=r.m43Mul(i,o)),r.m43SetPos(i,s),this.camera.matrix=i},e.prototype.translate=function(e,t,n){var r=this.md,i=this.camera.matrix,s=r.m43Pos(i),o=this.maxSpeed;s=r.v3Add4(s,r.v3ScalarMul(r.m43Right(i),o*e),r.v3ScalarMul(r.m43Up(i),o*t),r.v3ScalarMul(r.m43At(i),-(o*n))),r.m43SetPos(i,s)},e.prototype.update=function(){var e=!1;if(this.turn!==0||this.pitch!==0)e=!0,this.rotate(this.turn,this.pitch),this.turn=0,this.pitch=0;this.step>0?this.forward+=this.step:this.step<0&&(this.backward-=this.step);var t=this.right+this.padright-(this.left+this.padleft),n=this.up-this.down,r=this.forward+this.padforward-(this.backward+this.padbackward);if(t!==0||n!==0||r!==0)e=!0,this.translate(t,n,r),this.step>0?(this.forward-=this.step,this.step=0):this.step<0&&(this.backward+=this.step,this.step=0);e&&this.camera.updateViewMatrix()},e.create=function(t,n,r,i){var s=new e;s.md=r.md,s.camera=r,s.turn=0,s.pitch=0,s.right=0,s.left=0,s.up=0,s.down=0,s.forward=0,s.backward=0,s.step=0,s.padright=0,s.padleft=0,s.padforward=0,s.padbackward=0,s.looktouch={id:-1,originX:0,originY:0},s.movetouch={id:-1,originX:0,originY:0};var o;n&&(o=n.keyCodes);var u=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=1;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=1;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=1;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=1;break;case o.E:case o.NUMPAD_9:s.up=1;break;case o.Q:case o.NUMPAD_7:s.down=1}},a=function(e){switch(e){case o.A:case o.LEFT:case o.NUMPAD_4:s.left=0;break;case o.D:case o.RIGHT:case o.NUMPAD_6:s.right=0;break;case o.W:case o.UP:case o.NUMPAD_8:s.forward=0;break;case o.S:case o.DOWN:case o.NUMPAD_2:s.backward=0;break;case o.E:case o.NUMPAD_9:s.up=0;break;case o.Q:case o.NUMPAD_7:s.down=0;break;case o.RETURN:t.fullscreen=!t.fullscreen}};return i?(s.onkeydown=function(t){i.innerHTML+=" KeyDown:&nbsp;"+t,u(t)},s.onkeyup=function(t){t===o.BACKSPACE?i.innerHTML="":i.innerHTML+=" KeyUp:&nbsp;"+t,a(t)}):(s.onkeydown=u,s.onkeyup=a),s.onmouseup=function(){n.isLocked()||n.lockMouse()},s.onmousewheel=function(t){s.step=t*5},s.onmousemove=function(t,n){s.turn+=t,s.pitch+=n},s.onpadmove=function(t,n,r,i,o){s.turn+=t*10,s.pitch+=n*10,i>=0?(s.padright=i,s.padleft=0):(s.padright=0,s.padleft=-i),o>=0?(s.padforward=o,s.padbackward=0):(s.padforward=0,s.padbackward=-o)},s.onmouselocklost=function(){n.unlockMouse()},s.ontouchstart=function(n){var r=n.changedTouches,i=r.length,o,u=t.width*.5;for(o=0;o<i;o+=1){var a=r[o].identifier,f=r[o].positionX,l=r[o].positionY;f<u&&s.looktouch.id===-1?(s.looktouch.id=a,s.looktouch.originX=f,s.looktouch.originY=l):f>=u&&s.movetouch.id===-1&&(s.movetouch.id=a,s.movetouch.originX=f,s.movetouch.originY=l)}},s.ontouchend=function(t){var n=t.changedTouches,r=n.length,i;for(i=0;i<r;i+=1){var o=n[i].identifier;s.looktouch.id===o?(s.looktouch.id=-1,s.looktouch.originX=0,s.looktouch.originY=0,s.turn=0,s.pitch=0):s.movetouch.id===o&&(s.movetouch.id=-1,s.movetouch.originX=0,s.movetouch.originY=0,s.left=0,s.right=0,s.forward=0,s.backward=0)}},s.ontouchmove=function(t){var n=t.changedTouches,r=n.length,i=16,o;for(o=0;o<r;o+=1){var u=n[o].identifier,a=n[o].positionX,f=n[o].positionY;s.looktouch.id===u?(a-s.looktouch.originX>i||a-s.looktouch.originX<-i?s.turn=(a-s.looktouch.originX)/i:s.turn=0,f-s.looktouch.originY>i||f-s.looktouch.originY<-i?s.pitch=(f-s.looktouch.originY)/16:s.pitch=0):s.movetouch.id===u&&(a-s.movetouch.originX>i?(s.left=0,s.right=1):a-s.movetouch.originX<-i?(s.left=1,s.right=0):(s.left=0,s.right=0),f-s.movetouch.originY>i?(s.forward=0,s.backward=1):f-s.movetouch.originY<-i?(s.forward=1,s.backward=0):(s.forward=0,s.backward=0))}},s.attach=function(t){t.addEventListener("keydown",s.onkeydown),t.addEventListener("keyup",s.onkeyup),t.addEventListener("mouseup",s.onmouseup),t.addEventListener("mousewheel",s.onmousewheel),t.addEventListener("mousemove",s.onmousemove),t.addEventListener("padmove",s.onpadmove),t.addEventListener("mouselocklost",s.onmouselocklost),t.addEventListener("touchstart",s.ontouchstart),t.addEventListener("touchend",s.ontouchend),t.addEventListener("touchmove",s.ontouchmove)},n&&s.attach(n),s},e.version=1,e}(),w=function(){function e(e,t,n){return this.escapeNodeOffset=t,this.externalNode=n,this.extents=e,this}return e.prototype.isLeaf=function(){return!!this.externalNode},e.prototype.reset=function(e,t,n,r,i,s,o,u){this.escapeNodeOffset=o,this.externalNode=u;var a=this.extents;a[0]=e,a[1]=t,a[2]=n,a[3]=r,a[4]=i,a[5]=s},e.prototype.clear=function(){this.escapeNodeOffset=1,this.externalNode=undefined;var e=this.extents,t=Number.MAX_VALUE;e[0]=t,e[1]=t,e[2]=t,e[3]=-t,e[4]=-t,e[5]=-t},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}(),E=function(){function e(e){this.numNodesLeaf=4,this.nodes=[],this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.highQuality=e,this.ignoreY=!1,this.nodesStack=new Array(32)}return e.allocateNode=function(){var e=this.nodesPool;if(!e.length){var t=this.nodesPoolAllocationSize,n=this.useFloat32Array,r,i;n&&(r=new Float32Array(t*6),i=0);var s,o;for(s=0;s<t;s+=1)n?(o=r.subarray(i,i+6),i+=6):o=[0,0,0,0,0,0],e[s]=w.create(o,1,undefined)}return e.pop()},e.releaseNode=function(e){var t=this.nodesPool;t.length<this.nodesPoolAllocationSize&&(e.clear(),t.push(e))},e.recycleNodes=function(e,t){var n=e.length,r;for(r=t;r<n;r+=1){var i=e[r];i&&this.releaseNode(i)}e.length=t},e.prototype.add=function(t,n){var r=this.endNode;t.spatialIndex=r;var i=e.allocateNode();i.escapeNodeOffset=1,i.externalNode=t;var s=i.extents;s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=n[3],s[4]=n[4],s[5]=n[5],this.nodes[r]=i,this.endNode=r+1,this.needsRebuild=!0,this.numAdds+=1,this.numExternalNodes+=1},e.prototype.remove=function(e){var t=e.spatialIndex;if(t!==undefined){if(this.numExternalNodes>1){var n=this.nodes;n[t].clear();var r=this.endNode;if(t+1>=r){while(!n[r-1].externalNode)r-=1;this.endNode=r}else this.needsRebuild=!0;this.numExternalNodes-=1}else this.clear();e.spatialIndex=undefined}},e.prototype.findParent=function(e){var t=this.nodes,n=e,r=0,i;do n-=1,r+=1,i=t[n];while(i.escapeNodeOffset<=r);return i},e.prototype.update=function(e,t){var n=e.spatialIndex;if(n!==undefined){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=this.needsRebuild,l=this.needsRebound,c=this.nodes,h=c[n],p=h.extents,d=f||l||p[0]>r||p[1]>i||p[2]>s||p[3]<o||p[4]<u||p[5]<a;p[0]=r,p[1]=i,p[2]=s,p[3]=o,p[4]=u,p[5]=a;if(d&&!f&&1<c.length){this.numUpdates+=1,this.startUpdate>n&&(this.startUpdate=n),this.endUpdate<n&&(this.endUpdate=n);if(!l)if(2*this.numUpdates>this.numExternalNodes)this.needsRebound=!0;else{var v=this.findParent(n),m=v.extents;if(m[0]>r||m[1]>i||m[2]>s||m[3]<o||m[4]<u||m[5]<a)this.needsRebound=!0}else this.numUpdates>3*this.numExternalNodes&&(this.needsRebuild=!0,this.numAdds=this.numUpdates)}}else this.add(e,t)},e.prototype.needsFinalize=function(){return this.needsRebuild||this.needsRebound},e.prototype.finalize=function(){this.needsRebuild?this.rebuild():this.needsRebound&&this.rebound()},e.prototype.rebound=function(){var e=this.nodes;if(e.length>1){var t=this.startUpdate,n=this.endUpdate,r=this.nodesStack,i=0,s=0;for(;;){var o=e[s],u=s,a=s+o.escapeNodeOffset,f=s+1,l;do{l=e[f];var c=f+l.escapeNodeOffset;if(!(f<n))break;l.externalNode||c>t&&(r[i]=s,i+=1,s=f),f=c}while(f<a);if(s===u){f=s+1,l=e[f];var h=l.extents,p=h[0],d=h[1],v=h[2],m=h[3],g=h[4],y=h[5];f+=l.escapeNodeOffset;while(f<a)l=e[f],h=l.extents,p>h[0]&&(p=h[0]),d>h[1]&&(d=h[1]),v>h[2]&&(v=h[2]),m<h[3]&&(m=h[3]),g<h[4]&&(g=h[4]),y<h[5]&&(y=h[5]),f+=l.escapeNodeOffset;h=o.extents,h[0]=p,h[1]=d,h[2]=v,h[3]=m,h[4]=g,h[5]=y,n=s;if(!(0<i))break;i-=1,s=r[i]}}}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype.rebuild=function(){if(this.numExternalNodes>0){var t=this.nodes,n,r,i,s;if(this.numExternalNodes===t.length)r=t,i=t.length,t=[],this.nodes=t;else{r=[],r.length=this.numExternalNodes,i=0,s=this.endNode;for(n=0;n<s;n+=1){var o=t[n];o.externalNode&&(t[n]=undefined,r[i]=o,i+=1)}r.length>i&&(r.length=i)}var u;if(i>1){i>this.numNodesLeaf&&this.numAdds>0&&(this.highQuality?this._sortNodesHighQuality(r):this.ignoreY?this._sortNodesNoY(r):this._sortNodes(r));var a=this._predictNumNodes(0,i,0);t.length>a&&e.recycleNodes(t,a),this._recursiveBuild(r,0,i,0),s=t[0].escapeNodeOffset,t.length>s&&e.recycleNodes(t,s),this.endNode=s,u=t[0];var f=u.extents,l=f[3]-f[0],c=f[4]-f[1],h=f[5]-f[2];this.ignoreY=4*c<(l<=h?l:h)}else u=r[0],u.externalNode.spatialIndex=0,t.length=1,t[0]=u,this.endNode=1;r=null}this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.startUpdate=2147483647,this.endUpdate=-2147483647},e.prototype._sortNodes=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return-(t[0]+t[3])}function u(e){var t=e.extents;return-(t[1]+t[4])}function a(e){var t=e.extents;return-(t[2]+t[5])}function h(e,n,p){var d=n+p>>1;c===0?l?f(e,n,d,p,o):f(e,n,d,p,r):c===2?l?f(e,n,d,p,a):f(e,n,d,p,s):l?f(e,n,d,p,u):f(e,n,d,p,i),c===0?c=2:c===2?c=1:c=0,l=!l,n+t<d&&h(e,n,d),d+t<p&&h(e,d,p)}var t=this.numNodesLeaf,n=e.length,f=this._nthElement,l=!1,c=0;h(e,0,n)},e.prototype._sortNodesNoY=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[2]+t[5]}function s(e){var t=e.extents;return-(t[0]+t[3])}function o(e){var t=e.extents;return-(t[2]+t[5])}function l(e,n,c){var h=n+c>>1;f===0?a?u(e,n,h,c,s):u(e,n,h,c,r):a?u(e,n,h,c,o):u(e,n,h,c,i),f===0?f=2:f=0,a=!a,n+t<h&&l(e,n,h),h+t<c&&l(e,h,c)}var t=this.numNodesLeaf,n=e.length,u=this._nthElement,a=!1,f=0;l(e,0,n)},e.prototype._sortNodesHighQuality=function(e){function r(e){var t=e.extents;return t[0]+t[3]}function i(e){var t=e.extents;return t[1]+t[4]}function s(e){var t=e.extents;return t[2]+t[5]}function o(e){var t=e.extents;return t[0]+t[2]+t[3]+t[5]}function u(e){var t=e.extents;return t[0]-t[2]+t[3]-t[5]}function a(e){var t=e.extents;return-(t[0]+t[3])}function f(e){var t=e.extents;return-(t[1]+t[4])}function l(e){var t=e.extents;return-(t[2]+t[5])}function c(e){var t=e.extents;return-(t[0]+t[2]+t[3]+t[5])}function h(e){var t=e.extents;return-(t[0]-t[2]+t[3]-t[5])}function m(e,n,g){var y=n+g>>1;p(e,n,y,g,r);var b=d(e,n,y)+d(e,y,g);p(e,n,y,g,i);var w=d(e,n,y)+d(e,y,g);p(e,n,y,g,s);var E=d(e,n,y)+d(e,y,g);p(e,n,y,g,o);var S=d(e,n,y)+d(e,y,g);p(e,n,y,g,u);var x=d(e,n,y)+d(e,y,g);b<=w&&b<=E&&b<=S&&b<=x?v?p(e,n,y,g,a):p(e,n,y,g,r):E<=w&&E<=S&&E<=x?v?p(e,n,y,g,l):p(e,n,y,g,s):w<=S&&w<=x?v?p(e,n,y,g,f):p(e,n,y,g,i):S<=x?v?p(e,n,y,g,c):p(e,n,y,g,o):v?p(e,n,y,g,h):p(e,n,y,g,u),v=!v,n+t<y&&m(e,n,y),y+t<g&&m(e,y,g)}var t=this.numNodesLeaf,n=e.length,p=this._nthElement,d=this._calculateSAH,v=!1;m(e,0,n)},e.prototype._calculateSAH=function(e,t,n){var r,i,s,o,u,a,f,l;r=e[t],i=r.extents,s=i[0],o=i[1],u=i[2],a=i[3],f=i[4],l=i[5];for(var c=t+1;c<n;c+=1)r=e[c],i=r.extents,s>i[0]&&(s=i[0]),o>i[1]&&(o=i[1]),u>i[2]&&(u=i[2]),a<i[3]&&(a=i[3]),f<i[4]&&(f=i[4]),l<i[5]&&(l=i[5]);return a-s+(f-o)+(l-u)},e.prototype._nthElement=function(e,t,n,r,i){function s(e,t,n){return e<t?t<n?t:e<n?n:e:e<n?e:t<n?n:t}function o(e,t,n,r){var i=t+1;while(i!==n){var s=e[i],o=r(s),u=i,a=i-1;while(u!==t&&o<r(e[a]))e[u]=e[a],u-=1,a-=1;u!==i&&(e[u]=s),i+=1}}while(r-t>8){var u=s(i(e[t]),i(e[t+(r-t>>1)]),i(e[r-1])),a=t,f=r,l;for(;;a+=1){while(i(e[a])<u)a+=1;do f-=1;while(u<i(e[f]));if(a>=f){l=a;break}var c=e[a];e[a]=e[f],e[f]=c}l<=n?t=l:r=l}o(e,t,r,i)},e.prototype._recursiveBuild=function(t,n,r,i){var s=this.nodes,o=i;i+=1;var u,a,f,l,c,h,p,d,v;if(n+this.numNodesLeaf>=r){d=t[n],p=d.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);for(var m=n+1;m<r;m+=1)d=t[m],p=d.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5]),i+=1,d.externalNode.spatialIndex=i,this._replaceNode(s,i,d);v=s[i]}else{var g=n+r>>1;n+1>=g?(d=t[n],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,n,g,i),v=s[i],p=v.extents,u=p[0],a=p[1],f=p[2],l=p[3],c=p[4],h=p[5],i+=v.escapeNodeOffset,g+1>=r?(d=t[g],d.externalNode.spatialIndex=i,this._replaceNode(s,i,d)):this._recursiveBuild(t,g,r,i),v=s[i],p=v.extents,u>p[0]&&(u=p[0]),a>p[1]&&(a=p[1]),f>p[2]&&(f=p[2]),l<p[3]&&(l=p[3]),c<p[4]&&(c=p[4]),h<p[5]&&(h=p[5])}var y=s[o];y===undefined&&(s[o]=y=e.allocateNode()),y.reset(u,a,f,l,c,h,i+v.escapeNodeOffset-o)},e.prototype._replaceNode=function(t,n,r){var i=t[n];t[n]=r,i!==undefined&&e.releaseNode(i)},e.prototype._predictNumNodes=function(e,t,n){n+=1;if(e+this.numNodesLeaf>=t)n+=t-e;else{var r=e+t>>1;e+1>=r?n+=1:n=this._predictNumNodes(e,r,n),r+1>=t?n+=1:n=this._predictNumNodes(r,t,n)}return n},e.prototype.getVisibleNodes=function(e,t,n){var r=0;if(this.numExternalNodes>0){var i=this.nodes,s=this.endNode,o=e.length,u=n===undefined?t.length:n,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=0;for(;;){a=i[T],f=a.extents,c=f[0],h=f[1],p=f[2],d=f[3],v=f[4],m=f[5],g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w<0?c:d)+E*(E<0?h:v)+S*(S<0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g)if(a.externalNode){t[u]=a.externalNode,u+=1,r+=1,T+=1;if(T>=s)break}else{g=!0,y=0;do{b=e[y],w=b[0],E=b[1],S=b[2],x=w*(w>0?c:d)+E*(E>0?h:v)+S*(S>0?p:m);if(x<b[3]){g=!1;break}y+=1}while(y<o);if(g){l=T+a.escapeNodeOffset,T+=1;do a=i[T],a.externalNode&&(t[u]=a.externalNode,u+=1,r+=1),T+=1;while(T<l);if(T>=s)break}else T+=1}else{T+=a.escapeNodeOffset;if(T>=s)break}}}return r},e.prototype.getOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=this.nodes,l=this.endNode,c,h,p,d=0,v=n===undefined?t.length:n,m=0;for(;;){c=f[m],h=c.extents;var g=h[0],y=h[1],b=h[2],w=h[3],E=h[4],S=h[5];if(r<=w&&i<=E&&s<=S&&o>=g&&u>=y&&a>=b)if(c.externalNode){t[v]=c.externalNode,v+=1,d+=1,m+=1;if(m>=l)break}else if(o>=w&&u>=E&&a>=S&&r<=g&&i<=y&&s<=b){p=m+c.escapeNodeOffset,m+=1;do c=f[m],c.externalNode&&(t[v]=c.externalNode,v+=1,d+=1),m+=1;while(m<p);if(m>=l)break}else m+=1;else{m+=c.escapeNodeOffset;if(m>=l)break}}return d}return 0},e.prototype.getSphereOverlappingNodes=function(e,t,n){if(this.numExternalNodes>0){var r=t*t,i=e[0],s=e[1],o=e[2],u=this.nodes,a=this.endNode,f,l,c=n.length,h=0;for(;;){f=u[h],l=f.extents;var p=l[0],d=l[1],v=l[2],m=l[3],g=l[4],y=l[5],b=0,w;i<p?(w=p-i,b+=w*w):i>m&&(w=i-m,b+=w*w),s<d?(w=d-s,b+=w*w):s>g&&(w=s-g,b+=w*w),o<v?(w=v-o,b+=w*w):o>y&&(w=o-y,b+=w*w);if(b<=r){h+=1;if(f.externalNode){n[c]=f.externalNode,c+=1;if(h>=a)break}}else{h+=f.escapeNodeOffset;if(h>=a)break}}}},e.prototype.getOverlappingPairs=function(e,t){if(this.numExternalNodes>0){var n=this.nodes,r=this.endNode,i,s,o,u,a=0,f=t===undefined?e.length:t,l=0,c;for(;;){i=n[l];while(!i.externalNode)l+=1,i=n[l];l+=1;if(!(l<r))break;s=i.externalNode,u=i.extents;var h=u[0],p=u[1],d=u[2],v=u[3],m=u[4],g=u[5];c=l;for(;;){o=n[c],u=o.extents;if(h<=u[3]&&p<=u[4]&&d<=u[5]&&v>=u[0]&&m>=u[1]&&g>=u[2]){c+=1;if(o.externalNode){e[f]=s,e[f+1]=o.externalNode,f+=2,a+=2;if(c>=r)break}}else{c+=o.escapeNodeOffset;if(c>=r)break}}}return a}return 0},e.prototype.getExtents=function(){return 0<this.nodes.length?this.nodes[0].extents:null},e.prototype.getRootNode=function(){return this.nodes[0]},e.prototype.getNodes=function(){return this.nodes},e.prototype.getEndNodeIndex=function(){return this.endNode},e.prototype.clear=function(){this.nodes.length&&e.recycleNodes(this.nodes,0),this.endNode=0,this.needsRebuild=!1,this.needsRebound=!1,this.numAdds=0,this.numUpdates=0,this.numExternalNodes=0,this.startUpdate=2147483647,this.endUpdate=-2147483647,this.ignoreY=!1},e.rayTest=function(e,t,n){function d(e,t){var n=e[0],r=e[1],i=e[2],d=e[3],v=e[4],m=e[5];if(n<=s&&s<=d&&r<=o&&o<=v&&i<=u&&u<=m)return 0;var g,y,b,w,E;a>=0?(E=n-s,g=E===0?0:E*c,E=d-s,y=E===0?0:E*c):(g=(d-s)*c,y=(n-s)*c),f>=0?(E=r-o,b=E===0?0:E*h,E=v-o,w=E===0?0:E*h):(b=(v-o)*h,w=(r-o)*h);if(g>w||b>y)return undefined;b>g&&(g=b),w<y&&(y=w);var S,x;return l>=0?(E=i-u,S=E===0?0:E*p,E=m-u,x=E===0?0:E*p):(S=(m-u)*p,x=(i-u)*p),g>x||S>y?undefined:(S>g&&(g=S),x<y&&(y=x),g<0&&(g=y),0<=g&&g<t?g:undefined)}function g(e,r,i){var s=e.getNodes(),o=s[r],u=d(o.extents,i);if(u===undefined)return i;if(o.externalNode){var a=n(e,o.externalNode,t,u,i);a&&(m=a,i=a.factor)}else{var f=v.length,l;for(l=0;l<f;l+=1){var c=v[l];if(u>c.distance)break}v.splice(l-1,0,{tree:e,nodeIndex:r,distance:u})}return i}var r=t.origin,i=t.direction,s=r[0],o=r[1],u=r[2],a=i[0],f=i[1],l=i[2],c=1/a,h=1/f,p=1/l,v=[],m=null,y=t.maxFactor,b,w;for(w=0;w<e.length;w+=1)b=e[w],b.endNode!==0&&(y=g(b,0,y));while(v.length!==0){var E=v.pop();if(E.distance>=y)continue;var S=E.nodeIndex;b=E.tree;var x=b.getNodes(),T=x[S],N=S+T.escapeNodeOffset,C=S+1;do y=g(b,C,y),C+=x[C].escapeNodeOffset;while(C<N)}return m},e.create=function(t){return new e(t?!0:!1)},e.version=1,e.useFloat32Array=!1,e.nodesPoolAllocationSize=128,e.nodesPool=[],e}();(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(E.useFloat32Array=!0)}})();var S=function(){function e(){}return e.prototype.setTexture=function(e){this.texture=e,this.textureChangedObserver&&this.textureChangedObserver.notify(this)},e.prototype.getTexture=function(){return this.texture},e.prototype.subscribeTextureChanged=function(e){this.textureChangedObserver||(this.textureChangedObserver=r.create()),this.textureChangedObserver.subscribe(e)},e.prototype.unsubscribeTextureChanged=function(e){this.textureChangedObserver.unsubscribe(e)},e.prototype.destroy=function(){this.texture.name!=="default"&&this.texture.destroy(),delete 
this.texture,delete this.textureChangedObserver},e.create=function(t,n){var r=new e;return r.name=t,r.texture=n,r.reference=u.create(r),r},e.version=1,e}(),x=function(){function e(){}return e.prototype.add=function(e,t,n){var r=this.textureInstances[e];r?r.setTexture(t):(this.textureInstances[e]=S.create(e,t),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),n&&(this.internalTexture[e]=!0,this.textureInstances[e].reference.add())},e.prototype.get=function(e){var t=this.textureInstances[e];return t?t.getTexture():this.defaultTexture},e.prototype.getInstance=function(e){return this.textureInstances[e]},e.prototype.load=function(e,t,n){var i=this;e===undefined&&this.errorCallback("Invalid texture path passed to TextureManager.Load");var s=this.textureInstances[e];if(!s||s.texture===this.defaultTexture&&e!=="default"){s||this.add(e,this.defaultTexture,!1);if(e in this.loadingTexture)n&&this.loadedTextureObservers[e].subscribe(n);else{if(0!==this.numLoadingArchives)return this.delayedTextures[e]={nomipmaps:t,onload:n},this.get(e);this.loadingTexture[e]=!0,this.numLoadingTextures+=1;var o=!0;t&&(o=!1);var u=r.create();this.loadedTextureObservers[e]=u,n&&u.subscribe(n);var a=function(n,r){r===200&&n&&i.add(e,n,!1),u.notify(n),delete i.loadedTextureObservers[e],delete i.loadingTexture[e],i.numLoadingTextures-=1},f=function(t,n){var r=i.graphicsDevice.createTexture({src:t,mipmaps:o,onload:n});r||i.errorCallback("Texture '"+t+"' not created.")};this.requestHandler.request({src:this.pathRemapping&&this.pathRemapping[e]||this.pathPrefix+e,requestFn:f,onload:a})}return this.get(e)}var l=this.get(e);return n&&TurbulenzEngine.setTimeout(function(){n(l)},0),l},e.prototype.map=function(e,t){this.textureInstances[e]?this.textureInstances[e].setTexture(this.textureInstances[t].getTexture()):(this.textureInstances[e]=S.create(e,this.textureInstances[t].getTexture()),this.textureInstances[e].reference.subscribeDestroyed(this.onTextureInstanceDestroyed)),this.internalTexture[e]=!0},e.prototype.remove=function(e){this.internalTexture[e]||e in this.textureInstances&&(this.textureInstances[e].reference.unsubscribeDestroyed(this.onTextureInstanceDestroyed),delete this.textureInstances[e])},e.prototype.loadArchive=function(e,t,n,i){var s=this,o=this.archivesLoaded[e];if(!o)if(e in this.loadingArchives)n&&this.loadedArchiveObservers[e].subscribe(function(){var r=s.archivesLoaded[e],o=r.textures,u;for(u in o)o.hasOwnProperty(u)&&n(o[u]);i&&i(r)});else{var u=!0;t&&(u=!1),this.loadingArchives[e]={textures:{}},this.numLoadingArchives+=1;var a=r.create();this.loadedArchiveObservers[e]=a,i&&a.subscribe(i);var f=function(n,r){var i;r===200&&n&&(i={textures:s.loadingArchives[e].textures},s.archivesLoaded[e]=i),a.notify(i),delete s.loadedArchiveObservers[e],delete s.loadingArchives[e],s.numLoadingArchives-=1;if(0===s.numLoadingArchives){var o;for(o in s.delayedTextures)if(s.delayedTextures.hasOwnProperty(o)){var u=s.delayedTextures[o];s.load(o,u.nomipmaps,u.onload)}s.delayedTextures={}}},l=function(r,i){var o=function(r){var i=r.name;if(!(i in s.textureInstances)||s.textureInstances[i].texture===s.defaultTexture)s.add(i,r,!1),s.loadingArchives[e].textures[i]=r;n&&n(r),delete s.delayedTextures[i],e in s.loadingTexture&&(delete s.loadingTexture[e],s.numLoadingTextures-=1)};s.graphicsDevice.loadTexturesArchive({src:r,mipmaps:u,ontextureload:o,onload:i})||s.errorCallback("Archive '"+e+"' not loaded.")};s.requestHandler.request({src:s.pathRemapping&&s.pathRemapping[e]||s.pathPrefix+e,requestFn:l,onload:f})}else if(n){var c=o.textures,h=0,p=function(t){return function(){n(t),h-=1,h===0&&i&&i(o)}},d;for(d in c)c.hasOwnProperty(d)&&(h+=1,TurbulenzEngine.setTimeout(p(c[d]),0))}},e.prototype.isArchiveLoaded=function(e){return e in this.archivesLoaded},e.prototype.removeArchive=function(e){if(e in this.archivesLoaded){var t=this.archivesLoaded[e].textures,n;for(n in t)t.hasOwnProperty(n)&&this.remove(n);delete this.archivesLoaded[e]}},e.prototype.getAll=function(){return this.textureInstances},e.prototype.getNumPendingTextures=function(){return this.numLoadingTextures+this.numLoadingArchives},e.prototype.isTextureLoaded=function(e){return!(e in this.loadingTexture)&&!(e in this.delayedTextures)},e.prototype.isTextureMissing=function(e){return!(e in this.textureInstances)},e.prototype.setPathRemapping=function(e,t){this.pathRemapping=e,this.pathPrefix=t},e.prototype.addProceduralTexture=function(e){var t=e.name,n=this.graphicsDevice.createTexture(e);n?this.add(t,n,!0):this.errorCallback("Failed to create '"+t+"' texture.")},e.prototype.destroy=function(){if(this.textureInstances){var e;for(e in this.textureInstances)if(this.textureInstances.hasOwnProperty(e)){var t=this.textureInstances[e];t&&t.destroy()}this.textureInstances=null}this.defaultTexture&&(this.defaultTexture.destroy(),this.defaultTexture=null),this.loadingTexture=null,this.loadedTextureObservers=null,this.delayedTextures=null,this.numLoadingTextures=0,this.archivesLoaded=null,this.loadingArchives=null,this.loadedArchiveObservers=null,this.numLoadingArchives=0,this.internalTexture=null,this.pathRemapping=null,this.pathPrefix=null,this.requestHandler=null,this.graphicsDevice=null},e.create=function(t,n,r,i,s){var o=new e;i||(i=function(){});var u="default",a;r?a=r:(a=t.createTexture({name:u,width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255]}),a||i("Default texture not created.")),o.textureInstances={},o.loadingTexture={},o.loadedTextureObservers={},o.delayedTextures={},o.numLoadingTextures=0,o.archivesLoaded={},o.loadingArchives={},o.loadedArchiveObservers={},o.numLoadingArchives=0,o.internalTexture={},o.pathRemapping=null,o.pathPrefix="",o.graphicsDevice=t,o.requestHandler=n,o.defaultTexture=a,o.errorCallback=i;var f=function(t){t.reference.unsubscribeDestroyed(f),delete o.textureInstances[t.name]};o.onTextureInstanceDestroyed=f,s&&(o.add=function(n,r){return s.innerHTML+="TextureManager.add:&nbsp;'"+n+"'",e.prototype.add.call(o,n,r)},o.load=function(n,r){return s.innerHTML+="TextureManager.load:&nbsp;'"+n+"'",e.prototype.load.call(o,n,r)},o.loadArchive=function(n,r){return s.innerHTML+="TextureManager.loadArchive:&nbsp;'"+n+"'",e.prototype.loadArchive.call(o,n,r)},o.isArchiveLoaded=function(n){return s.innerHTML+="TextureManager.isArchiveLoaded:&nbsp;'"+n+"'",e.prototype.isArchiveLoaded.call(o,n)},o.removeArchive=function(n){return s.innerHTML+="TextureManager.removeArchive:&nbsp;'"+n+"'",e.prototype.removeArchive.call(o,n)},o.map=function(n,r){s.innerHTML+="TextureManager.map:&nbsp;'"+r+"' -> '"+n+"'",e.prototype.map.call(o,n,r)},o.get=function(n){return s.innerHTML+="TextureManager.get:&nbsp;'"+n+"'",e.prototype.get.call(o,n)},o.getInstance=function(n){return s.innerHTML+="TextureManager.getInstance:&nbsp;'"+n+"'",e.prototype.getInstance.call(o,n)},o.remove=function(n){s.innerHTML+="TextureManager.remove:&nbsp;'"+n+"'",e.prototype.remove.call(o,n)}),o.add(u,a,!0),o.addProceduralTexture({name:"white",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]}),o.addProceduralTexture({name:"black",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]}),o.addProceduralTexture({name:"flat",width:2,height:2,depth:1,format:"R8G8B8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:[128,128,255,255,128,128,255,255,128,128,255,255,128,128,255,255]});var l=Math.abs,c,h,p=[];for(h=0;h<4;h+=1)for(c=0;c<32;c+=1){var d=(c+.5)*(2/32)-1;d=l(d)-1/32;var v=1-d*2+d*d;v<=0?p.push(0):v>=1?p.push(255):p.push(v*255)}o.addProceduralTexture({name:"quadratic",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:p}),p=null;var m=[];for(h=0;h<4;h+=1){m.push(0);for(c=1;c<31;c+=1)m.push(255);m.push(0)}return o.addProceduralTexture({name:"nofalloff",width:32,height:4,depth:1,format:"L8",cubemap:!1,mipmaps:!0,dynamic:!1,data:m}),m=null,o},e.version=1,e}(),T=function(){function e(){}return e.prototype.get=function(e){return null},e.create=function(t,n,i,s,o){function y(e){var t=e.parameters,n=e.techniques,r=e.programs,i,s,o,u,a,f,l,c,h,p,d,v,m,y,b;for(i in t)if(t.hasOwnProperty(i)){s=g[i];if(s!==undefined){t[i].rows=s,o={};for(u in n)if(n.hasOwnProperty(u)){a=n[u],f=a.length;for(l=0;l<f;l+=1){c=a[l];if(c.parameters.indexOf(i)!==-1){h=c.programs,p=h.length;for(d=0;d<p;d+=1)o[h[d]]=!0}}}v=new RegExp("uniform\\s+(\\w+)\\s+"+i+"\\s*\\[[^\\]]+\\]","mg"),m="uniform $1 "+i+"["+s+"]";for(y in o)o.hasOwnProperty(y)&&(b=r[y],b.code=b.code.replace(v,m))}}}s||(s=function(){});var u="default",a;if(i)a=i;else{var f={version:1,name:"default.cgfx",parameters:{worldViewProjection:{type:"float",rows:4,columns:4},diffuse:{type:"sampler2D"}},techniques:{textured3D:[{parameters:["worldViewProjection","diffuse"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!0,DepthFunc:515,DepthMask:!0,CullFaceEnable:!0,CullFace:1029,BlendEnable:!1},programs:["vp","fp"]}]},programs:{fp:{type:"fragment",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];vec4 _ret_0;uniform sampler2D diffuse;void main()\n{_ret_0=texture2D(diffuse,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp:{type:"vertex",code:"#ifdef GL_ES\nprecision mediump float;precision mediump int;\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvec4 _OUTpos1;vec2 _OUTuv1;uniform vec4 worldViewProjection[4];void main()\n{_OUTpos1=ATTR0.xxxx*worldViewProjection[0]+ATTR0.yyyy*worldViewProjection[1]+ATTR0.zzzz*worldViewProjection[2]+worldViewProjection[3];_OUTuv1=ATTR8.xy;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=_OUTpos1;}"}}};a=t.createShader(f),a||s("Default shader not created.")}var l={},c={},h={},p=0,d=null,v="",m=!1,g={};l[u]=a;var b=function(i,u){i===undefined&&s("Invalid texture path passed to ShaderManager.Load");var f=l[i];if(!f){if(!c[i]){c[i]=!0,p+=1;var g=r.create();h[i]=g,u&&g.subscribe(u);var b=function(n){if(n){var r=JSON.parse(n);m&&y(r);var s=t.createShader(r);s?l[i]=s:delete l[i],g.notify(s),delete h[i]}else o&&(o.innerHTML+="ShaderManager.load:&nbsp;'"+i+"' failed to load<br>"),delete l[i];delete c[i],p-=1};n.request({src:d&&d[i]||v+i,onload:b})}else u&&h[i].subscribe(u);return a}return u&&TurbulenzEngine.setTimeout(function(){u(f)},0),f},w=function(t,n){l[t]=l[n]},E=function(t){var n=l[t];return n?n:a},S=function(t){typeof l[t]!="undefined"&&delete l[t]},x=function(t,n){S(t),b(t,n)},T=new e;return o?(T.load=function(t,n){return o.innerHTML+="ShaderManager.load:&nbsp;'"+t+"'<br>",b(t,n)},T.map=function(t,n){o.innerHTML+="ShaderManager.map:&nbsp;'"+n+"' -> '"+t+"'<br>",w(t,n)},T.get=function(t){return o.innerHTML+="ShaderManager.get:&nbsp;'"+t+"'<br>",E(t)},T.remove=function(t){o.innerHTML+="ShaderManager.remove:&nbsp;'"+t+"'<br>",S(t)},T.reload=function(t,n){o.innerHTML+="ShaderManager. reload:&nbsp;'"+t+"'<br>",x(t,n)}):(T.load=b,T.map=w,T.get=E,T.remove=S,T.reload=x),T.reloadAll=function(){for(var t in l)l.hasOwnProperty(t)&&t!==u&&x(t)},T.getAll=function(){return l},T.getNumPendingShaders=function(){return p},T.isShaderLoaded=function(t){return!c[t]},T.isShaderMissing=function(t){return!l[t]},T.setPathRemapping=function(t,n){d=t,v=n},T.setAutomaticParameterResize=function(t,n){m=!0,g[t]=n},T.destroy=function(){if(l){var r;for(r in l)if(l.hasOwnProperty(r)){var i=l[r];i&&i.destroy()}l=null}a=null,c=null,h=null,p=0,d=null,v=null,n=null,t=null},T},e.version=1,e}(),N=function(){function e(){}return e.create=function(t){var n=new e;return n.name=t,n.geometryType={},n.numMaterials=0,n.materialsMap={},n},e.prototype.hashMaterial=function(e){var t=e.texturesNames,n=[],r=0;for(var i in t)t.hasOwnProperty(i)&&(n[r]=t[i],r+=1);if(1<r)return n.sort(),n.join(",");if(0<r)return n[0];var s=e.techniqueParameters.materialColor;if(s){var o=s.length,u;for(u=0;u<o;u+=1)n[u]=s[u].toFixed(3).replace(".000","");return n.join(",")}return e.name},e.prototype.prepareMaterial=function(e){var t=this.hashMaterial(e),n=this.materialsMap[t];n===undefined&&(n=this.numMaterials,this.numMaterials+=1,this.materialsMap[t]=n),e.meta.materialIndex=n,e.effect=this},e.prototype.add=function(e,t){this.geometryType[e]=t},e.prototype.remove=function(e){delete this.geometryType[e]},e.prototype.get=function(e){return this.geometryType[e]},e.prototype.prepare=function(e){var t=this.geometryType[e.geometryType];t&&t.prepare(e)},e.version=1,e}(),C=function(){function e(){}return e.create=function(){var t=new e;return t.effects={},t},e.prototype.add=function(e){this.effects[e.name]=e},e.prototype.remove=function(e){delete this.effects[e]},e.prototype.map=function(e,t){this.effects[e]=this.effects[t]},e.prototype.get=function(e){var t=this.effects[e];return t?t:this.effects["default"]},e.version=1,e}(),k=function(){function e(){}return e.create=function(t){var n=new e;return n.reference=u.create(n),n.techniqueParameters=t.createTechniqueParameters(),n.meta={},n.onTextureChanged=function(t){var r=t.texture,i=n,s=i.techniqueParameters,o=i.textureInstances;for(var u in o)o.hasOwnProperty(u)&&o[u]===t&&(s[u]=r)},n},e.prototype.getName=function(){return this.name},e.prototype.setName=function(e){this.name=e},e.prototype.clone=function(t){var n=e.create(t);this.effect&&(n.effect=this.effect),this.effectName&&(n.effectName=this.effectName);var r=this.meta,i=n.meta,s;for(s in r)r.hasOwnProperty(s)&&(i[s]=r[s]);var o=this.techniqueParameters,u=n.techniqueParameters;for(s in o)o.hasOwnProperty(s)&&(u[s]=o[s]);var a=this.texturesNames;if(a){var f=n.texturesNames;f||(n.texturesNames=f={});for(s in a)a.hasOwnProperty(s)&&(f[s]=a[s])}var l=this.textureInstances;if(l){var c=n.textureInstances;c||(n.textureInstances=c={});for(s in l)if(l.hasOwnProperty(s)){var h=l[s];c[s]=h,h.subscribeTextureChanged(n.onTextureChanged),h.reference.add()}}return n},e.prototype.loadTextures=function(e){var t=this.texturesNames;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];e.load(r),this.setTextureInstance(n,e.getInstance(r))}},e.prototype.setTextureInstance=function(e,t){this.textureInstances||(this.textureInstances={});var n=this.textureInstances[e];n!==t&&(n&&n.unsubscribeTextureChanged&&n.unsubscribeTextureChanged(this.onTextureChanged),this.textureInstances[e]=t,this.techniqueParameters[e]=t.texture,t.subscribeTextureChanged(this.onTextureChanged),t.reference.add())},e.prototype.isSimilar=function(e){function t(e,t){var n;for(n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n])return!1}for(n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function n(e,t){var n=e.length,r;for(r=0;r<n;r+=1)if(e[r]!==t[r])return!1;return!0}if(this.effect!==e.effect)return!1;if(this.effectName!==e.effectName)return!1;if(this.meta.materialIndex!==e.meta.materialIndex){var r=this.texturesNames,i=e.texturesNames;if(r||i){if(!r||!i)return!1;if(!t(r,i))return!1}}var s=this.techniqueParameters,o=e.techniqueParameters,u,a,f;for(u in s)if(s.hasOwnProperty(u)){if(!o.hasOwnProperty(u))return!1;a=s[u],f=o[u];if(a!==f){if(!(a&&typeof a!="number"&&f&&typeof f!="number"&&a.length===f.length&&a.length))return!1;if(!n(a,f))return!1}}for(u in o)if(o.hasOwnProperty(u)&&!s.hasOwnProperty(u))return!1;return!0},e.prototype.destroy=function(){delete this.techniqueParameters;var e,t=this.textureInstances;for(var n in t)t.hasOwnProperty(n)&&(e=t[n],e.unsubscribeTextureChanged(this.onTextureChanged),e.reference.remove());delete this.textureInstances,delete this.texturesNames},e.version=1,e}(),L=function(){function e(t){this.name=t.name;var n=this.mathDevice;n||(n=TurbulenzEngine.getMathDevice(),e.prototype.mathDevice=n),this.dynamic=t.dynamic||!1,this.disabled=t.disabled||!1,this.dirtyWorld=!1,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.worldUpdate=0,this.frameVisible=-1;var r=t.local;if(r)if(this.arrayConstructor!==Array){var i=new Float32Array(24);this.local=n.m43Copy(r,i.subarray(0,12)),this.world=n.m43Copy(this.local,i.subarray(12,24))}else this.local=n.m43Copy(r),this.world=n.m43Copy(this.local);else this.local=undefined,this.world=n.m43BuildIdentity();this.parent=undefined,this.notifiedParent=!1}return e.makePath=function(e,t){return e+"/"+t},e.invalidSetLocalTransform=function(){},e.prototype.getName=function(){return this.name},e.prototype.getPath=function(){return this.parent?e.makePath(this.parent.getPath(),this.name):this.name},e.prototype.getParent=function(){return this.parent},e.prototype.setParentHelper=function(e){this.parent=e,this.notifiedParent=!1,this.dirtyWorld=!1,this._setDirtyWorldTransform()},e.prototype.addChild=function(e){e.parent?e.parent.removeChild(e):e.scene&&e.scene.removeRootNode(e),this.children||(this.children=[],this.childNeedsUpdateCount=0),this.children.push(e),e.setParentHelper(this),this.dynamic&&!e.dynamic&&e.setDynamic()},e.prototype.removeChild=function(e){var t=this.children;if(t){e.notifiedParent&&this.childUpdated();var n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){var i=this.getRoot();i.scene&&e.removedFromScene(i.scene),t.splice(r,1),e.setParentHelper(null);return}}},e.prototype.findChild=function(e){var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)if(t[r].name===e)return t[r]}return undefined},e.prototype.clone=function(t){var n=e.create({name:t||this.name,local:this.local,dynamic:this.dynamic,disabled:this.disabled}),r=this.renderables;if(r){var i=r.length;for(var s=0;s<i;s+=1){var o=r[s];n.addRenderable(o.clone())}}var u=this.lightInstances;if(u){var a=u.length;for(var f=0;f<a;f+=1){var l=u[f];n.addLightInstance(l.clone())}}this.clonedObserver&&this.clonedObserver.notify({oldNode:this,newNode:n});var c=this.children;if(c){var h=c.length;for(var p=0;p<h;p+=1)n.addChild(c[p].clone())}return n},e.prototype.getRoot=function(){var e=this;while(e.parent)e=e.parent;return e},e.prototype.isInScene=function(){return this.getRoot().scene?!0:!1},e.prototype.removedFromScene=function(e){this.spatialIndex!==undefined&&(this.dynamic?e.dynamicSpatialMap.remove(this):(e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1));var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].removedFromScene(e)}},e.prototype.setLocalTransform=function(e){e!==this.local&&(this.local=this.mathDevice.m43Copy(e,this.local)),this.dirtyWorld||this._setDirtyWorldTransform()},e.prototype.getLocalTransform=function(){return this.local||(this.local=this.mathDevice.m43BuildIdentity()),this.local},e.prototype._setDirtyWorldTransform=function(){var t=this.parent;if(t)this.notifiedParent||(this.notifiedParent=!0,t.childNeedsUpdate());else{var n=this.scene;n&&n.addRootNodeToUpdate(this,this.name)}var r=e._tempDirtyNodes;r[0]=this;var i=1,s,o,u;do{i-=1,s=r[i],s.dirtyWorld=!0,!s.customWorldExtents&&s.localExtents&&(s.dirtyWorldExtents=!0);var a=s.children;if(a){var f=a.length;if(!s.childNeedsUpdateCount){s.childNeedsUpdateCount=f;for(o=0;o<f;o+=1)u=a[o],u.notifiedParent=!0,r[i]=u,i+=1}else for(o=0;o<f;o+=1)u=a[o],u.dirtyWorld||(u.notifiedParent||(u.notifiedParent=!0,s.childNeedsUpdateCount+=1),r[i]=u,i+=1)}}while(0<i)},e.prototype.getWorldTransform=function(){return this.dirtyWorld&&this.updateWorldTransform(),this.world},e.prototype.updateWorldTransform=function(){if(this.dirtyWorld){this.dirtyWorld=!1,this.worldUpdate+=1,this.checkUpdateRequired();var e=this.parent,t=this.local;if(e){var n=e.getWorldTransform();t?this.world=this.mathDevice.m43Mul(t,n,this.world):this.world=this.mathDevice.m43Copy(n,this.world)}else this.world=this.mathDevice.m43Copy(t,this.world)}},e.prototype.setDynamic=function(){if(!this.dynamic){if(this.spatialIndex!==undefined){var e=this.getRoot().scene;e.staticSpatialMap.remove(this),e.staticNodesChangeCounter+=1,delete this.spatialIndex}delete this.setLocalTransform;var t=this.getWorldExtents();t&&this.getRoot().scene.dynamicSpatialMap.update(this,t),this.dynamic=!0}var n=this.children;if(n){var r=n.length;for(var i=0;i<r;i+=1)n[i].setDynamic()}},e.prototype.setStatic=function(){if(this.dynamic){this.spatialIndex!==undefined&&(this.getRoot().scene.dynamicSpatialMap.remove(this),delete this.spatialIndex),this.setLocalTransform=e.invalidSetLocalTransform;var t=this.getWorldExtents();if(t){var n=this.getRoot().scene;n&&(n.staticSpatialMap.update(this,t),n.staticNodesChangeCounter+=1)}delete this.dirtyWorldExtents,delete this.worldExtentsUpdate,delete this.dirtyWorld,delete this.notifiedParent,delete this.dynamic}var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s].setStatic()}},e.prototype.setDisabled=function(e){e?this.disabled=!0:this.disabled=!1},e.prototype.getDisabled=function(){return this.disabled},e.prototype.enableHierarchy=function(e){this.setDisabled(!e);var t=this.children;if(t){var n=t.length;for(var r=0;r<n;r+=1)t[r].enableHierarchy(e)}},e.prototype.childUpdated=function(){this.childNeedsUpdateCount-=1,this.childNeedsUpdateCount===0&&this.dirtyWorld===!1&&this.dirtyWorldExtents===!1&&this.parent&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.childNeedsUpdate=function(){this.updateRequired(),this.childNeedsUpdateCount+=1},e.prototype.updateRequired=function(){var e=this.parent;if(e)this.notifiedParent||(this.notifiedParent=!0,e.childNeedsUpdate());else{var t=this.scene;t&&t.addRootNodeToUpdate(this,this.name)}},e.prototype.checkUpdateRequired=function(){this.notifiedParent&&!this.dirtyWorldExtents&&!this.dirtyWorld&&!this.childNeedsUpdateCount&&(this.parent.childUpdated(),this.notifiedParent=!1)},e.prototype.update=function(t){var n=e._tempDirtyNodes;n[0]=this,e.updateNodes(this.mathDevice,t||this.scene,n,1)},e.updateNodes=function(t,n,r,i){var s=n.dynamicSpatialMap,o,u,a,f;do{i-=1,o=r[i];if(o.dirtyWorld){o.dirtyWorld=!1,o.worldUpdate+=1,u=o.parent;if(u){var l=o.local;l?o.world=t.m43Mul(l,u.world,o.world):o.world=t.m43Copy(u.world,o.world)}else o.world=t.m43Copy(o.local,o.world)}o.dirtyWorldExtents&&(o.customWorldExtents?o.worldExtents=o.customWorldExtents:(o.dirtyLocalExtents&&o.updateLocalExtents(),o.numCustomRenderableWorldExtents?o.updateCustomRenderableWorldExtents():o.localExtents?o.recalculateWorldExtents():delete o.worldExtents),o.dirtyWorldExtents=!1,o.worldExtentsUpdate=!0),o.worldExtentsUpdate&&(o.worldExtentsUpdate=!1,f=o.worldExtents,f?o.dynamic?s.update(o,f):(n.staticSpatialMap.update(o,f),n.staticNodesChangeCounter+=1,o.setLocalTransform=e.invalidSetLocalTransform,delete o.dirtyWorldExtents,delete o.worldExtentsUpdate,delete o.dirtyWorld,delete o.notifiedParent):o.spatialIndex!==undefined&&(o.dynamic?s.remove(o):(n.staticSpatialMap.remove(o),n.staticNodesChangeCounter+=1)));if(o.childNeedsUpdateCount){o.childNeedsUpdateCount=0;var c=o.children;if(c){var h=c.length;for(a=0;a<h;a+=1){var p=c[a];p.notifiedParent&&(r[i]=p,i+=1)}}}o.notifiedParent=!1}while(0<i)},e.prototype.updateLocalExtents=function(){var e,t,n,r=!1;if(this.customLocalExtents)this.localExtents=this.customLocalExtents,r=!0;else{var i=this.renderables,s=this.lightInstances,o=i?i.length:0,u=s?s.length:0;if(o||u){var a=Number.MAX_VALUE,f=-a,l=Math.min,c=Math.max,h,p,d,v,m,g,y,b=a,w=a,E=a,S=f,x=f,T=f;for(y=0;y<o;y+=1){var N=i[y];n=N.halfExtents,n&&!N.hasCustomWorldExtents()&&(h=n[0],p=n[1],d=n[2],t=N.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}for(y=0;y<u;y+=1){var C=s[y].light;n=C.halfExtents,n&&(h=n[0],p=n[1],d=n[2],t=C.center,t?(v=t[0],m=t[1],g=t[2],b=l(b,v-h),w=l(w,m-p),E=l(E,g-d),S=c(S,v+h),x=c(x,m+p),T=c(T,g+d)):(b=l(b,-h),w=l(w,-p),E=l(E,-d),S=c(S,+h),x=c(x,+p),T=c(T,+d)))}if(this.arrayConstructor!==Array){var k=6;this.localHalfExtents||(k+=3),this.localExtentsCenter||(k+=3),this.worldExtents||(k+=6);var L=new Float32Array(k),A=0;this.localExtents=e=L.subarray(A,A+6),A+=6,this.localHalfExtents||(this.localHalfExtents=L.subarray(A,A+3),A+=3),this.localExtentsCenter||(this.localExtentsCenter=L.subarray(A,A+3),A+=3),this.worldExtents||(this.worldExtents=L.subarray(A,A+6),A+=6)}else this.localExtents=e=new Array(6),this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6));e[0]=b,e[1]=w,e[2]=E,e[3]=S,e[4]=x,e[5]=T,r=!0}}r?(e=this.localExtents,t=this.localExtentsCenter||new this.arrayConstructor(3),t[0]=(e[3]+e[0])*.5,t[1]=(e[4]+e[1])*.5,t[2]=(e[5]+e[2])*.5,this.localExtentsCenter=t,n=this.localHalfExtents||new this.arrayConstructor(3),n[0]=e[3]-t[0],n[1]=e[4]-t[1],n[2]=e[5]-t[2],this.localHalfExtents=n):(delete this.localExtents,delete this.localExtentsCenter,delete this.localHalfExtents),this.dirtyLocalExtents=!1},e.prototype.getLocalExtents=function(){return this.dirtyLocalExtents&&this.updateLocalExtents(),this.localExtents},e.prototype.updateWorldExtents=function(){this.dirtyWorld&&this.updateWorldTransform(),this.dirtyWorldExtents&&(this.customWorldExtents?this.worldExtents=this.customWorldExtents:(this.dirtyLocalExtents&&this.updateLocalExtents(),this.numCustomRenderableWorldExtents?this.updateCustomRenderableWorldExtents():this.localExtents?this.recalculateWorldExtents():delete this.worldExtents),this.dirtyWorldExtents=!1,this.worldExtentsUpdate=!0,this.checkUpdateRequired())},e.prototype.updateCustomRenderableWorldExtents=function(){var e,t,n,r,i,s,o,u,a,f=this.renderables,l=f.length,c=!0;for(e=0;e<l;e+=1){t=f[e],n=t.getCustomWorldExtents();if(n){r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],e+=1,c=!1;break}}for(;e<l;e+=1)t=f[e],n=t.getCustomWorldExtents(),n&&(r>n[0]&&(r=n[0]),i>n[1]&&(i=n[1]),s>n[2]&&(s=n[2]),o<n[3]&&(o=n[3]),u<n[4]&&(u=n[4]),a<n[5]&&(a=n[5]));if(c)delete this.worldExtents;else{var h=this.worldExtents;h||(h=new this.arrayConstructor(6),this.worldExtents=h),h[0]=r,h[1]=i,h[2]=s,h[3]=o,h[4]=u,h[5]=a}},e.prototype.recalculateWorldExtents=function(){var e=this.localExtentsCenter,t=this.localHalfExtents,n=e[0],r=e[1],i=e[2],s=t[0],o=t[1],u=t[2],a=this.world,f=a[0],l=a[1],c=a[2],h=a[3],p=a[4],d=a[5],v=a[6],m=a[7],g=a[8],y=a[9],b=a[10],w=a[11];if(n!==0||r!==0||i!==0)y+=f*n+h*r+v*i,b+=l*n+p*r+m*i,w+=c*n+d*r+g*i;var E=(f<0?-f:f)*s+(h<0?-h:h)*o+(v<0?-v:v)*u,S=(l<0?-l:l)*s+(p<0?-p:p)*o+(m<0?-m:m)*u,x=(c<0?-c:c)*s+(d<0?-d:d)*o+(g<0?-g:g)*u,T=this.worldExtents;T||(T=new this.arrayConstructor(6),this.worldExtents=T),T[0]=y-E,T[1]=b-S,T[2]=w-x,T[3]=y+E,T[4]=b+S,T[5]=w+x},e.prototype.getWorldExtents=function(){return this.dirtyWorldExtents&&this.updateWorldExtents(),this.worldExtents},e.prototype.addCustomLocalExtents=function(e){var t=this.customLocalExtents;if(!t){this.localExtents=undefined;if(this.arrayConstructor!==Array){var n=0;this.localHalfExtents||(n+=3),this.localExtentsCenter||(n+=3),this.worldExtents||(n+=6),n+=6;var r=new Float32Array(n),i=0;this.localHalfExtents||(this.localHalfExtents=r.subarray(i,i+3),i+=3),this.localExtentsCenter||(this.localExtentsCenter=r.subarray(i,i+3),i+=3),this.worldExtents||(this.worldExtents=r.subarray(i,i+6),i+=6),this.customLocalExtents=t=r.subarray(i,i+6),i+=6}else this.localHalfExtents||(this.localHalfExtents=new Array(3)),this.localExtentsCenter||(this.localExtentsCenter=new Array(3)),this.worldExtents||(this.worldExtents=new Array(6)),this.customLocalExtents=t=new Array(6);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0}else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyLocalExtents=!0;this.dirtyLocalExtents&&(this.dirtyWorldExtents=!0,this.updateRequired())},e.prototype.removeCustomLocalExtents=function(){delete this.customLocalExtents,this.dirtyWorldExtents=!0,this.dirtyLocalExtents=!0,this.updateRequired()},e.prototype.getCustomLocalExtents=function(){return this.customLocalExtents},e.prototype.addCustomWorldExtents=function(e){var t=this.customWorldExtents;if(!t)this.customWorldExtents=t=new this.arrayConstructor(6),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;else if(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||t[4]!==e[4]||t[5]!==e[5])t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],this.dirtyWorldExtents=!0;this.dirtyWorldExtents&&this.updateRequired()},e.prototype.removeCustomWorldExtents=function(){delete this.customWorldExtents,this.dirtyWorldExtents=!0,this.updateRequired()},e.prototype.getCustomWorldExtents=function(){return this.customWorldExtents},e.prototype.renderableWorldExtentsUpdated=function(e){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),e||(this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents=this.numCustomRenderableWorldExtents?this.numCustomRenderableWorldExtents+1:1)},e.prototype.renderableWorldExtentsRemoved=function(){this.customWorldExtents||(this.dirtyWorldExtents=!0,this.updateRequired()),this.dirtyLocalExtents=!0,this.numCustomRenderableWorldExtents-=1},e.prototype.calculateHierarchyWorldExtents=function(e){var t=Number.MAX_VALUE,n=e;return n||(n=new this.arrayConstructor(6)),n[0]=t,n[1]=t,n[2]=t,n[3]=-t,n[4]=-t,n[5]=-t,this._calculateNodeExtents(n)?n:undefined},e.prototype._calculateNodeExtents=function(e){var t=!1,n=this.getWorldExtents();n&&(e[0]=e[0]<n[0]?e[0]:n[0],e[1]=e[1]<n[1]?e[1]:n[1],e[2]=e[2]<n[2]?e[2]:n[2],e[3]=e[3]>n[3]?e[3]:n[3],e[4]=e[4]>n[4]?e[4]:n[4],e[5]=e[5]>n[5]?e[5]:n[5],t=!0);var r=this.children;if(r){var i=r.length;for(var s=0;s<i;s+=1)r[s]._calculateNodeExtents(e)&&(t=!0)}return t},e.prototype.addRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]),this.renderables.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addRenderableArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.renderables||(this.renderables=[]);var t=this.renderables,n=e.length;for(var r=0;r<n;r+=1)t.push(e[r]),e[r].setNode(this);this.dirtyLocalExtents=!0},e.prototype.removeRenderable=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.renderables,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){t[r].setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasRenderables=function(){return this.renderables&&this.renderables.length?!0:!1},e.prototype.addLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]),this.lightInstances.push(e),e.setNode(this),this.dirtyLocalExtents=!0},e.prototype.addLightInstanceArray=function(e){this.dirtyWorldExtents=!0,this.updateRequired(),this.lightInstances||(this.lightInstances=[]);var t=this.lightInstances,n=e.length;for(var r=0;r<n;r+=1)e[r].setNode(this),t.push(e[r]);this.dirtyLocalExtents=!0},e.prototype.removeLightInstance=function(e){this.dirtyWorldExtents=!0,this.updateRequired();var t=this.lightInstances,n=t.length;for(var r=0;r<n;r+=1)if(t[r]===e){e.setNode(null),t.splice(r,1),this.dirtyLocalExtents=!0;return}},e.prototype.hasLightInstances=function(){return this.lightInstances&&this.lightInstances.length},e.prototype.destroy=function(){this.destroyedObserver&&this.destroyedObserver.notify({node:this});var t=this.children;if(t){var n=t.length;for(var r=n-1;r>=0;r-=1){var i=t[r];this.removeChild(i),i.destroy()}}var s=this.renderables;if(s){var o=s.length;for(var u=o-1;u>=0;u-=1){var a=s[u];a.destroy&&a.destroy()}this.renderables=[]}this.lightInstances&&(this.lightInstances=[]),delete this.scene;var f=e._tempDirtyNodes,l=f.length,c;for(c=0;c<l;c+=1)f[c]=null},e.prototype.subscribeCloned=function(e){this.clonedObserver||(this.clonedObserver=r.create()),this.clonedObserver.subscribe(e)},e.prototype.unsubscribeCloned=function(e){this.clonedObserver.unsubscribe(e)},e.prototype.subscribeDestroyed=function(e){this.destroyedObserver||(this.destroyedObserver=r.create()),this.destroyedObserver.subscribe(e)},e.prototype.unsubscribeDestroyed=function(e){this.destroyedObserver.unsubscribe(e)},e.create=function(t){return new e(t)},e.version=1,e._tempDirtyNodes=[],e}();L.prototype.mathDevice=null,function(){L.prototype.arrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=new Float32Array(4),t=Object.prototype.toString.call(e);t==="[object Float32Array]"&&(L.prototype.arrayConstructor=Float32Array)}}();var A=function(){function e(e,t,n){this.md=e,this.staticSpatialMap=t||E.create(!0),this.dynamicSpatialMap=n||E.create(),this.clear();var r=this;this.onGeometryDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onGeometryDestroyed),delete r.shapes[t.name]},this.onMaterialDestroyed=function(t){t.reference.unsubscribeDestroyed(r.onMaterialDestroyed),delete r.materials[t.name]}}return e.prototype.findNode=function(e){var t=this.rootNodesMap[e]
;if(t)return t;var n=e.split("/"),r=n[0];t=this.rootNodesMap[r];for(var i=1;t&&i<n.length;i+=1)t=t.findChild(n[i]);return t},e.prototype.addRootNode=function(e){var t=e.name;e.scene=this,e.worldExtentsUpdate=!0,this.rootNodes.push(e),this.rootNodesMap[t]=e,this.addRootNodeToUpdate(e,t)},e.prototype.removeRootNode=function(e){var t=e.name;e.removedFromScene(this);var n=this.rootNodes,r=n.indexOf(e);if(r!==-1){var i=n.length-1;r<i&&(n[r]=n[i]),n.length=i}delete this.rootNodesMap[t];if(this.dirtyRoots[t]===e){delete this.dirtyRoots[t];var s=this.nodesToUpdate,o=this.numNodesToUpdate;for(r=0;r<o;r+=1)if(s[r]===e){o-=1,r<o&&(s[r]=s[o]),s[o]=null,this.numNodesToUpdate=o;break}}delete e.scene},e.prototype.addLight=function(e){this.lights[e.name]=e,e.isGlobal()&&this.globalLights.push(e)},e.prototype.removeLight=function(e){delete this.lights[e.name];if(e.isGlobal()){var t=this.globalLights,n=t.length;for(var r=0;r<n;r+=1)if(e===t[r]){t.splice(r,1);break}}},e.prototype.getLight=function(e){return this.lights[e]},e.prototype.getGlobalLights=function(){return this.globalLights},e.prototype.calculateNumNodes=function(e){var t=e.length,n=t;for(var r=0;r<t;r+=1){var i=e[r].children;i&&(n+=this.calculateNumNodes(i))}return n},e.prototype.buildPortalPlanes=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s.length,f=0,l,c,h,p,d,v,m=[];m.length=u,c=0;do m[c]=0,c+=1;while(c<u);l=0;do{d=s[l];var g=d[0],y=d[1],b=d[2],w=d[3];v=0,c=0;do p=e[c],g*p[0]+y*p[1]+b*p[2]>=w?v+=1:m[c]|=1<<l,c+=1;while(c<u);if(v===0)return t.length=0,!1;v<u&&(t[f]=o.v4Copy(d,t[f]),f+=1),l+=1}while(l<a);var E=f===0,S=this.newPoints;c=0;do p=e[c],S[c]=o.v3Build(p[0]-n,p[1]-r,p[2]-i,S[c]),c+=1;while(c<u);var x=Math.sqrt;c=0;do{h=c+1,h>=u&&(h=0);if(0!==(m[c]&m[h])){c+=1;continue}p=S[c];var T=p[0],N=p[1],C=p[2];p=S[h];var k=p[0],L=p[1],A=p[2],O=N*A-C*L,M=C*k-T*A,_=T*L-N*k,D=O*O+M*M+_*_;if(D===0)return t.length=0,!1;var P=1/x(D);O*=P,M*=P,_*=P;var H=O*n+M*r+_*i;t[f]=o.v4Build(O,M,_,H,t[f]),f+=1,c+=1}while(c<u);return t.length=f,E},e.prototype.findAreaIndex=function(e,t,n,r){var i=e.length,s=0,o,u;do{o=e[s],u=o.plane,s=u[0]*t+u[1]*n+u[2]*r<u[3]?o.neg:o.pos;if(s<=0)return-(s+1)}while(s<i);return-1},e.prototype.findAreaIndicesAABB=function(e,t,n,r,i,s,o){var u=e.length,a=[],f=[],l=[0],c=1,h,p,d,v;do{c-=1,h=l[c];do{p=e[h],d=p.plane;var m=d[0],g=d[1],y=d[2],b=d[3];m*(m<0?t:i)+g*(g<0?n:s)+y*(y<0?r:o)<b?h=p.neg:(m*(m>0?t:i)+g*(g>0?n:s)+y*(y>0?r:o)<=b&&(h=p.neg,h<=0?h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v))):(l[c]=h,c+=1)),h=p.pos);if(h<=0){h<0&&(v=-(h+1),f[v]||(f[v]=!0,a.push(v)));break}}while(h<u)}while(0<c);return a},e.prototype.findVisiblePortals=function(e,t,n,r){var i=this.visiblePortals,s=i.length,o=this.frustumPlanes,u=o.length,a=this.getQueryCounter(),f=this.areas,l,c,h,p,d,v,m,g,y=0,b=this.nearPlane,w=b[0],E=b[1],S=b[2];o[u]=this.md.v4Build(w,E,S,w*t+E*n+S*r),d=f[e],l=d.portals,c=l.length;for(v=0;v<c;v+=1){h=l[v];if(h.disabled)continue;h.queryCounter=a,p=h.plane,p[0]*t+p[1]*n+p[2]*r<p[3]&&(y<s?(g=i[y],m=g.planes):m=[],this.buildPortalPlanes(h.points,m,t,n,r,o),0<m.length&&(y<s?(g.portal=h,g.area=h.area):i[y]={portal:h,planes:m,area:h.area},y+=1))}o.length=u;if(0<y){var x,T,N,C,k,L,A,O,M=0;do{g=i[M],M+=1,m=g.planes,x=m.length,h=g.portal,e=g.area,m[x]=h.plane,d=f[e],l=d.portals,c=l.length;for(v=0;v<c;v+=1)h=l[v],T=h.area,T!==e&&h.queryCounter!==a&&!h.disabled&&(p=h.plane,N=p[0],C=p[1],k=p[2],L=p[3],N*t+C*n+k*r<L?(y<s?(g=i[y],A=g.planes):A=[],O=this.buildPortalPlanes(h.points,A,t,n,r,m),0<A.length&&(O&&(h.queryCounter=a),y<s?(g.portal=h,g.area=T):i[y]={portal:h,planes:A,area:T},y+=1)):h.queryCounter=a);m.length=x}while(M<y)}y<s&&(i.length=y)},e.prototype.findVisibleNodes=function(e,t){var n=t.length,r=this.frustumPlanes,i=!0,s=this.areas;if(s){var o=e.matrix,u=o[9],a=o[10],f=o[11],l=this.findAreaIndex(this.bspNodes,u,a,f);this.cameraAreaIndex=l;if(l>=0){e.getFrustumExtents(this.cameraExtents);var c=this.cameraExtents[0],h=this.cameraExtents[1],p=this.cameraExtents[2],d=this.cameraExtents[3],v=this.cameraExtents[4],m=this.cameraExtents[5];this.findVisiblePortals(l,u,a,f);var g,y,b,w,E=s.length;for(y=0;y<E;y+=1)g=s[y],b=g.nodes,w=g.numStaticNodes,b.length>w&&(b.length=w),g.addedDynamicNodes=!1;var S=this.isInsidePlanesAABB,x=this.dynamicSpatialMap,T=this.visiblePortals,N=T.length,C=this.getQueryCounter(),k,L,A,O,M;g=s[l],b=g.nodes,g.addedDynamicNodes=!0;var _=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter=C,S(L.worldExtents,r)&&(t[n]=L,n+=1);for(A=0;A<N;A+=1){O=T[A],M=O.planes,g=s[O.area],b=g.nodes,g.addedDynamicNodes||(g.addedDynamicNodes=!0,_=g.extents,D=_[0],P=_[1],H=_[2],B=_[3],j=_[4],F=_[5],I[0]=D<c?c:D,I[1]=P<h?h:P,I[2]=H<p?p:H,I[3]=B>d?d:B,I[4]=j>v?v:j,I[5]=F>m?m:F,x.getOverlappingNodes(I,b)),w=b.length;for(k=0;k<w;k+=1)L=b[k],L.queryCounter!==C&&S(L.worldExtents,M)&&(L.queryCounter=C,t[n]=L,n+=1)}i=!1}}i&&(n+=this.staticSpatialMap.getVisibleNodes(r,t,n),this.dynamicSpatialMap.getVisibleNodes(r,t,n))},e.prototype.findVisibleNodesTree=function(e,t,n){var r=n.length,i=this.frustumPlanes,s=!0,o=this.areas;if(o){var u=this.cameraAreaIndex;if(u>=0){var a=this.cameraExtents[0],f=this.cameraExtents[1],l=this.cameraExtents[2],c=this.cameraExtents[3],h=this.cameraExtents[4],p=this.cameraExtents[5],d=this.externalNodesStack,v,m,g,y,b,w,E,S=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6),x,T,N,C,k=o.length;for(T=0;T<k;T+=1)x=o[T],N=x.externalNodes,N&&(d.push(N),x.externalNodes=null);var L=this.isInsidePlanesAABB,A=this.findOverlappingAreas,O=this.findAreaIndex,M=this.visiblePortals,_=M.length,D=this.getQueryCounter(),P=this.bspNodes,H,B,j,F,I,q,R,U,z,W,X,V;x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter=D,L(j.worldExtents,i)&&(n[r]=j,r+=1);for(I=0;I<_;I+=1){q=M[I],H=q.planes,u=q.area,x=o[u],N=x.externalNodes;if(!N){0<d.length?N=d.pop():N=[],x.externalNodes=N,v=x.extents,m=v[0],g=v[1],y=v[2],b=v[3],w=v[4],E=v[5],S[0]=m<a?a:m,S[1]=g<f?f:g,S[2]=y<l?l:y,S[3]=b>c?c:b,S[4]=w>h?h:w,S[5]=E>p?p:E,C=e.getOverlappingNodes(S,N,0);for(B=0;B<C;B+=1){j=N[B],F=j.worldExtents,R=(F[0]+F[3])*.5,U=(F[1]+F[4])*.5,z=(F[2]+F[5])*.5,W=O(P,R,U,z);if(W>=0&&u!==W){X=A.call(this,W,F,!0),V=X.length;for(T=0;T<V;T+=1)if(X[T]===x)break;if(T>=V){C-=1;if(!(B<C))break;N[B]=N[C],B-=1}}}N.length=C}C=N.length;for(B=0;B<C;B+=1)j=N[B],j.queryCounter!==D&&L(j.worldExtents,H)&&(j.queryCounter=D,n[r]=j,r+=1)}s=!1}}s&&e.getVisibleNodes(i,n,r)},e.prototype.buildPortalPlanesNoFrustum=function(e,t,n,r,i,s){var o=this.md,u=e.length,a=s?s.length:0,f=a,l=this.newPoints,c,h;c=0;do h=e[c],l[c]=o.v3Build(h[0]-n,h[1]-r,h[2]-i,l[c]),c+=1;while(c<u);var p=Math.sqrt;c=0;do{h=l[c];var d=h[0],v=h[1],m=h[2];h=l[c+1<u?c+1:0];var g=h[0],y=h[1],b=h[2],w=v*b-m*y,E=m*g-d*b,S=d*y-v*g,x=w*w+E*E+S*S;if(x===0)return!1;var T=1/p(x);w*=T,E*=T,S*=T;var N=w*n+E*r+S*i;t[f]=o.v4Build(w,E,S,N,t[f]),f+=1,c+=1}while(c<u);for(c=0;c<a;c+=1)t[c]=o.v4Copy(s[c],t[c]);return t.length=f,!0},e.prototype.findOverlappingPortals=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y=this.getQueryCounter(),b=this.areas,w=0,E,S=i[0],x=i[1],T=i[2],N=i[3],C=i[4],k=i[5];v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1){f=o[a];if(f.disabled)continue;f.queryCounter=y,m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T&&(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d&&(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,null)&&(E.portal=f,E.area=f.area,w+=1)))}if(0<w){var L,A,O=0;do{E=s[O],O+=1,L=E.planes,e=E.area,f=E.portal,v=b[e],o=v.portals,u=o.length;for(a=0;a<u;a+=1)f=o[a],A=f.area,A!==e&&f.queryCounter!==y&&!f.disabled&&(m=f.extents,m[0]<N&&m[1]<C&&m[2]<k&&m[3]>S&&m[4]>x&&m[5]>T?(l=f.plane,c=l[0],h=l[1],p=l[2],d=l[3],c*t+h*n+p*r<d&&c*(c<0?S:N)+h*(h<0?x:C)+p*(p<0?T:k)>=d?(E=s[w],E?g=E.planes:(g=[],s[w]=E={portal:null,planes:g,area:0}),this.buildPortalPlanesNoFrustum(f.points,g,t,n,r,L)&&(f.queryCounter=y,E.portal=f,E.area=A,w+=1)):f.queryCounter=y):f.queryCounter=y)}while(O<w)}return w},e.prototype.findOverlappingNodes=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingNodesAreas(e,t,n,r)),i&&e.getOverlappingNodes(n,r)},e.prototype.findStaticOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingNodes=function(e,t,n){this.findOverlappingNodes(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingNodesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=this.externalNodesStack,f=this.areas,l,c,h,p,d=f.length;for(l=0;l<d;l+=1)c=f[l],h=c.externalNodes,h&&(a.push(h),c.externalNodes=null);var v=n[0],m=n[1],g=n[2],y=n[3],b=n[4],w=n[5];c=f[u];var E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],L=this.overlappingPortals,A=this.findOverlappingPortals(u,i,s,o,n,L),O=this.isInsidePlanesAABB,M=this.getQueryCounter(),_=r.length,D,P,H,B,j;0<a.length?h=a.pop():h=[],c.externalNodes=h;var F=this.testExtents;F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter=M,r[_]=H,_+=1;for(B=0;B<A;B+=1){j=L[B],D=j.planes,c=f[j.area],h=c.externalNodes,h||(0<a.length?h=a.pop():h=[],c.externalNodes=h,E=c.extents,S=E[0],x=E[1],T=E[2],N=E[3],C=E[4],k=E[5],F[0]=S>v?S:v,F[1]=x>m?x:m,F[2]=T>g?T:g,F[3]=N<y?N:y,F[4]=C<b?C:b,F[5]=k<w?k:w,h.length=e.getOverlappingNodes(F,h,0)),p=h.length;for(P=0;P<p;P+=1)H=h[P],H.queryCounter!==M&&O(H.worldExtents,D)&&(H.queryCounter=M,r[_]=H,_+=1)}return!0},e.prototype.findOverlappingRenderables=function(e,t,n,r){var i=!0;this.areas&&(i=!this._findOverlappingRenderablesAreas(e,t,n,r)),i&&this._findOverlappingRenderablesNoAreas(e,n,r)},e.prototype.findStaticOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.staticSpatialMap,e,t,n)},e.prototype.findDynamicOverlappingRenderables=function(e,t,n){this.findOverlappingRenderables(this.dynamicSpatialMap,e,t,n)},e.prototype._findOverlappingRenderablesAreas=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=this.findAreaIndex(this.bspNodes,i,s,o);if(u<0)return!1;var a=r.length,f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5],v,m,g,y,b,w,E,S,x,T=this.externalNodesStack,N=this.areas,C,k,L,A=N.length;for(C=0;C<A;C+=1)k=N[C],L=k.externalNodes,L&&(T.push(L),k.externalNodes=null);k=N[u];var O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],j=this.overlappingPortals,F=this.findOverlappingPortals(u,i,s,o,n,j),I=this.isInsidePlanesAABB,q=this.isFullyInsidePlanesAABB,R=this.getQueryCounter(),U,z,W,X,V;0<T.length?L=T.pop():L=[],k.externalNodes=L;var $=this.testExtents;$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0),m=L.length;for(g=0;g<m;g+=1){v=L[g],v.queryCounter=R,b=v.renderables;if(b){w=b.length;if(w===1)r[a]=b[0],a+=1;else{E=v.worldExtents;if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)for(S=0;S<w;S+=1)r[a]=b[S],a+=1;else for(S=0;S<w;S+=1)y=b[S],x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&(r[a]=y,a+=1)}}}for(W=0;W<F;W+=1){X=j[W],U=X.planes,k=N[X.area],L=k.externalNodes,L||(0<T.length?L=T.pop():L=[],k.externalNodes=L,O=k.extents,M=O[0],_=O[1],D=O[2],P=O[3],H=O[4],B=O[5],$[0]=M>f?M:f,$[1]=_>l?_:l,$[2]=D>c?D:c,$[3]=P<h?P:h,$[4]=H<p?H:p,$[5]=B<d?B:d,L.length=e.getOverlappingNodes($,L,0)),m=L.length;for(z=0;z<m;z+=1){v=L[z];if(v.queryCounter!==R){V=!0,b=v.renderables;if(b){E=v.worldExtents;if(I(E,U)){w=b.length;if(w===1)y=b[0],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else if(E[0]>=f&&E[1]>=l&&E[2]>=c&&E[3]<=h&&E[4]<=p&&E[5]<=d)if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(y.queryCounter=R,r[a]=y,a+=1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(I(y.getWorldExtents(),U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else if(q(E,U))for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d?(y.queryCounter=R,r[a]=y,a+=1):V=!1);else for(S=0;S<w;S+=1)y=b[S],y.queryCounter!==R&&(x=y.getWorldExtents(),x[3]>=f&&x[4]>=l&&x[5]>=c&&x[0]<=h&&x[1]<=p&&x[2]<=d&&I(x,U)?(y.queryCounter=R,r[a]=y,a+=1):V=!1)}else V=!1}V&&(v.queryCounter=R)}}}return!0},e.prototype._findOverlappingRenderablesNoAreas=function(e,t,n){var r=n.length,i=t[0],s=t[1],o=t[2],u=t[3],a=t[4],f=t[5],l=this.queryVisibleNodes,c,h,p,d,v,m,g,y,b;h=e.getOverlappingNodes(t,l,0);for(p=0;p<h;p+=1){c=l[p],v=c.renderables;if(v){m=v.length;if(m===1)n[r]=v[0],r+=1;else{g=c.worldExtents;if(g[0]>=i&&g[1]>=s&&g[2]>=o&&g[3]<=u&&g[4]<=a&&g[5]<=f)for(y=0;y<m;y+=1)n[r]=v[y],r+=1;else for(y=0;y<m;y+=1)d=v[y],b=d.getWorldExtents(),b[3]>=i&&b[4]>=s&&b[5]>=o&&b[0]<=u&&b[1]<=a&&b[2]<=f&&(n[r]=d,r+=1)}}}},e.prototype.cloneRootNode=function(e,t){var n=e.clone(t);return this.addRootNode(n),n},e.prototype.updateVisibleNodes=function(e){var t=!0;this.areas&&(t=!this._updateVisibleNodesAreas(e)),t&&this._updateVisibleNodesNoAreas(e),this.frameIndex+=1},e.prototype._updateVisibleNodesNoAreas=function(e){var t=this.visibleNodes,n=0,r=this.visibleRenderables,i=0,s=this.visibleLights,o=0;this.extractFrustumPlanes(e);var u=this.frustumPlanes,a=this.frameIndex,f=this.nearPlane,l=f[0],c=f[1],h=f[2],p=f[3],d=0,v,m,g=this.isFullyInsidePlanesAABB,y=this.isInsidePlanesAABB,b=this.queryVisibleNodes,w=this.staticSpatialMap.getVisibleNodes(u,b,0);w+=this.dynamicSpatialMap.getVisibleNodes(u,b,w);for(v=0;v<w;v+=1){m=b[v];if(!m.disabled){var E=m.worldExtents,S,x,T,N,C;m.frameVisible=a,S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,m.distance=S;if(0<S){t[n]=m,n+=1;var k=m.renderables,L=k?k.length:0,A=m.lightInstances,O=A?A.length:0,M=1<O+L?g(E,u):!1;if(k)if(L===1&&!A)x=k[0],x.disabled||(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1);else for(T=0;T<L;T+=1){x=k[T];if(!x.disabled){E=x.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(d<S&&(d=S),x.distance=S,x.frameVisible=a,r[i]=x,i+=1)}}if(A)if(O===1&&!k)N=A[0],!N.disabled&&!N.light.isGlobal()&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1);else for(C=0;C<O;C+=1){N=A[C];if(!N.disabled&&!N.light.isGlobal()){E=N.getWorldExtents();if(M||y(E,u))S=l*(l>0?E[3]:E[0])+c*(c>0?E[4]:E[1])+h*(h>0?E[5]:E[2])-p,0<S&&(N.distance=S,N.frameVisible=a,s[o]=N,o+=1)}}}}}this.maxDistance=d+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,n,i,o):(r.length=i,s.length=o,t.length=n)},e.prototype._updateVisibleNodesAreas=function(e){function D(e,t){var n=e.worldExtents,r=!0,i;e.frameVisible!==p?(e.frameVisible=p,i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,e.distance=i,0<i&&(o[u]=e,u+=1)):i=e.distance;if(0<i){var s,h,d,w,E=e.renderables,T=E?E.length:0,N=e.lightInstances,C=N?N.length:0,k=1<C+T?S(n,t):!1;if(E)if(T===1&&!N)s=E[0],!s.disabled&&s.queryCounter!==_&&(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1);else for(h=0;h<T;h+=1)s=E[h],!s.disabled&&s.queryCounter!==_&&(n=s.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(b<i&&(b=i),s.distance=i,s.frameVisible=p,s.queryCounter=_,a[f]=s,f+=1):r=!1):r=!1);if(N)if(C===1&&!E)d=N[0],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1);else for(w=0;w<C;w+=1)d=N[w],!d.disabled&&d.queryCounter!==_&&!d.light.isGlobal()&&(n=d.getWorldExtents(),k||x(n,t)?(i=v*(v>0?n[3]:n[0])+m*(m>0?n[4]:n[1])+g*(g>0?n[5]:n[2])-y,0<i?(d.distance=i,d.frameVisible=p,d.queryCounter=_,l[c]=d,c+=1):r=!1):r=!1)}r&&(e.queryCounter=_)}var t=e.matrix,n=t[9],r=t[10],i=t[11],s=this.findAreaIndex(this.bspNodes,n,r,i);this.cameraAreaIndex=s;if(s<0)return!1;var o=this.visibleNodes,u=0,a=this.visibleRenderables,f=0,l=this.visibleLights,c=0;this.extractFrustumPlanes(e);var h=this.frustumPlanes,p=this.frameIndex,d=this.nearPlane,v=d[0],m=d[1],g=d[2],y=d[3],b=0,w=0,E,S=this.isFullyInsidePlanesAABB,x=this.isInsidePlanesAABB,T=this.cameraExtents;e.getFrustumExtents(T);var N=T[0],C=T[1],k=T[2],L=T[3],A=T[4],O=T[5],M=this.areas,_=this.getQueryCounter();this.findVisiblePortals(s,n,r,i);var P,H,B,j,F=M.length;for(H=0;H<F;H+=1)P=M[H],B=P.nodes,j=P.numStaticNodes,B.length>j&&(B.length=j),P.addedDynamicNodes=!1;var I=this.dynamicSpatialMap,q=this.visiblePortals,R=q.length,U,z,W;P=M[s],B=P.nodes,P.addedDynamicNodes=!0;var X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5],Y=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6);Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter=_,!E.disabled&&x(E.worldExtents,h)&&D(E,h);for(U=0;U<R;U+=1){z=q[U],W=z.planes,P=M[z.area],B=P.nodes,X=P.extents,V=X[0],$=X[1],J=X[2],K=X[3],Q=X[4],G=X[5];if(L>V&&A>$&&O>J&&K>N&&Q>C&&G>k){P.addedDynamicNodes||(P.addedDynamicNodes=!0,Y[0]=V<N?N:V,Y[1]=$<C?C:$,Y[2]=J<k?k:J,Y[3]=K>L?L:K,Y[4]=Q>A?A:Q,Y[5]=G>O?O:G,I.getOverlappingNodes(Y,B)),j=B.length;for(w=0;w<j;w+=1)E=B[w],E.queryCounter!==_&&(E.disabled?E.queryCounter=_:x(E.worldExtents,W)&&D(E,W))}}return this.maxDistance=b+e.nearPlane,this.maxDistance<e.farPlane?this._filterVisibleNodesForCameraBox(e,u,f,c):(a.length=f,l.length=c,o.length=u),!0},e.prototype._filterVisibleNodesForCameraBox=function(e,t,n,r){var i=this.visibleNodes,s=this.visibleRenderables,o=this.visibleLights,u=n,a=r,f=this.cameraExtents;e.getFrustumExtents(f,this.maxDistance);var l=f[0],c=f[1],h=f[2],p=f[3],d=f[4],v=f[5],m,g,y,b,w=0;while(w<n){g=s[w],b=g.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){g.frameVisible-=1,n-=1;if(!(w<n))break;s[w]=s[n]}else w+=1}w=0;while(w<r){y=o[w],b=y.getWorldExtents();if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){y.frameVisible-=1,r-=1;if(!(w<r))break;o[w]=o[r]}else w+=1}if(u!==n||a!==r){w=0;while(w<t){m=i[w],b=m.worldExtents;if(b[0]>p||b[1]>d||b[2]>v||b[3]<l||b[4]<c||b[5]<h){m.frameVisible-=1,t-=1;if(!(w<t))break;i[w]=i[t]}else w+=1}}s.length=n,o.length=r,i.length=t},e.prototype.getCurrentVisibleNodes=function(){return this.visibleNodes},e.prototype.getCurrentVisibleRenderables=function(){return this.visibleRenderables},e.prototype.getCurrentVisibleLights=function(){return this.visibleLights},e.prototype.addRootNodeToUpdate=function(e,t){var n=this.dirtyRoots;if(n[t]!==e){n[t]=e;var r=this.numNodesToUpdate;this.nodesToUpdate[r]=e,this.numNodesToUpdate=r+1}},e.prototype.updateNodes=function(){var e=this.numNodesToUpdate;if(0<e){var t=this.nodesToUpdate,n=this.dirtyRoots,r;for(r=0;r<e;r+=1)n[t[r].name]=null;L.updateNodes(this.md,this,t,e),this.numNodesToUpdate=0}},e.prototype.update=function(){this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents(),this.areas&&this.staticNodesChangeCounter!==this.areaInitalizeStaticNodesChangeCounter&&this.initializeAreas()},e.prototype.updateExtents=function(){var e=this.staticSpatialMap.getExtents(),t=this.dynamicSpatialMap.getExtents(),n=this.extents;if(e)if(t){var r,i,s,o,u,a,f,l,c,h,p,d;r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=t[0],l=t[1],c=t[2],h=t[3],p=t[4],d=t[5],n[0]=r<f?r:f,n[1]=i<l?i:l,n[2]=s<c?s:c,n[3]=o>h?o:h,n[4]=u>p?u:p,n[5]=a>d?a:d}else n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=e[4],n[5]=e[5];else t?(n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5]):(n[0]=0,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=0)},e.prototype.getExtents=function(){return 0<this.numNodesToUpdate&&(this.updateNodes(),this.staticSpatialMap.finalize(),this.dynamicSpatialMap.finalize(),this.updateExtents()),this.extents},e.prototype.loadMaterial=function(e,t,n,r,i){var s=this.materials;if(!s[r]){var o=i.effect||"default",u=this.createMaterial(r,i,o,null,null,e);if(u){delete u.effectName;var a=n.get(o);return a&&a.prepareMaterial(u),u.loadTextures(t),!0}}return!1},e.prototype.hasMaterial=function(e){var t=this.materials[e];return t?!0:!1},e.prototype.getMaterial=function(e){return this.materials[e]},e.prototype.drawNodesArray=function(e,t,n,r,i){var s=e.length;if(s>0){var o=t.setTechnique,u=t.setTechniqueParameters,a=t.setStream,f=t.setIndexBuffer,l=t.drawIndexed,c=t.draw,h=null,p=null,d=null,v=-1,m,g,y,b,w,E,S,x,T,N,C,k,L,A=0;o.call(t,r),u.call(t,n);do{m=e[A],N=m.renderables;if(N){k=N.length;for(L=0;L<k;L+=1){C=N[L],i.call(C),g=C.geometry,w=g.vertexBuffer,S=g.vertexOffset,E=g.semantics,x=C.surface,y=C.sharedMaterial.techniqueParameters,b=C.techniqueParameters,h!==y?(h=y,u.call(t,y,b)):u.call(t,b);if(p!==w||d!==E||v!==S)p=w,d=E,v=S,a.call(t,w,E,S);T=x.indexBuffer,T?(f.call(t,T),l.call(t,x.primitive,x.numIndices,x.first)):c.call(t,x.primitive,x.numVertices,x.first)}}A+=1}while(A<s)}},e.prototype.drawVisibleNodes=function(e,t,n,r){this.drawNodesArray(this.visibleNodes,e,t,n,r)},e.prototype.clearMaterials=function(){var e=this.onMaterialDestroyed,t=this.materials;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.materials={}},e.prototype.clearShapes=function(){var e=this.onGeometryDestroyed,t=this.shapes;if(t)for(var n in t)t.hasOwnProperty(n)&&t[n].reference.unsubscribeDestroyed(e);this.shapes={}},e.prototype.clearShapesVertexData=function(){var e=this.shapes,t;if(e)for(var n in e)if(e.hasOwnProperty(n)){t=e[n],delete t.vertexData,delete t.indexData;var r=t.surfaces;if(r)for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];delete s.vertexData,delete s.indexData}}},e.prototype.clearRootNodes=function(){var e=this.rootNodes;if(e){var t=e.length;for(var n=0;n<t;n+=1)e[n].destroy()}this.rootNodes=[],this.rootNodesMap={},this.dirtyRoots={},this.nodesToUpdate=[],this.numNodesToUpdate=0},e.prototype.clear=function(){this.effects=[],this.effectsMap={},this.semantics={},this.lights={},this.globalLights=[],this.clearRootNodes(),this.clearMaterials(),this.clearShapes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear(),this.frustumPlanes=[],this.animations={},this.skeletons={},this.extents=this.md.aabbBuildEmpty(),this.visibleNodes=[],this.visibleRenderables=[],this.visibleLights=[],this.cameraAreaIndex=-1,this.cameraExtents=this.md.aabbBuildEmpty(),this.visiblePortals=[],this.frameIndex=0,this.queryCounter=0,this.staticNodesChangeCounter=0,this.testExtents=this.md.aabbBuildEmpty(),this.externalNodesStack=[],this.overlappingPortals=[],this.newPoints=[],this.queryVisibleNodes=[]},e.prototype.endLoading=function(e){this.initializeNodes(),this.initializeAreas(),e&&e(this)},e.prototype.initializeNodes=function(){var e=this.numNodesToUpdate;0<e&&(this.numNodesToUpdate=0,this.dirtyRoots={},L.updateNodes(this.md,this,this.nodesToUpdate,e)),this.staticSpatialMap.finalize(),this.updateExtents()},e.prototype.addAreaStaticNodes=function(){var e=this.findAreaIndicesAABB,t=this.findAreaIndex,n=this,r=function(s,o){if(this.dynamic)return;if(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents){var u=this.worldExtents,a=u[0],f=u[1],l=u[2],c=u[3],h=u[4],p=u[5],d,v,m,g,y;if(!this.hasRenderables()&&this.lightInstances.length===1&&this.lightInstances[0].light.spot){var b=this.world;m=b[9],g=b[10],y=b[11]}else m=(a+c)*.5,g=(f+h)*.5,y=(l+p)*.5;var w=t(s,m,g,y);if(w>=0){d=o[w],d.nodes.push(this);var E=n.findOverlappingAreas(w,u),S=E.length;for(v=0;v<S;v+=1)E[v].nodes.push(this)}else{var x=!1,T;for(;;){var N=e(s,a,f,l,c,h,p),C=N.length;if(0<C){v=0;do d=o[N[v]],T=d.extents,T[0]<=c&&T[1]<=h&&T[2]<=p&&T[3]>=a&&T[4]>=f&&T[5]>=l&&(d.nodes.push(this),x=!0),v+=1;while(v<C);if(!x){v=0;do o[N[v]].nodes.push(this),v+=1;while(v<C)}break}var k=Math.max(c-a,h-f,p-l)/20;a-=k,f-=k,l-=k,c+=k,h+=k,p+=k}}}var L=this.children;if(L){var A=L.length;for(var O=0;O<A;O+=1)r.call(L[O],s,o)}},i=this.rootNodes,s=i.length,o=this.bspNodes,u=this.areas;for(var a=0;a<s;a+=1)r.call(i[a],o,u)},e.prototype.findOverlappingAreas=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v=this.getQueryCounter(),m=this.areas,g=[],y=0,b=[],w=0,E=t[0],S=t[1],x=t[2],T=t[3],N=t[4],C=t[5];r=m[e],r.queryCounter=v,i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1))}while(0<y){y-=1,u=g[y],p=u.area,r=m[p],r.queryCounter!==v&&(r.queryCounter=v,b[w]=r,w+=1),i=r.portals,s=i.length;for(o=0;o<s;o+=1){u=i[o];if(n&&u.disabled)continue;d=u.area,d!==p&&d!==e&&u.queryCounter!==v&&(u.queryCounter=v,h=u.extents,h[0]<T&&h[1]<N&&h[2]<C&&h[3]>E&&h[4]>S&&h[5]>x&&(a=u.plane,f=a[0],l=a[1],c=a[2],f*(f<0?E:T)+l*(l<0?S:N)+c*(c<0?x:C)>=a[3]&&(g[y]=u,y+=1)))}}return b},e.prototype.checkAreaDynamicNodes=function(){var e=this.findAreaIndicesAABB,t=this.dynamicSpatialMap,n=this.bspNodes,r=this.areas,i=function(){if(this.dynamic&&(this.hasRenderables()||this.hasLightInstances()&&this.worldExtents)){var o=this.worldExtents,u=o[0],a=o[1],f=o[2],l=o[3],c=o[4],h=o[5],p=!1,d=!1,v;for(;;){var m=e(n,u,a,f,l,c,h),g=m.length;if(0<g){v=0;do{var y=r[m[v]],b=y.extents;if(b[0]<=l&&b[1]<=c&&b[2]<=h&&b[3]>=u&&b[4]>=a&&b[5]>=f){d=!0;break}v+=1}while(v<g)}if(d)break;var w=Math.max(l-u,c-a,h-f)/20;u-=w,a-=w,f-=w,l+=w,c+=w,h+=w,p=!0}p&&(o[0]=u,o[1]=a,o[2]=f,o[3]=l,o[4]=c,o[5]=h,t.update(this,o))}var E=this.children;if(E){var S=E.length;for(var x=0;x<S;x+=1)i.call(E[x])}},s=this.rootNodes,o=s.length;for(var u=0;u<o;u+=1)i.call(s[u])},e.prototype.initializeAreas=function(){var e=this.areas;if(e){var t=e.length,n,r,i,s,o;for(n=0;n<t;n+=1)r=e[n],i=r.target,r.nodes=[],s=i.calculateHierarchyWorldExtents(),s&&(o=r.extents,o[0]=s[0]<o[0]?s[0]:o[0],o[1]=s[1]<o[1]?s[1]:o[1],o[2]=s[2]<o[2]?s[2]:o[2],o[3]=s[3]>o[3]?s[3]:o[3],o[4]=s[4]>o[4]?s[4]:o[4],o[5]=s[5]>o[5]?s[5]:o[5]);this.addAreaStaticNodes(),this.checkAreaDynamicNodes();for(n=0;n<t;n+=1)r=e[n],r.numStaticNodes=r.nodes.length}this.areaInitalizeStaticNodesChangeCounter=this.staticNodesChangeCounter},e.prototype.createMaterial=function(e,t,n,r,i,s){var o=this.materials,u=k.create(s),a,f,l,c,h;if(r){var p=r[n];if(p){var d=p.parameters;for(c in d)d.hasOwnProperty(c)&&(a=d[c],typeof a=="string"?(i?f=i[a]||a:f=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[c]=f,u.techniqueParameters[c]=null):u.techniqueParameters[c]=a);l=p.type,h=p.meta}else l=n}else l=n;var v=t.parameters;for(c in v)v.hasOwnProperty(c)&&(a=v[c],typeof a=="string"?(i?f=i[a]||a:f=a,u.texturesNames||(u.texturesNames={}),u.texturesNames[c]=f,u.techniqueParameters[c]=null):u.techniqueParameters[c]=a);u.effectName=l;var m=t.meta;if(m){if(h)for(c in h)h.hasOwnProperty(c)&&!m.hasOwnProperty(c)&&(m[c]=h[c]);u.meta=m}else h&&(u.meta=h);return o[e]=u,u.name=e,u.reference.subscribeDestroyed(this.onMaterialDestroyed),u},e.prototype.loadMaterials=function(e){var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=this.createMaterial;e.append||(this.effects=[],this.effectsMap={},this.clearMaterials());var s=t.materials;if(s){var o=t.images,u=t.effects,a=this.materials;for(var f in s)if(s.hasOwnProperty(f)&&!a[f]){var l=s[f],c=l.effect||"default";i.call(this,f,l,c,u,o,n,r)}}},e.prototype.loadSkeletons=function(e){var t=e.data,n=t.skeletons,r=this.md,i=r.m43Build,s,o;for(var u in n)if(n.hasOwnProperty(u)){var a=n[u],f=a.numNodes,l=a.invBoneLTMs,c=a.bindPoses;for(var h=0;h<f;h+=1)s=l[h],o=c[h],l[h]=i.apply(r,s),c[h]=i.apply(r,o);e.skeletonNamePrefix&&(u=e.skeletonNamePrefix+u),this.skeletons[u]=a}},e.prototype._updateSingleIndexTables=function(e,t,n,r,i){var s=e.faces,o=s.length,u=[];u.length=o;var a=n.length,f=0,l=0,c,h,p,d,v,m;while(l<o){d=r,c=l,h=l+(t-1);do p=s[c],v=d[p],v===undefined&&(d[p]=v={}),d=v,c+=1;while(c<h);p=s[c],m=d[p];if(m===undefined){d[p]=m=i,i+=1,c=l;do n[a]=s[c],a+=1,c+=1;while(c<h);n[a]=p,a+=1}u[f]=m,f+=1,l+=t}return u.length=f,e.faces=u,i},e.prototype._isSequentialIndices=function(e,t){var n=e[0],r;for(r=1;r<t;r+=1)if(e[r]!==n+r)return!1;return!0},e.prototype._optimizeRenderables=function(e,t){function g(e){var t=new e.constructor,n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}var n=e.renderables,r=n.length,i=t.PRIMITIVE_TRIANGLES,s={},o=[],u=0,a,f,l,c,h,p,d,v,m=!1;for(a=0;a<r;a+=1)f=n[a],c=f.surface,c.primitive===i&&f.geometryType==="rigid"?(l=f.geometry,h=l.vertexBuffer.id,p=s[h],p===undefined&&(s[h]=p={}),c.indexBuffer?d=c.indexBuffer.id:d="null",v=p[d],v===undefined?p[d]=[f]:(v.push(f),m=!0)):(o[u]=f,u+=1);if(m){var y=Math.max,b=Math.min,w=this.float32ArrayConstructor?this.float32ArrayConstructor:Array,E=new w(6),S,x,T,N,C,k,L,A,O,M,_,D=function(){var t=g(S.surface);S.surface=t,t.indexBuffer?(t.numIndices=N-t.first,t.numVertices=C):t.numVertices=N-t.first;var n=(E[3]+E[0])*.5,r=(E[4]+E[1])*.5,i=(E[5]+E[2])*.5;if(n!==0||r!==0||i!==0){var s=S.center||new w(3);S.center=s,s[0]=n,s[1]=r,s[2]=i}else S.center=null;var o=S.halfExtents||new w(3);S.halfExtents=o,o[0]=(E[3]-E[0])*.5,o[1]=(E[4]-E[1])*.5,o[2]=(E[5]-E[2])*.5};r=0;for(h in s)if(s.hasOwnProperty(h)){p=s[h];for(d in p)if(p.hasOwnProperty(d)){v=p[d],k=v.length;if(k===1)n[r]=v[0],r+=1;else{v.sort(function(e,t){return e.geometry.vertexOffset-t.geometry.vertexOffset||e.surface.first-t.surface.first}),L=0,A=null,S=null,C=0,T=-1,N=0,x=0;do f=v[L],l=f.geometry,c=f.surface,O=f.sharedMaterial,M=f.center,_=f.halfExtents,T!==l.vertexOffset||N!==c.first||!A||A!==O&&!A.isSimilar(O)?(0<x&&(1<x&&D(),n[r]=S,r+=1),A=O,S=f,C=0,x=1,T=l.vertexOffset,M?(E[0]=M[0]-_[0],E[1]=M[1]-_[1],E[2]=M[2]-_[2],E[3]=M[0]+_[0],E[4]=M[1]+_[1],E[5]=M[2]+_[2]):(E[0]=-_[0],E[1]=-_[1],E[2]=-_[2],E[3]=_[0],E[4]=_[1],E[5]=_[2])):(x+=1,M?(E[0]=b(E[0],M[0]-_[0]),E[1]=b(E[1],M[1]-_[1]),E[2]=b(E[2],M[2]-_[2]),E[3]=y(E[3],M[0]+_[0]),E[4]=y(E[4],M[1]+_[1]),E[5]=y(E[5],M[2]+_[2])):(E[0]=b(E[0],-_[0]),E[1]=b(E[1],-_[1]),E[2]=b(E[2],-_[2]),E[3]=y(E[3],_[0]),E[4]=y(E[4],_[1]),E[5]=y(E[5],_[2]))),c.indexBuffer?(N=c.first+c.numIndices,C+=c.numVertices):N=c.first+c.numVertices,L+=1;while(L<k);1<x&&D(),n[r]=S,r+=1}}}for(a=0;a<u;a+=1)n[r]=o[a],r+=1;for(a=r;a<n.length;a+=1)n[a].setNode(null);n.length=r}},e.prototype.loadShape=function(e,t,n){var r=this.shapes[e];if(!r){var i=this.semantics,s=n.data,o=n.graphicsDevice,u=n.keepVertexData,a=s.geometries,f=a[t],l=f.sources,c=f.inputs,h=n.skeletonNamePrefix?n.skeletonNamePrefix+f.skeleton:f.skeleton;r=Geometry.create();if(h){var p=this.skeletons[h];p?(r.skeleton=p,r.type="skinned"):r.type="rigid"}else r.type="rigid";if(o){var d,v,m,g,y=0,b=[],w=function(t,n){return t>=0&&n<=255&&n>=0},E=function(t,n,r){var i=t.length;if(n.length!==i)return!1;for(var s=0;s<i;s+=1)if(!r(t[s],n[s]))return!1;return!0},S=n.vertexFormatMap||{},x;for(var T in c)if(c.hasOwnProperty(T)){if(o["SEMANTIC_"+T]===undefined)continue;x=c[T],d=x.offset,d>y&&(y=d);var N=l[x.source],C=N.stride;g=S[T],m=C,g&&(g.indexOf("4")?m=4:g.indexOf("3")?m=3:g.indexOf("2")?m=2:g.indexOf("1")?m=1:g=null),g||(T==="BLENDINDICES"||T==="BLENDINDICES0")&&C===4&&E(N.min,N.max,w)&&(g="UBYTE4"),g||(g="FLOAT"+C),b.push({semantic:T,offset:d,data:N.data,stride:C,destFormat:g,destStride:m})}var k=y+1;if(0<y){var L=function(e,t){if(e.offset===t.offset){var n=e.semantic;typeof n=="string"&&(n=o["SEMANTIC_"+n]);var r=t.semantic;return typeof r=="string"&&(r=o["SEMANTIC_"+r]),n-r}return e.offset-t.offset};b.sort(L)}var A=b.length,O=[],M=[],_=this.float32ArrayConstructor?!0:!1,D=0,P,H;for(P=0;P<A;P+=1)H=b[P],O[P]=H.semantic,g=H.destFormat,_&&(typeof g=="string"?g[0]!=="F"&&(_=!1):g!==o.VERTEXFORMAT_FLOAT1&&g!==o.VERTEXFORMAT_FLOAT2&&g!==o.VERTEXFORMAT_FLOAT3&&g!==o.VERTEXFORMAT_FLOAT4&&(_=!1)),M[P]=g,D+=H.stride;var B,j=0,F=!1,I=f.surfaces;I||(F=!0,I={singleSurface:{triangles:f.triangles,lines:f.lines,numPrimitives:f.numPrimitives}});var q,R,U,z;for(z in I)if(I.hasOwnProperty(z)){q=I[z],R={},r.surfaces[z]=R,U=q.triangles;var W,X;U?(W=o.PRIMITIVE_TRIANGLES,X=3):(U=q.lines,U&&(W=o.PRIMITIVE_LINES,X=2)),R.primitive=W,R.faces=U,U&&(1<k?(B=q.numPrimitives*X,R.numVertices=B):(B=b[0].data.length/b[0].stride,B>U.length&&(B=U.length),R.numVertices=B))}if(k>1){j=0;var V=[],$={},J=r.surfaces;for(z in J)if(J.hasOwnProperty(z)){var K=J[z];j=this._updateSingleIndexTables(K,k,V,$,j)}$=null;for(P=0;P<A;P+=1){H=b[P];var Q=H.offset,G=H.stride,Y=H.data,Z=new Array(G*j),et=0
,tt=Q;while(et<j){var nt=G*et,rt=G*V[tt];for(var it=0;it<G;it+=1)Z[nt+it]=Y[rt+it];et+=1,tt+=k}H.data=Z,H.offset=0}V.length=0,V=null,k=1}j=b[0].data.length/b[0].stride;var st=n.vertexBufferManager||this.vertexBufferManager;st||(st=VertexBufferManager.create(o),this.vertexBufferManager=st);var ot=n.indexBufferManager||this.indexBufferManager;ot||(ot=IndexBufferManager.create(o),this.indexBufferManager=ot);var ut,at=null,ft=st.allocate(j,M);at=ft.vertexBuffer;if(!at)return undefined;r.vertexBuffer=at,r.vertexBufferManager=st,r.vertexBufferAllocation=ft,ut=ft.baseIndex;var lt,ct,ht,pt,dt=_?new this.float32ArrayConstructor(j*D):new Array(j*D),vt=0;for(ct=0;ct<j;ct+=1){P=0;do{H=b[P];var mt=H.data;v=H.stride,ht=ct*v,pt=ht+v,m=H.destStride;do dt[vt]=mt[ht],vt+=1,ht+=1;while(ht<pt);while(v<m)dt[vt]=0,vt+=1,m-=1;P+=1}while(P<A)}at.setData(dt,ut,j),u&&!_&&this.float32ArrayConstructor&&(dt=new this.float32ArrayConstructor(dt));var gt=0,yt;for(z in I)if(I.hasOwnProperty(z)){R=r.surfaces[z],U=R.faces;if(U){yt=U.length;if(yt===6&&j===4&&R.primitive===o.PRIMITIVE_TRIANGLES){var bt=U[0];if(bt===U[3]||bt===U[4]||bt===U[5]){U[0]=U[1],U[1]=U[2],U[2]=bt,bt=U[0];if(bt===U[3]||bt===U[4]||bt===U[5])U[0]=U[1],U[1]=U[2],U[2]=bt}var wt=U[5];if(wt===U[1]||wt===U[2]){U[5]=U[4],U[4]=U[3],U[3]=wt,wt=U[5];if(wt===U[1]||wt===U[2])U[5]=U[4],U[4]=U[3],U[3]=wt}U[1]===U[4]&&U[2]===U[3]&&(R.primitive=o.PRIMITIVE_TRIANGLE_STRIP,yt=4,U=[U[0],U[1],U[2],U[5]],R.faces=U)}this._isSequentialIndices(U,yt)||(gt+=yt)}}var Et,St,xt,Tt,Nt;if(0<gt){Nt=ut+j-1;if(Nt>=65536)if(j<=65536){var Ct=ut>>>16<<16;ut-=Ct,ut+j>65536?(Ct+=ut+j-65536,ut=65536-j,Nt=65535):Nt=ut+j-1,r.vertexOffset=Ct}else r.vertexOffset=0;else r.vertexOffset=0;lt=ot.allocate(gt,Nt<65536?"USHORT":"UINT"),Et=lt.indexBuffer;if(!Et)return undefined;r.indexBufferManager=ot,r.indexBufferAllocation=lt,Nt<65536&&this.uint16ArrayConstructor?St=new this.uint16ArrayConstructor(gt):this.uint32ArrayConstructor?St=new this.uint32ArrayConstructor(gt):St=new Array(gt),xt=lt.baseIndex,Tt=0}for(z in I)if(I.hasOwnProperty(z)){R=r.surfaces[z],U=R.faces,delete R.faces;if(U){yt=U.length;if(!this._isSequentialIndices(U,yt)){R.indexBuffer=Et,R.numIndices=yt,R.first=xt+Tt,R.numVertices=j;if(ut)for(ct=0;ct<yt;ct+=1)St[Tt]=ut+U[ct],Tt+=1;else for(ct=0;ct<yt;ct+=1)St[Tt]=U[ct],Tt+=1;u&&(Nt<65536&&this.uint16ArrayConstructor?R.indexData=new this.uint16ArrayConstructor(U):this.uint32ArrayConstructor?R.indexData=new this.uint32ArrayConstructor(U):R.indexData=U)}else R.first=ut+U[0];U=null,u&&(R.vertexData=dt)}else delete r.surfaces[z]}Et&&(Et.setData(St,xt,gt),St=null);var kt=O.join(),Lt=i[kt];Lt||(Lt=o.createSemantics(O),i[kt]=Lt),r.semantics=Lt,F&&(q=r.surfaces.singleSurface,q&&(r.primitive=q.primitive,u&&(r.vertexData=q.vertexData),r.first=q.first,r.numVertices=q.numVertices,q.indexBuffer&&(r.indexBuffer=q.indexBuffer,r.numIndices=q.numIndices,u&&(r.indexData=q.indexData))),delete r.surfaces)}if(c.POSITION){var At=l[c.POSITION.source],Ot=At.min,Mt=At.max;if(Ot&&Mt){var _t=Ot[0],Dt=Ot[1],Pt=Ot[2],Ht=Mt[0],Bt=Mt[1],jt=Mt[2],Ft,It;if(_t!==-Ht||Dt!==-Bt||Pt!==-jt){if(this.float32ArrayConstructor){var qt=new this.float32ArrayConstructor(6);It=qt.subarray(0,3),Ft=qt.subarray(3,6)}else It=new Array(3),Ft=new Array(3);It[0]=(_t+Ht)*.5,It[1]=(Dt+Bt)*.5,It[2]=(Pt+jt)*.5,Ft[0]=Ht-It[0],Ft[1]=Bt-It[1],Ft[2]=jt-It[2]}else Ft=this.float32ArrayConstructor?new this.float32ArrayConstructor(3):new Array(3),Ft[0]=(Ht-_t)*.5,Ft[1]=(Bt-Dt)*.5,Ft[2]=(jt-Pt)*.5;r.center=It,r.halfExtents=Ft}}return this.shapes[e]=r,r.name=e,r.reference.subscribeDestroyed(this.onGeometryDestroyed),r}throw"Geometry '"+e+"' already exists in the scene"},e.prototype.streamShapes=function(e,t){var n=e.yieldFn,r=this,i=e.shapesNamePrefix,s=e.data,o=s.geometries,u=e.loadCustomShapeFn,a=[],f=[];for(var l in o)if(o.hasOwnProperty(l)){var c=o[l];c.meta&&c.meta.graphics&&(c.meta.custom?f.push(l):a.push(l))}var h=function(){var o=a.pop(),u=i?i+"-"+o:o;r.loadShape(u,o,e),a.length?n(h):n(t)},p=function(){var o=f.pop(),l=i?i+"-"+o:o;u.call(r,l,o,e),f.length?n(p):a.length?n(h):n(t)};f.length?n(p):a.length?n(h):n(t)},e.prototype.loadLights=function(e){var t=e.data,n=e.textureManager;e.append||(this.lights={},this.globalLights=[]);var r=t.lights,i=this.lights,o=this.globalLights,u=this.materials,a=s.beget,f=e.mathDevice,l=f.v3Build;for(var c in r)if(r.hasOwnProperty(c)&&!i[c]){var h=r[c],p=a(h),d=h.type;d==="directional"?p.directional=!0:d==="spot"?p.spot=!0:d==="ambient"?p.ambient=!0:p.point=!0,p.color=h.color&&l.apply(f,h.color),p.origin=h.origin&&l.apply(f,h.origin),p.center=h.center&&l.apply(f,h.center),p.target=h.target&&l.apply(f,h.target),p.right=h.right&&l.apply(f,h.right),p.up=h.up&&l.apply(f,h.up),p.start=h.start&&l.apply(f,h.start),p.end=h.end&&l.apply(f,h.end),p.direction=h.direction&&l.apply(f,h.direction),p.halfExtents=h.halfextents&&l.apply(f,h.halfextents);var v=h.material;if(v){var m=u[v];m&&(p.material=m,m.effectName&&(delete m.effectName,m.loadTextures(n)))}var g=Light.create(p);i[c]=g,g.isGlobal()&&o.push(g)}},e.prototype.loadNodes=function(e){function E(e,t){function n(e){var t=Math.abs;return t(1-e[0])<1e-5&&t(0-e[1])<1e-5&&t(0-e[2])<1e-5&&t(0-e[3])<1e-5&&t(1-e[4])<1e-5&&t(0-e[5])<1e-5&&t(0-e[6])<1e-5&&t(0-e[7])<1e-5&&t(1-e[8])<1e-5&&t(0-e[9])<1e-5&&t(0-e[10])<1e-5&&t(0-e[11])<1e-5}if((!t.camera||!e.camera)&&t.disabled===e.disabled&&t.dynamic===e.dynamic&&t.kinematic===e.kinematic&&(!t.local||n(t.local))){t.renderables&&e.addRenderableArray(t.renderables),t.lightInstances&&e.addLightInstanceArray(t.lightInstances),t.camera&&(e.camera=t.camera);var r=t.children;if(r){var i,s=r;for(i=0;i<s;i+=1)E(e,t)||e.addChild(t)}return!0}return!1}var t=e.data,n=e.graphicsDevice,r=e.textureManager,i=e.effectManager,s=e.baseScene,o=e.keepCameras,u=e.keepLights,a=e.optimizeHierarchy,f=e.optimizeRenderables,l=e.disabled;e.append||(this.clearRootNodes(),this.staticSpatialMap.clear(),this.dynamicSpatialMap.clear());var c=e.loadCustomGeometryInstanceFn,h=this.md,p=h.m43Build,d=this.materials,v=this.lights,m=this,g;s&&(g=s.materials);var y=e.baseMatrix,b=e.nodesNamePrefix,w=e.shapesNamePrefix,S=function(y,b,x,T){var N=b?b+"/"+y:y,C=L.create({name:y,local:this.matrix&&p.apply(h,this.matrix),dynamic:this.dynamic||x.dynamic||e.dynamic}),k,A=this.customgeometryinstances;if(A&&c)for(var O in A)if(A.hasOwnProperty(O)){var M=A[O],_=c.call(m,M,e);_&&C.addRenderable(_)}var D=this.geometryinstances;if(D)for(var P in D)if(D.hasOwnProperty(P)){var H=D[P],B=H.geometry,j=w?w+"-"+B:B,F=m.shapes[j];F||(F=m.loadShape(j,B,e));if(n){var I=H.material;if(T&&t.skins){var q=t.skins[T];if(q){var R=q[I];R&&(I=R)}}var U=d[I];if(!U){g&&(U=g[I]);if(!U)return undefined;d[I]=U,U.name=I,U.reference.subscribeDestroyed(m.onMaterialDestroyed)}k=U.effect;if(!k){U.loadTextures(r);var z=U.effectName;delete U.effectName,k=i.get(z),k&&k.prepareMaterial(U)}var W=F.surfaces,X=W?W[H.surface]:F,V=GeometryInstance.create(F,X,U);C.addRenderable(V),H.disabled&&(V.disabled=!0)}else C.addRenderable(GeometryInstance.create(F,null,null))}this.camera&&o&&(C.camera=this.camera);var $=this.lightinstances;if($&&u)for(var J in $)if($.hasOwnProperty(J)){var K=$[J],Q=v[K.light];if(Q&&!Q.global){var G=LightInstance.create(Q);C.addLightInstance(G),K.disabled&&(G.disabled=!0)}}this.reference&&alert("Found unresolved node reference during scene loading");if(this.kinematic||x.kinematic)C.kinematic=!0;(this.disabled||x.disabled)&&l!==!1&&(C.disabled=!0);var Y=this.nodes;if(Y)for(var Z in Y)if(Y.hasOwnProperty(Z)&&!C.findChild(Z)){var et=S.call(Y[Z],Z,N,C,this.skin||T);et&&(!a||!E(C,et))&&C.addChild(et)}return f&&C.renderables&&1<C.renderables.length&&m._optimizeRenderables(C,n),C},x=t.nodes,T=e.parentNode,N={};for(var C in x)if(x.hasOwnProperty(C)){var k=x[C],A=C,O=b?b+"/"+C:C,M=m.findNode(O),_=S.call(k,A,b,M||T||N,k.skin||e.materialSkin);if(_){T&&!M&&T.addChild(_),y?_.local?_.setLocalTransform(h.m43Mul(_.getLocalTransform(),y)):_.setLocalTransform(y):_.local||_.setLocalTransform(h.m43BuildIdentity()),l&&_.enableHierarchy(!1);if(M){var D=M.local;D&&_.local&&(_.local=h.m43Mul(_.local,D),M.setLocalTransform(_.local),delete _.local);var P=M.children;if(P&&_.children)while(_.children.length){var H=_.children[0];M.findChild(H.name)||M.addChild(H),_.removeChild(H)}for(var B in _)_.hasOwnProperty(B)&&(M[B]=_[B]);_=null}else T||this.addRootNode(_)}}},e.prototype.loadAreas=function(e){var t=e.data,n=t.areas;if(!n)return;var r=n.length;if(r<=0)return;e.append||delete this.areas;var i=this.areas;i||(i=[],this.areas=i);var s=e.nodesNamePrefix,o=this.md,u=this.planeNormalize,a=i.length,f=Number.MAX_VALUE,l,c;for(var h=0;h<r;h+=1){var p=n[h],d=p.target;s&&(d=s+"/"+d);var v=this.findNode(d);if(!v){a-=1;continue}var m=v.getWorldTransform(),g=m[0],y=m[1],b=m[2],w=m[3],E=m[4],S=m[5],x=m[6],T=m[7],N=m[8],C=m[9],k=m[10],L=m[11],A=f,O=f,M=f,_=-f,D=-f,P=-f,H=p.portals,B=H.length,j=[],F,I,q,R,U,z,W;this.float32ArrayConstructor?(l=new this.float32ArrayConstructor(6+B*13),c=0,W=l.subarray(c,c+6),c+=6):W=new Array(6);for(var X=0;X<B;X+=1){var V=f,$=f,J=f,K=-f,Q=-f,G=-f,Y=0,Z=0,et=0;F=H[X],I=F.points,R=I.length,q=[];for(U=0;U<R;U+=1){z=I[U];var tt=z[0],nt=z[1],rt=z[2],it=g*tt+w*nt+x*rt+C,st=y*tt+E*nt+T*rt+k,ot=b*tt+S*nt+N*rt+L;it<V&&(V=it),st<$&&($=st),ot<J&&(J=ot),it>K&&(K=it),st>Q&&(Q=st),ot>G&&(G=ot),Y+=it,Z+=st,et+=ot,q.push(o.v3Build(it,st,ot))}V<A&&(A=V),$<O&&(O=$),J<M&&(M=J),K>_&&(_=K),Q>D&&(D=Q),G>P&&(P=G);var ut=o.v3Cross(o.v3Sub(q[1],q[0]),o.v3Sub(q[2],q[0])),at,ft,lt;this.float32ArrayConstructor?(at=l.subarray(c,c+6),c+=6,ft=l.subarray(c,c+3),c+=3,lt=l.subarray(c,c+4),c+=4):(at=new Array(6),ft=new Array(3),lt=new Array(4)),at[0]=V,at[1]=$,at[2]=J,at[3]=K,at[4]=Q,at[5]=G,ft[0]=Y/R,ft[1]=Z/R,ft[2]=et/R,lt=u(ut[0],ut[1],ut[2],o.v3Dot(ut,q[0]),lt);var ct={area:a+F.area,points:q,origin:ft,extents:at,plane:lt};j.push(ct)}W[0]=A,W[1]=O,W[2]=M,W[3]=_,W[4]=D,W[5]=P;var ht={target:v,portals:j,extents:W,externalNodes:null};i.push(ht)}var pt=t.bspnodes,dt=pt.length,vt=[];vt.length=dt,this.bspNodes=vt,this.float32ArrayConstructor&&(l=new this.float32ArrayConstructor(4*dt),c=0);for(var mt=0;mt<dt;mt+=1){var gt=pt[mt],yt=gt.plane,bt;this.float32ArrayConstructor?(bt=l.subarray(c,c+4),c+=4):bt=new Array(4),bt[0]=yt[0],bt[1]=yt[1],bt[2]=yt[2],bt[3]=-yt[3],vt[mt]={plane:bt,pos:gt.pos,neg:gt.neg}}},e.prototype.load=function(e){var t=this;e.append||(this.clearShapes(),this.semantics={});var n=function(){e.keepLights&&t.loadLights(e),t.loadNodes(e),e.physicsManager&&e.physicsManager.loadNodes(e,t),t.loadAreas(e),t.endLoading(e.onload)};e.graphicsDevice&&this.loadMaterials(e),t.loadSkeletons(e);var r=e.yieldFn;if(r){var i=function(){t.streamShapes(e,n)};r(i)}else n()},e.prototype.planeNormalize=function(t,n,r,i,s){var o=s;if(!o){var u=e.prototype.float32ArrayConstructor;o=u?new u(4):new Array(4)}var a=t*t+n*n+r*r;if(a>0){var f=1/Math.sqrt(a);o[0]=t*f,o[1]=n*f,o[2]=r*f,o[3]=i*f}else o[0]=0,o[1]=0,o[2]=0,o[3]=0;return o},e.prototype.isInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c<0?n:s)+h*(h<0?r:o)+p*(p<0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.isFullyInsidePlanesAABB=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=t.length,f=0;do{var l=t[f],c=l[0],h=l[1],p=l[2];if(c*(c>0?n:s)+h*(h>0?r:o)+p*(p>0?i:u)<l[3])return!1;f+=1}while(f<a);return!0},e.prototype.extractFrustumPlanes=function(e){var t=this.planeNormalize,n=e.viewProjectionMatrix,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=n[6],l=n[7],c=n[8],h=n[9],p=n[10],d=n[11],v=n[12],m=n[13],g=n[14],y=n[15],b=this.frustumPlanes;return b[0]=t(o+r,l+u,d+c,-(y+v),b[0]),b[1]=t(o-r,l-u,d-c,-(y-v),b[1]),b[2]=t(o-i,l-a,d-h,-(y-m),b[2]),b[3]=t(o+i,l+a,d+h,-(y+m),b[3]),this.areas?b.length>4&&(b.length=4):b[4]=t(o-s,l-f,d-p,-(y-g),b[4]),this.nearPlane=t(o+s,l+f,d+p,-(y+g),this.nearPlane),b},e.prototype.calculateHullScreenExtents=function(e,t){var n=function(t,n,r,i,s){var o=t[r],u=n[r],a=t[3],f=n[3],l=0,c=!0;if(i)if(o>a){if(!(u<=f))return;u<f&&(l=(a-o)/(u-o-(f-a)))}else u>f&&(o<a&&(l=(a-o)/(u-o-(f-a))),c=!1);else if(o<-a){if(!(u>=-f))return;u>-f&&(l=(-a-o)/(u-o+(f-a)))}else u<-f&&(o>-a&&(l=(-a-o)/(u-o+(f-a))),c=!1);if(l>0){var h=t[0],p=t[1],d=t[2],v=n[0],m=n[1],g=n[2];s.push([h+l*(v-h),p+l*(m-p),d+l*(g-d),a+l*(f-a)])}c&&s.push(n)},r=1,i=-1,s=1,o=-1,u=e.length;for(var a=0;a<u;a+=1){var f=e[a],l,c,h,p,d;for(var v=0;v<2;v+=1)for(var m=0;m<3;m+=1){l=f.length;if(!l)break;d=[];for(c=0;c<l;c+=1)c<1?h=f[l-1]:h=f[c-1],p=f[c],n(h,p,m,v,d);f=d}l=f.length;for(c=0;c<l;c+=1){h=f[c];var g=h[0],y=h[1],b=h[3];if(b===0)g=g>=0?1:-1,y=y>=0?1:-1;else{var w=1/b;g*=w,y*=w}r>g&&(r=g),i<g&&(i=g),s>y&&(s=y),o<y&&(o=y)}}return r>=i||s>=o?undefined:(r<-1&&(r=-1),i>1&&(i=1),s<-1&&(s=-1),o>1&&(o=1),t||(t=this.float32ArrayConstructor?new this.float32ArrayConstructor(4):new Array(4)),t[0]=r,t[1]=s,t[2]=i,t[3]=o,t)},e.prototype.calculateLightsScreenExtents=function(e){var t=this.visibleLights,n=t.length;if(n>0){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=e.viewProjectionMatrix,T=this.calculateHullScreenExtents,N=this.md,C=N.m44Transform,k=N.m43MulM44,L=N.v4Build,A=L.call(N,-1,-1,1,1),O=L.call(N,1,-1,1,1),M=L.call(N,-1,1,1,1),_=L.call(N,1,1,1,1),D=0;do{w=t[D],E=w.light;if(E){if(E.global)continue;r=w.node.world,E.spot?(i=N.m33MulM43(E.frustum,r,i),S=k.call(N,i,x,S),l=C.call(N,S,A,l),c=C.call(N,S,O,c),h=C.call(N,S,M,h),p=C.call(N,S,_,p),y=L.call(N,r[9],r[10],r[11],1,y),y=C.call(N,x,y,y),b=[[y,l,c],[y,c,p],[y,h,l],[y,p,h],[h,p,c,l]]):(s=E.halfExtents,E.fog||(o=E.center,o&&(r=i=N.m43Offset(r,o,i))),u=s[0],a=s[1],f=s[2],S=k.call(N,r,x,S),l=C.call(N,S,L.call(N,-u,-a,-f,1,l),l),c=C.call(N,S,L.call(N,+u,-a,-f,1,c),c),h=C.call(N,S,L.call(N,+u,-a,+f,1,h),h),p=C.call(N,S,L.call(N,-u,-a,+f,1,p),p),d=C.call(N,S,L.call(N,-u,+a,-f,1,d),d),v=C.call(N,S,L.call(N,+u,+a,-f,1,v),v),m=C.call(N,S,L.call(N,+u,+a,+f,1,m),m),g=C.call(N,S,L.call(N,-u,+a,+f,1,g),g),b=[[p,h,c,l],[d,v,m,g],[l,c,v,d],[g,m,h,p],[d,g,p,l],[c,h,m,v]]),w.screenExtents=T(b,w.screenExtents)}D+=1}while(D<n)}},e.prototype.destroy=function(){this.clear(),this.vertexBufferManager&&(this.vertexBufferManager.destroy(),delete this.vertexBufferManager),this.indexBufferManager&&(this.indexBufferManager.destroy(),delete this.indexBufferManager)},e.prototype.getQueryCounter=function(){var e=this.queryCounter;return this.queryCounter=e+1,e},e.create=function(t,n,r){return new e(t,n,r)},e.version=1,e}();(function(){var e,t;typeof Uint16Array!="undefined"&&(e=new Uint16Array(4),t=Object.prototype.toString.call(e),t==="[object Uint16Array]"&&(A.prototype.uint16ArrayConstructor=Uint16Array)),typeof Uint32Array!="undefined"&&(e=new Uint32Array(4),t=Object.prototype.toString.call(e),t==="[object Uint32Array]"&&(A.prototype.uint32ArrayConstructor=Uint32Array)),typeof Float32Array!="undefined"&&(e=new Float32Array(4),t=Object.prototype.toString.call(e),t==="[object Float32Array]"&&(A.prototype.float32ArrayConstructor=Float32Array))})(),A.prototype.getMaterialName=function(t){function i(e,t){for(var n in r)r.hasOwnProperty(n)&&e===r[n]&&t.push(n)}var n=[],r=this.materials,s=t.sharedMaterial;s&&i(s,n);var o=t.renderables;if(o){var u=o.length;for(var a=0;a<u;a+=1){var f=o[a];s=f.sharedMaterial,i(s,n)}}var l=t.lightInstances;if(l){var c=l.length;for(var h=0;h<c;h+=1){var p=l[h];s=p.material,i(s,n)}}return n.length?n.length===1?n[0]:n:undefined},A.prototype.findLightName=function(t){var n=this.lights;for(var r in n)if(n.hasOwnProperty(r)&&t===n[r])return r;return undefined},A.prototype.writeBox=function(t,n,r,i,s){var o=n[0],u=n[1],a=n[2],f=n[3],l=n[4],c=n[5];t(o,u,a,r,i,s),t(o,u,c,r,i,s),t(o,u,a,r,i,s),t(o,l,a,r,i,s),t(o,u,a,r,i,s),t(f,u,a,r,i,s),t(f,l,c,r,i,s),t(f,l,a,r,i,s),t(f,l,c,r,i,s),t(f,u,c,r,i,s),t(f,l,c,r,i,s),t(o,l,c,r,i,s),t(o,l,c,r,i,s),t(o,l,a,r,i,s),t(o,l,c,r,i,s),t(o,u,c,r,i,s),t(f,l,a,r,i,s),t(o,l,a,r,i,s),t(f,l,a,r,i,s),t(f,u,a,r,i,s),t(f,u,c,r,i,s),t(o,u,c,r,i,s),t(f,u,c,r,i,s),t(f,u,a,r,i,s)},A.prototype.writeRotatedBox=function(t,n,r,i,s,o){var u=n[0],a=n[1],f=n[2],l=n[3],c=n[4],h=n[5],p=n[6],d=n[7],v=n[8],m=n[9],g=n[10],y=n[11],b=r[0],w=r[1],E=r[2],S=u*b,x=a*b,T=f*b,N=l*w,C=c*w,k=h*w,L=p*E,A=d*E,O=v*E,M=m-S-N-L,_=g-x-C-A,D=y-T-k-O,P=m+S-N-L,H=g+x-C-A,B=y+T-k-O,j=m+S-N+L,F=g+x-C+A,I=y+T-k+O,q=m-S-N+L,R=g-x-C+A,U=y-T-k+O,z=m-S+N-L,W=g-x+C-A,X=y-T+k-O,V=m+S+N-L,$=g+x+C-A,J=y+T+k-O,K=m+S+N+L,Q=g+x+C+A,G=y+T+k+O,Y=m-S+N+L,Z=g-x+C+A,et=y-T+k+O;t(M,_,D,i,s,o),t(P,H,B,i,s,o),t(P,H,B,i,s,o),t(j,F,I,i,s,o),t(j,F,I,i,s,o),t(q,R,U,i,s,o),t(q,R,U,i,s,o),t(M,_,D,i,s,o),t(M,_,D,i,s,o),t(z,W,X,i,s,o),t(P,H,B,i,s,o),t(V,$,J,i,s,o),t(j,F,I,i,s,o),t(K,Q,G,i,s,o),t(q,R,U,i,s,o),t(Y,Z,et,i,s,o),t(z,W,X,i,s,o),t(V,$,J,i,s,o),t(V,$,J,i,s,o),t(K,Q,G,i,s,o),t(K,Q,G,i,s,o),t(Y,Z,et,i,s,o),t(Y,Z,et,i,s,o),t(z,W,X,i,s,o)},A.prototype.drawLights=function(t,n,r){var i=this.visibleNodes,s=i.length;if(s>0){var o,u,a,f,l,c,h=0,p=0,d=0,v=0;do{o=i[v],u=o.lightInstances;if(u){a=u.length;for(c=0;c<a;c+=1){f=u[c],l=f.light;if(l){if(l.global){v+=1;continue}l.spot?h+=1:l.fog?d+=1:p+=1}}}v+=1}while(v<s);if(0===p&&0===h&&0===d)return;var m=n.load("shaders/debug.cgfx"),g=m.getTechnique("debug_lines");if(!g)return;t.setTechnique(g);var y=this.debugLinesTechniqueParameters;y?y.worldViewProjection=r.viewProjectionMatrix:(y=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=y),t.setTechniqueParameters(y);var b=this.getDebugSemanticsPosCol(),w=t.VERTEXFORMAT_FLOAT3,E=t.beginDraw(t.PRIMITIVE_LINES,24*p+16*h+24*d,[w,w],b);if(E){var S=this.md,x,T,N,C,k,L,A;v=0;do{o=i[v],u=o.lightInstances;if(u){a=u.length;for(c=0;c<a;c+=1){f=u[c],l=f.light;if(l){if(l.global){v+=1;continue}x=o.world,T=l.color,N=T[0],C=T[1],k=T[2];if(l.spot){var O=S.m33MulM43(l.frustum,x),M=S.m43TransformPoint(O,S.v3Build(-1,-1,1)),_=S.m43TransformPoint(O,S.v3Build(1,-1,1)),D=S.m43TransformPoint(O,S.v3Build(-1,1,1)),P=S.m43TransformPoint(O,S.v3Build(1,1,1)),H=S.m43Pos(x);E(H,N,C,k),E(M,N,C,k),E(H,N,C,k),E(_,N,C,k),E(H,N,C,k),E(D,N,C,k),E(H,N,C,k),E(P,N,C,k),E(M,N,C,k),E(_,N,C,k),E(_,N,C,k),E(P,N,C,k),E(P,N,C,k),E(D,N,C,k),E(D,N,C,k),E(M,N,C,k)}else l.fog?(L=l.halfExtents,this.writeRotatedBox(E,x,L,N,C,k)):(L=l.halfExtents,A=l.center,A&&(x=S.m43Offset(x,A)),this.writeRotatedBox(E,x,L,N,C,k))}}}v+=1}while(v<s);t.endDraw(E)}}},A.prototype.drawLightsExtents=function(t,n,r){var i=this.visibleLights,s=i.length;if(s>0){var o,u,a=0,f=0;do{o=i[f],u=o.light;if(u){if(u.global){f+=1;continue}a+=1}f+=1}while(f<s);if(0===a)return;var l=n.load("shaders/debug.cgfx"),c=l.getTechnique("debug_lines");if(!c)return;t.setTechnique(c);var h=this.debugLinesTechniqueParameters;h?h.worldViewProjection=r.viewProjectionMatrix:(h=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=h),t.setTechniqueParameters(h);var p=this.getDebugSemanticsPosCol(),d=t.beginDraw(t.PRIMITIVE_LINES,24*a,[t.VERTEXFORMAT_FLOAT3,t.VERTEXFORMAT_FLOAT3],p);if(d){var v=this.writeBox,m,g,y,b,w;f=0;do{o=i[f],u=o.light;if(u){if(u.global){f+=1;continue}m=o.getWorldExtents(),m&&(g=u.color,y=g[0],b=g[1],w=g[2],v(d,m,y,b,w))}f+=1}while(f<s);t.endDraw(d)}}},A.prototype.drawLightsScreenExtents=function(t,n){var r=this.visibleLights,i=r.length;if(i>0){var s,o,u=0,a=0;do{s=r[a],o=s.light;if(o){if(o.global){a+=1;continue}s.screenExtents&&(u+=1)}a+=1}while(a<i);if(0===u)return;var f=n.load("shaders/generic2D.cgfx"),l=f.getTechnique("vertexColor2D");if(!l)return;t.setTechnique(l),l.clipSpace=this.md.v4Build(1,1,0,0);var c=this.getDebugSemanticsPosCol(),h=t.beginDraw(t.PRIMITIVE_LINES,8*u,[t.VERTEXFORMAT_FLOAT2,t.VERTEXFORMAT_FLOAT3],c);if(h){var p,d,v,m,g,y,b,w,E;a=0;do{s=r[a],o=s.light;if(o){if(o.global){a+=1;continue}p=s.screenExtents,p&&(d=p[0],m=p[1],v=p[2],g=p[3],y=o.color,b=y[0],w=y[1],E=y[2],h(d,m,b,w,E),h(d,g,b,w,E),h(d,g,b,w,E),h(v,g,b,w,E),h(v,g,b,w,E),h(v,m,b,w,E),h(v,m,b,w,E),h(d,m,b,w,E))}a+=1}while(a<i);t.endDraw(h)}}},A.prototype.drawAreas=function(t,n,r){var i=this.areas;if(i){var s=n.load("shaders/debug.cgfx"),o=s.getTechnique("debug_lines");if(!o)return;var u=this.isInsidePlanesAABB,a=this.frustumPlanes,f=[],l=0,c,h,p=this.cameraAreaIndex;if(p>=0){f[l]=p,l+=1;var d=this.visiblePortals,v=d.length;for(h=0;h<v;h+=1)f[l]=d[h].area,l+=1}else{var m=i.length;for(h=0;h<m;h+=1)c=i[h],u(c.extents,a)&&(f[l]=h,l+=1)}if(!l)return;t.setTechnique(o);var g=this.debugLinesTechniqueParameters;g?g.worldViewProjection=r.viewProjectionMatrix:(g=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=g),t.setTechniqueParameters(g);var y=this.getDebugSemanticsPosCol(),b=t.VERTEXFORMAT_FLOAT3,w=t.beginDraw(t.PRIMITIVE_LINES,24*l,[b,b],y);if(w){var E=this.writeBox,S,x,T;for(h=0;h<l;h+=1){p=f[h],c=i[p];var N=p%3;N===0?(S=1,x=0,T=0):N===1?(S=0,x=1,T=0):(S=0,x=0,T=1),E(w,c.extents,S,x,T)}t.endDraw(w)}}},A.prototype.drawPortals=function(t,n,r){var i=this.areas;if(i){var s,o,u,a,f,l,c,h,p,d,v,m,g=[],y=i.length;s=0;for(u=0;u<y;u+=1){o=i[u],a=o.portals,f=a.length;for(l=0;l<f;l+=1)c=a[l],g.push(c),s+=2*c.points.length}if(!s)return;var b=n.load("shaders/debug.cgfx"),w=b.getTechnique("debug_lines_constant");if(!w)return;t.setTechnique(w);var E=this.md;w.worldViewProjection=r.viewProjectionMatrix,w.constantColor=E.v4Build(1,1,1,1);var S=this.getDebugSemanticsPos(),x=t.beginDraw(t.PRIMITIVE_LINES,s,[t.VERTEXFORMAT_FLOAT3],S);if(x){var T=g.length;for(u=0;u<T;u+=1){c=g[u],h=c.points,p=h.length;for(d=0;d<p;d+=1)v=d>0?h[d-1]:h[p-1],m=h[d],x(v[0],v[1],v[2]),x(m[0],m[1],m[2])}t.endDraw(x)}var N=this.visiblePortals,C=N.length;s=0;for(u=0;u<C;u+=1)c=N[u].portal,s+=2*c.points.length;if(!s)return;w.constantColor=E.v4Build(1,1,0,1),x=t.beginDraw(t.PRIMITIVE_LINES,s,[t.VERTEXFORMAT_FLOAT3],S);if(x){for(u=0;u<C;u+=1){c=N[u].portal,h=c.points,p=h.length;for(d=0;d<p;d+=1)v=d>0?h[d-1]:h[p-1],m=h[d],x(v[0],v[1],v[2]),x(m[0],m[1],m[2])}t.endDraw(x)}}},A.prototype.drawTransforms=function(t,n,r,i){var s=this.visibleNodes,o=s.length;if(o){var u,a=6*(o+1);if(!a)return;var f=n.load("shaders/debug.cgfx"),l=f.getTechnique("debug_lines");if(!l)return;t.setTechnique(l);var c=this.debugLinesTechniqueParameters;c?c.worldViewProjection=r.viewProjectionMatrix:(c=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=c),t.setTechniqueParameters(c);var h=this.getDebugSemanticsPosCol(),p=t.beginDraw(t.PRIMITIVE_LINES,a,[t.VERTEXFORMAT_FLOAT3,t.VERTEXFORMAT_FLOAT3],h);if(p){for(u=0;u<o;u+=1){var d=s[u],v=d.world,m=v[9],g=v[10],y=v[11];p(m,g,y,1,0,0),p(m+v[0]*i,g+v[1]*i,y+v[2]*i,1,0,0),p(m,g,y,0,1,0),p(m+v[3]*i,g+v[4]*i,y+v[5]*i,0,1,0),p(m,g,y,0,0,1),p(m+v[6]*i,g+v[7]*i,y+v[8]*i,0,0,1)}p(0,0,0,0,0,0),p(i,0,0,1,0,0),p(0,0,0,0,0,0),p(0,i,0,0,1,0),p(0,0,0,0,0,0),p(0,0,i,0,0,1),t.endDraw(p),p=null}}},A.prototype.drawAnimationHierarchy=function(t,n,r,i,s,o,u,a,f){var l=s,c=o,h=c.bounds,p=2*l,d=0,v=0,m=0,g=1,y=0,b=0;a&&(d=a[0],v=a[1],m=a[2]),f&&(g=f[0],y=f[1],b=f[2]),h&&(p+=24);if(!p)return;var w=n.load("shaders/debug.cgfx"),E=w.getTechnique("debug_lines");if(!E)return;t.setTechnique(E);var S=this.debugLinesTechniqueParameters;S?S.worldViewProjection=r.viewProjectionMatrix:(S=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=S),t.setTechniqueParameters(S);var x=this.getDebugSemanticsPosCol(),T=t.beginDraw(t.PRIMITIVE_LINES,p,[t.VERTEXFORMAT_FLOAT3,t.VERTEXFORMAT_FLOAT3],x);if(T){var N=this.md,C=N.m43TransformPoint,k=N.m43FromRTS,L=N.m43FromQuatPos,A=N.quatPosBuild,O=N.m43Mul,M=N.m43Pos,_=i.parents;c.update();var D=c.output,P=c.outputChannels,H=P.scale,B=[],j,F;for(var I=0;I<l;I+=1){var q=_[I],R=D[I];H?j=k.call(N,R.rotation,R.translation,R.scale,B[I]):(F=A.call(N,R.rotation,R.translation,F),j=L.call(N,F,B[I])),q!==-1&&(j=O.call(N,j,B[q],B[I])),B[I]=j;if(q===-1)continue;var U=M.call(N,B[I]),z=M.call(N,B[q]);u&&(U=C.call(N,u,U),z=C.call(N,u,z)),T(U,d,v,m),T(z,d,v,m)}if(h){var W=h.center,X=h.halfExtent;u&&(W=N.v3Add(N.m43Pos(u),W));var V=N.v3Sub(W,X),$=N.v3Add(W,X),J=[V[0],V[1],V[2],$[0],$[1],$[2]];this.writeBox(T,J,g,y,b)}t.endDraw(T)}},A.prototype.drawSceneNodeHierarchy=function(t,n,r){var i=function(t){var n=1,r=t.children;if(r){var s=r.length;for(var o=0;o<s;o+=1)n+=i(r[o])}return n},s=function(t,n,r){var i=t.children;if(i){var o=i.length;for(var u=0;u<o;u+=1){var a=i[u],f=r.m43Pos(t.world),l=r.m43Pos(a.world);n(f,0,0,0),n(l,0,0,0),s(a,n,r)}}};if(!this.rootNodes)return;var o=0,u=this.rootNodes.length;for(var a=0;a<u;a+=1)o+=i(this.rootNodes[a]);var f=2*o;if(!f)return;var l=n.load("shaders/debug.cgfx"),c=l.getTechnique("debug_lines");if(!c)return;t.setTechnique(c);var h=this.debugLinesTechniqueParameters;h?h.worldViewProjection=r.viewProjectionMatrix:(h=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=h),t.setTechniqueParameters(h);var p=this.getDebugSemanticsPosCol(),d=t.beginDraw(t.PRIMITIVE_LINES,f,[t.VERTEXFORMAT_FLOAT3,t.VERTEXFORMAT_FLOAT3],p);if(d){var v=this.md;for(a=0;a<u;a+=1){var m=this.rootNodes[a];s(m,d,v)}t.endDraw(d)}},A.prototype.createGeoSphere=function(t,n){function u(e,n,i){var s=Math.sqrt(e*e+n*n+i*i),o=t/s;return r[r.length]=e*o,r[r.length]=n*o,r[r.length]=i*o,r.length/3-1}function a(e,t){var n=e<t,i=n?e:t,o=n?t:e,a=i.toString()+o.toString()+(i+o);if(s[a])return s[a];e*=3,t*=3;var f=u((r[e]+r[t])*.5,(r[e+1]+r[t+1])*.5,(r[e+2]+r[t+2])*.5);return s[a]=f,f}var r=[],i=[],s={},o=(1+Math.sqrt(5))/2;n=n?n:3,u(-1,o,0),u(1,o,0),u(-1,-o,0),u(1,-o,0),u(0,-1,o),u(0,1,o),u(0,-1,-o),u(0,1,-o),u(o,0,-1),u(o,0,1),u(-o,0,-1),u(-o,0,1),i=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];for(var f=0;f<n;f+=1){var l=[];for(var c=0;c<i.length;c+=3){var h=i[c],p=i[c+1],d=i[c+2],v=a(h,p),m=a(p,d),g=a(d,h);l[l.length]=h,l[l.length]=v,l[l.length]=g,l[l.length]=p,l[l.length]=m,l[l.length]=v,l[l.length]=d,l[l.length]=g,l[l.length]=m,l[l.length]=v,l[l.length]=m,l[l.length]=g}i=l}return{indices:i,vertices:r,minExtent:[-t,-t,-t],maxExtent:[t,t,t]}},A.prototype.createCylinder=function(t,n,r,i,s){var o=[],u=[],a=r/2;s=s?s:10;var f=1/s,l=Math.PI*2*f,c=l*.5,h=-a,p=-a,d=-a;for(var v=0;v<=s;v+=1){var m=l*v,g=Math.cos(m),y=Math.sin(m),b=Math.cos(m+c),w=Math.sin(m+c);h=t*g,p=-a,d=t*y,o[o.length]=h,o[o.length]=p,o[o.length]=d,h=n*g,p=a,d=n*y,o[o.length]=h,o[o.length]=p,o[o.length]=d,h=t*b,p=-a,d=t*w,o[o.length]=h,o[o.length]=p,o[o.length]=d,h=n*b,p=a,d=n*w,o[o.length]=h,o[o.length]=p,o[o.length]=d}var E=s*4;for(v=0;v!==E;v+=2)u[u.length]=v+2,u[u.length]=v,u[u.length]=v+1,u[u.length]=v+2,u[u.length]=v+1,u[u.length]=v+3;u[u.length]=0,u[u.length]=v,u[u.length]=v+1,u[u.length]=0,u[u.length]=v+1,u[u.length]=1;if(i){var S=0;if(t!==0){h=0,p=-a,d=0,o[o.length]=h,o[o.length]=p,o[o.length]=d,S=o.length/3-1;for(v=0;v!==E;v+=2)u[u.length]=S,u[u.length]=v,u[u.length]=v+2;u[u.length]=S,u[u.length]=v,u[u.length]=0}if(n!==0){p=a,d=0,o[o.length]=h,o[o.length]=p,o[o.length]=d,S=o.length/3-1;for(v=0;v!==E;v+=2)u[u.length]=v+1,u[u.length]=S,u[u.length]=v+3;u[u.length]=v+1,u[u.length]=S,u[u.length]=1}}var x=Math.max(t,n);return{indices:u,vertices:o,minExtent:[-x,-a,-x],maxExtent:[x,a,x]}},A.prototype.createRoundedPrimitive=function(t,n,r,i,s){function g(e,o,u){l=c.length/3;var a=[(e?1:-1)*.5*t,(o?1:-1)*.5*n,(u?1:-1)*.5*r],f=p/2/s,d=o?0:p/2,v;e&&u&&(v=0),!e&&u&&(v=1.5*p),e&&!u&&(v=p/2),!e&&!u&&(v=p);for(var m=0;m<=s;m+=1){var g=m*f+d,y=i*Math.sin(g),b=i*Math.cos(g);for(var w=0;w<=s;w+=1){var E=w*f+v,S=y*Math.sin(E),x=y*Math.cos(E);c[c.length]=S+a[0],c[c.length]=b+a[1],c[c.length]=x+a[2],m!==s&&w!==s&&(h[h.length]=l+s+2,h[h.length]=l,h[h.length]=l+s+1,h[h.length]=l+s+2,h[h.length]=l+1,h[h.length]=l),l+=1}}}function y(e,p,g){var y=o.v3BuildXAxis(y),b=o.v3BuildYAxis(b),w=o.v3BuildZAxis(w),E,S=m.call(o,y,.5*e*t),x=m.call(o,b,.5*p*n),T=m.call(o,w,.5*g*r),N=v.call(o,S,x,T);S=m.call(o,y,1-Math.abs(e)),x=m.call(o,b,1-Math.abs(p)),T=m.call(o,w,1-Math.abs(g));var C=v.call(o,S,x,T),k=o.v3Build(C[1],C[2],C[0]),L=o.v3Build(C[2],C[0],C[1]);l=c.length/3,o.v3Dot(k,N)<0&&(k=o.v3Neg(k,k)),o.v3Dot(L,N)<0&&(L=o.v3Neg(L,L));var A=o.v3Cross(k,C);o.v3Dot(A,L)<0&&(C=o.v3Neg(C,C));var O=(1-Math.abs(e))*t+(1-Math.abs(p))*n+(1-Math.abs(g))*r,M=o.v3Sub(N,o.v3ScalarMul(C,.5*O)),_=1,D=Math.PI/2/s,P=O/_;e===0?_=u:p===0?_=a:g===0&&(_=f);for(var H=0;H<=_;H+=1)for(var B=0;B<=s;B+=1){var j=i*Math.cos(B*D),F=i*Math.sin(B*D);m.call(o,k,j,S),m.call(o,C,H*P,x),m.call(o,L,F,T),E=d.call(o,S,x,T,M,E),c[c.length]=E[0],c[c.length]=E[1],c[c.length]=E[2],H!==_&&B!==s&&(h[h.length]=l+s+2,h[h.length]=l,h[h.length]=l+s+1,h[h.length]=l+s+2,h[h.length]=l+1,h[h.length]=l),l+=1}}function b(e,t,n,r,i,s){l=c.length/3;var u=o.v3Cross(i,o.v3BuildXAxis());o.v3LengthSq(u)<1e-7&&o.v3Cross(i,o.v3BuildYAxis(),u),o.v3Normalize(u,u);var a=o.v3Cross(i,u),f=m.call(o,u,n/e),p=m.call(o,a,r/t),v=o.v3Sub(m.call(o,u,-0.5*n),m.call(o,a,.5*r));for(var g=0;g<=e;g+=1)for(var y=0;y<=t;y+=1){var b=d.call(o,v,m.call(o,f,g),m.call(o,p,y),s,b);c[c.length]=b[0],c[c.length]=b[1],c[c.length]=b[2]}var w=!1,E=o.v3Cross(f,p);o.v3Dot(E,i)>0&&(w=!0);for(var S=0;S<e;S+=1){for(var x=0;x<t;x+=1)w?(h[h.length]=l,h[h.length]=l+t+1,h[h.length]=l+1,h[h.length]=l+1,h[h.length]=l+t+1,h[h.length]=l+t+1+1):(h[h.length]=l,h[h.length]=l+1,h[h.length]=l+t+1,h[h.length]=l+1,h[h.length]=l+t+1+1,h[h.length]=l+t+1),l+=1;l+=1}}var o=this.md,u=1,a=1,f=1;t=t===0?1e-4:t,n=n===0?1e-4:n,r=r===0?1e-4:r,s=s?s:8;var l=0,c=[],h=[],p=Math.PI,d=o.v3Add4,v=o.v3Add3,m=o.v3ScalarMul,w=.5*t+i,E=.5*n+i,S=.5*r+i,x=o.v3Neg(o.v3BuildZAxis(),x),T=m.call(o,x,S);return b(a,u,n,t,x,T),x=o.v3BuildZAxis(x),m.call(o,x,S,T),b(a,u,n,t,x,T),o.v3Neg(o.v3BuildYAxis(x),x),m.call(o,x,E,T),b(f,u,r,t,x,T),o.v3BuildYAxis(x),m.call(o,x,E,T),b(f,u,r,t,x,T),o.v3Neg(o.v3BuildXAxis(x),x),m.call(o,x,w,T),b(f,a,r,n,x,T),o.v3BuildXAxis(x),m.call(o,x,w,T),b(f,a,r,n,x,T),g(!0,!0,!0),g(!0,!0,!1),g(!0,!1,!0),g(!0,!1,!1),g(!1,!0,!0),g(!1,!0,!1),g(!1,!1,!0),g(!1,!1,!1),y(-1,-1,0),y(-1,1,0),y(1,-1,0),y(1,1,0),y(-1,0,-1),y(-1,0,1),y(1,0,-1),y(1,0,1),y(0,-1,-1),y(0,-1,1),y(0,1,-1),y(0,1,1),{indices:h,vertices:c,minExtent:[-w,-E,-S],maxExtent:[w,E,S]}},A.prototype.createBox=function(t){var n=t[0],r=t[1],i=t[2],s=[-n,-r,i,n,-r,i,n,r,i,-n,r,i,-n,r,i,n,r,i,n,r,-i,-n,r,-i,-n,r,-i,n,r,-i,n,-r,-i,-n,-r,-i,-n,-r,-i,n,-r,-i,n,-r,i,-n,-r,i,n,-r,i,n,-r,-i,n,r,-i,n,r,i,-n,-r,-i,-n,-r,i,-n,r,i,-n,r,-i],o=[2,0,1,3,0,2,6,4,5,7,4,6,10,8,9,11,8,10,14,12,13,15,12,14,18,16,17,19,16,18,22,20,21,23,20,22];return{indices:o,vertices:s,minExtent:[-n,-r,-i],maxExtent:[n,r,i]}},A.prototype.createConvexHull=function(t,n,r){function d(e,t){var n=o.v3Add4,r=o.v3ScalarMul;u=i.length/3;var a=o.v3Cross(t,o.v3BuildXAxis());o.v3LengthSq(a)<1e-7&&o.v3Cross(t,o.v3BuildYAxis(),a),o.v3Normalize(a,a);var f=o.v3Cross(t,a),l=o.v3ScalarMul(a,p),c=o.v3ScalarMul(f,p),h=o.v3Sub(o.v3ScalarMul(a,-0.5*p),o.v3ScalarMul(f,.5*p));for(var d=0;d<2;d+=1)for(var v=0;v<2;v+=1){var m=n.call(o,h,r.call(o,l,d),r.call(o,c,v),e,m);i[i.length]=m[0],i[i.length]=m[1],i[i.length]=m[2]}var g=!1,y=o.v3Cross(l,c);o.v3Dot(y,t)>0&&(g=!0),g?(s[s.length]=u,s[s.length]=u+2,s[s.length]=u+1,s[s.length]=u+1,s[s.length]=u+2,s[s.length]=u+3):(s[s.length]=u,s[s.length]=u+1,s[s.length]=u+2,s[s.length]=u+1,s[s.length]=u+3,s[s.length]=u+2)}function v(e,r){var i=o.v3Add,s=o.v3Add3,u=t.rayTest,h=o.v3Sub,p=o.m43InverseOrthonormal,v=o.m43TransformPoint,m=o.m43TransformVector,g=[];g[0]=o.v3BuildXAxis(),g[1]=o.v3BuildYAxis(),g[2]=o.v3BuildZAxis();var y=h.call(o,o.v3Mul(f,g[(e+1)%3]),o.v3Mul(l,g[(e+1)%3])),b=h.call(o,o.v3Mul(f,g[(e+2)%3]),o.v3Mul(l,g[(e+2)%3])),w=h.call(o,o.v3Mul(f,g[e]),o.v3Mul(l,g[e])),E=i.call(o,o.v3Mul(f,g[e]),o.v3Mul(l,g[e]));if(r){var S=w;w=E,E=S}var x=o.v3ScalarMul(o.v3ScalarMul(o.v3Mul(l,g[(e+1)%3]),2),1/c),T=o.v3ScalarMul(o.v3ScalarMul(o.v3Mul(l,g[(e+2)%3]),2),1/c);for(var N=0;N<c;N+=1)for(var C=0;C<c;C+=1){var k=i.call(o,y,o.v3ScalarMul(x,N)),L=i.call(o,b,o.v3ScalarMul(T,C)),A=s.call(o,k,L,E,A),O=s.call(o,k,L,w,O),M=u.call(t,{from:A,to:O});if(M&&(M.body===n||M.collisionObject===n)){var _=M.hitPoint,D=M.hitNormal,P=p.call(o,a);v.call(o,P,_,_),m.call(o,P,D,D),d(_,D)}}}if(TurbulenzEngine.canvas)return n.shape._private.triangleArray;var i=[],s=[],o=this.md,u=0,a=n.transform,f=o.m43Pos(a),l=n.shape.halfExtents,c=Math.ceil(Math.sqrt(r)),h=l[0];h=l[1]>h?l[1]:h,h=l[1]>h?l[2]:h;var p=h/r*(r/5);return v(0,!1),v(0,!0),v(1,!1),v(1,!0),v(2,!1),v(2,!0),{indices:s,vertices:i}},A.prototype.drawPhysicsNodes=function(t,n,r,i){var s=n.load("shaders/debug.cgfx"),o=s.getTechnique("debug_lines");if(!o)return;var u=i.physicsNodes,a=this.frameIndex-1,f=this.isInsidePlanesAABB,l=this.frustumPlanes,c,h,p,d=this.float32ArrayConstructor?new 
this.float32ArrayConstructor(6):new Array(6),v=u.length,m=[];for(c=0;c<v;c+=1)h=u[c],p=h.target,p.frameVisible>=a?m[m.length]=h:(h.body.calculateExtents(d),f(d,l)&&(m[m.length]=h));v=m.length;if(!v)return;t.setTechnique(o);var g=this.debugLinesTechniqueParameters;g?g.worldViewProjection=r.viewProjectionMatrix:(g=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix}),this.debugLinesTechniqueParameters=g),t.setTechniqueParameters(g);var y=this.getDebugSemanticsPosCol(),b=t.VERTEXFORMAT_FLOAT3,w=t.beginDraw(t.PRIMITIVE_LINES,24*v,[b,b],y);if(w){var E=i.mathsDevice.m43BuildIdentity();for(c=0;c<v;c+=1){h=m[c],p=h.target;var S=p.disabled?.2:1,x,T,N;h.kinematic?(x=0,T=0,N=S):h.dynamic?(x=0,T=S,N=0):(x=S,T=0,N=0);var C=h.body;C.calculateTransform(E),this.writeRotatedBox(w,E,C.shape.halfExtents,x,T,N)}t.endDraw(w)}},A.prototype.drawPhysicsGeometry=function(t,n,r,i){var s=n.load("shaders/debug.cgfx"),o=s.getTechnique("physics_debug");if(!o)return;var u=this.md,a=t.VERTEXFORMAT_FLOAT3,f=t.VERTEXFORMAT_FLOAT4,l=[f,a,a],c=10,h=i.physicsNodes,p=this.frameIndex-1,d=this.isInsidePlanesAABB,v=this.frustumPlanes,m,g,y,b,w,E,S,x,T,N=this.float32ArrayConstructor?new this.float32ArrayConstructor(6):new Array(6),C=h.length,k=[],L,A=i.physicsDevice,O=i.dynamicsWorld,M;for(m=0;m<C;m+=1){g=h[m],w=!1,y=g.target,y.frameVisible>=p?w=!0:(g.body.calculateExtents(N),d(N,v)&&(w=!0));if(w){k[k.length]=g,b=g.triangleArray;if(!b){M=g.body.shape;var _=M.type,D=M.halfExtents;if(_==="SPHERE")L=this.createGeoSphere(M.radius);else if(_==="CYLINDER")L=this.createCylinder(D[0],D[2],D[1]*2,!0);else if(_==="CONE")L=this.createCylinder(D[0],0,D[1]*2,!0);else if(_==="CAPSULE"){var P=(D[1]-D[0])*2;L=this.createRoundedPrimitive(0,P,0,D[0])}else _==="BOX"?L=this.createBox(D):_==="CONVEX_HULL"?L=this.createConvexHull(O,g.body,50):_==="TRIANGLE_MESH"&&(L=M.triangleArray);if(!(L&&L.vertices.length>0)){k.pop();continue}L.triangles?b=L:b=A.createTriangleArray(L),g.triangleArray=b}E=g.positions;if(!E&&b){var H=b.vertices;if(!TurbulenzEngine.canvas){var B=H.length;E=[],E.length=B;for(S=0;S<B;S+=1)E[S]=H[S]}else E=H;g.positions=E,g.indices=b.indices}if(!g.wireframeBuffer&&E){x=g.indices,T=x.length;var j=this.float32ArrayConstructor?new this.float32ArrayConstructor(T*c):new Array(T*c),F,I=0,q,R,U,z,W,X,V,$,J,K,Q,G,Y=t.createVertexBuffer({numVertices:T,attributes:l});for(F=0;F<T;F+=3)q=3*x[F],W=3*x[F+1],J=3*x[F+2],R=E[q],U=E[q+1],z=E[q+2],j[I]=R,j[I+1]=U,j[I+2]=z,j[I+3]=0,X=E[W],V=E[W+1],$=E[W+2],j[I+4]=X,j[I+5]=V,j[I+6]=$,K=E[J],Q=E[J+1],G=E[J+2],j[I+7]=K,j[I+8]=Q,j[I+9]=G,I+=c,j[I]=X,j[I+1]=V,j[I+2]=$,j[I+3]=1,j[I+4]=R,j[I+5]=U,j[I+6]=z,j[I+7]=K,j[I+8]=Q,j[I+9]=G,I+=c,j[I]=K,j[I+1]=Q,j[I+2]=G,j[I+3]=2,j[I+4]=R,j[I+5]=U,j[I+6]=z,j[I+7]=X,j[I+8]=V,j[I+9]=$,I+=c;Y.setData(j),g.wireframeBuffer=Y}}}C=k.length;if(!C)return;var Z=u.v4Build,et=u.m43MulM44;t.setTechnique(o),o.windowScale=[t.width/2,t.height/2],o.wireColor=Z.call(u,0,.2,.6,1),o.alphaRef=0,o.alpha=.5;var tt,nt,rt=u.m43BuildIdentity(),it=this.physicsWireframeSemantics;it||(this.physicsWireframeSemantics=it=t.createSemantics(["POSITION","TEXCOORD0","TEXCOORD1"]));for(m=0;m<C;m+=1){g=k[m],y=g.target;var st=g.body,ot=y.disabled?.2:st.active?1:.4,ut,at,ft;g.kinematic?(ut=0,at=0,ft=ot):g.dynamic?(ut=0,at=ot,ft=0):(ut=ot,at=0,ft=0);var lt,ct,ht;st.type==="CHARACTER"?(lt=0,ct=0,ht=0):(M=st.shape,M.type==="TRIANGLE_MESH"?(lt=1,ct=0,ht=0):M.type==="CONVEX_HULL"?(lt=0,ct=0,ht=1):(lt=0,ct=1,ht=0)),lt=.5*(lt+ut),ct=.5*(ct+at),ht=.5*(ht+ft),tt=Z.call(u,lt,ct,ht,0,tt),st.calculateTransform(rt),nt=et.call(u,rt,r.viewProjectionMatrix,nt),o.fillColor=tt,o.worldViewProjection=nt;var pt=g.wireframeBuffer;t.setStream(pt,it),t.draw(t.PRIMITIVE_TRIANGLES,pt.numVertices,0)}},A.prototype.drawVisibleRenderablesExtents=function(t,n,r,i,s){var o=this.visibleRenderables,u=o.length;if(u){var a,f,l,c=[],h;for(a=0;a<u;a+=1)f=o[a],h=f.getWorldExtents(),h&&(l=f.sharedMaterial.meta,l.decal?i&&c.push(h):l.transparent?s&&c.push(h):!i&&!s&&c.push(h));var p=c.length;if(!p)return;var d=n.load("shaders/debug.cgfx"),v=d.getTechnique("debug_lines_constant");if(!v)return;var m,g,y;i?(m=1,g=0,y=0):s?(m=0,g=0,y=1):(m=0,g=1,y=0),t.setTechnique(v);var b=this.md,w=this.debugLinesConstantTechniqueParameters;w?(w.worldViewProjection=r.viewProjectionMatrix,w.constantColor=b.v4Build(m,g,y,1,w.constantColor)):(w=t.createTechniqueParameters({worldViewProjection:r.viewProjectionMatrix,constantColor:b.v4Build(m,g,y,1)}),this.debugLinesConstantTechniqueParameters=w),t.setTechniqueParameters(w);var E=this.getDebugSemanticsPos(),S=t.beginDraw(t.PRIMITIVE_LINES,24*p,[t.VERTEXFORMAT_FLOAT3],E);if(S){for(a=0;a<p;a+=1){h=c[a];var x=h[0],T=h[1],N=h[2],C=h[3],k=h[4],L=h[5];S(x,T,N),S(x,T,L),S(x,T,N),S(x,k,N),S(x,T,N),S(C,T,N),S(C,k,L),S(C,k,N),S(C,k,L),S(C,T,L),S(C,k,L),S(x,k,L),S(x,k,L),S(x,k,N),S(x,k,L),S(x,T,L),S(C,k,N),S(x,k,N),S(C,k,N),S(C,T,N),S(C,T,L),S(x,T,L),S(C,T,L),S(C,T,N)}t.endDraw(S),S=null}}},A.prototype.drawOpaqueNodesExtents=function(t,n,r){this.drawVisibleRenderablesExtents(t,n,r,!1,!1)},A.prototype.drawDecalNodesExtents=function(t,n,r){this.drawVisibleRenderablesExtents(t,n,r,!0,!1)},A.prototype.drawTransparentNodesExtents=function(t,n,r){this.drawVisibleRenderablesExtents(t,n,r,!1,!0)},A.prototype.drawStaticNodesTree=function(t,n,r,i){this.staticSpatialMap.getNodes?this.drawNodesTree(this.staticSpatialMap,t,n,r,i):this.staticSpatialMap.getCells&&this.drawCellsGrid(this.staticSpatialMap,t,n,r)},A.prototype.drawDynamicNodesTree=function(t,n,r,i){this.dynamicSpatialMap.getNodes?this.drawNodesTree(this.dynamicSpatialMap,t,n,r,i):this.dynamicSpatialMap.getCells&&this.drawCellsGrid(this.dynamicSpatialMap,t,n,r)},A.prototype.drawNodesTree=function(t,n,r,i,s){function o(e,t,n,r){var i=t[n];if(r===0){var s=i.extents,u=s[0],a=s[1],f=s[2],l=s[3],c=s[4],h=s[5];return e(u,a,f),e(u,a,h),e(u,a,f),e(u,c,f),e(u,a,f),e(l,a,f),e(l,c,h),e(l,c,f),e(l,c,h),e(l,a,h),e(l,c,h),e(u,c,h),e(u,c,h),e(u,c,f),e(u,c,h),e(u,a,h),e(l,c,f),e(u,c,f),e(l,c,f),e(l,a,f),e(l,a,h),e(u,a,h),e(l,a,h),e(l,a,f),n+i.escapeNodeOffset}if(i.isLeaf())return n+1;var p=n+i.escapeNodeOffset;r-=1,n+=1;do n=o(e,t,n,r);while(n<p);return n}var u=t.getNodes(),a=t.getEndNodeIndex();if(a){var f=r.load("shaders/debug.cgfx"),l=f.getTechnique("debug_lines_constant");if(!l)return;n.setTechnique(l);var c=this.md,h=this.debugLinesConstantTechniqueParameters;h||(h=n.createTechniqueParameters({worldViewProjection:null,constantColor:null}),this.debugLinesConstantTechniqueParameters=h),h.worldViewProjection=i.viewProjectionMatrix,h.constantColor=c.v4Build(1,0,0,1),n.setTechniqueParameters(h);var p=24*c.truncate(Math.pow(2,s)),d=this.getDebugSemanticsPos(),v=n.beginDraw(n.PRIMITIVE_LINES,p,[n.VERTEXFORMAT_FLOAT3],d);v&&(o(v,u,0,s),n.endDraw(v),v=null)}},A.prototype.drawCellsGrid=function(t,n,r,i){var s=r.load("shaders/debug.cgfx"),o=s.getTechnique("debug_lines");if(!o)return;var u=t.getCells(),a=u.length,f=0,l=0,c,h,p;for(c=0;c<a;c+=1)h=u[c],h&&(p=h.length,f<p&&(f=p),l+=1);if(l){n.setTechnique(o);var d=this.debugLinesTechniqueParameters;d?d.worldViewProjection=i.viewProjectionMatrix:(d=n.createTechniqueParameters({worldViewProjection:i.viewProjectionMatrix}),this.debugLinesTechniqueParameters=d),n.setTechniqueParameters(d);var v=this.getDebugSemanticsPosCol(),m=n.VERTEXFORMAT_FLOAT3,g=n.beginDraw(n.PRIMITIVE_LINES,24*l,[m,m],v);if(g){var y=t.getCellSize(),b=t.getExtents(),w=b[0],E=b[1],S=b[2],x=b[3],T=b[4],N=b[5],C=Math.ceil((x-w)/y),k=Math.ceil((N-S)/y),L=b.slice(0),A=this.writeBox,O=1/f,M,_,D;L[2]=S,L[5]=S+y,c=0;for(M=0;M<k;M+=1){L[0]=w,L[3]=w+y;for(_=0;_<C;_+=1)h=u[c],c+=1,h&&(p=h.length,D=1===p?0:p*O,A(g,L,1,D,D)),L[0]=L[3],L[3]+=y;L[2]=L[5],L[5]+=y}n.endDraw(g),g=null}}},A.prototype.updateNormals=function(t,n,r,i,s,o,u,a){var f,l,c,h,p=function(n,r){var i=t.createVertexBuffer({numVertices:n,attributes:[t.VERTEXFORMAT_FLOAT3],dynamic:!0}),s=Geometry.create();s.halfExtents=f,s.center=l,s.primitive=t.PRIMITIVE_LINES,s.semantics=t.createSemantics([t.SEMANTIC_POSITION]),s.vertexBuffer=i,s.numIndices=n;var o={first:0,numVertices:n,primitive:t.PRIMITIVE_LINES},u=GeometryInstance.create(s,o,r);return c.addRenderable(u),u},d=function(t,n,r,i,s,o){var u,a,f,l,c,p,d,v,m=0,g=t.map();if(g){for(var y=0;y<s;y+=2)f=n[m+r+0],l=n[m+r+1],c=n[m+r+2],p=n[m+i+0],d=n[m+i+1],v=n[m+i+2],u=p*p+d*d+v*v,u?(a=1/u*o,p*=a,d*=a,v*=a):(p=0,d=0,v=0),g(f,l,c),g(f+p,l+d,c+v),m+=h;t.unmap(g)}},v=this.rootNodes,m=v.length;for(var g=0;g<m;g+=1){c=v[g];if(c.renderables){var y,b,w,E,S,x,T,N,C,k,L,A,O,M,_=c.renderables.length;for(var D=0;D<_;D+=1){var P=c.renderables[D];if(!P.isNormal){b=P.geometry,w=P.surface,f=b.halfExtents,E=b.vertexBuffer,N=(f[0]+f[1]+f[2])*.01;if(!P.normalsInfo){var H;if(w.indexBuffer){var B=b.vertexBufferAllocation;H=B.baseIndex,S=B.length}else H=w.first,S=w.numVertices;var j=b.semantics,F=j.length;y=S*2,h=E.stride,x=w.vertexData;var I=E.attributes,q=I.length;l=b.center,C=-1,L=-1,O=-1,T=-1,k=null,A=null,M=null;var R=0,U,z;for(var W=0;W<F;W+=1){U=j[W],z=I[W],t.SEMANTIC_POSITION===U?T=R:t.SEMANTIC_NORMAL===U?(k=p(y,i),k.normals=!0,C=R):t.SEMANTIC_TANGENT===U?(A=p(y,o),A.tangents=!0,L=R):t.SEMANTIC_BINORMAL===U&&(M=p(y,a),M.binormal=!0,O=R);var X=this.attributeComponents(z);R+=X}P.normalsInfo={stride:h,positionOffset:T,vertexBufferData:x,normalsNumVerts:y,normalOffset:C,tangentOffset:L,binormalOffset:O,normalRenderable:k,tangentRenderable:A,binormalRenderable:M,scale:N}}else{var V=P.normalsInfo;h=V.stride,T=V.positionOffset,x=V.vertexBufferData,y=V.normalsNumVerts,k=V.normalRenderable,A=V.tangentRenderable,M=V.binormalRenderable,C=V.normalOffset,L=V.tangentOffset,O=V.binormalOffset,N=V.scale}k&&(k.disabled=!r,r&&(k.setMaterial(i),d(k.geometry.vertexBuffer,x,T,C,y,n*N))),A&&(A.disabled=!s,s&&(A.setMaterial(o),d(A.geometry.vertexBuffer,x,T,L,y,n*N))),M&&(M.disabled=!u,u&&(M.setMaterial(a),d(M.geometry.vertexBuffer,x,T,O,y,n*N)))}}}}},A.prototype.attributeComponents=function(t){if(TurbulenzEngine.canvas)return t.numComponents;var n=this.vertexAttrToNumComponents;if(!n){var r=TurbulenzEngine.getGraphicsDevice();n={},n[r.VERTEXFORMAT_BYTE4]=4,n[r.VERTEXFORMAT_BYTE4N]=4,n[r.VERTEXFORMAT_UBYTE4]=4,n[r.VERTEXFORMAT_UBYTE4N]=4,n[r.VERTEXFORMAT_SHORT4]=4,n[r.VERTEXFORMAT_SHORT4N]=4,n[r.VERTEXFORMAT_USHORT4]=4,n[r.VERTEXFORMAT_USHORT4N]=4,n[r.VERTEXFORMAT_FLOAT4]=4,n[r.VERTEXFORMAT_SHORT2]=2,n[r.VERTEXFORMAT_SHORT2N]=2,n[r.VERTEXFORMAT_USHORT2]=2,n[r.VERTEXFORMAT_USHORT2N]=2,n[r.VERTEXFORMAT_FLOAT2]=2,n[r.VERTEXFORMAT_FLOAT1]=1,n[r.VERTEXFORMAT_FLOAT3]=3,this.vertexAttrToNumComponents=n}var i=n[t];return i},A.prototype.drawWireframe=function(t,n,r,i){var s=this.visibleNodes,o=s.length;if(o){var u=n.load("shaders/debug.cgfx"),a=u.getTechnique("wireframe"),f=u.getTechnique("wireframe_skinned");if(!a||!f)return!1;var l=this.md,c=t.setTechnique,h=t.setStream,p=t.draw,d=l.m43MulM44,v=r.viewProjectionMatrix,m,g,y,b,w,E,S=t.VERTEXFORMAT_FLOAT4,x=t.VERTEXFORMAT_FLOAT3,T=t.VERTEXFORMAT_BYTE4,N=[S,x,x,T,S,T,S,T,S],C=[S,x,x],k=this.skinnedWireframeSemantics;k||(k=t.createSemantics(["POSITION","TEXCOORD0","TEXCOORD1","BLENDINDICES","BLENDWEIGHT","TEXCOORD2","TEXCOORD3","TEXCOORD4","TEXCOORD5"]),this.skinnedWireframeSemantics=k);var L=this.solidWireframeSemantics;L||(L=t.createSemantics(["POSITION","TEXCOORD0","TEXCOORD1"]),this.solidWireframeSemantics=L);for(var O=0;O<o;O+=1){var M=s[O],_=M.renderables;if(_&&!M.disabled){var D=_.length;for(var P=0;P<D;P+=1){var H=_[P],B=H.surface;if(!H.disabled&&B&&B.vertexData&&(B.primitive===t.PRIMITIVE_TRIANGLES||B.primitive===t.PRIMITIVE_TRIANGLE_STRIP||B.primitive===t.PRIMITIVE_TRIANGLE_FAN)){var j=B.primitive,F=H.skinController;F?(m!==f&&(m=f,c.call(t,f)),m.skinBones=F.output,b=N,y=k,w=34,E=24):(m!==a&&(m=a,c.call(t,a)),b=C,y=L,w=10,E=0),g=d.call(l,H.node.world,v,g),m.worldViewProjection=g,m.windowScale=[t.width/2,t.height/2],i&&i.wireColor&&i.fillColor?(m.wireColor=i.wireColor,m.fillColor=i.fillColor,m.alphaRef=i.alphaRef):(m.wireColor=l.v4Build(0,0,0,1),m.fillColor=l.v4Build(1,1,1,0),m.alphaRef=.35);var I=B.wireframeBuffer;if(!I){var q=H.geometry,R=q.vertexBuffer,U=q.semantics,z=B.vertexData,W=B.indexBuffer,X=R.stride,V=0,$=0,J=0,K=!1;for(var Q=0;Q<U.length;Q+=1){if(U[Q]===t.SEMANTIC_POSITION){K=!0;break}V+=A.prototype.attributeComponents(R.attributes[Q])}if(K===!1)return!1;if(m===f){K=!1;for(Q=0;Q<U.length;Q+=1){if(U[Q]===t.SEMANTIC_BLENDINDICES){K=!0;break}$+=A.prototype.attributeComponents(R.attributes[Q])}if(K===!1)return!1;K=!1;for(Q=0;Q<U.length;Q+=1){if(U[Q]===t.SEMANTIC_BLENDWEIGHT){K=!0;break}J+=A.prototype.attributeComponents(R.attributes[Q])}if(K===!1)return!1}var G,Y,Z,et,tt,nt,rt=[],it=0,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt;W?(G=B.indexData,j===t.PRIMITIVE_TRIANGLE_STRIP?(et=G.length-2,Z=et*3,nt=1):(Z=G.length,nt=3)):j===t.PRIMITIVE_TRIANGLE_STRIP||j===t.PRIMITIVE_TRIANGLE_FAN?(V+=(B.first-q.vertexBufferAllocation.baseIndex)*X,et=B.numVertices-2,Z=et*3,nt=1):(V+=(B.first-q.vertexBufferAllocation.baseIndex)*X,Z=B.numVertices,nt=3),Y=t.createVertexBuffer({numVertices:Z,attributes:b,dynamic:R.dynamic}),rt.length=Z*w;for(Q=0;Q<Z;Q+=nt)W?j===t.PRIMITIVE_TRIANGLE_STRIP?Q%2===0?(st=G[Q]*X+V,ft=G[Q+1]*X+V,pt=G[Q+2]*X+V):(st=G[Q+1]*X+V,ft=G[Q]*X+V,pt=G[Q+2]*X+V):(st=G[Q]*X+V,ft=G[Q+1]*X+V,pt=G[Q+2]*X+V):j===t.PRIMITIVE_TRIANGLE_STRIP?Q%2===0?(st=Q*X+V,ft=(Q+1)*X+V,pt=(Q+2)*X+V):(st=(Q+1)*X+V,ft=Q*X+V,pt=(Q+2)*X+V):j===t.PRIMITIVE_TRIANGLE_FAN?(st=V,ft=(Q+1)*X+V,pt=(Q+2)*X+V):(st=Q*X+V,ft=(Q+1)*X+V,pt=(Q+2)*X+V),ot=z[st],ut=z[st+1],at=z[st+2],rt[it]=ot,rt[it+1]=ut,rt[it+2]=at,rt[it+3]=0,lt=z[ft],ct=z[ft+1],ht=z[ft+2],rt[it+4]=lt,rt[it+5]=ct,rt[it+6]=ht,dt=z[pt],vt=z[pt+1],mt=z[pt+2],rt[it+7]=dt,rt[it+8]=vt,rt[it+9]=mt,it+=w,rt[it]=lt,rt[it+1]=ct,rt[it+2]=ht,rt[it+3]=1,rt[it+4]=ot,rt[it+5]=ut,rt[it+6]=at,rt[it+7]=dt,rt[it+8]=vt,rt[it+9]=mt,it+=w,rt[it]=dt,rt[it+1]=vt,rt[it+2]=mt,rt[it+3]=2,rt[it+4]=ot,rt[it+5]=ut,rt[it+6]=at,rt[it+7]=lt,rt[it+8]=ct,rt[it+9]=ht,it+=w;if(m===f){var gt,yt,bt,wt,Et,St,xt=[],Tt=[],Nt=[];it=0;for(Q=0;Q<Z;Q+=nt){W?(gt=G[Q]*X+$,bt=G[Q+1]*X+$,Et=G[Q+2]*X+$,yt=G[Q]*X+J,wt=G[Q+1]*X+J,St=G[Q+2]*X+J):j===t.PRIMITIVE_TRIANGLE_STRIP?Q%2===0?(gt=Q*X+$,bt=(Q+1)*X+$,Et=(Q+2)*X+$,yt=Q*X+J,wt=(Q+1)*X+J,St=(Q+2)*X+J):(gt=(Q+1)*X+$,bt=Q*X+$,Et=(Q+2)*X+$,yt=(Q+1)*X+J,wt=Q*X+J,St=(Q+2)*X+J):j===t.PRIMITIVE_TRIANGLE_FAN?(gt=$,bt=(Q+1)*X+$,Et=(Q+2)*X+$,yt=J,wt=(Q+1)*X+J,St=(Q+2)*X+J):(gt=Q*X+$,bt=(Q+1)*X+$,Et=(Q+2)*X+$,yt=Q*X+J,wt=(Q+1)*X+J,St=(Q+2)*X+J);for(tt=0;tt<4;tt+=1)xt[tt]=z[gt+tt],xt[tt+4]=z[yt+tt],Tt[tt]=z[bt+tt],Tt[tt+4]=z[wt+tt],Nt[tt]=z[Et+tt],Nt[tt+4]=z[St+tt];for(tt=0;tt<8;tt+=1)rt[it+10+tt]=xt[tt],rt[it+18+tt]=Tt[tt],rt[it+26+tt]=Nt[tt];it+=w;for(tt=0;tt<8;tt+=1)rt[it+10+tt]=Tt[tt],rt[it+18+tt]=xt[tt],rt[it+26+tt]=Nt[tt];it+=w;for(tt=0;tt<8;tt+=1)rt[it+10+tt]=Nt[tt],rt[it+18+tt]=xt[tt],rt[it+26+tt]=Tt[tt];it+=w}}Y.setData(rt),W=null,B.wireframeBuffer=Y,I=Y}h.call(t,I,y),p.call(t,t.PRIMITIVE_TRIANGLES,I.numVertices,0)}}}}}return!0},A.prototype.getMetrics=function(){var t=0,n=0,r=0,i=0,s=this.globalLights.length,o=function(u){t+=1;var a=u.renderables,f=a?a.length:0;n+=f;var l=u.lightInstances,c=l?l.length:0;s+=c;var h,p;for(h=0;h<f;h+=1){var d=a[h],v=d.surface;r+=v.numVertices,v.indexBuffer?p=v.numIndices:p=v.numVertices;switch(v.primitive){case 0:i+=p;break;case 1:i+=p>>1;break;case 2:i+=p;break;case 3:i+=p-1;break;case 4:i+=p/3|0;break;case 5:i+=p-2;break;case 6:i+=p-2}}var m=u.children;if(m){var g=m.length;for(h=0;h<g;h+=1)o(m[h])}},u=this.rootNodes;if(u){var a=u.length;for(var f=0;f<a;f+=1)o(u[f])}return{numNodes:t,numRenderables:n,numLights:s,numVertices:r,numPrimitives:i}},A.prototype.getVisibilityMetrics=function(){var t=this.visiblePortals,n=t.length,r=0,i;for(i=0;i<n;i+=1)r+=t[i].planes.length;var s=this.visibleRenderables.length,o=0,u=0,a=this.visibleLights,f=a.length;for(i=0;i<f;i+=1){var l=a[i];l.numVisibleDrawParameters&&(s+=l.numVisibleDrawParameters);var c=l.shadowMap;c&&l.frameVisible===c.frameVisible&&c.numRenderables&&(o+=1,u+=c.numRenderables)}return{numPortals:n,numPortalsPlanes:r,numLights:f,numRenderables:s,numShadowMaps:o,numOccluders:u}},A.prototype.getDebugSemanticsPosCol=function(){var t=this.debugSemanticsPosCol;if(!t){var n=TurbulenzEngine.getGraphicsDevice();t=n.createSemantics([n.SEMANTIC_POSITION,n.SEMANTIC_COLOR]),this.debugSemanticsPosCol=t}return t},A.prototype.getDebugSemanticsPos=function(){var t=this.debugSemanticsPos;if(!t){var n=TurbulenzEngine.getGraphicsDevice();t=n.createSemantics([n.SEMANTIC_POSITION]),this.debugSemanticsPos=t}return t};var O=function(t){var n=O,r=n.techniquesIndexMap[t];return r===undefined&&(r=n.numTechniques,n.techniquesIndexMap[t]=r,n.numTechniques+=1),r};O.techniquesIndexMap={},O.numTechniques=0;var D=function(t){var n=this.array;n[n.length]=t},P=function(){function n(){this.passIndex={fillZ:0,glow:1,ambient:2,shadow:3,diffuse:4,decal:5,transparent:6}}return n.prototype.updateShader=function(e){var t=e.get("shaders/zonly.cgfx");t!==this.zonlyShader&&(this.zonlyShader=t,this.zonlyRigidTechnique=t.getTechnique("rigid"),this.zonlySkinnedTechnique=t.getTechnique("skinned"),this.zonlyRigidAlphaTechnique=t.getTechnique("rigid_alphatest"),this.zonlySkinnedAlphaTechnique=t.getTechnique("skinned_alphatest"),this.zonlyRigidNoCullTechnique=t.getTechnique("rigid_nocull"),this.zonlySkinnedNoCullTechnique=t.getTechnique("skinned_nocull"),this.zonlyRigidAlphaNoCullTechnique=t.getTechnique("rigid_alphatest_nocull"),this.zonlySkinnedAlphaNoCullTechnique=t.getTechnique("skinned_alphatest_nocull")),t=e.get("shaders/forwardrendering.cgfx"),t!==this.forwardShader&&(this.forwardShader=t,this.skyboxTechnique=t.getTechnique("skybox"),this.ambientRigidTechnique=t.getTechnique("ambient"),this.ambientSkinnedTechnique=t.getTechnique("ambient_skinned"),this.ambientRigidAlphaTechnique=t.getTechnique("ambient_alphatest"),this.ambientSkinnedAlphaTechnique=t.getTechnique("ambient_alphatest_skinned"),this.ambientFlatRigidTechnique=t.getTechnique("ambient_flat"),this.ambientFlatRigidNoCullTechnique=t.getTechnique("ambient_flat_nocull"),this.ambientFlatSkinnedTechnique=t.getTechnique("ambient_flat_skinned"),this.ambientGlowmapRigidTechnique=t.getTechnique("ambient_glowmap"),this.ambientGlowmapSkinnedTechnique=t.getTechnique("ambient_glowmap_skinned"),this.ambientLightmapRigidTechnique=t.getTechnique("ambient_lightmap"),this.glowmapRigidTechnique=t.getTechnique("glowmap"),this.glowmapSkinnedTechnique=t.getTechnique("glowmap_skinned"),this.lightmapRigidTechnique=t.getTechnique("lightmap"));var n=this.shadowMaps;n&&n.updateShader(e)},n.createNodeRendererInfo=function(e,t){var r=new Float32Array(21);e.rendererInfo={id:n.nextNodeID,worldView:t.m43BuildIdentity(r.subarray(0,12)),worldViewInverseTranspose:t.m33BuildIdentity(r.subarray(12,21))},n.nextNodeID+=1},n.prototype.createRendererInfo=function(e){var t=_(e);e.rendererInfo=t;var r=e.sharedMaterial.techniqueParameters;(!r.env_map||!!r.normal_map)&&!r.materialColor&&!e.techniqueParameters.materialColor&&(r.materialColor=this.v4One),!r.uvTransform&&!e.techniqueParameters.uvTransform&&(r.uvTransform=this.identityUVTransform);var i=e.node;i.rendererInfo||n.createNodeRendererInfo(i,this.md);var s=e.geometry.vertexBuffer.id;return t.id=1/(1+s),t},n.prototype.prepareRenderables=function(e,t){var n,r=this.passesSize,i=this.passes,s=this.numPasses;for(n=0;n<s;n+=1)r[n]=0;var o=t.getCurrentVisibleRenderables();this.visibleRenderables=o;var u=o.length;if(u>0){var a,f,l,c,h,p,d,v,m,g=this.passIndex.transparent,y=this.passIndex.ambient,b=t.maxDistance,w=0<b?1/b:0;a=0;do{f=o[a],l=f.rendererInfo,l||(l=this.createRendererInfo(f)),l.far&&(f.distance=1e38),f.renderUpdate(e),h=f.drawParameters,p=h.length,m=f.distance,0<m?(m*=w,.999<m&&(m=.999)):m=0;for(d=0;d<p;d+=1)v=h[d],n=v.userData.passIndex,n<=y?v.sortKey=(v.sortKey|0)+m:n===g&&(v.sortKey=m),c=r[n],i[n][c]=v,r[n]=c+1;h=f.diffuseDrawParameters;if(h){p=h.length;for(d=0;d<p;d+=1)v=h[d],v.removeInstances();h=f.diffuseShadowDrawParameters;if(h){p=h.length;for(d=0;d<p;d+=1)v=h[d],v.removeInstances()}}a+=1}while(a<u)}for(n=0;n<s;n+=1)i[n].length=r[n]},n.prototype.prepareLights=function(e,t){var n=this.pointLights,r=this.spotLights,i=this.localDirectionalLights,s=this.globalDirectionalLights,o=0,u=0,a=0,f=0,l=t.getCurrentVisibleLights(),c=l.length,h,p,d;if(c){d=0;do{h=l[d],p=h.light;if(p&&!p.global){h.shadows=!1;if(!this.lightFindVisibleRenderables(e,h,t)){c-=1;if(d<c){l[d]=l[c];continue}break}p.spot?(r[u]=h,u+=1):p.point?(n[o]=h,o+=1):p.directional&&(i[a]=h,a+=1)}d+=1}while(d<c);c<l.length&&(l.length=c)}var v=t.getGlobalLights(),m=v.length;if(m){d=0;do p=v[d],p&&!p.disabled&&p.directional&&(s[f]=p,f+=1),d+=1;while(d<m)}s.length=f,i.length=a,n.length=o,r.length=u},n.prototype.addToDiffuseQueue=function(e,t,n){t.addInstance(n);if(1===t.getNumInstances()){var r=this.diffuseQueue,i=this.numDiffuseQueue;this.numDiffuseQueue=i+1,r[i]=t}},n.prototype.lightFindVisibleRenderables=function(e,t,n){var r,i,s,o,u,a,f,l,c,h,p=this.shadowMaps;l=t.node,c=t.light,a=t.getWorldExtents(),f=t.frameVisible;var d=this.overlapQueryRenderables,v=0;d.length=0;var m=this.lightVisibleRenderables,g=0;i=t.overlappingRenderables;if(l.dynamic||t.staticNodesChangeCounter!==n.staticNodesChangeCounter){var y=this.md,b=l.world,w=c.origin;w?r=y.m43TransformPoint(b,w,t.lightOrigin):r=y.m43Pos(b,t.lightOrigin),t.lightOrigin=r,i||(i=[],t.overlappingRenderables=i),s=0,t.staticNodesChangeCounter=n.staticNodesChangeCounter,n.findStaticOverlappingRenderables(r,a,d),v=d.length;for(o=0;o<v;o+=1)h=d[o],u=h.sharedMaterial.meta,!u.transparent&&!u.decal&&!u.far&&(i[s]=h,s+=1,h.getWorldExtents(),h.frameVisible===f&&!h.disabled&&!h.node.disabled&&(m[g]=h,g+=1));d.length=0,i.length=s,t.numStaticOverlappingRenderables=s}else{r=t.lightOrigin,s=t.numStaticOverlappingRenderables;for(o=0;o<s;o+=1)h=i[o],h.frameVisible===f&&!h.disabled&&!h.node.disabled&&(m[g]=h,g+=1)}n.findDynamicOverlappingRenderables(r,a,d),v=d.length;for(o=0;o<v;o+=1)h=d[o],u=h.sharedMaterial.meta,!u.transparent&&!u.decal&&!u.far&&(i[s]=h,s+=1,h.frameVisible===f&&!h.disabled&&!h.node.disabled&&(m[g]=h,g+=1));i.length!==s&&(i.length=s);if(0===g)return t.numVisibleDrawParameters=0,!1;var E,S,x,T,N,C=0,k=!1;p&&c.shadows&&(k=p.findVisibleRenderables(t));var L=t.techniqueParameters;L||(L=e.createTechniqueParameters(c.techniqueParameters),L.lightViewInverseTransposeFalloff=e.createTechniqueParameterBuffer({numFloats:16}),t.techniqueParameters=L);for(o=0;o<g;o+=1){h=m[o],E=h.rendererInfo.id||0,k?T=h.diffuseShadowDrawParameters:T=h.diffuseDrawParameters,x=T.length;for(S=0;S<x;S+=1)N=T[S],N.sortKey=(N.sortKey|0)+E,this.addToDiffuseQueue(e,N,L),C+=1}return t.numVisibleDrawParameters=C,0<C},n.prototype.directionalLightsUpdateVisibleRenderables=function(e){var t=this.globalDirectionalLights,n=t.length,r=this.visibleRenderables,i=r.length,s,o,u,a,f,l,c,h,p=0,d=0;do{s=t[d],o=s.techniqueParameters,u=0;for(a=0;a<i;a+=1){f=r[a];if(!f.disabled&&!f.node.disabled){h=f.diffuseDrawParameters;if(h){c=h.length;for(l=0;l<c;l+=1)this.addToDiffuseQueue(e,h[l],o),u+=1}}}s.numVisibleDrawParameters=u,p+=u,d+=1}while(d<n);return 0<p},n.prototype.update=function(e,t,n,r){this.camera=t,this.globalCameraMatrix=t.matrix,this.numDiffuseQueue=0,0<r?n.updateVisibleNodes(t):this.forceRenderInfoUpdate(n),this.sceneExtents=n.extents,this.prepareRenderables(t,n),this.prepareLights(e,n);var i=this.md,s=t.viewMatrix,o=this.globalTechniqueParameters;o.projection=t.projectionMatrix,o.viewProjection=t.viewProjectionMatrix,o.eyePosition=i.m43Pos(t.matrix,o.eyePosition),o.time=r;var u=n.globalLights,a=u.length,f=0,l=0,c=0,h,p,d;for(d=0;d<a;d+=1)h=u[d],h.disabled||h.ambient&&(p=h.color,f+=p[0],l+=p[1],c+=p[2]);var v=this.lightingScale;f||l||c?this.ambientColor=i.v3Build(v*f,v*l,v*c,this.ambientColor):delete this.ambientColor;var m,g,y,b,w,E,S,x,T,N,C=this.lightViewInverseTranspose,k=this.lightFalloff,L=this.worldView,A=this.pointLights,O=A.length;for(m=0;m<O;m+=1)b=A[m],g=b.node,y=b.light,E=g.world,S=b.techniqueParameters,x=y.origin,L=i.m43Mul(E,s,L),x?S.lightOrigin=i.m43TransformPoint(L,x,S.lightOrigin):S.lightOrigin=i.m43Pos(L,S.lightOrigin),w=y.color,S.lightColor=i.v3Build(v*w[0],v*w[1],v*w[2],S.lightColor),C=i.m43InverseTransposeProjection(L,y.halfExtents,C),k[0]=C[8],k[1]=C[9],k[2]=C[10],k[3]=C[11],C[8]=0,C[9]=0,C[10]=0,C[11]=1,N=S.lightViewInverseTransposeFalloff,N.setData(C,0,12),N.setData(k,12,4);var M=this.localDirectionalLights,_=M.length,D;for(m=0;m<_;m+=1)b=M[m],g=b.node,y=b.light,E=g.world,S=b.techniqueParameters,L=i.m43Mul(E,s,L),D=i.m43TransformVector(L,y.direction,D),S.lightOrigin=i.v3ScalarMul(D,-1e5,S.lightOrigin),w=y.color,S.lightColor=i.v3Build(v*w[0],v*w[1],v*w[2],S.lightColor),C=i.m43InverseTransposeProjection(L,y.halfExtents,C),k[0]=C[8],k[1]=C[9],k[2]=C[10],k[3]=C[11],C[8]=0,C[9]=0,C[10]=0,C[11]=1,N=S.lightViewInverseTransposeFalloff,N.setData(C,0,12),N.setData(k,12,4);var P=this.globalDirectionalLights,H=P.length;if(H)if(this.directionalLightsUpdateVisibleRenderables(e)){var B=n.extents,j=-1e5*(B[3]-B[0]+(B[4]-B[1])+(B[5]-B[2]));T=i.v3Build(B[3]-B[0],B[4]-B[1],B[5]-B[2]),C=i.m43InverseTransposeProjection(s,T,C),k[0]=C[8],k[1]=C[9],k[2]=C[10],k[3]=C[11],C[8]=0,C[9]=0,C[10]=0,C[11]=1,N=this.lightViewInverseTransposeFalloff,N.setData(C,0,12),N.setData(k,12,4);var F=i.v3BuildZero();m=0;do y=P[m],S=y.techniqueParameters,S.lightViewInverseTransposeFalloff=N,i.v3Normalize(y.direction,F),x=i.v3ScalarMul(F,j),S.lightOrigin=i.m43TransformPoint(s,x,S.lightOrigin),w=y.color,S.lightColor=i.v3Build(v*w[0],v*w[1],v*w[2],S.lightColor),m+=1;while(m<H)}else P.length=0;var I=this.spotLights,q=I.length;if(q){var R,U,z=this.lightProjection,W=this.lightViewInverseProjection;m=0;do{b=I[m],g=b.node,y=b.light,E=g.world,S=b.techniqueParameters,x=y.origin,L=i.m43Mul(E,s,L),x?S.lightOrigin=i.m43TransformPoint(L,x,S.lightOrigin):S.lightOrigin=i.m43Pos(L,S.lightOrigin),w=y.color,S.lightColor=i.v3Build(v*w[0],v*w[1],v*w[2],S.lightColor);var X=y.frustum,V=y.frustumNear,$=1/(1-V);R=i.m33MulM43(X,L,R),U=i.m43Inverse(R,U),z[8]=$,z[11]=-(V*$),W=i.m43Mul(U,z,W),C=i.m43Transpose(W,C),k[0]=C[8],k[1]=C[9],k[2]=C[10],k[3]=C[11],N=S.lightViewInverseTransposeFalloff,N.setData(C,0,12),N.setData(k,12,4),m+=1}while(m<q)}},n.prototype.forceRenderInfoUpdate=function(e){var t=e.visibleNodes,n=t.length,r;for(r=0;r<n;r+=1){var i=t[r].rendererInfo;i&&(i.frameVisible=-1)}},n.prototype.destroyBuffers=function(){this.finalRenderTarget&&(this.finalRenderTarget.destroy(),this.finalRenderTarget=null),this.finalTexture&&(this.finalTexture.destroy(),this.finalTexture=null),this.depthBuffer&&(this.depthBuffer.destroy(),this.depthBuffer=null)},n.prototype.updateBuffers=function(e,t,n){if(this.bufferWidth===t&&this.bufferHeight===n)return!0;this.destroyBuffers(),this.finalTexture=e.createTexture({name:"final",width:t,height:n,format:"R8G8B8A8",mipmaps:!1,renderable:!0}),this.depthBuffer=e.createRenderBuffer({width:t,height:n,format:"D24S8"});if(this.finalTexture&&this.depthBuffer){this.finalRenderTarget=e.createRenderTarget({colorTexture0:this.finalTexture,depthBuffer:this.depthBuffer});if(this.finalRenderTarget)return this.bufferWidth=t,this.bufferHeight=n,!0}return this.bufferWidth=0,this.bufferHeight=0,this.destroyBuffers(),!1},n.prototype.drawAmbientPass=function(e,t){this.ambientTechniqueParameters.ambientColor=t,e.drawArray(this.passes[this.passIndex.ambient],[this.globalTechniqueParameters,this.ambientTechniqueParameters],-1)},n.prototype.drawShadowMaps=function(e,t,n,r,i){var s=n.length;if(!s)return;var o,u,a,f=this.globalCameraMatrix;a=0;do{o=n[a];if(!o.numVisibleDrawParameters){a+=1;continue}u=o.light,u.shadows&&!u.ambient&&r.drawShadowMap(f,i,o),a+=1}while(a<s)},n.prototype.draw=function(e,t,n,r,i,s){var o=this.globalTechniqueParameters,u=this.ambientColor,a=this.shadowMaps;if(a){var f=this.sceneExtents,l=Math.max(f[3]-f[0],f[4]-f[1],f[5]-f[2])/6;a.lowIndex=0,a.highIndex=0,this.drawShadowMaps(e,o,this.pointLights,a,l),this.drawShadowMaps(e,o,this.spotLights,a,l),this.drawShadowMaps(e,o,this.localDirectionalLights,a,l),a.blurShadowMaps()}var c;s?c=e.beginRenderTarget(this.finalRenderTarget):c=!1,t?e.clear(t,1,0):u?e.clear(null,1,0):e.clear(this.v4Zero,1,0);var h=[o];t&&(t[0]||t[1]||t[2]||t[3]!==1)?(u||(u=this.v3Zero),this.drawAmbientPass(e,u)):u?this.drawAmbientPass(e,u):(e.drawArray(this.passes[this.passIndex.fillZ],h,-1),e.drawArray(this.passes[this.passIndex.glow],h,-1));var p=this.numDiffuseQueue;if(0<p){var d=this.diffuseQueue;p<d.length&&(d.length=p),e.drawArray(d,h,-1)}var v=this.passes[this.passIndex.decal];0<v.length&&e.drawArray(v,h,-1),n&&n(),v=this.passes[this.passIndex.transparent],0<v.length&&e.drawArray(v,h,1),r&&r(),i&&i();if(c){e.endRenderTarget();var m=this.finalTexture;s(e,m),e.setStream(this.quadVertexBuffer,this.quadSemantics),e.draw(this.quadPrimitive,4)}},n.prototype.setLightingScale=function(e){this.lightingScale=e},n.prototype.getDefaultSkinBufferSize=function(){return this.defaultSkinBufferSize},n.prototype.destroy=function(){delete this.globalTechniqueParameters,delete this.ambientTechniqueParameters,delete this.passesSize,delete this.passes,delete this.passIndex,delete this.sceneExtents,delete this.visibleRenderables,delete this.globalCameraMatrix,delete this.diffuseQueue,delete this.spotLights,delete this.pointLights,delete this.localDirectionalLights,delete this.globalDirectionalLights,delete this.fogLights,delete this.lightViewInverseTransposeFalloff,delete this.lightViewInverseTranspose,delete this.lightFalloff,delete this.v3Zero,delete this.v4Zero,delete this.v4One,delete this.lightProjection,delete this.quadPrimitive,delete this.quadSemantics,this.quadVertexBuffer&&(this.quadVertexBuffer.destroy(),delete this.quadVertexBuffer),delete this.camera,delete this.ambientColor,this.zonlyShader&&(delete this.zonlyShader,delete this.zonlyRigidTechnique,delete this.zonlySkinnedTechnique,delete this.zonlyRigidAlphaTechnique,delete this.zonlySkinnedAlphaTechnique,delete this.zonlyRigidNoCullTechnique,delete this.zonlySkinnedNoCullTechnique,delete this.zonlyRigidAlphaNoCullTechnique,delete this.zonlySkinnedAlphaNoCullTechnique),this.forwardShader&&(delete this.forwardShader,delete this.skyboxTechnique,delete this.ambientRigidTechnique,delete this.ambientSkinnedTechnique,delete this.ambientRigidAlphaTechnique,delete this.ambientSkinnedAlphaTechnique,delete this.ambientFlatRigidTechnique,delete this.ambientFlatRigidNoCullTechnique,delete this.ambientFlatSkinnedTechnique,delete this.ambientGlowmapRigidTechnique,delete this.ambientGlowmapSkinnedTechnique,delete this.ambientLightmapRigidTechnique,delete this.glowmapRigidTechnique,delete this.glowmapSkinnedTechnique,delete this.lightmapRigidTechnique);var e=this.shadowMaps;e&&(e.destroy(),delete this.shadowMaps),this.destroyBuffers(),delete this.md},n.create=function(r,i,s,o,u){var a=new n;a.md=i,a.globalTechniqueParameters=r.createTechniqueParameters({time:0}),a.ambientTechniqueParameters=r.createTechniqueParameters({ambientColor:i.v3BuildZero()}),a.numPasses=a.passIndex.transparent+1;var f=a.passes=[],l=a.sharedUserData=[],c=a.numPasses,h;for(h=0;h<c;h+=1)f[h]=[],l[h]={passIndex:h};a.passesSize=[],a.lightingScale=2,a.diffuseQueue=[],a.numDiffuseQueue=0,a.overlapQueryRenderables=[],a.lightVisibleRenderables=[],a.spotLights=[],a.pointLights=[],a.localDirectionalLights=[],a.globalDirectionalLights=[],a.fogLights=[],a.worldView=i.m43BuildIdentity(),a.lightViewInverseProjection=i.m43BuildIdentity(),a.lightViewInverseTransposeFalloff=r.createTechniqueParameterBuffer({numFloats:16}),a.lightViewInverseTranspose=i.m43BuildIdentity(),a.lightFalloff=i.v4BuildZero(),a.v3Zero=i.v3BuildZero(),a.v4Zero=i.v4BuildZero(),a.v4One=i.v4BuildOne(),a.identityUVTransform=new Float32Array([1,0,0,1,0,0]),a.quadPrimitive=r.PRIMITIVE_TRIANGLE_STRIP,a.quadSemantics=r.createSemantics(["POSITION","TEXCOORD0"]),a.quadVertexBuffer=r.createVertexBuffer({numVertices:4,attributes:["FLOAT2","FLOAT2"],dynamic:!1,data:[-1,1,0,1,1,1,1,1,-1,-1,0,0,1,-1,1,0]});var p=function(t){var n=t.getParameter("skinBones");a.defaultSkinBufferSize=n.rows*n.columns};s.load("shaders/zonly.cgfx"),s.load("shaders/forwardrendering.cgfx",p);var d,v;if(u&&u.shadowRendering){s.load("shaders/forwardrenderingshadows.cgfx");var m=ShadowMapping.create(r,i,s,o,u.shadowSizeLow,u.shadowSizeHigh);a.shadowMaps=m,d=m.update,v=m.skinnedUpdate,a.defaultShadowMappingUpdateFn=d,a.defaultShadowMappingSkinnedUpdateFn=v}var g,y,b,w,E=i.v3Build(.5,0,0),S=i.v3Build(0,.5,0),x=i.v3Build(.5,.5,1),T=i.v3Build(0,0,0);a.lightProjection=i.m43Build(E,S,x,T);var C=function(t,n,r){var s=i.m43Mul(t.world,r.viewMatrix,n.worldView);i.m33InverseTranspose(s,n.worldViewInverseTranspose)},k=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible
,C(n,r,t));var i=this.techniqueParameters;i.worldView=r.worldView,i.worldViewInverseTranspose=r.worldViewInverseTranspose},L=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,C(n,r,t));var i=this.techniqueParameters;i.worldView=r.worldView,i.worldViewInverseTranspose=r.worldViewInverseTranspose;var s=this.skinController;s&&(i.skinBones=s.output,s.update())},A=16384,O=0,_=function(t){var s,o,u=t.rendererInfo,f=t.sharedMaterial,l=f.meta,c=f.techniqueParameters,h=t.techniqueParameters,p=h.materialColor||c.materialColor||a.v4One;t.drawParameters=[];var d,v=this.technique.name,m=O,g=t.node;g.rendererInfo||n.createNodeRendererInfo(g,i);if(c.glow_map||c.light_map)s=s=r.createDrawParameters(),s.userData=a.sharedUserData[a.passIndex.glow],t.prepareDrawParameters(s),t.drawParameters.push(s),c.light_map?s.technique=a.lightmapRigidTechnique:t.skinController?s.technique=a.glowmapSkinnedTechnique:s.technique=a.glowmapRigidTechnique,s.sortKey=M(s.technique.id,l.materialIndex),s.setTechniqueParameters(0,c),s.setTechniqueParameters(1,h);else if(!l.transparent&&!l.decal){s=r.createDrawParameters(),s.userData=a.sharedUserData[a.passIndex.fillZ],t.prepareDrawParameters(s),t.drawParameters.push(s),d=0;var y=!1,b=-1!==v.indexOf("_nocull");c.alpha_map?(m=A,y=!0,o=r.createTechniqueParameters(),o.alpha_map=c.alpha_map,o.alphaFactor=p[3],c.uvTransform&&(o.uvTransform=c.uvTransform),s.setTechniqueParameters(d,o),d+=1):-1!==v.indexOf("_alpha")?(y=!0,m=A,o=r.createTechniqueParameters(),o.alpha_map=c.diffuse,o.alphaFactor=p[3],c.uvTransform&&(o.uvTransform=c.uvTransform),s.setTechniqueParameters(d,o),d+=1):-1!==v.indexOf("_nocull")&&(b=!0),t.skinController?y?b?s.technique=a.zonlySkinnedAlphaNoCullTechnique:s.technique=a.zonlySkinnedAlphaTechnique:b?s.technique=a.zonlySkinnedNoCullTechnique:s.technique=a.zonlySkinnedTechnique:y?b?s.technique=a.zonlyRigidAlphaNoCullTechnique:s.technique=a.zonlyRigidAlphaTechnique:b?s.technique=a.zonlyRigidNoCullTechnique:s.technique=a.zonlyRigidTechnique;var w=s.technique.id;y?s.sortKey=M(m|w,l.materialIndex):s.sortKey=M(m|w,g.rendererInfo.id),s.setTechniqueParameters(d,h)}!l.transparent&&!l.decal&&(s=r.createDrawParameters(),s.userData=a.sharedUserData[a.passIndex.ambient],t.prepareDrawParameters(s),t.drawParameters.push(s),t.skinController?c.glow_map?c.diffuse?s.technique=a.ambientGlowmapSkinnedTechnique:s.technique=a.glowmapSkinnedTechnique:0===v.indexOf("flat")?s.technique=a.ambientFlatSkinnedTechnique:s.technique=a.ambientSkinnedTechnique:c.light_map?s.technique=a.ambientLightmapRigidTechnique:c.glow_map?c.diffuse?s.technique=a.ambientGlowmapRigidTechnique:s.technique=a.glowmapRigidTechnique:0===v.indexOf("flat")?-1!==v.indexOf("_nocull")?s.technique=a.ambientFlatRigidNoCullTechnique:s.technique=a.ambientFlatRigidTechnique:-1!==v.indexOf("_alpha")?s.technique=a.ambientRigidAlphaTechnique:s.technique=a.ambientRigidTechnique,s.sortKey=M(m|s.technique.id,l.materialIndex),s.setTechniqueParameters(0,c),s.setTechniqueParameters(1,h)),s=r.createDrawParameters(),t.prepareDrawParameters(s),s.technique=this.technique,s.sortKey=M(m|this.techniqueIndex,l.materialIndex),t.renderUpdate=this.update,s.setTechniqueParameters(0,c),s.setTechniqueParameters(1,h);if(l.decal)s.userData=a.sharedUserData[a.passIndex.decal],t.drawParameters.push(s);else if(l.transparent)s.userData=a.sharedUserData[a.passIndex.transparent],t.drawParameters.push(s);else{0===v.indexOf("glowmap")||0===v.indexOf("lightmap")?t.diffuseDrawParameters=[]:(s.userData=a.sharedUserData[a.passIndex.diffuse],t.diffuseDrawParameters=[s]);if(a.shadowMaps&&this.shadowTechnique){var E=r.createDrawParameters();E.userData=a.sharedUserData[a.passIndex.diffuse],t.prepareDrawParameters(E),E.technique=this.shadowTechnique,E.sortKey=M(m|this.shadowTechniqueIndex,l.materialIndex),E.setTechniqueParameters(0,c),E.setTechniqueParameters(1,h),t.diffuseShadowDrawParameters=[E]}else t.diffuseShadowDrawParameters=t.diffuseDrawParameters}if(a.shadowMaps)if(this.shadowMappingUpdate&&!l.noshadows){s=r.createDrawParameters(),s.userData=a.sharedUserData[a.passIndex.shadow],t.prepareDrawParameters(s),t.shadowMappingDrawParameters=[s],u.shadowMappingUpdate=this.shadowMappingUpdate,s.technique=this.shadowMappingTechnique,s.sortKey=M(this.shadowMappingTechniqueIndex,g.rendererInfo.id);var S=r.createTechniqueParameters();t.shadowTechniqueParameters=S,s.setTechniqueParameters(0,S)}else l.noshadows=!0};a.defaultUpdateFn=k,a.defaultSkinnedUpdateFn=L,a.defaultPrepareFn=_;var D=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,C(n,r,t));var i=this.techniqueParameters;i.worldView=r.worldView},P=function(t){var n=this.node,r=n.rendererInfo;r.frameVisible!==n.frameVisible&&(r.frameVisible=n.frameVisible,C(n,r,t));var i=this.techniqueParameters;i.worldView=r.worldView;var s=this.skinController;s&&(i.skinBones=s.output,s.update())},H=function(t){var n,i=t.sharedMaterial,s=i.meta,o=i.techniqueParameters,u=t.techniqueParameters;t.drawParameters=[],n=r.createDrawParameters(),n.userData=a.sharedUserData[a.passIndex.glow],t.prepareDrawParameters(n),n.technique=a.skyboxTechnique,n.setTechniqueParameters(0,o),n.setTechniqueParameters(1,u),n.sortKey=M(n.technique.id,s.materialIndex),t.drawParameters.push(n),n=r.createDrawParameters(),n.userData=a.sharedUserData[a.passIndex.ambient],t.prepareDrawParameters(n),n.technique=a.skyboxTechnique,n.setTechniqueParameters(0,o),n.setTechniqueParameters(1,u),n.sortKey=M(O|n.technique.id,s.materialIndex),t.drawParameters.push(n),t.diffuseDrawParameters=[],t.diffuseShadowDrawParameters=[],t.renderUpdate=this.update},B=function(){this.techniqueParameters.world=this.node.world},j=function(){var t=this.techniqueParameters;t.world=this.node.world;var n=this.skinController;n&&(t.skinBones=n.output,n.update())},F=function(){this.techniqueParameters.world=this.node.world},I=function(){var t=this.techniqueParameters,n=this.node,r=n.worldUpdate;if(this.techniqueParametersUpdated!==r){this.techniqueParametersUpdated=r;var s=n.world;t.world=s,t.worldInverseTranspose=i.m33InverseTranspose(s,t.worldInverseTranspose)}},q=function(){var t=this.techniqueParameters,n=this.node,r=n.worldUpdate;if(this.techniqueParametersUpdated!==r){this.techniqueParametersUpdated=r;var s=n.world;t.world=s,t.worldInverseTranspose=i.m33InverseTranspose(s,t.worldInverseTranspose)}var o=this.skinController;o&&(t.skinBones=o.output,o.update())},R=function(s){if(!s.customGeometry){s.customGeometry=!0,g||(g=r.createIndexBuffer({numIndices:8,format:"USHORT",dynamic:!1,data:[1,0,2,5,4,3,2,1]}),y=r.createSemantics(["POSITION","TEXCOORD"]),b=new e(30),w=i.m43BuildIdentity());var o=s.geometry,u=o.semantics,a=o.vertexBuffer,f=s.surface,l=f.vertexData,c=f.indexData,h=r.createVertexBuffer({numVertices:6,attributes:["FLOAT3","FLOAT2"],dynamic:!0}),p={halfExtents:o.halfExtents,primitive:r.PRIMITIVE_TRIANGLE_STRIP,semantics:y,vertexBuffer:h,numIndices:8,first:0,indexBuffer:g,lastTimeVisible:!0,center:undefined,sourceVertices:undefined},d=o.center;d&&(p.center=d),s.geometry=p,s.surface=p,s.semantics=y;var v=r.SEMANTIC_NORMAL,m=r.SEMANTIC_TEXCOORD,E=a.stride,S=0;u[0]===v?(S+=3,u[1]===m&&(S+=2)):u[0]===m&&(S+=2,u[1]===v&&(S+=3));var x;c.length===4?x=c:c[3]!==0&&c[4]!==0&&c[5]!==0?x=[0,2,1,3]:c[3]!==1&&c[4]!==1&&c[5]!==1?x=[1,0,2,3]:x=[3,0,1,2],c=null;var T=x[0]*E+S,N=x[1]*E+S,C=x[2]*E+S,k=x[3]*E+S,L=l[T+0],A=l[T+1],O=l[T+2],M=l[N+0],D=l[N+1],P=l[N+2],H=l[C+0],B=l[C+1],j=l[C+2],F=l[k+0],I=l[k+1],q=l[k+2];l=null;var R=i.v3Build((L+M)*.5,(A+D)*.5,(O+P)*.5),U=i.v3Build((L+H)*.5,(A+B)*.5,(O+j)*.5),z=i.v3Build((M+F)*.5,(D+I)*.5,(P+q)*.5),W=i.v3Build((H+F)*.5,(B+I)*.5,(j+q)*.5),X,V;t.v3LengthSq(t.v3Sub(R,W))>t.v3LengthSq(t.v3Sub(U,z))?(X=R,V=W):(X=U,V=z);var $=t.v3Normalize(i.v3Build(M-L,D-A,P-O)),J=t.v3Normalize(i.v3Build(H-L,B-A,j-O)),K=t.v3Cross($,J);p.sourceVertices=[X,V,K],o.reference.remove(),_.call(this,s)}},U=function(t){var n=this.geometry,r=this.node,s,o,u,a,f,l,c,h,p,d,v,m,g,y,E,S,x=r.worldUpdate;if(this.techniqueParametersUpdated!==x){this.techniqueParametersUpdated=x;var T=r.world;this.techniqueParameters.world=w;var N=n.sourceVertices;s=i.m43TransformPoint(T,N[0],n.top),o=i.m43TransformPoint(T,N[1],n.bottom),u=i.m43TransformVector(T,N[2],n.normal),f=s[0],l=s[1],c=s[2],h=o[0],p=o[1],d=o[2],y=u[0],E=u[1],S=u[2],v=f-h,m=l-p,g=c-d;var C=v*v+m*m+g*g,k=C>0?1/Math.sqrt(C):0;v*=k,m*=k,g*=k,r.dynamic?(n.top=s,n.bottom=o,n.normal=u):(n.top=[f,l,c],n.bottom=[h,p,d],n.normal=[y,E,S]),n.tb=[v,m,g]}else s=n.top,o=n.bottom,a=n.tb,u=n.normal,f=s[0],l=s[1],c=s[2],h=o[0],p=o[1],d=o[2],v=a[0],m=a[1],g=a[2],y=u[0],E=u[1],S=u[2];var L=n.vertexBuffer,A=t.matrix,O=h-A[9],M=p-A[10],_=d-A[11];if(y*O+E*M+S*_<0){n.lastTimeVisible=!0;var D=this.sharedMaterial.meta.flareScale,P=O*O+M*M+_*_,H=P>0?1/Math.sqrt(P):0;O*=H,M*=H,_*=H;var B=M*g-_*m,j=_*v-O*g,F=O*m-M*v,I=j*_-F*M,q=F*O-B*_,R=B*M-j*O;B*=D,j*=D,F*=D,I*=D,q*=D,R*=D;var U=-2.5*D,z=O*U,W=M*U,X=_*U,V=b;V[0]=f-B+I+z,V[1]=l-j+q+W,V[2]=c-F+R+X,V[3]=1,V[4]=0,V[5]=f+B+I+z,V[6]=l+j+q+W,V[7]=c+F+R+X,V[8]=1,V[9]=1,V[10]=f,V[11]=l,V[12]=c,V[13]=.5,V[14]=0,V[15]=h+B-I+z,V[16]=p+j-q+W,V[17]=d+F-R+X,V[18]=1,V[19]=0,V[20]=h,V[21]=p,V[22]=d,V[23]=.5,V[24]=1,V[25]=h-B-I+z,V[26]=p-j-q+W,V[27]=d-F-R+X,V[28]=1,V[29]=1,L.setData(V,0,6)}else if(n.lastTimeVisible){n.lastTimeVisible=!1;var $;for($=0;$<30;$+=1)b[$]=0;L.setData(b,0,6)}},z=function(t){var n=this,r=function(t){n.shader=t,n.technique=t.getTechnique(n.techniqueName),n.techniqueIndex=n.technique.id};t.load(this.shaderName,r);if(a.shadowMaps){if(this.shadowMappingTechniqueName){var i=function(t){n.shadowMappingShader=t,n.shadowMappingTechnique=t.getTechnique(n.shadowMappingTechniqueName),n.shadowMappingTechniqueIndex=n.shadowMappingTechnique.id};t.load(this.shadowMappingShaderName,i)}if(this.shadowTechniqueName){var s=function(t){n.shadowShader=t,n.shadowTechnique=t.getTechnique(n.shadowTechniqueName),n.shadowTechniqueIndex=n.shadowTechnique.id};t.load(this.shadowShaderName,s)}}};a.loadTechniquesFn=z;var W,X,V="skinned",$="rigid";return W=N.create("rxgb_normalmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("rxgb_normalmap_specularmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("rxgb_normalmap_alphatest"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_alphatest_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_alphatest_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_alphatest_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("rxgb_normalmap_specularmap_alphatest"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_alphatest_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_alphatest_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_alphatest_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("rxgb_normalmap_glowmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_glowmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_glowmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_glowmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("rxgb_normalmap_specularmap_glowmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_glowmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"rxgb_normalmap_specularmap_glowmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"rxgb_normalmap_specularmap_glowmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("add"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"add",update:B,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"add_skinned",update:j,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("add_particle"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"add_particle",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("blend"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blend",update:B,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blend_skinned",update:j,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("blend_particle"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blend_particle",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("translucent"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"translucent",shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"translucent_skinned",update:j,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("translucent_particle"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"translucent_particle",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("filter"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"filter",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"filter_skinned",update:j,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("invfilter"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"invfilter",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("invfilter_particle"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"invfilter_particle",update:B,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("glass"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"glass",update:B,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("glass_env"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"glass_env",update:I,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("modulate2"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"modulate2",update:B,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"modulate2_skinned",update:j,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("skybox"),o.add(W),X={prepare:H,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"skybox",update:F,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("env"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"env",update:I,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"env_skinned",update:q,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("flare"),o.add(W),X={prepare:R,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"add",update:U,loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("blinn"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blinn",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"blinn_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blinn_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"blinn_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("blinn_nocull"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blinn_nocull",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"blinn_shadows_nocull",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"blinn_skinned_nocull",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"blinn_skinned_shadows_nocull",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap_specularmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap_specularmap_alphamap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_alphamap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_alphamap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_alphamap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_alphamap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap_alphatest"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_alphatest",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_alphatest_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),W=N.create("normalmap_specularmap_alphatest"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_alphatest_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_alphatest_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_alphatest_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap_glowmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_glowmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_glowmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_glowmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_glowmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("normalmap_specularmap_glowmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_glowmap_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"normalmap_specularmap_glowmap_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"normalmap_specularmap_glowmap_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),o.map("default","blinn"),o.map("lambert","blinn"),o.map("phong","blinn"),W=N.create("glowmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"glowmap",update:D,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"glowmap_skinned",update:P,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("constant"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"flat",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"flat_shadows",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"flat_skinned",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"flat_skinned_shadows",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("constant_nocull"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"flat_nocull",update:k,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"flat_shadows_nocull",loadTechniques:z},X.loadTechniques(s),W.add($,X),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"flat_skinned_nocull",update:L,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"skinned",shadowMappingUpdate:v,shadowShaderName:"shaders/forwardrenderingshadows.cgfx",shadowTechniqueName:"flat_skinned_shadows_nocull",loadTechniques:z},X.loadTechniques(s),W.add(V,X),W=N.create("lightmap"),o.add(W),X={prepare:_,shaderName:"shaders/forwardrendering.cgfx",techniqueName:"lightmap",update:D,shadowMappingShaderName:"shaders/shadowmapping.cgfx",shadowMappingTechniqueName:"rigid",shadowMappingUpdate:d,loadTechniques:z},X.loadTechniques(s),W.add($,X),a},n.version=1,n.nextNodeID=0,n}(),H=function(){function e(){}return e.encodeByteUnsignedFloat=function(e){return e<=0?0:e>=1?255:e*256|0},e.decodeByteUnsignedFloat=function(e){return e/256},e.encodeByteSignedFloat=function(e){return this.encodeByteUnsignedFloat((e+1)*.5)},e.decodeByteSignedFloat=function(t){return e.decodeByteUnsignedFloat(t)*2-1},e.encodeHalfUnsignedFloat=function(e){if(e<=0)return 0;if(e>=1)return 65535;var t=e*256%1*256,n=e%1*256;return n-=t/256,t|n<<8},e.decodeHalfUnsignedFloat=function(e){var t=e&255,n=e>>>8;return t/65536+n/256},e.encodeHalfSignedFloat=function(t){return e.encodeHalfUnsignedFloat((t+1)*.5)},e.decodeHalfSignedFloat=function(t){return e.decodeHalfUnsignedFloat(t)*2-1},e.encodeUnsignedFloat=function(e){if(e<=0)return 0;if(e>=1)return-1;var t=e*16777216%1*256,n=e*65536%1*256,r=e*256%1*256,i=e%1*256;return i-=r/256,r-=n/256,n-=t/256,t|n<<8|r<<16|i<<24},e.decodeUnsignedFloat=function(e){var t=e&255,n=e>>>8&255,r=e>>>16&255,i=e>>>24;return t/4294967296+n/16777216+r/65536+i/256},e.encodeSignedFloat=function(t){return e.encodeUnsignedFloat((t+1)*.5)},e.decodeSignedFloat=function(t){return e.decodeUnsignedFloat(t)*2-1},e.encodeUnsignedFloat4=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t=(t<0?0:t>1?1:t)*255,n=(n<0?0:n>1?1:n)*255,r=(r<0?0:r>1?1:r)*255,i=(i<0?0:i>1?1:i)*255,t|n<<8|r<<16|i<<24},e.decodeUnsignedFloat4=function(e,n){return n===undefined&&(n=t.v4BuildZero()),n[0]=(e&255)/255,n[1]=(e>>>8&255)/255,n[2]=(e>>>16&255)/255,n[3]=(e>>>24)/255,n},e.encodeUnsignedFloat2=function(t){var n=e.encodeHalfUnsignedFloat(t[0]),r=e.encodeHalfUnsignedFloat(t[1]);return n|r<<16},e.encodeUnsignedFloat2xy=function(t,n){return t=e.encodeHalfUnsignedFloat(t),n=e.encodeHalfUnsignedFloat(n),t|n<<16},e.decodeUnsignedFloat2=function(n,r){return r===undefined&&(r=t.v2BuildZero()),r[0]=e.decodeHalfUnsignedFloat(n&65535),r[1]=e.decodeHalfUnsignedFloat(n>>>16),r},e.encodeSignedFloat2=function(t){var n=e.encodeHalfSignedFloat(t[0]),r=e.encodeHalfSignedFloat(t[1]);return n|r<<16},e.decodeSignedFloat2=function(n,r){return r===undefined&&(r=t.v2BuildZero()),r[0]=e.decodeHalfSignedFloat(n&65535),r[1]=e.decodeHalfSignedFloat(n>>>16),r},e.version=1,e}(),B=function(){function e(){this.root=null}return e.gen=function(e,t,n){return{w:t,h:n,data:e,parent:null,child:null,height:0}},e.prototype.insert=function(t,n,r){var i=e.gen(t,n,r);if(!this.root)this.root=i;else{var s=this.root;while(s.child){var o=s.child[0],u=s.child[1],a=(s.w>i.w?s.w:i.w)+(s.h>i.h?s.h:i.h),f=a-(s.w+s.h),l=(o.w>i.w?o.w:i.w)+(o.h>i.h?o.h:i.h)+f,c=(u.w>i.w?u.w:i.w)+(u.h>i.h?u.h:i.h)+f;o.child&&(l-=o.w+o.h),u.child&&(c-=u.w+u.h);if(a<l&&a<c)break;s=l<c?o:u}var h=s,p=h.parent,d=e.gen(null,i.w>h.w?i.w:h.w,i.h>h.h?i.h:h.h);d.parent=p,d.height=h.height+1,h.parent=d,i.parent=d,d.child=[h,i],p?p.child[p.child[0]===h?0:1]=d:this.root=d,this.filterUp(d)}return i},e.prototype.remove=function(e){if(e===this.root)this.root=null;else{var t=e.parent,n=t.parent,r=t.child[t.child[0]===e?1:0];n?(n.child[n.child[0]===t?0:1]=r,r.parent=n,this.filterUp(n)):(this.root=r,r.parent=null)}},e.prototype.filterUp=function(e){while(e){e=this.balance(e);var t=e.child[0],n=e.child[1];e.height=1+(t.height>n.height?t.height:n.height),e.w=t.w>n.w?t.w:n.w,e.h=t.h>n.h?t.h:n.h,e=e.parent}},e.prototype.balance=function(e){if(!e.child||e.height<2)return e;var t=e.child[0],n=e.child[1],r=n.height-t.height;if(r>=-1&&r<=1)return e;var i,s,o;r>0?(i=n,s=t,o=1):(i=t,s=n,o=0);var u=i.child[0],a=i.child[1];i.child[1-o]=e,i.parent=e.parent,e.parent=i,i.parent?i.parent.child[i.parent.child[0]===e?0:1]=i:this.root=i;var f,l;return u.height>a.height?(f=u,l=a):(f=a,l=u),i.child[o]=f,e.child[o]=l,l.parent=e,e.w=s.w>l.w?s.w:l.w,e.h=s.h>l.h?s.h:l.h,i.w=e.w>f.w?e.w:f.w,i.h=e.h>f.h?e.h:
f.h,e.height=1+(s.height>l.height?s.height:l.height),i.height=1+(e.height>f.height?e.height:f.height),i},e.prototype.traverse=function(e){this.stack=this.stack||[];var t=this.stack;this.root&&t.push(this.root);while(t.length!==0){var n=t.pop();e(n)&&n.child&&(t.push(n.child[0]),t.push(n.child[1]))}},e.prototype.searchBestFit=function(e,t,n){this.stack=this.stack||[];var r=this.stack;this.root&&r.push(this.root);var i=Number.POSITIVE_INFINITY,s=null;while(r.length!==0){var o=r.pop();if(o.w>=e&&o.h>=t)if(o.child)r.push(o.child[0]),r.push(o.child[1]);else{var u=n(e,t,o.data);if(u===null){s=o;while(r.length!==0)r.pop();break}u<i&&(i=u,s=o)}}return s},e}(),j=function(){function e(e,t){this.free=new B,this.bins=[],this.maxWidth=e,this.maxHeight=t}return e.prototype.release=function(e){this.free.insert(e,e.w,e.h)},e.prototype.releaseSpace=function(e,t,n,r,i){if(r!==0&&i!==0){var s={x:t,y:n,w:r,h:i,bin:e};this.free.insert(s,r,i)}},e.costFit=function(e,t,n){if(n.w===e&&n.h===t)return null;var r=n.w/e,i=n.h/t,s=Math.sin((1-r*r)*Math.PI),o=Math.sin((1-i*i)*Math.PI);return s*o+(s+o)},e.prototype.pack=function(t,n){if(t>this.maxWidth||n>this.maxHeight)return null;var r=0,i=this.free.searchBestFit(t,n,e.costFit);return i?(this.free.remove(i),this.split(i.data,t,n)):this.grow(t,n)},e.prototype.split=function(e,t,n){return e.w-t<e.h-n?(this.releaseSpace(e.bin,e.x,e.y+n,e.w,e.h-n),this.releaseSpace(e.bin,e.x+t,e.y,e.w-t,n)):(this.releaseSpace(e.bin,e.x,e.y+n,t,e.h-n),this.releaseSpace(e.bin,e.x+t,e.y,e.w-t,e.h)),{x:e.x,y:e.y,w:t,h:n,bin:e.bin}},e.nearPow2Geq=function(e){return 1<<Math.ceil(Math.log(e)/Math.log(2))},e.prototype.grow=function(t,n,r){typeof r=="undefined"&&(r=0),r>=this.bins.length&&this.bins.push({x:0,y:0,w:0,h:0,bin:r});var i=this.bins[r],s=i.x+i.w+t<=this.maxWidth,o=i.y+i.h+n<=this.maxHeight,u=e.nearPow2Geq(i.w)!==e.nearPow2Geq(i.w+t),a=e.nearPow2Geq(i.h)!==e.nearPow2Geq(i.h+n),f=u===a?Math.abs(i.h-n)>Math.abs(i.w-t):!u;return s&&f?this.growRight(i,t,n):o?this.growDown(i,t,n):this.grow(t,n,r+1)},e.prototype.growRight=function(e,t,n){var r={x:e.x+e.w,y:e.y,w:t,h:n,bin:e.bin};return n<e.h?this.releaseSpace(e.bin,e.x+e.w,e.y+n,t,e.h-n):(this.releaseSpace(e.bin,e.x,e.y+e.h,e.w,n-e.h),e.h=n),e.w+=t,r},e.prototype.growDown=function(e,t,n){var r={x:e.x,y:e.y+e.h,w:t,h:n,bin:e.bin};return t<e.w?this.releaseSpace(e.bin,e.x+t,e.y+e.h,e.w-t,n):(this.releaseSpace(e.bin,e.x+e.w,e.y,t-e.w,e.h),e.w=t),e.h+=n,r},e}(),F=function(){function e(e){this.compare=e,this.heap=[]}return e.prototype.swap=function(e,t){var n=this.heap,r=n[e],i=n[t],s;s=r.key,r.key=i.key,i.key=s,s=r.data,r.data=i.data,i.data=s},e.prototype.clear=function(t){var n=this.heap,r=n.length;while(r>0){r-=1;var i=n.pop();t&&t(i.data),i.key=null,i.data=null,e.pool.push(i)}},e.prototype.removeNode=function(t){var n=this.heap,r=n.length-1;if(t!==r){this.swap(t,r);var i=t-1>>>1;if(t===0||this.compare(n[i].key,n[t].key))for(;;){var s=(t<<1)+1,o=(t<<1)+2,u=t;s<r&&this.compare(n[s].key,n[u].key)&&(u=s),o<r&&this.compare(n[o].key,n[u].key)&&(u=o);if(t===u)break;this.swap(t,u),t=u}else while(i!==t&&this.compare(n[t].key,n[i].key)){this.swap(t,i),t=i;if(i===0)break;i=i-1>>>1}}var a=n.pop();a.key=null,a.data=null,e.pool.push(a)},e.prototype.findNode=function(e){var t=0,n=this.heap,r=n.length;while(t<r){if(n[t].data===e)break;t+=1}return t},e.prototype.remove=function(e){var t=this.findNode(e);return t===this.heap.length?!1:(this.removeNode(t),!0)},e.prototype.insert=function(t,n){var r=this.heap,i=r.length,s=e.pool;if(s.length>0){var o=s.pop();o.data=t,o.key=n,r.push(o)}else r.push({data:t,key:n});if(i!==0){var u=i-1>>>1;while(u!==i&&this.compare(r[i].key,r[u].key)){this.swap(i,u),i=u;if(u===0)break;u=u-1>>>1}}},e.prototype.headData=function(){return this.heap.length===0?null:this.heap[0].data},e.prototype.headKey=function(){return this.heap.length===0?null:this.heap[0].key},e.prototype.pop=function(){if(this.heap.length===0)return null;var e=this.heap[0].data;return this.removeNode(0),e},e.pool=[],e}(),I=function(){function e(){this.heap=new F(e.compare),this.time=0}return e.compare=function(e,t){return e<t},e.prototype.clear=function(e){this.heap.clear(e),this.time=0},e.prototype.remove=function(e){return this.heap.remove(e)},e.prototype.insert=function(e,t){this.heap.insert(e,this.time+t)},e.prototype.update=function(e){this.time+=e},e.prototype.hasNext=function(){var e=this.heap.headKey();return e!==null&&e<=this.time},e.prototype.next=function(){return this.heap.pop()},e.prototype.iter=function(e){while(this.hasNext())e(this.next())},e}(),q=function(){function e(e){this.heapSize=e<<1,this.heap=new Float32Array(this.heapSize),this.time=0,this.wasForced=!1,this.lastDeath=0;var t;for(t=0;t<e;t+=1)this.heap[(t<<1)+1]=t}return e.prototype.swap=function(e,t){var n=this.heap,r=n[e];n[e]=n[t],n[t]=r,r=n[e+1],n[e+1]=n[t+1],n[t+1]=r},e.prototype.clear=function(){var e,t=this.heapSize>>>1;for(e=0;e<t;e+=1)this.heap[e<<1]=0;this.time=0,this.wasForced=!1,this.lastDeath=0},e.prototype.replace=function(e,t){var n=this.heap,r=this.heapSize-2;if(e!==r){this.swap(e,r);var i=e-2>>>2<<1;if(e===0||n[e]>=n[i])for(;;){var s=(e<<1)+2,o=(e<<1)+4,u=e;s<r&&n[s]<n[u]&&(u=s),o<r&&n[o]<n[u]&&(u=o);if(e===u)break;this.swap(e,u),e=u}else while(i!==e&&n[e]<n[i]){this.swap(e,i),e=i;if(i===0)break;i=i-2>>>2<<1}}e=r,n[e]=t;if(e!==0){var i=e-2>>>2<<1;while(i!==e&&n[e]<n[i]){this.swap(e,i),e=i;if(i===0)break;i=i-2>>>2<<1}}return n[e+1]},e.prototype.find=function(e){var t=0,n=this.heap,r=this.heapSize;while(t<r){if(n[t+1]===e)break;t+=2}return t},e.prototype.removeParticle=function(e){this.replace(this.find(e),0)},e.prototype.updateParticle=function(e,t){var n=this.find(e),r=this.heap[n]+t;r<this.time&&(r=this.time),r>this.lastDeath&&(this.lastDeath=r),this.replace(n,r)},e.prototype.create=function(e,t){typeof t=="undefined"&&(t=!1);if(t&&isFinite(this.heap[0])||this.heap[0]<=this.time){this.wasForced=this.heap[0]>this.time;var n=this.heap[1],r=e+this.time;return r>this.lastDeath&&(this.lastDeath=r),this.replace(0,r),n}return null},e.prototype.update=function(e){return this.time+=e,this.time<this.lastDeath},e}(),R;(function(e){e[e.cNone=0]="cNone",e[e.cHalf=1]="cHalf",e[e.cFull=2]="cFull"})(R||(R={}));var U;(function(e){e[e.sDirect=0]="sDirect",e[e.sNormalized=1]="sNormalized"})(U||(U={}));var z=function(){function e(){this.log=[],this.uncheckedErrorCount=0,this.uncheckedWarningCount=0}return e.wrap=function(e){return W.isString(e)?'"'+e+'"':""+e},e.prototype.empty=function(e){if(e)return this.log.length===0;var t=this.log,n=t.length,r;for(r=0;r<n;r+=1)if(t[r].error)return!1;return!0},e.prototype.error=function(t){this.uncheckedErrorCount+=1,this.log.push({error:!0,log:e.ERROR+"::"+t})},e.prototype.warning=function(t){this.uncheckedWarningCount+=1,this.log.push({error:!1,log:e.WARNING+"::"+t})},e.prototype.checkErrorState=function(e){return this.uncheckedWarningCount!==0&&(this.log.push({error:!1,log:"Warnings ("+this.uncheckedWarningCount+")"}),this.uncheckedWarningCount=0),this.uncheckedErrorCount!==0?(this.log.push({error:!0,log:"Errors ("+this.uncheckedErrorCount+")"}),e&&this.log.push({error:!0,log:e}),this.uncheckedErrorCount=0,!0):!1},e.prototype.fail=function(e){var t=this.log;this.checkErrorState(e)||t.push({error:!0,log:e});var n=t.length,r,i="";for(r=0;r<n;r+=1)r!==0&&(i+="\n"),i+=t[r].log;return this.log=[],i},e.ERROR="ERROR",e.WARNING="WARNING",e}(),W=function(){function e(){}return e.isTypedArray=function(t){return e.arrayTypes.indexOf(Object.prototype.toString.call(t))!==-1},e.isArray=function(t){return e.isTypedArray(t)||Object.prototype.toString.call(t)==="[object Array]"},e.isFunction=function(e){return Object.prototype.toString.call(e)==="[object Function]"},e.isNumber=function(e){return Object.prototype.toString.call(e)==="[object Number]"},e.isString=function(e){return Object.prototype.toString.call(e)==="[object String]"},e.isBoolean=function(e){return Object.prototype.toString.call(e)==="[object Boolean]"},e.isObject=function(e){return Object.prototype.toString.call(e)==="[object Object]"},e.isNullUndefined=function(e){return e===null||e===undefined},e.copy=function(t,n,r){return typeof r=="undefined"&&(r=!0),e.isTypedArray(t)&&!n?new t.constructor(t):e.isArray(t)?e.copyElements(t,n,r):e.isObject(t)?r?e.copyFields(t,n):t:t},e.copyElements=function(t,n,r){typeof r=="undefined"&&(r=!0);if(!t)return;n||(n=[]);var i,s=t.length;for(i=0;i<s;i+=1)n[i]=e.copy(t[i],n[i],r);return n},e.copyFields=function(t,n,r){typeof r=="undefined"&&(r=!0);if(!t)return n;n||(n={});for(var i in t)t.hasOwnProperty(i)&&(n[i]=e.copy(t[i],n[i],r));return n},e.arrayTypes=["[object Float64Array]","[object Float32Array]","[object Int32Array]","[object Int16Array]","[object Int8Array]","[object Uint32Array]","[object Uint16Array]","[object Uint8Array]"],e}(),X=function(){function e(){}return e.extraFields=function(e,t,n,r){for(var i in n)n.hasOwnProperty(i)&&r.indexOf(i)===-1&&e.warning(t+" has extra field '"+i+"'")},e.field=function(e,t,n,r){return n.hasOwnProperty(r)?n[r]:(e.error("No field '"+r+"' found on "+t),null)},e.stringField=function(t,n,r,i){var s=e.field(t,n,r,i);return r.hasOwnProperty(i)&&!W.isString(s)?(t.error("Field '"+i+"' of "+n+" is not a string ("+z.wrap(s)+")"),null):s},e.numberField=function(t,n,r,i){var s=e.field(t,n,r,i);return r.hasOwnProperty(i)&&!W.isNumber(s)?(t.error("Field '"+i+"' of "+n+" is not a number ("+z.wrap(s)+")"),null):isFinite(s)?s:(t.error("Field '"+i+"' of "+n+" is nan or infinite ("+z.wrap(s)+")"),null)},e.checkNumber=function(e,t,n,r){return W.isNumber(r)?isFinite(r)?r:(e.error(n+" of "+t+" is nan or infinite ("+z.wrap(r)+")"),null):(e.error(n+" of "+t+" is not a number ("+z.wrap(r)+")"),null)},e.checkNullNumber=function(t,n,r,i){return W.isNullUndefined(i)?null:e.checkNumber(t,n,r,i)},e.maybeField=function(e,t,n,r){return e.hasOwnProperty(t)?n(e[t]):r()},e.runField=function(e,t,n,r,i){return n.hasOwnProperty(r)?i(n[r]):(e.error("No field '"+r+"' found on "+t),null)},e.checkVector=function(t,n,r,i,s){if(!W.isArray(s)||s.length!==i)return t.error("Field '"+r+"' of "+n+" should be a Vector"+i+" object"),null;var o=new Float32Array(i),u;for(u=0;u<i;u+=1)o[u]=e.checkNullNumber(t,n,"element "+u,s[u])||0;return o},e.checkBoolean=function(e,t,n,r){return W.isBoolean(r)?r:(e.error("Field '"+n+"' of "+t+" should be a boolean"),null)},e.checkString=function(e,t,n,r){return W.isString(r)?r:(e.error("Field '"+n+"' of "+t+" should be a string"),null)},e.typeAttr=function(e,t,n,r,i){if(n===null)return null;var s=function(e){return e===null&&r||W.isNumber(e)},o=function(n,r){if(!W.isArray(n))return e.error("Value '"+z.wrap(n)+"' should be a float"+r+" for "+t),null;var i=n,o=i.length;o!==r&&(e.error("Value '"+z.wrap(n)+"' should have "+r+" elements for float "+r+t),n=null);var u;for(u=0;u<o;u+=1)s(i[u])||(e.error("Element "+u+" of value '"+z.wrap(n)+"' should be a number ("+z.wrap(i[u])+") for "+t),n=null);return n};switch(n){case"tFloat2":return o(i,2);case"tFloat4":return o(i,4);case"tFloat":default:if(!s(i))return e.error("Value '"+z.wrap(i)+"' should be a number for "+t),null;return[i]}},e.defaultAttr=function(e,t){typeof t=="undefined"&&(t=null);if(e===null)return null;switch(e){case"tFloat2":return[t,t];case"tFloat4":return[t,t,t,t];case"tFloat":default:return[t]}},e.parseSystem=function(t,n){var r;if(!W.isArray(n))t.error("System definition must be an array of attribute defintions"),r=null;else{r=[];var i=n,s=i.length,o;for(o=0;o<s;o+=1)r[o]=e.parseSystemAttribute(t,i[o]);for(o=0;o<s;o+=1){var u;for(u=o+1;u<s;u+=1)r[o].name===r[u].name&&t.error("System definition has conflicting attribute declarations for '"+r[o].name+"'")}}return t.checkErrorState("System parse failed!")?null:r},e.hasTextureIndex=function(e,t){var n=e.length,r;for(r=0;r<n;r+=1){var i=e[r];switch(i.type){case"tFloat":case"tFloat2":case"tFloat4":break;default:if(t===i.type)return!0}}return!1},e.parseSystemAttribute=function(t,n){var r=e.stringField(t,"system attribute",n,"name");r!==null&&r.length>14&&r.substr(r.length-14)==="-interpolation"&&(t.error("System attribute cannot have '-interpolation' as a suffix ("+r+")"),r=null);var i=r===null?"":" '"+r+"'",s=r===null?"'s":" '"+r+"'s",o=e.stringField.bind(null,t,"system attribute"+i),u=e.parseInterpolator.bind(null,t,"system attribute"+s+" default-interpolation field"),a=o(n,"type"),f=null;if(a!==null)switch(a){case"float":f="tFloat";break;case"float2":f="tFloat2";break;case"float4":f="tFloat4";break;default:a.substr(0,7)==="texture"?f=parseFloat(a.substr(7)):t.error("Unknown attribute type '"+a+"' for system attribute"+i)}var l=function(n){return e.typeAttr.bind(null,t,"system attribute"+s+" "+n+" field",f)},c=e.maybeField(n,"default",l("default").bind(null,!1),e.defaultAttr.bind(null,f,0)),h=e.maybeField(n,"default-interpolation",u,e.interpolators.linear.bind(null)),p=function(r){if(f===null)return null;switch(f){case"tFloat":case"tFloat2":case"tFloat4":return e.maybeField(n,r,l(r).bind(null,!0),e.defaultAttr.bind(null,f,null));default:if(n.hasOwnProperty(r))return t.error(r+" is not accepted for system texture attribute"+i),null}},d=p("min"),v=p("max"),m=e.maybeField(n,"compress",function(e){switch(e){case"none":return R.cNone;case"half":return R.cHalf;case"full":return R.cFull;default:return t.error("Unknown compression type '"+e+"' for system attribute "+i),null}},function(){return R.cFull}),g=null;if(f!==null)switch(f){case"tFloat":case"tFloat2":case"tFloat4":g=e.maybeField(n,"storage",function(e){switch(e){case"direct":return U.sDirect;case"normalized":return U.sNormalized;default:return t.error("Unknown storage type '"+e+"' for system attribute "+i),null}},function(){return U.sNormalized});break;default:n.hasOwnProperty("storage")&&t.error("Storage type is not accepted for system texture attribute"+i)}return e.extraFields(t,"system attribute"+i,n,["name","type","default","default-interpolation","min","max","storage","compress"]),{name:r,type:f,defaultValue:c,defaultInterpolator:h,minValue:d,maxValue:v,compress:m,storage:g}},e.parseInterpolator=function(t,n,r){if(W.isString(r)){var i=r;switch(i){case"none":return e.interpolators.none(null);case"linear":return e.interpolators.linear(null);case"catmull":return e.interpolators.catmull(null);default:return t.error("Unknown interpolator type '"+i+"' for "+n),null}}else{if(r===null)return t.error("Interpolator cannot be null for "+n),null;if(!W.isObject(r))return t.error("Invalid interpolator for "+n+". Should be an interpolator name, or complex interpolator definition, not "+z.wrap(r)),null;var s=r,o=e.stringField(t,n,s,"type");if(o===null)return t.error("complex interpolator type cannot be null for "+n),null;switch(o){case"none":return e.extraFields(t,n,s,["type"]),e.interpolators.none(null);case"linear":return e.extraFields(t,n,s,["type"]),e.interpolators.linear(null);case"catmull":return e.extraFields(t,n,s,["type"]),e.interpolators.catmull(null);case"cardinal":e.extraFields(t,n,s,["type","tension"]);var u=e.numberField(t,n,s,"tension");return e.interpolators.cardinal({tension:u});default:return t.error("Unknown complex interpolator type '"+o+"' for "+n),null}}},e.zero=function(){return 0},e.parseParticle=function(t,n){if(n===null)return t.error("particle definition cannot be null"),t.checkErrorState("Particle parse failed!"),null;var r=e.stringField(t,"particle",n,"name"),i=r===null?"":" '"+r+"'",s=r===null?"'s":" '"+r+"'s",o=e.stringField.bind(null,t,"particle"+i),u=e.numberField.bind(null,t,"particle"+i),a=e.maybeField(n,"fps",e.checkNumber.bind(null,t,"particle"+i,"fps"),function(){return 30});a!==null&&a<=0&&(t.error("particle"+s+" fps ("+a+") must be > 0"),a=null);var f=[];for(var l in n){if(!n.hasOwnProperty(l))continue;l.substr(0,7)==="texture"&&(l.substr(l.length-5)==="-size"?f.push(l.substr(0,l.length-5)):f.push(l))}var c={},h={},p=f.length,d,v;for(d=0;d<p;d+=1){var m=f[d];if(n.hasOwnProperty(m)&&!W.isArray(n[m]))t.error("particle"+s+" "+l+" should be an Array");else if(n.hasOwnProperty(m)){var g=n[m],y=g.length,b=[];for(v=0;v<y;v+=1)b.push(e.typeAttr(t,"element of particle"+s+" "+l,"tFloat4",!1,g[v]));c[m]=b.concat()}n.hasOwnProperty(m+"-size")&&(h[m]=e.typeAttr(t,"particle"+s+" "+l+"-size","tFloat2",!1,n[m+"-size"]))}var w=e.field(t,"particle"+i,n,"animation");n.hasOwnProperty("animation")&&!W.isArray(w)&&(t.error("particle"+s+" animation must be an array"),w=null);var E=null;if(w!==null){var S=w;if(S.length===0)t.error("particle"+s+" animation is empty"),E=null;else{E=[],p=S.length;for(d=0;d<p;d+=1){var x=S[d],T="particle"+s+" animation snapshot";if(!W.isObject(x)){t.error(T+" should be an object"),E[d]=null;continue}var N=x,C;d===0?(C=e.maybeField(N,"time",e.checkNumber.bind(null,t,T,"time"),e.zero),C!==0&&(t.error("first "+T+" time must be 0"),C=null)):(C=e.numberField(t,T,N,"time"),C!==null&&C<=0&&(t.error(T+" time must be positive"),C=null));var k={},L={};for(var l in N){if(!N.hasOwnProperty(l)||l==="time")continue;if(l.length>14&&l.substr(l.length-14)==="-interpolation"){var A=l.substr(0,l.length-14);L[A]=e.parseInterpolator(t,T+" attribute '"+A+"'",N[l])}else k[l]=e.parseAttributeValue(t,T+" attribute '"+l+"'",N[l])}E[d]={time:C,attributes:k,interpolators:L}}}}var O=[];p=f.length;for(d=0;d<p;d+=1)O.push(f[d]+"-size");return e.extraFields(t,"particle"+i,n,f.concat(O).concat(["name","fps","animation"])),t.checkErrorState("Particle"+i+" parse failed!")?null:{name:r,fps:a,animation:E,textureUVs:c,textureSizes:h}},e.parseAttributeValue=function(e,t,n){if(n===null)return e.error(t+" cannot be null"),null;if(W.isNumber(n))return[n];if(W.isArray(n)){var r=n,i=r.length,s;for(s=0;s<i;s+=1){var o=r[s];if(!W.isNumber(o))return e.error("Element of "+t+" has none number value ("+o+")"),null}return r.length!==2&&r.length!==4?(e.error(t+" should have either 2 or 4 elements for float2/float4 value"),null):r}return e.error(t+" has unrecognised value type"),null},e.interpolators={none:function(e){return{type:"none",offsets:[-1],fun:function(e,t,n){return e[0].concat()}}},linear:function(e){return{type:"linear",offsets:[-1,1],fun:function(e,t,n){if(!e[1])return e[0].concat();var r=[],i=e[0].length,s;for(s=0;s<i;s+=1)r[s]=e[0][s]*(1-n)+e[1][s]*n;return r}}},cardinal:function(e){return{type:"cardinal",offsets:[-2,-1,1,2],fun:function(t,n,r){var i=t[1].length,s=t[1],o=n[1],u=t[0]||s,a=n[0]||o,f=t[2]||s,l=n[2]||o,c=t[3]||f,h=n[3]||l,p=r*r,d=p*r,v=2*d-3*p+1,m=-2*d+3*p,g=d-2*p+r,y=d-p,b=[],w;for(w=0;w<i;w+=1){var E=(1-e.tension)*(f[w]-u[w])/(l-a),S=(1-e.tension)*(c[w]-s[w])/(h-o);isNaN(E)&&(E=0),isNaN(S)&&(S=0),b[w]=s[w]*v+E*g+S*y+f[w]*m}return b}}},catmull:function(t){var n=e.interpolators.cardinal({tension:0});return n.type="catmull",n}},e}(),V=function(){function e(){}return e.buildAnimationTexture=function(e,t,n,r){return e.createTexture({name:"ParticleBuilder AnimationTexture",width:t,height:n,depth:1,format:e.PIXELFORMAT_R8G8B8A8,mipmaps:!1,cubemap:!1,renderable:!1,dynamic:!1,data:r})},e.nearPow2Geq=function(e){return 1<<Math.ceil(Math.log(e)/Math.log(2))},e.packTextures=function(n){var r=n.graphicsDevice,i=n.textures,s=n.borderShrink;s===undefined&&(s=4);var o,u,a,f;if(!e.packedTextureVertices){o=e.packedTextureVertices=r.createVertexBuffer({numVertices:4,attributes:[r.VERTEXFORMAT_FLOAT2],dynamic:!1,data:[0,0,1,0,0,1,1,1]}),u=e.packedTextureSemantics=r.createSemantics([r.SEMANTIC_POSITION]),a=e.packedCopyParameters=r.createTechniqueParameters({dim:[0,0],dst:[0,0,0,0]});var l=r.createShader({version:1,name:"particles-packer.cgfx",samplers:{src:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071}},parameters:{src:{type:"sampler2D"},dim:{type:"float",columns:2},dst:{type:"float",columns:4},border:{type:"float"}},techniques:{pack:[{parameters:["dim","dst","border","src"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_pack","fp_pack"]}]},programs:{fp_pack:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _ret_0;uniform sampler2D src;void main()\n{_ret_0=texture2D(src,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp_pack:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;\nvec4 _outPosition1;vec2 _outUV1;uniform vec2 dim;uniform vec4 dst;uniform float border;void main()\n{vec2 _xy;vec2 _wh;vec2 _TMP4;_xy=dst.xy*2.0-1.0;_wh=(dst.zw*2.0-1.0)-_xy;_TMP4=_xy+_wh*ATTR0.xy;_outPosition1=vec4(_TMP4.x,_TMP4.y,0.0,1.0);_outUV1=ATTR0.xy+((ATTR0.xy*2.0-1.0)*border)/dim;tz_TexCoord[0].xy=_outUV1;gl_Position=_outPosition1;}"}}});f=e.packedCopyTechnique=l.getTechnique("pack")}else o=e.packedTextureVertices,u=e.packedTextureSemantics,a=e.packedCopyParameters,f=e.packedCopyTechnique;var c=[],h=i.length,p;for(p=0;p<h;p+=1){var d=i[p],v=c.indexOf(d);v!==-1?c[v].mapping.push(p):c.push({texture:d,mapping:[p],store:null})}c.sort(function(e,t){return t.texture.width+t.texture.height-(e.texture.width+e.texture.height)});var m=r.maxSupported("TEXTURE_SIZE"),g=new j(m,m),y,b=c.length;for(p=0;p<b;p+=1){y=c[p],y.store=g.pack(y.texture.width,y.texture.height);if(y.store.bin!==0)throw"Packing textures would require more than the maximum size possible"}var w=g.bins[0],E=e.nearPow2Geq(w.w),S=e.nearPow2Geq(w.h),x=1/E,T=1/S,N=s*x,C=s*T,k,L=[],A=[];for(k=0;k<b;k+=1){y=c[k];var O=y.store,M=O.x*x,_=O.y*T,D=O.w*x,P=O.h*T,H=t.v4Build(M+N,_+C,D-2*N,P-2*C),B=y.mapping.length,F;for(F=0;F<B;F+=1)L[y.mapping[F]]=H;A[k]=t.v4Build(M,_,M+D,_+P)}var I=function(){r.setStream(o,u),r.setTechnique(f),a.border=s;var e=r.createTexture({name:"ParticleBuilder Packed-Texture",width:E,height:S,depth:1,format:r.PIXELFORMAT_R8G8B8A8,mipmaps:!0,cubemap:!1,renderable:!0,dynamic:!0}),t=r.createRenderTarget({colorTexture0:e});r.beginRenderTarget(t);var n,i=a.dim;for(n=0;n<b;n+=1)y=c[n],a.dst=A[n],i[0]=y.texture.width,i[1]=y.texture.height,a.src=y.texture,r.setTechniqueParameters(a),r.draw(r.PRIMITIVE_TRIANGLE_STRIP,4,0);return r.endRenderTarget(),t.destroy(),e};return{texture:I,uvMap:L}},e.compile=function(t){var n=t.graphicsDevice,r=t.particles,i=t.system,s=t.uvMap,o=t.tweaks,u=t.failOnWarnings;u===undefined&&(u=!0);var a=new z,f,l,c=r.length,h;if(t.alreadyParsed){f=i,l=[];for(h=0;h<c;h+=1){var p=r[h],d=W.copy(p.textureUVs),v=[],m=p.animation,g=m.length,y;for(y=0;y<g;y+=1){var b=m[y],w=b.interpolators,E={};for(var S in w)w.hasOwnProperty(S)&&(E[S]=w[S]);v.push({time:b.time,attributes:W.copy(b.attributes),interpolators:E})}l.push({name:p.name,fps:p.fps,animation:v,textureUVs:d,textureSizes:p.textureSizes})}}else{f=X.parseSystem(a,i),l=[];for(h=0;h<c;h+=1)l[h]=X.parseParticle(a,r[h])}if(f===null)throw a.fail("Build failed!");for(h=0;h<c;h+=1)l[h]&&e.normalizeParticleUVs(l[h]);if(!t.alreadyParsed)for(h=0;h<c;h+=1)l[h]&&e.checkAttributes(a,l[h],f);var x=f.length,T;if(s){for(var S in s)if(s.hasOwnProperty(S)){var N=s[S];N.length!==l.length&&a.error("UV-remapping of "+S+" does not specify the correct number of maps");var C=!1;for(h=0;h<x;h+=1){T=f[h];if(W.isNumber(T.type)&&S.substr(7)===""+T.type){C=!0;break}}C||a.warning("UV-mapping is defined for "+S+" which is not used by system")}for(h=0;h<c;h+=1)l[h]&&e.remapUVs(l[h],s,h)}if(!a.empty(u))throw a.fail("Build failed!");for(h=0;h<c;h+=1)e.setDefaults(l[h],f);if(o){var k=[],L=[];for(h=0;h<x;h+=1)T=f[h],k.push(T.name+"-scale"),k.push(T.name+"-offset"),L.push(T.type);var A=o.length;A!==l.length&&a.error("Not enough tweaks specified to match particle count");for(h=0;h<A;h+=1){var O=o[h];X.extraFields(a,"animation tweaks",O,k);for(var S in O){var M=k.indexOf(S);if(M===-1)continue;W.isNumber(O[S])&&(O[S]=[O[S]]),e.checkAssignment(a,"particle "+l[h].name,"tweak '"+S+"'",O[S],L[M>>>1])}}if(a.checkErrorState())throw a.fail("Build failed!");for(h=0;h<A;h+=1)e.applyTweak(f,l[h],o[h])}if(!a.empty(u))throw a.fail("Build failed!");for(h=0;h<c;h+=1)e.discretize(f,l[h]);for(h=0;h<c;h+=1)e.clampAttributes(f,l[h]);var _=e.attributesMapping(f,l);for(h=0;h<c;h+=1)e.normalizeAttributes(f,l[h],_);var D=0;for(h=0;h<c;h+=1)D+=l[h].animation.length;var P=e.compileData(f,D,l),H=[],B=0,j=0;for(h=0;h<c;h+=1){var F=l[h],I=F.animation,q=I[I.length-1].time;q>B&&(B=q),H.push({lifeTime:q,animationRange:[(j+.5)/D,(j+I.length-.5)/D]}),j+=I.length}return{maxLifeTime:B,animation:e.buildAnimationTexture(n,D,f.length,P),particle:H,attribute:_}},e.checkAssignment=function(e,t,n,r,i){if(i===null)return;switch(i){case"tFloat":r.length!==1&&e.error("Cannot type "+z.wrap(r)+" with type float for "+n+" in "+t);break;case"tFloat2":r.length!==2&&e.error("Cannot type "+z.wrap(r)+" with type float2 for "+n+" in "+t);break;case"tFloat4":r.length!==4&&e.error("Cannot type "+z.wrap(r)+" with type float4 for "+n+" in "+t);break;default:r.length!==1&&e.error("Cannot type "+z.wrap(r)+" with type texture"+i+" for "+n+" in "+t)}},e.compileData=function(e,t,n){var r=0,i=e.length,s;for(s=0;s<i;s+=1){var o=e[s],u=W.isNumber(o.type)?4:o.defaultValue.length;switch(o.compress){case R.cHalf:u=Math.ceil(u/2);break;case R.cFull:u=Math.ceil(u/4);break;default:}r+=u}var a=t*r,f=new Uint32Array(a),l=0,c=n.length;for(s=0;s<i;s+=1){var o=e[s],h;for(h=0;h<c;h+=1){var p=n[h],d=p.animation,v=d.length,m;for(m=0;m<v;m+=1){var g=d[m].attributes[o.name];switch(o.type){case"tFloat":f[l]=H.encodeUnsignedFloat(g[0]);break;case"tFloat2":o.compress!==R.cNone?f[l]=H.encodeUnsignedFloat2(g):(f[l+t*0]=H.encodeUnsignedFloat(g[0]),f[l+t*1]=H.encodeUnsignedFloat(g[1]));break;default:if(o.type!=="tFloat4"){var y=p.textureUVs["texture"+o.type],b=g[0]|0;g=y[b]}o.compress===R.cFull?f[l]=H.encodeUnsignedFloat4(g):o.compress===R.cNone?(f[l+t*0]=H.encodeUnsignedFloat(g[0]),f[l+t*1]=H.encodeUnsignedFloat(g[1]),f[l+t*2]=H.encodeUnsignedFloat(g[2]),f[l+t*3]=H.encodeUnsignedFloat(g[3])):(f[l+t*0]=H.encodeUnsignedFloat2(g.slice(0,2)),f[l+t*1]=H.encodeUnsignedFloat2(g.slice(2,4)))}l+=1}}}return new Uint8Array(f.buffer)},e.normalizeAttributes=function(e,t,n){var r={},i=Number.POSITIVE_INFINITY,s=e.length,o;for(o=0;o<s;o+=1){var u=e[o];if(u.storage!==U.sNormalized)continue;var a=n[u.name],f=a.min.length,l=t.animation,c=l.length,h;for(h=0;h<c;h+=1){var p=l[h].attributes[u.name],d;for(d=0;d<f;d+=1)p[d]=(p[d]-a.min[d])*(a.delta[d]===0?1:1/a.delta[d])}}},e.attributesMapping=function(e,t){var n={},r=Number.POSITIVE_INFINITY,i=e.length,s;for(s=0;s<i;s+=1){var o=e[s];if(o.storage!==U.sNormalized)continue;var u,a,f;switch(o.type){case"tFloat2":u=[r,r],a=[-r,-r],f=2;break;case"tFloat4":u=[r,r,r,r],a=[-r,-r,-r,-r],f=4;break;default:u=[r],a=[-r],f=1}var l=t.length,c;for(c=0;c<l;c+=1){var h=t[c],p=h.animation,d=p.length,v;for(v=0;v<d;v+=1){var m=p[v].attributes[o.name],g;for(g=0;g<f;g+=1)m[g]<u[g]&&(u[g]=m[g]),m[g]>a[g]&&(a[g]=m[g])}}var y=[];for(c=0;c<f;c+=1)y[c]=a[c]-u[c];n[o.name]={min:u,delta:y}}return n},e.clampAttributes=function(e,t){var n=t.animation,r=n.length;if(r===0)return;var i=e.length,s;for(s=0;s<i;s+=1){var o=e[s],u=o.minValue,a=o.maxValue;W.isNumber(o.type)&&(u=[0],a=[t.textureUVs["texture"+o.type].length-1]);var f=n[0].attributes[o.name].length,l;for(l=0;l<r;l+=1){var c=n[l].attributes[o.name],h;for(h=0;h<f;h+=1)u[h]!==null&&c[h]<u[h]&&(c[h]=u[h]),a[h]!==null&&c[h]>a[h]&&(c[h]=a[h])}}},e.setDefaults=function(e,t){if(e.animation.length===0)return;var n=e.animation[0],r=t.length,i;for(i=0;i<r;i+=1){var s=t[i];n.attributes.hasOwnProperty(s.name)||(n.attributes[s.name]=W.copy(s.defaultValue)),n.interpolators.hasOwnProperty(s.name)||(n.interpolators[s.name]=s.defaultInterpolator)}},e.applyTweak=function(e,t,n){var r=e.length,i;for(i=0;i<r;i+=1){var s=e[i],o=s.name+"-scale",u=s.name+"-offset",a=null,f=null;n.hasOwnProperty(o)&&(a=n[o]),n.hasOwnProperty(u)&&(f=n[u]);if(!a&&!f)continue;var l=t.animation,c=l.length,h=a?a.length:f.length,p;for(p=0;p<c;p+=1){if(!l[p].attributes.hasOwnProperty(s.name))continue;var d=l[p].attributes[s.name],v;for(v=0;v<h;v+=1)a&&(d[v]*=a[v]),f&&(d[v]+=f[v])}}},e.remapUVs=function(e,t,n){for(var r in e.textureUVs)if(e.textureUVs.hasOwnProperty(r)&&t.hasOwnProperty(r)){var i=e.textureUVs[r],s=i.length,o=t[r];if(o.length<=n)continue;var u=o[n],a;for(a=0;a<s;a+=1){var f=i[a];f[0]=u[0]+f[0]*u[2],f[1]=u[1]+f[1]*u[3],f[2]*=u[2],f[3]*=u[3]}}},e.interpolate=function(e,t,n){var r=null,i=[],s=[],o=e.length,u;for(u=0;u<o;u+=1){var a=e[u];a.time<=n?(a.attributes.hasOwnProperty(t.name)&&i.push(a),a.interpolators.hasOwnProperty(t.name)&&(r=a.interpolators[t.name])):a.attributes.hasOwnProperty(t.name)&&s.push(a)}var f=[],l=[],c=r.offsets;o=c.length;for(u=0;u<o;u+=1){var h=c[u];h>0?(h-=1,h<s.length?(f.push(s[h].time),l.push(s[h].attributes[t.name])):(f.push(null),l.push(null))):(h+=i.length,h>=0?(f.push(i[h].time),l.push(i[h].attributes[t.name])):(f.push(null),l.push(null)))}var p;if(s.length===0)p=0;else{var d=i[i.length-1],v=s[0];p=(n-d.time)/(v.time-d.time)}return r.fun(l,f,p)},e.discretize=function(t,n){var r=[],i=n.animation,s=i.length,o=t.length,u,a,f;if(s===0){f={time:0,attributes:{},interpolators:{}};for(a=0;a<o;a+=1)u=t[a],f.attributes[u.name]=u.defaultValue.concat();r=[f]}else if(s===1)r=i;else{var l=0;for(a=0;a<s;a+=1)i[a].time+=l,l=i[a].time;var c=l;l=0;var h=1/n.fps;while(r.length===0||r[r.length-1].time<c){f={time:l,attributes:{},interpolators:{}};var a;for(a=0;a<o;a+=1)u=t[a],f.attributes[u.name]=e.interpolate(i,u,l);r.push(f),l+=h}}n.animation=r},e.checkAttributes=function(t,n,r){var i,s=n.animation;if(!s)return;var o=s.length,u;for(u=0;u<o;u+=1){var a=s[u],f=a.interpolators;for(var l in f)f.hasOwnProperty(l)&&!e.getAttribute(r,l)&&t.warning("particle "+n.name+" references attribute '"+l+"' not defined in system");var c=a.attributes;for(var l in c){if(!c.hasOwnProperty(l))continue;i=e.getAttribute(r,l);if(!i)t.warning("particle "+n.name+" references attribute '"+l+"' not defined in system");else{var h=c[l];e.checkAssignment(t,"particle "+n.name,"attribute '"+l+"'",h,i.type)}}}o=r.length;for(u=0;u<o;u+=1){i=r[u];switch(i.type){case"tFloat":case"tFloat2":case"tFloat4":break;default:n.textureUVs.hasOwnProperty("texture"+i.type)||(n.textureUVs["texture"+i.type]=[[0,0,1,1]])}}},e.getAttribute=function(e,t){var n=null,r=e.length,i;for(i=0;i<r;i+=1){var s=e[i];if(s.name===t){n=s;break}}return n},e.normalizeParticleUVs=function(e){for(var t in e.textureUVs){if(!e.textureUVs.hasOwnProperty(t)||!e.textureSizes.hasOwnProperty(t))continue;var n=e.textureUVs[t],r=e.textureSizes[t],i=1/r[0],s=1/r[1],o=n.length,u;for(u=0;u<o;u+=1)n[u][0]*=i,n[u][1]*=s,n[u][2]*=i,n[u][3]*=s}},e}(),$=function(){function e(t){this.graphicsDevice=t.graphicsDevice,e.init(this.graphicsDevice);var n=this.graphicsDevice.maxSupported("TEXTURE_SIZE");this.packer=new j(n,n),this.contexts=[]}return e.init=function(t){if(!e.textureVertices){e.textureVertices=t.createVertexBuffer({numVertices:4,attributes:[t.VERTEXFORMAT_FLOAT2],dynamic:!1,data:[0,0,1,0,0,1,1,1]}),e.textureSemantics=t.createSemantics([t.SEMANTIC_POSITION]),e.copyParameters=t.createTechniqueParameters({dim:[0,0],dst:[0,0,0,0]});var n=t.createShader({version:1,name:"particles-copy.cgfx",samplers:{src:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071}},parameters:{src:{type:"sampler2D"},dim:{type:"float",columns:2},dst:{type:"float",columns:4}},techniques:{copy:[{parameters:["dst","src"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_copy","fp_copy"]}]},programs:{fp_copy:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _ret_0;uniform sampler2D src;void main()\n{_ret_0=texture2D(src,tz_TexCoord[0].xy);gl_FragColor=_ret_0;}"},vp_copy:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;\nvec4 _outPosition1;vec2 _outUV1;uniform vec4 dst;void main()\n{vec2 _xy;vec2 _wh;vec2 _TMP3;_xy=dst.xy*2.0-1.0;_wh=(dst.zw*2.0-1.0)-_xy;_TMP3=_xy+_wh*ATTR0.xy;_outPosition1=vec4(_TMP3.x,_TMP3.y,0.0,1.0);_outUV1=ATTR0.xy;tz_TexCoord[0].xy=ATTR0.xy;gl_Position=_outPosition1;}"}}});e.copyTechnique=n.getTechnique("copy")}},e.create=function(t){return new e(t)},e.prototype.destroy=function(){var e=this.contexts,t=e.length;while(t>0){t-=1;var n=e[t];n.renderTargets[0].colorTexture0.destroy(),n.renderTargets[1].colorTexture0.destroy(),n.renderTargets[0].destroy(),n.renderTargets[1].destroy()}this.graphicsDevice=null,this.packer=null,this.contexts=null},e.prototype.release=function(e){var t=this.contexts[e.bin],n=t.store,r=n.length,i;for(i=0;i<r;i+=1){var s=n[i];if(s.ctx===e){n[i]=n[r-1],n.pop
(),this.packer.release(s.fit);break}}},e.prototype.allocate=function(t){var n=this.packer.pack(t.width,t.height);if(!n)return null;var r=n.bin,i=this.packer.bins[r],s=i.w,o=i.h;r>=this.contexts.length&&(this.contexts[r]=e.createContext(this.graphicsDevice,s,o));var u=this.contexts[r];if(s>u.width||o>u.height)u=this.contexts[r]=this.resizeContext(u,s,o);var a=1/u.width,f=1/u.height,l={renderTargets:u.renderTargets,uvRectangle:[n.x*a,n.y*f,n.w*a,n.h*f],bin:n.bin};return u.store.push({set:t.set,fit:n,ctx:l}),l},e.prototype.resizeContext=function(t,n,r){var i=t.width,s=t.height;while(i<n)i=Math.ceil(i*1.25);while(s<r)s=Math.ceil(s*1.25);i>this.packer.maxWidth&&(i=this.packer.maxWidth),s>this.packer.maxHeight&&(s=this.packer.maxHeight),n=i,r=s;var o=this.graphicsDevice,u=e.createContext(o,n,r);e.copyTexture(o,t.renderTargets[0],u.renderTargets[0]),e.copyTexture(o,t.renderTargets[1],u.renderTargets[1]),t.renderTargets[0].colorTexture0.destroy(),t.renderTargets[1].colorTexture0.destroy(),t.renderTargets[0].destroy(),t.renderTargets[1].destroy();var a=1/n,f=1/r,l=t.store,c=u.store,h=l.length,p;for(p=0;p<h;p+=1){var d=l[p],v=d.fit;c.push(d),d.ctx={renderTargets:u.renderTargets,uvRectangle:[v.x*a,v.y*f,v.w*a,v.h*f],bin:v.bin},d.set(d.ctx)}return u},e.copyTexture=function(t,n,r){var i=e.copyParameters,s=e.copyTechnique,o=e.textureVertices,u=e.textureSemantics;i.src=n.colorTexture0,i.dst=[0,0,n.colorTexture0.width/r.colorTexture0.width,n.colorTexture0.height/r.colorTexture0.height],t.beginRenderTarget(r),t.setStream(o,u),t.setTechnique(s),t.setTechniqueParameters(i),t.draw(t.PRIMITIVE_TRIANGLE_STRIP,4,0),t.endRenderTarget()},e.createContext=function(e,t,n){var r=[],i;for(i=0;i<2;i+=1){var s=e.createTexture({name:"SharedRenderContext Context Texture "+i,width:t,height:n,depth:1,format:e.PIXELFORMAT_R8G8B8A8,mipmaps:!1,cubemap:!1,dynamic:!0,renderable:!0});r.push(e.createRenderTarget({colorTexture0:s}))}return{width:t,height:n,renderTargets:r,store:[]}},e}(),J=function(){function e(){}return e.prototype.register=function(e){this.handlers.indexOf(e)===-1&&this.handlers.push(e)},e.prototype.unregister=function(e){var t=this.handlers.indexOf(e);t!==-1&&this.handlers.splice(t,1)},e.prototype.resize=function(e){if(e<=this.maxParticles)return;var t=this.template,n=t.length,r=new Uint16Array(e*n),i;for(i=0;i<e;i+=1){var s=i*n,o;for(o=0;o<n;o+=1)r[s+o]=t[o]===null?i:t[o]}this.maxParticles=e,this.vertexBuffer&&this.vertexBuffer.destroy(),this.vertexBuffer=this.graphicsDevice.createVertexBuffer({numVertices:e*this.particleStride,attributes:this.attributes,dynamic:!1,data:r});var u=this.handlers,a=u.length;for(i=0;i<a;i+=1)u[i]()},e.create=function(t){var n=t.maxParticles,r=t.template,i=r.length,s=i/t.stride|0,o=t.primitive;o===undefined&&(o=t.graphicsDevice.PRIMITIVE_TRIANGLES);var u=new e;return u.handlers=[],u.graphicsDevice=t.graphicsDevice,u.particleStride=s,u.semantics=t.semantics,u.primitive=o,u.shared=t.shared===undefined?!1:t.shared,u.template=r.concat(),u.attributes=t.attributes.concat(),u.resize(t.maxParticles),u},e.prototype.destroy=function(){this.vertexBuffer.destroy()},e}(),K=function(){function e(){}return e.load=function(e,t,n){t("shaders/particles-default-update.cgfx"),e.noiseTexture&&n(e.noiseTexture)},e.compressArchetype=function(t){return nt.recordDelta(e.template,t)},e.parseArchetype=function(n,r){function i(e){return X.checkVector.bind(null,n,"default updater archetype",e,3)}function s(e){return X.checkNumber.bind(null,n,"default updater archetype",e)}function o(e){return X.checkString.bind(null,n,"default updater archetype",e)}function u(e){return function(){return e}}function a(e,t,n){return X.maybeField(r,e,t(e),n)}return W.isNullUndefined(r)?W.copy(e.template):W.isObject(r)?(X.extraFields(n,"default updater archetype",r,["acceleration","drag","noiseTexture","randomizedAcceleration"]),{acceleration:a("acceleration",i,t.v3BuildZero),drag:a("drag",s,u(0)),noiseTexture:a("noiseTexture",o,u(null)),randomizedAcceleration:a("randomizedAcceleration",i,t.v3BuildZero)}):(n.error("updater archetype should be an object"),null)},e.prototype.applyArchetype=function(e,n,r){var i=n.updateParameters;t.v3Copy(r.acceleration,i.acceleration),i.drag=r.drag,i.noiseTexture=e.get(r.noiseTexture),t.v3Copy(r.randomizedAcceleration,i.randomizedAcceleration)},e.prototype.createUserDataSeed=function(){return Math.random()*255<<16},e.prototype.createUserData=function(e){return(e.randomizeAcceleration!==undefined?e.randomizeAcceleration:0)<<24|(e.seed!==undefined?e.seed:0)<<16},e.prototype.predict=function(e,t,n,r,i){var s=1/60,o=e.acceleration,u=o[0],a=o[1],f=o[2],l=1-Math.min(1,e.drag*s),c;if(l===1)c=.5*(i-s),t[0]+=i*(n[0]+c*u),t[1]+=i*(n[1]+c*a),t[2]+=i*(n[2]+c*f),n[0]+=i*u,n[1]+=i*a,n[2]+=i*f;else{var h=Math.pow(l,i/s),p=Math.log(l);c=s*(h-1)/p;var d=(s*(h-1)-i*p)/((l-1)*p)*l*s,v=s*l*(h-1)/(l-1);t[0]+=c*n[0]+d*u,t[1]+=c*n[1]+d*a,t[2]+=c*n[2]+d*f,n[0]=h*n[0]+v*u,n[1]=h*n[1]+v*a,n[2]=h*n[2]+v*f}return r},e.prototype.update=function(e,t,n,r,i){var s=e.timeStep,o=e.lifeStep,u=e.acceleration,a=e.drag,f=e.halfExtents,l=e.shift,c=e.maxSpeed;a=1-Math.min(1,s*a);var h=c/f[0],p=c/f[1],d=c/f[2],v=c===0?0:1/c,m=u[0]*v,g=u[1]*v,y=u[2]*v,b=l[0],w=l[1],E=l[2],S=G.PARTICLE_SPAN,x=G.PARTICLE_LIFE,T=G.PARTICLE_VEL,N=G.PARTICLE_POS,C=H.decodeHalfUnsignedFloat,k=H.encodeHalfUnsignedFloat,L;for(L=0;L<i;L+=1){var A=r[L]*S,O=C(n[A+x]>>>16);if(O<=0)continue;var M=O-o,_=s;o!==0&&(_*=Math.min(o,O)/o);var D=t[A+T],P=t[A+T+1],B=t[A+T+2],j=t[A+N]+D*_*h+b,F=t[A+N+1]+P*_*p+w,I=t[A+N+2]+B*_*d+E;t[A+N]=j<-1?-1:j>1?1:j,t[A+N+1]=F<-1?-1:F>1?1:F,t[A+N+2]=I<-1?-1:I>1?1:I,j=a*(D+m*_),F=a*(P+g*_),I=a*(B+y*_),t[A+T]=j<-1?-1:j>1?1:j,t[A+T+1]=F<-1?-1:F>1?1:F,t[A+T+2]=I<-1?-1:I>1?1:I,n[A+x]=k(M)<<16|65535&n[A+x]}},e.create=function(t,n){var r=n.get("shaders/particles-default-update.cgfx"),i=new e;return i.technique=r.getTechnique("update"),i.parameters={acceleration:new Float32Array(3),drag:0,noiseTexture:G.getDefaultNoiseTexture(t),randomizedAcceleration:new Float32Array(3)},i},e.template={acceleration:[0,0,0],drag:0,noiseTexture:null,randomizedAcceleration:[0,0,0]},e}(),Q=function(){function e(){}return e.load=function(e,t,n){t("shaders/particles-default-render.cgfx"),e.noiseTexture&&n(e.noiseTexture)},e.compressArchetype=function(t){return nt.recordDelta(e.template,t)},e.parseArchetype=function(n,r){function i(e){return X.checkVector.bind(null,n,"default renderer archetype",e,2)}function s(e){return X.checkNumber.bind(null,n,"default renderer archetype",e)}function o(e){return X.checkBoolean.bind(null,n,"default renderer archetype",e)}function u(e){return X.checkString.bind(null,n,"default renderer archetype",e)}function a(e){return function(){return e}}function f(e,t,n){return X.maybeField(r,e,t(e),n)}return W.isNullUndefined(r)?W.copy(e.template):W.isObject(r)?(X.extraFields(n,"default renderer archetype",r,["animatedRotation","animatedOrientation","animatedScale","animatedAlpha","randomizedScale","randomizedAlpha","randomizedRotation","randomizedOrientation","noiseTexture"]),{noiseTexture:f("noiseTexture",u,a(null)),randomizedRotation:f("randomizedRotation",s,a(0)),randomizedOrientation:f("randomizedOrientation",i,t.v2BuildZero),randomizedScale:f("randomizedScale",i,t.v2BuildZero),randomizedAlpha:f("randomizedAlpha",s,a(0)),animatedRotation:f("animatedRotation",o,a(!1)),animatedOrientation:f("animatedRotation",o,a(!1)),animatedScale:f("animatedScale   ",o,a(!1)),animatedAlpha:f("animatedAlpha   ",o,a(!1))}):(n.error("renderer archetype should be an object"),null)},e.prototype.applyArchetype=function(e,n,r,i){var s=n.renderParameters;s.noiseTexture=e.get(r.noiseTexture),s.randomizedRotation=r.randomizedRotation,t.v2Copy(r.randomizedOrientation,s.randomizedOrientation),t.v2Copy(r.randomizedScale,s.randomizedScale),s.randomizedAlpha=r.randomizedAlpha,s.animatedRotation=r.animatedRotation,s.animatedOrientation=r.animatedOrientation,s.animatedScale=r.animatedScale,s.animatedAlpha=r.animatedAlpha,s.texture=i("texture0")},e.prototype.createUserDataSeed=function(){return Math.random()*255<<16},e.prototype.createUserData=function(e){var t=0;e.facing==="velocity"&&(t|=1<<30),e.facing==="custom"&&(t|=2<<30),t|=e.randomizeRotation<<29,t|=e.randomizeScale<<28,t|=e.randomizeOrientation<<27,t|=e.randomizeAlpha<<26,t|=e.seed<<16;var n=0;if(e.theta!==undefined){var r=e.theta%(Math.PI*2);r<0&&(r+=Math.PI*2),r>Math.PI&&(r=Math.PI*2-r,n=Math.PI),t|=H.encodeByteUnsignedFloat(r/Math.PI)<<8}if(e.phi!==undefined||n!==0){var i=((e.phi||0)+n)%(Math.PI*2);i<0&&(i+=Math.PI*2),t|=H.encodeByteUnsignedFloat(i/(Math.PI*2))}return t},e.prototype.setAnimationParameters=function(e,t){var n=e.renderParameters,r=n.animationScale,i=t.attribute.scale;r[0]=i.min[0],r[1]=i.min[1],r[2]=i.delta[0],r[3]=i.delta[1];var s=n.animationRotation,o=t.attribute.rotation;s[0]=o.min[0],s[1]=o.delta[0]},e.prototype.createGeometry=function(e,t,n){return typeof n=="undefined"&&(n=!1),J.create({graphicsDevice:e,maxParticles:t,template:[0,null,1,null,2,null,0,null,2,null,3,null],attributes:[e.VERTEXFORMAT_USHORT2],stride:2,semantics:e.createSemantics([e.SEMANTIC_POSITION]),primitive:e.PRIMITIVE_TRIANGLES,shared:n})},e.create=function(t,n,r){typeof r=="undefined"&&(r="alpha");var i=n.get("shaders/particles-default-render.cgfx"),s=new e;return s.technique=i.getTechnique(r),s.parameters={animationScale:new Float32Array(4),animationRotation:new Float32Array(2),texture:null,noiseTexture:G.getDefaultNoiseTexture(t),randomizedOrientation:new Float32Array(2),randomizedScale:new Float32Array(2),randomizedRotation:0,randomizedAlpha:0,animatedOrientation:!1,animatedScale:!1,animatedRotation:!1,animatedAlpha:!1},s},e.template={noiseTexture:null,randomizedRotation:0,randomizedOrientation:[0,0],randomizedScale:[0,0],randomizedAlpha:0,animatedRotation:!1,animatedOrientation:!1,animatedScale:!1,animatedAlpha:!1},e}(),G=function(){function e(){}return e.compressArchetype=function(t){return nt.recordDelta(e.template,t)},e.parseArchetype=function(n,r){function i(e){return X.checkVector.bind(null,n,"system archetype",e,3)}function s(e){return X.checkNumber.bind(null,n,"system archetype",e)}function o(e){return X.checkBoolean.bind(null,n,"system archetype",e)}function u(e){return function(){return e}}function a(e,t,n){return X.maybeField(r,e,t(e),n)}return W.isNullUndefined(r)?W.copy(e.template):W.isObject(r)?(X.extraFields(n,"system archetype",r,["center","halfExtents","maxSpeed","maxParticles","maxParticles","zSorted","maxSortSTeps","trackingEnabled","maxLifeTime"]),{center:a("center",i,t.v3BuildZero),halfExtents:a("halfExtents",i,t.v3BuildOne),maxSpeed:a("maxSpeed",s,u(null)),maxParticles:a("maxParticles",s,u(null)),zSorted:a("zSorted",o,u(!1)),maxSortSteps:a("maxSortSteps",s,u(136)),trackingEnabled:a("trackingEnabled",o,u(!1)),maxLifeTime:a("maxLifeTime",s,u(null))}):(n.error("System archetype should be an object"),null)},e.getDefaultNoiseTexture=function(t){if(!e.defaultNoiseTexture){var n=H.encodeByteSignedFloat(0);e.defaultNoiseTexture=t.createTexture({name:"ParticleSystem defaultNoiseTeture",width:1,height:1,depth:1,format:t.PIXELFORMAT_R8G8B8A8,mipmaps:!0,cubemap:!1,renderable:!1,dynamic:!1,data:[n,n,n,n]})}return e.defaultNoiseTexture},e.computeMaxParticleDependents=function(e,t){var n,r;if(t){if(e<=8)return{maxMergeStage:2,textureSize:[4,2],capacity:8};var i=Math.ceil(Math.log(e)/Math.log(2));if(i<3)return{maxMergeStage:2,textureSize:[4,2],capacity:8};if(i>16)return{maxMergeStage:15,textureSize:[256,256],capacity:65536};var s=i>>>1;return n=1<<i-s,r=1<<s,{maxMergeStage:i-1,textureSize:[n,r],capacity:n*r}}return e>66536&&(e=66536),e<=1?{maxMergeStage:null,textureSize:[1,1],capacity:1}:(n=Math.ceil(Math.sqrt(e)),r=Math.ceil(e/n),{maxMergeStage:null,textureSize:[n,r],capacity:n*r})},e.prototype.addTracked=function(t){var n=this.numTracked,r=n+1,i=this.tracked;r>i.length&&(i=this.tracked=e.resizeUInt16(i,r,n)),i[n]=t,this.numTracked+=1},e.addCreated=function(t){var n=e.numCreated,r=n+1,i=e.createdIndices;r>i.length&&(i=e.createdIndices=e.resizeUInt16(i,r,n)),i[n]=t,e.numCreated+=1},e.resizeUInt16=function(e,t,n){var r=e.length;while(r<t)r*=2;var i=new Uint16Array(r),s;for(s=0;s<n;s+=1)i[s]=e[s];return i},e.sizeCreated=function(t,n){e.createdIndices||(e.createdIndices=new Uint16Array(4));var r=e.PARTICLE_DIMX,i=e.PARTICLE_DIMY,s=n[0]*r,o=n[1]*i,u=e.createdTexture;if(!u||u.width<s||u.height<o){var a=u?u.width:s,f=u?u.height:o;while(a<s)a=a*1.5|0;while(f<o)f=f*1.5|0;var l=256*r,c=256*i;a>l&&(a=l),f>c&&(f=c),u&&u.destroy(),e.createdTexture=t.createTexture({name:"ParticleSystem Shared Creation Texture",width:a,height:f,depth:1,format:t.PIXELFORMAT_R8G8B8A8,mipmaps:!1,cubemap:!1,renderable:!1,dynamic:!0}),e.createdValidWidth=a,e.createdValidHeight=f,e.createdData=new Uint8Array(a*f*4),e.createdData32=new Uint32Array(e.createdData.buffer)}},e.dispatchCreated=function(t){var n=e.PARTICLE_DIMX,r=e.PARTICLE_DIMY,i=e.createdValidWidth,s=e.createdValidHeight,o=t[0]*n,u=t[1]*r,a=e.numCreated;if(a!==0||o>i||u>s)e.createdTexture.setData(e.createdData,0,0,0,0,o,u),a===0?o>=i&&u>=s&&(e.createdValidWidth=o,e.createdValidHeight=u):(e.createdValidWidth=0,e.createdValidHeight=0);if(a===0)return;var f=e.createdData32,l=e.createdIndices,c=t[0],h=c*n,p;for(p=0;p<a;p+=1){var d=l[p],v=d%c,m=(d-v)/c|0,g=m*r*h+v*n;f[g]=f[g+1]=f[g+2]=f[g+h]=f[g+h+1]=f[g+h+2]=f[g+h*2]=f[g+h*2+1]=f[g+h*2+2]=0}e.numCreated=0},e.prototype.constructor=function(){},e.create=function(n){var r=new e;r.graphicsDevice=n.graphicsDevice,r.center=n.center===undefined?t.v3BuildZero():t.v3Copy(n.center),r.halfExtents=t.v3Copy(n.halfExtents),r.invHalfExtents=t.v3Reciprocal(r.halfExtents),r.maxLifeTime=n.maxLifeTime,r.animation=n.animation,r.sharedAnimation=n.sharedAnimation===undefined?!1:n.sharedAnimation,r.timer=n.timer,r.timer===undefined&&(r.timer=function(){return TurbulenzEngine.time}),r.synchronizer=n.synchronizer,r.synchronizer||(r.synchronizer=et.create({})),r.lastVisible=null,r.lastTime=null,r.zSorted=n.zSorted===undefined?!1:n.zSorted;var i=e.computeMaxParticleDependents(n.maxParticles,r.zSorted);r.particleSize=i.textureSize,r.maxParticles=n.maxParticles,r.maxMergeStage=i.maxMergeStage,r.maxSortSteps=n.maxSortSteps===undefined?136:n.maxSortSteps,r.maxSpeed=n.maxSpeed,r.views=[],r.renderer=n.renderer,r.renderer||(e.sharedDefaultRenderer||(e.sharedDefaultRenderer=Q.create(n.graphicsDevice,n.shaderManager,"alpha")),r.renderer=e.sharedDefaultRenderer),r.updater=n.updater,r.updater||(e.sharedDefaultUpdater||(e.sharedDefaultUpdater=K.create(n.graphicsDevice,n.shaderManager)),r.updater=e.sharedDefaultUpdater),r.geometry=n.geometry,r.geometry||(r.geometry=n.renderer.createGeometry(r.graphicsDevice,r.maxParticles)),e.sizeCreated(r.graphicsDevice,r.particleSize),r.queue=new q(r.maxParticles),r.trackingEnabled=n.trackingEnabled===!0&&r.updater!==undefined,r.trackingEnabled&&(r.numTracked=0,r.tracked=new Uint16Array(4),r.cpuF32=new Float32Array(r.maxParticles*e.PARTICLE_SPAN),r.cpuU32=new Uint32Array(r.cpuF32.buffer));var s=W.copyFields(r.updater.parameters,null,!1);s.lifeStep=0,s.timeStep=0,s.shift=t.v3BuildZero(),s.center=r.center,s.halfExtents=r.halfExtents,s.maxSpeed=n.maxSpeed,s.maxLifeTime=n.maxLifeTime,s.previousState=null,s.creationState=null,s.creationScale=t.v2BuildZero(),s.textureSize=t.v2BuildZero(),s.invTextureSize=t.v2BuildZero(),s.regionSize=t.v2BuildZero(),s.invRegionSize=t.v2BuildZero(),s.regionPos=t.v2BuildZero(),r.updateParameters=r.graphicsDevice.createTechniqueParameters(s),s=W.copyFields(r.renderer.parameters,null,!1),s.center=r.center,s.halfExtents=r.halfExtents,s.zSorted=r.zSorted,s.vParticleState=null,s.fParticleState=null,s.maxLifeTime=n.maxLifeTime,s.animation=r.animation,s.animationSize=r.animation?t.v2Build(r.animation.width,r.animation.height):t.v2BuildOne(),s.textureSize=t.v2BuildZero(),s.invTextureSize=t.v2BuildZero(),s.regionSize=t.v2BuildZero(),s.invRegionSize=t.v2BuildZero(),s.regionPos=t.v2BuildZero(),r.renderParameters=r.graphicsDevice.createTechniqueParameters(s);var o=n.sharedRenderContext;return r.renderContextShared=o,r.renderContextShared||(o=new $({graphicsDevice:r.graphicsDevice})),r.renderContext=o,r.currentState=0,r.setStateContext(o.allocate({width:r.particleSize[0]*e.PARTICLE_DIMX,height:r.particleSize[1]*e.PARTICLE_DIMY,set:r.setStateContext.bind(r)})),e.fullTextureVertices||(e.fullTextureVertices=r.graphicsDevice.createVertexBuffer({numVertices:4,attributes:[r.graphicsDevice.VERTEXFORMAT_FLOAT2],dynamic:!1,data:[0,0,1,0,0,1,1,1]}),e.fullTextureSemantics=r.graphicsDevice.createSemantics([r.graphicsDevice.SEMANTIC_POSITION])),r},e.prototype.destroy=function(){this.renderContextShared?this.renderContext.release(this.stateContext):this.renderContext.destroy(),this.renderContext=null,this.stateContext=null,this.queue=null,this.geometry.shared||this.geometry.destroy(),this.geometry=null,this.timer=null,this.synchronizer=null,!this.sharedAnimation&&this.animation&&this.animation.destroy(),this.animation=null},e.prototype.reset=function(e){this.removeAllParticles(),e!==undefined?(this.lastVisible=-1,this.lastTime=e):(this.lastVisible=null,this.lastTime=null)},e.prototype.setStateContext=function(e){this.stateContext=e;if(!e)return;var n=e.renderTargets[this.currentState].colorTexture0,r=e.uvRectangle,i=t.v2Build(n.width,n.height),s=t.v2Reciprocal(i),o=t.v2Build(r[0]*n.width,r[1]*n.height),u=t.v2Build(r[2]*n.width,r[3]*n.height),a=t.v2Reciprocal(u),f;f=this.updateParameters,t.v2Copy(i,f.textureSize),t.v2Copy(s,f.invTextureSize),t.v2Copy(u,f.regionSize),t.v2Copy(a,f.invRegionSize),t.v2Copy(o,f.regionPos),f=this.renderParameters,t.v2Copy(i,f.textureSize),t.v2Copy(s,f.invTextureSize),t.v2Copy(u,f.regionSize),t.v2Copy(a,f.invRegionSize),t.v2Copy(o,f.regionPos),f.vParticleState=n,f.fParticleState=n},e.prototype.createParticle=function(t){var n=t.lifeTime;if(n<=0)return null;n>this.maxLifeTime&&(n=this.maxLifeTime);var r=n;t.isTracked&&this.trackingEnabled&&(r=Number.POSITIVE_INFINITY);var i=this.queue.create(r,t.forceCreation);if(i===null)return null;var s=H.encodeSignedFloat,o=H.encodeUnsignedFloat2xy,u,a=t.position,f=t.velocity,l=t.userData===undefined?0:t.userData,c=this.center,h=this.invHalfExtents,p=n*(this.maxLifeTime===0?0:1/this.maxLifeTime),d=t.animationRange,v=(a[0]-c[0])*h[0],m=(a[1]-c[1])*h[1],g=(a[2]-c[2])*h[2],y=this.maxSpeed===0?0:1/this.maxSpeed,b=f[0]*y,w=f[1]*y,E=f[2]*y,S=o(p,p),x=o(d[1],d[1]-d[0]);if(t.isTracked&&this.trackingEnabled){if(this.queue.wasForced){var T=!1,N,C=this.numTracked,k=this.tracked;for(N=0;N<C;N+=1)if(k[N]===i){T=!0;break}T||this.addTracked(i)}else this.addTracked(i);var L,A,O,M=this.cpuF32,_=this.cpuU32,D=e.PARTICLE_POS,P=e.PARTICLE_VEL;u=i*e.PARTICLE_SPAN,M[u+D]=v<-1?-1:v>1?1:v,M[u+D+1]=m<-1?-1:m>1?1:m,M[u+D+2]=g<-1?-1:g>1?1:g,M[u+P]=b<-1?-1:b>1?1:b,M[u+P+1]=w<-1?-1:w>1?1:w,M[u+P+2]=E<-1?-1:E>1?1:E,_[u+e.PARTICLE_LIFE]=S,_[u+e.PARTICLE_ANIM]=x,_[u+e.PARTICLE_DATA]=l}var B=this.particleSize[0],j=i%B,F=(i-j)/B|0;e.addCreated(i);var I=e.PARTICLE_DIMX,q=e.PARTICLE_DIMY,R=B*I;u=F*q*R+j*I;var U=e.createdData32;return U[u]=s(v),U[u+R]=s(m),U[u+R*2]=s(g),U[u+1]=s(b),U[u+R+1]=s(w),U[u+R*2+1]=s(E),U[u+2]=S,U[u+R+2]=x,U[u+R*2+2]=l,i},e.prototype.removeAllParticles=function(){this.trackingEnabled&&(this.numTracked=0),this.queue.clear();var t=e.createdData32,n=this.particleSize,r=n[0],i=n[1],s=e.PARTICLE_DIMX,o=e.PARTICLE_DIMY,u=r*s,a,f;for(f=0;f<i;f+=1)for(a=0;a<r;a+=1){var l=f*o*u+a*s;t[l+2]=65535,e.addCreated(f*n[0]+a)}},e.prototype.removeParticle=function(t){this.queue.removeParticle(t);if(this.trackingEnabled){var n,r=0,i=this.tracked,s=this.numTracked;for(n=0;n<s;n+=1)i[n]!==t?(i[r]=i[n],r+=1):this.numTracked-=1}var o=this.particleSize[0],u=t%o,a=(t-u)/o|0,f=e.PARTICLE_DIMX,l=e.PARTICLE_DIMY,c=o*f,h=a*l*c+u*f;e.createdData32[h+2]=65535},e.prototype.updateParticle=function(t,n){if(!this.trackingEnabled)return;var r=this.cpuU32,i=this.cpuF32,s=e.PARTICLE_POS,o=e.PARTICLE_VEL,u=e.PARTICLE_LIFE,a=e.PARTICLE_ANIM,f=e.PARTICLE_DATA,l=H.decodeHalfUnsignedFloat,c=H.encodeSignedFloat,h=t*e.PARTICLE_SPAN,p=this.particleSize[0],d=t%p,v=(t-d)/p|0,m=e.PARTICLE_DIMX,g=e.PARTICLE_DIMY,y=p*m,b=v*g*y+d*m,w=e.createdData32,E,S,x,T=this.invHalfExtents,N=n.position;if(N!==undefined){var C=this.center;E=(N[0]-C[0])*T[0],S=(N[1]-C[1])*T[1],x=(N[2]-C[2])*T[2],E=E<-1?-1:E>1?1:E,S=S<-1?-1:S>1?1:S,x=x<-1?-1:x>1?1:x,i[h+s]=E,i[h+s+1]=S,i[h+s+2]=x}else E=i[h+s],S=i[h+s+1],x=i[h+s+2];w[b]=c(E),w[b+y]=c(S),w[b+y*2]=c(x);var k=n.velocity;if(k!==undefined){var L=this.maxSpeed===0?0:1/this.maxSpeed;E=k[0]*L,S=k[1]*L,x=k[2]*L,E=E<-1?-1:E>1?1:E,S=S<-1?-1:S>1?1:S,x=x<-1?-1:x>1?1:x,i[h+o]=E,i[h+o+1]=S,i[h+o+2]=x}else E=i[h+o],S=i[h+o+1],x=i[h+o+2];w[b+1]=c(E),w[b+y+1]=c(S),w[b+y*2+1]=c(x),w[b+2]=r[h+u];var A=n.animationRange,O;A!==undefined?(O=H.encodeUnsignedFloat2xy(A[1],A[1]-A[0]),r[h+a]=O):O=r[h+a],w[b+y+2]=O;var M=n.userData;M!==undefined?r[h+f]=M:M=r[h+f],w[b+y*2+2]=M,e.addCreated(t);if(n.isTracked!==undefined&&!n.isTracked){var _=this.tracked,D=this.numTracked,P,B=0;for(P=0;P<D;P+=1)_[P]!==t?(_[B]=_[P],B+=1):this.numTracked-=1}},e.prototype.sync=function(e){if(this.lastVisible===null)this.lastTime=this.timer();else if(e!==this.lastVisible){var t=this.timer();this.synchronizer.synchronize(this,t-this.lastTime),this.lastTime=t}this.lastVisible=e},e.prototype.beginUpdate=function(e,n){this.updateTime=e,this.updateShift=n?t.v3Copy(n,this.updateShift):t.v3BuildZero(this.updateShift),this.shouldUpdate=this.hasLiveParticles,this.hasLiveParticles=this.queue.update(e)},e.prototype.endUpdate=function(){return this.hasLiveParticles=this.hasLiveParticles||e.numCreated!==0,(this.shouldUpdate||this.hasLiveParticles)&&this.updateParticleState(this.updateTime,this.updateShift),this.hasLiveParticles},e.prototype.updateParticleState=function(t,n){e.dispatchCreated(this.particleSize);var r=this.updater,i=this.updateParameters,s=i.lifeStep=t*(this.maxLifeTime===0?0:1/this.maxLifeTime),o=i.timeStep=t;i.creationState=e.createdTexture;var u=i.shift,a=this.invHalfExtents;u[0]=n[0]*a[0],u[1]=n[1]*a[1],u[2]=n[2]*a[2];var f=this.graphicsDevice,l=this.stateContext.renderTargets,c=i.previousState=l[this.currentState].colorTexture0,h=i.creationScale;h[0]=this.particleSize[0]*e.PARTICLE_DIMX/e.createdTexture.width,h[1]=this.particleSize[1]*e.PARTICLE_DIMY/e.createdTexture.height,f.setStream(e.fullTextureVertices,e.fullTextureSemantics),f.beginRenderTarget(l[1-this.currentState]),f.setTechnique(r.technique),f.setTechniqueParameters(i),f.draw(f.PRIMITIVE_TRIANGLE_STRIP,4,0),f.endRenderTarget(),this.currentState=1-this.currentState;var c=l[this.currentState].colorTexture0;i=this.renderParameters,i.vParticleState=c,i.fParticleState=c,this.trackingEnabled&&r.update(this.updateParameters,this.cpuF32,this.cpuU32,this.tracked,this.numTracked)},e.prototype.queryPosition=function(n,r){r===undefined&&(r=t.v3BuildZero());var i=this.center,s=this.halfExtents,o=this.cpuF32,u=n*e.PARTICLE_SPAN+e.PARTICLE_POS;return r[0]=i[0]+s[0]*o[u],r[1]=i[1]+s[1]*o[u+1],r[2]=i[2]+s[2]*o[u+2],r},e.prototype.queryVelocity=function(n,r){r===undefined&&(r=t.v3BuildZero());var i=this.cpuF32,s=n*e.PARTICLE_SPAN+e.PARTICLE_VEL;return r[0]=this.maxSpeed*i[s],r[1]=this.maxSpeed*i[s+1],r[2]=this.maxSpeed*i[s+2],r},e.prototype.queryRemainingLife=function(t){var n=this.cpuU32[t*e.PARTICLE_SPAN+e.PARTICLE_LIFE];return H.decodeHalfUnsignedFloat(n>>>16)*this.maxLifeTime},e.prototype.queryUserData=function(t){return this.cpuU32[t*e.PARTICLE_SPAN+e.PARTICLE_DATA]},e.prototype.render=function(e){if(!this.hasLiveParticles)return;var t=this.graphicsDevice,n=this.renderer,r=this.geometry;t.setStream(r.vertexBuffer,r.semantics),t.setTechnique(n.technique),t.setTechniqueParameters(this.renderParameters),t.setTechniqueParameters(e.parameters),t.draw(r.primitive,r.particleStride*this.maxParticles,0)},e.prototype.renderDebug=function(){},e.PARTICLE_DIMX=3,e.PARTICLE_DIMY=3,e.PARTICLE_SPAN=9,e.PARTICLE_POS=0,e.PARTICLE_VEL=3,e.PARTICLE_LIFE=6,e.PARTICLE_ANIM=7,e.PARTICLE_DATA=8,e.template={center:[0,0,0],halfExtents:[1,1,1],maxSpeed:null,maxParticles:null,zSorted:!1,maxSortSteps:136,trackingEnabled:!1,maxLifeTime:null},e.numCreated=0,e}(),Y=function(){function e(){this.mergePass=0,this.mergeStage=0}return e.prototype.constructor=function(){},e.create=function(n){var r=new e;r.graphicsDevice=n.graphicsDevice,r.parameters=r.graphicsDevice.createTechniqueParameters({modelView:t.m43BuildIdentity(),projection:t.m44BuildIdentity(),mappingTable:null,mappingSize:t.v2BuildZero(),invMappingSize:t.v2BuildZero(),mappingPos:t.v2BuildZero()});var i=n.sharedRenderContext;return r.renderContextShared=i,r.renderContext=i,r.setSystem(n.system),r},e.prototype.destroy=function(){this.setSystem(null),this.renderContext=null},e.prototype.setMappingContext=function(e){this.mappingContext=e;var n=e.renderTargets[this.currentMapping].colorTexture0,r=e.uvRectangle,i=t.v2Build(n.width,n.height),s=t.v2Reciprocal(i),o=t.v2Build(r[0]*n.width,r[1]*n.height),u=this.parameters;t.v2Copy(i,u.mappingSize),t.v2Copy(s,u.invMappingSize),t.v2Copy(o,u.mappingPos),u.mappingTable=n},e.initSorting=function(t){if(e.mergeSortTechnique)return;var n=t.createShader({version:1,name:"particles-sort.cgfx",samplers:{previousState:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071},creationState:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071},mappingTable:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071},vParticleState:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071},fParticleState:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071},animation:{MinFilter:9728,MagFilter:9728,WrapS:33071,WrapT:33071}},parameters:{textureSize:{type:"float",columns:2},invTextureSize:{type:"float",columns:2},regionSize:{type:"float",columns:2},invRegionSize:{type:"float",columns:2},regionPos:{type:"float",columns:2},halfExtents:{type:"float",columns:3},center:{type:"float",columns:3},maxLifeTime:{type:"float"},previousState:{type:"sampler2D"},shift:{type:"float",columns:3},timeStep:{type:"float"},lifeStep:{type:"float"},maxSpeed:{type:"float"},creationState:{type:"sampler2D"},creationScale:{type:"float",columns:2},projection:{type:"float",rows:4,columns:4},modelView:{type:"float",rows:4,columns:3},mappingTable:{type:"sampler2D"},mappingSize:{type:"float",columns:2},invMappingSize:{type:"float",columns:2},mappingPos:{type:"float",columns:2},vParticleState:{type:"sampler2D"},fParticleState:{type:"sampler2D"},animationSize:{type:"float",columns:2},animation:{type:"sampler2D"},zSorted:{type:"bool"},zBound:{type:"float"},cpass:{type:"float"},PmS:{type:"float"},twoStage:{type:"float"},twoStage_PmS_1:{type:"float"}},techniques:{prepare_sort:[{parameters:["regionSize","invMappingSize","mappingPos","invTextureSize","regionSize","invRegionSize","regionPos","modelView","mappingTable","invMappingSize","mappingPos","fParticleState","zBound"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_update_mapping","fp_prepare_sort"]}],sort_pass:[{parameters:["regionSize","invMappingSize","mappingPos","regionSize","invRegionSize","mappingTable","invMappingSize","mappingPos","cpass","PmS","twoStage","twoStage_PmS_1"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_update_mapping","fp_merge_sort_pass"]}]},programs:{fp_merge_sort_pass:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _TMP7;float _TMP11;float _TMP12;vec2 _TMP6;vec2 _TMP5;float _TMP10;float _TMP2;float _TMP3;float _TMP4;float _TMP1;vec2 _TMP0;vec2 _p0049;vec2 _x0051;float _x0055;float _x0059;float _x0061;float _u0063;float _index0063;float _v0063;float _y0065;float _x0067;float _TMP78;float _TMP90;uniform vec2 regionSize;uniform vec2 invRegionSize;uniform sampler2D mappingTable;uniform vec2 invMappingSize;uniform vec2 mappingPos;uniform float cpass;uniform float PmS;uniform float twoStage;uniform float twoStage_PmS_1;void main()\n{vec4 _self;float _index1;float _j;float _compare;vec4 _other;_TMP0=(mappingPos+(regionSize*tz_TexCoord[0].xy)/vec2(3.0,3.0))*invMappingSize;_self=texture2D(mappingTable,_TMP0);_x0051=(tz_TexCoord[0].xy*regionSize)/vec2(3.0,3.0);_p0049=floor(_x0051);_index1=(_p0049.y*regionSize.x)/3.0+_p0049.x;_x0055=_index1/twoStage;_TMP10=floor(_x0055);_TMP1=_index1-twoStage*_TMP10;_j=floor(_TMP1);if(_j<PmS||_j>twoStage_PmS_1){_TMP2=0.0;}else{_x0059=(_j+PmS)/cpass;_x0061=_x0059/2.0;_TMP10=floor(_x0061);_TMP4=_x0059-2.0*_TMP10;if(_TMP4<1.0){_TMP3=1.0;}else{_TMP3=-1.0;}\n_TMP2=_TMP3;}\n_compare=float(_TMP2);_index0063=_index1+_compare*cpass;_y0065=regionSize.x/3.0;_x0067=_index0063/_y0065;_TMP10=floor(_x0067);_u0063=_index0063-_y0065*_TMP10;_v0063=(_index0063-_u0063)*invRegionSize.x*3.0;_TMP5=vec2(_u0063+0.5,_v0063+0.5)*invRegionSize*vec2(3.0,3.0);_TMP6=(mappingPos+(regionSize*_TMP5)/vec2(3.0,3.0))*invMappingSize;_other=texture2D(mappingTable,_TMP6);_TMP11=dot(_self.zw,vec2(3.89099121E-03,9.96093750E-01));_TMP12=min(1.0,_TMP11);_TMP78=max(0.0,_TMP12);_TMP11=dot(_other.zw,vec2(3.89099121E-03,9.96093750E-01));_TMP12=min(1.0,_TMP11);_TMP90=max(0.0,_TMP12);if(_TMP78*_compare<=_TMP90*_compare){_TMP7=_self;}else{_TMP7=_other;}\ngl_FragColor=_TMP7;}"},vp_update_mapping:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;\nvec4 _outPosition1;vec2 _outParticle1;vec2 _TMP0;uniform vec2 regionSize;uniform vec2 invMappingSize;uniform vec2 mappingPos;void main()\n{vec2 _TMP32;_TMP0=(mappingPos+(regionSize*ATTR0.xy)/vec2(3.0,3.0))*invMappingSize;_TMP32=_TMP0*2.0-1.0;_outPosition1=vec4(_TMP32.x,_TMP32.y,0.0,1.0);_outParticle1=ATTR0.xy;tz_TexCoord[0].xy=ATTR0.xy;gl_Position=_outPosition1;}"},fp_prepare_sort:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nvec4 _ret_0;vec2 _TMP5;float _TMP11;vec4 _TMP10;float _TMP13;float _TMP6;vec4 _TMP1;vec2 _TMP0;vec2 _p0053;vec4 _life0055;vec2 _c0057;float _TMP64;vec3 _TMP70;vec2 _uv0073;float _TMP74;float _TMP86;float _TMP92;vec2 _uv0093;float _TMP104;float _TMP110;vec2 _uv0111;float _TMP122;vec2 _TMP128;vec2 _enc10129;float _TMP132;vec2 _x0139;uniform vec2 invTextureSize;uniform vec2 regionSize;uniform vec2 invRegionSize;uniform vec2 regionPos;uniform vec3 modelView[4];uniform sampler2D mappingTable;uniform vec2 invMappingSize;uniform vec2 mappingPos;uniform sampler2D fParticleState;uniform float zBound;void main()\n{vec2 _particleUV;float _z1;_TMP0=(mappingPos+(regionSize*tz_TexCoord[0].xy)/vec2(3.0,3.0))*invMappingSize;_TMP1=texture2D(mappingTable,_TMP0);_p0053=(_TMP1.xy*255.0)*vec2(3.0,3.0)*invRegionSize;_particleUV=(regionPos+regionSize*_p0053)*invTextureSize;_c0057=_particleUV+vec2(2.5,0.5)*invTextureSize;_life0055=texture2D(fParticleState,_c0057);_TMP6=dot(_life0055.zw,vec2(3.89099121E-03,9.96093750E-01));_TMP11=min(1.0,_TMP6);_TMP64=max(0.0,_TMP11);if(_TMP64<=0.0){_ret_0=vec4(_TMP1.x,_TMP1.y,1.0,1.0);gl_FragColor=_ret_0;return;}else{_uv0073=_particleUV+vec2(0.5,0.5)*invTextureSize;_TMP10=texture2D(fParticleState,_uv0073);_TMP13=dot(_TMP10,vec4(5.93718141E-08,1.51991844E-05,3.89099121E-03,9.96093750E-01));_TMP11=min(1.0,_TMP13);_TMP86=max(0.0,_TMP11);_TMP74=(_TMP86-0.5)*2.0;_uv0093=_uv0073+vec2(0.0,invTextureSize.y);_TMP10=texture2D(fParticleState,_uv0093);_TMP13=dot(_TMP10,vec4(5.93718141E-08,1.51991844E-05,3.89099121E-03,9.96093750E-01));_TMP11=min(1.0,_TMP13);_TMP104=max(0.0,_TMP11);_TMP92=(_TMP104-0.5)*2.0;_uv0111=_uv0073+vec2(0.0,2.0*invTextureSize.y);_TMP10=texture2D(fParticleState,_uv0111);_TMP13=dot(_TMP10,vec4(5.93718141E-08,1.51991844E-05,3.89099121E-03,9.96093750E-01));_TMP11=min(1.0,_TMP13);_TMP122=max(0.0,_TMP11);_TMP110=(_TMP122-0.5)*2.0;_TMP70=vec3(_TMP74,_TMP92,_TMP110);_z1=_TMP70.x*modelView[0].z+_TMP70.y*modelView[1].z+_TMP70.z*modelView[2].z;_z1=(_z1+zBound)/(2.0*zBound);if(_z1>=1.0){_TMP128=vec2(1.0,1.0);}else{_TMP11=min(1.0,_z1);_TMP132=max(0.0,_TMP11);_x0139=_TMP132*vec2(256.0,1.0);_TMP5=fract(_x0139);_enc10129=_TMP5*256.0;_enc10129.y=_enc10129.y-_enc10129.x/256.0;_TMP128=_enc10129/255.0;}\n_ret_0=vec4(_TMP1.x,_TMP1.y,_TMP128.x,_TMP128.y);gl_FragColor=_ret_0;return;}\ngl_FragColor=_ret_0;}"}}});e.prepareSortTechnique=n.getTechnique("prepare_sort"),e.mergeSortTechnique=n.getTechnique("sort_pass"),e.prepareSortParameters=t.createTechniqueParameters({zBound:0}),e.mergeSortParameters=t.createTechniqueParameters({cpass:0,PmS:0,twoStage:0,twoStage_PmS_1:0,mappingTable:null})},e.prototype.setSystem=function(t){if(this.system===
t)return;this.system&&(this.system.views.splice(this.system.views.indexOf(this),1),this.system.zSorted&&(this.renderContextShared?this.renderContext.release(this.mappingContext):(this.renderContext.destroy(),this.renderContext=null))),this.system=t;if(!t)return;t.views.push(this);if(t.zSorted){e.initSorting(this.graphicsDevice);var n=t.particleSize;this.renderContextShared||(this.renderContext=new $({graphicsDevice:this.graphicsDevice})),this.currentMapping=0,this.setMappingContext(this.renderContext.allocate({width:n[0],height:n[1],set:this.setMappingContext.bind(this)}));var r=n[0]*n[1],i=new Uint8Array(r*4),s;for(s=0;s<r;s+=1){var o=s%n[0],u=(s-o)/n[0]|0;i[s<<2]=o,i[(s<<2)+1]=u}var a=this.mappingContext,f=a.uvRectangle,l=a.renderTargets[this.currentMapping].colorTexture0;l.setData(i,0,0,f[0]*l.width,f[1]*l.height,f[2]*l.width,f[3]*l.height)}},e.prototype.update=function(e,n){var r=this.parameters;e&&t.m43Copy(e,r.modelView),n&&t.m44Copy(n,r.projection),this.system.zSorted&&(this.sort(),this.parameters.mappingTable=this.mappingContext.renderTargets[this.currentMapping].colorTexture0)},e.prototype.render=function(){this.system.render(this)},e.prototype.sort=function(){if(!this.system.hasLiveParticles)return;var t=this.graphicsDevice;t.setStream(G.fullTextureVertices,G.fullTextureSemantics);var n=this.mappingContext.renderTargets,r=e.prepareSortParameters,i=Math.abs,s=this.parameters.modelView;r.zBound=i(s[2])+i(s[5])+i(s[8]),this.parameters.mappingTable=n[this.currentMapping].colorTexture0,t.beginRenderTarget(n[1-this.currentMapping]),t.setTechnique(e.prepareSortTechnique),t.setTechniqueParameters(this.system.renderParameters),t.setTechniqueParameters(this.parameters),t.setTechniqueParameters(r),t.draw(t.PRIMITIVE_TRIANGLE_STRIP,4,0),t.endRenderTarget(),this.currentMapping=1-this.currentMapping;var o=e.mergeSortParameters;t.setTechnique(e.mergeSortTechnique),t.setTechniqueParameters(this.system.renderParameters),t.setTechniqueParameters(this.parameters);var u=this.system.maxSortSteps;while(u>0){u-=1;var a=1<<this.mergePass,f=1<<this.mergeStage;o.cpass=a,o.PmS=a%f,o.twoStage=2*f,o.twoStage_PmS_1=2*f-a%f-1,o.mappingTable=n[this.currentMapping].colorTexture0,t.beginRenderTarget(n[1-this.currentMapping]),t.setTechniqueParameters(o),t.draw(t.PRIMITIVE_TRIANGLE_STRIP,4,0),t.endRenderTarget(),this.currentMapping=1-this.currentMapping,this.mergePass-=1;if(this.mergePass<0){this.mergeStage+=1,this.mergePass=this.mergeStage;if(this.mergeStage>this.system.maxMergeStage){this.mergePass=this.mergeStage=0;break}}}},e}(),Z=function(){function e(){this.disabled=!1,this.geometryType="ParticleSystem",this.drawParameters=null,this.diffuseDrawParameters=null,this.shadowDrawParameters=null,this.frameVisible=0,this.queryCounter=0,this.diffuseShadowDrawParameters=null,this.shadowMappingDrawParameters=null,this.geometry=null,this.surface=null,this.techniqueParameters=null,this.skinController=null,this.isNormal=!1,this.node=null,this.normalInfos=null}return e.prototype.addCustomWorldExtents=function(e){throw"Not supported"},e.prototype.clone=function(){throw"Not supported"},e.prototype.getCustomWorldExtents=function(){return this.getWorldExtents()},e.prototype.getMaterial=function(){return this.sharedMaterial},e.prototype.getWorldExtents=function(){var e=this.node;if(e.worldUpdate>this.worldExtentsUpdate||this.invalidated)this.invalidated=!1,this.updateWorldExtents(),this.worldExtentsUpdate=e.worldUpdate;return this.worldExtents},e.prototype.hasCustomWorldExtents=function(){return!0},e.prototype.removeCustomWorldExtents=function(){throw"Not supported"},e.prototype.setMaterial=function(e){throw"Not supported"},e.prototype.getNode=function(){return this.node},e.prototype.setNode=function(e){this.node&&this.node.renderableWorldExtentsRemoved(),this.node=e,this.node&&this.node.renderableWorldExtentsUpdated(!1),this.worldExtentsUpdate=-1},e.prototype.isSkinned=function(){return!1},e.prototype.setLocalTransform=function(e){e&&this.localTransform!==e&&t.m43Copy(e,this.localTransform),this.invalidated=!0,this.node&&this.node.renderableWorldExtentsUpdated(!0)},e.prototype.setFixedOrientation=function(e){this.fixedOrientation!==e&&(this.fixedOrientation=e,this.invalidated=!0,this.node&&this.node.renderableWorldExtentsUpdated(!0))},e.prototype.updateWorldExtents=function(){var e=this.center,n=this.halfExtents,r=this.worldExtents,i=this.world,s=this.node,o=this.localTransform,u=s.world;if(this.fixedOrientation){var a=o[9],f=o[10],l=o[11];i[0]=o[0],i[1]=o[1],i[2]=o[2],i[3]=o[3],i[4]=o[4],i[5]=o[5],i[6]=o[6],i[7]=o[7],i[8]=o[8],i[9]=u[0]*a+u[3]*f+u[6]*l+u[9],i[10]=u[1]*a+u[4]*f+u[7]*l+u[10],i[11]=u[2]*a+u[5]*f+u[8]*l+u[11]}else t.m43Mul(o,u,i);var c=i[0],h=i[1],p=i[2],d=i[3],v=i[4],m=i[5],g=i[6],y=i[7],b=i[8],w=i[9],E=i[10],S=i[11],x=e[0],T=e[1],N=e[2],C=w+(c*x+d*T+g*N),k=E+(h*x+v*T+y*N),L=S+(p*x+m*T+b*N),A=n[0],O=n[1],M=n[2],_=(c<0?-c:c)*A+(d<0?-d:d)*O+(g<0?-g:g)*M,D=(h<0?-h:h)*A+(v<0?-v:v)*O+(y<0?-y:y)*M,P=(p<0?-p:p)*A+(m<0?-m:m)*O+(b<0?-b:b)*M;r[0]=C-_,r[1]=k-D,r[2]=L-P,r[3]=C+_,r[4]=k+D,r[5]=L+P},e.create=function(n){var r=n.graphicsDevice;if(!e.material){var i=e.material=k.create(r);i.meta.far=!1,i.meta.transparent=!0,i.meta.decal=!1,i.meta.noshadows=!0}var s=new e;return s.resizedGeometryCb=e.resizedGeometry.bind(null,s),s.graphicsDevice=r,s.passIndex=n.passIndex,s.sharedMaterial=e.material,s.rendererInfo={},s.views=[],s.fixedOrientation=!0,s.world=t.m43BuildIdentity(),s.worldExtents=new Float32Array(6),s.localTransform=t.m43BuildIdentity(),s.sharedRenderContext=n.sharedRenderContext,s.setSystem(n.system),s},e.prototype.releaseViews=function(e){var t=this.views;for(var n in t)t.hasOwnProperty(n)&&(e?e(t[n]):t[n].destroy());this.views=[]},e.prototype.destroy=function(){this.releaseViews(),this.views=null},e.prototype.renderUpdate=function(n){this.system||this.setSystem(this.lazySystem()),this.system.sync(this.frameVisible);var r=n;r.__particle_id===undefined&&(r.__particle_id=e.cameraId,e.cameraId+=1);var i=this.views,s=i[r.__particle_id];s||(this.lazyView&&(s=this.lazyView()),s||(s=Y.create({graphicsDevice:this.graphicsDevice,sharedRenderContext:this.sharedRenderContext})),s.setSystem(this.system),i[r.__particle_id]=s),t.m43Mul(this.world,n.viewMatrix,s.parameters.modelView),s.update(null,n.projectionMatrix),this.drawParameters[0].setTechniqueParameters(1,s.parameters)},e.prototype.setLazyView=function(e){this.lazyView=e},e.prototype.setLazySystem=function(e,t,n){this.setSystem(null),this.center=t,this.halfExtents=n,this.lazySystem=e,this.worldExtentsUpdate=-1},e.prototype.setSystem=function(e){this.system&&this.system.geometry.unregister(this.resizedGeometryCb),this.system=e;if(e){e.geometry.register(this.resizedGeometryCb),this.center=e.center,this.halfExtents=e.halfExtents,this.worldExtentsUpdate=-1;var t=this.graphicsDevice.createDrawParameters();t.setVertexBuffer(0,e.geometry.vertexBuffer),t.setSemantics(0,e.geometry.semantics),t.technique=e.renderer.technique,t.primitive=e.geometry.primitive,t.count=e.maxParticles*e.geometry.particleStride,t.userData={passIndex:this.passIndex},t.setTechniqueParameters(0,e.renderParameters),t.setTechniqueParameters(1,null),this.drawParameters=[t],this.shadowDrawParameters=this.drawParameters}},e.resizedGeometry=function(e){var t=e.system;if(t){var n=e.drawParameters[0];n.setVertexBuffer(0,t.geometry.vertexBuffer)}},e.cameraId=0,e}(),et=function(){function e(){this.offsetTime=0}return e.compressArchetype=function(t){return nt.recordDelta(e.template,t)},e.parseArchetype=function(t,n){function r(e){return X.checkNumber.bind(null,t,"default synchronizer archetype",e)}function i(e){return X.checkNullNumber.bind(null,t,"default synchronizer archetype",e)}function s(e){return function(){return e}}function o(e,t,r){return X.maybeField(n,e,t(e),r)}return W.isNullUndefined(n)?W.copy(e.template):W.isObject(n)?(X.extraFields(t,"default synchronizer archetype",n,["fixedTimeStep","maxSubSteps","trailFollow"]),{fixedTimeStep:o("fixedTimeStep",i,s(null)),maxSubSteps:o("maxSubSteps",r,s(3)),trailFollow:o("trailFollow",r,s(1))}):(t.error("synchronizer archetype should be an object"),null)},e.prototype.applyArchetype=function(e){this.fixedTimeStep=e.fixedTimeStep,this.maxSubSteps=e.maxSubSteps,this.trailFollow=e.trailFollow},e.prototype.synchronize=function(e,t){if(this.fixedTimeStep!==undefined&&this.fixedTimeStep!==null){t+=this.offsetTime;var n=Math.floor(t/this.fixedTimeStep);n>this.maxSubSteps?(n=this.maxSubSteps,t/=n,this.offsetTime=0):(this.offsetTime=t-n*this.fixedTimeStep,t=this.fixedTimeStep);while(n>0)n-=1,this.update(e,t)}else this.update(e,t)},e.prototype.update=function(e,n){var r=this.shift;if(this.renderable){var i=this.renderable.world,s=this.previousPos;s||(s=this.previousPos=t.m43Pos(i)),r[0]=(s[0]-i[9])*this.trailFollow,r[1]=(s[1]-i[10])*this.trailFollow,r[2]=(s[2]-i[11])*this.trailFollow,s[0]=i[9],s[1]=i[10],s[2]=i[11]}else t.v3BuildZero(r);e.beginUpdate(n,r);var o=this.emitters,u=o.length,a;for(a=0;a<u;a+=1)o[a].enabled&&o[a].sync(this,e,n);var f=this.events;f.update(n);while(f.hasNext()){var l=f.next();l.fun(l,this,e)}e.endUpdate()},e.prototype.enqueue=function(e){this.events.insert(e,e.time)},e.prototype.addEmitter=function(e){this.emitters.indexOf(e)===-1&&this.emitters.push(e)},e.prototype.removeEmitter=function(e){var t=this.emitters.indexOf(e);t!==-1&&this.emitters.splice(t,1)},e.prototype.reset=function(){var t=this.emitters,n=t.length;while(n!==0)n-=1,this.removeEmitter(t[n]);this.offsetTime=0,this.events.clear(e.recycleEvent)},e.recycleEvent=function(e){e.recycle()},e.create=function(n){var r=new e;return r.events=new I,r.emitters=[],r.fixedTimeStep=n.fixedTimeStep,r.maxSubSteps=n.maxSubSteps!==undefined?n.maxSubSteps:3,r.renderable=n.renderable,r.trailFollow=n.trailFollow!==undefined?n.trailFollow:1,r.shift=t.v3BuildZero(),r},e.template={fixedTimeStep:null,maxSubSteps:3,trailFollow:1},e}(),tt=function(){function e(){}return e.compressArchetype=function(t){return nt.recordDelta(e.template,t)},e.parseArchetype=function(n,r,i){function s(e,t){return typeof t=="undefined"&&(t=""),X.checkVector.bind(null,n,"default emitter archetype"+t,e,3)}function o(e,t){return typeof t=="undefined"&&(t=""),X.checkNumber.bind(null,n,"default emitter archetype"+t,e)}function u(e,t){return typeof t=="undefined"&&(t=""),X.checkBoolean.bind(null,n,"default emitter archetype"+t,e)}function a(e,t){return typeof t=="undefined"&&(t=""),function(r){return r=X.checkString(n,"default emitter archetype"+t,e,r),r&&r!=="uniform"&&r!=="normal"?(n.error("Unknown distribution type, should be 'uniform' or 'normal'"),null):r}}function f(e){return function(){return e}}function l(e,t,n,r){return X.maybeField(e,t,n(t),r)}return W.isNullUndefined(r)?(n.error("archetype cannot be null for DefaultParticleEmitter"),null):W.isObject(r)?(X.extraFields(n,"default emitter archetype",r,["forceCreation","usePrediction","emittance","particle","position","velocity"]),{forceCreation:l(r,"forceCreation",u,f(!1)),usePrediction:l(r,"usePrediction",u,f(!0)),emittance:X.maybeField(r,"emittance",function(t){function r(e){return o(e," emittance")}return W.isNullUndefined(t)?W.copy(e.template.emittance):W.isObject(t)?(X.extraFields(n,"default emitter archetype emittance",t,["delay","rate","burstMin","burstMax"]),{delay:l(t,"delay",r,f(0)),rate:l(t,"rate",r,f(4)),burstMin:l(t,"burstMin",r,f(1)),burstMax:l(t,"burstMax",r,f(1))}):(n.error("default emitter archetype emittance should be an object"),null)},W.copy.bind(null,e.template.emittance)),particle:X.runField(n,"default emitter",r,"particle",function(e){function t(e){return o(e," particle")}function r(e){return u(e," particle")}function s(e){return function(t){return W.isObject(t)||n.error("default emitter archetype "+e+" should be an object"),t}}if(W.isNullUndefined(e))return n.error("default emitter archetype particle must be defined"),null;if(!W.isObject(e))return n.error("default emitter archetype particle should be an object"),null;X.extraFields(n,"default emitter archetype particle",e,["lifeTimeMin","lifeTimeMax","renderUserData","updateUserData","useAnimationLifeTime","lifeTimeScaleMin","lifeTimeScaleMax","name"]);var a=X.stringField(n,"default emitter archetype particle",e,"name");a&&!i.hasOwnProperty(a)&&n.error("Emitter references non-existant particle of system '"+a+"'");var c={name:a,lifeTimeMin:l(e,"lifeTimeMin",t,f(1)),lifeTimeMax:l(e,"lifeTimeMax",t,f(1)),useAnimationLifeTime:l(e,"useAnimationLifeTime",r,f(!0)),lifeTimeScaleMin:l(e,"lifeTimeScaleMin",t,f(1)),lifeTimeScaleMax:l(e,"lifeTimeScaleMax",t,f(1)),renderUserData:l(e,"renderUserData",s,f({})),updateUserData:l(e,"updateUserData",s,f({}))};return c}),position:X.maybeField(r,"position",function(r){function i(e){return o(e," position")}function c(e){return a(e," position")}function h(e){return s(e," position")}function p(e){return u(e," position")}return W.isNullUndefined(r)?W.copy(e.template.position):W.isObject(r)?(X.extraFields(n,"default emitter archetype position",r,["position","spherical","normal","radiusMin","radiusMax","radiusDistribution","radiusSigma"]),{position:l(r,"position",h,t.v3BuildZero),spherical:l(r,"spherical",p,f(!1)),normal:l(r,"normal",h,t.v3BuildYAxis),radiusMin:l(r,"radiusMin",i,f(0)),radiusMax:l(r,"radiusMax",i,f(0)),radiusDistribution:l(r,"radiusDistribution",c,f("uniform")),radiusSigma:l(r,"radiusSigma",i,f(.25))}):(n.error("default emitter archetype position should be an object"),null)},W.copy.bind(null,e.template.position)),velocity:X.maybeField(r,"velocity",function(t){function r(e){return o(e," velocity")}function i(e){return a(e," velocity")}return W.isNullUndefined(t)?W.copy(e.template.velocity):W.isObject(t)?(X.extraFields(n,"default emitter archetype velocity",t,["theta","phi","speedMin","speedMax","flatSpread","flatSpreadAngle","flatSpreadDistribution","flatSpreadSigma","conicalSpread","conicalSpreadDistribution","conicalSpreadSigma"]),{theta:l(t,"theta",r,f(0)),phi:l(t,"phi",r,f(0)),speedMin:l(t,"speedMin",r,f(1)),speedMax:l(t,"speedMax",r,f(1)),flatSpread:l(t,"flatSpread",r,f(0)),flatSpreadAngle:l(t,"flatSpreadAngle",r,f(0)),flatSpreadDistribution:l(t,"flatSpreadDistribution",i,f("uniform")),flatSpreadSigma:l(t,"flatSpreadSigma",r,f(.25)),conicalSpread:l(t,"conicalSpread",r,f(0)),conicalSpreadDistribution:l(t,"conicalSpreadDistribution",i,f("uniform")),conicalSpreadSigma:l(t,"conicalSpreadSigma",r,f(.25))}):(n.error("default emitter archetype velocity should be an object"),null)},W.copy.bind(null,e.template.velocity))}):(n.error("emitter archetype should be an object"),null)},e.prototype.applyArchetype=function(e,n,r,i){this.forceCreation=e.forceCreation,this.usePrediction=e.usePrediction,this.emittance=W.copyFields(e.emittance,this.emittance),this.position=W.copyFields(e.position,this.position),this.velocity=W.copyFields(e.velocity,this.velocity);var s=n[e.particle.name],o=e.particle,u,a;o.useAnimationLifeTime?(u=o.lifeTimeScaleMin*s.lifeTime,a=o.lifeTimeScaleMax*s.lifeTime):(u=o.lifeTimeMin,a=o.lifeTimeMax);var f=this.particle||{};this.particle=f,f.animationRange=t.v2Copy(s.animationRange,f.animationRange),o.userData!==undefined?f.userData=o.userData:r&&i&&(f.userData=r.createUserData(o.renderUserData)|i.createUserData(o.updateUserData)),f.lifeTimeMin=u,f.lifeTimeMax=a},e.prototype.getMaxLifeTime=function(){return this.particle.lifeTimeMax},e.prototype.getMaxParticles=function(){var e=this.emittance;return Math.ceil(this.particle.lifeTimeMax*e.rate*e.burstMax)},e.prototype.getMaxSpeed=function(){return this.velocity.speedMax},e.prototype.reset=function(){this.bursting=null},e.eventFun=function(t,n,r){r.createParticle(t.particle),e.eventPool.push(t)},e.recycleFun=function(t){e.eventPool.push(t)},e.prototype.sync=function(t,n,r){var i=this.particle,s=this.emittance,o=this.position,u=this.velocity,a=r+this.offsetTime,f=Math.ceil(a*s.rate);this.offsetTime+=r-Math.max(0,f)/s.rate;if(f<=0)return;this.bursting!==null&&(f=Math.min(f,this.bursting)),this.bursting!==null&&(this.bursting-=f,this.bursting===0&&(this.bursting=null,this.enabled=!1));var l=i.lifeTimeMax,c=Math.max(0,Math.ceil((a-l)*s.rate));if(c>=f)return;var h=o.radiusSigma*o.radiusSigma,p=1/Math.sqrt(h*2*Math.PI),d=p*Math.exp(-1/(2*h)),v=u.conicalSpreadSigma*u.conicalSpreadSigma,m=1/Math.sqrt(v*2*Math.PI),g=m*Math.exp(-1/(2*v)),y=2*u.conicalSpread/Math.PI,b=u.flatSpreadSigma*u.flatSpreadSigma,w=1/Math.sqrt(b*2*Math.PI),E=w*Math.exp(-1/(2*b)),S=e.eventPool,x=Math.sin,T=Math.cos,N=Math.acos,C=Math.random,k=Math.exp,L=Math.pow,A=Math.sqrt,O=Math.PI,M;for(M=c;M<f;M+=1){var _=s.burstMin+C()*(s.burstMax-s.burstMin),D;for(D=0;D<_;D+=1){var P=M/s.rate-a,H=i.lifeTimeMin+C()*(i.lifeTimeMax-i.lifeTimeMin);if(P+H<=0)continue;var B;S.length!=0?B=S.pop():B={particle:{position:new Float32Array(3),velocity:new Float32Array(3),animationRange:new Float32Array(2)},fun:e.eventFun,recycle:e.recycleFun},B.time=P;var j=B.particle,F=j.position,I=j.velocity,q=j.animationRange;j.lifeTime=H+P,j.forceCreation=this.forceCreation,j.userData=i.userData|n.renderer.createUserDataSeed()|n.updater.createUserDataSeed();var R,U,z,W,X,V,$,J,K,Q,G,Y,Z;F[0]=o.position[0],F[1]=o.position[1],F[2]=o.position[2];if(o.radiusMax!==0){W=0;switch(o.radiusDistribution){case"uniform":W=C();break;case"normal":W=C(),W=p*k(-W*W/(2*h)),W=(W-d)/(p-d)}if(o.spherical)J=N(1-C()*2),K=C()*O*2,Q=x(J),G=T(J),Y=x(K),Z=T(K),W=L(W,1/3),$=o.radiusMin+W*(o.radiusMax-o.radiusMin),F[0]+=Z*Q*$,F[1]+=G*$,F[2]+=Y*Q*$;else{W=A(W),$=o.radiusMin+W*(o.radiusMax-o.radiusMin);var et,tt,nt,rt,it,st=o.normal,ot=st[0],ut=st[1],at=st[2];if(ot==0&&at==0)et=it=$,tt=nt=rt=0;else{var ft=$/A(ot*ot+at*at);et=-at*ft,tt=ot*ft,nt=-tt*ut,rt=tt*ot-et*at,it=et*ut,ft=$/A(nt*nt+rt*rt+it*it),nt*=ft,rt*=ft,it*=ft}J=C()*O*2,G=T(J),Q=x(J),F[0]+=et*G+nt*Q,F[1]+=rt*Q,F[2]+=tt*G+it*Q}}K=u.phi,J=u.theta,Q=x(J),G=T(J),Y=x(K),Z=T(K);if(u.conicalSpread!==0){W=0;switch(u.conicalSpreadDistribution){case"uniform":W=C();break;case"normal":W=C(),W=m*k(-W*W/(2*v)),W=(W-g)/(m-g)}X=N(1-W*y),V=C()*O*2;var lt=x(X),ct=T(X),ht=x(V),pt=T(V),dt=pt*lt,vt=G*dt+Q*ct,mt=ht*lt,gt=ht*ct,yt=pt*ct,bt=G*yt-Q*lt;R=Z*vt-Y*mt,U=G*ct-Q*dt,z=Y*vt+Z*mt}else R=Z*Q,U=G,z=Y*Q;var wt,Et,St,xt,Tt,Nt,Ct;if(u.flatSpread!==0){W=0;switch(u.flatSpreadDistribution){case"uniform":W=(C()-.5)*2;break;case"normal":var kt=(C()-.5)*2;W=w*k(-kt*kt/(2*b)),W=(W-E)/(w-E),kt<0&&(W=-W)}wt=W*u.flatSpread,Et=x(wt),St=T(wt),xt=1-St,Ct=Z*Et;var Lt=Z*Y*xt,At=Y*Et;Tt=(Y*Y*xt+St)*R-(Lt*z+Ct*U),Nt=Ct*R+St*U+At*z,z=(Z*Z*xt+St)*z-(Lt*R+At*U),R=Tt,U=Nt}if(u.flatSpreadAngle!==0){wt=u.flatSpreadAngle,Et=x(wt),St=T(wt),xt=1-St;var Ot=Z*Q,Mt=Y*Q,_t=Ot*xt,Dt=Mt*xt,Pt=Ot*Et,Ht=Mt*Et,Bt=Mt*_t,jt=Dt*G,Ft=_t*G;Ct=G*Et,Tt=(Ot*_t+St)*R+(Ft-Ht)*U+(Bt+Ct)*z,Nt=(Ft+Ht)*R+(G*G*xt+St)*U+(jt-Pt)*z,z=(Mt*Dt+St)*z+(jt+Pt)*U+(Bt-Ct)*R,R=Tt,U=Nt}var It=u.speedMin+C()*(u.speedMax-u.speedMin);I[0]=It*R,I[1]=It*U,I[2]=It*z,q[0]=i.animationRange[0],q[1]=i.animationRange[1],this.usePrediction&&(n.updater.predict(n.updateParameters,F,I,0,-P),q[0]=q[1]-(q[1]-q[0])*(1+P/H)),t.enqueue(B)}}},e.create=function(){var t=new e;return t.applyArchetype(e.createArchetype,e.createParticleDefns,null,null),t.enabled=!1,t.bursting=null,t},e.prototype.enable=function(){this.enabled=!0,this.offsetTime=-this.emittance.delay},e.prototype.disable=function(){this.enabled=!1},e.prototype.burst=function(e){typeof e=="undefined"&&(e=1),this.enable(),this.bursting=e},e.prototype.timeout=function(e){var t=this.emittance,n=this.particle,r=t.rate*(e-n.lifeTimeMax-t.delay);this.burst(r)},e.template={forceCreation:!1,usePrediction:!0,emittance:{delay:0,rate:4,burstMin:1,burstMax:1},particle:{name:null,lifeTimeMin:1,lifeTimeMax:1,useAnimationLifeTime:!0,lifeTimeScaleMin:1,lifeTimeScaleMax:1,renderUserData:{},updateUserData:{}},position:{position:[0,0,0],spherical:!1,normal:[0,1,0],radiusMin:0,radiusMax:0,radiusDistribution:"uniform",radiusSigma:.25},velocity:{theta:0,phi:0,speedMin:1,speedMax:1,flatSpread:0,flatSpreadAngle:0,flatSpreadDistribution:"uniform",flatSpreadSigma:.25,conicalSpread:0,conicalSpreadDistribution:"uniform",conicalSpreadSigma:.25}},e.eventPool=[],e.createArchetype=e.parseArchetype(null,{particle:{name:"#",useAnimationLifeTime:!1}},{"#":""}),e.createParticleDefns={"#":{animationRange:[0,1]}},e}(),nt=function(){function e(){this.uniqueId=0,this.initialized=!1,this.failOnWarnings=!0,this.time=0}return e.prototype.update=function(e){this.time+=e;var t=this.queue;t.update(e);while(t.hasNext()){var n=t.next();this.destroyInstance(n,!0)}},e.prototype.clear=function(e){var t,n;if(!e){this.queue.clear(this.clearQueueFun.bind(this));var r=this.archetypes,i=r.length,s;for(s=0;s<i;s+=1){t=r[s].context.instances,n=t.length;while(n>0)n-=1,this.destroyInstance(t[n])}}else if(e.context){t=e.context.instances,n=t.length;while(n>0)n-=1,this.destroyInstance(t[n])}},e.prototype.clearQueueFun=function(e){this.destroyInstance(e,!0)},e.prototype.initialize=function(e,t){this.scene=e,this.passIndex=t,this.initialized=!0},e.create=function(t,n,r){var i=new e;return i.graphicsDevice=t,i.textureManager=n,i.shaderManager=r,i.renderers={},i.updaters={},i.systems={},i.particles={},i.synchronizers={},i.emitters={},i.geometries={},i.archetypes=[],i.systemContext=$.create({graphicsDevice:t}),i.viewContext=$.create({graphicsDevice:t}),i.getViewCb=i.getView.bind(i),i.viewPool=[],i.queue=new I,i.registerGeometry("default",function(e,t){return Q.prototype.createGeometry(e,t,!0)}),i.registerRenderer("default",Q.parseArchetype,Q.compressArchetype,Q.load,Q.create.bind(null,t,r,"alpha"),"default"),i.registerRenderer("alpha",Q.parseArchetype,Q.compressArchetype,Q.load,Q.create.bind(null,t,r,"alpha"),"default"),i.registerRenderer("additive",Q.parseArchetype,Q.compressArchetype,Q.load,Q.create.bind(null,t,r,"additive"),"default"),i.registerRenderer("opaque",Q.parseArchetype,Q.compressArchetype,Q.load,Q.create.bind(null,t,r,"opaque"),"default"),i.registerUpdater("default",K.parseArchetype,K.compressArchetype,K.load,K.create.bind(null,t,r)),i.registerAnimationSystem("default",[{name:"color",type:"float4","default":[1,1,1,1],min:[0,0,0,0],max:[1,1,1,1],storage:"direct"},{name:"scale",type:"float2","default":[1,1]},{name:"rotation",type:"float","default":0},{name:"frame",type:"texture0","default":0}]),i.registerParticleAnimation({name:"default",animation:[{}]}),i.registerSynchronizer("default",et.parseArchetype,et.compressArchetype,et.create.bind(null,{})),i.registerEmitter("default",tt.parseArchetype,tt.compressArchetype,tt.create),i.timerCb=function(){return i.time},i},e.prototype.gatherInstanceMetrics=function(e){var t=this.timerCb(),n,r,i;if(e){if(!e.context)return[];n=[];var s=e.context.instances;r=s.length;for(i=0;i<r;i+=1){var o=s[i];n.push({instance:o,allocated:o.system,active:o.system&&o.system.lastTime===t})}return n}var u=this.archetypes;r=u.length,n=[];for(i=0;i<r;i+=1)n=n.concat(this.gatherInstanceMetrics(u[i]));return n},e.prototype.gatherMetrics=function(e){var t=this.timerCb(),n,r,i;if(e){if(!e.context)return{numPooledSystems:0,numPooledInstances:0,numActiveInstances:0,numAllocatedInstances:0,numInstances:0,activeParticleCount:0};var r=e.context,s=r.instances,o=s.length;n={numPooledSystems:r.systemPool.length,numPooledInstances:r.instancePool.length,numActiveInstances:0,numAllocatedInstances:0,numInstances:o,activeParticleCount:0};for(i=0;i<o;i+=1){var u=s[i];u.system&&(n.numAllocatedInstances+=1,u.system.lastTime===t&&(n.numActiveInstances+=1,n.activeParticleCount+=u.system.maxParticles))}return n}var a=this.archetypes,f=a.length;n={numInitializedArchetypes:f,numPooledViews:this.viewPool.length,numPooledSynchronizers:0,numPooledEmitters:0,numPooledSystems:0,numPooledInstances:0,numActiveInstances:0,numAllocatedInstances:0,numInstances:0,activeParticleCount:0};for(i=0;i<f;i+=1){var l=this.gatherMetrics(a[i]);n.numPooledSystems+=l.numPooledSystems,n.numPooledInstances+=l.numPooledInstances,n.numActiveInstances+=l.numActiveInstances,n.numAllocatedInstances+=l.numAllocatedInstances,n.numInstances+=l.numInstances,n.activeParticleCount+=l.activeParticleCount}for(var c in this.emitters){if(!this.emitters.hasOwnProperty(c))continue;var h=this.emitters[c];n.numPooledEmitters+=h.pool.length}for(var c in this.synchronizers){if(!this.synchronizers.hasOwnProperty(c))continue;var p=this.synchronizers[c];n.numPooledSynchronizers+=p.pool.length}return n},e.prototype.getGeometry=function(e,t){t=t||"default";if(!this.geometries.hasOwnProperty(t))return null;var n=this.geometries[t];return typeof n=="function"?n=this.geometries[t]=n(this.graphicsDevice,e):n.resize(e),n},e.prototype.registerGeometry=function(e,t){this.geometries[e]=t},e.prototype.getRenderer=function(e){e=e||"default";if(!this.renderers.hasOwnProperty(e))return null;var t=this.renderers[e].value;return typeof t=="function"&&(t=this.renderers[e].value=t()),t},e.prototype.registerRenderer=function(e,t,n,r,i,s){this.renderers[e]={parseArchetype:t,compressArchetype:n,load:r,value:i,geometry:s}},e.prototype.getUpdater=function(e){e=e||"default";if(!this.updaters.hasOwnProperty(e))return null;var t=this.updaters[e].value;return typeof t=="function"&&(t=this.updaters[e].value=t()),t},e.prototype.registerUpdater=function(e,t,n,r,i){this.updaters[e]={parseArchetype:t,compressArchetype:n,load:r,value:i}},e.prototype.getAnimationSystem=function(e){return this.systems[e||"default"]},e.prototype.registerAnimationSystem=function(e,t){var n=new z,r=X.parseSystem(n,t);if(!n.empty(this.failOnWarnings))throw n.fail("System parse failed!");this.systems[e]=r},e.prototype.computeAnimationLifeTime=function(e){var t=this.getParticleAnimation(e).animation,n=t.length,r=0,i;for(i=0;i<n;i+=1)r+=t[i].time;return r},e.prototype.getParticleAnimation=function(e){return this.particles[e||"default"]},e.prototype.registerParticleAnimation=function(e){var t=new z,n=X.parseParticle(t,e);if(!t.empty(this.failOnWarnings))throw t.fail("Particle parse failed!");this.particles[e.name]=n},e.prototype.getEmitter=function(e){e=e||"default";var t=this.emitters[e],n;return t.pool.length>0?n=t.pool.pop():n=t.value(),n.name=e,n},e.prototype.registerEmitter=function(e,t,n,r){this.emitters[e]={parseArchetype:t,compressArchetype:n,value:r,pool:[]}},e.prototype.getSynchronizer=function(e){e=e||"default";var t=this.synchronizers[e],n;return t.pool.length>0?n=t.pool.pop():n=t.value(),n.name=e,n},e.prototype.registerSynchronizer=function(e,t,n,r){this.synchronizers[e]={parseArchetype:t,compressArchetype:n,value:r,pool:[]}},e.prototype.loadArchetype=function(e,t){var n,r,i;if(t){var s=1,o=this,i=function(){s-=1,s===0&&t(e)};n=function(e){s+=1,o.textureManager.load(e,undefined,i)},r=function(e){s+=1,o.shaderManager.load(e,i)}}else n=this.textureManager.load.bind(this.textureManager),r=this.shaderManager.load.bind(this.shaderManager);this.renderers[e.renderer.name].load(e.renderer,r,n),this.updaters[e.updater.name].load(e.updater,r,n);var u=e.packedTextures,a=u.length,f;for(f=0;f<a;f+=1)n(u[f]);var l=e.particles;for(var c in e.particles){if(!e.particles.hasOwnProperty(c))continue;var h=l[c],p=h.textures;a=p.length;for(f=0;f<a;f+=1)n(p[f])}i&&i()},e.prototype.initializeArchetype=function(e){if(!this.initialized)throw"ParticleManager not initialized";var t=e.context;if(t)return;t={},this.archetypes.push(e);var n=this.textureManager,r=this.getAnimationSystem(e.animationSystem),i={},s={},o={},u=[],a=[],f,l,c;l=e.packedTextures.length;for(c=0;c<l;c+=1)e.packedTextures[c]&&(s["texture"+c]=[],i["texture"+c]=this.textureManager.get(e.packedTextures[c]));var h;for(var p in e.particles){if(!e.particles.hasOwnProperty(p))continue;f=e.particles[p],a.push(this.getParticleAnimation(f.animation)),u.push(f.tweaks);var d=f.textureUVs,v=f.textures;l=Math.max(v.length,d.length);for(c=0;c<l;c+=1){var m=s["texture"+c],g=o["texture"+c];if(m)m.push(d[c]);else if(g||X.hasTextureIndex(r,c))g||(g=o["texture"+c]=[]),g.push(this.textureManager.get(v[c]))}}var y=[];for(var p in o){if(!o.hasOwnProperty(p))continue;var b=parseInt(p.substr(7)),w=V.packTextures({graphicsDevice:this.graphicsDevice,textures:o[p]});i[p]=w.texture,s[p]=w.uvMap,y.push(p)}t.packed=y,t.textures=i,t.getTextureCb=function(e){if(!i.hasOwnProperty(e))return null;var t=i[e];return typeof t=="function"&&(t=i[e]=t()),t},t.definition=V.compile({graphicsDevice:this.graphicsDevice,system:r,particles:a,alreadyParsed:!0,uvMap:s,tweaks:u}),t.particleDefns={},h=0;for(var p in e.particles){if(!e.particles.hasOwnProperty(p))continue;f=e.particles[p],t.particleDefns[p]=t.definition.particle[h],h+=1}var E=e.renderer.name;t.renderer=this.getRenderer(E),t.updater=this.getUpdater(e.updater.name),t.instances=[],t.instancePool=[],t.systemPool=[],e.context=t},e.prototype.createInstance=function(e,t){this.initializeArchetype(e);var n=e.context,r=n.instancePool,i;r.length>0?i=r.pop():i=this.createNewInstance(e),this.buildSynchronizer(e,i),i.queued=t!==undefined,i.creationTime=this.timerCb(),i.queued&&this.queue.insert(i,t),n.instances.push(i);var s=i.synchronizer.emitters,o=s.length,u;for(u=0;u<o;u+=1){var a=s[u];i.queued?a.timeout(t):a.enable()}return i},e.prototype.destroyInstance=function(t,n){typeof n=="undefined"&&(n=!1);var r=t.archetype,i=r.context;this.removeInstanceFromScene(t),this.releaseSynchronizer(t);var s=t.renderable;s.releaseViews(this.viewPool.push.bind(this.viewPool)),s.system&&(i.systemPool.push(s.system),s.setSystem(null)),s.setLocalTransform(e.m43Identity),t.system=null;var o=i.instances;o.splice(o.indexOf(t),1),i.instancePool.push(t),t.queued&&!n&&this.queue.remove(t)},e.prototype.addInstanceToScene=function(e,t){var n=e.sceneNode;n.isInScene()&&this.removeInstanceFromScene(e),t?t.addChild(n):this.scene.addRootNode(n)},e.prototype.removeInstanceFromScene=function(e){var t=e.sceneNode;if(t.isInScene())if(t.getRoot()===t)this.scene.removeRootNode(t);else{var n=t.getParent();n&&n.removeChild(t)}},e.prototype.getSystem=function(e,t){var n=e.context,r=n.systemPool,i;if(r.length>0)i=r.pop(),i.beginUpdate(0),i.reset(),i.endUpdate(),i.synchronizer=t.synchronizer;else{var s=e.system,o=s.maxParticles||n.maxParticles;n.geometry||(n.geometry=this.getGeometry(o,this.renderers[e.renderer.name].geometry));var s=e.system;i=G.create({graphicsDevice:this.graphicsDevice,center:s.center,halfExtents:s.halfExtents,maxSpeed:s.maxSpeed||n.maxSpeed,maxParticles:o,zSorted:s.zSorted,maxSortSteps:s.maxSortSteps,geometry:n.geometry,sharedRenderContext:this.systemContext,maxLifeTime:s.maxLifeTime||n.maxLifeTime,animation:n.definition.animation,sharedAnimation:!0,timer:this.timerCb,synchronizer:t.synchronizer,trackingEnabled:s.trackingEnabled,updater:n.updater,renderer:n.renderer}),n.updater.applyArchetype(this.textureManager,i,e.updater),n.renderer.applyArchetype(this.textureManager,i,e.renderer,n.getTextureCb),n.renderer.setAnimationParameters(i,n.definition)}return t.system=i,i.reset(t.creationTime),i},e.prototype.getView=function(){var e=this.viewPool;return e.length>0?e.pop():Y.create({graphicsDevice:this.graphicsDevice,sharedRenderContext:this.viewContext})},e.prototype.createNewInstance=function(e){var t={archetype:e};return this.buildParticleSceneNode(e,t),t},e.prototype.replaceArchetype=function(e,t){var n=e.context;if(!n)return;this.initializeArchetype(t);var r=t.context,i=n.instances,s=r.instances,o=i.length;while(o>0){o-=1;var u=i.pop(),a=u.sceneNode.getParent();this.removeInstanceFromScene(u),this.releaseSynchronizer(u);var f=u.renderable;f.releaseViews(this.viewPool.push.bind(this.viewPool)),f.system&&(n.systemPool.push(f.system),f.setSystem(null)),u.system=null,u.archetype=t;var l=this.getSystem.bind(this,t,u);f.setLazySystem(l,t.system.center,t.system.halfExtents),this.buildSynchronizer(t,u),s.push(u),this.addInstanceToScene(u,a)}},e.prototype.destroy=function(){var e=this.archetypes,t=e.length;while(t>0)t-=1,this.destroyArchetype(e[t]);var n=this.geometries;for(var r in n){if(!n.hasOwnProperty(r))continue;var i=n[r];typeof i!="function"&&i.destroy()}this.geometries=null;var s=this.viewPool;t=s.length;while(t>0)t-=1,s.pop().destroy();this.viewPool=null,this.renderers=null,this.updaters=null,this.systems=null,this.particles=null,this.synchronizers=null,this.emitters=null,this.archetypes=null,this.systemContext.destroy(),this.systemContext=null,this.viewContext.destroy(),this.viewContext=null,this.queue=null},e.prototype.destroyArchetype=function(e){var t=e.context;if(!t)return;this.archetypes.splice(this.archetypes.indexOf(e),1);var n=t.instances,r=n.length;while(r>0){r-=1;var i=n.pop();this.removeInstanceFromScene(i),this.releaseSynchronizer(i);var s=i.renderable;s.releaseViews(this.viewPool.push.bind(this.viewPool)),this.queue.remove(i);if(s.system){var o=s.system;s.setSystem(null),o.destroy()}}var u=t.systemPool;r=u.length;while(r>0)r-=1,u.pop().destroy();t.definition.animation
.destroy();var a=t.packed,f=t.textures;r=a.length;while(r>0){r-=1;var l=f[a.pop()];typeof l!="function"&&l.destroy()}e.context=null},e.prototype.buildParticleSceneNode=function(e,t){var n=e.context,r=Z.create({graphicsDevice:this.graphicsDevice,passIndex:this.passIndex,sharedRenderContext:this.viewContext}),i=this.getSystem.bind(this,e,t);r.setLazySystem(i,e.system.center,e.system.halfExtents),r.setLazyView(this.getViewCb);var s=L.create({name:"ParticleManager_SceneNode_"+this.uniqueId,dynamic:!0});this.uniqueId+=1,s.addRenderable(r),t.renderable=r,t.sceneNode=s},e.prototype.releaseSynchronizer=function(e){var t=e.synchronizer;e.synchronizer=null,t.renderable=null,e.system&&(e.system.synchronizer=null);var n=t.emitters,r=n.length;while(r>0){r-=1;var i=n[r];t.removeEmitter(i),i.reset(),this.emitters[i.name].pool.push(i)}t.reset(),this.synchronizers[t.name].pool.push(t)},e.prototype.buildSynchronizer=function(e,t){var n=e.synchronizer,r=e.context,i=this.getSynchronizer(n.name);i.applyArchetype(n),i.renderable=t.renderable;var s=0,o=0,u=0,a=e.emitters,f=e.emitters,l=f.length,c;for(c=0;c<l;c+=1){n=f[c];var h=this.getEmitter(n.name);h.applyArchetype(n,r.particleDefns,r.renderer,r.updater),h.enable(),i.addEmitter(h);if(!r.maxParticles){var p=h.getMaxLifeTime();p>s&&(s=p);var d=h.getMaxSpeed();d>u&&(u=d),o+=h.getMaxParticles()}}r.maxParticles||(r.maxParticles=o,r.maxLifeTime=s,r.maxSpeed=Math.max(1,u)*10),t.synchronizer=i},e.JSONreplacer=function(e,t){if(W.isTypedArray(t)){var n=[],r,i=t.length;for(r=0;r<i;r+=1)n.push(t[r]);return n}return t},e.prototype.serializeArchetype=function(t){return JSON.stringify(this.compressArchetype(t),e.JSONreplacer)},e.prototype.deserializeArchetype=function(e){return this.parseArchetype(JSON.parse(e))},e.prototype.compressArchetype=function(e){var t=null,n=G.compressArchetype(e.system);n&&(t=t||{},t.system=n);var r=e.renderer.name,i=e.updater.name,s=e.synchronizer.name,o=this.renderers[r],u=this.updaters[i],a=this.synchronizers[s];delete e.renderer.name,delete e.updater.name,delete e.synchronizer.name;var f=o.compressArchetype(e.renderer),l=u.compressArchetype(e.updater),c=a.compressArchetype(e.synchronizer);e.renderer.name=r,e.updater.name=i,e.synchronizer.name=s;if(f||r!=="default")t=t||{},t.renderer=f||{},r!=="default"&&(t.renderer.name=r);if(l||i!=="default")t=t||{},t.updater=l||{},i!=="default"&&(t.updater.name=i);if(c||s!=="default")t=t||{},t.synchronizer=c||{},s!=="default"&&(t.synchronizer.name=s);var h=e.packedTextures,p=h.length,d;p!==0&&(t=t||{});for(d=0;d<p;d+=1)h[d]&&(t["packedTexture"+(d||"")]=h[d]);e.animationSystem!=="default"&&(t=t||{},t.animationSystem=e.animationSystem);var v=e.particles;for(var m in v){if(!v.hasOwnProperty(m))continue;t=t||{},t.particles=t.particles||{};var g=v[m],y=null;g.animation!=="default"&&(y=y||{},y.animation=g.animation);for(var b in g.tweaks)if(g.tweaks.hasOwnProperty(b)){y=y||{},y.tweaks=W.copy(g.tweaks);break}var w=g.textures;p=w.length,p!==0&&(y=y||{});for(d=0;d<p;d+=1)w[d]&&(y["texture"+(d||"")]=w[d]);var E=g.textureUVs;p=E.length;for(d=0;d<p;d+=1){var S=E[d];S&&(S[0]!==0||S[1]!==0||S[2]!==1||S[3]!==1)&&(y=y||{},y["texture-uv"+(d||"")]=W.copy(S))}t.particles[m]=y}var x=e.emitters;p=x.length,p!==0&&(t=t||{},t.emitters=[]);for(d=0;d<p;d+=1){var T=x[d],N=T.name;delete T.name;var C=this.emitters[N].compressArchetype(T);C.name=N,T.name=N,N!=="default"&&(C.name=N),t.emitters.push(C)}return t},e.prototype.parseArchetype=function(e){function f(e){return X.checkString.bind(null,a,"archetype",e)}function l(e){return function(){return e}}function c(e,t,n,r){return X.maybeField(e,t,n(t),r)}var n=e&&e.renderer&&e.renderer.name||"default",r=e&&e.updater&&e.updater.name||"default",i=e&&e.synchronizer&&e.synchronizer.name||"default",s=this.renderers[n],o=this.updaters[r],u=this.synchronizers[i];if(!s)throw"Renderer with name "+n+" has not been registered with manager";if(!o)throw"Renderer with name "+r+" has not been registered with manager";if(!u)throw"Renderer with name "+i+" has not been registered with manager";e&&e.renderer&&delete e.renderer.name,e&&e.updater&&delete e.updater.name,e&&e.synchronizer&&delete e.synchronizer.name;var a=new z,h=e?c(e,"animationSystem",f,l("default")):"default",p=this.getAnimationSystem(h);p||a.error("Archetype references animation system '"+h+"' not registered with manager");var d=[];if(e)for(var v in e){if(!e.hasOwnProperty(v)||v.substr(0,13)!=="packedTexture")continue;var m=parseFloat(v.substr(13)||"0");(m|0)!==m||m<0?a.error("Archetype packedTexture index must be an integer >= 0 for "+v):p&&!X.hasTextureIndex(p,m)?a.warning("Archetype specifies "+v+", but system animation "+"specifies no attribute requiring "+v+". Field will be ignored"):d[m]=f(v)(e[v])}var g=this,y={};y.system=G.parseArchetype(a,e&&e.system),y.renderer=s.parseArchetype(a,e&&e.renderer),y.updater=o.parseArchetype(a,e&&e.updater),y.synchronizer=u.parseArchetype(a,e&&e.synchronizer),y.animationSystem=h,y.packedTextures=d,y.particles=e?X.maybeField(e,"particles",function(e){var t={};for(var n in e){if(!e.hasOwnProperty(n))continue;var r=e[n];if(W.isNullUndefined(r)){t[n]={animation:"default",tweaks:{},textureUVs:[],textures:[]};continue}var i=r.animation;!W.isNullUndefined(i)&&!W.isString(i)&&!W.isObject(i)&&a.error("Archetype particle animation should be a string name referencing a registered particle animation for particle '"+n+"'");var s=r.tweaks||{},o=g.getParticleAnimation(i);o?p&&V.checkAttributes(a,o,p):a.error("Archetype particle animation '"+i+"' has not been registered "+"with the manager");var u=[],f=[],l=[];for(var c in r){if(!r.hasOwnProperty(c))continue;var h;if(c.substr(0,10)==="texture-uv")u.push(c),h=parseFloat(c.substr(10)||"0"),((h|0)!==h||h<0)&&a.error("Archetype particle texture-uv index must be an integer >= 0 for particle '"+n+"' "+c),d[h]?l[h]=X.checkVector(a,"Archetype particle",c,4,r[c]):a.warning("Archetype particle specifies "+c+", but archetype has not "+"specified a pre-packed texture for index. Field will be ignored");else if(c.substr(0,7)==="texture"){u.push(c),h=parseFloat(c.substr(7)||"0"),((h|0)!==h||h<0)&&a.error("Archetype particle texture index must be an integer >= 0 for particle '"+n+"' "+c);if(d[h])a.warning("Archetype particle specifies "+c+", but archetype already"+"specified a pre-packed texture for index. Field will be ignored");else if(p&&!X.hasTextureIndex(p,h))a.warning("Archetype particle specifies "+c+", but system animation "+"specifies no attribute requiring "+c+". Field will be ignored");else{var v=r[c];W.isString(v)?f[h]=v:a.error("Archetype particle texture should be a string path for particle '"+n+"' "+c)}}}X.extraFields(a,"Archetype particle '"+n+"'",r,["animation","tweaks"].concat(u)),t[n]={animation:r.animation||"default",tweaks:s,textures:f,textureUVs:l}}return t},l({})):{},y.emitters=e?X.maybeField(e,"emitters",function(e){function t(e){return X.checkString.bind(null,a,"archetype emitter",e)}var n=[],r=e.length,i;for(i=0;i<r;i+=1){var s=e[i];if(!s||!W.isObject(s)){a.error("Archetype emitter must be an object");continue}var o=c(s,"name",t,l("default")),u=g.emitters[o];if(!u)throw"Emitter with name "+o+" has not been registered with manager";delete s.name;var f=u.parseArchetype(a,s,y.particles);f&&(f.name=o,n.push(f)),s.name=o}return n},l([])):[],y.context=null;var b=y.particles,w=d.length,E;for(E=0;E<w;E+=1)if(p&&X.hasTextureIndex(p,E))for(var S in b){if(!b.hasOwnProperty(S))continue;var x=b[S];d[E]?x.textureUVs[E]||(x.textureUVs[E]=t.v4Build(0,0,1,1)):x.textures[E]||(x.textures[E]=[null])}if(!a.empty(this.failOnWarnings))throw a.fail("Archetype parse failed!");y.renderer.name=n,y.updater.name=r,y.synchronizer.name=i,e&&e.renderer&&(e.renderer.name=n),e&&e.updater&&(e.updater.name=r),e&&e.synchronizer&&(e.synchronizer.name=i);if(!a.empty(this.failOnWarnings))throw a.fail("Archetype parse failed!");return y},e.recordDelta=function(e,t){var n=!0,r,i,s;if(W.isNullUndefined(e))s=W.copy(t),n=!1;else if(W.isArray(e)){s=[],r=e.length;for(i=0;i<r;i+=1)s.push(this.recordDelta(e[i],t[i])),W.isNullUndefined(s[i])||(n=!1)}else if(W.isObject(e)){n=!0,s={};var o;for(o in e)if(e.hasOwnProperty(o)){var u=this.recordDelta(e[o],t[o]);W.isNullUndefined(u)||(s[o]=u,n=!1)}for(o in t)t.hasOwnProperty(o)&&!e.hasOwnProperty(o)&&(s[o]=t[o],n=!1)}else if(W.isFunction(e)){e=e(),s=[],r=t.length;for(i=0;i<r;i+=1)s.push(this.recordDelta(e,t[i])),W.isNullUndefined(s[i])||(n=!1)}else s=t,n=e===t;return n?null:s},e.m43Identity=t.m43BuildIdentity(),e}(),rt=function(){function e(e,t){this.gd=e,this.fm=t,this.bold=!1,this.italic=!1,this.pageWidth=0,this.pageHeight=0,this.baseline=0,this.glyphs=null,this.numGlyphs=0,this.minGlyphIndex=0,this.unknownGlyphIndex="?".charCodeAt(0),this.lineHeight=0,this.pages=null,this.kernings=null,this.textures=[]}return e.prototype.calculateTextDimensions=function(e,t,n,r,i){var s=this.glyphs,o=(this.lineHeight+(r||0))*t,u=s[this.unknownGlyphIndex],a=this.pages?this.pages.length:1,f=0,l=this.lineHeight*t,c=0,h=0,p=[],d=[],v=e.length,m=0,g,y,b,w,E;for(E=0;E<a;E+=1)d[E]=0;for(E=0;E<v;E+=1)g=e.charCodeAt(E),g===10?(m&&(m-=n),p[h]=m,h+=1,f<m&&(f=m),m=0,l+=o):(y=s[g]||u,y&&(b=y.awidth,b?(m+=b*t+n,c+=1):m+=n,w=y.page,d[w]+=1));return p[h]=m,f<m&&(f=m),i?(i.width=f,i.height=l,i.numGlyphs=c,i.linesWidth=p,i.glyphCounts=d,i):{width:f,height:l,numGlyphs:c,linesWidth:p,glyphCounts:d}},e.prototype.generatePageTextVertices=function(e,t,n,r){var i=t.scale||1,s=t.spacing?t.spacing*i:0,o=t.dimensions;o||(o=this.calculateTextDimensions(e,i,s));var u=o.glyphCounts,a=r||{vertices:null,vertexIndex:0},f=u[n];if(0===f)return a;var l=t.rect,c=t.alignment,h=o.linesWidth,p=(this.lineHeight+(t.lineSpacing||0))*i,d=this.kernings,v=this.glyphs,m=this.fm,g=m.reusableArrays,y=0,b=g[f];b?g[f]=null:b=new m.float32ArrayConstructor(f*4*4);var w=h[0],E=l[0],S=l[2],x=l[1],T=E;1===c?T+=(S-w)*.5:2===c&&(T+=S-w);var N=e.length,C=0,k,L,A,O,M,_,D,P,H,B,j,F,I;for(k=0;k<N;k+=1){A=e.charCodeAt(k);if(A===10)x+=p,C+=1,w=h[C],T=E,1===c?T+=(S-w)*.5:2===c&&(T+=S-w);else{I=v[A]||v[this.unknownGlyphIndex];if(I){P=I.awidth*i;if(P){L=I.page||0;if(L===n){O=T+I.xoffset*i,M=x+I.yoffset*i,_=O+I.width*i,D=M+I.height*i,H=I.left,B=I.top,j=I.right,F=I.bottom,b[y+0]=O,b[y+1]=M,b[y+2]=H,b[y+3]=B,b[y+4]=_,b[y+5]=M,b[y+6]=j,b[y+7]=B,b[y+8]=O,b[y+9]=D,b[y+10]=H,b[y+11]=F,b[y+12]=_,b[y+13]=D,b[y+14]=j,b[y+15]=F,y+=16,f-=1;if(0===f)break}T+=P+s;if(d){var q=d[A];if(q&&k<N-1){var R=q[e.charCodeAt(k+1)];R&&(T+=R*i)}}}else T+=s}}}return a.vertices=b,a.vertexIndex=0,a},e.prototype.drawTextRect=function(e,t){var n=t.dimensions;if(!n){var r=t.scale||1,i=t.spacing?t.spacing*r:0;n=this.calculateTextDimensions(e,r,i);var s=t;t={dimensions:n},t.__proto__=s}var o=n.numGlyphs;if(0>=o)return;var u=n.glyphCounts,a=u.length,f,l,c=this.fm.scratchPageContext;for(f=0;f<a;f+=1){l=u[f];if(l){c=this.generatePageTextVertices(e,t,f,c),this.drawTextVertices(c,f,!0),o-=l;if(0===o)break}}},e.prototype.drawTextVertices=function(e,t,n){var r=e.vertices;if(!r)return;var i=this.gd,s=this.fm,o=s.sharedVertexBuffer,u=s.sharedIndexBuffer,a=s.techniqueParameters,f,l,c=r.length>>4;f=c*4;if(!o||f>o.numVertices)o&&o.destroy(),o=this.createVertexBuffer(c),s.sharedVertexBuffer=o;o.setData(r,0,f),i.setStream(o,s.semantics),a.texture=this.textures[t],i.setTechniqueParameters(a);if(4<f){l=c*6;if(!u||l>u.numIndices)u&&u.destroy(),u=this.createIndexBuffer(c),s.sharedIndexBuffer=u;i.setIndexBuffer(u),i.drawIndexed(s.primitive,l,0)}else i.draw(s.primitiveTristrip,4,0);n&&(s.reusableArrays[c]=r)},e.prototype.createIndexBuffer=function(e){var t=this.gd,n={numIndices:6*e,format:"USHORT"},r=t.createIndexBuffer(n),i=r.map();if(i){var s,o,u,a;for(var f=0;f<e;f+=1)s=4*f,o=s+1,u=s+2,a=s+3,i(s,o,u),i(u,o,a);r.unmap(i)}return r},e.prototype.createVertexBuffer=function(e){var t=this.gd;return t.createVertexBuffer({numVertices:4*e,attributes:[t.VERTEXFORMAT_FLOAT2,t.VERTEXFORMAT_FLOAT2],dynamic:!0,"transient":!0})},e.version=1,e}(),it=function(){function e(e){this.primitive=e.PRIMITIVE_TRIANGLES,this.primitiveTristrip=e.PRIMITIVE_TRIANGLE_STRIP,this.semantics=e.createSemantics(["POSITION","TEXCOORD0"]),this.techniqueParameters=e.createTechniqueParameters({texture:null}),this.sharedIndexBuffer=null,this.sharedVertexBuffer=null,this.reusableArrays={},this.scratchPageContext={vertices:null,vertexIndex:0},this.float32ArrayConstructor=Array;if(typeof Float32Array!="undefined"){var t=new Float32Array(4),n=Object.prototype.toString.call(t);n==="[object Float32Array]"&&(this.float32ArrayConstructor=Float32Array)}}return e.prototype.get=function(e){return undefined},e.create=function(t,n,i,s,o){s||(s=function(){});var u={},a={},f={},l={},c=0,h={},p=null,d="",v=i,m=function(t,n,r){var i=Math.floor,s=r/16,o=1/16,u=1/s,a=.5/n.width,f=.5/n.height,l=i(n.width*o),c=i(n.height*u),h=[];h.length=r;for(var p=0;p<r;p+=1){var d=i(p%16)*o-a,v=i(p/16)*u-f;h[p]={width:l,height:c,awidth:l,xoffset:0,yoffset:0,left:d,top:v,right:d+o,bottom:v+u,page:0}}t.lineHeight=c,t.baseline=c,t.glyphs=h,t.numGlyphs=r,t.minGlyphIndex=0},g=function(t){function r(e,t,n){e[t+0]=255,e[t+1]=n&128?255:0,e[t+2]=255,e[t+3]=n&64?255:0,e[t+4]=255,e[t+5]=n&32?255:0,e[t+6]=255,e[t+7]=n&16?255:0,e[t+8]=255,e[t+9]=n&8?255:0,e[t+10]=255,e[t+11]=n&4?255:0,e[t+12]=255,e[t+13]=n&2?255:0,e[t+14]=255,e[t+15]=n&1?255:0}var n=[0,0,0,0,0,0,0,0,126,129,165,129,189,153,129,126,126,255,219,255,195,231,255,126,108,254,254,254,124,56,16,0,16,56,124,254,124,56,16,0,56,124,56,254,254,124,56,124,16,16,56,124,254,124,56,124,0,0,24,60,60,24,0,0,255,255,231,195,195,231,255,255,0,60,102,66,66,102,60,0,255,195,153,189,189,153,195,255,15,7,15,125,204,204,204,120,60,102,102,102,60,24,126,24,63,51,63,48,48,112,240,224,127,99,127,99,99,103,230,192,153,90,60,231,231,60,90,153,128,224,248,254,248,224,128,0,2,14,62,254,62,14,2,0,24,60,126,24,24,126,60,24,102,102,102,102,102,0,102,0,127,219,219,123,27,27,27,0,62,99,56,108,108,56,204,120,0,0,0,0,126,126,126,0,24,60,126,24,126,60,24,255,24,60,126,24,24,24,24,0,24,24,24,24,126,60,24,0,0,24,12,254,12,24,0,0,0,48,96,254,96,48,0,0,0,0,192,192,192,254,0,0,0,36,102,255,102,36,0,0,0,24,60,126,255,255,0,0,0,255,255,126,60,24,0,0,0,0,0,0,0,0,0,0,48,120,120,120,48,0,48,0,108,108,108,0,0,0,0,0,108,108,254,108,254,108,108,0,48,124,192,120,12,248,48,0,0,198,204,24,48,102,198,0,56,108,56,118,220,204,118,0,96,96,192,0,0,0,0,0,24,48,96,96,96,48,24,0,96,48,24,24,24,48,96,0,0,102,60,255,60,102,0,0,0,48,48,252,48,48,0,0,0,0,0,0,0,48,48,96,0,0,0,252,0,0,0,0,0,0,0,0,0,48,48,0,6,12,24,48,96,192,128,0,124,198,206,222,246,230,124,0,48,112,48,48,48,48,252,0,120,204,12,56,96,204,252,0,120,204,12,56,12,204,120,0,28,60,108,204,254,12,30,0,252,192,248,12,12,204,120,0,56,96,192,248,204,204,120,0,252,204,12,24,48,48,48,0,120,204,204,120,204,204,120,0,120,204,204,124,12,24,112,0,0,48,48,0,0,48,48,0,0,48,48,0,0,48,48,96,24,48,96,192,96,48,24,0,0,0,252,0,0,252,0,0,96,48,24,12,24,48,96,0,120,204,12,24,48,0,48,0,124,198,222,222,222,192,120,0,48,120,204,204,252,204,204,0,252,102,102,124,102,102,252,0,60,102,192,192,192,102,60,0,248,108,102,102,102,108,248,0,126,96,96,120,96,96,126,0,126,96,96,120,96,96,96,0,60,102,192,192,206,102,62,0,204,204,204,252,204,204,204,0,120,48,48,48,48,48,120,0,30,12,12,12,204,204,120,0,230,102,108,120,108,102,230,0,96,96,96,96,96,96,126,0,198,238,254,254,214,198,198,0,198,230,246,222,206,198,198,0,56,108,198,198,198,108,56,0,252,102,102,124,96,96,240,0,120,204,204,204,220,120,28,0,252,102,102,124,108,102,230,0,120,204,224,112,28,204,120,0,252,48,48,48,48,48,48,0,204,204,204,204,204,204,252,0,204,204,204,204,204,120,48,0,198,198,198,214,254,238,198,0,198,198,108,56,56,108,198,0,204,204,204,120,48,48,120,0,254,6,12,24,48,96,254,0,120,96,96,96,96,96,120,0,192,96,48,24,12,6,2,0,120,24,24,24,24,24,120,0,16,56,108,198,0,0,0,0,0,0,0,0,0,0,255,0,48,48,24,0,0,0,0,0,0,0,120,12,124,204,118,0,224,96,96,124,102,102,220,0,0,0,120,204,192,204,120,0,28,12,12,124,204,204,118,0,0,0,120,204,252,192,120,0,56,108,96,240,96,96,240,0,0,0,118,204,204,124,12,248,224,96,108,118,102,102,230,0,48,0,112,48,48,48,120,0,12,0,12,12,12,204,204,120,224,96,102,108,120,108,230,0,112,48,48,48,48,48,120,0,0,0,204,254,254,214,198,0,0,0,248,204,204,204,204,0,0,0,120,204,204,204,120,0,0,0,220,102,102,124,96,240,0,0,118,204,204,124,12,30,0,0,220,118,102,96,240,0,0,0,124,192,120,12,248,0,16,48,124,48,48,52,24,0,0,0,204,204,204,204,118,0,0,0,204,204,204,120,48,0,0,0,198,214,254,254,108,0,0,0,198,108,56,108,198,0,0,0,204,204,204,124,12,248,0,0,252,152,48,100,252,0,28,48,48,224,48,48,28,0,24,24,24,0,24,24,24,0,224,48,48,28,48,48,224,0,118,220,0,0,0,0,0,0,0,16,56,108,198,198,254,0],i=new Array(32768),s,o,u,a,f,l,c;u=0,l=0,c=256;for(o=0;o<16;o+=1){a=u;for(s=0;s<16;s+=1){for(f=0;f<8;f+=1)r(i,a+f*c,n[l]),l+=1;a+=16}u+=2048}return t.createTexture({name:"defaultFont",width:128,height:64,depth:1,format:"L8A8",cubemap:!1,mipmaps:!0,dynamic:!1,data:i})},y=new e(t);if(!v){v=new rt(t,y);var b=g(t);b&&(m(v,b,128),v.textures=[b],v.pageWidth=128,v.pageHeight=64)}u["default"]=v;var w=function(t,n){t.textures=[n],t.pageWidth=n.width,t.pageHeight=n.height;var r=t.glyphs;r||m(t,n,256)},E=function(i,o){function h(){return l[i]-=1,l[i]===0?(delete l[i],delete a[i],c-=1,!0):!1}function m(e,n){var r=u[i];if(!r){h();return}t.createTexture({src:e,mipmaps:!0,onload:n})||(s("Failed to create texture for font '"+i+"'."),delete u[i],h())}var g=u[i];if(!g){if(i in a)o&&f[i].subscribe(o);else{a[i]=!0,l[i]=0,c+=1;var b=r.create();f[i]=b,o&&b.subscribe(o);var E=function(r,o){if(o!==200||!r){s("Failed to load font file: '"+i+"'."),b.notify(null),delete l[i],delete a[i],c-=1,o===404&&(u[i]=v);return}g=new rt(t,y);var E=JSON.parse(r),S=E.bitmapfontlayouts;for(var x in S)if(S.hasOwnProperty(x)){var T=S[x];g.bold=T.bold||!1,g.italic=T.italic||!1,g.pageWidth=T.pagewidth||0,g.pageHeight=T.pageheight||0,g.baseline=T.baseline||0,g.glyphs=T.glyphs||null,g.numGlyphs=T.numglyphs||0,g.minGlyphIndex=T.minglyphindex||0,g.lineHeight=T.lineheight||0,g.pages=T.pages||null,g.kernings=T.kernings||null;break}u[i]=g;var N,C=g.pages;if(C){var k=C.length;l[i]+=k;var L=function(t,n,r){var o=u[i],a=r.pageIdx;if(o){if(t){o.textures[a]=t,h()&&(b.notify(o),delete f[i]);return}s("Failed to load font page: '"+C[a]+"'."),delete u[i]}h()};for(var A=0;A<k;A+=1)N=C[A],n.request({src:p&&p[N]||d+N,onload:L,requestFn:m,pageIdx:A})}else N=i+".dds",n.request({src:p&&p[N]||d+N,onload:function(e){e?(w(g,e),b.notify(g),delete f[i]):(s("Failed to load font page: '"+N+"'."),delete u[i]),delete l[i],delete a[i],c-=1},requestFn:function(e,n){t.createTexture({src:e,mipmaps:!0,onload:n})||(r?s("Failed to create texture for font '"+i+"'."):s("Failed to load font '"+i+"'."),delete u[i],delete l[i],delete a[i],c-=1)}})},S=i,x,T=S.lastIndexOf(".");T!==-1&&(x=S.substr(T));if(!x||x!==".fnt"&&x!==".fontdat")S+=".fontdat";n.request({src:p&&p[S]||d+S,onload:E})}g=v}else o&&TurbulenzEngine.setTimeout(function(){o(g)},0);return g},S=function(t,n){u[t]=u[n],h[t]=!0},x=function(t){t in u&&delete u[t]};return o?(y.load=function(t,n){return o.innerHTML+="FontManager.load:&nbsp;'"+t+"'",E(t,n)},y.map=function(t,n){o.innerHTML+="FontManager.map:&nbsp;'"+n+"' -> '"+t+"'",S(t,n)},y.remove=function(t){o.innerHTML+="FontManager.remove:&nbsp;'"+t+"'",x(t)}):(y.load=E,y.map=S,y.remove=x),y.get=function(t){var n=u[t];return n?n:v},y.getAll=function(){return u},y.getNumPendingFonts=function(){return c},y.isFontLoaded=function(t){return!a[t]},y.isFontMissing=function(t){return!u[t]},y.setPathRemapping=function(t,n){p=t,d=n},y.calculateTextDimensions=function(t,n,r,i){var s=u[t];return s?s.calculateTextDimensions(n,r,i):{width:0,height:0,numGlyphs:0,linesWidth:[],glyphCounts:[]}},y.reuseVertices=function(t){this.reusableArrays[t.length>>4]=t},y.destroy=function(){if(u){var r;for(r in u)if(u.hasOwnProperty(r)){var i=u[r];if(i){var s=i.texture;s&&(s.destroy(),i.texture=null)}}u=null}this.sharedVertexBuffer&&(this.sharedVertexBuffer.destroy(),this.sharedVertexBuffer=null),this.sharedIndexBuffer&&(this.sharedIndexBuffer.destroy(),this.sharedIndexBuffer=null),this.techniqueParameters=null,this.semantics=null,a=null,l=null,f=null,l=null,c=0,h=null,p=null,d=null,n=null,t=null},y},e.version=1,e}(),st={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},ot=function(t,n){var r=parseInt,i;t=t.replace(/ /g,"").toLowerCase(),t=st[t]||t;if(t[0]==="#"){t=t.substr(1,6);var s=t.length;if(s===6){i=/^(\w{2})(\w{2})(\w{2})$/.exec(t);if(i)return n[0]=r(i[1],16)/255,n[1]=r(i[2],16)/255,n[2]=r(i[3],16)/255,n[3]=1,n}else if(s===3){i=/^(\w{1})(\w{1})(\w{1})$/.exec(t);if(i)return n[0]=r(i[1],16)/15,n[1]=r(i[2],16)/15,n[2]=r(i[3],16)/15,n[3]=1,n}}else{var o=t.substr(0,4);if(o==="rgba"){i=/^rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(\d*\.?\d+)\)$/.exec(t);if(i)return n[0]=r(i[1],10)/255,n[1]=r(i[2],10)/255,n[2]=r(i[3],10)/255,n[3]=parseFloat(i[4]),n}else if(o==="rgb("){i=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/.exec(t);if(i)return n[0]=r(i[1],10)/255,n[1]=r(i[2],10)/255,n[2]=r(i[3],10)/255,n[3]=1,n}else{o==="hsla"?(i=/^hsla\((\d{1,3}),\s*(\d{1,3})\%,\s*(\d{1,3})\%,\s*(\d*\.?\d+)\)$/.exec(t),i&&(n[3]=parseFloat(i[4]))):o==="hsl("&&(i=/^hsl\((\d{1,3}),\s*(\d{1,3})\%,\s*(\d{1,3})\%\)$/.exec(t),i&&(n[3]=1));if(i){var u=r(i[1],10)/360,a=r(i[2],10)/100,f=r(i[3],10)/100;if(a===0)n[0]=f,n[1]=f,n[2]=f;else{var l,c;f<.5?c=f*(a+1):c=f+a-f*a,l=f*2-c;var h=function(t,n,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?t+(n-t)*r*6:2*r<1?n:3*r<2?t+(n-t)*(2/3-r)*6:t};n[0]=h(l,c,u+1/3),n[1]=h(l,c,u),n[2]=h(l,c,u-1/3)}return n}}}return undefined},ut=function(){function e(){}return e.prototype.addColorStop=function(e,t){function n(e,t){return e[0]-t[0]}if(e<0||e>1)throw"INDEX_SIZE_ERR";var r=this.stops,i=r.length,s=ot(t,new Array(4));s[3]<1&&(this.opaque=!1),s[0]=s[0]*255,s[1]=s[1]*255,s[2]=s[2]*255,s[3]=s[3]*255,r[i]=[e,s],i+=1,i>1&&r.sort(n)},e.prototype.updateTexture=function(e){var t=this.texture,n=this.stops,r=n.length;if(this.numTextureStops!==r){this.numTextureStops=r;var i=this.width,s=this.height;t||(this.texture=t=e.createTexture({name:"linear:"+i+"x"+s,width:i,height:s,depth:1,format:e.PIXELFORMAT_R8G8B8A8,cubemap:!1,mipmaps:!1}));var o=this.opaque,u=this.x1-this.x0,a=this.y1-this.y0,f=u*u+a*a;f===0?f=1:f=1/Math.sqrt(f),u*=f,a*=f;var l=u/(i>1?i-1:1),c=a/(s>1?s-1:1),h=i*s*4,p=new Array(h),d=0,v=0;for(var m=0;m<s;m+=1,v+=c){var g=v*a,y=0;for(var b=0;b<i;b+=1,d+=4,y+=l){var w=y*u+g,E=n[0],S=E[0],x=E[1],T=S,N=x;if(w>S)for(var C=1;C<r;C+=1){E=n[C],S=E[0],x=E[1];if(w<=S)break;T=S,N=x}var k=S-T;if(k<=0||w===S)p[d]=x[0],p[d+1]=x[1],p[d+2]=x[2],o?p[d+3]=255:p[d+3]=x[3];else{var L=(w-T)/k;if(L<.996){var A=1-L;p[d]=x[0]*L+N[0]*A,p[d+1]=x[1]*L+N[1]*A,p[d+2]=x[2]*L+N[2]*A,o?p[d+3]=255:p[d+3]=x[3]*L+N[3]*A}else p[d]=x[0],p[d+1]=x[1],p[d+2]=x[2],o?p[d+3]=255:p[d+3]=x[3]}}}t.setData(p)}return t},e.create=function(t,n,r,i){var s=r-t,o=i-n,u=Math.abs(s),a=Math.abs(o);if(u===0&&a===0)return null;while(u<16&&a<16)u*=16,a*=16;u<1?u=1:u=Math.floor(u),a<1?a=1:a=Math.floor(a);var f=new e;f.x0=t,f.y0=n,f.x1=r,f.y1=i,f.width=u,f.height=a,f.stops=[];var l=1/s,c=1/o;return f.matrix=[l,0,-t*l,0,c,-n*c],f.numTextureStops=0,f.texture=null,f.opaque=!0,f},e.version=1,e}(),at=function(){function e(){}return e.prototype.addColorStop=function(e,t){function n(e,t){return e[0]-t[0]}if(e<0||e>1)throw"INDEX_SIZE_ERR";var r=this.stops,i=r.length,s=ot(t,new Array(4));s[3]<1&&(this.opaque=!1),s[0]=s[0]*255,s[1]=s[1]*255,s[2]=s[2]*255,s[3]=s[3]*255,r[i]=[e,s],i+=1,i>1&&r.sort(n)},e.prototype.updateTexture=function(e){var t=this.texture,n=this.stops,r=n.length;if(this.numTextureStops!==r){this.numTextureStops=r;var i=this.width;i<r&&(this.width=i=r);var s=this.height;s<r&&(this.height=s=r);if(!t||t.width!==i||t.height!==s)this.texture=t=e.createTexture({name:"radial:"+i+"x"+s,width:i,height:s,depth:1,format:e.PIXELFORMAT_R8G8B8A8,cubemap:!1,mipmaps:!1});var o=this.x0-this.minX,u=this.x1-this.minX,a=u-o,f=this.y0-this.minY,l=this.y1-this.minY,c=l-f,h=this.r0,p=this.r1,d=p-h,v=i*s*4,m=new Array(v),g=Math.cos,y=Math.sin,b=Math.abs,w=Math.PI*2,E=Math.max(b(a|0),b(c|0),b(d|0)),S=1/E,x,T,N,C;for(var k=0;k<=1;k+=S){var L=n[0],A=L[0],O=L[1],M=A,_=O;if(k>A)for(var D=1;D<r;D+=1){L=n[D],A=L[0],O=L[1];if(k<=A)break;M=A,_=O}var P=A-M;if(P<=0||k===A)x=O[0],T=O[1],N=O[2],C=O[3];else{var H=(k-M)/P,B=1-H;x=O[0]*H+_[0]*B,T=O[1]*H+_[1]*B,N=O[2]*H+_[2]*B,C=O[3]*H+_[3]*B}var j=o+k*a,F=f+k*c,I=h+k*d,q,R,U,z,W;for(var X=1;X<I;X+=1){R=1/X;for(q=0;q<w;q+=R)U=j+X*g(q)|0,z=F+X*y(q)|0,W=U+z*i<<2,m[W+3]===undefined&&(m[W]=x,m[W+1]=T,m[W+2]=N,m[W+3]=C)}R=1/I;for(q=0;q<w;q+=R)U=j+I*g(q)|0,z=F+I*y(q)|0,W=U+z*i<<2,m[W+3]===undefined&&(m[W]=x,m[W+1]=T,m[W+2]=N,m[W+3]=C)}var V=n[r-1][1],$=V[0],J=V[1],K=V[2],Q=V[3];for(var G=0;G<v;G+=4)m[G+3]===undefined&&(m[G]=$,m[G+1]=J,m[G+2]=K,m[G+3]=Q);t.setData(m)}return t},e.create=function(t,n,r,i,s,o){if(r<0||o<0)throw"INDEX_SIZE_ERR";var u=new e;u.x0=t,u.y0=n,u.r0=r,u.x1=i,u.y1=s,u.r1=o;var a=Math.min(t-r,i-o)-1,f=Math.max(t+r,i+o)+1,l=Math.min(n-r,s-o)-1,c=Math.max(n+r,s+o)+1;u.minX=a,u.minY=l,u.stops=[];var h=Math.ceil(f-a),p=Math.ceil(c-l);if(!h||!p)return null;u.width=h,u.height=p;var d=1/h,v=1/p;return u.matrix=[d,0,-a*d,0,v,-l*v],u.numTextureStops=0,u.texture=null,u.opaque=!0,u},e.version=1,e}(),ft=function(){function e(e,t,n,r){this.compositeOperations={"source-atop":1,"source-in":1,"source-out":1,"source-over":1,"destination-atop":1,"destination-in":1,"destination-out":1,"destination-over":1,lighter:1,copy:1,xor:1},this.capStyles={butt:1,round:1,square:1},this.joinStyles={bevel:1,round:1,miter:1},this.shaderDefinition={version:1,name:"canvas.cgfx",samplers:{texture:{MinFilter:9985,MagFilter:9729,WrapS:33071,WrapT:33071},pattern:{MinFilter:9728,MagFilter:9729,WrapS:10497,WrapT:10497},gradient:{MinFilter:9728,MagFilter:9729,WrapS:33071,WrapT:33071},image:{MinFilter:9728,MagFilter:9729,WrapS:33071,WrapT:33071}},parameters:{screen:{type:"float",columns:4},uvtransform:{type:"float",rows:2,columns:3},color:{type:"float",columns:4},alpha:{type:"float"},texture:{type:"sampler2D"},pattern:{type:"sampler2D"},gradient:{type:"sampler2D"},image:{type:"sampler2D"}},techniques:{flat_source_atop:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,771]},programs:["vp_flat","fp_flat"]}],flat_source_in:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,0]},programs:["vp_flat","fp_flat"]}],flat_source_out:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,0]},programs:["vp_flat","fp_flat"]}],flat_source_over:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_flat","fp_flat"]}],flat_destination_atop:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,770]},programs:["vp_flat","fp_flat"]}],flat_destination_in:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,770]},programs:["vp_flat","fp_flat"]}],flat_destination_out:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,771]},programs:["vp_flat","fp_flat"]}],flat_destination_over:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,1]},programs:["vp_flat","fp_flat"]}],flat_lighter:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,1]},programs:["vp_flat","fp_flat"]}],flat_copy:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_flat","fp_flat"]}],flat_xor:[{parameters:["screen","color"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,771]},programs:["vp_flat","fp_flat"]}],texture_source_atop:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,771]},programs:["vp_texture","fp_texture"]}],texture_source_in:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,0]},programs:["vp_texture","fp_texture"]}],texture_source_out:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,0]},programs:["vp_texture","fp_texture"]}],texture_source_over:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture","fp_texture"]}],texture_destination_atop:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,770]},programs:["vp_texture","fp_texture"]}],texture_destination_in:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,770]},programs:["vp_texture","fp_texture"]}],texture_destination_out:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,771]},programs:["vp_texture","fp_texture"]}],texture_destination_over:[{parameters:
["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,1]},programs:["vp_texture","fp_texture"]}],texture_lighter:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,1]},programs:["vp_texture","fp_texture"]}],texture_copy:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_texture","fp_texture"]}],texture_xor:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,771]},programs:["vp_texture","fp_texture"]}],pattern_source_atop:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,771]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_source_in:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,0]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_source_out:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,0]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_source_over:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_destination_atop:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,770]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_destination_in:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,770]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_destination_out:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,771]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_destination_over:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,1]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_lighter:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,1]},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_copy:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_texture_uvtransform","fp_pattern"]}],pattern_xor:[{parameters:["screen","uvtransform","alpha","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,771]},programs:["vp_texture_uvtransform","fp_pattern"]}],gradient_source_atop:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,771]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_source_in:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[772,0]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_source_out:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,0]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_source_over:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_destination_atop:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,770]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_destination_in:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,770]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_destination_out:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[0,771]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_destination_over:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,1]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_lighter:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,1]},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_copy:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_texture_uvtransform","fp_gradient"]}],gradient_xor:[{parameters:["screen","uvtransform","alpha","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[773,771]},programs:["vp_texture_uvtransform","fp_gradient"]}],texture_shadow:[{parameters:["screen","color","texture"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture","fp_texture_shadow"]}],pattern_shadow:[{parameters:["screen","uvtransform","color","pattern"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture_uvtransform","fp_pattern_shadow"]}],gradient_shadow:[{parameters:["screen","uvtransform","color","gradient"],semantics:["POSITION"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!0,BlendFunc:[1,771]},programs:["vp_texture_uvtransform","fp_gradient_shadow"]}],image:[{parameters:["image"],semantics:["POSITION","TEXCOORD0"],states:{DepthTestEnable:!1,DepthMask:!1,CullFaceEnable:!1,BlendEnable:!1},programs:["vp_image","fp_image"]}]},programs:{fp_image:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D image;void main()\n{gl_FragColor=texture2D(image,tz_TexCoord[0].xy);}"},vp_image:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nvoid main()\n{vec4 tmpvar_1;tmpvar_1.zw=vec2(0.0,1.0);tmpvar_1.x=ATTR0.x;tmpvar_1.y=ATTR0.y;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=tmpvar_1;}"},fp_gradient_shadow:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D gradient;uniform vec4 color;void main()\n{gl_FragColor=(color*texture2D(gradient,tz_TexCoord[0].xy).w);}"},vp_texture_uvtransform:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;\nuniform vec3 uvtransform[2];uniform vec4 screen;void main()\n{vec2 tmpvar_1;vec2 tmpvar_2;tmpvar_2=((ATTR0.xy*screen.xy)+screen.zw);vec4 tmpvar_3;tmpvar_3.zw=vec2(0.0,1.0);tmpvar_3.x=tmpvar_2.x;tmpvar_3.y=tmpvar_2.y;vec3 tmpvar_4;tmpvar_4.z=1.0;tmpvar_4.x=ATTR0.x;tmpvar_4.y=ATTR0.y;tmpvar_1.x=dot(tmpvar_4,uvtransform[0]);tmpvar_1.y=dot(tmpvar_4,uvtransform[1]);tz_TexCoord[0].xy=tmpvar_1;gl_Position=tmpvar_3;}"},fp_pattern_shadow:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D pattern;uniform vec4 color;void main()\n{gl_FragColor=(color*texture2D(pattern,tz_TexCoord[0].xy).w);}"},fp_texture_shadow:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D texture;uniform vec4 color;void main()\n{gl_FragColor=(color*texture2D(texture,tz_TexCoord[0].xy).w);}"},vp_texture:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];attribute vec4 ATTR0;attribute vec4 ATTR8;\nuniform vec4 screen;void main()\n{vec2 tmpvar_1;tmpvar_1=((ATTR0.xy*screen.xy)+screen.zw);vec4 tmpvar_2;tmpvar_2.zw=vec2(0.0,1.0);tmpvar_2.x=tmpvar_1.x;tmpvar_2.y=tmpvar_1.y;tz_TexCoord[0].xy=ATTR8.xy;gl_Position=tmpvar_2;}"},fp_gradient:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D gradient;uniform float alpha;void main()\n{vec4 _fg;vec4 tmpvar_1;tmpvar_1=texture2D(gradient,tz_TexCoord[0].xy);_fg=tmpvar_1;_fg.w=(tmpvar_1.w*alpha);_fg.xyz=(tmpvar_1.xyz*_fg.w);gl_FragColor=_fg;}"},fp_pattern:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D pattern;uniform float alpha;void main()\n{vec4 _fg;vec4 tmpvar_1;tmpvar_1=texture2D(pattern,tz_TexCoord[0].xy);_fg=tmpvar_1;_fg.w=(tmpvar_1.w*alpha);_fg.xyz=(tmpvar_1.xyz*_fg.w);gl_FragColor=_fg;}"},fp_texture:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nvarying vec4 tz_TexCoord[1];\nuniform sampler2D texture;uniform vec4 color;void main()\n{vec4 _fg;vec4 tmpvar_1;tmpvar_1=(texture2D(texture,tz_TexCoord[0].xy)*color);_fg=tmpvar_1;_fg.xyz=(tmpvar_1.xyz*tmpvar_1.w);gl_FragColor=_fg;}"},fp_flat:{type:"fragment",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nuniform vec4 color;void main()\n{gl_FragColor=color;}"},vp_flat:{type:"vertex",code:"#ifdef GL_ES\n#define TZ_LOWP lowp\nprecision mediump float;\nprecision mediump int;\n#else\n#define TZ_LOWP\n#endif\nattribute vec4 ATTR0;\nuniform vec4 screen;void main()\n{vec2 tmpvar_1;tmpvar_1=((ATTR0.xy*screen.xy)+screen.zw);vec4 tmpvar_2;tmpvar_2.zw=vec2(0.0,1.0);tmpvar_2.x=tmpvar_1.x;tmpvar_2.y=tmpvar_1.y;gl_Position=tmpvar_2;}"}}},this.canvas=e,this.globalAlpha=1,this.globalCompositeOperation="source-over",this.strokeStyle="#000000",this.fillStyle="#000000",this.lineWidth=1,this.lineCap="butt",this.lineJoin="miter",this.miterLimit=10,this.shadowOffsetX=0,this.shadowOffsetY=0,this.shadowBlur=0,this.shadowColor="rgba(0,0,0,0)",this.font="10px sans-serif",this.textAlign="start",this.textBaseline="alphabetic",this.imageColor="#fff",this.gd=t,this.fm=null,this.target=null,this.viewport=[0,0,n,r],this.pixelRatio=1,this.width=n,this.height=r;var i=this.floatArrayConstructor;this.screen=new i(4),this.screen[0]=2/n,this.screen[1]=-2/r,this.screen[2]=-1,this.screen[3]=1,this.subPaths=[],this.needToSimplifyPath=[],this.currentSubPath=[],this.activeVertexBuffer=null,this.activeTechnique=null,this.activeScreen=new i(4),this.activeColor=new i(4);var s=t.createShader(this.shaderDefinition);this.shader=s,this.triangleStripPrimitive=t.PRIMITIVE_TRIANGLE_STRIP,this.triangleFanPrimitive=t.PRIMITIVE_TRIANGLE_FAN,this.trianglePrimitive=t.PRIMITIVE_TRIANGLES,this.lineStripPrimitive=t.PRIMITIVE_LINE_STRIP,this.linePrimitive=t.PRIMITIVE_LINES,this.textureVertexFormats=[t.VERTEXFORMAT_FLOAT2,t.VERTEXFORMAT_FLOAT2],this.textureSemantics=t.createSemantics(["POSITION","TEXCOORD0"]),this.textureVertexBuffer=t.createVertexBuffer({numVertices:4,attributes:this.textureVertexFormats,dynamic:!0,"transient":!0}),this.flatVertexFormats=[t.VERTEXFORMAT_FLOAT2],this.flatSemantics=t.createSemantics(["POSITION"]),this.flatVertexBuffer=t.createVertexBuffer({numVertices:256,attributes:this.flatVertexFormats,dynamic:!0,"transient":!0}),this.flatOffset=0,this.bufferData=new i(512),this.subBufferDataCache={},this.tempRect=new i(8),this.tempPoint=new i(2),this.tempVertices=[],this.tempStack=[],this.v4Zero=new i(4),this.v4Zero[0]=0,this.v4Zero[1]=0,this.v4Zero[2]=0,this.v4Zero[3]=0,this.v4One=new i(4),this.v4One[0]=1,this.v4One[1]=1,this.v4One[2]=1,this.v4One[3]=1,this.cachedColors={},this.numCachedColors=0,this.uvtransform=new i(6),this.uvtransform[0]=1,this.uvtransform[1]=0,this.uvtransform[2]=0,this.uvtransform[3]=0,this.uvtransform[4]=1,this.uvtransform[5]=0,this.tempColor=new i(4),this.tempScreen=new i(4),this.tempImage=null,this.imageTechnique=s.getTechnique("image");var o=this.compositeOperations,u={},a={},f={},l={};this.flatTechniques=u,this.textureTechniques=a,this.patternTechniques=f,this.gradientTechniques=l;for(var c in o)if(o.hasOwnProperty(c)){var h=c.replace("-","_");u[c]=s.getTechnique("flat_"+h),a[c]=s.getTechnique("texture_"+h),f[c]=s.getTechnique("pattern_"+h),l[c]=s.getTechnique("gradient_"+h)}this.textureShadowTechnique=s.getTechnique("texture_shadow"),this.patternShadowTechnique=s.getTechnique("pattern_shadow"),this.gradientShadowTechnique=s.getTechnique("gradient_shadow"),this.matrix=new i(6),this.resetTransform(),this.clipExtents=new i(4),this.clipExtents[0]=0,this.clipExtents[1]=0,this.clipExtents[2]=n,this.clipExtents[3]=r,this.statesStack=[this.createStatesObject()],this.numStatesInStack=0,this.defaultStates=this.createStatesObject(),this.cachedTriangulation={},this.tempAngles=[],this.cachedPaths={},this.numCachedPaths=0}return e.prototype.save=function(){var e=this.statesStack,t=this.numStatesInStack,n=e[t];n?this.setStates(n,this):e[t]=this.createStatesObject(),this.numStatesInStack=t+1},e.prototype.restore=function(){var e=this.numStatesInStack;if(0<e){e-=1,this.numStatesInStack=e;var t=this.statesStack[e];this.setStates(this,t)}},e.prototype.scale=function(e,t){var n=this.matrix;n[0]*=e,n[1]*=t,n[3]*=e,n[4]*=t},e.prototype.rotate=function(e){if(e){var t=Math.sin(e),n=Math.cos(e);(t<-0.005||.005<t||n<.995||1.005<n)&&this.transform(n,t,-t,n,0,0)}},e.prototype.translate=function(e,t){var n=this.matrix;n[2]+=n[0]*e+n[1]*t,n[5]+=n[3]*e+n[4]*t},e.prototype.transform=function(e,t,n,r,i,s){var o=this.matrix,u=o[0],a=o[1],f=o[2],l=o[3],c=o[4],h=o[5];o[0]=u*e+a*t,o[3]=l*e+c*t,o[1]=u*n+a*r,o[4]=l*n+c*r,o[2]=u*i+a*s+f,o[5]=l*i+c*s+h},e.prototype.setTransform=function(e,t,n,r,i,s){var o=this.matrix;o[0]=e,o[1]=n,o[2]=i,o[3]=t,o[4]=r,o[5]=s},e.prototype.resetTransform=function(){var e=this.matrix;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,this.scale=this.scaleIdentity,this.translate=this.translateIdentity,this.transform=this.setTransformIdentity,this.setTransform=this.setTransformIdentity,this.transformPoint=this.transformPointIdentity,this.transformRect=this.transformRectIdentity},e.prototype.createLinearGradient=function(e,t,n,r){return ut.create(e,t,n,r)},e.prototype.createRadialGradient=function(e,t,n,r,i,s){return at.create(e,t,n,r,i,s)},e.prototype.createPattern=function(e){if(!e)throw"INVALID_STATE_ERR";return e.width===0||e.height===0?null:e},e.prototype.clearRect=function(e,t,n,r){if(n>0&&r>0){var i=this.gd,s=this.clipExtents,o=s[0],u=s[1],a=s[2],f=s[3],l=this.transformRect(e,t,n,r,this.tempRect);if(l[0]<=o&&l[1]>=f&&l[2]>=a&&l[3]>=f&&l[4]<=o&&l[5]<=u&&l[6]>=a&&l[7]<=u)i.clear(this.v4Zero);else{this.fillFlatBuffer(l,4);var c=this.flatTechniques.copy;this.setTechniqueWithColor(c,this.screen,this.v4Zero),i.draw(this.triangleStripPrimitive,4,this.flatOffset),this.flatOffset+=4}}},e.prototype.fillRect=function(e,t,n,r){if(n>0&&r>0){var i=this.transformRect(e,t,n,r,this.tempRect);this.fillFlatBuffer(i,4);var s=this.triangleStripPrimitive,o=this.fillStyle,u=this.gd;this.setShadowStyle(o)&&u.draw(s,4,this.flatOffset),this.setStyle(o),u.draw(s,4,this.flatOffset),this.flatOffset+=4}},e.prototype.strokeRect=function(e,t,n,r){if(n>0||r>0){var i=this.transformRect(e,t,n,r,this.tempRect),s=this.strokeStyle,o=this.lineWidth,u=this.pixelRatio*o<2,a,f,l;if(u)a=this.lineStripPrimitive,f=5,l=this.getFlatBuffer(5),l&&(l[0]=i[4],l[1]=i[5],l[2]=i[6],l[3]=i[7],l[4]=i[2],l[5]=i[3],l[6]=i[0],l[7]=i[1],l[8]=i[4],l[9]=i[5],this.fillFlatBuffer(l,5));else{var c=[i[0],i[1]],h=[i[2],i[3]],p=[i[4],i[5]],d=[i[6],i[7]],v=[p,d,h,c,p];a=this.triangleStripPrimitive,f=this.fillFatStrip(v,5,o)}var m=this.gd;this.setShadowStyle(s)&&m.draw(a,f,this.flatOffset),this.setStyle(s),m.draw(a,f,this.flatOffset),this.flatOffset+=f}},e.prototype.beginPath=function(){this.subPaths.length=0,this.currentSubPath.length=0,this.needToSimplifyPath[0]=!0},e.prototype.closePath=function(){var e=this.currentSubPath,t=e.length;if(t>1){var n=e[0];if(t>2){var r=e[t-1],i=Math.abs;if(i(n[0]-r[0])>=1||i(n[1]-r[1])>=1)e[t]=n;this.simplifyShape(e)}var s=this.subPaths,o=s.length;s[o]=e,this.currentSubPath=[n];var u=this.needToSimplifyPath;u[o]=!1,u[o+1]=!0}},e.prototype.moveTo=function(e,t){var n=this.currentSubPath,r=n.length;if(r>1){var i=this.subPaths,s=i.length;i[s]=n,this.currentSubPath=[this.transformPoint(e,t)];var o=this.needToSimplifyPath;o[s]=r>2,o[s+1]=!0}else n[0]=this.transformPoint(e,t)},e.prototype.lineTo=function(e,t){var n=this.currentSubPath;n[n.length]=this.transformPoint(e,t)},e.prototype.quadraticCurveTo=function(e,t,n,r){var i=this.currentSubPath,s=i.length;if(s===0)throw"Needs starting point!";var o=i[s-1],u=o[0],a=o[1],f=this.transformPoint(e,t),l=f[0],c=f[1],h=this.transformPoint(n,r),p=h[0],d=h[1],v=Math.abs,m=Math.ceil(this.pixelRatio*Math.sqrt(v(l-u)+v(c-a)+v(p-l)+v(d-c)));if(1<m){i.length+=m;var g=1/m;for(var y=g;1<m;y+=g,m-=1){var b=1-y,w=b*b,E=y*y,S=2*y*b;i[s]=[w*u+S*l+E*p,w*a+S*c+E*d],s+=1}}i[s]=h},e.prototype.bezierCurveTo=function(e,t,n,r,i,s){var o=this.currentSubPath,u=o.length;if(u===0)throw"Needs starting point!";var a=o[u-1],f=a[0],l=a[1],c,h,p,d,v,m,g;if(this.transformPoint===this.transformPointIdentity)c=e,h=t,p=n,d=r,m=i,g=s,v=[i,s];else if(this.transformPoint===this.transformPointTranslate){var y=this.matrix,b=y[2],w=y[5];c=e+b,h=t+w,p=n+b,d=r+w,m=i+b,g=s+w,v=[m,g]}else{var E=this.transformPoint(e,t);c=E[0],h=E[1];var S=this.transformPoint(n,r);p=S[0],d=S[1],v=this.transformPoint(i,s),m=v[0],g=v[1]}var x=Math.abs,T=Math.ceil(this.pixelRatio*Math.sqrt(x(c-f)+x(h-l)+x(p-c)+x(d-h)+x(m-p)+x(g-d)));if(1<T){o.length+=T;var N=1/T;for(var C=N;1<T;C+=N,T-=1){var k=1-C,L=k*k,A=L*k,O=C*C,M=O*C,_=3*C*L,D=3*O*k;o[u]=[A*f+_*c+D*p+M*m,A*l+_*h+D*d+M*g],u+=1}}o[u]=v},e.prototype.arcTo=function(e,t,n,r,i){if(i<0)throw"INDEX_SIZE_ERR";var s,o,u=this.currentSubPath,a=u.length;if(a===0)u[0]=this.transformPoint(e,t),a=1,s=e,o=t;else{var f=this.untransformPoint(u[a-1],this.tempPoint);s=f[0],o=f[1]}var l=s-e,c=o-t,h=l*l+c*c,p=n-e,d=r-t,v=p*p+d*d;if(i<2||h<2||v<2)u.push(this.transformPoint(e,t));else{var m=Math.sqrt,g=Math.acos,y=Math.PI;h=1/m(h),l*=h,c*=h,v=1/m(v),p*=v,d*=v;var b=l+p,w=c+d,E=1/m(b*b+w*w);b*=E,w*=E;var S=b*p+w*d,x=i/S,T=this.transformPoint(e+x*b,t+x*w),N=T[0],C=T[1],k=l*d-p*c>0,L=g(-b);w<0&&(L=-L),L=.5*y-L;var A=g(S),O=y+A+L,M=2*y-A+L;k?this.interpolateArc(N,C,i,M,O,!0):this.interpolateArc(N,C,i,O,M)}},e.prototype.arc=function(e,t,n,r,i,s){if(n<0)throw"INDEX_SIZE_ERR";var o=this.transformPoint(e,t);n<2?this.currentSubPath.push(o):this.interpolateArc(o[0],o[1],n,r,i,s)},e.prototype.ellipse=function(e,t,n,r,i,s,o,u){if(n<0||r<0)throw"INDEX_SIZE_ERR";if(n<2&&r<2){var a=this.transformPoint(e,t);this.currentSubPath.push(a);return}var f,l,c;n===r?(f=n,l=1,c=1):n>r?(f=n,l=1,c=r/n):(f=r,l=n/r,c=1),i!==0||l!==1||c!==1?(this.translate(e,t),i!==0&&this.rotate(i),(l!==1||c!==1)&&this.scale(l,c),this.arc(0,0,f,s,o,u),(l!==1||c!==1)&&this.scale(1/l,1/c),i!==0&&this.rotate(-i),this.translate(-e,-t)):this.arc(e,t,f,s,o,u)},e.prototype.rect=function(e,t,n,r){var i=this.subPaths,s=i.length,o=this.currentSubPath,u=o.length,a=this.needToSimplifyPath;u>1&&(i[s]=o,a[s]=u>2,s+=1);var f=this.transformRect(e,t,n,r,this.tempRect),l=[f[0],f[1]],c=[f[2],f[3]],h=[f[4],f[5]],p=[f[6],f[7]];i[s]=[h,p,c,l,h],this.currentSubPath=[l],a[s]=n<1||r<1,a[s+1]=!0},e.prototype.parsePath=function(e){var t=[],n=e.length,r=-1,i=-1,s=0,o=function(){var r=e.charCodeAt(s);while(r<=32||r===44){s+=1;if(s>=n)return-1;r=e.charCodeAt(s)}return r},u=function(){var r=e.charCodeAt(s);while(r<=32||r===44){s+=1;if(s>=n)throw"Reached end of string without required coordinate.";r=e.charCodeAt(s)}var i=s;if(r===45||r===43){s+=1;if(s>=n)return 0;r=e.charCodeAt(s)}while(r>=48&&r<=57){s+=1;if(s>=n)break;r=e.charCodeAt(s)}if(r===46||r===101||r===101){if(r===46)do{s+=1;if(s>=n)break;r=e.charCodeAt(s)}while(r>=48&&r<=57);if(r===101||r===101){s+=1;if(s<n){r=e.charCodeAt(s);if(r===45||r===43)s+=1,s<n&&(r=e.charCodeAt(s));while(r>=48&&r<=57){s+=1;if(s>=n)break;r=e.charCodeAt(s)}}}return parseFloat(e.slice(i,s))}return parseInt(e.slice(i,s),10)},a=function(){var n=o();if(n<-1)throw"Reached end of string without required flag.";if(n===48)return s+=1,!1;if(n===49)return s+=1,!0;throw"Unknown flag: "+e.slice(s)},f=-1,l=function(t,n,r){var i=t.length;if(0<f){var s=t[f];s<0?t[f]=s-1:t[f]=-2,t.push(n,r)}else f=i,t.push(76,n,r)},c=function(t,n){var r=t[0],i=t[1],s=n[0],o=n[1];return(r*s+i*o)/Math.sqrt((r*r+i*i)*(s*s+o*o))},h=function(t,n){return(t[0]*n[1]<t[1]*n[0]?-1:1)*Math.acos(c(t,n))},p=Math.sqrt,d=Math.abs,v=Math.PI,m=0,g=0,y=0,b=0,w,E,S,x,T,N,C,k,L,A,O;while(s<n){var M=o();if(M<0)return t;if(M===43||M===45||M===46||M>=48&&M<=57){if(r<0)throw"Coordinates without a command: "+e.slice(s);r===77?r=76:r===109&&(r=108)}else i=r,r=M,s+=1;switch(r){case 77:case 109:w=u(),E=u(),r===109&&(w+=m,E+=g),y=w,b=E,t.push(77,w,E),f=-1;break;case 76:case 108:w=u(),E=u(),r===108&&(w+=m,E+=g),l(t,w,E);break;case 72:case 104:w=u(),r===104&&(w+=m),E=g,l(t,w,E);break;case 86:case 118:w=m,E=u(),r===118&&(E+=g),l(t,w,E);break;case 67:case 99:S=u(),x=u(),T=u(),N=u(),w=u(),E=u(),r===99&&(S+=m,x+=g,T+=m,N+=g,w+=m,E+=g),t.push(67,S,x,T,N,w,E),f=-1;break;case 83:case 115:i===67||i===99||i===83||i===115?(S=2*m-T,x=2*g-N):(S=m,x=g),T=u(),N=u(),w=u(),E=u(),r===115&&(T+=m,N+=g,w+=m,E+=g),t.push(67,S,x,T,N,w,E),f=-1;break;case 81:case 113:S=u(),x=u(),w=u(),E=u(),r===113&&(S+=m,x+=g,w+=m,E+=g),t.push(81,S,x,w,E),f=-1;break;case 84:case 116:i===81||i===113||i===84||i===116?(S=2*m-S,x=2*g-x):(S=m,x=g),w=u(),E=u(),r===116&&(w+=m,E+=g),t.push(81,S,x,w,E),f=-1;break;case 65:case 97:S=m,x=g,C=u(),k=u(),L=u(),L*=v/180,A=a(),O=a(),w=u(),E=u(),r===97&&(w+=m,E+=g);var _=Math.cos(L),D=Math.sin(L),P=(S-w)*.5,H=(x-E)*.5,B=_*P+D*H,j=B*B,F=-D*P+_*H,I=F*F,q=j/(C*C)+I/(k*k);if(q>1){var R=p(q);C*=R,k*=R}var U=C*C,z=1/C,W=k*k,X=1/k,V=(A===O?-1:1)*p((U*W-U*I-W*j)/(U*I+W*j));isNaN(V)&&(V=0);var $=V*C*F*X,J=V*-k*B*z,K=(S+w)*.5+_*$-D*J,Q=(x+E)*.5+D*$+_*J,G=[(B-$)*z,(F-J)*X],Y=[(-B-$)*z,(-F-J)*X],Z=h([1,0],G),et,tt=c(G,Y);tt<=-1?et=v:tt>=1?et=0:et=h(G,Y),O?et<0&&(et+=2*v):et>0&&(et-=2*v);var nt,rt,it;C===k?(nt=C,rt=1,it=1):C>k?(nt=C,rt=1,it=k*z):(nt=k,rt=C*X,it=1),t.push(65,L,rt,it,K,Q,nt,Z,Z+et,!O),f=-1;break;case 90:case 122:if(3<=f&&t[f-3]===77){var st=t[f-2],ot=t[f-1];d(st-m)<1&&d(ot-g)<1&&(t[f]+=1,t[f]===0?t.length=f:t.length-=2)}w=y,E=b,t.push(90),f=-1;break;default:throw"Unknown command: "+e.slice(s)}m=w,g=E}return t},e.prototype.addPoints=function(e,t,n){var r=this.currentSubPath,i=r.length,s=i+n,o=t;r.length=s;if(this.transformPoint===this.transformPointIdentity){do r[i]=[e[o],e[o+1]],o+=2,i+=1;while(i<s)}else if(this.transformPoint===this.transformPointTranslate){var u=this.matrix,a=u[2],f=u[5];do r[i]=[e[o]+a,e[o+1]+f],o+=2,i+=1;while(i<s)}else do r[i]=this.transformPoint(e[o],e[o+1]),o+=2,i+=1;while(i<s);return o},e.prototype.path=function(e){var t=this.cachedPaths[e];t===undefined&&(this.numCachedPaths>=1024&&(this.cachedPaths={},this.numCachedPaths=0),t=this.parsePath(e),this.cachedPaths[e]=t,this.numCachedPaths+=1),this.compiledPath(t)},e.prototype.compiledPath=function(e){var t=e.length,n=-1,r=0,i,s,o,u,a,f;while(r<t){n=e[r],r+=1;if(n<0){r=this.addPoints(e,r,-n);continue}switch(n){case 77:i=e[r],r+=1,s=e[r],r+=1,this.moveTo(i,s);break;case 76:i=e[r],r+=1,s=e[r],r+=1,this.currentSubPath.push(this.transformPoint(i,s));break;case 67:o=e[r],r+=1,u=e[r],r+=1,a=e[r],r+=1,f=e[r],r+=1,i=e[r],r+=1,s=e[r],r+=1,this.bezierCurveTo(o,u,a,f,i,s);break;case 81:o=e[r],r+=1,u=e[r],r+=1,i=e[r],r+=1,s=e[r],r+=1,this.quadraticCurveTo(o,u,i,s);break;case 65:var l=e[r];r+=1;var c=e[r];r+=1;var h=e[r];r+=1;var p=e[r];r+=1;var d=e[r];r+=1;var v=e[r];r+=1;var m=e[r];r+=1;var g=e[r];r+=1;var y=e[r];r+=1,l!==0||c!==1||h!==1?(this.translate(p,d),l!==0&&this.rotate(l),(c!==1||h!==1)&&this.scale(c,h),this.arc(0,0,v,m,g,y),(c!==1||h!==1)&&this.scale(1/c,1/h),l!==0&&this.rotate(-l),this.translate(-p,-d)):this.arc(p,d,v,m,g,y);break;case 90:this.closePath();break;default:}}},e.prototype.fill=function(){var e=this.subPaths,t=e.length,n=this.currentSubPath,r=this.needToSimplifyPath;if(t>0||n.length>2){var i=this.autoClose,s=this.canTriangulateAsFan,o=this.triangulateAsFan,u,a,f,l=this.fillStyle,c,h,p=0;if(t>1||t===1&&n.length>2){c=this.trianglePrimitive,h=this.tempVertices;for(var d=0;d<t;d+=1)u=e[d],a=u.length,a>2&&(a=i(u,a),f=a-1,r[d]&&(r[d]=!1,f=this.simplifyShape(u)),f>1&&(s(u,f)?p=o(u,f,h,p):p=this.triangulateConcaveCached(u,f,h,p)));u=n,a=u.length,a>2&&(a=i(u,a),f=a-1,r[t]&&(r[t]=!1,f=this.simplifyShape(u)),f>1&&(s(u,f)?p=o(u,f,h,p):p=this.triangulateConcaveCached(u,f,h,p)))}else t>0?u=e[0]:u=n,a=u.length,a>2&&(a=i(u,a),f=a-1,r[0]&&(r[0]=!1,f=this.simplifyShape(u)),f>1&&(s(u,f)?(c=this.triangleFanPrimitive,h=u,p=f):(c=this.trianglePrimitive,h=this.tempVertices,p=this.triangulateConcaveCached(u,f,h,0))));if(p>0){var v=this.getFlatBuffer(p);this.fillFlatVertices(v,h,p),this.fillFlatBuffer(v,p);var m=this.gd;this.setShadowStyle(l)&&m.draw(c,p,this.flatOffset),this.setStyle(l),m.draw(c,p,this.flatOffset),this.flatOffset+=p}}},e.prototype.stroke=function(){var e=this.subPaths,t=e.length,n=this.currentSubPath,r=this.needToSimplifyPath;if(t>0||n.length>0){var i=this.gd,s=this.strokeStyle,o=this.lineWidth,u=this.pixelRatio*o<2,a,f,l,c,h;u?l=this.lineStripPrimitive:l=this.triangleStripPrimitive;for(var p=0;p<t;p+=1){a=e[p],f=a.length,r[p]&&(r[p]=!1,f=1+this.simplifyShape(a));if(u)c=f,h=this.getFlatBuffer(c),this.fillFlatVertices(h,a,c),this.fillFlatBuffer(h,c);else{if(!(f>1))continue;c=this.fillFatStrip(a,f,o)}this.setShadowStyle(s)&&i.draw(l,c,this.flatOffset),this.setStyle(s),i.draw(l,c,this.flatOffset),this.flatOffset+=c}a=n,f=a.length;if(f>0){r[t]&&(r[t]=!1,f>2&&(f=1+this.simplifyShape(a)));if(u)c=f,h=this.getFlatBuffer(c),this.fillFlatVertices(h,a,c),this.fillFlatBuffer(h,c);else{if(!(f>1))return;c=this.fillFatStrip(a,f,o)}this.setShadowStyle(s)&&i.draw(l,c,this.flatOffset),this.setStyle(s),i.draw(l,c,this.flatOffset),this.flatOffset+=c}}},e.prototype.drawSystemFocusRing=function(){},e.prototype.drawCustomFocusRing=function(){return!1},e.prototype.scrollPathIntoView=function(){},e.prototype.clip=function(){var e,t,n,r,i,s,o,u=0,a=[],f=this.subPaths,l=f.length;if(l>0){a.length=l,n=0;do e=f[n],e.length>2&&(a[u]=e.slice(),u+=1),n+=1;while(n<l)}var c=this.currentSubPath;c.length>2&&(a[u]=c.slice(0),u+=1);if(u===0)return;var h=this.autoClose,p,d,v,m;n=0;do{e=a[n],t=h(e,e.length),r=0,p===undefined&&(i=e[0],p=v=i[0],d=m=i[1],r=1);do i=e[r],s=i[0],o=i[1],p>s?p=s:v<s&&(v=s),d>o?d=o:m<o&&(m=o),r+=1;while(r<t);n+=1}while(n<u);var g=this.clipExtents,y=g[0],b=g[1],w=g[2],E=g[3];y=y>p?y:p,b=b>d?b:d,w=w<v?w:v,E=E<m?E:m,g[0]=y,g[1]=b,g[2]=w,g[3]=E,this.updateScissor()},e.prototype.isPointInPath=function(e,t){var n=this.subPaths,r=n.length;if(r>0)for(var i=0;i<r;i+=1)if(this.isPointInSubPath(e,t,n[i]))return!0;var s=this.currentSubPath;return this.isPointInSubPath(e,t,s)?!0:!1},e.prototype.fillText=function(t,n,r,i){if(i!==undefined&&i<=0)return;var s=this.fm;if(!s)return;var o=this.buildFontName();if(!o)return;var u=s.load(o);if(!u)return;i||(i=this.width);var a,f=this.fillStyle;typeof f=="string"?a=this.parseColor(f):a=this.v4One;var l=this.globalAlpha;if(l<1){var c=this.tempColor;c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3]*l,a=c}var h=this.textureTechniques[this.globalCompositeOperation];if(!h)throw"Unknown composite operation: "+this.globalCompositeOperation;this.setTechniqueWithColor(h,this.screen,a);var p=this.calculateFontScale(u);if(this.textBaseline==="alphabetic")r-=u.baseline*p;else if(this.textBaseline==="middle")r-=u.baseline*.5*p;else if(this.textBaseline==="bottom"||this.textBaseline==="ideographic")r-=u.lineHeight*p;var d;this.textAlign==="left"||this.textAlign==="start"?d=0:this.textAlign==="right"||this.textAlign==="end"?d=2:d=1;var v;if(this.transformRect===e.prototype.transformRect){var m=u.calculateTextDimensions(t,p,0);v={rect:[n,r,i,i],scale:p,spacing:0,alignment:d,dimensions:m};var g=m.numGlyphs,y=m.glyphCounts,b=y.length,w,E,S=u.fm.scratchPageContext;for(w=0;w<b;w+=1){E=y[w];if(E){S=u.generatePageTextVertices(t,v,w,S);var x=S.vertices;if(x){var T=x.length,N;for(N=0;N<T;N+=4){var C=this.transformPoint(x[N],x[N+1]);x[N]=C[0],x[N+1]=C[1]}}u.drawTextVertices(S,w,!0)}g-=E;if(0===g)break}}else{var k=this.transformRect(n,r,i,i,this.tempRect);n=k[4],r=k[5];var L=k[2]-n,A=k[3]-r;v={rect:[n,r,L,A],scale:p,spacing:0,alignment:d}}u.drawTextRect(t,v),this.activeVertexBuffer=null},e.prototype.strokeText=function(){},e.prototype.measureText=function(e){var t=this.fm;if(t){var n=this.buildFontName();if(n){var r=t.load(n);if(r){var i=this.calculateFontScale(r);return{width:r.calculateTextDimensions(e,i,0).width}}}}return{width:0}},e.prototype.drawImage=function(e,t,n,r,i){var s,o,u,a,f,l,c,h;if(arguments.length>=7){var p=arguments[1],d=arguments[2],v=arguments[3],m=arguments[4];s=arguments[5],o=arguments[6],arguments.length>=9?(u=arguments[7],a=arguments[8]):(u=v,a=m);var g=1/e.width,y=1/e.height;f=p*g,l=d*y,c=(p+v)*g,h=(d+m)*y}else s=arguments[1],o=arguments[2],arguments.length>=5?(u=arguments[3],a=arguments[4]):(u=e.width,a=e.height),f=0,l=0,c=1,h=1;if(u>0&&a>0){var b=this.getTextureBuffer(4);if(b){var w=this.transformRect(s,o,u,a,this.tempRect);b[0]=w[0],b[1]=w[1],b[2]=f,b[3]=h,b[4]=w[2],b[5]=w[3],b[6]=c,b[7]=h,b[8]=w[4],b[9]=w[5],b[10]=f,b[11]=l,b[12]=w[6],b[13]=w[7],b[14]=c,b[15]=l,this.fillTextureBuffer(b,4);var E=this.triangleStripPrimitive,S=this.gd;this.setShadowStyle(e,!0)&&S.draw(E,4);var x=this.textureTechniques[this.globalCompositeOperation];if(!x)throw"Unknown composite operation: "+this.globalCompositeOperation;var T=this.parseColor(this.imageColor),N=this.globalAlpha;if(N<1){var C=this.tempColor;C[0]=T[0],C[1]=T[1],C[2]=T[2],C[3]=T[3]*N,T=C}this.setTechniqueWithColor(x,this.screen,T),x.texture=e,S.draw(E,4)}}},e.prototype.createImageData=function(){var e,t;if(arguments.length===2)e=arguments[0],t=arguments[1];else{if(arguments.length!==1)throw"Wrong arguments";var n=arguments[0];e=n.width,t=n.height}var r=e*t*4,i=new Array(r);for(var s=0;s<r;s+=1)i[s]=0;return{width:e,height:t,data:i}},e.prototype.getImageData=function(e,t,n,r){var i=this.gd;t=this.height-(t+r);var s=i.getScreenshot(!1,e,t,n,r);return{width:n,height:r,data:s}},e.prototype.putImageData=function(e,t,n){if(!e||!e.data)throw"TYPE_MISMATCH_ERR";var r=e.width,i=e.height,s,o,u,a;arguments.length>=7?(s=arguments[3],o=arguments[4],u=arguments[5],a=arguments[6]):(s=0,o=0,u=r,a=i);if(u&&a){var f=this.gd,l=this.tempImage;if(l===null||l.width!==u||l.height!==a)this.tempImage=l=f.createTexture({name:"imageData:"+u+"x"+a,width:u,height:a,depth:1,format:f.PIXELFORMAT_R8G8B8A8,cubemap:!1,mipmaps:!1});l.setData(e.data);var c=this.viewport;f.setScissor(c[0],c[1],c[2],c[3]);var h=this.getTextureBuffer(4);if(h){var p=2/this.width,d=2/this.height,v=t*p-1,m=1-n*d,g=(t+u)*p-1,y=1-(n+a)*d,b=1/r,w=1/i,E=s*b,S=o*w,x=(s+u)*b,T=(o+a)*w;h[0]=v,h[1]=y,h[2]=E,h[3]=T,
h[4]=g,h[5]=y,h[6]=x,h[7]=T,h[8]=v,h[9]=m,h[10]=E,h[11]=S,h[12]=g,h[13]=m,h[14]=x,h[15]=S,this.fillTextureBuffer(h,4);var N=this.imageTechnique;f.setTechnique(N),this.activeTechnique=null,N.image=l,f.draw(this.triangleStripPrimitive,4)}this.updateScissor()}},e.prototype.beginFrame=function(e,t){if(this.target)throw'"endFrame" was never called!';var n=this.gd;e||(e=n),this.target=e,n.setViewport(0,0,e.width,e.height);var r=this.viewport;t?(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]):(r[0]=0,r[1]=0,r[2]=e.width,r[3]=e.height);var i=this.canvas,s=i.width,o=i.height;this.updateScreenScale(),this.updateScissor(),this.pixelRatio=Math.max(r[2]/s,r[3]/o),this.activeVertexBuffer=null,this.activeTechnique=null,this.flatOffset=0;if(s!==this.width||o!==this.height)this.width=s,this.height=o,this.resetState(),this.clearRect(0,0,s,o);return!0},e.prototype.endFrame=function(){var e=this.target;if(!e)throw'"beginFrame" was never called!';this.target=null,this.gd.setScissor(0,0,e.width,e.height)},e.prototype.setWidth=function(e){this.width=e,this.resetState(),this.target&&(this.updateScreenScale(),this.clearRect(0,0,e,this.height))},e.prototype.setHeight=function(e){this.height=e,this.resetState(),this.target&&(this.updateScreenScale(),this.clearRect(0,0,this.width,e))},e.prototype.createStatesObject=function(){var e={globalAlpha:this.globalAlpha,globalCompositeOperation:this.globalCompositeOperation,strokeStyle:this.strokeStyle,fillStyle:this.fillStyle,lineWidth:this.lineWidth,lineCap:this.lineCap,lineJoin:this.lineJoin,miterLimit:this.miterLimit,shadowOffsetX:this.shadowOffsetX,shadowOffsetY:this.shadowOffsetY,shadowBlur:this.shadowBlur,shadowColor:this.shadowColor,font:this.font,textAlign:this.textAlign,textBaseline:this.textBaseline,imageColor:this.imageColor,matrix:new this.floatArrayConstructor(6),scale:this.scale,translate:this.translate,transform:this.transform,setTransform:this.setTransform,transformPoint:this.transformPoint,transformRect:this.transformRect,clipExtents:new this.floatArrayConstructor(4)},t=e.matrix,n=this.matrix;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5];var r=e.clipExtents,i=this.clipExtents;return r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=i[3],e},e.prototype.setStates=function(e,t){e.globalAlpha=t.globalAlpha,e.globalCompositeOperation=t.globalCompositeOperation,e.strokeStyle=t.strokeStyle,e.fillStyle=t.fillStyle,e.lineWidth=t.lineWidth,e.lineCap=t.lineCap,e.lineJoin=t.lineJoin,e.miterLimit=t.miterLimit,e.shadowOffsetX=t.shadowOffsetX,e.shadowOffsetY=t.shadowOffsetY,e.shadowBlur=t.shadowBlur,e.shadowColor=t.shadowColor,e.font=t.font,e.textAlign=t.textAlign,e.textBaseline=t.textBaseline,e.imageColor=t.imageColor;var n=e.matrix,r=t.matrix;n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],e.scale=t.scale,e.translate=t.translate,e.transform=t.transform,e.setTransform=t.setTransform,e.transformPoint=t.transformPoint,e.transformRect=t.transformRect;var i=e.clipExtents,s=t.clipExtents;return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],e},e.prototype.resetState=function(){this.numStatesInStack=0,this.beginPath(),this.setStates(this,this.defaultStates);var e=this.clipExtents;e[0]=0,e[1]=0,e[2]=this.width,e[3]=this.height,this.target&&this.updateScissor()},e.prototype.updateScreenScale=function(){var e=this.screen,t=this.target,n=this.viewport,r=t.width,i=t.height;e[0]=2*n[2]/(this.width*r),e[1]=-2*n[3]/(this.height*i),e[2]=-1+2*n[0]/r,e[3]=1-2*(n[1]+n[3]-i)/i},e.prototype.updateScissor=function(){var e=this.viewport,t=e[0],n=e[1],r=e[2],i=e[3],s=r/this.width,o=i/this.height,u=this.clipExtents,a=u[0]*s,f=u[1]*o,l=u[2]*s,c=u[3]*o,h=t+a,p=n+(i-c),d=l-a,v=c-f;h<0&&(h=0),p<0&&(p=0);var m=this.target;h+d>m.width&&(d=m.width-h),p+v>m.height&&(v=m.height-p),this.gd.setScissor(h,p,d,v)},e.prototype.setFontManager=function(e){this.fm=e},e.prototype.buildFontName=function(){var e,t=this.font,n=t.lastIndexOf(" ");return n!==-1&&(e="fonts/"+t.substr(n+1)+".fnt"),e},e.prototype.calculateFontScale=function(e){var t=parseInt(this.font,10);return isNaN(t)?1:t/e.lineHeight},e.prototype.resetTransformMethods=function(){var t=e.prototype;this.scale=t.scale,this.translate=t.translate,this.transform=t.transform,this.setTransform=t.setTransform,this.transformPoint=t.transformPoint,this.transformRect=t.transformRect},e.prototype.transformPoint=function(e,t){var n=this.matrix;return[e*n[0]+t*n[1]+n[2],e*n[3]+t*n[4]+n[5]]},e.prototype.transformRect=function(e,t,n,r,i){var s=this.matrix,o=s[0],u=s[1],a=s[2],f=s[3],l=s[4],c=s[5],h=e*o+t*u+a,p=e*f+t*l+c,d=n*o,v=r*u,m=n*f,g=r*l;return i[0]=h+v,i[1]=p+g,i[2]=h+d+v,i[3]=p+m+g,i[4]=h,i[5]=p,i[6]=h+d,i[7]=p+m,i},e.prototype.transformPointTranslate=function(e,t){var n=this.matrix;return[e+n[2],t+n[5]]},e.prototype.transformRectTranslate=function(e,t,n,r,i){var s=this.matrix,o=e+s[2],u=t+s[5],a=o+n,f=u+r;return i[0]=o,i[1]=f,i[2]=a,i[3]=f,i[4]=o,i[5]=u,i[6]=a,i[7]=u,i},e.prototype.transformPointIdentity=function(e,t){return[e,t]},e.prototype.transformRectIdentity=function(e,t,n,r,i){var s=e+n,o=t+r;return i[0]=e,i[1]=o,i[2]=s,i[3]=o,i[4]=e,i[5]=t,i[6]=s,i[7]=t,i},e.prototype.transformTranslate=function(e,t,n,r,i,s){var o=this.matrix;o[0]=e,o[3]=t,o[1]=n,o[4]=r,o[2]=i+o[2],o[5]=s+o[5],this.resetTransformMethods()},e.prototype.scaleIdentity=function(e,t){if(e<.999||1.001<e||t<.999||1.001<t){var n=this.matrix;n[0]=e,n[4]=t,this.resetTransformMethods()}},e.prototype.translateIdentity=function(t,n){if(t!==0||n!==0){var r=this.matrix;r[2]=t,r[5]=n,this.translate=e.prototype.translate,this.transform=this.transformTranslate,this.transformPoint=this.transformPointTranslate,this.transformRect=this.transformRectTranslate}},e.prototype.setTransformIdentity=function(e,t,n,r,i,s){var o=this.matrix;o[0]=e,o[1]=n,o[2]=i,o[3]=t,o[4]=r,o[5]=s,this.resetTransformMethods()},e.prototype.untransformPoint=function(e,t){if(this.transformPoint===this.transformPointIdentity)return e;var n=this.matrix,r=e[0],i=e[1];if(this.transformPoint===this.transformPointTranslate)return t[0]=r-n[2],t[1]=i-n[5],t;var s=n[0],o=n[1],u=n[2],a=n[3],f=n[4],l=n[5],c,h,p,d,v,m,g=s*f-o*a;if(g===0)return e;c=f,d=-a,h=-o,v=s,p=o*l-f*u,m=u*a-s*l;if(g!==1){var y=1/g;c*=y,d*=y,h*=y,v*=y,p*=y,m*=y}return t[0]=r*c+i*h+p,t[1]=r*d+i*v+m,t},e.prototype.calculateGradientUVtransform=function(e){var t=this.matrix,n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=e[0],f=e[1],l=e[2],c=e[3],h=e[4],p=e[5],d,v,m,g,y,b,w=n*o-r*s;if(w===0)d=1,g=0,v=0,y=1,m=0,b=0;else{d=o,g=-s,v=-r,y=n,m=r*u-o*i,b=i*s-n*u;if(w!==1){var E=1/w;d*=E,g*=E,v*=E,y*=E,m*=E,b*=E}}var S=this.uvtransform;return S[0]=a*d+f*g,S[1]=a*v+f*y,S[2]=a*m+f*b+l,S[3]=c*d+h*g,S[4]=c*v+h*y,S[5]=c*m+h*b+p,S},e.prototype.calculatePatternUVtransform=function(e,t){var n=this.matrix,r=n[0],i=n[1],s=n[2],o=n[3],u=n[4],a=n[5],f=1/e,l=1/t,c,h,p,d,v,m,g=r*u-i*o;if(g===0)c=1,d=0,h=0,v=1,p=0,m=0;else{c=u,d=-o,h=-i,v=r,p=i*a-u*s,m=s*o-r*a;if(g!==1){var y=1/g;c*=y,d*=y,h*=y,v*=y,p*=y,m*=y}}var b=this.uvtransform;return b[0]=f*c,b[1]=f*h,b[2]=f*p,b[3]=l*d,b[4]=l*v,b[5]=l*m,b},e.prototype.setShadowStyle=function(e,t){var n=this.shadowOffsetX,r=this.shadowOffsetY;if(n<1&&r<1)return!1;if(this.globalCompositeOperation!=="source-over")return!1;var i=this.parseColor(this.shadowColor),s=i[3]*this.globalAlpha;this.shadowBlur>0&&(s*=.5);if(s<.004)return!1;if(s<1){var o=this.tempColor;o[0]=i[0]*s,o[1]=i[1]*s,o[2]=i[2]*s,o[3]=s,i=o}var u=this.screen,a=u[0],f=u[1],l=this.tempScreen;l[0]=a,l[1]=f,l[2]=u[2]+n*a,l[3]=u[3]+r*f,u=l;var c;if(typeof e!="string"&&!e.opaque)if(t)c=this.textureShadowTechnique,this.setTechniqueWithColor(c,u,i),c.texture=e;else if(e.stops){var h=e.updateTexture(this.gd),p=h.width,d=h.height;if(!p||!d)throw"INVALID_STATE_ERR";c=this.gradientShadowTechnique,this.setTechniqueWithColor(c,u,i),c.uvtransform=this.calculateGradientUVtransform(e.matrix),c.gradient=h}else{var v=e.width,m=e.height;if(!v||!m)throw"INVALID_STATE_ERR";c=this.patternShadowTechnique,this.setTechniqueWithColor(c,u,i),c.uvtransform=this.calculatePatternUVtransform(v,m),c.pattern=e}else s<1?c=this.flatTechniques["source-over"]:c=this.flatTechniques.copy,this.setTechniqueWithColor(c,u,i);return!0},e.prototype.setStyle=function(e){if(!e)throw"INVALID_STATE_ERR";var t=this.globalCompositeOperation,n=this.screen,r;if(typeof e=="string"){var i=this.parseColor(e),s=i[3]*this.globalAlpha;if(s<1){var o=this.tempColor;o[0]=i[0]*s,o[1]=i[1]*s,o[2]=i[2]*s,o[3]=s,i=o}if(t!=="source-over"||s<1){r=this.flatTechniques[t];if(!r)throw"Unknown composite operation: "+t}else r=this.flatTechniques.copy;this.setTechniqueWithColor(r,n,i)}else if(e.stops){var u=e.updateTexture(this.gd),a=u.width,f=u.height;if(!a||!f)throw"INVALID_STATE_ERR";var l=this.globalAlpha;if(t!=="source-over"||l<1||!e.opaque){r=this.gradientTechniques[t];if(!r)throw"Unknown composite operation: "+t}else r=this.gradientTechniques.copy;this.setTechniqueWithAlpha(r,n,l),r.uvtransform=this.calculateGradientUVtransform(e.matrix),r.gradient=u}else{var c=e.width,h=e.height;if(!c||!h)throw"INVALID_STATE_ERR";r=this.patternTechniques[t];if(!r)throw"Unknown composite operation: "+t;this.setTechniqueWithAlpha(r,n,this.globalAlpha),r.uvtransform=this.calculatePatternUVtransform(c,h),r.pattern=e}},e.prototype.setStream=function(e,t){this.activeVertexBuffer!==e&&(this.activeVertexBuffer=e,this.gd.setStream(e,t,0))},e.prototype.setTechniqueWithAlpha=function(e,t,n){var r=this.activeScreen,i=this.activeColor;if(this.activeTechnique!==e)this.activeTechnique=e,this.gd.setTechnique(e),e.screen=t,e.alpha=n,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],i[3]=n;else{if(r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3])r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],e.screen=t;i[3]!==n&&(i[3]=n,e.alpha=n)}},e.prototype.setTechniqueWithColor=function(e,t,n){var r=this.activeScreen,i=this.activeColor;if(this.activeTechnique!==e)this.activeTechnique=e,this.gd.setTechnique(e),e.screen=t,e.color=n,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3];else{if(r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3])r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],e.screen=t;if(i[0]!==n[0]||i[1]!==n[1]||i[2]!==n[2]||i[3]!==n[3])i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],e.color=n}},e.prototype.parseColor=function(e){var t=this.cachedColors[e];if(t!==undefined)return t;this.numCachedColors>=1024&&(this.cachedColors={},this.numCachedColors=0),t=ot(e,new this.floatArrayConstructor(4));if(t)return this.cachedColors[e]=t,this.numCachedColors+=1,t;throw"Unknown color: "+e},e.prototype.interpolateArc=function(e,t,n,r,i,s){var o=Math.cos,u=Math.sin,a=Math.PI*2,f=this.currentSubPath,l=f.length,c,h,p,d,v=1/Math.sqrt(n*this.pixelRatio),m=this.matrix,g=m[0]*n,y=m[1]*n,b=m[3]*n,w=m[4]*n;if(s){while(i>=r)i-=a;h=r-i;if(h>=v)for(c=r;c>i;c-=v)p=o(c),d=u(c),f[l]=[p*g+d*y+e,p*b+d*w+t],l+=1}else{while(i<=r)i+=a;h=i-r;if(h>=v)for(c=r;c<i;c+=v)p=o(c),d=u(c),f[l]=[p*g+d*y+e,p*b+d*w+t],l+=1}p=o(i),d=u(i),f[l]=[p*g+d*y+e,p*b+d*w+t]},e.prototype.getFlatBuffer=function(e){var t=this.bufferData,n=2*e;if(t.length<n)this.bufferData=t=new this.floatArrayConstructor(n),this.subBufferDataCache={};else if(n<t.length){var r=this.subBufferDataCache[n];r===undefined&&(r=t.subarray(0,n),this.subBufferDataCache[n]=r),t=r}return t},e.prototype.fillFlatBuffer=function(e,t){var n=this.flatVertexBuffer;n.numVertices<t?(n.destroy(),this.flatVertexBuffer=n=this.gd.createVertexBuffer({numVertices:t,attributes:this.flatVertexFormats,dynamic:!0,"transient":!0}),this.flatOffset=0):this.flatOffset+t>n.numVertices&&(this.flatOffset=0),n.setData(e,this.flatOffset,t),this.setStream(n,this.flatSemantics)},e.prototype.getTextureBuffer=function(e){var t=this.bufferData,n=4*e;if(t.length<n)this.bufferData=t=new this.floatArrayConstructor(n),this.subBufferDataCache={};else if(n<t.length){var r=this.subBufferDataCache[n];r===undefined&&(r=t.subarray(0,n),this.subBufferDataCache[n]=r),t=r}return t},e.prototype.fillTextureBuffer=function(e,t){var n=this.textureVertexBuffer;n.numVertices<t&&(n.destroy(),this.textureVertexBuffer=n=null,this.textureVertexBuffer=n=this.gd.createVertexBuffer({numVertices:t,attributes:this.textureVertexFormats,dynamic:!0,"transient":!0})),n.setData(e,0,t),this.setStream(n,this.textureSemantics)},e.prototype.fillFatStrip=function(e,t,n){var r=0,i=this.getFlatBuffer(t*2);if(i){var s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E=Math.sqrt,S=Math.abs,x=n*.5;o=e[0],u=o[0],a=o[1];var T=e[t-1],N=S(u-T[0])<1&&S(a-T[1])<1;if(N){if(t<3)return 0;o=e[t-2],c=u-o[0],h=a-o[1]}else o=e[1],c=o[0]-u,h=o[1]-a;v=c*c+h*h,v>0&&(v=1/E(v),c*=v,h*=v),s=0,y=0;do{s+=1;if(s<t)o=e[s],f=o[0],l=o[1];else{if(!N){c*=x,h*=x,i[y+0]=u-h,i[y+1]=a+c,i[y+2]=u+h,i[y+3]=a-c,y+=4,r+=2;break}o=e[1],f=o[0],l=o[1]}p=f-u,d=l-a,v=p*p+d*d,v>=1&&(v=1/E(v),p*=v,d*=v,m=c+p,g=h+d,v=m*m+g*g,v>.001?(b=n/v,w=x/E(v),h*p>c*d&&(v=b,b=w,w=v)):(m=-h,g=c,b=x,w=x),i[y+0]=u-g*b,i[y+1]=a+m*b,i[y+2]=u+g*w,i[y+3]=a-m*w,y+=4,r+=2,u=f,a=l,c=p,h=d)}while(s<t);this.fillFlatBuffer(i,r)}return r},e.prototype.autoClose=function(e,t){var n=e[0],r=e[t-1];if(n===r)return t;var i=Math.abs;return i(n[0]-r[0])<1&&i(n[1]-r[1])<1?t:(e[t]=n,t+1)},e.prototype.isClosed=function(e,t){if(e===t)return!0;var n=Math.abs;return n(e[0]-t[0])<1&&n(e[1]-t[1])<1?!0:!1},e.prototype.canTriangulateAsFan=function(e,t){if(t<4)return!0;var n=0,r=e[0],i=e[1],s=r[0],o=r[1],u=i[0],a=i[1],f=u-s,l=a-o,c=2;do{var h=e[c],p=h[0],d=h[1],v=p-s,m=d-o,g=f*m-l*v;g<0?n|=1:g>0&&(n|=2);if(n===3)return!1;f=v,l=m,c+=1}while(c<t);return n!==0?!0:!1},e.prototype.simplifyShape=function(e){var t=Math.abs,n=.5/this.pixelRatio,r=this.tempStack,i=0,s=0,o=e.length-1,u=e[o],a=u[0],f=u[1],l,c;for(;;){var h=e[s],p=h[0],d=h[1],v=a-p,m=f-d,g=s+1,y=n,b=-1;if(t(v)<n)for(l=g;l<o;l+=1)c=t(e[l][0]-a),y<c&&(y=c,b=l);else if(t(m)<n)for(l=g;l<o;l+=1)c=t(e[l][1]-f),y<c&&(y=c,b=l);else{var w=m/v,E=d-w*p,S;y*=Math.sqrt(w*w+1);for(l=g;l<o;l+=1)S=e[l],c=t(w*S[0]-S[1]+E),y<c&&(y=c,b=l)}if(b===-1){o===e.length-1?(e[g]=u,e.length=g+1):e.splice(g,o-g);if(i===0)break;i-=2,s=r[i],o=r[i+1],u=e[o],a=u[0],f=u[1]}else if(g<b)b+1<o?(r[i]=s,r[i+1]=b,i+=2,s=b):(o=b,u=e[o],a=u[0],f=u[1]);else if(b+1<o)s=b;else{if(i===0)break;i-=2,s=r[i],o=r[i+1],u=e[o],a=u[0],f=u[1]}}return e.length-1},e.prototype.calculateArea=function(e,t){var n=0,r=e[t-2],i=e[t-1],s=0;do{var o=e[s];n+=i[0]*(o[1]-r[1]),r=i,i=o,s+=1}while(s<t);return n*.5},e.prototype.triangulateAsFan=function(e,t,n,r){var i=e[0],s=e[1],o=2;do{var u=e[o];n[r]=i,n[r+1]=s,n[r+2]=u,r+=3,s=u,o+=1}while(o<t);return r},e.prototype.getAngles=function(e,t,n){var r=e[0],i=e[1],s=r[0],o=r[1],u=i[0],a=i[1],f=u-s,l=a-o,c=f*f+l*l,h=2,p=Math.sqrt,d;do{var v=e[h],m=v[0],g=v[1],y=m-s,b=g-o,w=y*y+b*b;d=(f*b-l*y)/p(c*w),n[h-2]=d*100|0,f=y,l=b,c=w,h+=1}while(h<t);return h-2},e.prototype.lowerBound=function(e,t,n){var r=0,i=e.length>>>1,s,o,u,a,f,l;while(0<i){s=i>>>1,o=r+s,u=(o<<1)+1,f=0,l=e[u];for(;;){a=l[f]-t[f];if(a<0){r=o+1,i-=s+1;break}if(a>0){i=s;break}f+=1;if(f>=n)return-u}}return r<<1},e.prototype.triangulateConcaveCached=function(e,t,n,r){var i,s=this.tempAngles,o=this.getAngles(e,t,s),u=this.cachedTriangulation,a=u[o];a===undefined?(u[o]=a=[],i=0):i=this.lowerBound(a,s,o);if(i<0)i=-i-1,r=this.expandIndices(e,n,r,a[i]);else{var f=this.calculateArea(e,t);if(f===0)return r;var l=t+1,c;for(c=0;c<l;c+=1)e[c][2]=c;var h=r;r=this.triangulateConcave(e,t,n,r,!1,f);var p=r-h,d=l<256?new this.byteArrayConstructor(p):new this.shortArrayConstructor(p);for(c=0;c<p;c+=1)d[c]=n[h+c][2];a.length>=1024&&(a.length=0,i=0);var v=s.slice(0,o);i<a.length?a.splice(i,0,d,v):a.push(d,v)}return r},e.prototype.expandIndices=function(e,t,n,r){var i=r.length,s,o;for(s=0,o=n;s<i;s+=1,o+=1)t[o]=e[r[s]];return o},e.prototype.triangulateConcave=function(e,t,n,r,i,s){var o=this.canTriangulateAsFan;i?e.length=t:e=e.slice(0,t);var u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I;do{u=t-2,a=t-1,f=0,l=e[u],v=l[0],m=l[1],c=e[a],g=c[0],y=c[1],x=g-v,T=y-m,F=!1;do{I=!1,h=e[f],b=h[0],w=h[1],E=b-v,S=w-m,d=x*S-E*T;if(s*d>0){N=v<g?v:g,N=N<b?N:b,C=v>g?v:g,C=C>b?C:b,k=m<y?m:y,k=k<w?k:w,L=m>y?m:y,L=L>w?L:w,0<d?(A=g-v,O=m-y,M=v*y-m*g,_=b-g,D=y-w,P=g*w-y*b,H=v-b,B=w-m,j=b*m-w*v):(A=v-g,O=y-m,M=m*g-v*y,_=g-b,D=w-y,P=y*b-g*w,H=b-v,B=m-w,j=w*v-b*m);var q=.1,R=-1;p=0;do{var U=e[p],z=U[0];if(N<z&&z<C){var W=U[1];if(k<W&&W<L){var X=B*z+H*W+j;q<X&&.1<O*z+A*W+M&&.1<D*z+_*W+P&&(q=X,R=p)}}p+=1}while(p<t);if(R<0)n[r]=l,n[r+1]=c,n[r+2]=h,r+=3,I=!0;else if(R===(a+2)%t)u=a,a=f,f=R,l=c,v=g,m=y,c=h,h=e[f],b=h[0],w=h[1],E=b-v,S=w-m,n[r]=l,n[r+1]=c,n[r+2]=h,r+=3,I=!0;else{if(a!==(R+2)%t){var V,$;a<R?(V=a,$=R):(V=R,$=a);var J=$-V+1,K,Q;J<=e.length-J+2?(K=e.splice(V,J,e[V],e[$]),Q=e):(Q=e.splice(V,J,e[V],e[$]),K=e),e=null;var G=K.length;G===3?(n[r]=K[0],n[r+1]=K[1],n[r+2]=K[2],r+=3):(K[G]=K[0],o(K,G)?r=this.triangulateAsFan(K,G,n,r):r=this.triangulateConcave(K,G,n,r,!0,s)),K=null;var Y=Q.length;if(Y===3)return n[r]=Q[0],n[r+1]=Q[1],n[r+2]=Q[2],r+=3,r;Q[Y]=Q[0],e=Q,t=Y,Q=null,e.length=t,F=!0;break}f=a,a=u,u=R,h=c,b=g,w=y,c=l,l=e[u],v=l[0],m=l[1],E=b-v,S=w-m,n[r]=l,n[r+1]=c,n[r+2]=h,r+=3,I=!0}}else d===0&&(I=!0);if(I){F=!0,e.splice(a,1),t-=1;if(t<4)break;if(f<t){a===0?u=t-1:(u=a-1,a===t&&(a=0)),f=a+1,c=h,g=b,y=w,x=E,T=S;continue}break}u=a,a=f,f+=1,l=c,v=g,m=y,c=h,g=b,y=w,x=g-v,T=y-m}while(f<t)}while(F&&!o(e,t));if(!F)return r;l=e[0],v=l[0],m=l[1],c=e[1],g=c[0],y=c[1],x=g-v,T=y-m,p=2;do h=e[p],b=h[0],w=h[1],E=b-v,S=w-m,d=x*S-E*T,s*d>0&&(n[r]=l,n[r+1]=c,n[r+2]=h,r+=3),c=h,g=b,y=w,x=E,T=S,p+=1;while(p<t);return r},e.prototype.fillFlatVertices=function(e,t,n){var r=0,i=0;do{var s=t[r];e[i]=s[0],i+=1,e[i]=s[1],i+=1,r+=1}while(r<n)},e.prototype.isPointInPolygon=function(e,t,n,r){var i,s,o,u,a,f;u=n[r-1],i=u[1]>=t,o=!1;for(f=0;f<r;f+=1)a=n[f],s=a[1]>=t,i!==s&&(a[1]-t)*(u[0]-a[0])>=(a[0]-e)*(u[1]-a[1])===s&&(o=!o),u=a,i=s;return o},e.prototype.isPointInSubPath=function(e,t,n){var r=n.length;return r>2&&this.isClosed(n[0],n[r-1])?(r-=1,this.isPointInPolygon(e,t,n,r)):!1},e.create=function(t,n,r,i){return new e(t,n,r,i)},e.version=1,e}(),lt=function(){function e(){}return e.prototype.getContext=function(e){return e.toLowerCase()==="2d"?this.context:null},e.prototype.toDataURL=function(){if(this.width===0||this.height===0)return"data:,";var e=this.context.gd.getScreenshot(!0,0,0,this.width,this.height);return e?"data:image/jpeg;base64,"+e.toBase64():null},e.prototype.toBlob=function(e){if(e){var t=this.context.gd.getScreenshot(!0,0,0,this.width,this.height);e(t)}},e.prototype.setAttribute=function(e,t){t.substr(-2,2)==="px"&&(t=t.substr(0,t.lengh-2)),t=parseInt(t,10);if(e==="width")this.width=t;else{if(e!=="height")throw"UNSUPPORTED ATTRIBUTE!";this.height=t}},e.prototype.setFontManager=function(e){this.context.setFontManager(e)},e.create=function(t){var n=t.width,r=t.height,i=new e;return i.context=ft.create(i,t,n,r),Object.defineProperty?(Object.defineProperty(i,"width",{get:function(){return n},set:function(t){n=t,this.context.setWidth(t),this.clientWidth=t},enumerable:!0,configurable:!1}),Object.defineProperty(i,"height",{get:function(){return r},set:function(t){r=t,this.context.setHeight(t),this.clientHeight=t},enumerable:!0,configurable:!1})):(i.width=n,i.height=r),i.clientWidth=n,i.clientHeight=r,i},e.version=1,e}();(function(){ft.prototype.floatArrayConstructor=Array,ft.prototype.byteArrayConstructor=Array,ft.prototype.shortArrayConstructor=Array;if(typeof Float32Array!="undefined"){var e=Object.prototype.toString.call(new Float32Array(4));e==="[object Float32Array]"&&(ft.prototype.floatArrayConstructor=Float32Array)}if(typeof Uint8Array!="undefined"){var e=Object.prototype.toString.call(new Uint8Array(4));e==="[object Uint8Array]"&&(ft.prototype.byteArrayConstructor=Uint8Array)}if(typeof Uint16Array!="undefined"){var e=Object.prototype.toString.call(new Uint16Array(4));e==="[object Uint16Array]"&&(ft.prototype.shortArrayConstructor=Uint16Array)}})();var ct=function(){function e(){this.version=1}return e.prototype.setSelectedRadio=function(e,t){var n=this.radioControls[e],r;n&&(r=n.controls[t],r&&(n.selected=t,this.updateRadio(r.id,!0)))},e.prototype.addRadioControl=function(e){var t=this.radioControls,n=e.groupName,r=e.radioIndex,i=e.id,s=e.fn,o=e.isDefault;if(n===undefined||n===null||r<0||i===undefined||i===null||s===undefined||s===null)return;var u=t[n];u||(t[n]={},u=t[n],u.controls=[],u.selected=0),u.controls[r]=e,o&&(u.selected=r),this.updateRadio(i,o)},e.prototype.addCheckboxControl=function(e){var t=this.checkboxControls,n=e.id,r=e.value;t[r]=e,this.updateCheckbox(n,e.isSelected)},e.prototype.addButtonControl=function(e){var t=this.buttonControls,n=e.id;t[n]=e},e.prototype.addSliderControl=function(e){var t=this.sliderControls;t[e.id]=e},e.prototype.getSliderValue=function(e){var t=window.$("#"+e).value;return t?parseInt(t,10):undefined},e.prototype.getHandler=function(){var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls;return function(r){var i;r||(r=window.event),r.target?i=r.target:r.srcElement&&(i=r.srcElement),i.nodeType===3&&(i=i.parentNode);var s=i.id,o;switch(i.type){case"radio":for(var u in e)if(e.hasOwnProperty(u)){var a=0,f=e[u].controls,l=f.length;while(a<l){o=f[a];if(o.id===s){o.fn();return}a+=1}}break;case"checkbox":for(var c in t)if(t.hasOwnProperty(c)){o=t[c];if(o.id===s){var h=o.fn();h!==undefined&&(document.getElementById(o.id).checked=!!h);return}}break;case"button":for(var p in n)if(n.hasOwnProperty(p)){o=n[p];if(p===s){o.fn();return}}break;default:}}},e.prototype.register=function(){function d(e){return function(t,n){var r=window.$("#"+e+"input");r.val(n.value),r.change()}}function v(e,t){return function(){var n=parseFloat(this.value);if(!window.$)return;var r=window.$("#"+t),i=window.$("#"+t+"input");if(!r||!i)return;var s=r.slider("value");if(n===undefined||isNaN(n)||s===undefined||isNaN(s)||s===n)return;var o=r.slider("option","min"),u=r.slider("option","max");n<o?n=o:n>u&&(n=u),i.val(n),e.value=n,e.fn()}}var e=this.radioControls,t=this.checkboxControls,n=this.buttonControls,r=this.sliderControls,i,s,o;for(var u in e)if(e.hasOwnProperty(u)){var a=e[u].selected,f=e[u].controls,l=f.length;for(var c=0;c<l;c+=1)i=f[c],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.name=i.groupName,s.onclick=this.getHandler(),s.checked=a===i.radioIndex?"checked":"")}for(var h in t)t.hasOwnProperty(h)&&(i=t[h],o=i.id,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler(),s.checked=i.isSelected?"checked":""));for(var p in n)n.hasOwnProperty(p)&&(i=n[p],o=p,s=document.getElementById(o),s&&(s.value=i.value,s.onclick=this.getHandler()));for(var m in r)if(r.hasOwnProperty(m)){i=r[m],o=i.id;if(!window.$)return;var g=window.$("#"+o),y=window.$("#"+o+"input");if(!g||!y)return;g.slider({value:i.value,min:i.min,max:i.max,step:i.step,slide:d(o)}),y.val(g.slider("value")),y.change(v(i,o))}this.registered=!0},e.prototype.updateRadio=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateCheckbox=function(e,t){if(!this.registered)return;var n=document.getElementById(e);n&&(n.checked=!!t)},e.prototype.updateSlider=function(e,t){if(!this.registered)return;if(window.$){var n=window.$("#"+e);n&&n.slider("option","value",t)}},e.create=function(){var t=new e;return t.radioControls={},t.checkboxControls={},t.buttonControls={},t.sliderControls={},t.registered=!1,t},e}();TurbulenzEngine.onload=function(){function H(){_.render(n,w),D&&M.drawVisibleRenderablesExtents(n,a,w,!1,!0)}function W(){if(!U)return;var e=n.fps.toFixed(2)+" fps";e!==z&&(z=e,U.innerHTML=z)}function G(){q=a.get("shaders/font.cgfx").getTechnique("font"),R=n.createTechniqueParameters({clipSpace:r.v4BuildZero(),alphaRef:.01,color:r.v4BuildOne()}),k=P.create(n,r,a,f,{}),X.initialize(M,k.passIndex.transparent),Q=TurbulenzEngine.time}function rt(){var e=TurbulenzEngine.time,t=e-Q;Q=e,W(),s.update(),S.maxSpeed=t*N,S.update();var i=n.width/n.height;i!==w.aspectRatio&&(w.aspectRatio=i,w.updateProjectionMatrix()),w.updateViewProjectionMatrix(),t*=Math.pow(1.3,g),X.update(t),m+=t;var o=0;while(m>1/v&&o<100){o+=1,m-=1/v;var u,a,f,l,d;d=2+2*Math.random(),u=X.createInstance(J,d),a=Math.random()*(h-tt*2)+tt,f=Math.random()*(p-tt*2)+tt,l=1+Math.random()*2,u.renderable.setLocalTransform(r.m43Build(l,0,0,0,l,0,0,0,l,a,0,f)),X.addInstanceToScene(u,Y),d=2+2*Math.random(),u=X.createInstance(K,d),a=Math.random()*(h-tt*2)+tt,f=Math.random()*(p-tt*2)+tt,l=1+Math.random()*2,u.renderable.setLocalTransform(r.m43Build(l,0,0,0,l,0,0,0,l,a,0,f)),X.addInstanceToScene(u,Y)}m%=1/v;if(Z){et+=t;var y=et/5,b=tt*Math.sin(y),E=r.m43BuildTranslation(Math.sin(y)*b,0,Math.cos(y)*b);Y.setLocalTransform(E)}M.update();if(!n.beginFrame())return;k.update(n,w,M,e),k.draw(n,O,H),n.setTechnique(q),r.v4Build(2/n.width,-2/n.height,-1,1,R.clipSpace),n.setTechniqueParameters(R);var x=X.gatherMetrics(),T="ParticleManager Metrics:\n";for(var C in x)x.hasOwnProperty(C)&&(T+=C+": "+x[C]+"\n");var L=c.get("fonts/hero.fnt"),A=.5,_=L.calculateTextDimensions(T,A,0);L.drawTextRect(T,{rect:r.v4Build(0,0,_.width,_.height),scale:A,alignment:0}),B.width!==n.width&&(B.width=n.width),B.height!==n.height&&(B.height=n.height);var D=h*F,P=p*I,U=r.v4Build(B.width-D-2,B.height-2,D,P);U=null,j.beginFrame(null,U),j.setTransform(1,0,0,1,0,0),j.translate(B.width-h*F-2,2),j.strokeStyle="#ffffff",j.strokeRect(0,0,h*F,p*I);var z=X.gatherInstanceMetrics(),V=z.length,$;for($=0;$<V;$+=1){var G=z[$],nt=G.instance.renderable.getWorldExtents();a=(nt[0]+nt[3])/2*F,f=(nt[2]+nt[5])/2*I,j.strokeStyle=G.active?"#00ff00":G.allocated?"#ffff00":"#ff0000",j.strokeRect(a-.5,f-.5,1,1)}var rt=r.m43Pos(r.m43Inverse(w.viewMatrix));rt[0]>=0&&rt[2]>=0&&rt[0]<=h&&rt[2]<=p&&(j.strokeStyle="#ffffff",j.strokeRect(rt[0]*F-1.5,rt[2]*I-1.5,3,3)),j.endFrame(),n.endFrame()}function ot(){n.beginFrame()&&(n.clear(O),n.endFrame()),u.getNumPendingTextures()===0&&a.getNumPendingShaders()===0&&(TurbulenzEngine.clearInterval(st),G(),st=TurbulenzEngine.setInterval(rt,1e3/60))}function ut(){a.load("shaders/debug.cgfx"),a.load("shaders/font.cgfx"),c.load("fonts/hero.fnt"),X.loadArchetype(J),X.loadArchetype(K),st=TurbulenzEngine.setInterval(ot,10)}function at(e){u.setPathRemapping(e.urlMapping,e.assetPrefix),a.setPathRemapping(e.urlMapping,e.assetPrefix),c.setPathRemapping(e.urlMapping,e.assetPrefix),ut()}function ft(e){d.createMappingTable(o,e,at)}function vt(e,t,n){var r=e.emitters,i=r.length,s;for(s=0;s<i;s+=1){var o=r[s];o.emittance.burstMin*=n,o.emittance.burstMax*=n}var u=X.parseArchetype(e);return X.replaceArchetype(t,u),X.destroyArchetype(t),u}var t=function(t){window.alert(t)},n=TurbulenzEngine.createGraphicsDevice({});if(n.maxSupported("VERTEX_TEXTURE_UNITS")===0){t("Device does not support sampling of textures from vertex shaders required by GPU particle system");return}var r=TurbulenzEngine.createMathDevice({}),s=TurbulenzEngine.createInputDevice({}),o=i.create({}),u=x.create(n,o,null,t),a=T.create(n,o,null,t),f=C.create(),c=it.create(n,o,null,t),h=1e3,p=1e3,v=50,m=0,g=0,w=y.create(r),E=Math.tan(30*Math.PI/180);w.recipViewWindowX=1/E,w.recipViewWindowY=1/E,w.lookAt(r.v3Build(0,0,0),r.v3BuildYAxis(),r.v3Build(h/2,30,p/2)),w.updateProjectionMatrix(),w.updateViewMatrix();var S=b.create(n,s,w),N=200,k,O=r.v4Build(0,0,0,1),M=A.create(r),_=l.create(n,r);_.color=r.v4Build(0,0,.6,1),_.fadeToColor=O;var D=!1,B=lt.create(n),j=B.getContext("2d"),F=150/h,I=150/p;j.lineWidth=.1;var q,R,U=document.getElementById("fps"),z="",X=nt.create(n,u,a);X.registerParticleAnimation({name:"fire","texture0-size":[4,2],texture0:[[0,0,1,1],[1,0,1,1],[2,0,1,1],[3,0,1,1],[0,1,1,1],[1,1,1,1],[2,1,1,1],[3,1,1,1]],animation:[{frame:0},{time:.6,color:[1,1,1,1]},{time:.1,frame:8,color:[1,1,1,0]}]}),X.registerParticleAnimation({name:"smoke","texture0-size":[4,2],texture0:[[0,0,1,1],[1,0,1,1],[2,0,1,1],[3,0,1,1],[0,1,1,1],[1,1,1,1],[2,1,1,1],[3,1,1,1]],animation:[{frame:0,"frame-interpolation":"linear",color:[1,1,1,1],"color-interpolation":"linear"},{time:.8,color:[1,.5,.5,1]},{time:.5,frame:8,color:[0,0,0,0]}]}),X.registerParticleAnimation({name:"portal",animation:[{"scale-interpolation":"catmull",color:[0,1,0,1]},{time:.3,scale:[2,2],color:[1,1,1,1]},{time:.7,scale:[.5,.5],color:[1,0,0,0]}]});var V={system:{center:[0,6,0],halfExtents:[7,6,7]},updater:{noiseTexture:"textures/noise.dds",randomizedAcceleration:[10,10,10]},renderer:{name:"additive",noiseTexture:"textures/noise.dds",randomizedOrientation:[0,.3*Math.PI],animatedOrientation:!0,randomizedScale:[3,3],animatedScale:!1},packedTexture:"textures/flamesmokesequence.png",particles:{fire:{animation:"fire","texture-uv":[0,0,1,.5],tweaks:{"scale-scale":[5,5]}},ember:{animation:"fire","texture-uv":[0,0,1,.5],tweaks:{"scale-scale":[2,2],"frame-scale":.5,"frame-offset":4}},smoke:{animation:"smoke","texture-uv":[0,.5,1,.5],tweaks:{"scale-scale":[3,3]}}},emitters:[{particle:{name:"fire",lifeTimeScaleMin:.6,lifeTimeScaleMax:1.2,renderUserData:{facing:"billboard",randomizeOrientation:!0,randomizeScale:!0}},emittance:{rate:10,burstMin:0,burstMax:2},position:{position:[0,2,0],radiusMax:1,radiusDistribution:"normal"},velocity:{theta:0,phi:0}},{particle:{name:"ember",lifeTimeMin:.2,lifeTimeMax:.6,updateUserData:{randomizeAcceleration:!0},renderUserData:{randomizeOrientation:!0}},emittance:{rate:3,burstMin:0,burstMax:15,delay:.25},velocity:{conicalSpread:Math.PI*.25,speedMin:1,speedMax:3},position:{position:[0,3,0],spherical:!0,radiusMin:1,radiusMax:2.5}},{particle:{name:"smoke",updateUserData:{randomizeAcceleration:!0}},emittance:{rate:20,burstMin:0,burstMax:3},velocity:{conicalSpread:Math.PI*.25,speedMin:2,speedMax:6},position:{position:[0,2.5,0],spherical:!0,radiusMin:.5,radiusMax:2}}]},$={system:{center:[0,6,0],halfExtents:[12,6,12]},renderer:{name:"additive",noiseTexture:"textures/noise.dds",randomizedAlpha:1,animatedAlpha:!0,randomizedOrientation:[Math.PI*.25,Math.PI*.25],animatedOrientation:!0,randomizedRotation:Math.PI*2,animatedRotation:!0},updater:{drag:1,noiseTexture:"textures/noise.dds",randomizedAcceleration:[10,0,10]},particles:{spark:{animation:"portal",tweaks:{"scale-scale":[.5,.5]},texture:"textures/particle_spark.png"},smoke:{animation:"portal",tweaks:{"color-scale":[-1,-1,-1,1],"color-offset":[1,1,1,0]},texture:"textures/smoke.dds"}},emitters:[{emittance:{delay:1,rate:80,burstMin:4,burstMax:4},particle:{name:"spark",updateUserData:{randomizeAcceleration:!0},renderUserData:{facing:"velocity",randomizeAlpha:!0,randomizeOrientation:!0,randomizeRotation:!0}},velocity:{speedMin:3,speedMax:20,conicalSpread:Math.PI/10},position:{radiusMin:4,radiusMax:5,radiusDistribution:"normal",radiusSigma:.125}},{emittance:{rate:20,burstMin:0,burstMax:6},particle:{name:"smoke",renderUserData:{facing:"billboard"},useAnimationLifeTime:!1,lifeTimeMin:.5,lifeTimeMax:1.5},velocity:{speedMin:5,speedMax:15},position:{spherical:!1,radiusMin:0,radiusMax:2}}]},J=X.parseArchetype(V),K=X.parseArchetype($),Q,Y=L.create({name:"particleNode",dynamic:!0});M.addRootNode(Y);var Z=!1,et=0,tt=50,st,ht=d.createGameSession(o,ft);TurbulenzEngine.onunload=function(){TurbulenzEngine.clearInterval(st),ht&&(ht.destroy(),ht=null),a&&(a.destroy(),a=null),u&&(u.destroy(),u=null),c&&(c.destroy(),c=null),k&&(k.destroy(),k=null),X&&(X.destroy(),X=null),f=null,o=null,S=null,w=null,_=null,TurbulenzEngine.flush(),s=null,n=null,r=null};var pt=ct.create();pt.addSliderControl({id:"speedSlider",value:g,max:6,min:-10,step:1,fn:function(){g=this.value,pt.updateSlider("speedSlider",g)}}),pt.addSliderControl({id:"instanceSlider",value:v,max:200,min:20,step:20,fn:function(){v=this.value,pt.updateSlider("instanceSlider",v)}});var dt=0;pt.addButtonControl({id:"button-decrease-particles",value:"-",fn:function(){dt>-5&&(dt-=1,J=vt(V,J,1/1.5),K=vt($,K,1/1.5))}}),pt.addButtonControl({id:"button-increase-particles",value:"+",fn:function(){dt<4&&(dt+=1,J=vt(V,J,1.5),K=vt($,K,1.5))}}),pt.addCheckboxControl({id:"move-systems",value:"moveSystems",isSelected:Z,fn:function(){return Z=!Z,Z}}),pt.addCheckboxControl({id:"draw-extents",value:"drawRenderableExtents",isSelected:D,fn:function(){return D=!D,D}}),pt.addButtonControl({id:"button-clear",value:"Clear",fn:function(){X.clear(J),X.clear(K)}}),pt.addButtonControl({id:"button-destroy-1",value:"Destroy 1",fn:function(){X.destroyArchetype(J)}}),pt.addButtonControl({id:"button-destroy-2",value:"Destroy 2",fn:function(){X.destroyArchetype(K)}}),pt.addButtonControl({id:"button-replace-1-2",value:"Replace 1 to 2",fn:function(){X.replaceArchetype(J,K)}}),pt.addButtonControl({id:"button-replace-2-1",value:"Replace 2 to 1",fn:function(){X.replaceArchetype(K,J)}}),pt.register()};if(!TurbulenzEngine.onload){window.alert("Entry point 'TurbulenzEngine.onload' must be defined.");return}TurbulenzEngine.onload.call(this)})();