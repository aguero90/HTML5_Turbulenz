
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <title>
            Physics2D - Samples - Turbulenz Engine
        </title>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
        <style type="text/css">
            html, body, div, span, object, iframe, h1, h2, p, a, img, ul, li, fieldset, form, label, legend, table, thead, tbody, tfoot, tr, th, td {
                border: 0;
                font-size: 100%;
                margin: 0;
                outline: 0;
                padding: 0;
                vertical-align: baseline;
            }
        </style>
        <!-- block tz_app_header -->

        <link rel="stylesheet" type="text/css" href="css/base_template.css">
        <link rel="shortcut icon" href="img/favicon.ico">
        <link rel="Stylesheet" type="text/css" href="css/jquery-ui-1.8.2.custom.css"/>
        <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.8.2.custom.min.js"></script>

        <!-- end tz_app_header -->
    </head>
    <body>
        <div id="engine">
            <canvas id="turbulenz_game_engine_canvas" moz-opaque="true" tabindex="1">
                Sorry, but your browser does not support WebGL or does not have it
                enabled.  To get a WebGL-enabled browser, please see:<br/>
                <a href="http://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" target="_blank">
                    Getting a WebGL Implementation
                </a>
            </canvas>

            <script type="text/javascript">
                var canvasSupported = true;
                (function ()
                {
                    var contextNames = ["webgl", "experimental-webgl"];
                    var context = null;
                    var canvas = document.createElement('canvas');

                    document.body.appendChild(canvas);

                    for (var i = 0; i < contextNames.length; i += 1)
                    {
                        try {
                            context = canvas.getContext(contextNames[i]);
                        } catch (e) {
                        }

                        if (context) {
                            break;
                        }
                    }
                    if (!context)
                    {
                        canvasSupported = false;
                        window.alert("Sorry, but your browser does not support WebGL or does not have it enabled.");
                    }

                    document.body.removeChild(canvas);
                }());
                var TurbulenzEngine = {};
            </script>
        </div>

        <!-- begin 'tz_include_js' variable -->
        <script type="text/javascript" src="jslib/debug.js"></script>
        <script type="text/javascript" src="jslib/vmath.js"></script>
        <script type="text/javascript" src="jslib/utilities.js"></script>
        <script type="text/javascript" src="jslib/aabbtree.js"></script>
        <script type="text/javascript" src="jslib/observer.js"></script>
        <script type="text/javascript" src="jslib/webgl/ddsloader.js"></script>
        <script type="text/javascript" src="jslib/webgl/graphicsdevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/inputdevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/mathdevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/networkdevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/physicsdevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/sounddevice.js"></script>
        <script type="text/javascript" src="jslib/webgl/soundtarloader.js"></script>
        <script type="text/javascript" src="jslib/webgl/tarloader.js"></script>
        <script type="text/javascript" src="jslib/webgl/tgaloader.js"></script>
        <script type="text/javascript" src="jslib/webgl/touch.js"></script>
        <script type="text/javascript" src="jslib/webgl/touchevent.js"></script>
        <script type="text/javascript" src="jslib/webgl/turbulenzengine.js"></script>
        <script type="text/javascript" src="jslib/requesthandler.js"></script>
        <script type="text/javascript" src="jslib/services/turbulenzservices.js"></script>
        <script type="text/javascript" src="jslib/services/turbulenzbridge.js"></script>
        <script type="text/javascript" src="jslib/services/gamesession.js"></script>
        <script type="text/javascript" src="jslib/services/mappingtable.js"></script>
        <script type="text/javascript" src="jslib/shadermanager.js"></script>
        <script type="text/javascript" src="jslib/physics2ddevice.js"></script>
        <script type="text/javascript" src="jslib/draw2d.js"></script>
        <script type="text/javascript" src="jslib/boxtree.js"></script>
        <script type="text/javascript" src="jslib/physics2ddebugdraw.js"></script>
        <script type="text/javascript" src="jslib/textureeffects.js"></script>
        <script type="text/javascript" src="jslib/fontmanager.js"></script>
        <script type="text/javascript" src="jslib/soundmanager.js"></script>
        <script type="text/javascript" src="scripts/htmlcontrols.js"></script>
        <!-- end 'tz_include_js' variable -->

        <script type="text/javascript" src="MYSCRIPTS/game.js"></script>
        <script type="text/javascript" src="MYSCRIPTS/player.js"></script>
        <script type="text/javascript" src="MYSCRIPTS/bonus.js"></script>
        <script type="text/javascript" src="MYSCRIPTS/platform.js"></script>

        <script type="text/javascript">

                TurbulenzEngine.onload = function onloadFn() {

                    var modularCode = false;

                    if (modularCode) {

                        var game = new Game();
                        game.init();

                    } else {
                        //==========================================================================
                        // Turbulenz Initialization
                        //==========================================================================
                        var graphicsDevice = TurbulenzEngine.createGraphicsDevice({});
                        var mathDevice = TurbulenzEngine.createMathDevice({});
                        var requestHandler = RequestHandler.create({});

                        var playerAtlas;
                        var playerAtlasJSON;
                        var atlas;
                        var atlasJSON;
                        var tilemap;
                        var gameSession;
                        var draw2DTexture;

                        var sprites = [];

                        function sessionCreated(gameSession) {
                            TurbulenzServices.createMappingTable(requestHandler, gameSession, function (table) {

                                TurbulenzEngine.request(table.getURL("JSON/tilemap/superMario.json"), function (JSON) {
                                    if (JSON) {
                                        tilemap = JSON;
                                    }
                                });

                                TurbulenzEngine.request(table.getURL("JSON/textures/superMarioTiles.json"), function (JSON) {
                                    if (JSON) {
                                        atlasJSON = JSON;
                                    }
                                });

                                TurbulenzEngine.request(table.getURL("JSON/textures/player.json"), function (JSON) {
                                    if (JSON) {
                                        playerAtlasJSON = JSON;
                                    }
                                });

                                graphicsDevice.createTexture({
                                    src: table.getURL("textures/superMarioTiles.png"),
                                    mipmaps: true,
                                    onload: function (texture) {
                                        if (texture) {
                                            atlas = texture;
                                        }
                                    }
                                });

                                graphicsDevice.createTexture({
                                    src: table.getURL("textures/player.png"),
                                    mipmaps: true,
                                    onload: function (texture) {
                                        if (texture) {
                                            playerAtlas = texture;
                                        }
                                    }
                                });

                                graphicsDevice.createTexture({
                                    src: table.getURL("textures/physics2d.png"),
                                    mipmaps: true,
                                    onload: function (texture) {
                                        if (texture) {
                                            draw2DTexture = texture;
                                        }
                                    }
                                });

                            });
                        }
                        gameSession = TurbulenzServices.createGameSession(requestHandler, sessionCreated);

                        //==========================================================================
                        // Physics2D/Draw2D
                        //==========================================================================
                        // set up.
                        var phys2D = Physics2DDevice.create();
                        var collisionUtils = phys2D.createCollisionUtils();

                        // size of physics stage.
                        var stageWidth = 50 * 16; // voglio vedere 50 tiles in orizzontale
                        var stageHeight = 30 * 16; // voglio vedere 30 tiles in verticale

                        var draw2D = Draw2D.create({
                            graphicsDevice: graphicsDevice
                        });
                        var debug = Physics2DDebugDraw.create({
                            graphicsDevice: graphicsDevice
                        });

                        // Configure draw2D viewport to the physics stage.
                        // As well as the physics2D debug-draw viewport.
                        draw2D.configure({
                            viewportRectangle: [0, 0, stageWidth, stageHeight],
                            scaleMode: 'scale'
                        });
                        debug.setPhysics2DViewport([0, 0, stageWidth, stageHeight]);

                        var world = phys2D.createWorld({
                            gravity: [0, 20 * (16 / 0.8)]
                        });

                        var rubberMaterial = phys2D.createMaterial({
                            elasticity: 0.9,
                            staticFriction: 6,
                            dynamicFriction: 4,
                            rollingFriction: 0.001
                        });

                        var heavyMaterial = phys2D.createMaterial({
                            density: 3
                        });

                        var conveyorBeltMaterial = phys2D.createMaterial({
                            elasticity: 0,
                            staticFriction: 10,
                            dynamicFriction: 8,
                            rollingFriction: 0.1
                        });

                        var borderMaterial = phys2D.createMaterial({
                            elasticity: 0,
                            staticFriction: 0,
                            dynamicFriction: 0 // in questo modo il corpo scivola anzichè "impuntarsi"
                        });

                        var mushroomMaterial, collisionMaterial = phys2D.createMaterial({
                            elasticity: 0,
                            staticFriction: 0,
                            dynamicFriction: 0 // in questo modo il corpo scivola anzichè "impuntarsi"
                        });

                        var shapeSize = 16;
                        var shapeFactory = [
                            phys2D.createCircleShape({
                                radius: (shapeSize / 2),
                                material: rubberMaterial
                            }),
                            phys2D.createPolygonShape({
                                vertices: phys2D.createBoxVertices(shapeSize, shapeSize),
                                material: heavyMaterial
                            }),
                            phys2D.createPolygonShape({
                                sensor: true, // in questo modo la "corsa" del player non viene intaccata dal bonus
                                vertices: phys2D.createRegularPolygonVertices(shapeSize, shapeSize, 3),
                                material: heavyMaterial
                            }),
                            phys2D.createPolygonShape({
                                vertices: phys2D.createRegularPolygonVertices(shapeSize, shapeSize, 6),
                                material: rubberMaterial
                            })
                        ];

                        // texture rectangles for above shapes.
                        // OVVERO: COME UTILIZZARE GLI SPRITESHEET A MANO -.-
                        var textureRectangles = [
                            [130, 130, 255, 255],
                            [5, 132, 125, 252],
                            [131, 3, 251, 123],
                            [5, 5, 125, 125]
                        ];

                        var player;

                        function reset() {
                            // Remove all bodies and constraints from world.
                            world.clear();

                            createTilemap();

                            player = phys2D.createRigidBody({
                                shapes: [phys2D.createPolygonShape({
                                        vertices: phys2D.createRegularPolygonVertices(20, 30, 4)
                                    })],
                                position: [16, stageHeight / 2],
                                userData: Draw2DSprite.create({
                                    width: 20,
                                    height: 30,
                                    origin: [20 / 2, 30 / 2],
                                    textureRectangle: [281, 2, 281 + 66, 2 + 92],
                                    texture: playerAtlas
                                })
                            });

                            world.addRigidBody(player);

                            player.indexAnimation = 0;
                            player.standardSprite = player.userData;
                            player.animationSprite = [];

                            for (var i = 0; i < playerAtlasJSON.frames.length; i++) {
                                if (playerAtlasJSON.frames[i].filename.contains("walk")) {
                                    player.animationSprite.push(
                                            Draw2DSprite.create({
                                                width: 20,
                                                height: 30,
                                                origin: [20 / 2, 30 / 2],
                                                textureRectangle: [
                                                    playerAtlasJSON.frames[i].frame.x,
                                                    playerAtlasJSON.frames[i].frame.y,
                                                    playerAtlasJSON.frames[i].frame.x + playerAtlasJSON.frames[i].frame.w,
                                                    playerAtlasJSON.frames[i].frame.y + playerAtlasJSON.frames[i].frame.h
                                                ],
                                                texture: playerAtlas
                                            })
                                            );
                                }
                            }

                            console.log(player.animationSprite);

                            player.shapes[0].addEventListener("begin", function (arbiter, shape) {

                                if (arbiter.bodyA.isCoins) {
                                    world.removeRigidBody(arbiter.bodyA);
                                } else if (arbiter.bodyA.isBlock) {
                                    if (!arbiter.bodyA.isHitted) {
                                        var tile = atlasJSON.frames[16];
                                        arbiter.bodyA.userData.setTextureRectangle([
                                            tile.frame.x + 0.5,
                                            tile.frame.y + 0.5,
                                            tile.frame.x + tile.frame.w - 0.5,
                                            tile.frame.y + tile.frame.h - 0.5
                                        ]);
                                        arbiter.bodyA.isHitted = true;

                                        var pos = arbiter.bodyA.getPosition();
                                        createMushroom(pos[0], pos[1] - 16);

                                    }
                                } else if (shape.body.isMushroom) {
                                    world.removeRigidBody(shape.body);
                                    playerPowerUp();
                                }


                            });
                        }

                        function createTilemap() {
                            for (var l = 0; l < tilemap.layers.length; l++) {
                                if (tilemap.layers[l].name === "Collision") {
                                    createCollisionLayer(tilemap.layers[l]);
                                } else if (tilemap.layers[l].name === "Coins") {
                                    createCoinsLayer(tilemap.layers[l]);
                                } else if (tilemap.layers[l].name === "Block") {
                                    createBlockLayer(tilemap.layers[l]);
                                } else {
                                    createSimpleLayer(tilemap.layers[l]);
                                }
                            }
                        }

                        function createCollisionLayer(layer) {
                            var numTile;
                            for (var i = 0; i < tilemap.height; i++) {
                                for (var j = 0; j < tilemap.width; j++) {
                                    numTile = layer.data[(i * tilemap.width) + j];
                                    if (numTile !== 0) {
                                        world.addRigidBody(createCollisionTile(atlasJSON.frames[numTile - 1], i, j));
                                    }
                                }
                            }
                        }

                        function createCoinsLayer(layer) {
                            var numTile;
                            for (var i = 0; i < tilemap.height; i++) {
                                for (var j = 0; j < tilemap.width; j++) {
                                    numTile = layer.data[(i * tilemap.width) + j];
                                    if (numTile !== 0) {
                                        world.addRigidBody(createCoinsTile(atlasJSON.frames[numTile - 1], i, j));
                                    }
                                }
                            }
                        }

                        function createBlockLayer(layer) {
                            var numTile;
                            for (var i = 0; i < tilemap.height; i++) {
                                for (var j = 0; j < tilemap.width; j++) {
                                    numTile = layer.data[(i * tilemap.width) + j];
                                    if (numTile !== 0) {
                                        world.addRigidBody(createBlockTile(atlasJSON.frames[numTile - 1], i, j));
                                    }
                                }
                            }
                        }

                        function createSimpleLayer(layer) {
                            var numTile;
                            for (var i = 0; i < tilemap.height; i++) {
                                for (var j = 0; j < tilemap.width; j++) {
                                    numTile = layer.data[(i * tilemap.width) + j];
                                    if (numTile !== 0) {
                                        sprites.push(drawTile(atlasJSON.frames[numTile - 1], i, j));
                                    }
                                }
                            }
                        }

                        function createCollisionTile(tile, row, col) {

                            var shape = phys2D.createPolygonShape({
                                vertices: phys2D.createBoxVertices(tile.frame.w, tile.frame.h),
                                material: collisionMaterial
                            });

                            var sprite = Draw2DSprite.create({
                                width: tile.frame.w,
                                height: tile.frame.h,
                                // NOTA: devo sistemare manualmente le texture rectangle -.-
                                textureRectangle: [
                                    tile.frame.x + 0.5,
                                    tile.frame.y + 0.5,
                                    tile.frame.x + tile.frame.w - 0.5,
                                    tile.frame.y + tile.frame.h - 0.5
                                ],
                                texture: atlas
                            });

                            var body = phys2D.createRigidBody({
                                type: 'static',
                                shapes: [shape],
                                position: [col * tile.frame.w, row * tile.frame.h],
                                userData: sprite
                            });

                            return body;
                        }

                        function createCoinsTile(tile, row, col) {

                            var shape = phys2D.createPolygonShape({
                                sensor: true,
                                vertices: phys2D.createBoxVertices(tile.frame.w, tile.frame.h),
                                material: conveyorBeltMaterial
                            });

                            var sprite = Draw2DSprite.create({
                                width: tile.frame.w,
                                height: tile.frame.h,
                                // NOTA: devo sistemare manualmente le texture rectangle -.-
                                textureRectangle: [
                                    tile.frame.x + 0.5,
                                    tile.frame.y + 0.5,
                                    tile.frame.x + tile.frame.w - 0.5,
                                    tile.frame.y + tile.frame.h - 0.5
                                ],
                                texture: atlas
                            });

                            var body = phys2D.createRigidBody({
                                type: 'static',
                                shapes: [shape],
                                position: [col * tile.frame.w, row * tile.frame.h],
                                userData: sprite
                            });

                            body.isCoins = true;

                            return body;
                        }

                        function createBlockTile(tile, row, col) {

                            var shape = phys2D.createPolygonShape({
                                vertices: phys2D.createBoxVertices(tile.frame.w, tile.frame.h),
                                material: conveyorBeltMaterial
                            });

                            var sprite = Draw2DSprite.create({
                                width: tile.frame.w,
                                height: tile.frame.h,
                                // NOTA: devo sistemare manualmente le texture rectangle -.-
                                textureRectangle: [
                                    tile.frame.x + 0.5,
                                    tile.frame.y + 0.5,
                                    tile.frame.x + tile.frame.w - 0.5,
                                    tile.frame.y + tile.frame.h - 0.5
                                ],
                                texture: atlas
                            });

                            var body = phys2D.createRigidBody({
                                type: 'static',
                                shapes: [shape],
                                position: [col * tile.frame.w, row * tile.frame.h],
                                userData: sprite
                            });

                            body.isBlock = true;
                            body.isHitted = false;

                            return body;
                        }

                        function drawTile(tile, row, col) {

                            var sprite = Draw2DSprite.create({
                                width: tile.frame.w,
                                height: tile.frame.h,
                                x: col * tile.frame.w,
                                y: row * tile.frame.h,
                                textureRectangle: [
                                    tile.frame.x + 0.5,
                                    tile.frame.y + 0.5,
                                    tile.frame.x + tile.frame.w - 0.5,
                                    tile.frame.y + tile.frame.h - 0.5
                                ],
                                texture: atlas
                            });

                            return sprite;

                        }

                        function createMushroom(x, y) {

                            var tile = atlasJSON.frames[11];

                            var shape = phys2D.createPolygonShape({
                                sensor: true,
                                vertices: phys2D.createBoxVertices(tile.frame.w, tile.frame.h),
                                material: mushroomMaterial
                            });

                            var sprite = Draw2DSprite.create({
                                width: tile.frame.w,
                                height: tile.frame.h,
                                // NOTA: devo sistemare manualmente le texture rectangle -.-
                                textureRectangle: [
                                    tile.frame.x + 0.5,
                                    tile.frame.y + 0.5,
                                    tile.frame.x + tile.frame.w - 0.5,
                                    tile.frame.y + tile.frame.h - 0.5
                                ],
                                texture: atlas
                            });

                            var body = phys2D.createRigidBody({
                                type: 'static',
                                shapes: [shape],
                                position: [x, y],
                                userData: sprite
                            });

                            body.isMushroom = true;

                            world.addRigidBody(body);
                        }

                        function playerPowerUp() {

                            var shapes = player.shapes;
                            while (shapes.length > 0) {
                                player.removeShape(shapes[0]);
                            }

                            player.addShape(phys2D.createPolygonShape({
                                vertices: phys2D.createBoxVertices(shapeSize * 1.5, shapeSize * 1.5),
                                material: heavyMaterial
                            }));

                            player.userData.setScale([1.5, 1.5]);


                            player.shapes[0].addEventListener("begin", function (arbiter, shape) {

                                if (arbiter.bodyA.isCoins) {
                                    world.removeRigidBody(arbiter.bodyA);
                                } else if (arbiter.bodyA.isBlock) {
                                    if (!arbiter.bodyA.isHitted) {
                                        var tile = atlasJSON.frames[16];
                                        arbiter.bodyA.userData.setTextureRectangle([
                                            tile.frame.x + 0.5,
                                            tile.frame.y + 0.5,
                                            tile.frame.x + tile.frame.w - 0.5,
                                            tile.frame.y + tile.frame.h - 0.5
                                        ]);
                                        arbiter.bodyA.isHitted = true;

                                        var pos = arbiter.bodyA.getPosition();
                                        createMushroom(pos[0], pos[1] - 16);

                                    }
                                } else if (shape.body.isMushroom) {
                                    world.removeRigidBody(shape.body);
                                    playerPowerUp();
                                }


                            });

                        }

                        //==========================================================================
                        // Mouse/Keyboard controls
                        //==========================================================================
                        var inputDevice = TurbulenzEngine.createInputDevice({});
                        var keyCodes = inputDevice.keyCodes;
                        var controls = {};

                        var onKeyUp = function onKeyUpFn(keynum) {

                            switch (keynum) {
                                case keyCodes.R:
                                    reset();
                                    break;
                                case keyCodes.RIGHT:
                                    controls.right = false;
                                    break;
                                case keyCodes.LEFT:
                                    controls.left = false;
                                    break;
                                case keyCodes.UP:
                                    controls.up = false;
                                    break;
                                case keyCodes.DOWN:
                                    controls.down = false;
                                    break;
                            }
                        };
                        inputDevice.addEventListener('keyup', onKeyUp);

                        var onKeyDown = function onKeyDownFn(keynum) {

                            switch (keynum) {

                                case keyCodes.RIGHT:
                                    controls.right = true;
                                    break;
                                case keyCodes.LEFT:
                                    controls.left = true;
                                    break;
                                case keyCodes.DOWN:
                                    controls.down = true;
                                    break;
                                case keyCodes.UP:
                                    controls.up = true;
                                    player.setVelocity([0, -15 * (16 / 0.8)]);
                                    break;
                            }
                        };
                        inputDevice.addEventListener('keydown', onKeyDown);

                        //==========================================================================
                        // Main loop.
                        //==========================================================================
                        var realTime = 0;
                        var prevTime = TurbulenzEngine.time;

                        function mainLoop() {
                            if (!graphicsDevice.beginFrame()) {
                                return;
                            }

                            inputDevice.update();
                            // graphicsDevice.clear([0.3, 0.3, 0.3, 1.0]);
                            graphicsDevice.clear([0.4, 0.53, 1, 1.0]); // celeste dello sfondo delle tile

                            var playerPos = player.getPosition();
                            draw2D.configure({
                                viewportRectangle: [playerPos[0] - (stageWidth / 2), 0, playerPos[0] + (stageWidth / 2), stageHeight],
                                scaleMode: 'scale'
                            });

                            var body;
                            var curTime = TurbulenzEngine.time;
                            var timeDelta = (curTime - prevTime);

                            if (timeDelta > (1 / 20)) {
                                timeDelta = (1 / 20);
                            }
                            realTime += timeDelta;
                            prevTime = curTime;

                            while (world.simulatedTime < realTime) {

                                // input control
                                if (controls.right) {
                                    var vel = player.getVelocity();
                                    player.setVelocity([7 * (16 / 0.8), vel[1]]);
                                    player.indexAnimation = (player.indexAnimation + 1) % player.animationSprite.length;
                                    player.userData = player.animationSprite[player.indexAnimation];
                                    player.userData.setScale([1, 1]);
                                } else if (controls.left) {
                                    var vel = player.getVelocity();
                                    player.setVelocity([-7 * (16 / 0.8), vel[1]]);
                                    player.indexAnimation = (player.indexAnimation + 1) % player.animationSprite.length;
                                    player.userData = player.animationSprite[player.indexAnimation];
                                    player.userData.setScale([-1, 1]);

                                }

                                if (controls.down) {
                                    player.setVelocity([0, 25 * (16 / 0.8)]);
                                }

                                world.step(1 / 60);
                            }


                            // draw2D sprite drawing.
                            var bodies = world.rigidBodies;
                            var limit = bodies.length;
                            var i;
                            draw2D.begin('alpha');

                            for (i = 0; i < sprites.length; i++) {
                                draw2D.drawSprite(sprites[i]);
                            }


                            var pos = [];
                            for (i = 0; i < limit; i += 1) {
                                body = bodies[i];
                                if (body.userData) {
                                    body.getPosition(pos);
                                    var sprite = body.userData;
                                    sprite.x = pos[0];
                                    sprite.y = pos[1];
                                    sprite.rotation = body.getRotation();
                                    draw2D.drawSprite(sprite);
                                }
                            }



                            draw2D.end();

                            // physics2D debug drawing.
                            /*
                             debug.setScreenViewport(draw2D.getScreenSpaceViewport());

                             debug.begin();
                             for (i = 0; i < limit; i += 1) {
                             body = bodies[i];
                             if (!body.userData) {
                             debug.drawRigidBody(body);
                             }
                             }
                             debug.drawWorld(world);
                             debug.end(); */

                            graphicsDevice.endFrame();
                        }

                        var intervalID;
                        function loadingLoop() {

                            if (atlas && atlasJSON && playerAtlas && playerAtlasJSON && tilemap && draw2DTexture) {

                                atlasJSON = JSON.parse(atlasJSON);
                                playerAtlasJSON = JSON.parse(playerAtlasJSON);
                                tilemap = JSON.parse(tilemap);

                                reset();

                                TurbulenzEngine.clearInterval(intervalID);
                                intervalID = TurbulenzEngine.setInterval(mainLoop, 1000 / 60);
                            }
                        }
                        intervalID = TurbulenzEngine.setInterval(loadingLoop, 10);
                    } // FINE else


                    // Create a scene destroy callback to run when the window is closed
                    TurbulenzEngine.onunload = function destroyScene() {
                        if (intervalID) {
                            TurbulenzEngine.clearInterval(intervalID);
                        }

                        if (gameSession) {
                            gameSession.destroy();
                            gameSession = null;
                        }
                    };
                };

                // Engine startup
                window.onload = function ()
                {
                    var appEntry = TurbulenzEngine.onload;
                    var appShutdown = TurbulenzEngine.onunload;
                    if (!appEntry) {
                        window.alert("TurbulenzEngine.onload has not been set");
                        return;
                    }

                    var canvas =
                            document.getElementById('turbulenz_game_engine_canvas');

                    var startCanvas = function startCanvasFn()
                    {
                        if (canvas.getContext && canvasSupported)
                        {
                            TurbulenzEngine = WebGLTurbulenzEngine.create({
                                canvas: canvas,
                                fillParent: true
                            });

                            if (!TurbulenzEngine) {
                                window.alert("Failed to init TurbulenzEngine (canvas)");
                                return;
                            }

                            TurbulenzEngine.onload = appEntry;
                            TurbulenzEngine.onunload = appShutdown;
                            appEntry();
                        }
                    };

                    var previousOnBeforeUnload = window.onbeforeunload;
                    window.onbeforeunload = function ()
                    {
                        if (TurbulenzEngine.onunload) {
                            TurbulenzEngine.onunload.call(this);
                        }
                    };  // window.beforeunload

                    startCanvas();
                };  // window.onload()

        </script>

    </body>
</html>